
; 64tass Turbo Assembler Macro V1.59.3120+ listing file
; 64tass --m65c02 --nostart -Wall -q --case-sensitive --line-numbers --verbose-list -Lbuild/mos320multios.lst --output-section mos -o build/320multios/mos.rom --output-section utils -o build/320multios/utils.rom --output-section ext -o build/320multios/ext.rom mos320multios.s65
; Tue Nov 14 23:52:50 2023

;Line	;Offset	;PC	;Hex		;Monitor	;Source

:1	;******  Processing input file: mos320multios.s65

1							                .include "src/hardware.s65"

:2	;******  Processing file: src/hardware.s65

1							;-------------------------------------------------------------------------

3							                .virtual $fe00

5	.fe00						CRTC: .block

7							                .virtual 8
8	.0008						R8: .block
9	=$00						normalSync=%00000000
10	=$01						interlaceSync=%00000001
11	=$02						normalSyncAlt=%00000010
12	=$03						interlaceSyncAndVideo=%00000011

14	=0						displayDelay0=0<<4
15	=16						displayDelay1=1<<4
16	=32						displayDelay2=2<<4
17	=48						displayDisable=3<<4

19	=0						cursorDelay0=0<<6
20	=64						cursorDelay1=1<<6
21	=128						cursorDelay2=2<<6
22	=192						cursorDisable=3<<6
23							                .endblock
24							                .endvirtual

26							                .virtual 10
27	.000a						R10: .block
28	=$40						blink=$40
29	=$20						slowBlink=$20
30							                .endblock
31							                .endvirtual

33							                .endblock

35							                .endvirtual

37							;-------------------------------------------------------------------------
38							; ACIA=$fe08
39	=$fe10						SERPROC=$fe10
40							;HADC=$fe18
41	=$fee0						TUBE=$fee0
42	=$fe30						ROMSEL=$fe30
43							;ACCCON=$fe34
44							                .virtual $fe20
45	.fe20						VCONTROL: .block
46	=$01						flash=$01
47	=$02						isTeletext=$02
48	=$00						shift2MHz=$00
49	=$04						shift4MHz=$04
50	=$08						shift8MHz=$08
51	=$0c						shift16MHz=$0c
52	=$00						crtc1MHz=$00
53	=$10						crtc2MHz=$10
54	=$00						cursor____=$00
55	=$20						cursor__XX=$20
56	=$40						cursor_X__=$40
57	=$60						cursor_XXX=$60
58	=$80						cursorX___=$80
59	=$a0						cursorX_XX=$a0
60	=$c0						cursorXX__=$c0
61	=$e0						cursorXXXX=$e0
62							                .endblock
63							                .endvirtual
64	=$fe21						VPALETTE=$fe21

66							;-------------------------------------------------------------------------

68							                .virtual $fe08
69	.fe08						ACIA: .block

71	.fe08						control: .block
72	=0						counterDivide1=0<<0
73	=1						counterDivide16=1<<0
74	=2						counterDivide64=2<<0
75	=3						reset=3<<0

77	=0						word7DataEventParity2Stop=0<<2
78	=4						word7DataOddParity2Stop=1<<2
79	=8						word7DataEvenParity1Stop=2<<2
80	=12						word7DataOddParity1Stop=3<<2
81	=16						word8DataNoParity2Stop=4<<2
82	=20						word8DataNoParity1Stop=5<<2
83	=24						word8DataEvenParity1Stop=6<<2
84	=28						word8DataOddParity1Stop=7<<2

86	=0						rtsLowTXInterruptDisabled=0<<5
87	=32						rtsLowTXInterruptEnabled=1<<5
88	=64						rtsHighTXInterruptDisabled=2<<5
89	=96						rtsLowBreakTXInterruptDisabled=3<<5

91	=0						rtsRXInterruptDisabled=0<<7
92	=128						rtsRTSInterruptEnabled=1<<7

94							                .endblock
95	.fe08						status: .block
96							                .endblock

98	>fe08						                .fill 1
99	.fe09						tdr:
100	.fe09						rdr:
101	>fe09						                .fill 1
102							                .endblock
103							                .endvirtual

105							;-------------------------------------------------------------------------

107							                .virtual $fe18
108	.fe18						HADC: .block
109	.fe18						status: .block
110							                .endblock
111	.fe18						latch: .block
112							                .endblock
113	>fe18						                .fill 1

115							                .endblock
116							                .endvirtual

118							;-------------------------------------------------------------------------

120							                .virtual $fe34
121	.fe34						ACCCON: .block
122							;D=1 = display shadow RAM; D=0 = display main RAM
123	=$01						D=$01

125							;E=1 = VDU code ($c000-$dfff in MOS ROM) accesses shadow RAM; E=0 =
126							;VDU code accesses main RAM
127	=$02						E=$02

129							;X=1 = shadow RAM at $3000; X=0 = main RAM at $3000
130	=$04						X=$04

132							;Y=1 = HAZEL at $c000; Y=0 = MOS ROM at $c000
133	=$08						Y=$08

135							;ITU=1 = access internal Tube; ITU=0 = access external Tube
136	=$10						ITU=$10

138							;IFJ=1 = $fc00...$fdff accesses cartridge; IFJ=0 = $fc00...$fdff
139							;accesses 1MHz bus
140	=$20						IFJ=$20

142							; TST=1 = read MOS ROM at $fc00...$feff; TST=0 = read I/O at
143							; $fc00...$feff
144	=$40						TST=$40

146							;IRR=1 = IRQ to CPU
147	=$80						IRR=$80
148							                .bend
149							                .endv

151							                VIA: .struct                    ;
152	.0000						orb:
153	.0000						irb:
154	>0000						                .fill 1         ;0
155	.0001						ora:
156	.0001						ira:
157	>0001						                .fill 1         ;1
158	.0002						ddrb:
159	>0002						                .fill 1         ;2
160	.0003						ddra:
161	>0003						                .fill 1         ;3
162	.0004						t1cL:
163	>0004						                .fill 1         ;4
164	.0005						t1cH:
165	>0005						                .fill 1         ;5
166	.0006						t1lL:
167	>0006						                .fill 1         ;6
168	.0007						t1lH:
169	>0007						                .fill 1         ;7
170	.0008						t2cL:
171	>0008						                .fill 1         ;8
172	.0009						t2cH:
173	>0009						                .fill 1         ;9
174	.000a						sr:
175	>000a						                .fill 1         ;10
176	.000b						acr: .block
177	=0						t1OneShot=0<<6
178	=64						t1Continuous=1<<6
179	=128						t1OneShotPB7=2<<6
180	=192						t1ContinuousPB7=3<<6

182	=0						t2Timer=0<<5
183	=32						t2CountPB6=1<<5

185	=0						srDisabled=0<<2
186	=4						srShiftInT2=1<<2
187	=8						srShiftInVIAClock=2<<2
188	=12						srShiftInExtClock=3<<2
189	=16						srShiftOutT2FreeRun=4<<2
190	=20						srShiftOutT2=5<<2
191	=24						srShiftOutVIAClock=6<<2
192	=28						srShiftOutExtClock=7<<2

194	=0						pbLatchDisabled=0<<1
195	=2						pbLatchEnabled=1<<1

197	=0						paLatchDisabled=0<<0
198	=1						paLatchEnabled=1<<0

200	>000b						                .fill 1         ;11
201							                .endblock
202	.000c						pcr: .block

204	=0						cb2InputNegativeActiveEdge=0<<5
205	=32						cb2IndependentInterruptInputNegativeEdge=1<<5
206	=64						cb2InputPositiveEdge=2<<5
207	=96						cb2IndependentInterruptInputPositiveEdge=3<<5
208	=128						cb2HandshakeOutput=4<<5
209	=160						cb2PulseOutput=5<<5
210	=192						cb2LowOutput=6<<5
211	=224						cb2HighOutput=7<<5

213	=0						cb1NegativeActiveEdge=0<<4
214	=16						cb1PositiveActiveEdge=1<<4

216	=0						ca2InputNegativeActiveEdge=0<<1
217	=2						ca2IndependentInterruptInputNegativeEdge=1<<1
218	=4						ca2InputPositiveEdge=2<<1
219	=6						ca2IndependentInterruptInputPositiveEdge=3<<1
220	=8						ca2HandshakeOutput=4<<1
221	=10						ca2PulseOutput=5<<1
222	=12						ca2LowOutput=6<<1
223	=14						ca2HighOutput=7<<1

225	=0						ca1NegativeActiveEdge=0<<0
226	=1						ca1PositiveActiveEdge=1<<0

228	>000c						                .fill 1         ;12
229							                .endblock
230	.000d						ifr:
231	>000d						                .fill 1         ;13
232	.000e						ier:
233	>000e						                .fill 1         ;14
234	.000f						oraNoHandshake:
235	.000f						iraNoHandshake:
236	>000f						                .fill 1         ;15

238	.0010						irq: .block
239	=1						ca2=1
240	=2						ca1=2
241	=4						sr=4
242	=8						cb2=8
243	=16						cb1=16
244	=32						t2=32
245	=64						t1=64
246							                .endblock
247							                .ends

249							                                .virtual $fe40
250	.fe40						systemVIA: .dstruct VIA
152	.fe40						orb:
153	.fe40						irb:
154	>fe40						                .fill 1         ;0
155	.fe41						ora:
156	.fe41						ira:
157	>fe41						                .fill 1         ;1
158	.fe42						ddrb:
159	>fe42						                .fill 1         ;2
160	.fe43						ddra:
161	>fe43						                .fill 1         ;3
162	.fe44						t1cL:
163	>fe44						                .fill 1         ;4
164	.fe45						t1cH:
165	>fe45						                .fill 1         ;5
166	.fe46						t1lL:
167	>fe46						                .fill 1         ;6
168	.fe47						t1lH:
169	>fe47						                .fill 1         ;7
170	.fe48						t2cL:
171	>fe48						                .fill 1         ;8
172	.fe49						t2cH:
173	>fe49						                .fill 1         ;9
174	.fe4a						sr:
175	>fe4a						                .fill 1         ;10
176	.fe4b						acr: .block
177	=0						t1OneShot=0<<6
178	=64						t1Continuous=1<<6
179	=128						t1OneShotPB7=2<<6
180	=192						t1ContinuousPB7=3<<6

182	=0						t2Timer=0<<5
183	=32						t2CountPB6=1<<5

185	=0						srDisabled=0<<2
186	=4						srShiftInT2=1<<2
187	=8						srShiftInVIAClock=2<<2
188	=12						srShiftInExtClock=3<<2
189	=16						srShiftOutT2FreeRun=4<<2
190	=20						srShiftOutT2=5<<2
191	=24						srShiftOutVIAClock=6<<2
192	=28						srShiftOutExtClock=7<<2

194	=0						pbLatchDisabled=0<<1
195	=2						pbLatchEnabled=1<<1

197	=0						paLatchDisabled=0<<0
198	=1						paLatchEnabled=1<<0

200	>fe4b						                .fill 1         ;11
201							                .endblock
202	.fe4c						pcr: .block

204	=0						cb2InputNegativeActiveEdge=0<<5
205	=32						cb2IndependentInterruptInputNegativeEdge=1<<5
206	=64						cb2InputPositiveEdge=2<<5
207	=96						cb2IndependentInterruptInputPositiveEdge=3<<5
208	=128						cb2HandshakeOutput=4<<5
209	=160						cb2PulseOutput=5<<5
210	=192						cb2LowOutput=6<<5
211	=224						cb2HighOutput=7<<5

213	=0						cb1NegativeActiveEdge=0<<4
214	=16						cb1PositiveActiveEdge=1<<4

216	=0						ca2InputNegativeActiveEdge=0<<1
217	=2						ca2IndependentInterruptInputNegativeEdge=1<<1
218	=4						ca2InputPositiveEdge=2<<1
219	=6						ca2IndependentInterruptInputPositiveEdge=3<<1
220	=8						ca2HandshakeOutput=4<<1
221	=10						ca2PulseOutput=5<<1
222	=12						ca2LowOutput=6<<1
223	=14						ca2HighOutput=7<<1

225	=0						ca1NegativeActiveEdge=0<<0
226	=1						ca1PositiveActiveEdge=1<<0

228	>fe4c						                .fill 1         ;12
229							                .endblock
230	.fe4d						ifr:
231	>fe4d						                .fill 1         ;13
232	.fe4e						ier:
233	>fe4e						                .fill 1         ;14
234	.fe4f						oraNoHandshake:
235	.fe4f						iraNoHandshake:
236	>fe4f						                .fill 1         ;15

238	.fe50						irq: .block
239	=1						ca2=1
240	=2						ca1=2
241	=4						sr=4
242	=8						cb2=8
243	=16						cb1=16
244	=32						t2=32
245	=64						t1=64
246							                .endblock
247							                .ends
251							                .endv

253							                .virtual $fe60
254	.fe60						userVIA: .dstruct VIA
152	.fe60						orb:
153	.fe60						irb:
154	>fe60						                .fill 1         ;0
155	.fe61						ora:
156	.fe61						ira:
157	>fe61						                .fill 1         ;1
158	.fe62						ddrb:
159	>fe62						                .fill 1         ;2
160	.fe63						ddra:
161	>fe63						                .fill 1         ;3
162	.fe64						t1cL:
163	>fe64						                .fill 1         ;4
164	.fe65						t1cH:
165	>fe65						                .fill 1         ;5
166	.fe66						t1lL:
167	>fe66						                .fill 1         ;6
168	.fe67						t1lH:
169	>fe67						                .fill 1         ;7
170	.fe68						t2cL:
171	>fe68						                .fill 1         ;8
172	.fe69						t2cH:
173	>fe69						                .fill 1         ;9
174	.fe6a						sr:
175	>fe6a						                .fill 1         ;10
176	.fe6b						acr: .block
177	=0						t1OneShot=0<<6
178	=64						t1Continuous=1<<6
179	=128						t1OneShotPB7=2<<6
180	=192						t1ContinuousPB7=3<<6

182	=0						t2Timer=0<<5
183	=32						t2CountPB6=1<<5

185	=0						srDisabled=0<<2
186	=4						srShiftInT2=1<<2
187	=8						srShiftInVIAClock=2<<2
188	=12						srShiftInExtClock=3<<2
189	=16						srShiftOutT2FreeRun=4<<2
190	=20						srShiftOutT2=5<<2
191	=24						srShiftOutVIAClock=6<<2
192	=28						srShiftOutExtClock=7<<2

194	=0						pbLatchDisabled=0<<1
195	=2						pbLatchEnabled=1<<1

197	=0						paLatchDisabled=0<<0
198	=1						paLatchEnabled=1<<0

200	>fe6b						                .fill 1         ;11
201							                .endblock
202	.fe6c						pcr: .block

204	=0						cb2InputNegativeActiveEdge=0<<5
205	=32						cb2IndependentInterruptInputNegativeEdge=1<<5
206	=64						cb2InputPositiveEdge=2<<5
207	=96						cb2IndependentInterruptInputPositiveEdge=3<<5
208	=128						cb2HandshakeOutput=4<<5
209	=160						cb2PulseOutput=5<<5
210	=192						cb2LowOutput=6<<5
211	=224						cb2HighOutput=7<<5

213	=0						cb1NegativeActiveEdge=0<<4
214	=16						cb1PositiveActiveEdge=1<<4

216	=0						ca2InputNegativeActiveEdge=0<<1
217	=2						ca2IndependentInterruptInputNegativeEdge=1<<1
218	=4						ca2InputPositiveEdge=2<<1
219	=6						ca2IndependentInterruptInputPositiveEdge=3<<1
220	=8						ca2HandshakeOutput=4<<1
221	=10						ca2PulseOutput=5<<1
222	=12						ca2LowOutput=6<<1
223	=14						ca2HighOutput=7<<1

225	=0						ca1NegativeActiveEdge=0<<0
226	=1						ca1PositiveActiveEdge=1<<0

228	>fe6c						                .fill 1         ;12
229							                .endblock
230	.fe6d						ifr:
231	>fe6d						                .fill 1         ;13
232	.fe6e						ier:
233	>fe6e						                .fill 1         ;14
234	.fe6f						oraNoHandshake:
235	.fe6f						iraNoHandshake:
236	>fe6f						                .fill 1         ;15

238	.fe70						irq: .block
239	=1						ca2=1
240	=2						ca1=2
241	=4						sr=4
242	=8						cb2=8
243	=16						cb1=16
244	=32						t2=32
245	=64						t1=64
246							                .endblock
247							                .ends
255							                .endv

257							                .virtual $fee0
258	.fee0						tube: .block
259							; Parasite to Host: Carries the OSWRCH call. Data register is a FIFO
260							; that can handle a VDU command length (10 bytes).
261							;
262							; Host to Parasite: There is a 1 byte buffer. It is used to generate
263							; IRQ's in the parasite from events in the host.

265							; write/read (clears IRQ)
266	.fee0						status1: .block
267							; [Tube p13]
268	=$01						Q=$01                           ;enable HIRQ from R4
269	=$02						I=$02                           ;enable PIRQ from R1
270	=$04						J=$04                           ;enable PIRQ from R3
271	=$08						M=$08                           ;enable PNMI from R3
272	=$10						V=$10                           ;2-byte R3
273	=$20						P=$20                           ;activate PRST
274	=$40						T=$40                           ;clear all Tube registers
275	=$80						S=$80                           ;set/clear bits
276							                .bend
277	>fee0						                .fill 1

279							; bit 7 - data available/IRQ
280							; bit 6 - not full
281	.fee1						data1:
282	>fee1						                .fill 1

284							; Used to implement OS calls that take a long time or that cannot
285							; interrupt Host tasks. The parasite passes a byte describing the
286							; required task. The two processors then exchange data until the task
287							; is complete. OS calls handled through this register include: OSRDCH,
288							; OSCLI, OSBYTE, OSWORD, OSBPUT, OSBGET, OSFIND, OSARGS, OSFILE,
289							; OSGBPB.

291							; write/read
292	.fee2						status2:
293	>fee2						                .fill 1

295							; bit 7 - data available
296							; bit 6 - not full
297	.fee3						data2:
298	>fee3						                .fill 1

300							; Used for the background task of fast data transfer between the two
301							; processors.

303							; write/read
304	.fee4						status3:
305	>fee4						                .fill 1

307							; bit 7 - data available/NMI
308							; bit 6 - not full
309	.fee5						data3:
310	>fee5						                .fill 1

312							; Used as the control channel for block transfers going through
313							; Register 3, and also the transfer register for error strings from
314							; host to parasite. In both cases, the host interrupts the parasite by
315							; placing a byte into the Register. In the former case it is a byte
316							; describing the required action, in the latter it is an error code.

318							; write (sets IRQ)/read (clears IRQ)
319	.fee6						status4:
320	>fee6						                .fill 1

322							; bit 7 - data available/IRQ
323							; bit 6 - not full/IRQ
324	.fee7						data4:
325	>fee7						                .fill 1
326							                .bend
327							                .endv

329							RTC: .struct
330	>0000						seconds: .fill 1
331	>0001						secondsAlarm: .fill 1
332	>0002						minutes: .fill 1
333	>0003						minutesAlarm: .fill 1
334	>0004						hours: .fill 1
335	>0005						hoursAlarm: .fill 1
336	>0006						dayOfWeek: .fill 1
337	>0007						dayOfMonth: .fill 1
338	>0008						month: .fill 1
339	>0009						year: .fill 1
340	.000a						a: .block
341	=7						dvMask=7
342	=4						dvShift=4
343	=0						dv4194304Hz=0<<dvShift
344	=16						dv1048576Hz=1<<dvShift
345	=32						dv32768Hz=2<<dvShift
346	>000a						                .fill 1
347							                .endblock
348	.000b						b: .block
349	=$80						set=$80
350	=$02						_24h=$02
351	=$01						dse=$01
352	>000b						                .fill 1
353							                .endblock
354	.000c						c: .block
355	=$10						uf=$10
356	>000c						                .fill 1
357							                .endblock
358	.000d						d: .block
359	>000d						                .fill 1
360							                .endblock
361	=50						ram_size=50
362	>000e						ram: .fill ram_size
363							                .endstruct

:1	;******  Return to file: mos320multios.s65

2							                .include "src/mos_workspace.s65"

:3	;******  Processing file: src/mos_workspace.s65


2							;-------------------------------------------------------------------------
3							;
4							; Disorganized jumble of constants. They'll get tidied up at some
5							; point... promise...
6							;
7							;-------------------------------------------------------------------------

9							; These variant flags are applicable to the stated versions only, and
10							; may or may not be separable from the various .if/.endif constructs
11							; for that version. If they're set for any other version, the output
12							; may not make sense.

14							                .weak
15							                ; Set if building Olivetti MOS, a variant of 5.10.
16	=false						olivetti=false

18							                ; Set if building CFA3000 MOS, a variant of 3.50.
19	=false						CFA3000=false

21							                ; Set if building Autocue 1500 MOS, a variant of 5.11.
22	=false						autocue=false

24							                ; Set if building MOS 3.29 (Acorn FinMOS), a variant
25							                ; of 3.50.
26	=false						finmos329=false

28							                ; Set if building the Y2K-fixed version found in the
29							                ; RetroClinic multi-OS adapter, a variant of 3.20.
30	=false						multios=false
31							                .endweak

33							;-------------------------------------------------------------------------


36	=$400						tubeHostAddr=$400

38							                .if version==350
45							                .endif

47							;-------------------------------------------------------------------------

49	=$a8						osargsBuffer=$a8                ;4-byte ZP buffer for use with OSARGS
50	=$b8						printMessageAddress=$b8

52							                .virtual $bb
53	.00bb						tapeCurrentOptionsByte: .block
54							                .endblock
55							                .endvirtual

57							                .virtual $f2
58	.00f2						fsStatusByte: .block
59	=$01						inputFileOpen=$01
60	=$02						outputFileOpen=$02
61	=$08						catStatus=$08
62	=$40						eofReached=$40
63	=$80						eofWarningGiven=$80
64							                .endblock
65							                .endvirtual

67							                .virtual $e4
68	.00e4						stringInputOptions: .block
69	=$80						doubleQuotes=$80
70	=$40						spaceNotATerminator=$40
71	=$01						goodString=$01
72							                .endblock
73							                .endvirtual
74	=$e5						stringInputPlingFlag=$e5        ;bit 7 set if last char was '!'
75	=$e6						readCharacterTimedFlag=$e6
76	=$e7						autoRepeatCountdownTimer=$e7
77	=$eb						tapeCritical=$eb
78	=$ec						lastKeyPressedInternal=$ec
79	=$ed						firstKeyPressedInternal=$ed
80	=$f2						stringInputBufferAddress=$f2    ;word

82							;-------------------------------------------------------------------------

84	=$01						romServiceCallAbsoluteWorkspaceClaim=$01 ; memory used only when ROM is paged in
85	=$02						romServiceCallPrivateWorkspaceClaim=$02 ; memory used even when ROM is not paged in
86	=$03						romServiceCallAutoBoot=$03              ;
87	=$04						romServiceCallUnrecognisedCommand=$04   ; star command not recognised
88	=$05						romServiceCallUnrecognisedInterrupt=$05 ;
89	=$06						romServiceCallBreakInstruction=$06      ;
90	=$07						romServiceCallUnrecognisedOSBYTE=$07    ;
91	=$08						romServiceCallUnrecognisedOSWORD=$08    ;
92	=$09						romServiceCallHelp=$09                  ;
93	=$0a						romServiceCallClaimStaticWorkspace=$0A ; (Issued by paged ROMs, not the OS)
94	=$0b						romServiceCallNMIRelease=$0B    ; (Issued by paged ROMs, not the OS)
95	=$0c						romServiceCallNMIClaim=$0C      ; (Issued by paged ROMs, not the OS)
96	=$0d						romServiceCallROMFilingSystemInitialize=$0D    ;
97	=$0e						romServiceCallROMFilingSystemByteGet=$0E    ;
98	=$0f						romServiceCallVectorsClaimed=$0F    ; Used when a filing system starts
99	=$10						romServiceCallSpoolExecClosureWarning=$10    ;
100							;romServiceCallFontImplosionExplosionWarning=$11    ;
101	=$12						romServiceCallInitialiseFilingSystem=$12    ; (Issued from paged ROMs, not the OS)
102	=$15						romServiceCallPollingInterrupt=$15
103	=$18						romServiceCallReserved=$18
104	=$21						romServiceCallAbsoluteHAZELWorkspaceClaim=$21
105	=$22						romServiceCallPrivateHAZELWorkspaceClam=$22
106	=$23						romServiceCallTopOfHAZELWorkspace=$23
107	=$24						romServiceCallCountDynamicHAZELWorkspace=$24
108	=$25						romServiceCallRequestFSInfo=$25
109	=$26						romServiceCallCloseAllOpenFiles=$26
110	=$27						romServiceCallInformReset=$27
111	=$28						romServiceCallUnknownCONFIG=$28
112	=$29						romServiceCallUnknownSTATUS=$29
113	=$2a						romServiceCallLanguageChange=$2a
114	=$30						romServiceCall30=$30
115	=$fe						romServiceCallTubeSystemPostInitialisation=$FE    ;
116	=$ff						romServiceCallTubeMainInitialisation=$FF    ;

118							;-------------------------------------------------------------------------

120							; [MasRef D.2-24]

122	=0						eventOutputBufferEmpty=0
123	=1						eventInputBufferFull=1
124	=2						eventCharacterEnteringBuffer=2
125	=3						eventADCConversionComplete=3
126	=4						eventStartOfVerticalSync=4
127	=5						eventIntervalTimerCrossingZero=5
128	=6						eventESCAPEPressed=6
129	=7						eventRS423Error=7
130	=8						eventNetworkError=8
131	=9						eventUser=9
132	=9						eventMax=9

134							;-------------------------------------------------------------------------

136							; [MasRef D.2-27]

138							; Input buffers
139	=0						bufferKeyboard=0
140	=1						bufferRS423Input=1

142							; Output buffers
143	=2						bufferFirstOutput=2
144	=2						bufferRS423Output=2
145	=3						bufferPrinter=3
146	=4						bufferSoundChannel0=4
147	=5						bufferSoundChannel1=5
148	=6						bufferSoundChannel2=6
149	=7						bufferSoundChannel3=7
150							; What's buffer 8? Previously speech on OS 1.20. There's indices
151							; allocated for it...
152	=8						bufferMax=8


155	=$03e0						bufferKeyboardAddress=$03e0
156	=32						bufferKeyboardSize=32
157	=$0a00						bufferRS423InputAddress=$0a00
158	=256						bufferRS423InputSize=256
159	=$0900						bufferRS423OutputAddress=$0900
160	=192						bufferRS423OutputSize=192
161	=$0880						bufferPrinterAddress=$0880
162	=64						bufferPrinterSize=64
163	=$0840						bufferSoundChannel0Address=$0840
164	=16						bufferSoundChannel0Size=16
165	=$0850						bufferSoundChannel1Address=$0850
166	=16						bufferSoundChannel1Size=16
167	=$0860						bufferSoundChannel2Address=$0860
168	=16						bufferSoundChannel2Size=16
169	=$0870						bufferSoundChannel3Address=$0870
170	=16						bufferSoundChannel3Size=16
171	=$09c0						buffer8Address=$09c0
172	=64						buffer8Size=64



176							; BufferInfo: .function bufferAddress,bufferSizeByte
177							;                 .endfunction (bufferAddress,256-bufferSizeByte)

179							; ; buffer info is (base address,size)
180							;  _:=[]
181							; _..=[BufferInfo($0300,32)];bufferKeyboard=0
182							; _..=[BufferInfo($0a00,256)];bufferRS423Input=1
183							; _..=[BufferInfo($08c0,192)];bufferRS423Output=2
184							; _..=[BufferInfo($07c0,64)];bufferPrinter=3
185							; _..=[BufferInfo($0750,16)];bufferSoundChannel0=4
186							; _..=[BufferInfo($0760,16)];bufferSoundChannel1=5
187							; _..=[BufferInfo($0770,16)];bufferSoundChannel2=6
188							; _..=[BufferInfo($0780,16)];bufferSoundChannel3=7
189							; _..=[BufferInfo($0900,64)];What's buffer 8?

191							;-------------------------------------------------------------------------

193							; [MasRef C.5-5]

195	=0						printerDriverTypeSink=0
196	=1						printerDriverTypeParallel=1
197	=2						printerDriverTypeSerial=2
198	=3						printerDriverTypeUser=3
199	=4						printerDriverTypeNetwork=4

201							; AUG p259

203	=0						printerDriverPoll=0
204	=1						printerDriverActivate=1
205	=2						printerDriverVDU2=2
206	=3						printerDriverVDU3=3
207	=5						printerDriverFX5=5

209	=10						printerDriverFX3=10             ;undocumented???

211							;-------------------------------------------------------------------------

213							; AUG p261

215	=0						netPrinterRequest0=0
216	=1						netPrinterRequest1=1
217	=2						netPrinterRequest2=2
218	=3						netPrinterRequest3=3
219	=4						netWriteCharacterAttempted=4
220	=5						netPrinterRequest5=5
221	=6						netReadCharacterAttempted=6
222	=7						netOSBYTEAttempted=7
223	=8						netOSWORDAttempted=8
224	=13						netOSWORD0Complete=13

226							;-------------------------------------------------------------------------

228	=0						fscOPT=0
229	=1						fscCheckEOF=1
230	=2						fscStarSlash=2
231	=3						fscUnknownCommand=3
232	=4						fscStarRUN=4
233	=5						fscStarCAT=5
234	=6						fscNewFS=6
235	=7						fscFileHandleRange=7
236	=8						fscStarCommand=8
237	=9						fscStarEX=9
238	=10						fscStarINFO=10
239	=11						fscRUNLibrary=11

241							; NAUG mentions this. But it doesn't appear to
242							; actually exist in the code.
243							;
244							; Maybe it's present in MOS 3.50 or later?
245	=12						fscRENAME=12

247	=1						gbpbPutBytesNewPTR=1            ;[AUG p340]
248	=2						gbppPutBytesCurrentPTR=2        ;[AUG p340]
249	=3						gbpbGetBytesNewPTR=3            ;[AUG p341]
250	=4						gbpbGetBytesCurrentPTR=4        ;[AUG p341]
251	=5						gbpbGetMediaMetadata=5          ;[AUG p341]
252	=6						gbpbGetCurrentDevice=6          ;[AUG p341]
253	=7						gbpbGetLibraryDevice=7          ;[AUG p341]
254	=8						gbpbReadFileNames=8             ;[AUG p341]

256							OSGBPBParameterBlock: .struct
257	.0000						handle:
258	>0000						                .fill 1
259	.0001						address:
260	>0001						                .fill 4
261	.0005						count:
262	>0005						                .fill 4
263	.0009						ptr:
264	>0009						                .fill 4
265							                .endstruct

267	=0						argsGetFS=0                     ;[AUG p337]
268	=1						argsGetCommandLine=1            ;[AUG p338]
269	=2						argsCheckANFS=2                 ;https://beebwiki.mdfs.net/OSARGS
270	=3						argsGetLibFS=3                  ;
271	=$ff						argsFlushBuffers=$ff            ;[AUG p338]

273	=0						argsFileGetPTR=0
274	=1						argsFileSetPTR=1
275	=2						argsFileGetEXT=2
276	=$ff						argsFileFlush=$ff

278	=0						fileSave=0                      ;[AUG p336]
279	=1						fileWriteMetadata=1             ;[AUG p336]
280	=2						fileWriteLoadAddress=2          ;[AUG p336]
281	=3						fileWriteExecAddress=3          ;[AUG p336]
282	=4						fileWritettributes=4            ;[AUG p336]
283	=5						fileReadMetadata=5              ;[AUG p336]
284	=6						fileDelete=6                    ;[AUG p336]
285	=$ff						fileLoad=$ff                    ;[AUG p336]

287							OSFILEParameterBlock: .struct
288	.0000						fileName:
289	>0000						                .fill 2
290	.0002						addresses:
291	.0002						load:
292	>0002						                .fill 4
293	.0006						exec:
294	>0006						                .fill 4
295	.000a						length:
296	.000a						saveStart:
297	>000a						                .fill 4
298	.000e						attributes:
299	.000e						saveEnd:
300	>000e						                .fill 4
301							                .endstruct

303							;-------------------------------------------------------------------------

305	=0						bufferNumberKeyboard=0          ;
306	=1						bufferNumberRS423Input=1        ;
307	=2						bufferNumberRS423Output=2       ;
308	=3						bufferNumberPrinter=3           ;
309	=4						bufferNumberSound0=4            ; Noise channel
310	=5						bufferNumberSound1=5            ;
311	=6						bufferNumberSound2=6            ;
312	=7						bufferNumberSound3=7            ;
313							; bufferNumberSpeech=8            ;
314	=8						bufferNumberHighest=8           ;

316							;-------------------------------------------------------------------------

318							; uservIndex=0
319							; brkvIndex=1
320							; irq1vIndex=2
321							; irq2vIndex=3
322							; clivIndex=4
323							; bytevIndex=5
324							; wordvIndex=6
325							; wrchvIndex=7
326							; rdchvIndex=8
327							; filevIndex=9
328							; argsvIndex=10
329							; bgetvIndex=11
330							; bputvIndex=12
331							; gbpbvIndex=13
332							; findvIndex=14
333							; fscvIndex=15
334							; eventvIndex=16
335							; uptvIndex=17
336							; netvIndex=18
337							; vduvIndex=19
338							; keyvIndex=20
339							; insvIndex=21
340							; remvIndex=22
341							; cnpvIndex=23
342							; ind1vIndex=24
343							; ind2vIndex=25
344							; ind3vIndex=26


347							                .virtual $200
348	.0200						vectors:
349	.0200						USERV:
350	>0200						                .fill 2
351	.0202						BRKV:
352	>0202						                .fill 2
353	.0204						IRQ1V:
354	>0204						                .fill 2
355	.0206						IRQ2V:
356	>0206						                .fill 2
357	.0208						CLIV:
358	>0208						                .fill 2
359	.020a						BYTEV:
360	>020a						                .fill 2
361	.020c						WORDV:
362	>020c						                .fill 2
363	.020e						WRCHV:
364	>020e						                .fill 2
365	.0210						RDCHV:
366	>0210						                .fill 2
367	.0212						FILEV:
368	>0212						                .fill 2
369	.0214						ARGSV:
370	>0214						                .fill 2
371	.0216						BGETV:
372	>0216						                .fill 2
373	.0218						BPUTV:
374	>0218						                .fill 2
375	.021a						GBPBV:
376	>021a						                .fill 2
377	.021c						FINDV:
378	>021c						                .fill 2
379	.021e						FSCV:
380	>021e						                .fill 2
381	.0220						EVENTV:
382	>0220						                .fill 2
383	.0222						UPTV:
384	>0222						                .fill 2
385	.0224						NETV:
386	>0224						                .fill 2
387	.0226						VDUV:
388	>0226						                .fill 2
389	.0228						KEYV:
390	>0228						                .fill 2
391	.022a						INSV:
392	>022a						                .fill 2
393	.022c						REMV:
394	>022c						                .fill 2
395	.022e						CNPV:
396	>022e						                .fill 2
397	.0230						IND1V:
398	>0230						                .fill 2
399	.0232						IND2V:
400	>0232						                .fill 2
401	.0234						IND3V:
402	>0234						                .fill 2
403	.0236						mosVariables:

405							; OSBYTE 166 (&A6) Read start address of MOS variables [MasRef D.2-50]
406							; OSBYTE 167 (&A7) Read start address of MOS variablespointer table  [MasRef D.2-50]
407	>0236						mosVariablesAddress: .fill 2

409							; OSBYTE 168 (&A8) Read address of ROM pointer table [MasRef D.2-51]
410							; OSBYTE 169 (&A9) Read address of ROM pointer table [MasRef D.2-51]
411	>0238						extendedVectorSpaceAddress: .fill 2

413							; OSBYTE 170 (&AA) Read address of ROM information table [MasRef D.2-51]
414							; OSBYTE 171 (&AB) Read address of ROM information table [MasRef D.2-51]
415	>023a						romInformationTableAddress: .fill 2

417							; OSBYTE 172 (&AC) Read address of keyboard translation table [MasRef D.2-52]
418							; OSBYTE 173 (&AD) Read address of keyboard translation table [MasRef D.2-52]
419	>023c						keyboardTranslationTableAddress: .fill 2

421							; OSBYTE 174 (&AE) Read address of VDU variables origin [MasRef D.2-52]
422							; OSBYTE 175 (&AF) Read address of VDU variables origin [MasRef D.2-52]
423	>023e						vduVariablesAddress: .fill 2

425							; OSBYTE 176 (&B0) Read/Write CFS timeout counter [MasRef D.2-52]
426	>0240						cfsTimeoutCounter: .fill 1

428							; OSBYTE 177 (&B1) Read/write input source [MasRef D.2-53]
429	>0241						inputSource: .fill 1

431							; OSBYTE 178 (&B2) Read/write keyboard semaphore [MasRef D.2-53]
432	>0242						keyboardSemaphore: .fill 1

434							; OSBYTE 179 (&B3) Read/write ROM polling semaphore [MasRef D.2-54]
435	>0243						romPollingSemaphore: .fill 1

437							; OSBYTE 180 (&B4) Read/write Operating System High [MasRef D.2-54]
438	>0244						oshwm: .fill 1

440							; OSBYTE 181 (&B5) Read/write RS243 input interpretation [MasRef D.2-54]
441	>0245						rs423InputInterpretationStatus: .fill 1

443							; OSBYTE 182 (&B6) Read NOIGNORE state [MasRef D.2-55]
444							;
445							; TODO - not a great name, no matter how official - should probably be usePrinterIgnoreChar or something
446	>0246						noignoreState: .fill 1

448							; OSBYTE 183 (&B7) Read/write cassette/ROM filing system [MasRef D.2-55]
449	>0247						cfsRFSFSSwitch: .fill 1

451							; OSBYTE 184 (&B8) Read OS copy of video ULA control [MasRef D.2-56]
452	>0248						vcontrolRegister: .fill 1

454							; OSBYTE 185 (&B9) Read OS copy of video ULA palette [MasRef D.2-56]
455	>0249						vpaletteRegister: .fill 1

457							; OSBYTE 186 (&BA) Read ROM number active at last BRK [MasRef D.2-56]
458	>024a						romActiveAtLastBRK: .fill 1

460							; OSBYTE 187 (&BB) Read ROM number of socket [MasRef D.2-57]
461	>024b						basicROMNumber: .fill 1

463							; OSBYTE 188 (&BC) Read current ADC channel number [MasRef D.2-57]
464	>024c						currentADCChannel: .fill 1

466							; OSBYTE 189 (&BD) Read maximum ADC channel number [MasRef D.2-57]
467	>024d						maximumADCChannel: .fill 1

469							; OSBYTE 190 (&BE) Read/write ADC conversion type [MasRef D.2-58]
470	>024e						adcConversionType: .fill 1

472							; OSBYTE 191 (&BF) Read/write RS423 busy flag [MasRef D.2-58]
473	>024f						rs423Busy: .fill 1

475							; OSBYTE 192 (&C0) Read serial ACIA control register [MasRef D.2-58]
476	>0250						aciaControlRegister: .fill 1

478							; OSBYTE 193 (&C1) Read/write flash counter [MasRef D.2-59]
479	>0251						flashCounter: .fill 1

481							; OSBYTE 194 (&C2) Read/write duration of first colour [MasRef D.2-59]
482	>0252						firstFlashColourDuration: .fill 1

484							; OSBYTE 195 (&C3) Read/write duration of second colour [MasRef D.2-60]
485	>0253						secondFlashColourDuration: .fill 1

487							; OSBYTE 196 (&C4) Read/write keyboard auto-repeat delay [MasRef D.2-60]
488	>0254						keyboardAutoRepeatDelay: .fill 1

490							; OSBYTE 197 (&C5) Read/write keyboard auto-repeat rate [MasRef D.2-60]
491	>0255						keyboardAutoRepeatRate: .fill 1

493							; OSBYTE 198 (&C6) Read/write *EXEC file handle [MasRef D.2-61]
494	>0256						execFileHandle: .fill 1

496							; OSBYTE 199 (&C7) Read/write *SPOOL file handle [MasRef D.2-62]
497	>0257						spoolFileHandle: .fill 1

499							; OSBYTE 200 (&C8) Read/write BREAK and ESCAPE effect [MasRef D.2-62]
500	>0258						breakAndESCAPEEffect: .fill 1

502							; OSBYTE 201 (&C9) Read/write keyboard status [MasRef D.2-63]
503	>0259						keyboardStatus: .fill 1

505							; OSBYTE 202 (&CA) Read/write keyboard status byte [MasRef D.2-63]
506	.025a						keyboardStatusByte: .block
507	=$8						shiftPressed=%1<<3
508	=%10000						capsLockDisengaged=%1<<4
509	=%100000					shiftLockDisengaged=%1<<5
510	=%1000000					ctrlPressed=%1<<6
511	=$80						shiftEnabled=%1<<7
512	>025a						                .fill 1
513							                .endblock

515							; OSBYTE 203 (&CB) Read/write RS423 input buffer [MasRef D.2-64]
516	>025b						rs423InputBufferMinimumSpace: .fill 1

518							; OSBYTE 204 (&CC) Read/write RS423 ignore flag [MasRef D.2-65]
519	>025c						rs423Ignore: .fill 1

521							; OSBYTE 205 (&CD) Read/write RS423 destination [MasRef D.2-65]
522	>025d						rs423Destination: .fill 1

524							; OSBYTE 206 (&CE) Read/write Econet OS call interception [MasRef D.2-66]
525	>025e						econetInterceptionStatus: .fill 1

527							; OSBYTE 207 (&CF) Read/write Econet input interpretation [MasRef D.2-66]
528	>025f						econetInputInterpretationStatus: .fill 1

530							; OSBYTE 208 (&D0) Read write Econet output [MasRef D.2-67]
531	>0260						econetOutputInterpretationStatus: .fill 1

533							; OSBYTE 209 (&D1) is reserved for the speech system [MasRef D.2-67]
534	>0261						speechSystemByte1:  .fill 1

536							; OSBYTE 210 (&D2) Read/write sound suppression status [MasRef D.2-67]
537	>0262						soundSuppressionStatus: .fill 1

539							; OSBYTE 211 (&D3) Read/write BELL channel [MasRef D.2-67]
540	>0263						bellChannel: .fill 1

542							; OSBYTE 212 (&D4) Read/write BELL sound information [MasRef D.2-68]
543	>0264						bellSound: .fill 1

545							; OSBYTE 213 (&D5) Read/write BELL frequency [MasRef D.2-69]
546	>0265						bellFrequency: .fill 1

548							; OSBYTE 214 (&D6) Read/write BELL duration [MasRef D.2-69]
549	>0266						bellDuration: .fill 1

551							; OSBYTE 215 (&D7) Read/write startup message [MasRef D.2-69]
552	>0267						startupMessageSuppressionStatus: .fill 1

554							; OSBYTE 216 (&D8) Read/write length of soft key string [MasRef D.2-70]
555	>0268						softKeyStringLength: .fill 1

557							; OSBYTE 217 (&D9) Read/write paged mode line count [MasRef D.2-71]
558	>0269						pagedModeCounter: .fill 1

560							; OSBYTE 218 (&DA) Read/write bytes in VDU queue [MasRef D.2-71]
561	>026a						vduQueueNegativeLength: .fill 1

563							; OSBYTE 219 (&DB) Read/write TAB key code [MasRef D.2-72]
564	>026b						tabKeyCode: .fill 1

566							; OSBYTE 220 (&DC) Read/write ESCAPE character [MasRef D.2-72]
567	>026c						escapeCharacter: .fill 1

569							; OSBYTE 221 (&DD) Read/write interpretation of input values 192-207 [MasRef D.2-73]
570	>026d						input192To207Interpretation: .fill 1

572							; OSBYTE 222 (&DE) Read/write interpretation of input values 208-223 [MasRef D.2-73]
573	>026e						input208To223Interpretation: .fill 1

575							; OSBYTE 223 (&DF) Read/write interpretation of input values 224-239 [MasRef D.2-73]
576	>026f						input224To239Interpretation: .fill 1

578							; OSBYTE 224 (&E0) Read/write interpretation of input values 240-255 [MasRef D.2-73]
579	>0270						input240To255Interpretation: .fill 1

581							; OSBYTE 225 (&E1) Read/write soft key interpretation [MasRef D.2-74]
582	>0271						softKeyInterpretation: .fill 1

584							; OSBYTE 226 (&E2) Read/write SHIFT+soft key interpretation [MasRef D.2-74]
585	>0272						shiftSoftKeyInterpretation: .fill 1

587							; OSBYTE 227 (&E3) Read/write CTRL+soft key interpretation [MasRef D.2-74]
588	>0273						ctrlSoftKeyInterpretation: .fill 1

590							; OSBYTE 228 (&E4) Read/write SHIFT+CTRL+soft key interpretation [MasRef D.2-74]
591	>0274						shiftCtrlSoftKeyInterpretation: .fill 1

593							; OSBYTE 229 (&E5) Read/write ESCAPE key status [MasRef D.2-75]
594	>0275						escapeKeyStatus: .fill 1

596							; OSBYTE 230 (&E6) Read/write ESCAPE effects [MasRef D.2-75]
597	>0276						escapeEffects: .fill 1

599							; OSBYTE 231 (&E7) Read/write IRQ bit mask for user 6522 [MasRef D.2-76]
600	>0277						userVIAInterruptMask: .fill 1

602							; OSBYTE 232 (&E8) Read/write IRQ bit mask for 6850 [MasRef D.2-76]
603	>0278						rs423InterruptMask: .fill 1

605							; OSBYTE 233 (&E9) Read write IRQ bit mask for system [MasRef D.2-76]
606	>0279						systemVIAInterruptMask: .fill 1

608							; OSBYTE 234 (&EA) Read flag indicating Tube presence [MasRef D.2-76]
609	>027a						tubePresence: .fill 1

611							; OSBYTE 235 (&EB) is reserved for the speech system. [MasRef D.2-77]
612	>027b						speechSystemByte2: .fill 1

614							; OSBYTE 236 (&EC) Read/write character destination status [MasRef D.2-77]
615	.027c						characterDestinationStatus: .block
616	>027c						                .fill 1
617	=1						rs423_enable=1
618	=2						vdu_disable=2
619	=4						printer_disable=4               ;printer always off
620	=8						printer_enable=8                ;printer always on
621	=16						spool_disable=16
622	=64						printer_maybe=64                ;printer on when VDU 1 only
623							                .endblock

625							; OSBYTE 237 (&ED) Read/write cursor editing status [MasRef D.2-77]
626	.027d						editKeysMode: .block
627	=0						editKeys=0                      ;edit keys do editing
628	=1						asciiKeys=1                     ;edit keys are ASCII 135-139
629	=2						functionKeys=2                  ;edit keys are F keys 11-15
630	>027d						                .fill 1
631							                .endblock

633							; OSBYTE 238 (&EE) Read/write numeric keypad [MasRef D.2-78]
634	>027e						numericKeypadInterpretation: .fill 1

636							; OSBYTE 239 (&EF) Read/write *SHADOW state [MasRef D.2-78]
637	>027f						shadowRAMState: .fill 1

639							; OSBYTE 240 (&F0) Read country flag [MasRef D.2-79]
640	>0280						countryFlag: .fill 1

642							; OSBYTE 241 (&F1) Read/write user flag [MasRef D.2-79]
643	>0281						userFlag: .fill 1

645							; OSBYTE 242 (&F2) Read copy of serial processor ULA [MasRef D.2-80]
646	>0282						serialULARegister: .fill 1

648							; OSBYTE 243 (&F3) Read timer switch state [MasRef D.2-80]
649							;
650							; The location holds either 5 (initialTimerSwitchState) or 10
651							; (initialTimerSwitchState^15) - i.e., the offset of the byte after
652							; the last of the timer.
653							;
654							; Various offsets are applied to the timer addresses to make this
655							; work.
656	>0283						timerSwitchState: .fill 1

658							; OSBYTE 244 (&F4) Read/write soft key consistency flag [MasRef D.2-81]
659	>0284						softKeyConsistencyFlag: .fill 1

661							; OSBYTE 245 (&F5) Read printer driver type [MasRef D.2-81[
662	>0285						printerDriverType: .fill 1

664							; OSBYTE 246 (&F6) Read/write printer ignore character [MasRef D.2-81]
665	>0286						printerIgnoreChar: .fill 1

667							; OSBYTE 247 (&F7) Read/write BREAK intercept vector [MasRef D.2-82]
668	>0287						breakVectorByte0: .fill 1

670							; OSBYTE 248 (&F7) Read/write BREAK intercept vector [MasRef D.2-82]
671	>0288						breakVectorByte1: .fill 1

673							; OSBYTE 249 (&F7) Read/write BREAK intercept vector [MasRef D.2-82]
674	>0289						breakVectorByte2: .fill 1

676							; OSBYTE 250 (&FA) Read memory written by VDU driver [MasRef D.2-82]
677	>028a						vduDriverMemory: .fill 1

679							; OSBYTE 251 (&FB) Read memory displayed [MasRef D.2-83]
680	>028b						displayMemory: .fill 1

682							; OSBYTE 252 (&FC) Read/write current language ROM number [MasRef D.2-83]
683	>028c						currentLanguageROM: .fill 1

685							; OSBYTE 253 (&FD) Read last BREAK type [MasRef D.2-83]
686	.028d						lastBREAKType: .block
687	>028d						                .fill 1
688	=0						softBREAK=0
689	=1						powerOn=1
690	=2						hardBREAK=2
691							                .endblock
692							; OSBYTE 254 (&FE) Set effect of SHIFT on numeric keypad [MasRef D.2-84]
693	>028e						numericKeypadShiftEffect: .fill 1
694							; OSBYTE 255 (&FF) Read/write startup options [MasRef D.2-84]
695	>028f						startupOptions: .fill 1
696	=7						modeMask=7

698							                .endvirtual

700	=166						firstMOSVariableOSBYTE=166

702	=5						initialTimerSwitchState=5
703	=$290						tvOffset=$290
704	=$291						tvInterlace=$291
705	=$292						timer0=$292
706	=$297						timer1=$297
707	=$29c						intervalTimer=$29c
708	=$2a1						romInformationTable=$2a1
709	=$2b1						inkeyTimeoutCounter=$2b1
710	=$2b3						osword0MaxLineLength=$2b3
711	=$2b4						osword0MinASCIICharacter=$2b4
712	=$2b5						osword0MaxASCIICharacter=$2b5
713	=$2b6						adcResultLSBs=$2b6
714	=$2ba						adcResultMSBs=$2ba
715	=$2be						adcLastChannelRead=$2be         ;Two names for the same thing!
716	=$2be						adcLastConvertedChannel=$2be    ;Two names for the same thing!
717	=$2bf						eventEnabledFlags=$2bf
718	=$02c9						currentSoftKey=$02c9
719	=$02ca						keyboardFirstAutoRepeatCount=$02ca
720	=$2cb						previousKeyPressedWhenReadingLastKey=$2cb
721	=$2cc						previousKeyPressedWhenReadingFirstKey=$2cc
722	=$2cd						previousKeyPressedWhenReadingOSBYTE=$2cd
723							; soundIsUpdatingFlag=$2ce
724	=$2ce						bufferEmptyFlags=$2ce
725	=$2d7						bufferStartIndices=$2d7
726	=$2e0						bufferEndIndices=$2e0

728	=$2e9						tapeInputCurrentBlockSize=$2e9
729	=$2eb						blockFlagOfCurrentlyResidentBlock=$2eb
730	=$2ec						lastCharacterOfCurrentlyResidentBlock=$2ec

732							; Probably needs a better name :(
733							;
734							; Used by various file routines to store OSGBPB and OSFILE parameter
735							; blocks.
736							;
737							; Used by the clock routines to hold a (possibly partial) mirror of
738							; the RTC time/date registers.
739							;
740							; Used when parsing hex addresses from the command line - obviously
741							; designed primarily for convenient use when building up the OSFILE
742							; parameter block for use with *LOAD and *SAVE.
743	=$2ed						osfileParameterBlock=$2ed

745							; rtcTempData=$2ee

747							ExtendedVectorAddress: .function vectorAddress
749							                .endfunction extendedVectorSpace+(vectorAddress-vectors)/2*3

751							;-------------------------------------------------------------------------

753	=$d9f						extendedVectorSpace=$d9f

755	=$62						key_space=$62
756	=$66						key_comma=$66
757	=$17						key_minus=$17
758	=$67						key_stop=$67
759	=$68						key_slash=$68
760	=$27						key_0=$27
761	=$30						key_1=$30
762	=$31						key_2=$31
763	=$11						key_3=$11
764	=$12						key_4=$12
765	=$13						key_5=$13
766	=$34						key_6=$34
767	=$24						key_7=$24
768	=$15						key_8=$15
769	=$26						key_9=$26
770	=$48						key_colon=$48
771	=$57						key_semicolon=$57
772	=$47						key_at=$47
773	=$41						key_a=$41
774	=$64						key_b=$64
775	=$52						key_c=$52
776	=$32						key_d=$32
777	=$22						key_e=$22
778	=$43						key_f=$43
779	=$53						key_g=$53
780	=$54						key_h=$54
781	=$25						key_i=$25
782	=$45						key_j=$45
783	=$46						key_k=$46
784	=$56						key_l=$56
785	=$65						key_m=$65
786	=$55						key_n=$55
787	=$36						key_o=$36
788	=$37						key_p=$37
789	=$10						key_q=$10
790	=$33						key_r=$33
791	=$51						key_s=$51
792	=$23						key_t=$23
793	=$35						key_u=$35
794	=$63						key_v=$63
795	=$21						key_w=$21
796	=$42						key_x=$42
797	=$44						key_y=$44
798	=$61						key_z=$61
799	=$38						key_left_square_bracket=$38
800	=$78						key_backslash=$78
801	=$58						key_right_square_bracket=$58
802	=$18						key_caret=$18
803	=$28						key_underline=$28
804	=$70						key_escape=$70
805	=$60						key_tab=$60
806	=$40						key_caps_lock=$40
807	=$1						key_ctrl=$1
808	=$50						key_shift_lock=$50
809	=$0						key_shift=$0
810	=$59						key_delete=$59
811	=$69						key_copy=$69
812	=$49						key_return=$49
813	=$39						key_up=$39
814	=$29						key_down=$29
815	=$19						key_left=$19
816	=$79						key_right=$79
817	=$20						key_f0=$20
818	=$71						key_f1=$71
819	=$72						key_f2=$72
820	=$73						key_f3=$73
821	=$14						key_f4=$14
822	=$74						key_f5=$74
823	=$75						key_f6=$75
824	=$16						key_f7=$16
825	=$76						key_f8=$76
826	=$77						key_f9=$77
827	=$6a						key_numpad_0=$6a
828	=$6b						key_numpad_1=$6b
829	=$7c						key_numpad_2=$7c
830	=$6c						key_numpad_3=$6c
831	=$7a						key_numpad_4=$7a
832	=$7b						key_numpad_5=$7b
833	=$1a						key_numpad_6=$1a
834	=$1b						key_numpad_7=$1b
835	=$2a						key_numpad_8=$2a
836	=$2b						key_numpad_9=$2b
837	=$3a						key_numpad_plus=$3a
838	=$3b						key_numpad_minus=$3b
839	=$4a						key_numpad_divide=$4a
840	=$5a						key_numpad_hash=$5a
841	=$5b						key_numpad_multiply=$5b
842	=$5c						key_numpad_comma=$5c
843	=$3c						key_numpad_return=$3c
844	=$4b						key_numpad_delete=$4b
845	=$4c						key_numpad_stop=$4c

847							fsInfoBlock: .struct
848	>0000						name: .fill 8
849	>0008						minHandle: .fill 1
850	>0009						maxHandle: .fill 1
851	>000a						fsNumber: .fill 1
852							                .ends

854							osgbpbBlock: .struct
855	>0000						handle: .fill 1
856	>0001						addr: .fill 4
857	>0005						numBytes: .fill 4
858	>0009						ptr: .fill 4
859							                .ends

861							                ; NAUG p260
862							                .virtual $dc00
863	.dc00						hazel: .block
864	.dc00						commandLine:                    ;dc00
865	>dc00						                .fill 256
866	.dd00						ddxx:                           ;dd00
867	>dd00						                .fill 256
868	.de00						dexx:
869	>de00						                .fill 256
870	.df00						currentFS:                      ;df00
871	>df00						                .fill 1
872	.df01						activeFS:                       ;df01
873	>df01						                .fill 1
874	.df02						libFS:                          ;df02
875	>df02						                .fill 1
876	.df03						currentFSROM:                   ;df03
877	>df03						                .fill 1
878	.df04						commandLinePointer:             ;df04
879	>df04						                .fill 2

881							                ; 17 info blocks in total, but everything is relative
882							                ; to the 0th, so there's only a need to instantiate a
883							                ; struct for that one. Don't think 64tass handles
884							                ; arrays of structs anyway.
885	.df06						fsInfoBlocks:   .dstruct fsInfoBlock ;df06
848	>df06						name: .fill 8
849	>df0e						minHandle: .fill 1
850	>df0f						maxHandle: .fill 1
851	>df10						fsNumber: .fill 1
852							                .ends
886	>df11						                .fill 16*size(fsInfoBlock)
887	.dfc1						fsInfoBlocksTerminator:         ;dfc1
888							                ; space reserved for the 0 terminator when the full
889							                ; set of info blocks are filled.
890	>dfc1						                .fill 1
891	.dfc2						fsFlags: .block                 ;dfc2
892	>dfc2						                .fill 1
893	=$80						useASCII=$80
894	=$80						isAPPEND=$80
895	=$40						noLineNumbers=$40
896							                .bend
897	.dfc3						lineNumberBCD:                  ;dfc3
898	>dfc3						                .fill 2
899	.dfc5						lastCharPrinted:                ;dfc5
900	>dfc5						                .fill 1
901	.dfc6						tempFSFlag:                     ;dfc6
902	>dfc6						                .fill 1
903	.dfc7						moveOSGBPB: .dstruct osgbpbBlock ;dfc7
855	>dfc7						handle: .fill 1
856	>dfc8						addr: .fill 4
857	>dfcc						numBytes: .fill 4
858	>dfd0						ptr: .fill 4
859							                .ends
904	.dfd4						moveSrcHandle:                  ;dfd4
905	>dfd4						                .fill 1
906	.dfd5						moveDestHandle:                 ;dfd5
907	>dfd5						                .fill 1
908	.dfd6						moveBufferMSB:                  ;dfd6
909	>dfd6						                .fill 1
910	.dfd7						moveNumPages:                   ;dfd7
911	>dfd7						                .fill 1
912	.dfd8						moveDestName:                   ;dfd8
913	>dfd8						                .fill 2
914	.dfda						activeFSCV:                     ;dfda
915	>dfda						                .fill 2
916	.dfdc						oldACCCON:                      ;dfdc
917	>dfdc						                .fill 1
918	.dfdd						hasACCCONChanged:                ;dfdd
919	>dfdd						                .fill 1
920	.dfde						dfde:
921	>dfde						                .fill 1
922							                .bend
923							                .endv

925							;-------------------------------------------------------------------------
926							;
927							; VDU variables
928							;
929							; MasRef E.4-1
930							;
931							VDUVariables: .struct
932	.0000						graphicsWindow:
933							;graphicsWindowLeftBottom:
934							; &00 2 Graphics window left column. (p)
935	>0000						graphicsWindowPixelsLeft: .fill 2
936							; &02 2 Graphics window bottom row. (p)
937	>0002						graphicsWindowPixelsBottom: .fill 2
938							;graphicsWindowRightTop:
939							; &04 2 Graphics window right column. (p)
940	>0004						graphicsWindowPixelsRight: .fill 2
941							; &06 2 Graphics window top row. (p)
942	>0006						graphicsWindowPixelsTop: .fill 2
943	.0008						textWindow:
944							; &08 1 Text window left column.
945	>0008						textWindowLeft: .fill 1
946							; &09 1 Text window bottom row.
947	>0009						textWindowBottom: .fill 1
948							; &0A 1 Text window right column.
949	>000a						textWindowRight: .fill 1
950							; &0B 1 Text window top row.
951	>000b						textWindowTop: .fill 1
952							; &0C 2 Graphics origin X coordinate. (e)
953	>000c						graphicsWindowOriginX: .fill 2
954							; &0E 2 Graphics origin Y coordinate. (e)
955	>000e						graphicsWindowOriginY: .fill 2
956							; &10 2 Graphics cursor X coordinate. (e)
957	>0010						graphicsCursorPositionX: .fill 2
958							; &12 2 Graphics cursor Y coordinate. (e)
959	>0012						graphicsCursorPositionY: .fill 2
960							; &14 2 Previous graphics cursor X coordinate. (p)
961	.0014						oldGraphicsCursorPixels:
962	>0014						oldGraphicsCursorPixelsX: .fill 2
963							; &16 2 Previous graphics cursor Y coordinate. (p)
964	>0016						oldGraphicsCursorPixelsY: .fill 2
965							; &18 1 Text cursor X coordinate (from left of screen) when not cursor editing. When cursor editing, normally the input cursor X coordinate, but the output cursor X coordinate within an â<80><9C>unknown PLOT codesâ<80><9D> routine.
966	>0018						textCursorXPosition: .fill 1
967							; &19 1 Text cursor Y coordinate (from top of screen) when not cursor editing. When cursor editing, normally t.lsthe input cursor Y coordinate, but the output cursor Y coordinate within an â<80><9C>unknown PLOT codesâ<80><9D> routine.
968	>0019						textCursorYPosition: .fill 1
969							; &1A 1 Y produced by GADDR (see next section) so that (ZMEMG),Y addresses the correct byte.
970	>001a						graphicsAddressOffset: .fill 1
971							; &1Bâ<80><93>&23 VDU queue: &23 contains last byte of queue, other bytes immediately precede it.
972	=9						queueSize=9
973	>001b						queueBegin: .fill queueSize
974	.0024						queueEnd:
975	.0024						graphicsCursorPixels:
976							; &24 2 Graphics cursor X coordinate. (p)
977	>0024						graphicsCursorPixelsX: .fill 2
978							; &26 2 Graphics cursor Y coordinate. (p)
979	>0026						graphicsCursorPixelsY: .fill 2
980							; &28â<80><93>&49 Workspace. But variable &38 must not be used in a Teletext mode (mode 7 or 135).
981							                .union
982	.0028						hlfw: .dstruct HorizontalLineFillWorkspaceVDUVariables
1198	>0028						                .fill 6
1199	.002e						pixelsX:                        ;2e
1200	>002e						                .fill 2
1201	.0030						pixelsY:                        ;30
1202	>0030						                .fill 2
1203	.0032						pixelsRightEndX:
1204	>0032						                .fill 2         ;32
1205	.0034						pixelsLimitX:                   ;34
1206	>0034						                .fill 2
1207							                .endstruct
983	.0028						mocr: .dstruct MoveOrCopyRectangleWorkspaceVDUVariables
1189	.0028						src: .dstruct VDUAABB
1103	.0028						min: .dstruct VDUCoordinate
1098	>0028						x: .fill 2
1099	>002a						y: .fill 2
1100							                .endstruct
1104	.002c						max: .dstruct VDUCoordinate
1098	>002c						x: .fill 2
1099	>002e						y: .fill 2
1100							                .endstruct
1105							                .endstruct
1190	>0030						                .fill 4
1191	.0034						dest: .dstruct VDUAABB
1103	.0034						min: .dstruct VDUCoordinate
1098	>0034						x: .fill 2
1099	>0036						y: .fill 2
1100							                .endstruct
1104	.0038						max: .dstruct VDUCoordinate
1098	>0038						x: .fill 2
1099	>003a						y: .fill 2
1100							                .endstruct
1105							                .endstruct
1192	>003c						                .fill 9
1193	.0045						copy:
1194	>0045						                .fill 1         ;0=move, 2=copy
1195							                .endstruct
984	.0028						workspace: .dstruct GenericWorkspaceVDUVariables
1108	.0028						_28:
1109	>0028						                .fill 1
1110	.0029						_29:
1111	>0029						                .fill 1
1112	.002a						_2A:
1113	>002a						                .fill 1
1114	.002b						_2B:
1115	>002b						                .fill 1
1116	.002c						_2C:
1117	>002c						                .fill 1
1118	.002d						_2D:
1119	>002d						                .fill 1
1120	.002e						_2E:
1121	>002e						                .fill 1
1122	.002f						_2F:
1123	>002f						                .fill 1
1124	.0030						_30:
1125	>0030						                .fill 1
1126	.0031						_31:
1127	>0031						                .fill 1
1128	.0032						_32:
1129	>0032						                .fill 1
1130	.0033						_33:
1131	>0033						                .fill 1
1132	.0034						_34:
1133	>0034						                .fill 1
1134	.0035						_35:
1135	>0035						                .fill 1
1136	.0036						_36:
1137	>0036						                .fill 1
1138	.0037						_37:
1139	>0037						                .fill 1
1140	.0038						_38:
1141	>0038						                .fill 1
1142	.0039						_39:
1143	>0039						                .fill 1
1144	.003a						_3A:
1145	>003a						                .fill 1
1146	.003b						_3B:
1147	>003b						                .fill 1
1148	.003c						_3C:
1149	>003c						                .fill 1
1150	.003d						_3D:
1151	>003d						                .fill 1
1152	.003e						_3E:
1153	>003e						                .fill 1
1154	.003f						_3F:
1155	>003f						                .fill 1
1156	.0040						_40:
1157	>0040						                .fill 1
1158	.0041						_41:
1159	>0041						                .fill 1
1160	.0042						_42:
1161	>0042						                .fill 1
1162	.0043						_43:
1163	>0043						                .fill 1
1164	.0044						_44:
1165	>0044						                .fill 1
1166	.0045						_45:
1167	>0045						                .fill 1
1168	.0046						_46:
1169	>0046						                .fill 1
1170	.0047						_47:
1171	>0047						                .fill 1
1172	.0048						_48:
1173	>0048						                .fill 1
1174	.0049						_49:
1175	>0049						                .fill 1
1176							                .endstruct
985							                .endunion
986							; &4A 2 Address at which the 6845 is to display the text cursor.
987	>004a						textCursorCRTCAddress: .fill 2
988							; &4C 2 Number of bytes in a character row of the text window.
989	>004c						textWindowWidthInBytes: .fill 2
990							; &4E 1 Most significant byte of address of first byte of screen memory.
991	>004e						startScreenAddressHighByte: .fill 1
992							; &4F 1 Number of bytes in a character.
993	>004f						bytesPerCharacter: .fill 1
994							; &50 2 Address of byte in top left corner of screen display.
995	>0050						screenTopLeftAddress: .fill 2
996							; &52 2 Number of bytes in a character row of the whole screen.
997	>0052						bytesPerCharacterRow: .fill 2
998							; &54 1 Most significant byte of number of bytes of screen memory.
999	>0054						screenSizeHighByte: .fill 1
1000							; &55 1 Current screen mode (in range 0â<80><93>7, i.e. without regard to â<80><98>shadowingâ<80><99>).
1001	>0055						currentScreenMODE: .fill 1
1002							; &56 1 Memory mode: 0 for 20K modes, 1 for 16K modes, 2 for 10K modes, 3 for 8K modes, 4 for 1K modes.
1003	>0056						currentScreenMODEGroup: .fill 1
1004							; &57 1 Foreground text colour mask.
1005	>0057						foregroundTextColour: .fill 1
1006							; &58 1 Background text colour mask.
1007	>0058						backgroundTextColour: .fill 1
1008							; &59 1 0 if plotting graphics foreground, 8 if plotting graphics background.
1009	>0059						graphicsPlotState: .fill 1
1010							; &5A 1 Current graphics plot mode (usually set to one of following two reduced mod 16).
1011	>005a						graphicsPlotMode: .fill 1
1012							; &5B 1 Current graphics foreground plot mode (as set by VDU 18).
1013	>005b						foregroundGCOLMode: .fill 1
1014							; &5C 1 Current graphics background plot mode (as set by VDU 18).
1015	>005c						backgroundGCOLMode: .fill 1
1016							; &5D 2 Address of routine to process current VDU sequence.
1017	>005d						jumpVector: .fill 2
1018							; &5F 1 Value for 6845 register 10 to revert to on leaving cursor editing.
1019	>005f						lastCursorStartRegisterValue: .fill 1
1020							; &60 1 (Number of logical colours)â<88><92>1 (0 if Teletext).
1021	>0060						numberOfLogicalColoursMinusOne: .fill 1
1022							; &61 1 (Number of pixels/byte)â<88><92>1 (0 if not graphics).
1023	>0061						pixelsPerByteMinusOne: .fill 1
1024							; &62 1 Mask for leftmost pixel in a byte.
1025	>0062						colourMaskLeft: .fill 1
1026							; &63 1 Mask for rightmost pixel in a byte.
1027	>0063						colourMaskRight: .fill 1
1028							; &64 1 Output cursor X coordinate when cursor editing, but input cursor X coordinate when cursor editing and inside an â<80><98>unknown PLOT codesâ<80><99> routine.
1029	>0064						editCursorXPosition: .fill 1
1030							; &65 1 Output cursor Y coordinate when cursor editing, but input cursor Y coordinate when cursor editing and inside an â<80><98>unknown PLOT codesâ<80><99> routine.
1031	>0065						editCursorYPosition: .fill 1
1032							; &66 1 Cursor control flags (as set by VDU 23 16).
1033	.0066						cursorFlags: .block
1034	>0066						                .fill 1
1035							; MasRef E.3-18
1036	=$40						noSpecialVDU5Actions=$40
1037	=$20						noMoveCursorAfterPrint=$20
1038	=$10						noVerticalScroll=$10
1039	=$08						swapAxes=$08                    ;if set, X=vert; if clear, X=horiz
1040	=$04						invertVertical=$04              ;if set, vert=up; if clear, vert=down
1041	=$02						invertHorizontal=$02            ;if set, horiz=left; if clear, horiz=right
1042	=$01						scrollProtect=$01
1043							                .endblock
1044							; &67 1 Dot pattern (as set by VDU 23 6).
1045	>0067						dotPattern: .fill 1
1046							; &68 1 Current state of dot pattern.
1047	>0068						dotPatternState: .fill 1
1048							; &69 1 0 if colour being plotted is solid, non-zero if colour is an ECF
1049	>0069						isColourECF: .fill 1
1050							; &6A 1 0 if graphics foreground colour is solid, non-zero if foreground colour is an ECF
1051	>006a						isForegroundECF: .fill 1
1052							; &6B 1 0 if graphics background colour is solid, non-zero if background colour is an ECF
1053	>006b						isBackgroundECF: .fill 1
1054							; &6C 1 Top bit set when cursor is in "column 81".
1055	>006c						column81: .fill 1
1056							; &6D 1 Current graphics foreground colour (as set by VDU 18).
1057	>006d						foregroundGraphicsColour: .fill 1
1058							; &6E 1 Current graphics background colour (as set by VDU 18)
1059	>006e						backgroundGraphicsColour: .fill 1
1060							; &6Fâ<80><93>&7E Software copy of the current palette.
1061	>006f						currentPalette: .fill 16
1062							; &7F 1 Reserved.
1063	>007f						reserved: .fill 1
1064							                .endstruct

1066							                .virtual $300
1067	.0300						vduv: .dstruct VDUVariables
932	.0300						graphicsWindow:
933							;graphicsWindowLeftBottom:
934							; &00 2 Graphics window left column. (p)
935	>0300						graphicsWindowPixelsLeft: .fill 2
936							; &02 2 Graphics window bottom row. (p)
937	>0302						graphicsWindowPixelsBottom: .fill 2
938							;graphicsWindowRightTop:
939							; &04 2 Graphics window right column. (p)
940	>0304						graphicsWindowPixelsRight: .fill 2
941							; &06 2 Graphics window top row. (p)
942	>0306						graphicsWindowPixelsTop: .fill 2
943	.0308						textWindow:
944							; &08 1 Text window left column.
945	>0308						textWindowLeft: .fill 1
946							; &09 1 Text window bottom row.
947	>0309						textWindowBottom: .fill 1
948							; &0A 1 Text window right column.
949	>030a						textWindowRight: .fill 1
950							; &0B 1 Text window top row.
951	>030b						textWindowTop: .fill 1
952							; &0C 2 Graphics origin X coordinate. (e)
953	>030c						graphicsWindowOriginX: .fill 2
954							; &0E 2 Graphics origin Y coordinate. (e)
955	>030e						graphicsWindowOriginY: .fill 2
956							; &10 2 Graphics cursor X coordinate. (e)
957	>0310						graphicsCursorPositionX: .fill 2
958							; &12 2 Graphics cursor Y coordinate. (e)
959	>0312						graphicsCursorPositionY: .fill 2
960							; &14 2 Previous graphics cursor X coordinate. (p)
961	.0314						oldGraphicsCursorPixels:
962	>0314						oldGraphicsCursorPixelsX: .fill 2
963							; &16 2 Previous graphics cursor Y coordinate. (p)
964	>0316						oldGraphicsCursorPixelsY: .fill 2
965							; &18 1 Text cursor X coordinate (from left of screen) when not cursor editing. When cursor editing, normally the input cursor X coordinate, but the output cursor X coordinate within an â<80><9C>unknown PLOT codesâ<80><9D> routine.
966	>0318						textCursorXPosition: .fill 1
967							; &19 1 Text cursor Y coordinate (from top of screen) when not cursor editing. When cursor editing, normally t.lsthe input cursor Y coordinate, but the output cursor Y coordinate within an â<80><9C>unknown PLOT codesâ<80><9D> routine.
968	>0319						textCursorYPosition: .fill 1
969							; &1A 1 Y produced by GADDR (see next section) so that (ZMEMG),Y addresses the correct byte.
970	>031a						graphicsAddressOffset: .fill 1
971							; &1Bâ<80><93>&23 VDU queue: &23 contains last byte of queue, other bytes immediately precede it.
972	=9						queueSize=9
973	>031b						queueBegin: .fill queueSize
974	.0324						queueEnd:
975	.0324						graphicsCursorPixels:
976							; &24 2 Graphics cursor X coordinate. (p)
977	>0324						graphicsCursorPixelsX: .fill 2
978							; &26 2 Graphics cursor Y coordinate. (p)
979	>0326						graphicsCursorPixelsY: .fill 2
980							; &28â<80><93>&49 Workspace. But variable &38 must not be used in a Teletext mode (mode 7 or 135).
981							                .union
982	.0328						hlfw: .dstruct HorizontalLineFillWorkspaceVDUVariables
1198	>0328						                .fill 6
1199	.032e						pixelsX:                        ;2e
1200	>032e						                .fill 2
1201	.0330						pixelsY:                        ;30
1202	>0330						                .fill 2
1203	.0332						pixelsRightEndX:
1204	>0332						                .fill 2         ;32
1205	.0334						pixelsLimitX:                   ;34
1206	>0334						                .fill 2
1207							                .endstruct
983	.0328						mocr: .dstruct MoveOrCopyRectangleWorkspaceVDUVariables
1189	.0328						src: .dstruct VDUAABB
1103	.0328						min: .dstruct VDUCoordinate
1098	>0328						x: .fill 2
1099	>032a						y: .fill 2
1100							                .endstruct
1104	.032c						max: .dstruct VDUCoordinate
1098	>032c						x: .fill 2
1099	>032e						y: .fill 2
1100							                .endstruct
1105							                .endstruct
1190	>0330						                .fill 4
1191	.0334						dest: .dstruct VDUAABB
1103	.0334						min: .dstruct VDUCoordinate
1098	>0334						x: .fill 2
1099	>0336						y: .fill 2
1100							                .endstruct
1104	.0338						max: .dstruct VDUCoordinate
1098	>0338						x: .fill 2
1099	>033a						y: .fill 2
1100							                .endstruct
1105							                .endstruct
1192	>033c						                .fill 9
1193	.0345						copy:
1194	>0345						                .fill 1         ;0=move, 2=copy
1195							                .endstruct
984	.0328						workspace: .dstruct GenericWorkspaceVDUVariables
1108	.0328						_28:
1109	>0328						                .fill 1
1110	.0329						_29:
1111	>0329						                .fill 1
1112	.032a						_2A:
1113	>032a						                .fill 1
1114	.032b						_2B:
1115	>032b						                .fill 1
1116	.032c						_2C:
1117	>032c						                .fill 1
1118	.032d						_2D:
1119	>032d						                .fill 1
1120	.032e						_2E:
1121	>032e						                .fill 1
1122	.032f						_2F:
1123	>032f						                .fill 1
1124	.0330						_30:
1125	>0330						                .fill 1
1126	.0331						_31:
1127	>0331						                .fill 1
1128	.0332						_32:
1129	>0332						                .fill 1
1130	.0333						_33:
1131	>0333						                .fill 1
1132	.0334						_34:
1133	>0334						                .fill 1
1134	.0335						_35:
1135	>0335						                .fill 1
1136	.0336						_36:
1137	>0336						                .fill 1
1138	.0337						_37:
1139	>0337						                .fill 1
1140	.0338						_38:
1141	>0338						                .fill 1
1142	.0339						_39:
1143	>0339						                .fill 1
1144	.033a						_3A:
1145	>033a						                .fill 1
1146	.033b						_3B:
1147	>033b						                .fill 1
1148	.033c						_3C:
1149	>033c						                .fill 1
1150	.033d						_3D:
1151	>033d						                .fill 1
1152	.033e						_3E:
1153	>033e						                .fill 1
1154	.033f						_3F:
1155	>033f						                .fill 1
1156	.0340						_40:
1157	>0340						                .fill 1
1158	.0341						_41:
1159	>0341						                .fill 1
1160	.0342						_42:
1161	>0342						                .fill 1
1162	.0343						_43:
1163	>0343						                .fill 1
1164	.0344						_44:
1165	>0344						                .fill 1
1166	.0345						_45:
1167	>0345						                .fill 1
1168	.0346						_46:
1169	>0346						                .fill 1
1170	.0347						_47:
1171	>0347						                .fill 1
1172	.0348						_48:
1173	>0348						                .fill 1
1174	.0349						_49:
1175	>0349						                .fill 1
1176							                .endstruct
985							                .endunion
986							; &4A 2 Address at which the 6845 is to display the text cursor.
987	>034a						textCursorCRTCAddress: .fill 2
988							; &4C 2 Number of bytes in a character row of the text window.
989	>034c						textWindowWidthInBytes: .fill 2
990							; &4E 1 Most significant byte of address of first byte of screen memory.
991	>034e						startScreenAddressHighByte: .fill 1
992							; &4F 1 Number of bytes in a character.
993	>034f						bytesPerCharacter: .fill 1
994							; &50 2 Address of byte in top left corner of screen display.
995	>0350						screenTopLeftAddress: .fill 2
996							; &52 2 Number of bytes in a character row of the whole screen.
997	>0352						bytesPerCharacterRow: .fill 2
998							; &54 1 Most significant byte of number of bytes of screen memory.
999	>0354						screenSizeHighByte: .fill 1
1000							; &55 1 Current screen mode (in range 0â<80><93>7, i.e. without regard to â<80><98>shadowingâ<80><99>).
1001	>0355						currentScreenMODE: .fill 1
1002							; &56 1 Memory mode: 0 for 20K modes, 1 for 16K modes, 2 for 10K modes, 3 for 8K modes, 4 for 1K modes.
1003	>0356						currentScreenMODEGroup: .fill 1
1004							; &57 1 Foreground text colour mask.
1005	>0357						foregroundTextColour: .fill 1
1006							; &58 1 Background text colour mask.
1007	>0358						backgroundTextColour: .fill 1
1008							; &59 1 0 if plotting graphics foreground, 8 if plotting graphics background.
1009	>0359						graphicsPlotState: .fill 1
1010							; &5A 1 Current graphics plot mode (usually set to one of following two reduced mod 16).
1011	>035a						graphicsPlotMode: .fill 1
1012							; &5B 1 Current graphics foreground plot mode (as set by VDU 18).
1013	>035b						foregroundGCOLMode: .fill 1
1014							; &5C 1 Current graphics background plot mode (as set by VDU 18).
1015	>035c						backgroundGCOLMode: .fill 1
1016							; &5D 2 Address of routine to process current VDU sequence.
1017	>035d						jumpVector: .fill 2
1018							; &5F 1 Value for 6845 register 10 to revert to on leaving cursor editing.
1019	>035f						lastCursorStartRegisterValue: .fill 1
1020							; &60 1 (Number of logical colours)â<88><92>1 (0 if Teletext).
1021	>0360						numberOfLogicalColoursMinusOne: .fill 1
1022							; &61 1 (Number of pixels/byte)â<88><92>1 (0 if not graphics).
1023	>0361						pixelsPerByteMinusOne: .fill 1
1024							; &62 1 Mask for leftmost pixel in a byte.
1025	>0362						colourMaskLeft: .fill 1
1026							; &63 1 Mask for rightmost pixel in a byte.
1027	>0363						colourMaskRight: .fill 1
1028							; &64 1 Output cursor X coordinate when cursor editing, but input cursor X coordinate when cursor editing and inside an â<80><98>unknown PLOT codesâ<80><99> routine.
1029	>0364						editCursorXPosition: .fill 1
1030							; &65 1 Output cursor Y coordinate when cursor editing, but input cursor Y coordinate when cursor editing and inside an â<80><98>unknown PLOT codesâ<80><99> routine.
1031	>0365						editCursorYPosition: .fill 1
1032							; &66 1 Cursor control flags (as set by VDU 23 16).
1033	.0366						cursorFlags: .block
1034	>0366						                .fill 1
1035							; MasRef E.3-18
1036	=$40						noSpecialVDU5Actions=$40
1037	=$20						noMoveCursorAfterPrint=$20
1038	=$10						noVerticalScroll=$10
1039	=$08						swapAxes=$08                    ;if set, X=vert; if clear, X=horiz
1040	=$04						invertVertical=$04              ;if set, vert=up; if clear, vert=down
1041	=$02						invertHorizontal=$02            ;if set, horiz=left; if clear, horiz=right
1042	=$01						scrollProtect=$01
1043							                .endblock
1044							; &67 1 Dot pattern (as set by VDU 23 6).
1045	>0367						dotPattern: .fill 1
1046							; &68 1 Current state of dot pattern.
1047	>0368						dotPatternState: .fill 1
1048							; &69 1 0 if colour being plotted is solid, non-zero if colour is an ECF
1049	>0369						isColourECF: .fill 1
1050							; &6A 1 0 if graphics foreground colour is solid, non-zero if foreground colour is an ECF
1051	>036a						isForegroundECF: .fill 1
1052							; &6B 1 0 if graphics background colour is solid, non-zero if background colour is an ECF
1053	>036b						isBackgroundECF: .fill 1
1054							; &6C 1 Top bit set when cursor is in "column 81".
1055	>036c						column81: .fill 1
1056							; &6D 1 Current graphics foreground colour (as set by VDU 18).
1057	>036d						foregroundGraphicsColour: .fill 1
1058							; &6E 1 Current graphics background colour (as set by VDU 18)
1059	>036e						backgroundGraphicsColour: .fill 1
1060							; &6Fâ<80><93>&7E Software copy of the current palette.
1061	>036f						currentPalette: .fill 16
1062							; &7F 1 Reserved.
1063	>037f						reserved: .fill 1
1064							                .endstruct
1068							                .endvirtual

1070							; vduQueueItemAddr: .function index
1071							;                 .cerror index<0||index>=vdu.queueSize,"bad VDU queue index"
1072							;                 .endfunction vdu.queue+vdu.queueSize-1-index

1074							; Presumed addresses in ANDY that don't happen to coincide with other
1075							; labels.
1076							;
1077							; MasRef E.4-5, MasRef F.6-10
1078							;
1079							; &8000-83FF  RAM  Soft key expansions buffer
1080							; &8400â<80><93>87FF  RAM  VDU workspace.
1081							; &8800â<80><93>07    RAM  ECF pattern 1 definition.
1082							; &8808â<80><93>0F    RAM  ECF pattern 2 definition.
1083							; &8810â<80><93>17    RAM  ECF pattern 3 definition.
1084							; &8818â<80><93>1F    RAM  ECF pattern 4 definition.
1085							; &8820â<80><93>27    RAM  Current foreground ECF pattern or solid colour.
1086							; &8828â<80><93>2F    RAM  Current background ECF pattern or solid colour.
1087							; &8830â<80><93>BF    RAM  VDU workspace.
1088							; &88C0â<80><93>FF    RAM  Reserved for future expansion.
1089							; &8900â<80><93>FF    RAM  Current definitions of characters &20â<80><93>3F.
1090							; &8A00â<80><93>FF    RAM  Current definitions of characters &40â<80><93>5F.
1091							; &8B00â<80><93>FF    RAM  Current definitions of characters &60â<80><93>7F.
1092							; &8C00â<80><93>FF    RAM  Current definitions of characters &80â<80><93>9F.
1093							; &8D00â<80><93>FF    RAM  Current definitions of characters &A0â<80><93>BF.
1094							; &8E00â<80><93>FF    RAM  Current definitions of characters &C0â<80><93>DF.
1095							; &8F00â<80><93>FF    RAM  Current definitions of characters &E0â<80><93>FF.

1097							VDUCoordinate: .struct
1098	>0000						x: .fill 2
1099	>0002						y: .fill 2
1100							                .endstruct

1102							VDUAABB: .struct
1103	.0000						min: .dstruct VDUCoordinate
1098	>0000						x: .fill 2
1099	>0002						y: .fill 2
1100							                .endstruct
1104	.0004						max: .dstruct VDUCoordinate
1098	>0004						x: .fill 2
1099	>0006						y: .fill 2
1100							                .endstruct
1105							                .endstruct

1107							GenericWorkspaceVDUVariables: .struct
1108	.0000						_28:
1109	>0000						                .fill 1
1110	.0001						_29:
1111	>0001						                .fill 1
1112	.0002						_2A:
1113	>0002						                .fill 1
1114	.0003						_2B:
1115	>0003						                .fill 1
1116	.0004						_2C:
1117	>0004						                .fill 1
1118	.0005						_2D:
1119	>0005						                .fill 1
1120	.0006						_2E:
1121	>0006						                .fill 1
1122	.0007						_2F:
1123	>0007						                .fill 1
1124	.0008						_30:
1125	>0008						                .fill 1
1126	.0009						_31:
1127	>0009						                .fill 1
1128	.000a						_32:
1129	>000a						                .fill 1
1130	.000b						_33:
1131	>000b						                .fill 1
1132	.000c						_34:
1133	>000c						                .fill 1
1134	.000d						_35:
1135	>000d						                .fill 1
1136	.000e						_36:
1137	>000e						                .fill 1
1138	.000f						_37:
1139	>000f						                .fill 1
1140	.0010						_38:
1141	>0010						                .fill 1
1142	.0011						_39:
1143	>0011						                .fill 1
1144	.0012						_3A:
1145	>0012						                .fill 1
1146	.0013						_3B:
1147	>0013						                .fill 1
1148	.0014						_3C:
1149	>0014						                .fill 1
1150	.0015						_3D:
1151	>0015						                .fill 1
1152	.0016						_3E:
1153	>0016						                .fill 1
1154	.0017						_3F:
1155	>0017						                .fill 1
1156	.0018						_40:
1157	>0018						                .fill 1
1158	.0019						_41:
1159	>0019						                .fill 1
1160	.001a						_42:
1161	>001a						                .fill 1
1162	.001b						_43:
1163	>001b						                .fill 1
1164	.001c						_44:
1165	>001c						                .fill 1
1166	.001d						_45:
1167	>001d						                .fill 1
1168	.001e						_46:
1169	>001e						                .fill 1
1170	.001f						_47:
1171	>001f						                .fill 1
1172	.0020						_48:
1173	>0020						                .fill 1
1174	.0021						_49:
1175	>0021						                .fill 1
1176							                .endstruct

1178							HorizontalLineFillWorkspaceZP: .struct
1179	>0000						notByteMatch: .fill 1
1180	>0001						a: .fill 1
1181	>0002						b: .fill 2
1182							;c: .fill 2
1183	>0004						pixelsX: .fill 2
1184	>0006						d: .fill 1
1185	>0007						resultEOR: .fill 1
1186							                .endstruct

1188							MoveOrCopyRectangleWorkspaceVDUVariables: .struct
1189	.0000						src: .dstruct VDUAABB
1103	.0000						min: .dstruct VDUCoordinate
1098	>0000						x: .fill 2
1099	>0002						y: .fill 2
1100							                .endstruct
1104	.0004						max: .dstruct VDUCoordinate
1098	>0004						x: .fill 2
1099	>0006						y: .fill 2
1100							                .endstruct
1105							                .endstruct
1190	>0008						                .fill 4
1191	.000c						dest: .dstruct VDUAABB
1103	.000c						min: .dstruct VDUCoordinate
1098	>000c						x: .fill 2
1099	>000e						y: .fill 2
1100							                .endstruct
1104	.0010						max: .dstruct VDUCoordinate
1098	>0010						x: .fill 2
1099	>0012						y: .fill 2
1100							                .endstruct
1105							                .endstruct
1192	>0014						                .fill 9
1193	.001d						copy:
1194	>001d						                .fill 1         ;0=move, 2=copy
1195							                .endstruct

1197							HorizontalLineFillWorkspaceVDUVariables: .struct
1198	>0000						                .fill 6
1199	.0006						pixelsX:                        ;2e
1200	>0006						                .fill 2
1201	.0008						pixelsY:                        ;30
1202	>0008						                .fill 2
1203	.000a						pixelsRightEndX:
1204	>000a						                .fill 2         ;32
1205	.000c						pixelsLimitX:                   ;34
1206	>000c						                .fill 2
1207							                .endstruct

1209							HorizontalLineFillWorkspaceANDY: .struct
1210	>0000						ecfPattern: .fill 8
1211							                .endstruct

1213	=16						softKeyCount=16
1214	=$400						softKeyDataTotalSize=$400

1216							                .virtual $8000
1217	.8000						andy: .block
1218	.8000						softKeys: .block
1219	>8000						stringLSBs: .fill softKeyCount
1220	>8010						endLSB: .fill 1
1221	>8011						stringMSBs: .fill softKeyCount
1222	>8021						endMSB: .fill 1
1223	.8022						strings:
1224	>8022						                .fill softKeys+$400-*
1225	.8400						end:
1226							                .endblock
1227	>8400						                .fill $8800-*;(softKeyCount*2+1)
1228	.8800						ecfPatterns:
1229	>8800						ecfPattern1: .fill 8
1230	>8808						ecfPattern2: .fill 8
1231	>8810						ecfPattern3: .fill 8
1232	>8818						ecfPattern4: .fill 8
1233	.8820						currentECFPatterns:
1234	>8820						fgECFPattern: .fill 8
1235	>8828						bgECFPattern: .fill 8
1236	.8830						workspace:
1237							                .union
1238	.8830						hlfw: .dstruct HorizontalLineFillWorkspaceANDY
1210	>8830						ecfPattern: .fill 8
1211							                .endstruct
1239	>8830						                .fill 208
1240							                .endunion
1241	.8900						softCharacterDefinitions:
1242	>8900						                .fill (256-32)*8
1243							                .cerror (<andy.softCharacterDefinitions)!=0,"Soft character definitions must be page aligned"
1244							                .cerror *!=$9000,"ANDY is the wrong size"
1245							                .endblock
1246							                .endvirtual


1249	=$8000						L8000=$8000
1250	=$8001						L8001=$8001
1251	=$8002						L8002=$8002
1252	=$8004						L8004=$8004
1253	=$8010						L8010=$8010
1254	=$8011						L8011=$8011
1255	=$8012						L8012=$8012
1256							                ;l8011=$8011
1257							                ;l8012=$8012
1258	=$8021						L8021=$8021

1260							; see $d40d, $d4ae
1261							;
1262							; (suspect these are actually references to $8840-$104 and $8848-$104)
1263	=$873c						L873C=$873c
1264	=$8744						L8744=$8744

1266	=$8400						L8400=$8400
1267	=$8500						L8500=$8500
1268	=$8600						L8600=$8600
1269	=$8700						L8700=$8700
1270	=$87f8						L87F8=$87f8
1271	=$87ff						L87FF=$87FF
1272	=$8800						L8800=$8800
1273	=$8803						L8803=$8803
1274	=$8804						L8804=$8804
1275	=$881e						L881E=$881E
1276	=$8820						L8820=$8820
1277	=$8830						L8830=$8830
1278	=$8831						L8831=$8831
1279	=$8832						L8832=$8832
1280	=$8833						L8833=$8833
1281	=$8834						L8834=$8834
1282	=$8835						L8835=$8835
1283	=$8836						L8836=$8836
1284	=$8837						L8837=$8837
1285	=$8838						L8838=$8838
1286	=$8839						L8839=$8839
1287	=$883a						L883A=$883a
1288	=$883b						L883B=$883b
1289	=$883c						L883C=$883C
1290	=$883d						L883D=$883D
1291	=$883e						L883E=$883e
1292	=$883f						L883F=$883f
1293	=$8840						L8840=$8840
1294	=$8841						L8841=$8841
1295	=$8842						L8842=$8842
1296	=$8843						L8843=$8843
1297	=$8844						L8844=$8844
1298	=$8845						L8845=$8845
1299	=$8846						L8846=$8846
1300	=$8847						L8847=$8847
1301	=$8848						L8848=$8848
1302	=$8849						L8849=$8849
1303	=$884a						L884A=$884a
1304	=$884b						L884B=$884b
1305	=$884c						L884C=$884c
1306	=$884d						L884D=$884d
1307	=$884e						L884E=$884e

1309							                ; written to during startup
1310	=$fe8e						LFE8E=$fe8e

1312							;-------------------------------------------------------------------------

1314							                .virtual $00
1315							                .union
1316	.0000						tubeOSFILEParameterBlock: .dstruct OSFILEParameterBlock
288	.0000						fileName:
289	>0000						                .fill 2
290	.0002						addresses:
291	.0002						load:
292	>0002						                .fill 4
293	.0006						exec:
294	>0006						                .fill 4
295	.000a						length:
296	.000a						saveStart:
297	>000a						                .fill 4
298	.000e						attributes:
299	.000e						saveEnd:
300	>000e						                .fill 4
301							                .endstruct
1317	.0000						tubeOSGBPBParameterBlock: .dstruct OSGBPBParameterBlock
257	.0000						handle:
258	>0000						                .fill 1
259	.0001						address:
260	>0001						                .fill 4
261	.0005						count:
262	>0005						                .fill 4
263	.0009						ptr:
264	>0009						                .fill 4
265							                .endstruct
1318	>0000						tubeLanguageHostAddr: .fill 2
1319							                .endunion
1320	>0012						tubeTransferAddr: .fill 2
1321	>0014						tubeNotClaimed: .fill 1            ;bit 7 clear if tube claimed
1322	>0015						tubeClaimantID: .fill 1
1323	.0016						tubeBrkHandlerAddr:
1324							                ; Tube BRK handler sits here.
1325							                .endv

1327	=$700						tubeStringBuffer=$700
1328	=$0128						tubeOSWORDBuffer=$0128

1330							;-------------------------------------------------------------------------

1332							                .virtual $53
1333	>0053						tubeLanguageParasiteAddr: .fill 4
1334							                .endv

1336							; MasRef E.4-4
1337							                .virtual $d0
1338	.00d0						STATE: .block
1339	>00d0						                .fill 1
1340							                ; D.2-32
1341	=$01						isPrinterEnabled=$01
1342	=$02						isScrollingDisabled=$02
1343	=$04						isPagedScrolling=$04
1344	=$08						isTextWindow=$08
1345	=$10						isShadowMode=$10
1346	=$20						isVDU5=$20
1347	=$40						isCursorEditing=$40
1348	=$80						isVDU21=$80
1349							                .bend

1351	>00d1						ZMASK: .fill 1                       ;Pixel mask
1352	>00d2						ZORA: .fill 1                        ;Text OR mask
1353	>00d3						ZEOR: .fill 1                        ;Text EOR mask
1354	>00d4						ZGORA: .fill 1                       ;Graphics OR mask
1355	>00d5						ZGEOR: .fill 1                       ;Graphics EOR mask
1356	>00d6						ZMEMG: .fill 2                       ;Graphics pointer
1357	>00d8						ZMEMT: .fill 2                       ;Text pointer
1358	>00da						ZTEMP: .fill 2                       ;Temporary space
1359	>00dc						ZTEMPB: .fill 2                      ;Temporary space
1360	>00de						ZTEMPC: .fill 2                      ;Temporary space
1361	>00e0						ZTEMPD: .fill 2                      ;Temporary space
1362							                .endv

1364							                .virtual ZTEMP
1365	.00da						zhlfw: .dstruct HorizontalLineFillWorkspaceZP
1179	>00da						notByteMatch: .fill 1
1180	>00db						a: .fill 1
1181	>00dc						b: .fill 2
1182							;c: .fill 2
1183	>00de						pixelsX: .fill 2
1184	>00e0						d: .fill 1
1185	>00e1						resultEOR: .fill 1
1186							                .endstruct
1366							                .endv


1369	=$f8						softKeyExpansionPtr=$f8       ;pointer to current char when expanding soft key.
1370	=$fa						SEIWKA=$fa
1371	=$fb						SEIWKB=$fb

1373	=$d8						vduWriteCursor=$d8

1375	=$d00						nmiEntryPoint=$d00

1377	=0						gcolModeOverwrite=0
1378	=1						gcolModeOR=1
1379	=2						gcolModeAND=2
1380	=3						gcolModeEOR=3
1381	=4						gcolModeInvert=4
1382	=5						gcolModeLeave=5

1384							;-------------------------------------------------------------------------

1386							StarKEYWorkspace: .struct
1387	>0000						newStringLength: .fill 1
1388	>0001						destPtr: .fill 2
1389	>0003						srcPtr: .fill 2
1390	>0005						counter: .fill 2
1391							                .endstruct

1393							OSGBPBWorkspace: .struct
1394	>0000						ptr: .fill 2
1395							                .endstruct

1397							ParseFileNameFSWorkspace: .struct
1398	>0000						fsInfoOffset: .fill 1
1399							                .endstruct

1401							OSCLIWorkspace: .struct
1402	>0000						tablePtr: .fill 2
1403							                .endstruct

1405							                ; TODO - could do being renamed, as it's used (in the
1406							                ; same way) by *UNPLUG and *INSERT.
1407							StarROMSWorkspace: .struct
1408	>0000						insertedFlagMask: .fill 1
1409							                .endstruct

1411							TerminalHELPWorkspace: .struct
1412	>0000						tablePtr: .fill 2
1413							                .endstruct

1415							                ; TODO - tediously verbose names. Acronyms work well
1416							                ; enough for the VDU variables. Do the same thing
1417							                ; here.
1418							                .virtual $b0
1419							                .union
1420	.00b0						starKEYWorkspace: .dstruct StarKEYWorkspace
1387	>00b0						newStringLength: .fill 1
1388	>00b1						destPtr: .fill 2
1389	>00b3						srcPtr: .fill 2
1390	>00b5						counter: .fill 2
1391							                .endstruct
1421	.00b0						osgbpbWorkspace: .dstruct OSGBPBWorkspace
1394	>00b0						ptr: .fill 2
1395							                .endstruct
1422	.00b0						parseFileNameFSWorkspace: .dstruct ParseFileNameFSWorkspace
1398	>00b0						fsInfoOffset: .fill 1
1399							                .endstruct
1423	.00b0						oscliWorkspace: .dstruct OSCLIWorkspace
1402	>00b0						tablePtr: .fill 2
1403							                .endstruct
1424	.00b0						starROMSWorkspace: .dstruct StarROMSWorkspace
1408	>00b0						insertedFlagMask: .fill 1
1409							                .endstruct
1425	.00b0						terminalHELPWorkspace: .dstruct TerminalHELPWorkspace
1412	>00b0						tablePtr: .fill 2
1413							                .endstruct
1426							                .endunion
1427							                .endvirtual

1429							;-------------------------------------------------------------------------

1431							; ROM number containing Terminal
1432	=15						terminalROM=15

1434							; ROM number containing the extXXXX entry points
1435							                .if version==320
1436	=14						extROM=14
1441							                .endif

1443							; Base page for VDU routines
1444	=$c0						vduRoutinesPage=$c0

1446							                .if version<500
1447	=14						cmosBytesOffset=RTC.ram
1450							                .endif

1452							CMOSBytes: .struct
1453	>0000						econetStationNumber: .fill 1
1454	>0001						fileServerStationNumber: .fill 1
1455	>0002						fileServerNetworkNumber: .fill 1
1456	>0003						printerServerStationNumber: .fill 1
1457	>0004						printerServerNetworkNumber: .fill 1
1458	.0005						defaultROMs: .block
1459	>0005						                .fill 1
1460	=0						fsShift=0
1461	=4						languageShift=4
1462							                .endblock

1464	>0006						insertedROMs: .fill 2

1466	>0008						editROMByte: .fill 1
1467	>0009						telecommsByte: .fill 1

1469							                ; TODO - don't need to say "default" so much...
1470	.000a						defaults0: .block
1471	>000a						                .fill 1
1472	=7						defaultMODEMask=7
1473	=8						defaultSHADOWMask=8
1474	=16						defaultInterlaceMask=16
1475	=7						defaultTVMask=7
1476	=5						defaultTVShift=5
1477							                .endblock

1479	.000b						defaults1: .block
1480	>000b						                .fill 1
1481	=7						defaultFDRIVEMask=7
1482	=8						defaultShiftLockMask=8
1483	=16						defaultNoLockMask=16
1484	=32						defaultCapsLockMask=32
1485	=64						defaultADFSLoadDirMask=64
1486	=128						defaultFloppyDrive=128
1487							                .endblock

1489	>000c						keyboardAutoRepeatDelay: .fill 1
1490	>000d						keyboardAutoRepeatRate: .fill 1
1491	>000e						printerIgnoreChar: .fill 1

1493	.000f						defaults2: .block
1494	>000f						                .fill 1
1495	=1						tubeOnMask=1
1496	=2						usePrinterIgnoreCharMask=2
1497	=7						serialBaudRateIndexMask=7
1498	=2						serialBaudRateIndexShift=2
1499	=7						fx5SettingMask=7
1500	=5						fx5SettingShift=5
1501							                .endblock

1503	.0010						defaults3: .block
1504	>0010						                .fill 1
1505	=2						loudMask=2
1506	=4						extTubeMask=4
1507	=8						protectedScrollingMask=8
1508	=16						autoBootMask=16
1509	=7						defaultSerialDataFormatMask=7
1510	=5						defaultSerialDataFormatShift=5
1511							                .endblock

1513							                .if version>=500
1532							                .endif

1534							                .endstruct

1536	=$ef						originalA=$ef
1537	=$f0						originalX=$f0
1538	=$f1						originalY=$f1
1539	=$fc						irqTempA=$fc
1540	=$fd						errPtr=$fd                      ;REPTR in OS 1.20
1541	=$ff						escapeFlag=$ff

1543	=$8c0						envelope1Data=$8c0

1545	=$8000						sidewaysROMLanguageEntry=$8000
1546	=$8003						sidewaysROMServiceEntry=$8003
1547							                .virtual $8006
1548	.8006						sidewaysROMType: .block
1549	=32						hasRelocationAddress=32
1550	=64						hasLanguageEntry=64
1551	=128						hasServiceEntry=128
1552							                .endblock
1553							                .endvirtual
1554	=$8007						sidewaysROMCopyrightOffset=$8007
1555	=$8008						sidewaysROMVersion=$8008
1556	=$8009						sidewaysROMName=$8009

1558							;-------------------------------------------------------------------------

1560							                ; [MasRef D.3-22]
1561							ClockStringFormat: .struct
1562	.0000						ddd:
1563	>0000						                .fill 3
1564	>0003						                .fill 1                      ;','
1565	.0004						nn:
1566	>0004						                .fill 2
1567	>0006						                .fill 1                      ;' '
1568	.0007						mmm:
1569	>0007						                .fill 3
1570	>000a						                .fill 1                      ;' '
1571	.000b						yyyy:
1572	>000b						                .fill 4
1573	>000f						                .fill 1                      ;'.'
1574	.0010						hh:
1575	>0010						                .fill 2
1576	>0012						                .fill 1                      ;':'
1577	.0013						mm:
1578	>0013						                .fill 2
1579	>0015						                .fill 1                      ;':'
1580	.0016						ss:
1581	>0016						                .fill 2
1582	.0018						cr:
1583	>0018						                .fill 1                      ;'\n'
1584							                .endstruct

1586							;-------------------------------------------------------------------------

:1	;******  Return to file: mos320multios.s65

3							                .include "src/terminal_workspace.s65"

:4	;******  Processing file: src/terminal_workspace.s65

1							;-------------------------------------------------------------------------

3							; Not really MOS stuff. This is the Terminal ROM zero page workspace.

5	=$70						oldINSV=$70
6	=$72						oldREMV=$72
7							                .cerror oldREMV!=oldINSV+2,"oldREMV and oldINSV must be adjacent"

9							;-------------------------------------------------------------------------

11							beword .macro value
14							                .endm

16							;-------------------------------------------------------------------------

18							zterm: .struct
19	=$39						numRowsMinusOne=$39
20	=$38						numColumns=$38
21	=$37						numColumnsMinusOne=$37
22							; TODO old INSV and oldREMV should probably go in here too!
23							                .endstruct


:1	;******  Return to file: mos320multios.s65


5	=320						version=320
6	=true						multios=true

8							; The number of sections will probably increase, as a longer term goal
9							; is to have a bit of flexibility here. Stuff that's got documented
10							; addresses ($FFxx, default font, VDU driver entry points, etc.) needs
11							; to stay fixed, but, space permitting, other stuff could be
12							; rearranged.

14							*=$ba00
15							                .dsection ext
16							                .cwarn *>$c000,'Ext ROM is too large'

18							*=$8000
19							                .dsection utils
20							                .cwarn *>$c000,'Terminal ROM is too large'

22							*=$c000
23							                .dsection mos
24							                ; there's no need for a size check here - 64tass gives
25							                ; you an error if the code would go past the 64 K
26							                ; barrier.

28							;-------------------------------------------------------------------------

30							                .section ext
31							                .include "src/ext.s65"

:5	;******  Processing file: src/ext.s65

1							; -*- comment-column:45; -*-

3	.ba00						ext: .block

5	.ba00						plotEllipseOutline:
6	.ba00		20 2f bb	jsr $bb2f	                jsr     LBB2F
7							                .if version<500
8	.ba03		80 03		bra $ba08	                bra     LBA08
11							                .endif

13	.ba05						LBA05:
14	.ba05		20 e9 bb	jsr $bbe9	                jsr     LBBE9

16	.ba08						LBA08:
17	.ba08		a2 34		ldx #$34	                ldx     #VDUVariables.workspace._34
18	.ba0a		a0 3c		ldy #$3c	                ldy     #VDUVariables.workspace._3C
19	.ba0c		20 cc d5	jsr $d5cc	                jsr     mos.sortVDUVariableWords
20							                .if version!=350
21	.ba0f		a2 38		ldx #$38	                ldx     #VDUVariables.workspace._38
22							                .endif
23							                .if version<500&&version!=350
24	.ba11		bd 01 03	lda $0301,x	                lda     vduv+1,x
27							                .endif
28	.ba14		8d 43 03	sta $0343	                sta     vduv.workspace._43
29							                .if version<500&&version!=350
30	.ba17		bd 00 03	lda $0300,x	                lda     vduv+0,x
31	.ba1a		aa		tax		                tax
34							                .endif

36	.ba1b						LBA1B:
37	.ba1b		8e 42 03	stx $0342	                stx     vduv.workspace._42
38	.ba1e		20 20 bd	jsr $bd20	                jsr     LBD20
39	.ba21		e8		inx		                inx
40	.ba22		d0 03		bne $ba27	                bne     LBA27
41	.ba24		ee 43 03	inc $0343	                inc     vduv.workspace._43

43	.ba27						LBA27:
44	.ba27		8a		txa		                txa
45	.ba28		d9 00 03	cmp $0300,y	                cmp     vduv+0,y
46	.ba2b		ad 43 03	lda $0343	                lda     vduv.workspace._43
47	.ba2e		f9 01 03	sbc $0301,y	                sbc     vduv+1,y
48	.ba31		30 e8		bmi $ba1b	                bmi     LBA1B
49							                .if version<500&&version!=350
50	.ba33		a2 36		ldx #$36	                ldx     #VDUVariables.workspace._36
51	.ba35		a0 3e		ldy #$3e	                ldy     #VDUVariables.workspace._3E
52	.ba37		20 cc d5	jsr $d5cc	                jsr     mos.sortVDUVariableWords
53	.ba3a		a0 3a		ldy #$3a	                ldy     #VDUVariables.workspace._3A
54	.ba3c		b9 01 03	lda $0301,y	                lda     vduv+1,y
55	.ba3f		8d 43 03	sta $0343	                sta     vduv.workspace._43
56	.ba42		b9 00 03	lda $0300,y	                lda     vduv+0,y
57	.ba45		a8		tay		                tay

59	.ba46						LBA46:
60	.ba46		8c 42 03	sty $0342	                sty     vduv.workspace._42
61	.ba49		20 20 bd	jsr $bd20	                jsr     LBD20
62	.ba4c		98		tya		                tya
63	.ba4d		d0 03		bne $ba52	                bne     LBA52
64	.ba4f		ce 43 03	dec $0343	                dec     vduv.workspace._43

66	.ba52						LBA52:
67	.ba52		88		dey		                dey
68	.ba53		18		clc		                clc
69	.ba54		98		tya		                tya
70	.ba55		fd 00 03	sbc $0300,x	                sbc     vduv+0,x
71	.ba58		ad 43 03	lda $0343	                lda     vduv.workspace._43
72	.ba5b		fd 01 03	sbc $0301,x	                sbc     vduv+1,x
73	.ba5e		10 e6		bpl $ba46	                bpl     LBA46
74	.ba60		ad 2f 03	lda $032f	                lda     vduv.workspace._2F
75	.ba63		10 a0		bpl $ba05	                bpl     LBA05
76	.ba65		80 14		bra $ba7b	                bra     LBA7B

128							                .endif

130	.ba67						plotSolidEllipse:
131	.ba67		20 2f bb	jsr $bb2f	                jsr     LBB2F
132	.ba6a		80 03		bra $ba6f	                bra     LBA6F


135	.ba6c						LBA6C:
136	.ba6c		20 e9 bb	jsr $bbe9	                jsr     LBBE9

138	.ba6f						LBA6F:
139	.ba6f		a2 3a		ldx #$3a	                ldx     #VDUVariables.workspace._3A
140	.ba71		a0 38		ldy #$38	                ldy     #VDUVariables.workspace._38
141	.ba73		20 87 ba	jsr $ba87	                jsr     LBA87
142	.ba76		ad 2f 03	lda $032f	                lda     vduv.workspace._2F
143	.ba79		10 f1		bpl $ba6c	                bpl     LBA6C

145	.ba7b						LBA7B:
146	.ba7b		ee 4d 88	inc $884d	                inc     L884D
147	.ba7e		d0 03		bne $ba83	                bne     LBA83
148	.ba80		ee 4e 88	inc $884e	                inc     L884E

150	.ba83						LBA83:
151	.ba83		a2 3e		ldx #$3e	                ldx     #VDUVariables.workspace._3E
152	.ba85		a0 3c		ldy #$3c	                ldy     #VDUVariables.workspace._3C




157	.ba87						LBA87:



161	.ba87		da		phx		                phx
162	.ba88		5a		phy		                phy
163	.ba89		18		clc		                clc
164	.ba8a		ad 14 03	lda $0314	                lda     vduv.oldGraphicsCursorPixelsX+0
165	.ba8d		79 00 03	adc $0300,y	                adc     vduv+0,y
166	.ba90		8d 40 03	sta $0340	                sta     vduv.workspace._40
167	.ba93		ad 15 03	lda $0315	                lda     vduv.oldGraphicsCursorPixelsX+1
168	.ba96		79 01 03	adc $0301,y	                adc     vduv+1,y
169	.ba99		8d 41 03	sta $0341	                sta     vduv.workspace._41
170	.ba9c		18		clc		                clc
171	.ba9d		ad 14 03	lda $0314	                lda     vduv.oldGraphicsCursorPixelsX+0
172	.baa0		7d 00 03	adc $0300,x	                adc     vduv+0,x
173	.baa3		8d 44 03	sta $0344	                sta     vduv.workspace._44
174	.baa6		ad 15 03	lda $0315	                lda     vduv.oldGraphicsCursorPixelsX+1
175	.baa9		7d 01 03	adc $0301,x	                adc     vduv+1,x
176	.baac		8d 45 03	sta $0345	                sta     vduv.workspace._45
177	.baaf		18		clc		                clc
178	.bab0		ad 16 03	lda $0316	                lda     vduv.oldGraphicsCursorPixelsY+0
179	.bab3		6d 4d 88	adc $884d	                adc     L884D
180	.bab6		a8		tay		                tay
181	.bab7		ad 17 03	lda $0317	                lda     vduv.oldGraphicsCursorPixelsY+1
182	.baba		6d 4e 88	adc $884e	                adc     L884E
183	.babd		20 fe ba	jsr $bafe	                jsr     LBAFE
184	.bac0		7a		ply		                ply
185	.bac1		fa		plx		                plx
186	.bac2		ad 4d 88	lda $884d	                lda     L884D
187	.bac5		0d 4e 88	ora $884e	                ora     L884E
188	.bac8		f0 47		beq $bb11	                beq     rtsBB11
189	.baca		38		sec		                sec
190	.bacb		ad 14 03	lda $0314	                lda     vduv.oldGraphicsCursorPixelsX+0
191	.bace		fd 00 03	sbc $0300,x	                sbc     vduv+0,x
192	.bad1		8d 40 03	sta $0340	                sta     vduv.workspace._40
193	.bad4		ad 15 03	lda $0315	                lda     vduv.oldGraphicsCursorPixelsX+1
194	.bad7		fd 01 03	sbc $0301,x	                sbc     vduv+1,x
195	.bada		8d 41 03	sta $0341	                sta     vduv.workspace._41
196	.badd		38		sec		                sec
197	.bade		ad 14 03	lda $0314	                lda     vduv.oldGraphicsCursorPixelsX+0
198	.bae1		f9 00 03	sbc $0300,y	                sbc     vduv+0,y
199	.bae4		8d 44 03	sta $0344	                sta     vduv.workspace._44
200	.bae7		ad 15 03	lda $0315	                lda     vduv.oldGraphicsCursorPixelsX+1
201	.baea		f9 01 03	sbc $0301,y	                sbc     vduv+1,y
202	.baed		8d 45 03	sta $0345	                sta     vduv.workspace._45
203	.baf0		38		sec		                sec
204	.baf1		ad 16 03	lda $0316	                lda     vduv.oldGraphicsCursorPixelsY+0
205	.baf4		ed 4d 88	sbc $884d	                sbc     L884D
206	.baf7		a8		tay		                tay
207	.baf8		ad 17 03	lda $0317	                lda     vduv.oldGraphicsCursorPixelsY+1
208	.bafb		ed 4e 88	sbc $884e	                sbc     L884E






215	.bafe						LBAFE:
216	.bafe		8c 46 03	sty $0346	                sty     vduv.workspace._46
217	.bb01		8c 42 03	sty $0342	                sty     vduv.workspace._42
218	.bb04		8d 47 03	sta $0347	                sta     vduv.workspace._47
219	.bb07		8d 43 03	sta $0343	                sta     vduv.workspace._43
220	.bb0a		a2 44		ldx #$44	                ldx     #VDUVariables.workspace._44
221	.bb0c		a0 40		ldy #$40	                ldy     #VDUVariables.workspace._40
222	.bb0e		4c e8 da	jmp $dae8	                jmp     mos.LDAE8





228	.bb11						rtsBB11:
229	.bb11		60		rts		                rts




234	.bb12						LBB12:
235	.bb12		68		pla		                pla
236	.bb13		68		pla		                pla
237	.bb14		9c 4d 88	stz $884d	                stz     L884D
238	.bb17		9c 4e 88	stz $884e	                stz     L884E
239	.bb1a		a2 29		ldx #$29	                ldx     #VDUVariables.workspace._29
240	.bb1c		a0 40		ldy #$40	                ldy     #VDUVariables.workspace._40
241	.bb1e		20 fa bd	jsr $bdfa	                jsr     LBDFA
242	.bb21		a2 29		ldx #$29	                ldx     #VDUVariables.workspace._29
243	.bb23		a0 44		ldy #$44	                ldy     #VDUVariables.workspace._44
244	.bb25		20 0c c9	jsr $c90c	                jsr     mos.copyTwoBytesWithinVDUVariables
245	.bb28		a2 44		ldx #$44	                ldx     #VDUVariables.workspace._44
246	.bb2a		a0 40		ldy #$40	                ldy     #VDUVariables.workspace._40
247	.bb2c		4c 87 ba	jmp $ba87	                jmp     LBA87





253	.bb2f						LBB2F:



257	.bb2f		a0 24		ldy #$24	                ldy     #VDUVariables.graphicsCursorPixelsX
258	.bb31		a2 14		ldx #$14	                ldx     #VDUVariables.oldGraphicsCursorPixelsX
259	.bb33		a9 29		lda #$29	                lda     #VDUVariables.workspace._29
260	.bb35		20 78 d6	jsr $d678	                jsr     mos.LD678
261	.bb38		9c 28 03	stz $0328	                stz     vduv.workspace._28
262	.bb3b		a0 22		ldy #$22	                ldy     #VDUVariables.queueEnd-2
263	.bb3d		a2 16		ldx #$16	                ldx     #VDUVariables.oldGraphicsCursorPixelsY
264	.bb3f		a9 2e		lda #$2e	                lda     #VDUVariables.workspace._2E
265	.bb41		20 78 d6	jsr $d678	                jsr     mos.LD678
266	.bb44		ad 2e 03	lda $032e	                lda     vduv.workspace._2E
267	.bb47		0d 2f 03	ora $032f	                ora     vduv.workspace._2F
268	.bb4a		f0 c6		beq $bb12	                beq     LBB12
269	.bb4c		2a		rol a		                rol     a
270	.bb4d		8d 41 88	sta $8841	                sta     L8841
271	.bb50		a0 20		ldy #$20	                ldy     #VDUVariables.queueEnd-4
272	.bb52		a2 14		ldx #$14	                ldx     #VDUVariables.oldGraphicsCursorPixelsX
273	.bb54		a9 2c		lda #$2c	                lda     #VDUVariables.workspace._2C
274	.bb56		20 78 d6	jsr $d678	                jsr     mos.LD678
275	.bb59		9c 2b 03	stz $032b	                stz     vduv.workspace._2B
276	.bb5c		2a		rol a		                rol     a
277	.bb5d		4d 41 88	eor $8841	                eor     L8841
278	.bb60		29 01		and #$01	                and     #1
279	.bb62		8d 41 88	sta $8841	                sta     L8841
280	.bb65		a2 28		ldx #$28	                ldx     #VDUVariables.workspace._28
281	.bb67		a0 2e		ldy #$2e	                ldy     #VDUVariables.workspace._2E
282	.bb69		20 83 bd	jsr $bd83	                jsr     LBD83
283	.bb6c		a2 2b		ldx #$2b	                ldx     #VDUVariables.workspace._2B
284	.bb6e		a0 2e		ldy #$2e	                ldy     #VDUVariables.workspace._2E
285	.bb70		20 83 bd	jsr $bd83	                jsr     LBD83
286	.bb73		ad 41 88	lda $8841	                lda     L8841
287	.bb76		f0 0e		beq $bb86	                beq     LBB86
288	.bb78		38		sec		                sec
289	.bb79		a0 fd		ldy #$fd	                ldy     #$fd

291	.bb7b						LBB7B:
292	.bb7b		a9 00		lda #$00	                lda     #0
293	.bb7d		f9 2e 02	sbc $022e,y	                sbc     vduv.workspace._2B-$fd,y
294	.bb80		99 2e 02	sta $022e,y	                sta     vduv.workspace._2B-$fd,y
295	.bb83		c8		iny		                iny
296	.bb84		d0 f5		bne $bb7b	                bne     LBB7B

298	.bb86						LBB86:
299	.bb86		ad 2e 03	lda $032e	                lda     vduv.workspace._2E
300	.bb89		8d 3c 88	sta $883c	                sta     L883C
301	.bb8c		ad 2f 03	lda $032f	                lda     vduv.workspace._2F
302	.bb8f		20 ce d4	jsr $d4ce	                jsr     mos.LD4CE
303	.bb92		a0 03		ldy #$03	                ldy     #3

305	.bb94						LBB94:
306	.bb94		b9 40 88	lda $8840,y	                lda     $8840,y
307	.bb97		99 30 03	sta $0330,y	                sta     vduv.workspace._30,y
308	.bb9a		88		dey		                dey
309	.bb9b		10 f7		bpl $bb94	                bpl     LBB94
310	.bb9d		a2 0a		ldx #$0a	                ldx     #$a

312	.bb9f						LBB9F:
313	.bb9f		9e 42 88	stz $8842,x	                stz     $8842,x
314	.bba2		ca		dex		                dex
315	.bba3		10 fa		bpl $bb9f	                bpl     LBB9F
316	.bba5		ee 45 88	inc $8845	                inc     L8845
317	.bba8		20 18 bc	jsr $bc18	                jsr     LBC18
318	.bbab		20 18 bc	jsr $bc18	                jsr     LBC18
319	.bbae		9c 4d 88	stz $884d	                stz     L884D
320	.bbb1		9c 4e 88	stz $884e	                stz     L884E
321	.bbb4		a2 3c		ldx #$3c	                ldx     #VDUVariables.workspace._3C
322	.bbb6		a0 36		ldy #$36	                ldy     #VDUVariables.workspace._36
323	.bbb8		20 fa bd	jsr $bdfa	                jsr     LBDFA
324	.bbbb		a2 3e		ldx #$3e	                ldx     #VDUVariables.workspace._3E
325	.bbbd		a0 34		ldy #$34	                ldy     #VDUVariables.workspace._34
326	.bbbf		20 fa bd	jsr $bdfa	                jsr     LBDFA
327	.bbc2		a2 3c		ldx #$3c	                ldx     #VDUVariables.workspace._3C
328	.bbc4		a0 3a		ldy #$3a	                ldy     #VDUVariables.workspace._3A
329	.bbc6		20 d6 d5	jsr $d5d6	                jsr     mos.compareVDUVariableWords
330	.bbc9		10 07		bpl $bbd2	                bpl     LBBD2
331	.bbcb		20 0c c9	jsr $c90c	                jsr     mos.copyTwoBytesWithinVDUVariables
332	.bbce		a2 36		ldx #$36	                ldx     #VDUVariables.workspace._36
333	.bbd0		80 12		bra $bbe4	                bra     LBBE4


336	.bbd2						LBBD2:
337	.bbd2		a2 38		ldx #$38	                ldx     #VDUVariables.workspace._38
338	.bbd4		a0 3e		ldy #$3e	                ldy     #VDUVariables.workspace._3E
339	.bbd6		20 d6 d5	jsr $d5d6	                jsr     mos.compareVDUVariableWords
340	.bbd9		10 3c		bpl $bc17	                bpl     rtsBC17
341	.bbdb		a2 34		ldx #$34	                ldx     #VDUVariables.workspace._34
342	.bbdd		a0 3a		ldy #$3a	                ldy     #VDUVariables.workspace._3A
343	.bbdf		20 0c c9	jsr $c90c	                jsr     mos.copyTwoBytesWithinVDUVariables
344	.bbe2		a2 3e		ldx #$3e	                ldx     #VDUVariables.workspace._3E

346	.bbe4						LBBE4:
347	.bbe4		a0 38		ldy #$38	                ldy     #VDUVariables.workspace._38
348	.bbe6		4c 0c c9	jmp $c90c	                jmp     mos.copyTwoBytesWithinVDUVariables






355	.bbe9						LBBE9:

357	.bbe9		20 18 bc	jsr $bc18	                jsr     LBC18
358	.bbec		a0 3a		ldy #$3a	                ldy     #VDUVariables.workspace._3A
359	.bbee		a2 3c		ldx #$3c	                ldx     #VDUVariables.workspace._3C
360	.bbf0		20 d6 d5	jsr $d5d6	                jsr     mos.compareVDUVariableWords
361	.bbf3		10 0d		bpl $bc02	                bpl     LBC02
362	.bbf5		ad 3c 03	lda $033c	                lda     vduv.workspace._3C
363	.bbf8		8d 3a 03	sta $033a	                sta     vduv.workspace._3A
364	.bbfb		ad 3d 03	lda $033d	                lda     vduv.workspace._3D
365	.bbfe		8d 3b 03	sta $033b	                sta     vduv.workspace._3B
366	.bc01		60		rts		                rts


369	.bc02						LBC02:
370	.bc02		a2 38		ldx #$38	                ldx     #VDUVariables.workspace._38
371	.bc04		a0 3e		ldy #$3e	                ldy     #VDUVariables.workspace._3E
372	.bc06		20 d6 d5	jsr $d5d6	                jsr     mos.compareVDUVariableWords
373	.bc09		10 0c		bpl $bc17	                bpl     rtsBC17
374	.bc0b		ad 3e 03	lda $033e	                lda     vduv.workspace._3E
375	.bc0e		8d 38 03	sta $0338	                sta     vduv.workspace._38
376	.bc11		ad 3f 03	lda $033f	                lda     vduv.workspace._3F
377	.bc14		8d 39 03	sta $0339	                sta     vduv.workspace._39

379	.bc17						rtsBC17:
380	.bc17		60		rts		                rts






387	.bc18						LBC18:
388	.bc18		a2 38		ldx #$38	                ldx     #VDUVariables.workspace._38
389	.bc1a		a0 34		ldy #$34	                ldy     #VDUVariables.workspace._34
390	.bc1c		20 1e c9	jsr $c91e	                jsr     mos.copyFourBytesWithinVDUVariables
391	.bc1f		a2 3c		ldx #$3c	                ldx     #VDUVariables.workspace._3C
392	.bc21		a0 38		ldy #$38	                ldy     #VDUVariables.workspace._38
393	.bc23		20 1e c9	jsr $c91e	                jsr     mos.copyFourBytesWithinVDUVariables
394	.bc26		38		sec		                sec
395	.bc27		ad 30 03	lda $0330	                lda     vduv.workspace._30
396	.bc2a		ed 49 88	sbc $8849	                sbc     L8849
397	.bc2d		8d 36 88	sta $8836	                sta     L8836
398	.bc30		ad 31 03	lda $0331	                lda     vduv.workspace._31
399	.bc33		ed 4a 88	sbc $884a	                sbc     L884A
400	.bc36		8d 37 88	sta $8837	                sta     L8837
401	.bc39		ad 32 03	lda $0332	                lda     vduv.workspace._32
402	.bc3c		ed 4b 88	sbc $884b	                sbc     L884B
403	.bc3f		8d 38 88	sta $8838	                sta     L8838
404	.bc42		ad 33 03	lda $0333	                lda     vduv.workspace._33
405	.bc45		ed 4c 88	sbc $884c	                sbc     L884C
406	.bc48		8d 39 88	sta $8839	                sta     L8839
407	.bc4b		9c 35 88	stz $8835	                stz     L8835
408	.bc4e		9c 34 88	stz $8834	                stz     L8834
409	.bc51		20 4b be	jsr $be4b	                jsr     LBE4B
410	.bc54		ad 28 03	lda $0328	                lda     vduv.workspace._28
411	.bc57		8d 34 88	sta $8834	                sta     L8834
412	.bc5a		ad 29 03	lda $0329	                lda     vduv.workspace._29
413	.bc5d		8d 35 88	sta $8835	                sta     L8835
414	.bc60		ad 2a 03	lda $032a	                lda     vduv.workspace._2A
415	.bc63		8d 36 88	sta $8836	                sta     L8836
416	.bc66		20 0c be	jsr $be0c	                jsr     LBE0C
417	.bc69		18		clc		                clc
418	.bc6a		ad 42 88	lda $8842	                lda     L8842
419	.bc6d		6d 35 88	adc $8835	                adc     L8835
420	.bc70		08		php		                php
421	.bc71		ad 43 88	lda $8843	                lda     L8843
422	.bc74		6d 36 88	adc $8836	                adc     L8836
423	.bc77		8d 3e 03	sta $033e	                sta     vduv.workspace._3E
424	.bc7a		ad 44 88	lda $8844	                lda     L8844
425	.bc7d		6d 37 88	adc $8837	                adc     L8837
426	.bc80		8d 3f 03	sta $033f	                sta     vduv.workspace._3F
427	.bc83		28		plp		                plp
428	.bc84		10 08		bpl $bc8e	                bpl     LBC8E
429	.bc86		ee 3e 03	inc $033e	                inc     vduv.workspace._3E
430	.bc89		d0 03		bne $bc8e	                bne     LBC8E
431	.bc8b		ee 3f 03	inc $033f	                inc     vduv.workspace._3F

433	.bc8e						LBC8E:
434	.bc8e		38		sec		                sec
435	.bc8f		ad 42 88	lda $8842	                lda     L8842
436	.bc92		ed 35 88	sbc $8835	                sbc     L8835
437	.bc95		08		php		                php
438	.bc96		ad 43 88	lda $8843	                lda     L8843
439	.bc99		ed 36 88	sbc $8836	                sbc     L8836
440	.bc9c		8d 3c 03	sta $033c	                sta     vduv.workspace._3C
441	.bc9f		ad 44 88	lda $8844	                lda     L8844
442	.bca2		ed 37 88	sbc $8837	                sbc     L8837
443	.bca5		8d 3d 03	sta $033d	                sta     vduv.workspace._3D
444	.bca8		28		plp		                plp
445	.bca9		10 08		bpl $bcb3	                bpl     LBCB3
446	.bcab		ee 3c 03	inc $033c	                inc     vduv.workspace._3C
447	.bcae		d0 03		bne $bcb3	                bne     LBCB3
448	.bcb0		ee 3d 03	inc $033d	                inc     vduv.workspace._3D

450	.bcb3						LBCB3:
451	.bcb3		18		clc		                clc
452	.bcb4		ad 45 88	lda $8845	                lda     L8845
453	.bcb7		6d 49 88	adc $8849	                adc     L8849
454	.bcba		8d 49 88	sta $8849	                sta     L8849
455	.bcbd		ad 46 88	lda $8846	                lda     L8846
456	.bcc0		6d 4a 88	adc $884a	                adc     L884A
457	.bcc3		8d 4a 88	sta $884a	                sta     L884A
458	.bcc6		ad 47 88	lda $8847	                lda     L8847
459	.bcc9		6d 4b 88	adc $884b	                adc     L884B
460	.bccc		8d 4b 88	sta $884b	                sta     L884B
461	.bccf		ad 48 88	lda $8848	                lda     L8848
462	.bcd2		6d 4c 88	adc $884c	                adc     L884C
463	.bcd5		8d 4c 88	sta $884c	                sta     L884C
464	.bcd8		18		clc		                clc
465	.bcd9		a9 02		lda #$02	                lda     #2
466	.bcdb		6d 45 88	adc $8845	                adc     L8845
467	.bcde		8d 45 88	sta $8845	                sta     L8845
468	.bce1		90 0d		bcc $bcf0	                bcc     LBCF0
469	.bce3		ee 46 88	inc $8846	                inc     L8846
470	.bce6		d0 08		bne $bcf0	                bne     LBCF0
471	.bce8		ee 47 88	inc $8847	                inc     L8847
472	.bceb		d0 03		bne $bcf0	                bne     LBCF0
473	.bced		ee 48 88	inc $8848	                inc     L8848

475	.bcf0						LBCF0:
476	.bcf0		18		clc		                clc
477	.bcf1		ad 42 88	lda $8842	                lda     L8842
478	.bcf4		6d 2b 03	adc $032b	                adc     vduv.workspace._2B
479	.bcf7		8d 42 88	sta $8842	                sta     L8842
480	.bcfa		ad 43 88	lda $8843	                lda     L8843
481	.bcfd		6d 2c 03	adc $032c	                adc     vduv.workspace._2C
482	.bd00		8d 43 88	sta $8843	                sta     L8843
483	.bd03		ad 44 88	lda $8844	                lda     L8844
484	.bd06		6d 2d 03	adc $032d	                adc     vduv.workspace._2D
485	.bd09		8d 44 88	sta $8844	                sta     L8844
486	.bd0c		ee 4d 88	inc $884d	                inc     L884D
487	.bd0f		d0 03		bne $bd14	                bne     LBD14
488	.bd11		ee 4e 88	inc $884e	                inc     L884E

490	.bd14						LBD14:
491	.bd14		ad 2e 03	lda $032e	                lda     vduv.workspace._2E
492	.bd17		d0 03		bne $bd1c	                bne     LBD1C
493	.bd19		ce 2f 03	dec $032f	                dec     vduv.workspace._2F

495	.bd1c						LBD1C:
496	.bd1c		ce 2e 03	dec $032e	                dec     vduv.workspace._2E
497	.bd1f		60		rts		                rts






504	.bd20						LBD20:
505	.bd20		da		phx		                phx
506	.bd21		5a		phy		                phy
507	.bd22		18		clc		                clc
508	.bd23		ad 14 03	lda $0314	                lda     vduv.oldGraphicsCursorPixelsX+0
509	.bd26		6d 42 03	adc $0342	                adc     vduv.workspace._42
510	.bd29		8d 44 03	sta $0344	                sta     vduv.workspace._44
511	.bd2c		ad 15 03	lda $0315	                lda     vduv.oldGraphicsCursorPixelsX+1
512	.bd2f		6d 43 03	adc $0343	                adc     vduv.workspace._43
513	.bd32		8d 45 03	sta $0345	                sta     vduv.workspace._45
514	.bd35		18		clc		                clc
515	.bd36		ad 16 03	lda $0316	                lda     vduv.oldGraphicsCursorPixelsY+0
516	.bd39		6d 4d 88	adc $884d	                adc     L884D
517	.bd3c		8d 46 03	sta $0346	                sta     vduv.workspace._46
518	.bd3f		ad 17 03	lda $0317	                lda     vduv.oldGraphicsCursorPixelsY+1
519	.bd42		6d 4e 88	adc $884e	                adc     L884E
520	.bd45		8d 47 03	sta $0347	                sta     vduv.workspace._47
521	.bd48		a2 44		ldx #$44	                ldx     #VDUVariables.workspace._44
522	.bd4a		20 4c db	jsr $db4c	                jsr     mos.LDB4C
523	.bd4d		ad 4d 88	lda $884d	                lda     L884D
524	.bd50		0d 4e 88	ora $884e	                ora     L884E
525	.bd53		f0 2b		beq $bd80	                beq     LBD80
526	.bd55		38		sec		                sec
527	.bd56		ad 14 03	lda $0314	                lda     vduv.oldGraphicsCursorPixelsX+0
528	.bd59		ed 42 03	sbc $0342	                sbc     vduv.workspace._42
529	.bd5c		8d 44 03	sta $0344	                sta     vduv.workspace._44
530	.bd5f		ad 15 03	lda $0315	                lda     vduv.oldGraphicsCursorPixelsX+1
531	.bd62		ed 43 03	sbc $0343	                sbc     vduv.workspace._43
532	.bd65		8d 45 03	sta $0345	                sta     vduv.workspace._45
533	.bd68		38		sec		                sec
534	.bd69		ad 16 03	lda $0316	                lda     vduv.oldGraphicsCursorPixelsY+0
535	.bd6c		ed 4d 88	sbc $884d	                sbc     L884D
536	.bd6f		8d 46 03	sta $0346	                sta     vduv.workspace._46
537	.bd72		ad 17 03	lda $0317	                lda     vduv.oldGraphicsCursorPixelsY+1
538	.bd75		ed 4e 88	sbc $884e	                sbc     L884E
539	.bd78		8d 47 03	sta $0347	                sta     vduv.workspace._47
540	.bd7b		a2 44		ldx #$44	                ldx     #VDUVariables.workspace._44
541	.bd7d		20 4c db	jsr $db4c	                jsr     mos.LDB4C

543	.bd80						LBD80:
544	.bd80		7a		ply		                ply
545	.bd81		fa		plx		                plx
546	.bd82		60		rts		                rts






553	.bd83						LBD83:
554	.bd83		da		phx		                phx
555	.bd84		b9 00 03	lda $0300,y	                lda     vduv+0,y
556	.bd87		8d 3f 88	sta $883f	                sta     L883F
557	.bd8a		b9 01 03	lda $0301,y	                lda     vduv+1,y
558	.bd8d		8d 40 88	sta $8840	                sta     L8840
559	.bd90		a0 18		ldy #$18	                ldy     #$18 ;not VDUVariables.textCursorXPosition?
560	.bd92		bd 00 03	lda $0300,x	                lda     vduv+0,x
561	.bd95		8d 3a 88	sta $883a	                sta     L883A
562	.bd98		bd 01 03	lda $0301,x	                lda     vduv+1,x
563	.bd9b		8d 3b 88	sta $883b	                sta     L883B
564	.bd9e		bd 02 03	lda $0302,x	                lda     vduv+2,x
565	.bda1		30 0c		bmi $bdaf	                bmi     LBDAF

567	.bda3						LBDA3:
568	.bda3		88		dey		                dey
569	.bda4		f0 52		beq $bdf8	                beq     LBDF8
570	.bda6		0e 3a 88	asl $883a	                asl     L883A
571	.bda9		2e 3b 88	rol $883b	                rol     L883B
572	.bdac		2a		rol a		                rol     a
573	.bdad		10 f4		bpl $bda3	                bpl     LBDA3

575	.bdaf						LBDAF:
576	.bdaf		8d 3c 88	sta $883c	                sta     L883C
577	.bdb2		9c 3d 88	stz $883d	                stz     L883D
578	.bdb5		9c 3e 88	stz $883e	                stz     L883E
579	.bdb8		18		clc		                clc

581	.bdb9						LBDB9:
582	.bdb9		2e 3a 88	rol $883a	                rol     L883A
583	.bdbc		2e 3b 88	rol $883b	                rol     L883B
584	.bdbf		2e 3c 88	rol $883c	                rol     L883C
585	.bdc2		2e 3d 88	rol $883d	                rol     L883D
586	.bdc5		2e 3e 88	rol $883e	                rol     L883E
587	.bdc8		38		sec		                sec
588	.bdc9		ad 3d 88	lda $883d	                lda     L883D
589	.bdcc		ed 3f 88	sbc $883f	                sbc     L883F
590	.bdcf		aa		tax		                tax
591	.bdd0		ad 3e 88	lda $883e	                lda     L883E
592	.bdd3		ed 40 88	sbc $8840	                sbc     L8840
593	.bdd6		90 06		bcc $bdde	                bcc     LBDDE
594	.bdd8		8e 3d 88	stx $883d	                stx     L883D
595	.bddb		8d 3e 88	sta $883e	                sta     L883E

597	.bdde						LBDDE:
598	.bdde		88		dey		                dey
599	.bddf		d0 d8		bne $bdb9	                bne     LBDB9
600	.bde1		fa		plx		                plx
601	.bde2		ad 3a 88	lda $883a	                lda     L883A
602	.bde5		2a		rol a		                rol     a
603	.bde6		9d 00 03	sta $0300,x	                sta     vduv+0,x
604	.bde9		ad 3b 88	lda $883b	                lda     L883B
605	.bdec		2a		rol a		                rol     a
606	.bded		9d 01 03	sta $0301,x	                sta     vduv+1,x
607	.bdf0		ad 3c 88	lda $883c	                lda     L883C
608	.bdf3		2a		rol a		                rol     a
609	.bdf4		9d 02 03	sta $0302,x	                sta     vduv+2,x
610	.bdf7		60		rts		                rts


613	.bdf8						LBDF8:
614	.bdf8		fa		plx		                plx
615	.bdf9		60		rts		                rts






622	.bdfa						LBDFA:
623	.bdfa		38		sec		                sec
624	.bdfb		a9 00		lda #$00	                lda     #0
625	.bdfd		fd 00 03	sbc $0300,x	                sbc     vduv+0,x
626	.be00		99 00 03	sta $0300,y	                sta     vduv+0,y
627	.be03		a9 00		lda #$00	                lda     #0
628	.be05		fd 01 03	sbc $0301,x	                sbc     vduv+1,x
629	.be08		99 01 03	sta $0301,y	                sta     vduv+1,y
630	.be0b		60		rts		                rts






637	.be0c						LBE0C:
638	.be0c		a0 17		ldy #$17	                ldy     #$17
639	.be0e		9c 39 88	stz $8839	                stz     L8839
640	.be11		9c 38 88	stz $8838	                stz     L8838
641	.be14		9c 37 88	stz $8837	                stz     L8837
642	.be17		4e 36 88	lsr $8836	                lsr     L8836
643	.be1a		6e 35 88	ror $8835	                ror     L8835
644	.be1d		6e 34 88	ror $8834	                ror     L8834

646	.be20						LBE20:
647	.be20		90 1c		bcc $be3e	                bcc     LBE3E
648	.be22		18		clc		                clc
649	.be23		ad 30 88	lda $8830	                lda     L8830
650	.be26		6d 37 88	adc $8837	                adc     L8837
651	.be29		8d 37 88	sta $8837	                sta     L8837
652	.be2c		ad 31 88	lda $8831	                lda     L8831
653	.be2f		6d 38 88	adc $8838	                adc     L8838
654	.be32		8d 38 88	sta $8838	                sta     L8838
655	.be35		ad 32 88	lda $8832	                lda     L8832
656	.be38		6d 39 88	adc $8839	                adc     L8839
657	.be3b		8d 39 88	sta $8839	                sta     L8839

659	.be3e						LBE3E:
660	.be3e		18		clc		                clc
661	.be3f		a2 05		ldx #$05	                ldx     #5

663	.be41						LBE41:
664	.be41		7e 34 88	ror $8834,x	                ror     $8834,x
665	.be44		ca		dex		                dex
666	.be45		10 fa		bpl $be41	                bpl     LBE41
667	.be47		88		dey		                dey
668	.be48		10 d6		bpl $be20	                bpl     LBE20
669	.be4a		60		rts		                rts






676	.be4b						LBE4B:
677	.be4b		a2 03		ldx #$03	                ldx     #3

679	.be4d						LBE4D:
680	.be4d		9e 30 88	stz $8830,x	                stz     $8830,x
681	.be50		74 dc		stz $dc,x	                stz     ZTEMPB,x
682	.be52		ca		dex		                dex
683	.be53		10 f8		bpl $be4d	                bpl     LBE4D
684	.be55		a0 05		ldy #$05	                ldy     #5

686	.be57						LBE57:
687	.be57		b9 34 88	lda $8834,y	                lda     $8834,y
688	.be5a		85 da		sta $da		                sta     ZTEMP+0
689	.be5c		5a		phy		                phy
690	.be5d		a0 03		ldy #$03	                ldy     #3

692	.be5f						LBE5F:
693	.be5f		5a		phy		                phy
694	.be60		38		sec		                sec
695	.be61		2e 30 88	rol $8830	                rol     L8830
696	.be64		2e 31 88	rol $8831	                rol     L8831
697	.be67		2e 32 88	rol $8832	                rol     L8832
698	.be6a		2e 33 88	rol $8833	                rol     L8833
699	.be6d		a2 01		ldx #$01	                ldx     #1
700	.be6f		a5 dc		lda $dc		                lda     ZTEMPB+0

702	.be71						LBE71:
703	.be71		06 da		asl $da		                asl     ZTEMP+0
704	.be73		2a		rol a		                rol     a
705	.be74		26 dd		rol $dd		                rol     ZTEMPB+1
706	.be76		26 de		rol $de		                rol     ZTEMPC+0
707	.be78		26 df		rol $df		                rol     ZTEMPC+1
708	.be7a		ca		dex		                dex
709	.be7b		10 f4		bpl $be71	                bpl     LBE71
710	.be7d		85 dc		sta $dc		                sta     ZTEMPB+0
711	.be7f		38		sec		                sec
712	.be80		ed 30 88	sbc $8830	                sbc     L8830
713	.be83		48		pha		                pha
714	.be84		a5 dd		lda $dd		                lda     ZTEMPB+1
715	.be86		ed 31 88	sbc $8831	                sbc     L8831
716	.be89		aa		tax		                tax
717	.be8a		a5 de		lda $de		                lda     ZTEMPC+0
718	.be8c		ed 32 88	sbc $8832	                sbc     L8832
719	.be8f		a8		tay		                tay
720	.be90		a5 df		lda $df		                lda     ZTEMPC+1
721	.be92		ed 33 88	sbc $8833	                sbc     L8833
722	.be95		90 0e		bcc $bea5	                bcc     LBEA5
723	.be97		85 df		sta $df		                sta     ZTEMPC+1
724	.be99		84 de		sty $de		                sty     ZTEMPC+0
725	.be9b		86 dd		stx $dd		                stx     ZTEMPB+1
726	.be9d		68		pla		                pla
727	.be9e		85 dc		sta $dc		                sta     ZTEMPB+0
728	.bea0		ee 30 88	inc $8830	                inc     L8830
729	.bea3		80 04		bra $bea9	                bra     LBEA9


732	.bea5						LBEA5:
733	.bea5		68		pla		                pla
734	.bea6		ce 30 88	dec $8830	                dec     L8830

736	.bea9						LBEA9:
737	.bea9		7a		ply		                ply
738	.beaa		88		dey		                dey
739	.beab		10 b2		bpl $be5f	                bpl     LBE5F
740	.bead		7a		ply		                ply
741	.beae		88		dey		                dey
742	.beaf		10 a6		bpl $be57	                bpl     LBE57
743	.beb1		4e 33 88	lsr $8833	                lsr     L8833
744	.beb4		6e 32 88	ror $8832	                ror     L8832
745	.beb7		6e 31 88	ror $8831	                ror     L8831
746	.beba		6e 30 88	ror $8830	                ror     L8830
747	.bebd		60		rts		                rts

749							;-------------------------------------------------------------------------
750							;
751							; 184â<80><93>191 = Move/copy rectangle [MasRef E.3-31]
752							;
753							; The normal interpretation of <p> does not apply in this group of
754							; plot codes and the meanings are as follows:
755							;
756							; 184, 185 - %1011100x - Move rectangle, relative
757							; 186, 187 - %1011101x - Copy rectangle, relative
758							; 188, 189 - %1011110x - Move rectangle, absolute
759							; 190, 191 - %1011111x - Copy rectangle, absolute
760							;
761	.bebe						plotMoveOrCopyRectangle:
762	.bebe		29 02		and #$02	                and     #2
763	.bec0		8d 45 03	sta $0345	                sta     vduv.mocr.copy

765	.bec3		20 51 c9	jsr $c951	                jsr     mos.prepareForPlotBackground

767	.bec6		a2 14		ldx #$14	                ldx     #VDUVariables.oldGraphicsCursorPixels
768	.bec8		20 e6 c8	jsr $c8e6	                jsr     mos.prepareAABB

770							                ; mocr.dest.min = PLOT coordinate
771	.becb		a0 34		ldy #$34	                ldy     #VDUVariables.mocr.dest.min
772	.becd		20 16 c9	jsr $c916	                jsr     mos.copyLastFourVDUQueueBytes
773	.bed0		84 da		sty $da		                sty     ZTEMP+0              ;Y=VDUVariables.mocr.dest.max

775							                ; dest.max = dest.min + (src.max - src.min)
776	.bed2		a2 34		ldx #$34	                ldx     #VDUVariables.mocr.dest.min
777	.bed4		a0 2c		ldy #$2c	                ldy     #VDUVariables.mocr.src.max
778	.bed6		a9 28		lda #$28	                lda     #VDUVariables.mocr.src.min
779	.bed8		20 80 d5	jsr $d580	                jsr     mos.addRegionDimensionsToVDUVariableCoordinates

781							                ;
782	.bedb		a2 28		ldx #$28	                ldx     #VDUVariables.mocr.src.min
783	.bedd		a0 34		ldy #$34	                ldy     #VDUVariables.mocr.dest
784	.bedf		20 cc d5	jsr $d5cc	                jsr     mos.sortVDUVariableWords

786	.bee2		5a		phy		                phy
787	.bee3		da		phx		                phx
788	.bee4		a0 00		ldy #$00	                ldy     #0                   ;get outcode for X axis
789	.bee6		20 b7 d1	jsr $d1b7	                jsr     mos.getOutcodeForAxis
790	.bee9		f0 08		beq $bef3	                beq     LBEF3                ;taken if
791	.beeb		4a		lsr a		                lsr     a
792	.beec		f0 03		beq $bef1	                beq     LBEF1
793	.beee		68		pla		                pla

795	.beef						LBEEF:
796	.beef		68		pla		                pla
797	.bef0		60		rts		                rts


800	.bef1						LBEF1:
801	.bef1		a2 00		ldx #$00	                ldx     #0

803	.bef3						LBEF3:
804	.bef3		68		pla		                pla

806	.bef4		a0 30		ldy #$30	                ldy     #VDUVariables.workspace._30
807	.bef6		84 da		sty $da		                sty     ZTEMP+0
808	.bef8		a0 28		ldy #$28	                ldy     #VDUVariables.mocr.src.min
809	.befa		20 8d d5	jsr $d58d	                jsr     mos.addRegionDimensionToVDUVariableCoordinate

811	.befd		a0 3c		ldy #$3c	                ldy     #VDUVariables.workspace._3C
812	.beff		84 da		sty $da		                sty     ZTEMP+0

814	.bf01		a0 34		ldy #$34	                ldy     #VDUVariables.mocr.dest.min
815	.bf03		20 8d d5	jsr $d58d	                jsr     mos.addRegionDimensionToVDUVariableCoordinate

817	.bf06		68		pla		                pla
818	.bf07		18		clc		                clc
819	.bf08		69 04		adc #$04	                adc     #4
820	.bf0a		aa		tax		                tax
821	.bf0b		da		phx		                phx
822	.bf0c		a0 00		ldy #$00	                ldy     #0
823	.bf0e		20 b7 d1	jsr $d1b7	                jsr     mos.getOutcodeForAxis
824	.bf11		f0 05		beq $bf18	                beq     LBF18
825	.bf13		4a		lsr a		                lsr     a
826	.bf14		f0 d9		beq $beef	                beq     LBEEF
827	.bf16		a2 04		ldx #$04	                ldx     #4

829	.bf18						LBF18:
830	.bf18		68		pla		                pla
831	.bf19		a0 40		ldy #$40	                ldy     #VDUVariables.workspace._40
832	.bf1b		84 da		sty $da		                sty     ZTEMP+0
833	.bf1d		a0 38		ldy #$38	                ldy     #VDUVariables.workspace._38
834	.bf1f		20 8d d5	jsr $d58d	                jsr     mos.addRegionDimensionToVDUVariableCoordinate
835	.bf22		ad 40 03	lda $0340	                lda     vduv.workspace._40
836	.bf25		cd 3c 03	cmp $033c	                cmp     vduv.workspace._3C
837	.bf28		ad 41 03	lda $0341	                lda     vduv.workspace._41
838	.bf2b		ed 3d 03	sbc $033d	                sbc     vduv.workspace._3D
839	.bf2e		10 10		bpl $bf40	                bpl     LBF40
840	.bf30		ad 45 03	lda $0345	                lda     vduv.workspace._45
841	.bf33		d0 03		bne $bf38	                bne     LBF38
842	.bf35		20 20 c4	jsr $c420	                jsr     mos.LC420

844	.bf38						LBF38:
845	.bf38		a2 34		ldx #$34	                ldx     #VDUVariables.mocr.dest
846	.bf3a		20 02 c9	jsr $c902	                jsr     mos.copyEightBytesToWorkspace28
847	.bf3d		4c 20 c4	jmp $c420	                jmp     mos.LC420


850	.bf40						LBF40:
851	.bf40		9c 47 03	stz $0347	                stz     vduv.workspace._47
852	.bf43		ad 30 03	lda $0330	                lda     vduv.workspace._30
853	.bf46		2d 61 03	and $0361	                and     vduv.pixelsPerByteMinusOne
854	.bf49		85 da		sta $da		                sta     ZTEMP+0
855	.bf4b		ad 3c 03	lda $033c	                lda     vduv.workspace._3C
856	.bf4e		2d 61 03	and $0361	                and     vduv.pixelsPerByteMinusOne
857	.bf51		38		sec		                sec
858	.bf52		e5 da		sbc $da		                sbc     ZTEMP+0
859	.bf54		10 06		bpl $bf5c	                bpl     LBF5C
860	.bf56		ce 47 03	dec $0347	                dec     vduv.workspace._47
861	.bf59		2d 61 03	and $0361	                and     vduv.pixelsPerByteMinusOne

863	.bf5c						LBF5C:
864	.bf5c		8d 43 03	sta $0343	                sta     vduv.workspace._43
865	.bf5f		48		pha		                pha
866	.bf60		49 ff		eor #$ff	                eor     #$ff
867	.bf62		1a		inc a		                inc     a
868	.bf63		2d 61 03	and $0361	                and     vduv.pixelsPerByteMinusOne
869	.bf66		8d 42 03	sta $0342	                sta     vduv.workspace._42
870	.bf69		68		pla		                pla
871	.bf6a		18		clc		                clc
872	.bf6b		6d 61 03	adc $0361	                adc     vduv.pixelsPerByteMinusOne
873	.bf6e		aa		tax		                tax
874	.bf6f		bd 20 e1	lda $e120,x	                lda     mos.LE120,x
875	.bf72		85 e1		sta $e1		                sta     ZTEMPD+1
876	.bf74		a2 3c		ldx #$3c	                ldx     #VDUVariables.workspace._3C
877	.bf76		a0 40		ldy #$40	                ldy     #VDUVariables.workspace._40
878	.bf78		20 9c da	jsr $da9c	                jsr     mos.LDA9C
879	.bf7b		8d 44 03	sta $0344	                sta     vduv.workspace._44
880	.bf7e		a5 d1		lda $d1		                lda     ZMASK
881	.bf80		8d 46 03	sta $0346	                sta     vduv.workspace._46
882	.bf83		a5 dc		lda $dc		                lda     ZTEMPB+0
883	.bf85		85 e0		sta $e0		                sta     ZTEMPD+0
884	.bf87		a2 00		ldx #$00	                ldx     #0
885	.bf89		20 e6 bf	jsr $bfe6	                jsr     LBFE6
886	.bf8c		f0 40		beq $bfce	                beq     LBFCE
887	.bf8e		ad 2a 03	lda $032a	                lda     vduv.workspace._2A
888	.bf91		cd 36 03	cmp $0336	                cmp     vduv.workspace._36
889	.bf94		ad 2b 03	lda $032b	                lda     vduv.workspace._2B
890	.bf97		ed 37 03	sbc $0337	                sbc     vduv.workspace._37
891	.bf9a		50 02		bvc $bf9e	                bvc     LBF9E
892	.bf9c		49 80		eor #$80	                eor     #$80

894	.bf9e						LBF9E:
895	.bf9e		30 11		bmi $bfb1	                bmi     LBFB1

897	.bfa0						LBFA0:
898	.bfa0		20 62 db	jsr $db62	                jsr     mos.LDB62
899	.bfa3		a2 00		ldx #$00	                ldx     #0
900	.bfa5		20 d1 bf	jsr $bfd1	                jsr     LBFD1
901	.bfa8		a2 0c		ldx #$0c	                ldx     #$c
902	.bfaa		20 d1 bf	jsr $bfd1	                jsr     LBFD1
903	.bfad		d0 f1		bne $bfa0	                bne     LBFA0
904	.bfaf		80 1d		bra $bfce	                bra     LBFCE


907	.bfb1						LBFB1:
908	.bfb1		a2 2a		ldx #$2a	                ldx     #VDUVariables.mocr.src.min.y
909	.bfb3		a0 2e		ldy #$2e	                ldy     #VDUVariables.mocr.src.max.y
910	.bfb5		20 b2 e2	jsr $e2b2	                jsr     mos.exchangeTwoVDUBytes
911	.bfb8		a2 36		ldx #$36	                ldx     #VDUVariables.mocr.dest.min.y
912	.bfba		a0 3a		ldy #$3a	                ldy     #VDUVariables.mocr.dest.max.y
913	.bfbc		20 b2 e2	jsr $e2b2	                jsr     mos.exchangeTwoVDUBytes

915	.bfbf						LBFBF:
916	.bfbf		20 62 db	jsr $db62	                jsr     mos.LDB62
917	.bfc2		a2 00		ldx #$00	                ldx     #0
918	.bfc4		20 db bf	jsr $bfdb	                jsr     LBFDB
919	.bfc7		a2 0c		ldx #$0c	                ldx     #$c
920	.bfc9		20 db bf	jsr $bfdb	                jsr     LBFDB
921	.bfcc		d0 f1		bne $bfbf	                bne     LBFBF

923	.bfce						LBFCE:
924	.bfce		4c 62 db	jmp $db62	                jmp     mos.LDB62




929	.bfd1						LBFD1:
930	.bfd1		fe 2a 03	inc $032a,x	                inc     vduv.workspace._2A,x
931	.bfd4		d0 10		bne $bfe6	                bne     LBFE6
932	.bfd6		fe 2b 03	inc $032b,x	                inc     vduv.workspace._2B,x
933	.bfd9		80 0b		bra $bfe6	                bra     LBFE6






940	.bfdb						LBFDB:
941	.bfdb		bd 2a 03	lda $032a,x	                lda     vduv.workspace._2A,x
942	.bfde		d0 03		bne $bfe3	                bne     LBFE3
943	.bfe0		de 2b 03	dec $032b,x	                dec     vduv.workspace._2B,x

945	.bfe3						LBFE3:
946	.bfe3		de 2a 03	dec $032a,x	                dec     vduv.workspace._2A,x






953	.bfe6						LBFE6:
954	.bfe6		bd 2a 03	lda $032a,x	                lda     vduv.workspace._2A,x
955	.bfe9		dd 2e 03	cmp $032e,x	                cmp     vduv.workspace._2E,x
956	.bfec		d0 06		bne $bff4	                bne     rtsBFF4
957	.bfee		bd 2b 03	lda $032b,x	                lda     vduv.workspace._2B,x
958	.bff1		dd 2f 03	cmp $032f,x	                cmp     vduv.workspace._2F,x

960	.bff4						rtsBFF4:
961	.bff4		60		rts		                rts

963							                .if version!=400&&version!=350
964							; Hmm. What even is this???
965	>bff5		ff				                .byte $ff
966	>bff6		ff				                .byte $ff
967	>bff7		ff				                .byte $ff
968	>bff8		ff				                .byte $ff
969	>bff9		ff				                .byte $ff
970	>bffa		ff				                .byte $ff
971	>bffb		ff				                .byte $ff
972	>bffc		ff				                .byte $ff
973	>bffd		ff				                .byte $ff
974	>bffe		ff				                .byte $ff
975	>bfff		ff				                .byte $ff
976							                .endif

978							                .endblock

:1	;******  Return to file: mos320multios.s65

32							                .endsection

34							                .section utils
35							                .include "src/terminal.s65"

:6	;******  Processing file: src/terminal.s65

1							; -*- comment-column:45; -*-

3	.8000						terminal: .block
4							                .if version==320||version==350

6	.8000		4c 77 af	jmp $af77	                jmp terminalLanguageEntryPoint ; Language entry point
7	.8003		4c 72 9d	jmp $9d72	                jmp utilsServiceEntryPoint  ; Service entry point
8	>8006		c2				                .byte $C2                    ; ROM type=SERV+LANG+6502
9	>8007		11				                .byte copyrightText-1-terminal ; (C) offset
10	>8008		01				                .byte $01
11	>8009		54 45 52 4d 49 4e 41 4c		                .text "TERMINAL"
12	>8011		00				                .byte 0
13	.8012						copyrightText:
14							                .if version==350
16							                .else
17	>8012		28 43 29 31 39 38 34 20		                .text "(C)1984 Acorn"
	>801a		41 63 6f 72 6e
18							                .endif
19	>801f		00				                .byte 0

66							                .endif

68							;-------------------------------------------------------------------------

70							                .if version==350
75							                .endif

77							;-------------------------------------------------------------------------

79							                .if version==350
84							                .endif

86							;-------------------------------------------------------------------------

88							                .if version==350
93							                .endif

95							;-------------------------------------------------------------------------

97							                .if version==350
106							                .endif

108							;-------------------------------------------------------------------------

110							                .if version==350
123							                .endif

125							;-------------------------------------------------------------------------

127							                .if version==350
137							                .endif

139							;-------------------------------------------------------------------------

141							; STARTUP
142							; =======


145							                .if version==350             ;stripped_out_reset
151							                .else                        ;stripped_out_reset
152	.8020						reset:                          ;8020
153							                .include "reset.s65"

:7	;******  Processing file: src/reset.s65

1							                .if version==350
3							                .endif
4							                .if version!=350
5	.8020		a9 fe		lda #$fe	                lda #~ACCCON.D
6	.8022		1c 34 fe	trb $fe34	                trb ACCCON
7							                .endif
8							                .if version<500
9	.8025		9c dd df	stz $dfdd	                stz hazel.hasACCCONChanged
10							                .endif
11							                .if version!=350
12	.8028		1c 66 03	trb $0366	                trb $0366
13							                .endif
14	.802b		d8		cld		                cld
15	.802c		a2 ff		ldx #$ff	                ldx #$FF
16	.802e		9a		txs		                txs              ;reset stack
17	.802f		8e 63 fe	stx $fe63	                stx userVIA.ddra ;port A all outputs
18	.8032		a9 cf		lda #$cf	                lda #%11001111
19	.8034		8d 42 fe	sta $fe42	                sta systemVIA.ddrb
20							                .if version==350
23							                .endif
24							                .if version<500
25	.8037		a0 20		ldy #$20	                ldy #RTC.a.dv32768Hz
26	.8039		a2 0a		ldx #$0a	                ldx #RTC.a
27	.803b		20 e4 98	jsr $98e4	                jsr terminal.writeRTCByte
28	.803e		20 29 97	jsr $9729	                jsr terminal.finishRTCUpdate
29							                .endif
30							                .if version!=350
31	.8041		a9 0c		lda #$0c	                lda #ACCCON.Y|ACCCON.X       ; page in HAZEL+shadow
32	.8043		0c 34 fe	tsb $fe34	                tsb ACCCON
33							                .if version>=500
38							                .endif
42							                .endif
43							                .if version==350
45							                .else
46	.8046		ad 4e fe	lda $fe4e	                lda systemVIA.ier
47							                .endif
48	.8049		0a		asl a		                asl a
49	.804a		48		pha		                pha
50							                .if version==350
100							                .else
101							                .if version<400
102	.804b		f0 07		beq $8054	                beq startClearRAM       ; branch taken if power on
103	.804d		ad 58 02	lda $0258	                lda breakAndESCAPEEffect                    ; read BREAK action flags
104							                                             ; (set by *FX200)
105	.8050		4a		lsr a		                lsr a                        ; divide by 2 to get the
106							                                             ; break action
107	.8051		3a		dec a		                dec a                        ; Z=1 if it was 1
108	.8052		d0 1f		bne $8073	                bne nonPowerOnReset          ; branch taken if break
109							                                             ; action says don't clear
110							                                             ; RAM
120							                .endif
121	.8054						startClearRAM:
122	.8054		a8		tay		                tay             ;Y=0
123	.8055						clearRAM:
124	.8055		98		tya		                tya             ;A=0
125	.8056		64 01		stz $01		                stz $01
126	.8058		64 00		stz $00		                stz $00         ;start at $0000
127	.805a						clearRAMPageLoop:
128	.805a		91 00		sta ($00),y	                sta ($00),y     ;clear RAM
129	.805c		c8		iny		                iny
130	.805d		d0 fb		bne $805a	                bne clearRAMPageLoop
131	.805f		e6 01		inc $01		                inc $01
132	.8061		a2 40		ldx #$40	                ldx #$40          ;$40=RTI
133	.8063		8e 00 0d	stx $0d00	                stx nmiEntryPoint ;restore the RTI previously written,
134							                                  ;as each iteration will potentially
135							                                  ;overwrite it
136	.8066		a6 01		ldx $01		                ldx $01
137	.8068		e0 e0		cpx #$e0	                cpx #$E0        ;hit the end of RAM?
138	.806a		90 ee		bcc $805a	                bcc clearRAMPageLoop ;branch taken if still more to go
139	.806c		a9 04		lda #$04	                lda #ACCCON.X   ;page out shadow RAM
140	.806e		1c 34 fe	trb $fe34	                trb ACCCON
141	.8071		d0 e2		bne $8055	                bne clearRAM    ;branch taken if shadow RAM bit
142							                             ;previously set - i.e., that was the
143							                             ;first iteration, and we need to go back
144							                             ;to do main RAM
145							                .if version>=400
148							                .endif
149							                .endif
150	.8073						nonPowerOnReset:
151							                .if version>=350
156							                .endif
157	.8073		a9 11		lda #$11	                lda #<mos.emptyCommandLine
158	.8075		8d 04 df	sta $df04	                sta hazel.commandLinePointer+0
159	.8078		a9 e8		lda #$e8	                lda #>mos.emptyCommandLine
160	.807a		8d 05 df	sta $df05	                sta hazel.commandLinePointer+1
161	.807d		a9 0c		lda #$0c	                lda #ACCCON.Y|ACCCON.X ; page in MOS ROM, page in main
162							                                       ; RAM
163							                .if version==350
165							                .else
166	.807f		1c 34 fe	trb $fe34	                trb ACCCON
167							                .endif
168	.8082		a9 0f		lda #$0f	                lda #$0F
169	.8084		8d 8e 02	sta $028e	                sta numericKeypadShiftEffect
170							                .if version<500&&version!=350
171	.8087						-
172	.8087		3a		dec a		                dec a
173	.8088		8d 40 fe	sta $fe40	                sta systemVIA.orb
174	.808b		c9 09		cmp #$09	                cmp #$09
175	.808d		b0 f8		bcs $8087	                bcs -
176							                .endif
177	.808f		a2 01		ldx #$01	                ldx #key_ctrl
178							                .if version==350
180							                .else
181	.8091		20 80 f8	jsr $f880	                jsr mos.interrogateKeyboard
182							                .endif
183	.8094		e0 80		cpx #$80	                cpx #$80        ;Z=0 C=1 if CTRL+BREAK
184	.8096		20 35 f7	jsr $f735	                jsr mos.updateKeyboardLEDs
185	.8099		9c 8d 02	stz $028d	                stz lastBREAKType            ;softBREAK
186	.809c		6a		ror a		                ror a
187	.809d		a2 9c		ldx #$9c	                ldx #$9c                     ;what is this?
188	.809f		a0 8d		ldy #$8d	                ldy #$8D                     ;what is this?
189	.80a1		68		pla		                pla
190	.80a2		f0 09		beq $80ad	                beq L80AD
191	.80a4		a0 7e		ldy #$7e	                ldy #$7E                     ;what is this?
192	.80a6		90 37		bcc $80df	                bcc L80DF
193	.80a8		a0 87		ldy #$87	                ldy #$87                     ;what is this?
194	.80aa		ee 8d 02	inc $028d	                inc lastBREAKType
195	.80ad						L80AD:
196	.80ad		ee 8d 02	inc $028d	                inc lastBREAKType
197	.80b0		5a		phy		                phy
198							                .if version==350&&CFA3000
204							                .endif
205							                .if version==350
208							                .elsif version<500
209	.80b1		20 76 8e	jsr $8e76	                jsr readDefaultMODE          ; Read configured MODE
214							                .endif
215	.80b4		09 08		ora #$08	                ora #CMOSBytes.defaults0.defaultSHADOWMask
216	.80b6		8d 8f 02	sta $028f	                sta startupOptions
217	.80b9		20 ae 98	jsr $98ae	                jsr terminal.readDefaults3 ; Read configured BOOT
218	.80bc		29 10		and #$10	                and #CMOSBytes.defaults3.autoBootMask
219	.80be		4a		lsr a		                lsr a         ; Reset OSBYTE 255 boot bit (b3) if BOOT
220	.80bf		1c 8f 02	trb $028f	                trb startupOptions
221							                .if version==350
223							                .else
224	.80c2		20 5a 8e	jsr $8e5a	                jsr terminal.readDefaultTVSettings
225							                .endif
226	.80c5		8c 90 02	sty $0290	                sty tvOffset
227	.80c8		8e 91 02	stx $0291	                stx tvInterlace
228	.80cb		20 ae 98	jsr $98ae	                jsr terminal.readDefaults3
229	.80ce		29 08		and #$08	                and #CMOSBytes.defaults3.protectedScrollingMask
230	.80d0		f0 02		beq $80d4	                beq L80D4
231	.80d2		a9 01		lda #$01	                lda #VDUVariables.cursorFlags.scrollProtect
232	.80d4						L80D4:
233	.80d4		8d 66 03	sta $0366	                sta vduv.cursorFlags
234	.80d7		20 7b 92	jsr $927b	                jsr terminal.restoreFont32To255
235	.80da		7a		ply		                ply
236	.80db		a2 92		ldx #$92	                ldx #$92
237	.80dd		80 18		bra $80f7	                bra initializePage2Loop
238	.80df						L80DF:
239							                .if version>=500
241							                .endif
242	.80df		a9 87		lda #$87	                lda #$87             ; Clear MODE bits from OSBYTE 255
243	.80e1		1c 8f 02	trb $028f	                trb startupOptions
244	.80e4		ad 55 03	lda $0355	                lda vduv.currentScreenMODE ; Get current screen MODE b0-b2
245	.80e7		29 07		and #$07	                and #$07
246	.80e9		0c 8f 02	tsb $028f	                tsb startupOptions           ; Copy to OSBYTE 255
247	.80ec		a9 10		lda #$10	                lda #STATE.isShadowMode ; Test shadow screen bit in VDU flags
248	.80ee		24 d0		bit $d0		                bit STATE                      ; Not shadow screen
249	.80f0		f0 05		beq $80f7	                beq initializePage2Loop
250	.80f2		a9 80		lda #$80	                lda #$80                     ; Set shadow screen bit in OSBYTE 255
251	.80f4		0c 8f 02	tsb $028f	                tsb startupOptions

253	.80f7						initializePage2Loop:
254	.80f7		ad 8d 02	lda $028d	                lda lastBREAKType
255	.80fa		d0 08		bne $8104	                bne clearPage2Byte           ;taken unless soft BREAK

257							                ; leave the ROM information table alone on a soft
258							                ; BREAK.
259	.80fc		e0 b1		cpx #$b1	                cpx #<romInformationTable+16
260	.80fe		b0 04		bcs $8104	                bcs clearPage2Byte
261	.8100		e0 a1		cpx #$a1	                cpx #<romInformationTable
262	.8102		b0 0a		bcs $810e	                bcs nextPage2Byte
263	.8104						clearPage2Byte:
264	.8104		9e 00 02	stz $0200,x	                stz $0200,x
265	.8107		e0 cd		cpx #$cd	                cpx #$CD
266	.8109		90 03		bcc $810e	                bcc nextPage2Byte
267	.810b		de 00 02	dec $0200,x	                dec $0200,x                  ;initialize later values to $ff
268	.810e						nextPage2Byte:
269	.810e		e8		inx		                inx
270	.810f		d0 e6		bne $80f7	                bne initializePage2Loop

272							                .if version==350
274							                .endif
275	.8111		a2 cf		ldx #$cf	                ldx #$CF
276	.8113						initializeZeroPageLoop:
277	.8113		74 00		stz $00,x	                stz $00,x
278	.8115		e8		inx		                inx
279	.8116		d0 fb		bne $8113	                bne initializeZeroPageLoop
280							                .if version==350
283							                .endif

285	.8118		ad 8d 02	lda $028d	                lda lastBREAKType
286	.811b		d0 20		bne $813d	                bne L813D                    ;taken if not soft BREAK

288							                .if version!=400
289	.811d		ad 46 02	lda $0246	                lda noignoreState
290	.8120		48		pha		                pha
291							                .endif
292	.8121		ad 4b 02	lda $024b	                lda basicROMNumber
293	.8124		48		pha		                pha
294	.8125		ad 44 02	lda $0244	                lda oshwm
295	.8128		48		pha		                pha
296	.8129		ad 57 02	lda $0257	                lda spoolFileHandle
297	.812c		48		pha		                pha
298	.812d		ae 56 02	ldx $0256	                ldx execFileHandle

300	.8130						L8130:
301	.8130		b9 d6 e2	lda $e2d6,y	                lda mos.defaultVectorTable-1,y
302	.8133		99 ff 01	sta $01ff,y	                sta vectors-1,y
303	.8136		88		dey		                dey
304	.8137		c0 21		cpy #$21	                cpy #EVENTV+1-vectors
305	.8139		b0 f5		bcs $8130	                bcs L8130

307	.813b		a0 12		ldy #$12	                ldy #FILEV-vectors

309	.813d						L813D:
310	.813d		b9 d6 e2	lda $e2d6,y	                lda mos.defaultVectorTable-1,y
311	.8140		99 ff 01	sta $01ff,y	                sta vectors-1,y
312	.8143		88		dey		                dey
313	.8144		d0 f7		bne $813d	                bne L813D

315	.8146		ad 8d 02	lda $028d	                lda lastBREAKType
316	.8149		d0 19		bne $8164	                bne L8164
317	.814b		8e 56 02	stx $0256	                stx execFileHandle
318	.814e		68		pla		                pla                          ;restore *SPOOL file handle
319	.814f		c9 04		cmp #$04	                cmp #$04                     ;is it a TAPE or ROM handle?
320	.8151		b0 02		bcs $8155	                bcs L8155                    ;taken if no - keep it

322							                .if version==350
324							                .else
325	.8153		a9 00		lda #$00	                lda #$00          ;auto-close it if TAPE or ROM handle
326							                .endif
327	.8155						L8155:
328	.8155		8d 57 02	sta $0257	                sta spoolFileHandle
329	.8158		68		pla		                pla
330	.8159		8d 44 02	sta $0244	                sta oshwm
331	.815c		68		pla		                pla
332	.815d		8d 4b 02	sta $024b	                sta basicROMNumber
333							                .if version!=400
334	.8160		68		pla		                pla
335	.8161		8d 46 02	sta $0246	                sta noignoreState
336							                .endif

338	.8164						L8164:
339							                .if version==350
342							                .elsif version<500
343	.8164		20 ad 8e	jsr $8ead	                jsr readDefaults1
347							                .endif
348	.8167		a2 20		ldx #$20	                ldx #keyboardStatusByte.shiftLockDisengaged
349	.8169		0a		asl a		                asl a
350	.816a		0a		asl a		                asl a                        ;N=defaultCapsLockMask
351	.816b		30 07		bmi $8174	                bmi gotKeyboardStatusByte                    ;taken if defaultCapsLock
352	.816d		a2 30		ldx #$30	                ldx #keyboardStatusByte.shiftLockDisengaged|keyboardStatusByte.capsLockDisengaged
353	.816f		0a		asl a		                asl a                        ;N=defaultNoLockMask
354	.8170		30 02		bmi $8174	                bmi gotKeyboardStatusByte
355	.8172		a2 a0		ldx #$a0	                ldx #keyboardStatusByte.shiftEnabled|keyboardStatusByte.shiftLockDisengaged
356	.8174						gotKeyboardStatusByte:
357	.8174		8e 5a 02	stx $025a	                stx keyboardStatusByte
358							                .if version==350
360							                .else
361	.8177		20 90 e5	jsr $e590	                jsr mos.selectTerminalROM
362	.817a		20 07 f1	jsr $f107	                jsr mos.resetKeyRepeat
363							                .endif
364	.817d		ad 8d 02	lda $028d	                lda lastBREAKType
365	.8180		f0 14		beq $8196	                beq L8196
366							                .if version==350
369							                .elsif version<500
370	.8182		20 a8 8e	jsr $8ea8	                jsr readDefaultPrinterIgnoreChar
374							                .endif
375	.8185		8d 86 02	sta $0286	                sta printerIgnoreChar
376							                .if version==350
378							                .elsif version<500
379	.8188		20 aa 98	jsr $98aa	                jsr readDefaults2
380	.818b		4a		lsr a		                lsr a                        ;C=tubeOn
381	.818c		4a		lsr a		                lsr a                        ;C=usePrinterIgnoreChar
384							                .endif
385	.818d		6e 46 02	ror $0246	                ror noignoreState
386							                .if version==350
389							                .elsif version<500
390	.8190		20 8d 8e	jsr $8e8d	                jsr readDefaultFX5Settings
394							                .endif
395	.8193		8d 85 02	sta $0285	                sta printerDriverType
396	.8196						L8196:
397							                .if version==400
399							                .else
400							                .if version==350
403							                .elsif version<500
404	.8196		20 97 8e	jsr $8e97	                jsr readDefaultSerialDataFormat
408							                .endif
409	.8199		0a		asl a		                asl a                        ;
410	.819a		0a		asl a		                asl a       ;shift into the control registerword field
411	.819b		09 42		ora #$42	                ora #ACIA.control.rtsHighTXInterruptDisabled|ACIA.control.counterDivide64
412	.819d		8d 50 02	sta $0250	                sta aciaControlRegister

414							                .if version<500
415	.81a0		20 d6 a9	jsr $a9d6	                jsr terminal.resetACIAThenRewriteControlRegister
416	.81a3		a2 01		ldx #$01	                ldx #$01
446							                .endif
447							                .endif

449	.81a5		a9 7f		lda #$7f	                lda #$7F
450	.81a7						initializeVIAInterruptsLoop:
451	.81a7		9d 4d fe	sta $fe4d,x	                sta systemVIA.ifr,x
452	.81aa		9d 6d fe	sta $fe6d,x	                sta userVIA.ifr,x
453	.81ad		ca		dex		                dex
454	.81ae		10 f7		bpl $81a7	                bpl initializeVIAInterruptsLoop

456							                .if version!=350
457							                ; Let through 1 IRQ.
458	.81b0		58		cli		                cli
459	.81b1		78		sei		                sei

461							                ; $FC was cleared above, so if bit 6 is set, there
462							                ; must have been an IRQ (as A=$7f).
463	.81b2		24 fc		bit $fc		                bit $FC
464	.81b4		50 03		bvc $81b9	                bvc +
465	.81b6		20 cf f8	jsr $f8cf	                jsr mos.call1MHzBusHook
466	.81b9						+
467							                .endif

469							                .if version!=400
470	.81b9		a2 d2		ldx #$d2	                ldx #$80|VIA.irq.t1|VIA.irq.cb1|VIA.irq.ca1
473							                .endif
474	.81bb		8e 4e fe	stx $fe4e	                stx systemVIA.ier

476							                .if version>=500
479							                .endif

481	.81be		a2 04		ldx #$04	                ldx #VIA.pcr.cb2InputNegativeActiveEdge|VIA.pcr.cb1NegativeActiveEdge|VIA.pcr.ca2InputPositiveEdge|VIA.pcr.ca1NegativeActiveEdge
482	.81c0		8e 4c fe	stx $fe4c	                stx systemVIA.pcr
483	.81c3		a9 40		lda #$40	                lda #VIA.acr.t1Continuous|VIA.acr.t2Timer|VIA.acr.srDisabled|VIA.acr.pbLatchDisabled|VIA.acr.paLatchDisabled
484	.81c5		8d 4b fe	sta $fe4b	                sta systemVIA.acr
485	.81c8		a9 0e		lda #$0e	                lda #$0E
486	.81ca		8d 46 fe	sta $fe46	                sta systemVIA.t1lL
487	.81cd		8d 6c fe	sta $fe6c	                sta userVIA.pcr              ;VIA.pcr.cb2InputNegativeActiveEdge|VIA.pcr.cb1NegativeActiveEdge|VIA.pcr.ca2HighOutput|VIA.pcr.ca1NegativeActiveEdge
488							                .if version==350
490							                .elsif version<400
491	.81d0		8d 18 fe	sta $fe18	                sta HADC.latch               ;looks benign
492							                .endif
493	.81d3		a9 27		lda #$27	                lda #$27
494	.81d5		8d 47 fe	sta $fe47	                sta systemVIA.t1lH
495	.81d8		8d 45 fe	sta $fe45	                sta systemVIA.t1cH

497							                .if version==350||version>=400
499							                .else
500	.81db		a2 08		ldx #$08	                ldx #$08
501	.81dd						L81DD:
502	.81dd		ca		dex		                dex
503	.81de		20 5d f5	jsr $f55d	                jsr mos.clearSoundChannelBuffer
504	.81e1		e0 04		cpx #$04	                cpx #$04
505	.81e3		d0 f8		bne $81dd	                bne L81DD
506							                .endif

508							                .if version==350
510							                .else
511	.81e5		20 10 f9	jsr $f910	                jsr mos.osbyte7A
512							                .endif
513	.81e8		86 ed		stx $ed		                stx firstKeyPressedInternal
514	.81ea		a2 00		ldx #$00	                ldx #$00
515							                .if version>=500
517							                .endif
518	.81ec		20 7d e9	jsr $e97d	                jsr mos.purgeBuffer

520							                .if version!=400
521	.81ef		ad 82 02	lda $0282	                lda serialULARegister
522	.81f2		29 7f		and #$7f	                and #$7F
523	.81f4		20 89 ec	jsr $ec89	                jsr mos.LEC89
524							                .if version<500&&version!=350
525	.81f7		20 84 8e	jsr $8e84	                jsr readDefaultSerialBaudRateIndex
533							                .endif
534	.81fa		48		pha		                pha
535	.81fb		aa		tax		                tax
536	.81fc		20 6b ec	jsr $ec6b	                jsr mos.osbyte08
537	.81ff		fa		plx		                plx
538	.8200		a9 07		lda #$07	                lda #$07
539	.8202		20 6d ec	jsr $ec6d	                jsr mos.osbyte07
540							                .endif

542	.8205		20 ae 98	jsr $98ae	                jsr terminal.readDefaults3
543	.8208		89 02		bit #$02	                bit #CMOSBytes.defaults3.loudMask
544	.820a		d0 05		bne $8211	                bne L8211
545	.820c		a9 f0		lda #$f0	                lda #$F0
546	.820e		8d 64 02	sta $0264	                sta bellSound
547	.8211						L8211:
548							                .if version!=350
549	.8211		20 90 e5	jsr $e590	                jsr mos.selectTerminalROM
550							                .endif

552	.8214		ae 84 02	ldx $0284	                ldx softKeyConsistencyFlag
553	.8217		f0 03		beq $821c	                beq checkResetType
554	.8219		20 1a f1	jsr $f11a	                jsr mos.osbyte12
555	.821c						checkResetType:
556	.821c		ad 8d 02	lda $028d	                lda lastBREAKType
557	.821f		f0 03		beq $8224	                beq romsScanned                    ;taken if soft BREAK

559							                .if version==350
562							                .else
563	.8221		4c a0 e3	jmp $e3a0	                jmp mos.scanROMs
564							                .endif

566	.8224						romsScanned:
567	.8224		ad 8f 02	lda $028f	                lda startupOptions
568	.8227		20 99 c7	jsr $c799	                jsr mos.setStartupMODE
569	.822a		ad 8d 02	lda $028d	                lda lastBREAKType
570	.822d		3a		dec a		                dec a
571							                .if version>=510
574							                .else
575	.822e		d0 54		bne $8284	                bne softReset                    ;taken if not power-on reset
576							                .endif

578	.8230						powerOnReset:
579							                .if version>=500
595							                .endif
596	.8230						checkForNVRAMReset:

598							                .if version>=510
617							                .endif

619							                .if version<510
620	.8230		a5 ed		lda $ed		                lda firstKeyPressedInternal
621							                .endif
622	.8232						checkForResetKey:
623	.8232		c9 33		cmp #$33	                cmp #key_r
624	.8234		d0 4e		bne $8284	                bne softReset                    ;taken if R not pressed

626							                .if version<500
627							                .if CFA3000
629							                .else
630							                ; Reset CMOS RAM
631	.8236						resetCMOSRAM:
632	.8236		a2 31		ldx #$31	                ldx #size(RTC.ram)-1
633	.8238						resetCMOSRAMLoop:
634	.8238		da		phx		                phx
635	.8239		a0 00		ldy #$00	                ldy #$00
636							                .if version==350
641							                .endif
642	.823b		20 dc 98	jsr $98dc	                jsr terminal.writeCMOSByte
643	.823e		fa		plx		                plx
644	.823f		ca		dex		                dex
645							                .if version==350
647							                .else
648	.8240		10 f6		bpl $8238	                bpl resetCMOSRAMLoop
649							                .endif

651							                .if version!=350
652							                ; Initialize ROM insertion flags.
653	.8242		a0 ff		ldy #$ff	                ldy #$FF
654	.8244		a2 06		ldx #$06	                ldx #CMOSBytes.insertedROMs+0
655	.8246		20 dc 98	jsr $98dc	                jsr writeCMOSByte
656	.8249		a2 07		ldx #$07	                ldx #CMOSBytes.insertedROMs+1
657	.824b		20 dc 98	jsr $98dc	                jsr writeCMOSByte
658							                .endif

660							                .endif
672							                .endif

674							                .if version==350
676							                .else

678							                .if version>=500
691							                .endif

693	.824e		20 58 a9	jsr $a958	                jsr alwaysPrintFollowingMessage
694							                .if version>=500
696							                .endif
697	>8251		0d 0a				                .text 13,10
698							                .if version<500
699	>8253		43 4d 4f 53 20 52 41 4d		                .text "CMOS RAM reset"
	>825b		20 72 65 73 65 74
702							                .endif
703	>8261		0d 0a 50 72 65 73 73 20		                .text 13,10,"Press break to continue"
	>8269		62 72 65 61 6b 20 74 6f 20 63 6f 6e 74 69 6e 75
	>8279		65
704	>827a		0d 0a 00			                .text 13,10,0
705							                .endif

707	.827d		a9 03		lda #$03	                lda #$03
708	.827f		8d 58 02	sta $0258	                sta breakAndESCAPEEffect
709	.8282						hang:
710	.8282		80 fe		bra $8282	                bra hang

712							;-------------------------------------------------------------------------

714							                .if version==350
741							.endif

743							;-------------------------------------------------------------------------

745	.8284						softReset:
746							                .if version==350
749							                .else
750	.8284		20 ba ed	jsr $edba	                jsr mos.selectHAZEL
751							                .endif
752	.8287		9c d4 df	stz $dfd4	                stz hazel.moveSrcHandle
753	.828a		9c d5 df	stz $dfd5	                stz hazel.moveDestHandle
754	.828d		a0 ca		ldy #$ca	                ldy #$CA
755	.828f		20 7e ea	jsr $ea7e	                jsr mos.insertCharacterIntoKeyboardBuffer
756	.8292		20 49 f3	jsr $f349	                jsr mos.osbyte247EntryPoint
757	.8295		ad 8d 02	lda $028d	                lda lastBREAKType
758	.8298		f0 03		beq $829d	                beq L829D
759							                .if version==400
761							                .else
762	.829a		20 d0 ed	jsr $edd0	                jsr mos.LEDD0
763							                .endif
764	.829d						L829D:
765							                .if version<500
766							                .if version==350
768							                .else
769	.829d		20 aa 98	jsr $98aa	                jsr readDefaults2
770							                .endif
771	.82a0		4a		lsr a		                lsr a
772	.82a1		90 2d		bcc $82d0	                bcc continueSoftReset
773	.82a3		20 ae 98	jsr $98ae	                jsr terminal.readDefaults3

775							                .if version==350
783							                .else
784	.82a6		89 04		bit #$04	                bit #CMOSBytes.defaults3.extTubeMask
785	.82a8		08		php		                php
786	.82a9		a9 10		lda #$10	                lda #ACCCON.ITU
787	.82ab		1c 34 fe	trb $fe34	                trb ACCCON
788	.82ae		28		plp		                plp
789	.82af		d0 03		bne $82b4	                bne L82B4
790	.82b1		0c 34 fe	tsb $fe34	                tsb ACCCON
791							                .endif
792	.82b4						L82B4:
793							                .if version==350
795							                .else
796	.82b4		20 75 e3	jsr $e375	                jsr mos.LE375
797							                .endif

799	.82b7		b0 0d		bcs $82c6	                bcs foundTube

801							                .if version==350
803							                .else
804	.82b9		ad 34 fe	lda $fe34	                lda ACCCON                    ; Toggle Internal/External Tube
805							                .endif
806	.82bc		49 10		eor #$10	                eor #ACCCON.ITU
807							                .if version==350
809							                .else
810	.82be		8d 34 fe	sta $fe34	                sta ACCCON
811							                .endif

813							                .if version==350
815							                .else
816	.82c1		20 75 e3	jsr $e375	                jsr mos.LE375
817							                .endif

819							                .endif

:6	;******  Return to file: src/terminal.s65

154							                .endif

156							                .if version<500
157	.82c4		90 0a		bcc $82d0	                bcc continueSoftReset        ;taken if Tube not found
158	.82c6						foundTube:
159	.82c6		a2 ff		ldx #$ff	                ldx #romServiceCallTubeMainInitialisation
160	.82c8		20 72 ee	jsr $ee72	                jsr mos.makeROMServiceCall   ;
161	.82cb		d0 03		bne $82d0	                bne continueSoftReset        ; Not claimed, step past
162	.82cd		ce 7a 02	dec $027a	                dec tubePresence ; Tube PreInit claimed, set TubeFlag to &FF, Tube present
163							                .endif
164	.82d0						continueSoftReset:
165	.82d0		ad 8d 02	lda $028d	                lda lastBREAKType ; Soft Break, don't ask about workspace
166	.82d3		f0 27		beq $82fc	                beq L82FC
167	.82d5		a0 dc		ldy #$dc	                ldy #$DC                     ; Start high workspace at &DC00 and work downwards
168	.82d7		a2 24		ldx #$24	                ldx #romServiceCallCountDynamicHAZELWorkspace ; Ask ROMs how much private high workspace required
169	.82d9		20 72 ee	jsr $ee72	                jsr mos.makeROMServiceCall   ;
170	.82dc		a2 21		ldx #$21	                ldx #romServiceCallAbsoluteHAZELWorkspaceClaim ; Ask ROMs for maximum shared high workspace required
171	.82de		20 72 ee	jsr $ee72	                jsr mos.makeROMServiceCall   ;
172	.82e1		5a		phy		                phy                          ; Save top of shared workspace
173	.82e2		a2 22		ldx #$22	                ldx #romServiceCallPrivateHAZELWorkspaceClam ; Ask ROMs for private high workspace required
174	.82e4		20 72 ee	jsr $ee72	                jsr mos.makeROMServiceCall   ;
175	.82e7		a0 0e		ldy #$0e	                ldy #$0E                     ; Start low workspace at &0E00
176	.82e9		a2 01		ldx #$01	                ldx #romServiceCallAbsoluteWorkspaceClaim ; Ask ROMs for maximum shared workspace
177	.82eb		20 72 ee	jsr $ee72	                jsr mos.makeROMServiceCall   ;
178	.82ee		a2 02		ldx #$02	                ldx #romServiceCallPrivateWorkspaceClaim ; Ask ROMs for private workspace
179	.82f0		20 72 ee	jsr $ee72	                jsr mos.makeROMServiceCall   ;
180	.82f3		8c 44 02	sty $0244	                sty oshwm                    ; Set OSHWM - default PAGE
181	.82f6		7a		ply		                ply                          ; Get top of shared high workspace
182	.82f7		a2 23		ldx #$23	                ldx #romServiceCallTopOfHAZELWorkspace ; Tell ROMs top of shared high workspace
183	.82f9		20 72 ee	jsr $ee72	                jsr mos.makeROMServiceCall   ;
184	.82fc						L82FC:
185	.82fc		a2 21		ldx #$21	                ldx #size(defaultFsInfoBlocks)
186	.82fe						L82FE:
187	.82fe		bd 46 83	lda $8346,x	                lda defaultFsInfoBlocks-1,x                ; Copy initial FS info blocks for CFS, TAPE, ROM
188	.8301		9d 05 df	sta $df05,x	                sta hazel.fsInfoBlocks-1,x
189	.8304		ca		dex		                dex
190	.8305		d0 f7		bne $82fe	                bne L82FE
191	.8307		64 f2		stz $f2		                stz $F2                      ; &F2/3=>FS Info Blocks
192	.8309		a9 df		lda #$df	                lda #>hazel.fsInfoBlocks
193	.830b		85 f3		sta $f3		                sta $F3
194							                ; Y=>end of FS Info Blocks
195	.830d		a0 27		ldy #$27	                ldy #<hazel.fsInfoBlocks+size(defaultFsInfoBlocks)
196	.830f		a2 25		ldx #$25	                ldx #$25                     ; Ask ROMs for FS Info Blocks
197	.8311		20 72 ee	jsr $ee72	                jsr mos.makeROMServiceCall   ;
198	.8314		a9 00		lda #$00	                lda #$00                     ; Terminate FS Info blocks
199	.8316		91 f2		sta ($f2),y	                sta ($F2),y

201	.8318		ad 57 02	lda $0257	                lda spoolFileHandle ; Save Spool handle and disable Spooling
202	.831b		48		pha		                pha
203	.831c		9c 57 02	stz $0257	                stz spoolFileHandle
204	.831f		a2 fe		ldx #$fe	                ldx #romServiceCallTubeSystemPostInitialisation
205	.8321		ac 7a 02	ldy $027a	                ldy tubePresence
206	.8324		20 72 ee	jsr $ee72	                jsr mos.makeROMServiceCall   ; Tube PostInit
207	.8327		2d 67 02	and $0267	                and startupMessageSuppressionStatus
208	.832a		10 14		bpl $8340	                bpl L8340

210							                ; use +$ff rather than -1 to avoid 64tass warning.
211							                ; Only the LSB is used.
212	.832c		a0 ff		ldy #$ff	                ldy #((mos.startupMessages.acornMOS-(mos.startupMessages&$ff00))+$ff)&$ff
213	.832e		20 a1 e7	jsr $e7a1	                jsr mos.printStartupMessage
214	.8331		ad 8d 02	lda $028d	                lda lastBREAKType            ; Skip past if Soft Break
215	.8334		f0 05		beq $833b	                beq L833B
216	.8336		a0 0a		ldy #$0a	                ldy #((mos.startupMessages.beep-(mos.startupMessages&$ff00))-1)&$ff
217	.8338		20 a1 e7	jsr $e7a1	                jsr mos.printStartupMessage
218	.833b						L833B:
219	.833b		a0 0f		ldy #$0f	                ldy #((mos.startupMessages.twoNewlines-(mos.startupMessages&$ff00))-1)&$ff
220	.833d		20 a1 e7	jsr $e7a1	                jsr mos.printStartupMessage
221	.8340						L8340:
222	.8340		68		pla		                pla                          ; Restore Spool handle
223	.8341		8d 57 02	sta $0257	                sta spoolFileHandle
224	.8344		4c 0e e4	jmp $e40e	                jmp mos.LE40E                ;

226							;-------------------------------------------------------------------------

228							                .if version>=500
236							                .endif
237							                .if version>=400
246							                .endif

248							;-------------------------------------------------------------------------

250							; Default FS Info Blocks
251							; ======================
252	.8347						defaultFsInfoBlocks: .block
253							                .if version<500
254	>8347		43 46 53 20 20 20 20 20		                .text "CFS     "
255	>834f		01				                .byte $01
256	>8350		02				                .byte $02
257	>8351		01				                .byte $01
258	>8352		54 41 50 45 20 20 20 20		                .text "TAPE    "
259	>835a		01				                .byte $01
260	>835b		02				                .byte $02
261	>835c		01				                .byte $01
262							                .endif
263	>835d		52 4f 4d 20 20 20 20 20		                .text "ROM     "
264	>8365		03				                .byte $03
265	>8366		03				                .byte $03
266	>8367		03				                .byte $03
267							                .endblock

269							;-------------------------------------------------------------------------
270							;
271							; MOS command table

273							mos_command .macro name,routine,byte1,byte2
290							                .endm

292	.8368						mosCommandTable:
274							                ; Name of command, compared case-insensitively.
275	>8368		43 41 54			                .text "CAT"

277							                ; Address of command routine, big-endian so that the
278							                ; first byte always has bit 7 set.
12:4	>836b		f1				                .byte >mos.callFSCV
13	>836c		e5				                .byte <mos.callFSCV

281:6							                ; If bit 7 set, reset the tempFS flag before
282							                ; starting.
283	>836d		80				                .byte $80

285							                ; If bit 7 set, update string input buffer address
286							                ; before starting.
287							                ;
288							                ; A is set to this value on entry to the routine.
289	>836e		05				                .byte $05
294							                .if version!=400
274							                ; Name of command, compared case-insensitively.
275	>836f		41 44 46 53			                .text "ADFS"

277							                ; Address of command routine, big-endian so that the
278							                ; first byte always has bit 7 set.
12:4	>8373		85				                .byte >passStarCommandThrough
13	>8374		af				                .byte <passStarCommandThrough

281:6							                ; If bit 7 set, reset the tempFS flag before
282							                ; starting.
283	>8375		00				                .byte $00

285							                ; If bit 7 set, update string input buffer address
286							                ; before starting.
287							                ;
288							                ; A is set to this value on entry to the routine.
289	>8376		00				                .byte $00
296							                .endif
274							                ; Name of command, compared case-insensitively.
275	>8377		41 50 50 45 4e 44		                .text "APPEND"

277							                ; Address of command routine, big-endian so that the
278							                ; first byte always has bit 7 set.
12:4	>837d		90				                .byte >starAPPEND
13	>837e		14				                .byte <starAPPEND

281:6							                ; If bit 7 set, reset the tempFS flag before
282							                ; starting.
283	>837f		80				                .byte $80

285							                ; If bit 7 set, update string input buffer address
286							                ; before starting.
287							                ;
288							                ; A is set to this value on entry to the routine.
289	>8380		00				                .byte $00
274							                ; Name of command, compared case-insensitively.
275	>8381		42 41 53 49 43			                .text "BASIC"

277							                ; Address of command routine, big-endian so that the
278							                ; first byte always has bit 7 set.
12:4	>8386		85				                .byte >starBASIC
13	>8387		a6				                .byte <starBASIC

281:6							                ; If bit 7 set, reset the tempFS flag before
282							                ; starting.
283	>8388		00				                .byte $00

285							                ; If bit 7 set, update string input buffer address
286							                ; before starting.
287							                ;
288							                ; A is set to this value on entry to the routine.
289	>8389		00				                .byte $00
274							                ; Name of command, compared case-insensitively.
275	>838a		42 55 49 4c 44			                .text "BUILD"

277							                ; Address of command routine, big-endian so that the
278							                ; first byte always has bit 7 set.
12:4	>838f		90				                .byte >starBUILD
13	>8390		0f				                .byte <starBUILD

281:6							                ; If bit 7 set, reset the tempFS flag before
282							                ; starting.
283	>8391		80				                .byte $80

285							                ; If bit 7 set, update string input buffer address
286							                ; before starting.
287							                ;
288							                ; A is set to this value on entry to the routine.
289	>8392		00				                .byte $00
274							                ; Name of command, compared case-insensitively.
275	>8393		43 4c 4f 53 45			                .text "CLOSE"

277							                ; Address of command routine, big-endian so that the
278							                ; first byte always has bit 7 set.
12:4	>8398		93				                .byte >starCLOSE
13	>8399		7c				                .byte <starCLOSE

281:6							                ; If bit 7 set, reset the tempFS flag before
282							                ; starting.
283	>839a		00				                .byte $00

285							                ; If bit 7 set, update string input buffer address
286							                ; before starting.
287							                ;
288							                ; A is set to this value on entry to the routine.
289	>839b		ff				                .byte $FF
301							                .if version<500&&version!=350
274							                ; Name of command, compared case-insensitively.
275	>839c		43 4f 4e 46 49 47 55 52		                .text "CONFIGURE"
	>83a4		45

277							                ; Address of command routine, big-endian so that the
278							                ; first byte always has bit 7 set.
12:4	>83a5		88				                .byte >starCONFIGURE
13	>83a6		7a				                .byte <starCONFIGURE

281:6							                ; If bit 7 set, reset the tempFS flag before
282							                ; starting.
283	>83a7		00				                .byte $00

285							                ; If bit 7 set, update string input buffer address
286							                ; before starting.
287							                ;
288							                ; A is set to this value on entry to the routine.
289	>83a8		ff				                .byte $FF
305							                .endif
274							                ; Name of command, compared case-insensitively.
275	>83a9		43 4f 44 45			                .text "CODE"

277							                ; Address of command routine, big-endian so that the
278							                ; first byte always has bit 7 set.
12:4	>83ad		93				                .byte >starCommandThroughOSBYTE
13	>83ae		eb				                .byte <starCommandThroughOSBYTE

281:6							                ; If bit 7 set, reset the tempFS flag before
282							                ; starting.
283	>83af		00				                .byte $00

285							                ; If bit 7 set, update string input buffer address
286							                ; before starting.
287							                ;
288							                ; A is set to this value on entry to the routine.
289	>83b0		88				                .byte $88
274							                ; Name of command, compared case-insensitively.
275	>83b1		43 52 45 41 54 45		                .text "CREATE"

277							                ; Address of command routine, big-endian so that the
278							                ; first byte always has bit 7 set.
12:4	>83b7		93				                .byte >starCommandThroughOSFILE
13	>83b8		18				                .byte <starCommandThroughOSFILE

281:6							                ; If bit 7 set, reset the tempFS flag before
282							                ; starting.
283	>83b9		80				                .byte $80

285							                ; If bit 7 set, update string input buffer address
286							                ; before starting.
287							                ;
288							                ; A is set to this value on entry to the routine.
289	>83ba		07				                .byte $07
274							                ; Name of command, compared case-insensitively.
275	>83bb		44 55 4d 50			                .text "DUMP"

277							                ; Address of command routine, big-endian so that the
278							                ; first byte always has bit 7 set.
12:4	>83bf		8f				                .byte >starDUMP
13	>83c0		42				                .byte <starDUMP

281:6							                ; If bit 7 set, reset the tempFS flag before
282							                ; starting.
283	>83c1		80				                .byte $80

285							                ; If bit 7 set, update string input buffer address
286							                ; before starting.
287							                ;
288							                ; A is set to this value on entry to the routine.
289	>83c2		00				                .byte $00
274							                ; Name of command, compared case-insensitively.
275	>83c3		44 45 4c 45 54 45		                .text "DELETE"

277							                ; Address of command routine, big-endian so that the
278							                ; first byte always has bit 7 set.
12:4	>83c9		94				                .byte >starDELETE
13	>83ca		6a				                .byte <starDELETE

281:6							                ; If bit 7 set, reset the tempFS flag before
282							                ; starting.
283	>83cb		80				                .byte $80

285							                ; If bit 7 set, update string input buffer address
286							                ; before starting.
287							                ;
288							                ; A is set to this value on entry to the routine.
289	>83cc		00				                .byte $00
274							                ; Name of command, compared case-insensitively.
275	>83cd		45 58 45 43			                .text "EXEC"

277							                ; Address of command routine, big-endian so that the
278							                ; first byte always has bit 7 set.
12:4	>83d1		a5				                .byte >starEXEC
13	>83d2		91				                .byte <starEXEC

281:6							                ; If bit 7 set, reset the tempFS flag before
282							                ; starting.
283	>83d3		80				                .byte $80

285							                ; If bit 7 set, update string input buffer address
286							                ; before starting.
287							                ;
288							                ; A is set to this value on entry to the routine.
289	>83d4		00				                .byte $00
274							                ; Name of command, compared case-insensitively.
275	>83d5		45 58				                .text "EX"

277							                ; Address of command routine, big-endian so that the
278							                ; first byte always has bit 7 set.
12:4	>83d7		f1				                .byte >mos.callFSCV
13	>83d8		e5				                .byte <mos.callFSCV

281:6							                ; If bit 7 set, reset the tempFS flag before
282							                ; starting.
283	>83d9		80				                .byte $80

285							                ; If bit 7 set, update string input buffer address
286							                ; before starting.
287							                ;
288							                ; A is set to this value on entry to the routine.
289	>83da		09				                .byte $09
274							                ; Name of command, compared case-insensitively.
275	>83db		46 58				                .text "FX"

277							                ; Address of command routine, big-endian so that the
278							                ; first byte always has bit 7 set.
12:4	>83dd		93				                .byte >starFX
13	>83de		e5				                .byte <starFX

281:6							                ; If bit 7 set, reset the tempFS flag before
282							                ; starting.
283	>83df		00				                .byte $00

285							                ; If bit 7 set, update string input buffer address
286							                ; before starting.
287							                ;
288							                ; A is set to this value on entry to the routine.
289	>83e0		ff				                .byte $FF
274							                ; Name of command, compared case-insensitively.
275	>83e1		47 4f 49 4f			                .text "GOIO"

277							                ; Address of command routine, big-endian so that the
278							                ; first byte always has bit 7 set.
12:4	>83e5		92				                .byte >starGOIO
13	>83e6		fd				                .byte <starGOIO

281:6							                ; If bit 7 set, reset the tempFS flag before
282							                ; starting.
283	>83e7		00				                .byte $00

285							                ; If bit 7 set, update string input buffer address
286							                ; before starting.
287							                ;
288							                ; A is set to this value on entry to the routine.
289	>83e8		ff				                .byte $FF
274							                ; Name of command, compared case-insensitively.
275	>83e9		47 4f				                .text "GO"

277							                ; Address of command routine, big-endian so that the
278							                ; first byte always has bit 7 set.
12:4	>83eb		92				                .byte >starGO
13	>83ec		f5				                .byte <starGO

281:6							                ; If bit 7 set, reset the tempFS flag before
282							                ; starting.
283	>83ed		00				                .byte $00

285							                ; If bit 7 set, update string input buffer address
286							                ; before starting.
287							                ;
288							                ; A is set to this value on entry to the routine.
289	>83ee		ff				                .byte $FF
274							                ; Name of command, compared case-insensitively.
275	>83ef		48 45 4c 50			                .text "HELP"

277							                ; Address of command routine, big-endian so that the
278							                ; first byte always has bit 7 set.
12:4	>83f3		85				                .byte >starHELP
13	>83f4		ca				                .byte <starHELP

281:6							                ; If bit 7 set, reset the tempFS flag before
282							                ; starting.
283	>83f5		00				                .byte $00

285							                ; If bit 7 set, update string input buffer address
286							                ; before starting.
287							                ;
288							                ; A is set to this value on entry to the routine.
289	>83f6		ff				                .byte $FF
274							                ; Name of command, compared case-insensitively.
275	>83f7		49 4e 46 4f			                .text "INFO"

277							                ; Address of command routine, big-endian so that the
278							                ; first byte always has bit 7 set.
12:4	>83fb		f1				                .byte >mos.callFSCV
13	>83fc		e5				                .byte <mos.callFSCV

281:6							                ; If bit 7 set, reset the tempFS flag before
282							                ; starting.
283	>83fd		80				                .byte $80

285							                ; If bit 7 set, update string input buffer address
286							                ; before starting.
287							                ;
288							                ; A is set to this value on entry to the routine.
289	>83fe		0a				                .byte $0A
274							                ; Name of command, compared case-insensitively.
275	>83ff		49 47 4e 4f 52 45		                .text "IGNORE"

277							                ; Address of command routine, big-endian so that the
278							                ; first byte always has bit 7 set.
12:4	>8405		93				                .byte >starIGNORE
13	>8406		87				                .byte <starIGNORE

281:6							                ; If bit 7 set, reset the tempFS flag before
282							                ; starting.
283	>8407		00				                .byte $00

285							                ; If bit 7 set, update string input buffer address
286							                ; before starting.
287							                ;
288							                ; A is set to this value on entry to the routine.
289	>8408		ff				                .byte $FF
274							                ; Name of command, compared case-insensitively.
275	>8409		49 4e 53 45 52 54		                .text "INSERT"

277							                ; Address of command routine, big-endian so that the
278							                ; first byte always has bit 7 set.
12:4	>840f		87				                .byte >starINSERT
13	>8410		1f				                .byte <starINSERT

281:6							                ; If bit 7 set, reset the tempFS flag before
282							                ; starting.
283	>8411		00				                .byte $00

285							                ; If bit 7 set, update string input buffer address
286							                ; before starting.
287							                ;
288							                ; A is set to this value on entry to the routine.
289	>8412		ff				                .byte $FF
274							                ; Name of command, compared case-insensitively.
275	>8413		4b 45 59			                .text "KEY"

277							                ; Address of command routine, big-endian so that the
278							                ; first byte always has bit 7 set.
12:4	>8416		94				                .byte >starKEY
13	>8417		c7				                .byte <starKEY

281:6							                ; If bit 7 set, reset the tempFS flag before
282							                ; starting.
283	>8418		00				                .byte $00

285							                ; If bit 7 set, update string input buffer address
286							                ; before starting.
287							                ;
288							                ; A is set to this value on entry to the routine.
289	>8419		ff				                .byte $FF
274							                ; Name of command, compared case-insensitively.
275	>841a		4c 4f 41 44			                .text "LOAD"

277							                ; Address of command routine, big-endian so that the
278							                ; first byte always has bit 7 set.
12:4	>841e		93				                .byte >starLOAD
13	>841f		16				                .byte <starLOAD

281:6							                ; If bit 7 set, reset the tempFS flag before
282							                ; starting.
283	>8420		80				                .byte $80

285							                ; If bit 7 set, update string input buffer address
286							                ; before starting.
287							                ;
288							                ; A is set to this value on entry to the routine.
289	>8421		00				                .byte $00
274							                ; Name of command, compared case-insensitively.
275	>8422		4c 49 53 54			                .text "LIST"

277							                ; Address of command routine, big-endian so that the
278							                ; first byte always has bit 7 set.
12:4	>8426		8e				                .byte >starLIST
13	>8427		c0				                .byte <starLIST

281:6							                ; If bit 7 set, reset the tempFS flag before
282							                ; starting.
283	>8428		80				                .byte $80

285							                ; If bit 7 set, update string input buffer address
286							                ; before starting.
287							                ;
288							                ; A is set to this value on entry to the routine.
289	>8429		00				                .byte $00
274							                ; Name of command, compared case-insensitively.
275	>842a		4c 49 4e 45			                .text "LINE"

277							                ; Address of command routine, big-endian so that the
278							                ; first byte always has bit 7 set.
12:4	>842e		ec				                .byte >mos.callUSERV
13	>842f		39				                .byte <mos.callUSERV

281:6							                ; If bit 7 set, reset the tempFS flag before
282							                ; starting.
283	>8430		00				                .byte $00

285							                ; If bit 7 set, update string input buffer address
286							                ; before starting.
287							                ;
288							                ; A is set to this value on entry to the routine.
289	>8431		01				                .byte $01
274							                ; Name of command, compared case-insensitively.
275	>8432		4c 49 42 46 53			                .text "LIBFS"

277							                ; Address of command routine, big-endian so that the
278							                ; first byte always has bit 7 set.
12:4	>8437		e7				                .byte >mos.starLIBFS
13	>8438		f6				                .byte <mos.starLIBFS

281:6							                ; If bit 7 set, reset the tempFS flag before
282							                ; starting.
283	>8439		00				                .byte $00

285							                ; If bit 7 set, update string input buffer address
286							                ; before starting.
287							                ;
288							                ; A is set to this value on entry to the routine.
289	>843a		00				                .byte $00
324							                .if version<400
274							                ; Name of command, compared case-insensitively.
275	>843b		4d 4f 54 4f 52			                .text "MOTOR"

277							                ; Address of command routine, big-endian so that the
278							                ; first byte always has bit 7 set.
12:4	>8440		93				                .byte >starCommandThroughOSBYTE
13	>8441		eb				                .byte <starCommandThroughOSBYTE

281:6							                ; If bit 7 set, reset the tempFS flag before
282							                ; starting.
283	>8442		00				                .byte $00

285							                ; If bit 7 set, update string input buffer address
286							                ; before starting.
287							                ;
288							                ; A is set to this value on entry to the routine.
289	>8443		89				                .byte $89
330							                .endif
274							                ; Name of command, compared case-insensitively.
275	>8444		4d 4f 56 45			                .text "MOVE"

277							                ; Address of command routine, big-endian so that the
278							                ; first byte always has bit 7 set.
12:4	>8448		90				                .byte >starMOVE
13	>8449		b6				                .byte <starMOVE

281:6							                ; If bit 7 set, reset the tempFS flag before
282							                ; starting.
283	>844a		80				                .byte $80

285							                ; If bit 7 set, update string input buffer address
286							                ; before starting.
287							                ;
288							                ; A is set to this value on entry to the routine.
289	>844b		00				                .byte $00
274							                ; Name of command, compared case-insensitively.
275	>844c		4f 50 54			                .text "OPT"

277							                ; Address of command routine, big-endian so that the
278							                ; first byte always has bit 7 set.
12:4	>844f		93				                .byte >starCommandThroughOSBYTE
13	>8450		eb				                .byte <starCommandThroughOSBYTE

281:6							                ; If bit 7 set, reset the tempFS flag before
282							                ; starting.
283	>8451		80				                .byte $80

285							                ; If bit 7 set, update string input buffer address
286							                ; before starting.
287							                ;
288							                ; A is set to this value on entry to the routine.
289	>8452		8b				                .byte $8B
274							                ; Name of command, compared case-insensitively.
275	>8453		50 52 49 4e 54			                .text "PRINT"

277							                ; Address of command routine, big-endian so that the
278							                ; first byte always has bit 7 set.
12:4	>8458		8e				                .byte >starPRINT
13	>8459		b9				                .byte <starPRINT

281:6							                ; If bit 7 set, reset the tempFS flag before
282							                ; starting.
283	>845a		80				                .byte $80

285							                ; If bit 7 set, update string input buffer address
286							                ; before starting.
287							                ;
288							                ; A is set to this value on entry to the routine.
289	>845b		00				                .byte $00
274							                ; Name of command, compared case-insensitively.
275	>845c		52 55 4e			                .text "RUN"

277							                ; Address of command routine, big-endian so that the
278							                ; first byte always has bit 7 set.
12:4	>845f		f1				                .byte >mos.callFSCV
13	>8460		e5				                .byte <mos.callFSCV

281:6							                ; If bit 7 set, reset the tempFS flag before
282							                ; starting.
283	>8461		80				                .byte $80

285							                ; If bit 7 set, update string input buffer address
286							                ; before starting.
287							                ;
288							                ; A is set to this value on entry to the routine.
289	>8462		04				                .byte $04
274							                ; Name of command, compared case-insensitively.
275	>8463		52 45 4d 4f 56 45		                .text "REMOVE"

277							                ; Address of command routine, big-endian so that the
278							                ; first byte always has bit 7 set.
12:4	>8469		93				                .byte >starREMOVE
13	>846a		71				                .byte <starREMOVE

281:6							                ; If bit 7 set, reset the tempFS flag before
282							                ; starting.
283	>846b		80				                .byte $80

285							                ; If bit 7 set, update string input buffer address
286							                ; before starting.
287							                ;
288							                ; A is set to this value on entry to the routine.
289	>846c		00				                .byte $00
274							                ; Name of command, compared case-insensitively.
275	>846d		52 4f 4d			                .text "ROM"

277							                ; Address of command routine, big-endian so that the
278							                ; first byte always has bit 7 set.
12:4	>8470		93				                .byte >starCommandThroughOSBYTE
13	>8471		eb				                .byte <starCommandThroughOSBYTE

281:6							                ; If bit 7 set, reset the tempFS flag before
282							                ; starting.
283	>8472		00				                .byte $00

285							                ; If bit 7 set, update string input buffer address
286							                ; before starting.
287							                ;
288							                ; A is set to this value on entry to the routine.
289	>8473		8d				                .byte $8D
274							                ; Name of command, compared case-insensitively.
275	>8474		52 4f 4d 53			                .text "ROMS"

277							                ; Address of command routine, big-endian so that the
278							                ; first byte always has bit 7 set.
12:4	>8478		86				                .byte >starROMS
13	>8479		a6				                .byte <starROMS

281:6							                ; If bit 7 set, reset the tempFS flag before
282							                ; starting.
283	>847a		00				                .byte $00

285							                ; If bit 7 set, update string input buffer address
286							                ; before starting.
287							                ;
288							                ; A is set to this value on entry to the routine.
289	>847b		ff				                .byte $FF
274							                ; Name of command, compared case-insensitively.
275	>847c		53 41 56 45			                .text "SAVE"

277							                ; Address of command routine, big-endian so that the
278							                ; first byte always has bit 7 set.
12:4	>8480		93				                .byte >starCommandThroughOSFILE
13	>8481		18				                .byte <starCommandThroughOSFILE

281:6							                ; If bit 7 set, reset the tempFS flag before
282							                ; starting.
283	>8482		80				                .byte $80

285							                ; If bit 7 set, update string input buffer address
286							                ; before starting.
287							                ;
288							                ; A is set to this value on entry to the routine.
289	>8483		00				                .byte $00
274							                ; Name of command, compared case-insensitively.
275	>8484		53 48 41 44 4f 57		                .text "SHADOW"

277							                ; Address of command routine, big-endian so that the
278							                ; first byte always has bit 7 set.
12:4	>848a		94				                .byte >starSHADOW
13	>848b		66				                .byte <starSHADOW

281:6							                ; If bit 7 set, reset the tempFS flag before
282							                ; starting.
283	>848c		00				                .byte $00

285							                ; If bit 7 set, update string input buffer address
286							                ; before starting.
287							                ;
288							                ; A is set to this value on entry to the routine.
289	>848d		ff				                .byte $FF
274							                ; Name of command, compared case-insensitively.
275	>848e		53 48 4f 57			                .text "SHOW"

277							                ; Address of command routine, big-endian so that the
278							                ; first byte always has bit 7 set.
12:4	>8492		94				                .byte >starSHOW
13	>8493		88				                .byte <starSHOW

281:6							                ; If bit 7 set, reset the tempFS flag before
282							                ; starting.
283	>8494		00				                .byte $00

285							                ; If bit 7 set, update string input buffer address
286							                ; before starting.
287							                ;
288							                ; A is set to this value on entry to the routine.
289	>8495		ff				                .byte $FF
274							                ; Name of command, compared case-insensitively.
275	>8496		53 48 55 54			                .text "SHUT"

277							                ; Address of command routine, big-endian so that the
278							                ; first byte always has bit 7 set.
12:4	>849a		f3				                .byte >mos.starSHUT
13	>849b		73				                .byte <mos.starSHUT

281:6							                ; If bit 7 set, reset the tempFS flag before
282							                ; starting.
283	>849c		00				                .byte $00

285							                ; If bit 7 set, update string input buffer address
286							                ; before starting.
287							                ;
288							                ; A is set to this value on entry to the routine.
289	>849d		00				                .byte $00
274							                ; Name of command, compared case-insensitively.
275	>849e		53 50 4f 4f 4c			                .text "SPOOL"

277							                ; Address of command routine, big-endian so that the
278							                ; first byte always has bit 7 set.
12:4	>84a3		94				                .byte >starSPOOL
13	>84a4		33				                .byte <starSPOOL

281:6							                ; If bit 7 set, reset the tempFS flag before
282							                ; starting.
283	>84a5		80				                .byte $80

285							                ; If bit 7 set, update string input buffer address
286							                ; before starting.
287							                ;
288							                ; A is set to this value on entry to the routine.
289	>84a6		00				                .byte $00
274							                ; Name of command, compared case-insensitively.
275	>84a7		53 50 4f 4f 4c 4f 4e		                .text "SPOOLON"

277							                ; Address of command routine, big-endian so that the
278							                ; first byte always has bit 7 set.
12:4	>84ae		94				                .byte >starSPOOLON
13	>84af		20				                .byte <starSPOOLON

281:6							                ; If bit 7 set, reset the tempFS flag before
282							                ; starting.
283	>84b0		80				                .byte $80

285							                ; If bit 7 set, update string input buffer address
286							                ; before starting.
287							                ;
288							                ; A is set to this value on entry to the routine.
289	>84b1		00				                .byte $00
344							                .if version>=350
351							                .endif
352							                .if version<500&&version!=350
274							                ; Name of command, compared case-insensitively.
275	>84b2		53 54 41 54 55 53		                .text "STATUS"

277							                ; Address of command routine, big-endian so that the
278							                ; first byte always has bit 7 set.
12:4	>84b8		88				                .byte >starSTATUS
13	>84b9		95				                .byte <starSTATUS

281:6							                ; If bit 7 set, reset the tempFS flag before
282							                ; starting.
283	>84ba		00				                .byte $00

285							                ; If bit 7 set, update string input buffer address
286							                ; before starting.
287							                ;
288							                ; A is set to this value on entry to the routine.
289	>84bb		ff				                .byte $FF
356							                .endif
357							                .if version<400
274							                ; Name of command, compared case-insensitively.
275	>84bc		54 41 50 45			                .text "TAPE"

277							                ; Address of command routine, big-endian so that the
278							                ; first byte always has bit 7 set.
12:4	>84c0		93				                .byte >starCommandThroughOSBYTE
13	>84c1		eb				                .byte <starCommandThroughOSBYTE

281:6							                ; If bit 7 set, reset the tempFS flag before
282							                ; starting.
283	>84c2		00				                .byte $00

285							                ; If bit 7 set, update string input buffer address
286							                ; before starting.
287							                ;
288							                ; A is set to this value on entry to the routine.
289	>84c3		8c				                .byte $8C
363							                .endif
274							                ; Name of command, compared case-insensitively.
275	>84c4		54 56				                .text "TV"

277							                ; Address of command routine, big-endian so that the
278							                ; first byte always has bit 7 set.
12:4	>84c6		93				                .byte >starCommandThroughOSBYTE
13	>84c7		eb				                .byte <starCommandThroughOSBYTE

281:6							                ; If bit 7 set, reset the tempFS flag before
282							                ; starting.
283	>84c8		00				                .byte $00

285							                ; If bit 7 set, update string input buffer address
286							                ; before starting.
287							                ;
288							                ; A is set to this value on entry to the routine.
289	>84c9		90				                .byte $90
274							                ; Name of command, compared case-insensitively.
275	>84ca		54 49 4d 45			                .text "TIME"

277							                ; Address of command routine, big-endian so that the
278							                ; first byte always has bit 7 set.
12:4	>84ce		87				                .byte >starTIME
13	>84cf		44				                .byte <starTIME

281:6							                ; If bit 7 set, reset the tempFS flag before
282							                ; starting.
283	>84d0		00				                .byte $00

285							                ; If bit 7 set, update string input buffer address
286							                ; before starting.
287							                ;
288							                ; A is set to this value on entry to the routine.
289	>84d1		00				                .byte $00
274							                ; Name of command, compared case-insensitively.
275	>84d2		54 59 50 45			                .text "TYPE"

277							                ; Address of command routine, big-endian so that the
278							                ; first byte always has bit 7 set.
12:4	>84d6		8e				                .byte >starTYPE
13	>84d7		cb				                .byte <starTYPE

281:6							                ; If bit 7 set, reset the tempFS flag before
282							                ; starting.
283	>84d8		80				                .byte $80

285							                ; If bit 7 set, update string input buffer address
286							                ; before starting.
287							                ;
288							                ; A is set to this value on entry to the routine.
289	>84d9		00				                .byte $00
274							                ; Name of command, compared case-insensitively.
275	>84da		55 4e 50 4c 55 47		                .text "UNPLUG"

277							                ; Address of command routine, big-endian so that the
278							                ; first byte always has bit 7 set.
12:4	>84e0		87				                .byte >starUNPLUG
13	>84e1		22				                .byte <starUNPLUG

281:6							                ; If bit 7 set, reset the tempFS flag before
282							                ; starting.
283	>84e2		00				                .byte $00

285							                ; If bit 7 set, update string input buffer address
286							                ; before starting.
287							                ;
288							                ; A is set to this value on entry to the routine.
289	>84e3		ff				                .byte $FF
368							                .if version<500
274							                ; Name of command, compared case-insensitively.
275	>84e4		58				                .text "X"

277							                ; Address of command routine, big-endian so that the
278							                ; first byte always has bit 7 set.
12:4	>84e5		e7				                .byte >mos.starX
13	>84e6		fd				                .byte <mos.starX

281:6							                ; If bit 7 set, reset the tempFS flag before
282							                ; starting.
283	>84e7		00				                .byte $00

285							                ; If bit 7 set, update string input buffer address
286							                ; before starting.
287							                ;
288							                ; A is set to this value on entry to the routine.
289	>84e8		00				                .byte $00
370							                .endif
274							                ; Name of command, compared case-insensitively.
275	>84e9						                .text ""

277							                ; Address of command routine, big-endian so that the
278							                ; first byte always has bit 7 set.
12:4	>84e9		f1				                .byte >mos.callFSCV
13	>84ea		e5				                .byte <mos.callFSCV

281:6							                ; If bit 7 set, reset the tempFS flag before
282							                ; starting.
283	>84eb		00				                .byte $00

285							                ; If bit 7 set, update string input buffer address
286							                ; before starting.
287							                ;
288							                ; A is set to this value on entry to the routine.
289	>84ec		03				                .byte $03
372	>84ed		00				                .byte $00

374							;-------------------------------------------------------------------------
375							;
376							; Get string input buffer address tail according to table byte.
377							;
378							; Entry:
379							;
380							; oscliWorkspace.tablePtr; = pointer to table byte
381							; (stringInputBufferAddress),y = pointer to input
382							;
383							; Exit:
384							;
385							; A = table byte
386							;
387							; if table byte bit 7 set: Y/X points to command line tail
388	.84ee						maybeGetStringInputBufferAddress:
389	.84ee		b2 b0		lda ($b0)	                lda (oscliWorkspace.tablePtr)
390	.84f0		30 0c		bmi $84fe	                bmi rts84FE
391	.84f2						getStringInputBufferAddressWithYOffset:
392	.84f2		98		tya		                tya
393	.84f3						getStringInputBufferAddressWithAOffset:
394	.84f3		18		clc		                clc
395	.84f4		65 f2		adc $f2		                adc stringInputBufferAddress+0
396	.84f6		aa		tax		                tax
397	.84f7		a4 f3		ldy $f3		                ldy stringInputBufferAddress+1
398	.84f9		90 01		bcc $84fc	                bcc +
399	.84fb		c8		iny		                iny
400	.84fc						+
401	.84fc		b2 b0		lda ($b0)	                lda (oscliWorkspace.tablePtr)
402	.84fe						rts84FE:
403	.84fe		60		rts		                rts

405							; Prepare OSCLI command line
406							; ==========================
407	.84ff						oscli:
408	.84ff		86 f2		stx $f2		                stx stringInputBufferAddress+0
409	.8501		84 f3		sty $f3		                sty stringInputBufferAddress+1
410	.8503		ad 00 df	lda $df00	                lda hazel.currentFS
411	.8506		20 4d fb	jsr $fb4d	                jsr mos.selectFS
412	.8509		a9 08		lda #$08	                lda #fscStarCommand
413	.850b		20 e5 f1	jsr $f1e5	                jsr mos.callFSCV
414	.850e		a0 ff		ldy #$ff	                ldy #$FF
415	.8510						L8510:
416	.8510		20 fe f2	jsr $f2fe	                jsr mos.incAndSkipSpaces
417	.8513		f0 e9		beq $84fe	                beq rts84FE
418	.8515		c9 2a		cmp #$2a	                cmp #'*'
419	.8517		f0 f7		beq $8510	                beq L8510
420	.8519		20 ff f2	jsr $f2ff	                jsr mos.skipSpacesAndCheckForCRInStringInput
421	.851c		f0 e0		beq $84fe	                beq rts84FE
422	.851e		c9 7c		cmp #$7c	                cmp #'|'
423	.8520		f0 dc		beq $84fe	                beq rts84FE
424	.8522		9c c6 df	stz $dfc6	                stz hazel.tempFSFlag
425	.8525		c9 2d		cmp #$2d	                cmp #'-'
426	.8527		d0 0c		bne $8535	                bne L8535
427	.8529		20 a6 fa	jsr $faa6	                jsr mos.parseFileNameFS
428	.852c		20 4d fb	jsr $fb4d	                jsr mos.selectFS
429	.852f		38		sec		                sec
430	.8530		6e c6 df	ror $dfc6	                ror hazel.tempFSFlag
431	.8533		b1 f2		lda ($f2),y	                lda (stringInputBufferAddress),y
432	.8535						L8535:
433	.8535		c9 2f		cmp #$2f	                cmp #'/'
434	.8537		d0 09		bne $8542	                bne L8542
435	.8539		c8		iny		                iny
436	.853a		20 f2 84	jsr $84f2	                jsr getStringInputBufferAddressWithYOffset
437	.853d		a9 02		lda #$02	                lda #fscStarSlash
438	.853f		4c e5 f1	jmp $f1e5	                jmp mos.callFSCV

440	.8542						L8542:
441							                .if version<500&&version!=350
442	.8542		84 e6		sty $e6		                sty $E6
443							                .endif
444	.8544		a9 68		lda #$68	                lda #<mosCommandTable
445	.8546		85 b0		sta $b0		                sta oscliWorkspace.tablePtr+0
446	.8548		a9 83		lda #$83	                lda #>mosCommandTable
447	.854a		85 b1		sta $b1		                sta oscliWorkspace.tablePtr+1
448							                .if version<500&&version!=350
449	.854c		80 0a		bra $8558	                bra L8558
454							                .endif

456							                .if version<500&&version!=350
457	.854e						L854E:
458	.854e		52 b0		eor ($b0)	                eor (oscliWorkspace.tablePtr)
459	.8550		29 df		and #$df	                and #$DF
460	.8552		d0 15		bne $8569	                bne L8569
461	.8554		20 9b 85	jsr $859b	                jsr fetchCommandTableByte
462	.8557		c8		iny		                iny
463	.8558						L8558:
464	.8558		b1 f2		lda ($f2),y	                lda (stringInputBufferAddress),y
465	.855a		20 71 ea	jsr $ea71	                jsr mos.isLetter
466	.855d		90 ef		bcc $854e	                bcc L854E                    ;taken if letter
467	.855f		b2 b0		lda ($b0)	                lda (oscliWorkspace.tablePtr)
468	.8561		30 1f		bmi $8582	                bmi L8582                ;taken if end of command name
469	.8563		b1 f2		lda ($f2),y	                lda (stringInputBufferAddress),y
470	.8565		c9 2e		cmp #$2e	                cmp #'.'
471	.8567		f0 04		beq $856d	                beq L856D                    ;taken if input abbreviated
472	.8569						L8569:
473	.8569		18		clc		                clc
474	.856a		a4 e6		ldy $e6		                ldy $E6
475	.856c		88		dey		                dey
476	.856d						L856D:
477	.856d		c8		iny		                iny
478	.856e						L856E:
479	.856e		20 9b 85	jsr $859b	                jsr fetchCommandTableByte ; Get byte from table, update pointer
480	.8571		f0 3c		beq $85af	                beq passStarCommandThrough   ; Zero byte
481	.8573		10 f9		bpl $856e	                bpl L856E                    ; Loop until b7 set
482	.8575		b0 0e		bcs $8585	                bcs L8585
483	.8577		20 9b 85	jsr $859b	                jsr fetchCommandTableByte
484	.857a		20 9b 85	jsr $859b	                jsr fetchCommandTableByte
485	.857d		20 9b 85	jsr $859b	                jsr fetchCommandTableByte
486	.8580		80 d6		bra $8558	                bra L8558

488	.8582						L8582:
489	.8582		20 9b 85	jsr $859b	                jsr fetchCommandTableByte
490							                .endif
491	.8585						L8585:
492	.8585		48		pha		                pha
493	.8586		20 9b 85	jsr $859b	                jsr fetchCommandTableByte
494	.8589		48		pha		                pha
495	.858a		20 9b 85	jsr $859b	                jsr fetchCommandTableByte
496	.858d		30 03		bmi $8592	                bmi L8592
497	.858f		9c c6 df	stz $dfc6	                stz hazel.tempFSFlag
498	.8592						L8592:
499	.8592		20 ff f2	jsr $f2ff	                jsr mos.skipSpacesAndCheckForCRInStringInput
500	.8595		18		clc		                clc
501	.8596		08		php		                php
502	.8597		20 ee 84	jsr $84ee	                jsr maybeGetStringInputBufferAddress
503	.859a		40		rti		                rti

505							                .if version<500&&version!=350
506	.859b						fetchCommandTableByte:
507	.859b		b2 b0		lda ($b0)	                lda (oscliWorkspace.tablePtr)
508	.859d		48		pha		                pha
509	.859e		e6 b0		inc $b0		                inc oscliWorkspace.tablePtr+0
510	.85a0		d0 02		bne $85a4	                bne +
511	.85a2		e6 b1		inc $b1		                inc oscliWorkspace.tablePtr+1
512	.85a4						+
513	.85a4		68		pla		                pla
514	.85a5						rts85A5:
515	.85a5		60		rts		                rts
516							                .endif

518							;-------------------------------------------------------------------------

520							; *BASIC
521							; ======
522	.85a6						starBASIC:
523	.85a6		ae 4b 02	ldx $024b	                ldx basicROMNumber           ; Get BASIC ROM number
524	.85a9		30 04		bmi $85af	                bmi passStarCommandThrough ; If no BASIC ROM, jump to pass to ROMs and filing system
525							                .if version==350
527							                .elsif version<500
528	.85ab		38		sec		                sec                          ;
529	.85ac		4c c3 e4	jmp $e4c3	                jmp mos.osbyte8E             ; Enter ROM as a language
533							                .endif

535							;-------------------------------------------------------------------------

537							; *ADFS - pass straight to ROMs/Filing System
538							; ===========================================
539	.85af						passStarCommandThrough:
540	.85af		2c c6 df	bit $dfc6	                bit hazel.tempFSFlag      ; Check filing system flag
541	.85b2		30 0c		bmi $85c0	                bmi L85C0                    ; If ... skip ROM service call
542	.85b4		9c c6 df	stz $dfc6	                stz hazel.tempFSFlag      ; Clear filing system flag
543	.85b7		a4 e6		ldy $e6		                ldy $E6
544	.85b9		a2 04		ldx #$04	                ldx #romServiceCallUnrecognisedCommand
545	.85bb		20 03 ee	jsr $ee03	                jsr mos.osbyte8F    ; Service call 4 - Unknown command
546							                .if version<500&&version!=350
547	.85be		f0 e5		beq $85a5	                beq rts85A5                    ; Claimed, return
550							                .endif
551	.85c0						L85C0:
552	.85c0		a5 e6		lda $e6		                lda $E6
553	.85c2		20 f3 84	jsr $84f3	                jsr getStringInputBufferAddressWithAOffset
554	.85c5		a9 03		lda #$03	                lda #$03
555	.85c7		4c e5 f1	jmp $f1e5	                jmp mos.callFSCV ; mos.Pass to FSCV,3 - Unknown command

557	.85ca						starHELP:
558	.85ca		a2 09		ldx #$09	                ldx #romServiceCallHelp      ;
559	.85cc		a5 d0		lda $d0		                lda STATE                    ;
560	.85ce		48		pha		                pha                          ;save STATE
561	.85cf		a9 0e		lda #$0e	                lda #14
562	.85d1		20 ee ff	jsr $ffee	                jsr OSWRCH                   ; paged mode ON
563	.85d4		20 72 ee	jsr $ee72	                jsr mos.makeROMServiceCall   ;
564	.85d7		a2 18		ldx #$18	                ldx #romServiceCallReserved  ;???
565	.85d9		20 72 ee	jsr $ee72	                jsr mos.makeROMServiceCall
566	.85dc		68		pla		                pla                          ;restore STATE
567	.85dd		89 04		bit #$04	                bit #STATE.isPagedScrolling  ;was paged mode on originally?
568	.85df		d0 2c		bne $860d	                bne parseDone   ;taken if paged mode was originally on
569							                                ;(branch target is an arbitrary nearby
570							                                ;RTS)
571	.85e1		a9 0f		lda #$0f	                lda #15         ;restore non-paged mode
572	.85e3		4c ee ff	jmp $ffee	                jmp OSWRCH

574							;-------------------------------------------------------------------------
575							;
576							; Read a byte value (0-255) from a string. If the number has a '&'
577							; prefix, interpret it as hex.
578							;
579							; entry:
580							;
581							; (stringInputBufferAddress),y - string
582							;
583							; exit:
584							;
585							; X = result
586							; ?$e6 = result
587							; C=0 if error
588							; Z=1 if CR encountered
589							;
590	.85e6						parseNumberFromString:
591	.85e6		20 ff f2	jsr $f2ff	                jsr mos.skipSpacesAndCheckForCRInStringInput
592	.85e9		c9 26		cmp #$26	                cmp #'&'                     ; hex value incoming?
593	.85eb		d0 21		bne $860e	                bne parseDecimal             ; taken if not hex value
594	.85ed						parseHex:
595	.85ed		c8		iny		                iny                          ; skip '&'
596	.85ee		20 48 86	jsr $8648	                jsr readHexDigit             ; read first hex digit
597	.85f1		90 53		bcc $8646	                bcc errorReadingString
598	.85f3		85 e6		sta $e6		                sta $E6                      ; save first hex digit
599	.85f5		20 48 86	jsr $8648	                jsr readHexDigit             ; read second hex digih
600	.85f8		90 0e		bcc $8608	                bcc parsedValue         ; taken if not hex digit
601							                ; The first digit read was actually the high nybble,
602							                ; and the current digit read is therefore the low
603							                ; nybble.
604							                ;
605							                ; Shift saved digit 4 bits left.
606	.85fa		a2 04		ldx #$04	                ldx #$04
607	.85fc						-
608	.85fc		06 e6		asl $e6		                asl $E6
609	.85fe		ca		dex		                dex
610	.85ff		d0 fb		bne $85fc	                bne -
611	.8601		04 e6		tsb $e6		                tsb $E6                      ; insert low nybble
612	.8603		20 48 86	jsr $8648	                jsr readHexDigit             ; read third hex digit
613	.8606		b0 29		bcs $8631	                bcs errorReadingString2 ; 3+-digit hex values are not valid
614	.8608						parsedValue:
615	.8608		a6 e6		ldx $e6		                ldx $E6
616	.860a		c9 0d		cmp #$0d	                cmp #$0D
617	.860c		38		sec		                sec
618	.860d						parseDone:
619	.860d		60		rts		                rts

621	.860e						parseDecimal:
622	.860e		20 34 86	jsr $8634	                jsr readDigitFromString
623	.8611		90 33		bcc $8646	                bcc errorReadingString      ;branch taken if not digit
624	.8613						parseDecimalDigit:
625	.8613		85 e6		sta $e6		                sta $E6                     ;save current value
626	.8615		20 33 86	jsr $8633	                jsr readNextDigitFromString
627	.8618		90 ee		bcc $8608	                bcc parsedValue ;branch taken if not digit, meaning number
628							                                     ;parsed successfully
629	.861a		aa		tax		                tax                         ;X=digit

631							                ; calculate (value*4+value)*2 - i.e., value*10. Carry
632							                ; at any point indicates the value was greater than
633							                ; 255, and therefore an error.
634	.861b		a5 e6		lda $e6		                lda $E6                     ;value
635	.861d		0a		asl a		                asl a                       ;value*2
636	.861e		b0 26		bcs $8646	                bcs errorReadingString
637	.8620		0a		asl a		                asl a                       ;value*4
638	.8621		b0 23		bcs $8646	                bcs errorReadingString
639	.8623		65 e6		adc $e6		                adc $E6                     ;value*5
640	.8625		b0 1f		bcs $8646	                bcs errorReadingString
641	.8627		0a		asl a		                asl a                       ;value*10
642	.8628		b0 1c		bcs $8646	                bcs errorReadingString
643	.862a		85 e6		sta $e6		                sta $E6                      ;save value*10
644	.862c		8a		txa		                txa                          ;A=digit
645	.862d		65 e6		adc $e6		                adc $E6                      ;value*10+digit
646	.862f		90 e2		bcc $8613	                bcc parseDecimalDigit
647	.8631						errorReadingString2:
648	.8631		18		clc		                clc
649	.8632		60		rts		                rts

651	.8633						readNextDigitFromString:
652	.8633		c8		iny		                iny

654							; check if current string input byte is a digit.
655							;
656							; exit: C=1 if digit; C=0 if not digit
657	.8634						readDigitFromString:
658	.8634		b1 f2		lda ($f2),y	                lda (stringInputBufferAddress),y
659	.8636		c9 3a		cmp #$3a	                cmp #'9'+1
660	.8638		b0 0c		bcs $8646	                bcs errorReadingString       ;taken if not ASCII decimal digit
661	.863a		c9 30		cmp #$30	                cmp #'0'
662	.863c		90 08		bcc $8646	                bcc errorReadingString       ;taken if not ASCII decimal digit
663	.863e		29 0f		and #$0f	                and #$0F         ;convert ASCII decimaldigit to number
664	.8640		60		rts		                rts

666	.8641						L8641:
667	.8641		20 ff f2	jsr $f2ff	                jsr mos.skipSpacesAndCheckForCRInStringInput
668							                .if version!=350
669	.8644		c9 0d		cmp #$0d	                cmp #$0D
670							                .endif
671	.8646						errorReadingString:
672	.8646		18		clc		                clc
673	.8647		60		rts		                rts

675							;-------------------------------------------------------------------------
676							;
677							; Read a hex digit from a string
678							;
679							; entry:
680							;
681							; (stringInputBufferAddress),y = next byte to read
682							;
683							; exit:
684							;
685							; C=1 if ok: A = digit read
686							;
687							; C=0 if error: Z=1 if CR encountered
688							;
689	.8648						readHexDigit:
690	.8648		20 34 86	jsr $8634	                jsr readDigitFromString
691	.864b		b0 0d		bcs $865a	                bcs +                        ; branch taken if digit
692	.864d		29 df		and #$df	                and #$DF                     ; convert to upper case
693	.864f		c9 47		cmp #$47	                cmp #'F'+1
694	.8651		b0 ee		bcs $8641	                bcs L8641    ; branch taken if not ASCII A-F hex digit
695	.8653		c9 41		cmp #$41	                cmp #'A'
696	.8655		90 ea		bcc $8641	                bcc L8641     ;branch taken if not ASCII A-F hex digit
697							                ; convert ASCII A-F hex digit to number.
698	.8657		49 48		eor #$48	                eor #$48
699	.8659		1a		inc a		                inc a
700	.865a						+
701	.865a		c8		iny		                iny
702	.865b		60		rts		                rts

704							;-------------------------------------------------------------------------
705							;
706							; OSWORD 0 control block for *commands
707							; ====================================
708	.865c						commandLineUIOSWORD0Parameters:
709	>865c		00 dc				                .word hazel.commandLine      ; address
710	>865e		f0				                .byte $F0			; max # chars
711	>865f		20				                .byte $20			; min ASCII char
712	>8660		7e				                .byte $7E			; max ASCII char

714							;-------------------------------------------------------------------------

716	.8661						commandLineUI:
717	.8661		a9 8d		lda #$8d	                lda #<commandLineUIBRKHandler
718	.8663		8d 02 02	sta $0202	                sta BRKV+0
719	.8666		a9 86		lda #$86	                lda #>commandLineUIBRKHandler
720	.8668		8d 03 02	sta $0203	                sta BRKV+1
721	.866b		a9 1f		lda #$1f	                lda #$10|terminalROM         ;????
722	.866d		8d 8c 02	sta $028c	                sta currentLanguageROM
723	.8670						commandLineUILoop:
724	.8670		a2 ff		ldx #$ff	                ldx #$FF
725	.8672		9a		txs		                txs
726	.8673		58		cli		                cli
727	.8674		20 ba ed	jsr $edba	                jsr mos.selectHAZEL
728	.8677		a9 2a		lda #$2a	                lda #'*'
729	.8679		20 ee ff	jsr $ffee	                jsr OSWRCH
730	.867c		20 9d 86	jsr $869d	                jsr readCommandLine
731	.867f		90 03		bcc $8684	                bcc +                     ;taken if ESCAPE not pressed
732	.8681		4c 91 a8	jmp $a891	                jmp escapeError
733	.8684						+
734	.8684		a2 00		ldx #$00	                ldx #<hazel.commandLine
735	.8686		a0 dc		ldy #$dc	                ldy #>hazel.commandLine
736	.8688		20 f7 ff	jsr $fff7	                jsr OSCLI
737	.868b		80 e3		bra $8670	                bra commandLineUILoop

739	.868d						commandLineUIBRKHandler:
740	.868d		20 e7 ff	jsr $ffe7	                jsr OSNEWL
741	.8690		a0 00		ldy #$00	                ldy #$00
742	.8692		20 a7 e7	jsr $e7a7	                jsr mos.printBRKMessage
743	.8695		20 e7 ff	jsr $ffe7	                jsr OSNEWL
744	.8698		80 c7		bra $8661	                bra commandLineUI

746	.869a						badCommandError869A:
747	.869a		4c ed fb	jmp $fbed	                jmp mos.badCommandError

749	.869d						readCommandLine:
750	.869d		a9 00		lda #$00	                lda #$00
751	.869f		a2 5c		ldx #$5c	                ldx #<commandLineUIOSWORD0Parameters
752	.86a1		a0 86		ldy #$86	                ldy #>commandLineUIOSWORD0Parameters
753	.86a3		4c f1 ff	jmp $fff1	                jmp OSWORD

755							;-------------------------------------------------------------------------
756							;
757							; *ROMS [MasRef C.5-10]
758							;
759	.86a6						starROMS:
760	.86a6		20 ff f2	jsr $f2ff	                jsr mos.skipSpacesAndCheckForCRInStringInput
761	.86a9		d0 ef		bne $869a	                bne badCommandError869A
762	.86ab		a0 0f		ldy #$0f	                ldy #$0F
763	.86ad						printROMsLoop:
764							                .if version<400&&version!=350
765	.86ad		c8		iny		                iny                          ;ensure Y!=0
766	.86ae		20 27 a9	jsr $a927	                jsr printFollowingMessage
767	>86b1		52 4f 4d 20 00			                .text "ROM ",0
768	.86b6		98		tya		                tya                          ;A = ROM number+1
769	.86b7		3a		dec a		                dec a                        ;A = ROM number
770	.86b8		48		pha		                pha                          ;save ROM number
786							                .endif
787	.86b9		20 73 a8	jsr $a873	                jsr printHexDigit            ;print ROM slot
788	.86bc		20 0c 9f	jsr $9f0c	                jsr printSpace
789	.86bf		a9 09		lda #$09	                lda #<sidewaysROMName
790	.86c1		85 f6		sta $f6		                sta $F6
791	.86c3		a9 80		lda #$80	                lda #>sidewaysROMName
792	.86c5		85 f7		sta $f7		                sta $F7
793							                .if version<400&&version!=350
794	.86c7		fa		plx		                plx                          ;restore ROM number
795							                .endif
796	.86c8		20 87 e5	jsr $e587	                jsr mos.isROMValidThenSelectTerminalROM
797							                .if version<400&&version!=350
798	.86cb		88		dey		                dey
799							                .endif
800	.86cc		90 4a		bcc $8718	                bcc invalidROM
801							                .if version>=500||version==350
805							                .endif
806	.86ce						printROMNameLoop:
807	.86ce		20 fc f3	jsr $f3fc	                jsr mos.osrdscEntryPoint     ;read name byte
808	.86d1		c9 20		cmp #$20	                cmp #' '
809	.86d3		90 0f		bcc $86e4	                bcc printROMVersion ;taken if non-printable char, including the terminating 0
810	.86d5		c9 7f		cmp #$7f	                cmp #127
811	.86d7		b0 3f		bcs $8718	                bcs invalidROM  ;taken if bad (bit 7 set) char in name
812	.86d9		20 ee ff	jsr $ffee	                jsr OSWRCH
813	.86dc		e6 f6		inc $f6		                inc $F6
814	.86de		24 f6		bit $f6		                bit $F6
815	.86e0		50 ec		bvc $86ce	                bvc printROMNameLoop         ;taken if address<$8040
816	.86e2		80 34		bra $8718	                bra invalidROM               ;taken if name too long

818	.86e4						printROMVersion:
819	.86e4		aa		tax		                tax               ;Z=1 if final char was the expected 0
820	.86e5		d0 31		bne $8718	                bne invalidROM    ;taken if bad (control) char in name
821	.86e7		a9 08		lda #$08	                lda #<sidewaysROMVersion
822	.86e9		85 f6		sta $f6		                sta $F6
823	.86eb		a9 80		lda #$80	                lda #>sidewaysROMVersion
824	.86ed		85 f7		sta $f7		                sta $F7
825	.86ef		20 fc f3	jsr $f3fc	                jsr mos.osrdscEntryPoint
826	.86f2		20 65 a8	jsr $a865	                jsr printSpaceThenPrintHexByte
827	.86f5						printInsertionStatus:
828	.86f5		5a		phy		                phy
829							                .if version<500&&version!=350
830	.86f6		20 bb e9	jsr $e9bb	                jsr mos.getROMInsertedFlagRTCAddressAndMask
831	.86f9		85 b0		sta $b0		                sta starROMSWorkspace.insertedFlagMask
832	.86fb		20 b7 98	jsr $98b7	                jsr readRTCByte
833	.86fe		25 b0		and $b0		                and starROMSWorkspace.insertedFlagMask
836							                .endif
837	.8700		d0 0e		bne $8710	                bne +
838	.8702		20 58 a9	jsr $a958	                jsr alwaysPrintFollowingMessage
839	>8705		20 75 6e 70 6c 75 67 67		                .text " unplugged",0
	>870d		65 64 00
840	.8710						+
841	.8710		7a		ply		                ply
842	.8711		20 e7 ff	jsr $ffe7	                jsr OSNEWL
843	.8714		88		dey		                dey
844	.8715		10 96		bpl $86ad	                bpl printROMsLoop
845	.8717		60		rts		                rts

847	.8718						invalidROM:
848	.8718		a9 3f		lda #$3f	                lda #'?'
849	.871a		20 ee ff	jsr $ffee	                jsr OSWRCH
850	.871d		80 d6		bra $86f5	                bra printInsertionStatus

852							;-------------------------------------------------------------------------

854							                .if version>=500||version==350
861							                .endif

863							;-------------------------------------------------------------------------
864							;
865							; *INSERT [MasRef C.5-8]
866							;
867	.871f						starINSERT:
868	.871f		38		sec		                sec
869	.8720		80 01		bra $8723	                bra starINSERTOrStarUNPLUG

871							;-------------------------------------------------------------------------
872							;
873							; *UNPLUG [MasRef C.5-13]
874							;
875	.8722						starUNPLUG:
876	.8722		18		clc		                clc
877	.8723						starINSERTOrStarUNPLUG:
878	.8723		08		php		                php
879	.8724		20 ff f2	jsr $f2ff	                jsr mos.skipSpacesAndCheckForCRInStringInput
880							                .if version<500&&version!=350
881	.8727		20 7d 89	jsr $897d	                jsr parseSingle4BitNumberFromCommandLine
884							                .endif
885	.872a		a8		tay		                tay                          ;Y=ROM number
886	.872b		20 bb e9	jsr $e9bb	                jsr mos.getROMInsertedFlagRTCAddressAndMask
887	.872e		48		pha		                pha
888	.872f		20 b7 98	jsr $98b7	                jsr readRTCByte
889	.8732		84 b0		sty $b0		                sty starROMSWorkspace.insertedFlagMask
890	.8734		68		pla		                pla
891	.8735		28		plp		                plp
892	.8736		90 04		bcc $873c	                bcc unplug                   ;taken if it's *UNPLUG

894							                ; it's *INSERT
895	.8738		05 b0		ora $b0		                ora starROMSWorkspace.insertedFlagMask
896	.873a		80 04		bra $8740	                bra +
897	.873c						unplug:
898	.873c		49 ff		eor #$ff	                eor #$FF
899	.873e		25 b0		and $b0		                and starROMSWorkspace.insertedFlagMask
900	.8740						+
901	.8740		a8		tay		                tay
902	.8741		4c e4 98	jmp $98e4	                jmp writeRTCByte

904							;-------------------------------------------------------------------------
905							;
906							; *TIME [MasRef C.5-12]
907							;
908	.8744						starTIME:
909	.8744		9c 00 dc	stz $dc00	                stz hazel.commandLine
910	.8747		a2 00		ldx #$00	                ldx #<hazel.commandLine
911	.8749		a0 dc		ldy #$dc	                ldy #>hazel.commandLine
912	.874b		a9 0e		lda #$0e	                lda #$0E
913	.874d		20 f1 ff	jsr $fff1	                jsr OSWORD
914	.8750		a2 e7		ldx #$e7	                ldx #256-size(ClockStringFormat)
915	.8752						L8752:
916	.8752		bd 19 db	lda $db19,x	                lda hazel.commandLine-(256-size(ClockStringFormat)),x
917	.8755		20 e3 ff	jsr $ffe3	                jsr OSASCI
918	.8758		e8		inx		                inx
919	.8759		d0 f7		bne $8752	                bne L8752
920	.875b		60		rts		                rts

922							;-------------------------------------------------------------------------

924							                .if version==350
928							                .elsif version<400
929							                .include "configure320.s65"

:8	;******  Processing file: src/configure320.s65

1	=[]						_:=[]
2	=[(".",$8bf0,$8d7f)]				_..=[(".",printCONFIGUREHelp,printSTATUSHelp)]
3							                .if version<400
4	=[(".",$8bf0,$8d7f),("BAUD",$89f1,$8b7d)]	_..=[("BAUD",setDefaultSerialBaudRateIndex,printDefaultSerialBaudRateIndex)]
5							                .endif
6	=[(".",$8bf0,$8d7f),("BAUD",$89f1,$8b7d),("BOOT",$8a28,$8ae1)]
							_..=[("BOOT",setDefaultAutoBoot,printDefaultAutoBoot)]
7	=[(".",$8bf0,$8d7f),("BAUD",$89f1,$8b7d),("BOOT",$8a28,$8ae1),("CAPS",$88e8,$8a66)]
							_..=[("CAPS",setDefaultsCapsLock,printDefaultCaps)]
8							                .if version<400
9	=[(".",$8bf0,$8d7f),("BAUD",$89f1,$8b7d),("BOOT",$8a28,$8ae1),("CAPS",$88e8,$8a66),("DATA",$8a17,$8b82)]
							_..=[("DATA",setDefaultSerialDataFormat,printDefaultSerialDataFormat)]
10							                .endif
11	=[(".",$8bf0,$8d7f),("BAUD",$89f1,$8b7d),("BOOT",$8a28,$8ae1),("CAPS",$88e8,$8a66),("DATA",$8a17,$8b82),("DELAY",$899f,$8b2e)]
							_..=[("DELAY",setDefaultKeyboardAutoRepeatDelay,printDefaultKeyboardAutoRepeatDelay)]
12							                .if version<400
13	=[(".",$8bf0,$8d7f),("BAUD",$89f1,$8b7d),("BOOT",$8a28,$8ae1),("CAPS",$88e8,$8a66),("DATA",$8a17,$8b82),("DELAY",$899f,$8b2e),("DIR",$88bd,$8baa)]
							_..=[("DIR",setDefaultADFSLoadDir,printDefaultADFSLoadDir)]
14							                .endif
15	=[(".",$8bf0,$8d7f),("BAUD",$89f1,$8b7d),("BOOT",$8a28,$8ae1),("CAPS",$88e8,$8a66),("DATA",$8a17,$8b82),("DELAY",$899f,$8b2e),("DIR",$88bd,$8baa),("EXTUBE",$8a44,$8abb)]
							_..=[("EXTUBE",setDefaultExtTube,printDefaultExtTube)]
16							                .if version<400
17	=[(".",$8bf0,$8d7f),("BAUD",$89f1,$8b7d),("BOOT",$8a28,$8ae1),("CAPS",$88e8,$8a66),("DATA",$8a17,$8b82),("DELAY",$899f,$8b2e),("DIR",$88bd,$8baa),("EXTUBE",$8a44,$8abb),("FDRIVE",$88cb,$8b87)]
							_..=[("FDRIVE",setDefaultFDRIVE,printDefaultFDRIVE)]
18							                .endif
19	=[(".",$8bf0,$8d7f),("BAUD",$89f1,$8b7d),("BOOT",$8a28,$8ae1),("CAPS",$88e8,$8a66),("DATA",$8a17,$8b82),("DELAY",$899f,$8b2e),("DIR",$88bd,$8baa),("EXTUBE",$8a44,$8abb),("FDRIVE",$88cb,$8b87),("FILE",$8a5f,$8b10)]
							_..=[("FILE",setDefaultFSROM,printDefaultFSROM)]
20							                .if version<400
21	=[(".",$8bf0,$8d7f),("BAUD",$89f1,$8b7d),("BOOT",$8a28,$8ae1),("CAPS",$88e8,$8a66),("DATA",$8a17,$8b82),("DELAY",$899f,$8b2e),("DIR",$88bd,$8baa),("EXTUBE",$8a44,$8abb),("FDRIVE",$88cb,$8b87),("FILE",$8a5f,$8b10),("FLOPPY",$88b5,$8b8e)]
							_..=[("FLOPPY",setDefaultFloppyDrive,printDefaultFloppyDrive)]
22							                .endif
23							                .if version<400
24	=[(".",$8bf0,$8d7f),("BAUD",$89f1,$8b7d),("BOOT",$8a28,$8ae1),("CAPS",$88e8,$8a66),("DATA",$8a17,$8b82),("DELAY",$899f,$8b2e),("DIR",$88bd,$8baa),("EXTUBE",$8a44,$8abb),("FDRIVE",$88cb,$8b87),("FILE",$8a5f,$8b10),("FLOPPY",$88b5,$8b8e),("HARD",$88af,$8b8e)]
							_..=[("HARD",setDefaultHardDrive,printDefaultFloppyDrive)]
25							                .endif
26	=[(".",$8bf0,$8d7f),("BAUD",$89f1,$8b7d),("BOOT",$8a28,$8ae1),("CAPS",$88e8,$8a66),("DATA",$8a17,$8b82),("DELAY",$899f,$8b2e),("DIR",$88bd,$8baa),("EXTUBE",$8a44,$8abb),("FDRIVE",$88cb,$8b87),("FILE",$8a5f,$8b10),("FLOPPY",$88b5,$8b8e),("HARD",$88af,$8b8e),("IGNORE",$89b4,$8b44)]
							_..=[("IGNORE",setDefaultPrinterIgnoreChar,printDefaultPrinterIgnoreChar)]
27	=[(".",$8bf0,$8d7f),("BAUD",$89f1,$8b7d),("BOOT",$8a28,$8ae1),("CAPS",$88e8,$8a66),("DATA",$8a17,$8b82),("DELAY",$899f,$8b2e),("DIR",$88bd,$8baa),("EXTUBE",$8a44,$8abb),("FDRIVE",$88cb,$8b87),("FILE",$8a5f,$8b10),("FLOPPY",$88b5,$8b8e),("HARD",$88af,$8b8e),("IGNORE",$89b4,$8b44),("INTUBE",$8a4a,$8abb)]
							_..=[("INTUBE",setDefaultIntTube,printDefaultExtTube)]
28	=[(".",$8bf0,$8d7f),("BAUD",$89f1,$8b7d),("BOOT",$8a28,$8ae1),("CAPS",$88e8,$8a66),("DATA",$8a17,$8b82),("DELAY",$899f,$8b2e),("DIR",$88bd,$8baa),("EXTUBE",$8a44,$8abb),("FDRIVE",$88cb,$8b87),("FILE",$8a5f,$8b10),("FLOPPY",$88b5,$8b8e),("HARD",$88af,$8b8e),("IGNORE",$89b4,$8b44),("INTUBE",$8a4a,$8abb),("LANG",$8a52,$8b08)]
							_..=[("LANG",setDefaultLanguageROM,printDefaultLanguageROM)]
29	=[(".",$8bf0,$8d7f),("BAUD",$89f1,$8b7d),("BOOT",$8a28,$8ae1),("CAPS",$88e8,$8a66),("DATA",$8a17,$8b82),("DELAY",$899f,$8b2e),("DIR",$88bd,$8baa),("EXTUBE",$8a44,$8abb),("FDRIVE",$88cb,$8b87),("FILE",$8a5f,$8b10),("FLOPPY",$88b5,$8b8e),("HARD",$88af,$8b8e),("IGNORE",$89b4,$8b44),("INTUBE",$8a4a,$8abb),("LANG",$8a52,$8b08),("LOUD",$8a0f,$8a9f)]
							_..=[("LOUD",setDefaultLoud,printDefaultLoud)]
30	=[(".",$8bf0,$8d7f),("BAUD",$89f1,$8b7d),("BOOT",$8a28,$8ae1),("CAPS",$88e8,$8a66),("DATA",$8a17,$8b82),("DELAY",$899f,$8b2e),("DIR",$88bd,$8baa),("EXTUBE",$8a44,$8abb),("FDRIVE",$88cb,$8b87),("FILE",$8a5f,$8b10),("FLOPPY",$88b5,$8b8e),("HARD",$88af,$8b8e),("IGNORE",$89b4,$8b44),("INTUBE",$8a4a,$8abb),("LANG",$8a52,$8b08),("LOUD",$8a0f,$8a9f),("MODE",$88f0,$8b25)]
							_..=[("MODE",setDefaultMODE,printDefaultMODE)]
31	=[(".",$8bf0,$8d7f),("BAUD",$89f1,$8b7d),("BOOT",$8a28,$8ae1),("CAPS",$88e8,$8a66),("DATA",$8a17,$8b82),("DELAY",$899f,$8b2e),("DIR",$88bd,$8baa),("EXTUBE",$8a44,$8abb),("FDRIVE",$88cb,$8b87),("FILE",$8a5f,$8b10),("FLOPPY",$88b5,$8b8e),("HARD",$88af,$8b8e),("IGNORE",$89b4,$8b44),("INTUBE",$8a4a,$8abb),("LANG",$8a52,$8b08),("LOUD",$8a0f,$8a9f),("MODE",$88f0,$8b25),("NOBOOT",$8a2e,$8ae1)]
							_..=[("NOBOOT",setDefaultNoAutoBoot,printDefaultAutoBoot)]
32	=[(".",$8bf0,$8d7f),("BAUD",$89f1,$8b7d),("BOOT",$8a28,$8ae1),("CAPS",$88e8,$8a66),("DATA",$8a17,$8b82),("DELAY",$899f,$8b2e),("DIR",$88bd,$8baa),("EXTUBE",$8a44,$8abb),("FDRIVE",$88cb,$8b87),("FILE",$8a5f,$8b10),("FLOPPY",$88b5,$8b8e),("HARD",$88af,$8b8e),("IGNORE",$89b4,$8b44),("INTUBE",$8a4a,$8abb),("LANG",$8a52,$8b08),("LOUD",$8a0f,$8a9f),("MODE",$88f0,$8b25),("NOBOOT",$8a2e,$8ae1),("NOCAPS",$88dc,$8a66)]
							_..=[("NOCAPS",setDefaultNoLock,printDefaultCaps)]
33							                .if version<400
34	=[(".",$8bf0,$8d7f),("BAUD",$89f1,$8b7d),("BOOT",$8a28,$8ae1),("CAPS",$88e8,$8a66),("DATA",$8a17,$8b82),("DELAY",$899f,$8b2e),("DIR",$88bd,$8baa),("EXTUBE",$8a44,$8abb),("FDRIVE",$88cb,$8b87),("FILE",$8a5f,$8b10),("FLOPPY",$88b5,$8b8e),("HARD",$88af,$8b8e),("IGNORE",$89b4,$8b44),("INTUBE",$8a4a,$8abb),("LANG",$8a52,$8b08),("LOUD",$8a0f,$8a9f),("MODE",$88f0,$8b25),("NOBOOT",$8a2e,$8ae1),("NOCAPS",$88dc,$8a66),("NODIR",$88c3,$8baa)]
							_..=[("NODIR",setDefaultADFSNoLoadDir,printDefaultADFSLoadDir)]
35							                .endif
36	=[(".",$8bf0,$8d7f),("BAUD",$89f1,$8b7d),("BOOT",$8a28,$8ae1),("CAPS",$88e8,$8a66),("DATA",$8a17,$8b82),("DELAY",$899f,$8b2e),("DIR",$88bd,$8baa),("EXTUBE",$8a44,$8abb),("FDRIVE",$88cb,$8b87),("FILE",$8a5f,$8b10),("FLOPPY",$88b5,$8b8e),("HARD",$88af,$8b8e),("IGNORE",$89b4,$8b44),("INTUBE",$8a4a,$8abb),("LANG",$8a52,$8b08),("LOUD",$8a0f,$8a9f),("MODE",$88f0,$8b25),("NOBOOT",$8a2e,$8ae1),("NOCAPS",$88dc,$8a66),("NODIR",$88c3,$8baa),("NOSCROLL",$8a3c,$8a89)]
							_..=[("NOSCROLL",setDefaultNoProtectedScrolling,printDefaultProtectedScrolling)]
37	=[(".",$8bf0,$8d7f),("BAUD",$89f1,$8b7d),("BOOT",$8a28,$8ae1),("CAPS",$88e8,$8a66),("DATA",$8a17,$8b82),("DELAY",$899f,$8b2e),("DIR",$88bd,$8baa),("EXTUBE",$8a44,$8abb),("FDRIVE",$88cb,$8b87),("FILE",$8a5f,$8b10),("FLOPPY",$88b5,$8b8e),("HARD",$88af,$8b8e),("IGNORE",$89b4,$8b44),("INTUBE",$8a4a,$8abb),("LANG",$8a52,$8b08),("LOUD",$8a0f,$8a9f),("MODE",$88f0,$8b25),("NOBOOT",$8a2e,$8ae1),("NOCAPS",$88dc,$8a66),("NODIR",$88c3,$8baa),("NOSCROLL",$8a3c,$8a89),("NOTUBE",$89e4,$8af5)]
							_..=[("NOTUBE",setDefaultTubeOff,printDefaultTubeOn)]
38	=[(".",$8bf0,$8d7f),("BAUD",$89f1,$8b7d),("BOOT",$8a28,$8ae1),("CAPS",$88e8,$8a66),("DATA",$8a17,$8b82),("DELAY",$899f,$8b2e),("DIR",$88bd,$8baa),("EXTUBE",$8a44,$8abb),("FDRIVE",$88cb,$8b87),("FILE",$8a5f,$8b10),("FLOPPY",$88b5,$8b8e),("HARD",$88af,$8b8e),("IGNORE",$89b4,$8b44),("INTUBE",$8a4a,$8abb),("LANG",$8a52,$8b08),("LOUD",$8a0f,$8a9f),("MODE",$88f0,$8b25),("NOBOOT",$8a2e,$8ae1),("NOCAPS",$88dc,$8a66),("NODIR",$88c3,$8baa),("NOSCROLL",$8a3c,$8a89),("NOTUBE",$89e4,$8af5),("PRINT",$89c7,$8b78)]
							_..=[("PRINT",setDefaultFX5Settings,printDefaultFX5Settings)]
39	=[(".",$8bf0,$8d7f),("BAUD",$89f1,$8b7d),("BOOT",$8a28,$8ae1),("CAPS",$88e8,$8a66),("DATA",$8a17,$8b82),("DELAY",$899f,$8b2e),("DIR",$88bd,$8baa),("EXTUBE",$8a44,$8abb),("FDRIVE",$88cb,$8b87),("FILE",$8a5f,$8b10),("FLOPPY",$88b5,$8b8e),("HARD",$88af,$8b8e),("IGNORE",$89b4,$8b44),("INTUBE",$8a4a,$8abb),("LANG",$8a52,$8b08),("LOUD",$8a0f,$8a9f),("MODE",$88f0,$8b25),("NOBOOT",$8a2e,$8ae1),("NOCAPS",$88dc,$8a66),("NODIR",$88c3,$8baa),("NOSCROLL",$8a3c,$8a89),("NOTUBE",$89e4,$8af5),("PRINT",$89c7,$8b78),("QUIET",$8a09,$8a9f)]
							_..=[("QUIET",setDefaultQuiet,printDefaultLoud)]
40	=[(".",$8bf0,$8d7f),("BAUD",$89f1,$8b7d),("BOOT",$8a28,$8ae1),("CAPS",$88e8,$8a66),("DATA",$8a17,$8b82),("DELAY",$899f,$8b2e),("DIR",$88bd,$8baa),("EXTUBE",$8a44,$8abb),("FDRIVE",$88cb,$8b87),("FILE",$8a5f,$8b10),("FLOPPY",$88b5,$8b8e),("HARD",$88af,$8b8e),("IGNORE",$89b4,$8b44),("INTUBE",$8a4a,$8abb),("LANG",$8a52,$8b08),("LOUD",$8a0f,$8a9f),("MODE",$88f0,$8b25),("NOBOOT",$8a2e,$8ae1),("NOCAPS",$88dc,$8a66),("NODIR",$88c3,$8baa),("NOSCROLL",$8a3c,$8a89),("NOTUBE",$89e4,$8af5),("PRINT",$89c7,$8b78),("QUIET",$8a09,$8a9f),("REPEAT",$89a1,$8b34)]
							_..=[("REPEAT",setDefaultKeyboardAutoRepeatRate,printDefaultKeyboardRepeatRate)]
41	=[(".",$8bf0,$8d7f),("BAUD",$89f1,$8b7d),("BOOT",$8a28,$8ae1),("CAPS",$88e8,$8a66),("DATA",$8a17,$8b82),("DELAY",$899f,$8b2e),("DIR",$88bd,$8baa),("EXTUBE",$8a44,$8abb),("FDRIVE",$88cb,$8b87),("FILE",$8a5f,$8b10),("FLOPPY",$88b5,$8b8e),("HARD",$88af,$8b8e),("IGNORE",$89b4,$8b44),("INTUBE",$8a4a,$8abb),("LANG",$8a52,$8b08),("LOUD",$8a0f,$8a9f),("MODE",$88f0,$8b25),("NOBOOT",$8a2e,$8ae1),("NOCAPS",$88dc,$8a66),("NODIR",$88c3,$8baa),("NOSCROLL",$8a3c,$8a89),("NOTUBE",$89e4,$8af5),("PRINT",$89c7,$8b78),("QUIET",$8a09,$8a9f),("REPEAT",$89a1,$8b34),("SCROLL",$8a36,$8a89)]
							_..=[("SCROLL",setDefaultProtectedScrolling,printDefaultProtectedScrolling)]
42	=[(".",$8bf0,$8d7f),("BAUD",$89f1,$8b7d),("BOOT",$8a28,$8ae1),("CAPS",$88e8,$8a66),("DATA",$8a17,$8b82),("DELAY",$899f,$8b2e),("DIR",$88bd,$8baa),("EXTUBE",$8a44,$8abb),("FDRIVE",$88cb,$8b87),("FILE",$8a5f,$8b10),("FLOPPY",$88b5,$8b8e),("HARD",$88af,$8b8e),("IGNORE",$89b4,$8b44),("INTUBE",$8a4a,$8abb),("LANG",$8a52,$8b08),("LOUD",$8a0f,$8a9f),("MODE",$88f0,$8b25),("NOBOOT",$8a2e,$8ae1),("NOCAPS",$88dc,$8a66),("NODIR",$88c3,$8baa),("NOSCROLL",$8a3c,$8a89),("NOTUBE",$89e4,$8af5),("PRINT",$89c7,$8b78),("QUIET",$8a09,$8a9f),("REPEAT",$89a1,$8b34),("SCROLL",$8a36,$8a89),("SHCAPS",$88e2,$8a66)]
							_..=[("SHCAPS",setDefaultShiftLock,printDefaultCaps)]
43	=[(".",$8bf0,$8d7f),("BAUD",$89f1,$8b7d),("BOOT",$8a28,$8ae1),("CAPS",$88e8,$8a66),("DATA",$8a17,$8b82),("DELAY",$899f,$8b2e),("DIR",$88bd,$8baa),("EXTUBE",$8a44,$8abb),("FDRIVE",$88cb,$8b87),("FILE",$8a5f,$8b10),("FLOPPY",$88b5,$8b8e),("HARD",$88af,$8b8e),("IGNORE",$89b4,$8b44),("INTUBE",$8a4a,$8abb),("LANG",$8a52,$8b08),("LOUD",$8a0f,$8a9f),("MODE",$88f0,$8b25),("NOBOOT",$8a2e,$8ae1),("NOCAPS",$88dc,$8a66),("NODIR",$88c3,$8baa),("NOSCROLL",$8a3c,$8a89),("NOTUBE",$89e4,$8af5),("PRINT",$89c7,$8b78),("QUIET",$8a09,$8a9f),("REPEAT",$89a1,$8b34),("SCROLL",$8a36,$8a89),("SHCAPS",$88e2,$8a66),("TUBE",$89ee,$8af5)]
							_..=[("TUBE",setDefaultTubeOn,printDefaultTubeOn)]
44	=[(".",$8bf0,$8d7f),("BAUD",$89f1,$8b7d),("BOOT",$8a28,$8ae1),("CAPS",$88e8,$8a66),("DATA",$8a17,$8b82),("DELAY",$899f,$8b2e),("DIR",$88bd,$8baa),("EXTUBE",$8a44,$8abb),("FDRIVE",$88cb,$8b87),("FILE",$8a5f,$8b10),("FLOPPY",$88b5,$8b8e),("HARD",$88af,$8b8e),("IGNORE",$89b4,$8b44),("INTUBE",$8a4a,$8abb),("LANG",$8a52,$8b08),("LOUD",$8a0f,$8a9f),("MODE",$88f0,$8b25),("NOBOOT",$8a2e,$8ae1),("NOCAPS",$88dc,$8a66),("NODIR",$88c3,$8baa),("NOSCROLL",$8a3c,$8a89),("NOTUBE",$89e4,$8af5),("PRINT",$89c7,$8b78),("QUIET",$8a09,$8a9f),("REPEAT",$89a1,$8b34),("SCROLL",$8a36,$8a89),("SHCAPS",$88e2,$8a66),("TUBE",$89ee,$8af5),("TV",$8906,$8b17)]
							_..=[("TV",setDefaultTVSettings,printDefaultTVSettings)]
45	=[(".",$8bf0,$8d7f),("BAUD",$89f1,$8b7d),("BOOT",$8a28,$8ae1),("CAPS",$88e8,$8a66),("DATA",$8a17,$8b82),("DELAY",$899f,$8b2e),("DIR",$88bd,$8baa),("EXTUBE",$8a44,$8abb),("FDRIVE",$88cb,$8b87),("FILE",$8a5f,$8b10),("FLOPPY",$88b5,$8b8e),("HARD",$88af,$8b8e),("IGNORE",$89b4,$8b44),("INTUBE",$8a4a,$8abb),("LANG",$8a52,$8b08),("LOUD",$8a0f,$8a9f),("MODE",$88f0,$8b25),("NOBOOT",$8a2e,$8ae1),("NOCAPS",$88dc,$8a66),("NODIR",$88c3,$8baa),("NOSCROLL",$8a3c,$8a89),("NOTUBE",$89e4,$8af5),("PRINT",$89c7,$8b78),("QUIET",$8a09,$8a9f),("REPEAT",$89a1,$8b34),("SCROLL",$8a36,$8a89),("SHCAPS",$88e2,$8a66),("TUBE",$89ee,$8af5),("TV",$8906,$8b17)]
							configureData=_

47							                .if version<400
48	.875c						configureNames:
49							                .for i=0,i<len(configureData),i+=1
50	>875c		2e				                .text configureData[i][0]
51	>875d		80				                .byte $80+i*4                ;encoded index into configureRoutines
50	>875e		42 41 55 44			                .text configureData[i][0]
51	>8762		84				                .byte $80+i*4                ;encoded index into configureRoutines
50	>8763		42 4f 4f 54			                .text configureData[i][0]
51	>8767		88				                .byte $80+i*4                ;encoded index into configureRoutines
50	>8768		43 41 50 53			                .text configureData[i][0]
51	>876c		8c				                .byte $80+i*4                ;encoded index into configureRoutines
50	>876d		44 41 54 41			                .text configureData[i][0]
51	>8771		90				                .byte $80+i*4                ;encoded index into configureRoutines
50	>8772		44 45 4c 41 59			                .text configureData[i][0]
51	>8777		94				                .byte $80+i*4                ;encoded index into configureRoutines
50	>8778		44 49 52			                .text configureData[i][0]
51	>877b		98				                .byte $80+i*4                ;encoded index into configureRoutines
50	>877c		45 58 54 55 42 45		                .text configureData[i][0]
51	>8782		9c				                .byte $80+i*4                ;encoded index into configureRoutines
50	>8783		46 44 52 49 56 45		                .text configureData[i][0]
51	>8789		a0				                .byte $80+i*4                ;encoded index into configureRoutines
50	>878a		46 49 4c 45			                .text configureData[i][0]
51	>878e		a4				                .byte $80+i*4                ;encoded index into configureRoutines
50	>878f		46 4c 4f 50 50 59		                .text configureData[i][0]
51	>8795		a8				                .byte $80+i*4                ;encoded index into configureRoutines
50	>8796		48 41 52 44			                .text configureData[i][0]
51	>879a		ac				                .byte $80+i*4                ;encoded index into configureRoutines
50	>879b		49 47 4e 4f 52 45		                .text configureData[i][0]
51	>87a1		b0				                .byte $80+i*4                ;encoded index into configureRoutines
50	>87a2		49 4e 54 55 42 45		                .text configureData[i][0]
51	>87a8		b4				                .byte $80+i*4                ;encoded index into configureRoutines
50	>87a9		4c 41 4e 47			                .text configureData[i][0]
51	>87ad		b8				                .byte $80+i*4                ;encoded index into configureRoutines
50	>87ae		4c 4f 55 44			                .text configureData[i][0]
51	>87b2		bc				                .byte $80+i*4                ;encoded index into configureRoutines
50	>87b3		4d 4f 44 45			                .text configureData[i][0]
51	>87b7		c0				                .byte $80+i*4                ;encoded index into configureRoutines
50	>87b8		4e 4f 42 4f 4f 54		                .text configureData[i][0]
51	>87be		c4				                .byte $80+i*4                ;encoded index into configureRoutines
50	>87bf		4e 4f 43 41 50 53		                .text configureData[i][0]
51	>87c5		c8				                .byte $80+i*4                ;encoded index into configureRoutines
50	>87c6		4e 4f 44 49 52			                .text configureData[i][0]
51	>87cb		cc				                .byte $80+i*4                ;encoded index into configureRoutines
50	>87cc		4e 4f 53 43 52 4f 4c 4c		                .text configureData[i][0]
51	>87d4		d0				                .byte $80+i*4                ;encoded index into configureRoutines
50	>87d5		4e 4f 54 55 42 45		                .text configureData[i][0]
51	>87db		d4				                .byte $80+i*4                ;encoded index into configureRoutines
50	>87dc		50 52 49 4e 54			                .text configureData[i][0]
51	>87e1		d8				                .byte $80+i*4                ;encoded index into configureRoutines
50	>87e2		51 55 49 45 54			                .text configureData[i][0]
51	>87e7		dc				                .byte $80+i*4                ;encoded index into configureRoutines
50	>87e8		52 45 50 45 41 54		                .text configureData[i][0]
51	>87ee		e0				                .byte $80+i*4                ;encoded index into configureRoutines
50	>87ef		53 43 52 4f 4c 4c		                .text configureData[i][0]
51	>87f5		e4				                .byte $80+i*4                ;encoded index into configureRoutines
50	>87f6		53 48 43 41 50 53		                .text configureData[i][0]
51	>87fc		e8				                .byte $80+i*4                ;encoded index into configureRoutines
50	>87fd		54 55 42 45			                .text configureData[i][0]
51	>8801		ec				                .byte $80+i*4                ;encoded index into configureRoutines
50	>8802		54 56				                .text configureData[i][0]
51	>8804		f0				                .byte $80+i*4                ;encoded index into configureRoutines
52							                .next
53	>8805		00				                .byte 0

55	.8806						configureRoutines:
56							                .for i=0,i<len(configureData),i+=1
12:4	>8806		8b				                .byte >configureData[i][1]-1
13	>8807		ef				                .byte <configureData[i][1]-1
12	>8808		8d				                .byte >configureData[i][2]-1
13	>8809		7e				                .byte <configureData[i][2]-1
12	>880a		89				                .byte >configureData[i][1]-1
13	>880b		f0				                .byte <configureData[i][1]-1
12	>880c		8b				                .byte >configureData[i][2]-1
13	>880d		7c				                .byte <configureData[i][2]-1
12	>880e		8a				                .byte >configureData[i][1]-1
13	>880f		27				                .byte <configureData[i][1]-1
12	>8810		8a				                .byte >configureData[i][2]-1
13	>8811		e0				                .byte <configureData[i][2]-1
12	>8812		88				                .byte >configureData[i][1]-1
13	>8813		e7				                .byte <configureData[i][1]-1
12	>8814		8a				                .byte >configureData[i][2]-1
13	>8815		65				                .byte <configureData[i][2]-1
12	>8816		8a				                .byte >configureData[i][1]-1
13	>8817		16				                .byte <configureData[i][1]-1
12	>8818		8b				                .byte >configureData[i][2]-1
13	>8819		81				                .byte <configureData[i][2]-1
12	>881a		89				                .byte >configureData[i][1]-1
13	>881b		9e				                .byte <configureData[i][1]-1
12	>881c		8b				                .byte >configureData[i][2]-1
13	>881d		2d				                .byte <configureData[i][2]-1
12	>881e		88				                .byte >configureData[i][1]-1
13	>881f		bc				                .byte <configureData[i][1]-1
12	>8820		8b				                .byte >configureData[i][2]-1
13	>8821		a9				                .byte <configureData[i][2]-1
12	>8822		8a				                .byte >configureData[i][1]-1
13	>8823		43				                .byte <configureData[i][1]-1
12	>8824		8a				                .byte >configureData[i][2]-1
13	>8825		ba				                .byte <configureData[i][2]-1
12	>8826		88				                .byte >configureData[i][1]-1
13	>8827		ca				                .byte <configureData[i][1]-1
12	>8828		8b				                .byte >configureData[i][2]-1
13	>8829		86				                .byte <configureData[i][2]-1
12	>882a		8a				                .byte >configureData[i][1]-1
13	>882b		5e				                .byte <configureData[i][1]-1
12	>882c		8b				                .byte >configureData[i][2]-1
13	>882d		0f				                .byte <configureData[i][2]-1
12	>882e		88				                .byte >configureData[i][1]-1
13	>882f		b4				                .byte <configureData[i][1]-1
12	>8830		8b				                .byte >configureData[i][2]-1
13	>8831		8d				                .byte <configureData[i][2]-1
12	>8832		88				                .byte >configureData[i][1]-1
13	>8833		ae				                .byte <configureData[i][1]-1
12	>8834		8b				                .byte >configureData[i][2]-1
13	>8835		8d				                .byte <configureData[i][2]-1
12	>8836		89				                .byte >configureData[i][1]-1
13	>8837		b3				                .byte <configureData[i][1]-1
12	>8838		8b				                .byte >configureData[i][2]-1
13	>8839		43				                .byte <configureData[i][2]-1
12	>883a		8a				                .byte >configureData[i][1]-1
13	>883b		49				                .byte <configureData[i][1]-1
12	>883c		8a				                .byte >configureData[i][2]-1
13	>883d		ba				                .byte <configureData[i][2]-1
12	>883e		8a				                .byte >configureData[i][1]-1
13	>883f		51				                .byte <configureData[i][1]-1
12	>8840		8b				                .byte >configureData[i][2]-1
13	>8841		07				                .byte <configureData[i][2]-1
12	>8842		8a				                .byte >configureData[i][1]-1
13	>8843		0e				                .byte <configureData[i][1]-1
12	>8844		8a				                .byte >configureData[i][2]-1
13	>8845		9e				                .byte <configureData[i][2]-1
12	>8846		88				                .byte >configureData[i][1]-1
13	>8847		ef				                .byte <configureData[i][1]-1
12	>8848		8b				                .byte >configureData[i][2]-1
13	>8849		24				                .byte <configureData[i][2]-1
12	>884a		8a				                .byte >configureData[i][1]-1
13	>884b		2d				                .byte <configureData[i][1]-1
12	>884c		8a				                .byte >configureData[i][2]-1
13	>884d		e0				                .byte <configureData[i][2]-1
12	>884e		88				                .byte >configureData[i][1]-1
13	>884f		db				                .byte <configureData[i][1]-1
12	>8850		8a				                .byte >configureData[i][2]-1
13	>8851		65				                .byte <configureData[i][2]-1
12	>8852		88				                .byte >configureData[i][1]-1
13	>8853		c2				                .byte <configureData[i][1]-1
12	>8854		8b				                .byte >configureData[i][2]-1
13	>8855		a9				                .byte <configureData[i][2]-1
12	>8856		8a				                .byte >configureData[i][1]-1
13	>8857		3b				                .byte <configureData[i][1]-1
12	>8858		8a				                .byte >configureData[i][2]-1
13	>8859		88				                .byte <configureData[i][2]-1
12	>885a		89				                .byte >configureData[i][1]-1
13	>885b		e3				                .byte <configureData[i][1]-1
12	>885c		8a				                .byte >configureData[i][2]-1
13	>885d		f4				                .byte <configureData[i][2]-1
12	>885e		89				                .byte >configureData[i][1]-1
13	>885f		c6				                .byte <configureData[i][1]-1
12	>8860		8b				                .byte >configureData[i][2]-1
13	>8861		77				                .byte <configureData[i][2]-1
12	>8862		8a				                .byte >configureData[i][1]-1
13	>8863		08				                .byte <configureData[i][1]-1
12	>8864		8a				                .byte >configureData[i][2]-1
13	>8865		9e				                .byte <configureData[i][2]-1
12	>8866		89				                .byte >configureData[i][1]-1
13	>8867		a0				                .byte <configureData[i][1]-1
12	>8868		8b				                .byte >configureData[i][2]-1
13	>8869		33				                .byte <configureData[i][2]-1
12	>886a		8a				                .byte >configureData[i][1]-1
13	>886b		35				                .byte <configureData[i][1]-1
12	>886c		8a				                .byte >configureData[i][2]-1
13	>886d		88				                .byte <configureData[i][2]-1
12	>886e		88				                .byte >configureData[i][1]-1
13	>886f		e1				                .byte <configureData[i][1]-1
12	>8870		8a				                .byte >configureData[i][2]-1
13	>8871		65				                .byte <configureData[i][2]-1
12	>8872		89				                .byte >configureData[i][1]-1
13	>8873		ed				                .byte <configureData[i][1]-1
12	>8874		8a				                .byte >configureData[i][2]-1
13	>8875		f4				                .byte <configureData[i][2]-1
12	>8876		89				                .byte >configureData[i][1]-1
13	>8877		05				                .byte <configureData[i][1]-1
12	>8878		8b				                .byte >configureData[i][2]-1
13	>8879		16				                .byte <configureData[i][2]-1
59:8							                .next
68							                .endif

70							;-------------------------------------------------------------------------
71							;
72							; *CONFIGURE [MasRef C.5-2]
73							;
74	.887a						starCONFIGURE:
75	.887a		20 34 89	jsr $8934	                jsr L8934                    ;get configure param
76	.887d		b0 0a		bcs $8889	                bcs callSetRoutine           ;taken if known
77	.887f		a2 28		ldx #$28	                ldx #romServiceCallUnknownCONFIG
78	.8881						L8881:
79	.8881		a4 e6		ldy $e6		                ldy $E6
80	.8883		20 72 ee	jsr $ee72	                jsr mos.makeROMServiceCall
81	.8886		d0 24		bne $88ac	                bne badCommandError88AC
82	.8888		60		rts		                rts

84	.8889						callSetRoutine:
85							                .if version<400
86	.8889		aa		tax		                tax
87	.888a		bd 86 87	lda $8786,x	                lda configureRoutines+0-$80,x ;set routine MSB
88	.888d		48		pha		                pha
89	.888e		bd 87 87	lda $8787,x	                lda configureRoutines+1-$80,x ;set routine LSB
90	.8891		48		pha		                pha
95							                .endif
96	.8892						L8892:
97	.8892		4c ff f2	jmp $f2ff	                jmp mos.skipSpacesAndCheckForCRInStringInput

99	.8895						starSTATUS:
100	.8895		20 34 89	jsr $8934	                jsr L8934
101	.8898		b0 04		bcs $889e	                bcs L889E
102	.889a		a2 29		ldx #$29	                ldx #romServiceCallUnknownSTATUS
103	.889c		80 e3		bra $8881	                bra L8881

105	.889e						L889E:
106							                .if version<400
107	.889e		aa		tax		                tax
108	.889f		bd 88 87	lda $8788,x	                lda configureRoutines+2-$80,x ;print routine MSB
109	.88a2		48		pha		                pha
110	.88a3		bd 89 87	lda $8789,x	                lda configureRoutines+3-$80,x ;print routine LSB
111	.88a6		48		pha		                pha
117							                .endif
118	.88a7		20 ff f2	jsr $f2ff	                jsr mos.skipSpacesAndCheckForCRInStringInput
119	.88aa		f0 e6		beq $8892	                beq L8892
120	.88ac						badCommandError88AC:
121	.88ac		4c 76 89	jmp $8976	                jmp badCommandError8976

123							;-------------------------------------------------------------------------

125							                .if version<400
126	.88af						setDefaultHardDrive:
127	.88af		d0 fb		bne $88ac	                bne badCommandError88AC
128	.88b1		a9 00		lda #$00	                lda #$00
129	.88b3		80 04		bra $88b9	                bra writeDefaultFloppyDrive
130							                .endif

132							;-------------------------------------------------------------------------

134							                .if version<400
135	.88b5						setDefaultFloppyDrive:
136	.88b5		d0 f5		bne $88ac	                bne badCommandError88AC
137	.88b7		a9 80		lda #$80	                lda #CMOSBytes.defaults1.defaultFloppyDrive
138	.88b9						writeDefaultFloppyDrive:
139	.88b9		a0 7f		ldy #$7f	                ldy #~(CMOSBytes.defaults1.defaultFloppyDrive)&$ff
140	.88bb		80 1b		bra $88d8	                bra writeDefaults1Bits
141							                .endif

143							;-------------------------------------------------------------------------

145							                .if version<400
146	.88bd						setDefaultADFSLoadDir:
147	.88bd		d0 ed		bne $88ac	                bne badCommandError88AC
148	.88bf		a9 00		lda #$00	                lda #$00                                   ;NODIR
149	.88c1		80 04		bra $88c7	                bra writeDefaultADFSLoadDir
150							                .endif

152							;-------------------------------------------------------------------------

154							                .if version<400
155	.88c3						setDefaultADFSNoLoadDir:
156	.88c3		d0 e7		bne $88ac	                bne badCommandError88AC
157	.88c5		a9 40		lda #$40	                lda #CMOSBytes.defaults1.defaultADFSLoadDirMask
158	.88c7						writeDefaultADFSLoadDir:
159	.88c7		a0 bf		ldy #$bf	                ldy #(~CMOSBytes.defaults1.defaultADFSLoadDirMask)&$ff
160	.88c9		80 0d		bra $88d8	                bra writeDefaults1Bits
161							                .endif

163							;-------------------------------------------------------------------------

165							                .if version<400
166	.88cb						setDefaultFDRIVE:
167	.88cb		20 71 89	jsr $8971	                jsr parseNumberFromCommandLine
168	.88ce		20 87 89	jsr $8987	                jsr ensureCommandLineTailEmpty
169	.88d1		8a		txa		                txa
170	.88d2		c9 08		cmp #$08	                cmp #$08                     ;max FDRIVE is 7
171	.88d4		b0 d6		bcs $88ac	                bcs badCommandError88AC
172	.88d6		a0 f8		ldy #$f8	                ldy #(~CMOSBytes.defaults1.defaultFDRIVEMask)&$ff
173	.88d8						writeDefaults1Bits:
174	.88d8		a2 19		ldx #$19	                ldx #CMOSBytes.defaults1+cmosBytesOffset
175	.88da		80 51		bra $892d	                bra jmpWriteRTCBits892D
176							                .endif

178							;-------------------------------------------------------------------------

180	.88dc						setDefaultNoLock:
181	.88dc		d0 ce		bne $88ac	                bne badCommandError88AC
182	.88de		a9 10		lda #$10	                lda #CMOSBytes.defaults1.defaultNoLockMask
183	.88e0		80 0a		bra $88ec	                bra setDefaultLock

185							;-------------------------------------------------------------------------

187	.88e2						setDefaultShiftLock:
188	.88e2		d0 c8		bne $88ac	                bne badCommandError88AC
189	.88e4		a9 08		lda #$08	                lda #CMOSBytes.defaults1.defaultShiftLockMask
190	.88e6		80 04		bra $88ec	                bra setDefaultLock

192							;-------------------------------------------------------------------------

194	.88e8						setDefaultsCapsLock:
195	.88e8		d0 c2		bne $88ac	                bne badCommandError88AC
196	.88ea		a9 20		lda #$20	                lda #CMOSBytes.defaults1.defaultCapsLockMask
197	.88ec						setDefaultLock:
198	.88ec		a0 c7		ldy #$c7	                ldy #~(CMOSBytes.defaults1.defaultCapsLockMask|CMOSBytes.defaults1.defaultNoLockMask|CMOSBytes.defaults1.defaultShiftLockMask)&$ff
199							                .if version<400
200	.88ee		80 e8		bra $88d8	                bra writeDefaults1Bits
205							                .endif

207							;-------------------------------------------------------------------------

209	.88f0						setDefaultMODE:
210	.88f0		20 71 89	jsr $8971	                jsr parseNumberFromCommandLine
211	.88f3		20 87 89	jsr $8987	                jsr ensureCommandLineTailEmpty
212	.88f6		8a		txa		                txa
213	.88f7		29 7f		and #$7f	                and #$7F
214	.88f9		c9 08		cmp #$08	                cmp #$08                     ;only 0-7 is valid
215	.88fb		b0 14		bcs $8911	                bcs bcsBadCommandError8911
216	.88fd		e8		inx		                inx    ;set N as per X value - bit 6 is never set, so the result is valid for the original value
217	.88fe		10 02		bpl $8902	                bpl +
218	.8900		09 08		ora #$08	                ora #CMOSBytes.defaults0.defaultSHADOWMask
219	.8902						+
220	.8902		a0 f0		ldy #$f0	                ldy #~(CMOSBytes.defaults0.defaultSHADOWMask|CMOSBytes.defaults0.defaultMODEMask)&$ff
221	.8904		80 25		bra $892b	                bra writeDefaults0Bits

223							;-------------------------------------------------------------------------

225	.8906						setDefaultTVSettings:
226	.8906		f0 28		beq $8930	                beq resetDefaultTVSettings        ;reset to 0,0 if no values supplied
227	.8908		20 71 89	jsr $8971	                jsr parseNumberFromCommandLine
228							                ; valid range is 252-255 or 0-3
229	.890b		e0 fc		cpx #$fc	                cpx #252
230	.890d		b0 04		bcs $8913	                bcs +
231	.890f		e0 04		cpx #$04	                cpx #$04
232	.8911						bcsBadCommandError8911:
233	.8911		b0 63		bcs $8976	                bcs badCommandError8976
234	.8913						+
235	.8913		8a		txa		                txa
236	.8914		0a		asl a		                asl a                   ;make space for interlace flag
237	.8915		85 b1		sta $b1		                sta $B1
238	.8917		a2 00		ldx #$00	                ldx #$00
239	.8919		20 0a f3	jsr $f30a	                jsr mos.LF30A
240	.891c		f0 04		beq $8922	                beq +                  ;taken if only 1 value supplied
241	.891e		20 8f 89	jsr $898f	                jsr parseSingle1BitNumberFromCommandLine ;get interlace flag
242	.8921		aa		tax		                tax                          ;X=interlace flag
243	.8922						+
244	.8922		8a		txa		                txa                          ;
245	.8923		05 b1		ora $b1		                ora $B1                      ;OR in the TV setting
246	.8925		0a		asl a		                asl a
247	.8926		0a		asl a		                asl a
248	.8927		0a		asl a		                asl a
249	.8928		0a		asl a		                asl a                        ; shift into place
250	.8929						writeDefaultTVSettings:
251	.8929		a0 0f		ldy #$0f	                ldy #~(CMOSBytes.defaults0.defaultTVMask<<CMOSBytes.defaults0.defaultTVShift|CMOSBytes.defaults0.defaultInterlaceMask)&$ff
252	.892b						writeDefaults0Bits:
253	.892b		a2 18		ldx #$18	                ldx #CMOSBytes.defaults0+cmosBytesOffset
254	.892d						jmpWriteRTCBits892D:
255	.892d		4c d6 89	jmp $89d6	                jmp writeRTCBits

257	.8930						resetDefaultTVSettings:
258	.8930		a9 00		lda #$00	                lda #$00
259	.8932		80 f5		bra $8929	                bra writeDefaultTVSettings

261							;-------------------------------------------------------------------------
262							;-------------------------------------------------------------------------
263							;
264							;
265	.8934						L8934:
266	.8934		20 ff f2	jsr $f2ff	                jsr mos.skipSpacesAndCheckForCRInStringInput
267	.8937		84 e6		sty $e6		                sty $E6
268	.8939		f0 3e		beq $8979	                beq L8979                    ;taken if input ends with CR
269	.893b		a2 00		ldx #$00	                ldx #$00
270	.893d		80 0b		bra $894a	                bra L894A

272	.893f						L893F:
273							                .if version==400
275							                .else
276	.893f		5d 5c 87	eor $875c,x	                eor configureNames,x           ;matches configure setting name?
277							                .endif
278	.8942		29 df		and #$df	                and #$DF              ;case-insensitive
279	.8944		d0 16		bne $895c	                bne L895C             ;taken if no match
280	.8946		c8		iny		                iny
281	.8947						L8947:
282	.8947		b0 23		bcs $896c	                bcs L896C
283	.8949		e8		inx		                inx
284	.894a						L894A:
285	.894a		b1 f2		lda ($f2),y	                lda (stringInputBufferAddress),y
286	.894c		20 71 ea	jsr $ea71	                jsr mos.isLetter
287	.894f		90 ee		bcc $893f	                bcc L893F                    ;taken if letter
288	.8951						L8951:
289							                .if version==400
292							                .else
293	.8951		bd 5c 87	lda $875c,x	                lda configureNames,x
294	.8954		30 16		bmi $896c	                bmi L896C           ;taken if info byte - i.e., name matches
295							                .endif
296	.8956		b1 f2		lda ($f2),y	                lda ($F2),y
297	.8958		c9 2e		cmp #$2e	                cmp #'.'
298	.895a		f0 04		beq $8960	                beq L8960                    ;accept abbreviations
299	.895c						L895C:
300	.895c		18		clc		                clc
301	.895d		a4 e6		ldy $e6		                ldy $E6
302	.895f		88		dey		                dey
303	.8960						L8960:
304	.8960		c8		iny		                iny
305							                .if version==400
308							                .else
309	.8961		ca		dex		                dex
310							                .endif
311	.8962						L8962:
312	.8962		e8		inx		                inx
313							                .if version==400
315							                .else
316	.8963		bd 5c 87	lda $875c,x	                lda configureNames,x
317							                .endif
318	.8966		f0 06		beq $896e	                beq L896E
319	.8968		10 f8		bpl $8962	                bpl L8962
320	.896a		80 db		bra $8947	                bra L8947

322	.896c						L896C:
323							                .if version==400
327							                .endif
328	.896c						L8CE4:
329	.896c		38		sec		                sec
330	.896d		60		rts		                rts

332	.896e						L896E:
333	.896e		b0 fc		bcs $896c	                bcs L896C
334	.8970						rts8970:
335	.8970		60		rts		                rts

337							;-------------------------------------------------------------------------

339	.8971						parseNumberFromCommandLine:
340	.8971		20 e6 85	jsr $85e6	                jsr parseNumberFromString
341	.8974		b0 fa		bcs $8970	                bcs rts8970
342	.8976						badCommandError8976:
343	.8976		4c ed fb	jmp $fbed	                jmp mos.badCommandError

345							;-------------------------------------------------------------------------

347	.8979						L8979:
348	.8979		a2 01		ldx #$01	                ldx #$01
349	.897b		80 d4		bra $8951	                bra L8951

351							;-------------------------------------------------------------------------

353	.897d						parseSingle4BitNumberFromCommandLine:
354	.897d		20 e6 85	jsr $85e6	                jsr parseNumberFromString
355	.8980		90 f4		bcc $8976	                bcc badCommandError8976
356	.8982		8a		txa		                txa
357	.8983		c9 10		cmp #$10	                cmp #$10
358	.8985		b0 ef		bcs $8976	                bcs badCommandError8976
359	.8987						ensureCommandLineTailEmpty:
360	.8987		48		pha		                pha                          ;save value parsed
361	.8988		20 ff f2	jsr $f2ff	                jsr mos.skipSpacesAndCheckForCRInStringInput
362	.898b						bneBadCommandError898B:
363	.898b		d0 e9		bne $8976	                bne badCommandError8976      ;taken if followed up by anything other than CR
364	.898d		68		pla		                pla                          ;restore value parsed
365	.898e		60		rts		                rts

367							;-------------------------------------------------------------------------

369	.898f						parseSingle1BitNumberFromCommandLine:
370	.898f		20 97 89	jsr $8997	                jsr parseSingleNumberFromCommandLine
371	.8992		c9 02		cmp #$02	                cmp #$02
372	.8994		b0 e0		bcs $8976	                bcs badCommandError8976
373	.8996		60		rts		                rts

375							;-------------------------------------------------------------------------
376							;
377							; Parse single number from command line. Produce Bad Command error if
378							; the number is invalid or if there's more than one number.
379							;
380							; exit:
381							;
382							; A = value
383							;
384							; N/Z set as per A
385							;
386	.8997						parseSingleNumberFromCommandLine:
387	.8997		20 e6 85	jsr $85e6	                jsr parseNumberFromString
388	.899a		90 da		bcc $8976	                bcc badCommandError8976      ;taken if error
389	.899c		8a		txa		                txa                          ;A=value
390	.899d		80 e8		bra $8987	                bra ensureCommandLineTailEmpty

392							;-------------------------------------------------------------------------

394	.899f						setDefaultKeyboardAutoRepeatDelay:
395	.899f		18		clc		                clc
396	>89a0		24				                .byte $24                    ; BIT zp (make SEC mostly
397							                                             ; a NOP, in effect)
398	.89a1						setDefaultKeyboardAutoRepeatRate:
399	.89a1		38		sec		                sec
400	.89a2		08		php		                php                          ;save C
401	.89a3		20 71 89	jsr $8971	                jsr parseNumberFromCommandLine
402	.89a6		20 87 89	jsr $8987	                jsr ensureCommandLineTailEmpty
403	.89a9		28		plp		                plp                          ;restore C
404	.89aa		8a		txa		                txa
405	.89ab		a8		tay		                tay
406							                .cerror CMOSBytes.keyboardAutoRepeatDelay+1!=CMOSBytes.keyboardAutoRepeatRate,"keyboard auto repeat settings CMOS bytes must be adjacent"
407	.89ac		a9 1a		lda #$1a	                lda #CMOSBytes.keyboardAutoRepeatDelay+cmosBytesOffset
408	.89ae		69 00		adc #$00	                adc #$00             ;pick appropriate byte based on C
409	.89b0		aa		tax		                tax                  ;X=RTC address
410	.89b1						jmpWriteRTCByte:
411	.89b1		4c e4 98	jmp $98e4	                jmp writeRTCByte

413							;-------------------------------------------------------------------------

415	.89b4						setDefaultPrinterIgnoreChar:
416	.89b4		f0 4d		beq $8a03	                beq writeDefaultUsePrinterIgnoreCharTrue
417	.89b6		20 71 89	jsr $8971	                jsr parseNumberFromCommandLine
418	.89b9		da		phx		                phx
419	.89ba		20 87 89	jsr $8987	                jsr ensureCommandLineTailEmpty
420	.89bd		a9 00		lda #$00	                lda #$00
421	.89bf		20 05 8a	jsr $8a05	                jsr writeDefaultUsePrinterIgnoreChar
422	.89c2		7a		ply		                ply
423	.89c3		a2 1c		ldx #$1c	                ldx #CMOSBytes.printerIgnoreChar+cmosBytesOffset
424	.89c5		80 ea		bra $89b1	                bra jmpWriteRTCByte

426							;-------------------------------------------------------------------------

428	.89c7						setDefaultFX5Settings:
429	.89c7		20 97 89	jsr $8997	                jsr parseSingleNumberFromCommandLine
430	.89ca		c9 05		cmp #$05	                cmp #$05
431	.89cc						bcsBadCommandError:
432	.89cc		b0 a8		bcs $8976	                bcs badCommandError8976
433	.89ce		a0 1f		ldy #$1f	                ldy #~(CMOSBytes.defaults2.fx5SettingMask<<CMOSBytes.defaults2.fx5SettingShift)&$ff
434	.89d0		4a		lsr a		                lsr a
435	.89d1		6a		ror a		                ror a
436	.89d2		6a		ror a		                ror a
437	.89d3		6a		ror a		                ror a
438	.89d4						writeDefaults2Bits:
439	.89d4		a2 1d		ldx #$1d	                ldx #CMOSBytes.defaults2+cmosBytesOffset
440	.89d6						writeRTCBits:
441	.89d6		85 b1		sta $b1		                sta $B1
442	.89d8		84 b2		sty $b2		                sty $B2
443	.89da		20 b7 98	jsr $98b7	                jsr readRTCByte
444	.89dd		25 b2		and $b2		                and $B2
445	.89df		05 b1		ora $b1		                ora $B1
446	.89e1		a8		tay		                tay
447	.89e2		80 cd		bra $89b1	                bra jmpWriteRTCByte

449							;-------------------------------------------------------------------------

451	.89e4						setDefaultTubeOff:
452	.89e4		18		clc		                clc
453	.89e5						bneBadCommandError89E5:
454	.89e5		d0 a4		bne $898b	                bne bneBadCommandError898B
455	.89e7		a0 fe		ldy #$fe	                ldy #~(CMOSBytes.defaults2.tubeOnMask)&$ff
456	.89e9		a9 00		lda #$00	                lda #$00
457	.89eb		2a		rol a		                rol a
458	.89ec		80 e6		bra $89d4	                bra writeDefaults2Bits

460							;-------------------------------------------------------------------------

462	.89ee						setDefaultTubeOn:
463	.89ee		38		sec		                sec
464	.89ef		80 f4		bra $89e5	                bra bneBadCommandError89E5

466							;-------------------------------------------------------------------------

468							                .if version<400
469	.89f1						setDefaultSerialBaudRateIndex:
470	.89f1		20 97 89	jsr $8997	                jsr parseSingleNumberFromCommandLine
471	.89f4		d0 02		bne $89f8	                bne +
472	.89f6		a9 07		lda #$07	                lda #$07
473	.89f8						+
474	.89f8		c9 09		cmp #$09	                cmp #$09
475	.89fa		b0 d0		bcs $89cc	                bcs bcsBadCommandError       ;Bad Command if >=9
476	.89fc		3a		dec a		                dec a
477	.89fd		a0 e3		ldy #$e3	                ldy #~(CMOSBytes.defaults2.serialBaudRateIndexMask<<CMOSBytes.defaults2.serialBaudRateIndexShift)&$ff
478	.89ff		0a		asl a		                asl a
479	.8a00		0a		asl a		                asl a                        ;shift value into place
480	.8a01		80 d1		bra $89d4	                bra writeDefaults2Bits
481							                .endif

483							;-------------------------------------------------------------------------

485	.8a03						writeDefaultUsePrinterIgnoreCharTrue:
486	.8a03		a9 02		lda #$02	                lda #CMOSBytes.defaults2.usePrinterIgnoreCharMask
487	.8a05						writeDefaultUsePrinterIgnoreChar:
488	.8a05		a0 fd		ldy #$fd	                ldy #(~CMOSBytes.defaults2.usePrinterIgnoreCharMask)&$ff
489	.8a07		80 cb		bra $89d4	                bra writeDefaults2Bits

491							;-------------------------------------------------------------------------

493	.8a09						setDefaultQuiet:
494	.8a09		d0 da		bne $89e5	                bne bneBadCommandError89E5
495	.8a0b		a9 00		lda #$00	                lda #$00
496	.8a0d		80 04		bra $8a13	                bra writeDefaultLoud

498							;-------------------------------------------------------------------------

500	.8a0f						setDefaultLoud:
501	.8a0f		d0 d4		bne $89e5	                bne bneBadCommandError89E5
502	.8a11		a9 02		lda #$02	                lda #CMOSBytes.defaults3.loudMask
503	.8a13						writeDefaultLoud:
504	.8a13		a0 fd		ldy #$fd	                ldy #~(CMOSBytes.defaults3.loudMask)&$ff
505							                .if version<400
506	.8a15		80 0d		bra $8a24	                bra writeDefaults3Bits
512							                .endif

514							;-------------------------------------------------------------------------

516							                .if version<400
517	.8a17						setDefaultSerialDataFormat:
518	.8a17		20 97 89	jsr $8997	                jsr parseSingleNumberFromCommandLine
519	.8a1a		c9 08		cmp #$08	                cmp #$08
520	.8a1c		b0 ae		bcs $89cc	                bcs bcsBadCommandError
521	.8a1e		a0 1f		ldy #$1f	                ldy #~(CMOSBytes.defaults3.defaultSerialDataFormatMask<<CMOSBytes.defaults3.defaultSerialDataFormatShift)&$ff
522	.8a20		4a		lsr a		                lsr a                        ;%000000ab c
523	.8a21		6a		ror a		                ror a                        ;%c000000a b
524	.8a22		6a		ror a		                ror a                        ;%bc000000 a
525	.8a23		6a		ror a		                ror a                        ;%abc00000 0
526	.8a24						writeDefaults3Bits:
527	.8a24		a2 1e		ldx #$1e	                ldx #CMOSBytes.defaults3+cmosBytesOffset
528	.8a26						jmpWriteRTCBits8A26:
529	.8a26		80 ae		bra $89d6	                bra writeRTCBits
530							                .endif

532							;-------------------------------------------------------------------------

534	.8a28						setDefaultAutoBoot:
535	.8a28		d0 bb		bne $89e5	                bne bneBadCommandError89E5
536	.8a2a		a9 10		lda #$10	                lda #CMOSBytes.defaults3.autoBootMask
537	.8a2c		80 04		bra $8a32	                bra writeDefaultAutoBoot

539							;-------------------------------------------------------------------------

541	.8a2e						setDefaultNoAutoBoot:
542	.8a2e		d0 b5		bne $89e5	                bne bneBadCommandError89E5
543	.8a30		a9 00		lda #$00	                lda #$00                     ;no boot
544	.8a32						writeDefaultAutoBoot:
545	.8a32		a0 ef		ldy #$ef	                ldy #(~CMOSBytes.defaults3.autoBootMask)&$ff
546	.8a34		80 ee		bra $8a24	                bra writeDefaults3Bits

548							;-------------------------------------------------------------------------

550	.8a36						setDefaultProtectedScrolling:
551	.8a36		d0 ad		bne $89e5	                bne bneBadCommandError89E5
552	.8a38		a9 00		lda #$00	                lda #$00
553	.8a3a		80 04		bra $8a40	                bra writeDefaultProtectedScrolling

555							;-------------------------------------------------------------------------

557	.8a3c						setDefaultNoProtectedScrolling:
558	.8a3c		d0 a7		bne $89e5	                bne bneBadCommandError89E5
559	.8a3e		a9 08		lda #$08	                lda #CMOSBytes.defaults3.protectedScrollingMask
560	.8a40						writeDefaultProtectedScrolling:
561	.8a40		a0 f7		ldy #$f7	                ldy #~(CMOSBytes.defaults3.protectedScrollingMask)&$ff
562	.8a42		80 e0		bra $8a24	                bra writeDefaults3Bits

564							;-------------------------------------------------------------------------

566	.8a44						setDefaultExtTube:
567	.8a44		d0 86		bne $89cc	                bne bcsBadCommandError
568	.8a46		a9 04		lda #$04	                lda #CMOSBytes.defaults3.extTubeMask
569	.8a48		80 04		bra $8a4e	                bra writeDefaultExtTube

571							;-------------------------------------------------------------------------

573	.8a4a						setDefaultIntTube:
574	.8a4a		d0 80		bne $89cc	                bne bcsBadCommandError
575	.8a4c		a9 00		lda #$00	                lda #$00
576	.8a4e						writeDefaultExtTube:
577	.8a4e		a0 fb		ldy #$fb	                ldy #~(CMOSBytes.defaults3.extTubeMask)&$ff
578	.8a50		80 d2		bra $8a24	                bra writeDefaults3Bits

580							;-------------------------------------------------------------------------

582	.8a52						setDefaultLanguageROM:
583	.8a52		20 7d 89	jsr $897d	                jsr parseSingle4BitNumberFromCommandLine
584	.8a55		0a		asl a		                asl a
585	.8a56		0a		asl a		                asl a
586	.8a57		0a		asl a		                asl a
587	.8a58		0a		asl a		                asl a
588	.8a59		a0 0f		ldy #$0f	                ldy #~(15<<CMOSBytes.defaultROMs.languageShift)&$ff
589	.8a5b						writeDefaultROM:
590	.8a5b		a2 13		ldx #$13	                ldx #CMOSBytes.defaultROMs+cmosBytesOffset
591	.8a5d		80 c7		bra $8a26	                bra jmpWriteRTCBits8A26

593							;-------------------------------------------------------------------------

595	.8a5f						setDefaultFSROM:
596	.8a5f		20 7d 89	jsr $897d	                jsr parseSingle4BitNumberFromCommandLine
597	.8a62		a0 f0		ldy #$f0	                ldy #~(15<<CMOSBytes.defaultROMs.fsShift)&$ff
598	.8a64		80 f5		bra $8a5b	                bra writeDefaultROM

600							;-------------------------------------------------------------------------

602	.8a66						printDefaultCaps:
603	.8a66		20 ad 8e	jsr $8ead	                jsr readDefaults1            ;%fdCNSfff
604	.8a69		0a		asl a		                asl a                        ;%dCNSfff0
605	.8a6a		0a		asl a		                asl a                        ;%CNSfff00
606	.8a6b		30 0d		bmi $8a7a	                bmi printCaps
607	.8a6d		0a		asl a		                asl a                        ;%NSfff000
608	.8a6e		30 14		bmi $8a84	                bmi printNoCaps
609	.8a70		20 58 a9	jsr $a958	                jsr alwaysPrintFollowingMessage
610	>8a73		53 68 69 66 74 20 00		                .text "Shift ",0
611	.8a7a						printCaps:
612	.8a7a		20 58 a9	jsr $a958	                jsr alwaysPrintFollowingMessage
613	>8a7d		43 61 70 73 0d 00		                .text "Caps",13,0
614	.8a83		60		rts		                rts
615	.8a84						printNoCaps:
616	.8a84		20 b1 8e	jsr $8eb1	                jsr printNo_
617	.8a87		80 f1		bra $8a7a	                bra printCaps

619							;-------------------------------------------------------------------------

621	.8a89						printDefaultProtectedScrolling:
622	.8a89		20 ae 98	jsr $98ae	                jsr readDefaults3
623	.8a8c		89 08		bit #$08	                bit #CMOSBytes.defaults3.protectedScrollingMask
624	.8a8e		f0 03		beq $8a93	                beq +
625	.8a90		20 b1 8e	jsr $8eb1	                jsr printNo_
626	.8a93						+
627	.8a93		20 58 a9	jsr $a958	                jsr alwaysPrintFollowingMessage
628	>8a96		53 63 72 6f 6c 6c 0d 00		                .text "Scroll",13,0
629	.8a9e		60		rts		                rts

631							;-------------------------------------------------------------------------

633	.8a9f						printDefaultLoud:
634	.8a9f		20 ae 98	jsr $98ae	                jsr readDefaults3
635	.8aa2		89 02		bit #$02	                bit #CMOSBytes.defaults3.loudMask
636	.8aa4		d0 0b		bne $8ab1	                bne printLoud
637	.8aa6		20 58 a9	jsr $a958	                jsr alwaysPrintFollowingMessage
638	>8aa9		51 75 69 65 74 0d 00		                .text "Quiet",13,0
639	.8ab0		60		rts		                rts

641	.8ab1						printLoud:
642	.8ab1		20 58 a9	jsr $a958	                jsr alwaysPrintFollowingMessage
643	>8ab4		4c 6f 75 64 0d 00		                .text "Loud",13,0
644	.8aba		60		rts		                rts

646							;-------------------------------------------------------------------------

648	.8abb						printDefaultExtTube:
649	.8abb		20 ae 98	jsr $98ae	                jsr readDefaults3
650	.8abe		89 04		bit #$04	                bit #CMOSBytes.defaults3.extTubeMask
651	.8ac0		d0 08		bne $8aca	                bne printExternalTube
652	.8ac2		20 58 a9	jsr $a958	                jsr alwaysPrintFollowingMessage
653	>8ac5		49 6e 00			                .text "In",0
654	.8ac8		80 06		bra $8ad0	                bra printTernalTube

656	.8aca						printExternalTube:
657	.8aca		20 58 a9	jsr $a958	                jsr alwaysPrintFollowingMessage
658	>8acd		45 78 00			                .text "Ex",0
659	.8ad0						printTernalTube:
660	.8ad0		20 58 a9	jsr $a958	                jsr alwaysPrintFollowingMessage
661	>8ad3		74 65 72 6e 61 6c 20 54		                .text "ternal Tube",13,0
	>8adb		75 62 65 0d 00
662	.8ae0		60		rts		                rts

664							;-------------------------------------------------------------------------

666	.8ae1						printDefaultAutoBoot:
667	.8ae1		20 ae 98	jsr $98ae	                jsr readDefaults3
668	.8ae4		89 10		bit #$10	                bit #CMOSBytes.defaults3.autoBootMask
669	.8ae6		d0 03		bne $8aeb	                bne +
670	.8ae8		20 b1 8e	jsr $8eb1	                jsr printNo_
671	.8aeb						+
672	.8aeb		20 58 a9	jsr $a958	                jsr alwaysPrintFollowingMessage
673	>8aee		42 6f 6f 74 0d 00		                .text "Boot",13,0
674	.8af4		60		rts		                rts

676							;-------------------------------------------------------------------------

678	.8af5						printDefaultTubeOn:
679	.8af5		20 aa 98	jsr $98aa	                jsr readDefaults2
680	.8af8		4a		lsr a		                lsr a                        ;C=tubeOn
681	.8af9		b0 03		bcs $8afe	                bcs +
682	.8afb		20 b1 8e	jsr $8eb1	                jsr printNo_
683	.8afe						+
684	.8afe		20 58 a9	jsr $a958	                jsr alwaysPrintFollowingMessage
685	>8b01		54 75 62 65 0d 00		                .text "Tube",13,0
686	.8b07		60		rts		                rts

688							;-------------------------------------------------------------------------

690	.8b08						printDefaultLanguageROM:
691	.8b08		20 9c 8e	jsr $8e9c	                jsr readDefaultLanguageROM
692	.8b0b						printROMNumber:
693	.8b0b		20 c4 8b	jsr $8bc4	                jsr printDecimalByte
694	.8b0e		80 1b		bra $8b2b	                bra printNewLine8B2B

696							;-------------------------------------------------------------------------

698	.8b10						printDefaultFSROM:
699	.8b10		20 a4 8e	jsr $8ea4	                jsr readDefaultROMs
700	.8b13		29 0f		and #$0f	                and #$0F
701	.8b15		80 f4		bra $8b0b	                bra printROMNumber

703							;-------------------------------------------------------------------------

705	.8b17						printDefaultTVSettings:
706	.8b17		20 5a 8e	jsr $8e5a	                jsr readDefaultTVSettings
707	.8b1a		20 c3 8b	jsr $8bc3	                jsr printDecimalByteY
708	.8b1d		a9 2c		lda #$2c	                lda #','
709	.8b1f		20 ee ff	jsr $ffee	                jsr OSWRCH
710	.8b22		8a		txa		                txa
711	.8b23		80 03		bra $8b28	                bra printDecimalByteThenNewLine

713							;-------------------------------------------------------------------------

715	.8b25						printDefaultMODE:
716	.8b25		20 76 8e	jsr $8e76	                jsr readDefaultMODE
717	.8b28						printDecimalByteThenNewLine:
718	.8b28		20 c4 8b	jsr $8bc4	                jsr printDecimalByte
719	.8b2b						printNewLine8B2B:
720	.8b2b		4c e7 ff	jmp $ffe7	                jmp OSNEWL

722							;-------------------------------------------------------------------------

724	.8b2e						printDefaultKeyboardAutoRepeatDelay:
725	.8b2e		20 3a 8b	jsr $8b3a	                jsr getDefaultKeyboardAutoRepeatDelay
726	.8b31		98		tya		                tya
727	.8b32		80 f4		bra $8b28	                bra printDecimalByteThenNewLine

729							;-------------------------------------------------------------------------

731	.8b34						printDefaultKeyboardRepeatRate:
732	.8b34		20 3f 8b	jsr $8b3f	                jsr getDefaultKeyboardAutoRepeatRate
733	.8b37		98		tya		                tya
734	.8b38		80 ee		bra $8b28	                bra printDecimalByteThenNewLine

736							;-------------------------------------------------------------------------
737							;
738							; Read default keyboard auto repeat delay from CMOS RAM.
739							;
740							; exit:
741							;
742							; Y = default keyboard auto repeat delay
743							;
744	.8b3a						getDefaultKeyboardAutoRepeatDelay:
745	.8b3a		a2 1a		ldx #$1a	                ldx #CMOSBytes.keyboardAutoRepeatDelay+cmosBytesOffset
746	.8b3c		4c b7 98	jmp $98b7	                jmp readRTCByte

748							;-------------------------------------------------------------------------
749							;
750							; Read default keyboard auto repeat rate from CMOS RAM.
751							;
752							; exit:
753							;
754							; Y = default keyboard auto repeat rate
755							;
756	.8b3f						getDefaultKeyboardAutoRepeatRate:
757	.8b3f		a2 1b		ldx #$1b	                ldx #CMOSBytes.keyboardAutoRepeatRate+cmosBytesOffset
758	.8b41		4c b7 98	jmp $98b7	                jmp readRTCByte

760							;-------------------------------------------------------------------------

762	.8b44						printDefaultPrinterIgnoreChar:
763	.8b44		20 aa 98	jsr $98aa	                jsr readDefaults2
764	.8b47		89 02		bit #$02	                bit #CMOSBytes.defaults2.usePrinterIgnoreCharMask
765	.8b49		f0 0f		beq $8b5a	                beq showDefaultPrinterIgnoreChar
766	.8b4b						printNoIgnore:
767	.8b4b		20 b1 8e	jsr $8eb1	                jsr printNo_
768	.8b4e		20 58 a9	jsr $a958	                jsr alwaysPrintFollowingMessage
769	>8b51		49 67 6e 6f 72 65 0d 00		                .text "Ignore",13,0
770	.8b59		60		rts		                rts

772	.8b5a						showDefaultPrinterIgnoreChar:
773	.8b5a		20 a8 8e	jsr $8ea8	                jsr readDefaultPrinterIgnoreChar
774	.8b5d		20 c4 8b	jsr $8bc4	                jsr printDecimalByte
775	.8b60		80 c9		bra $8b2b	                bra printNewLine8B2B

777	.8b62						printDefaultPrinterIgnoreChar2:
778	.8b62		20 aa 98	jsr $98aa	                jsr readDefaults2
779	.8b65		89 02		bit #$02	                bit #CMOSBytes.defaults2.usePrinterIgnoreCharMask
780	.8b67		d0 e2		bne $8b4b	                bne printNoIgnore
781	.8b69		20 58 a9	jsr $a958	                jsr alwaysPrintFollowingMessage
782	>8b6c		49 67 6e 6f 72 65 20 20		                .text "Ignore   ",0
	>8b74		20 00
783	.8b76		80 e2		bra $8b5a	                bra showDefaultPrinterIgnoreChar

785							;-------------------------------------------------------------------------

787	.8b78						printDefaultFX5Settings:
788	.8b78		20 8d 8e	jsr $8e8d	                jsr readDefaultFX5Settings
789	.8b7b		80 ab		bra $8b28	                bra printDecimalByteThenNewLine

791							;-------------------------------------------------------------------------

793							                .if version<400
794	.8b7d						printDefaultSerialBaudRateIndex:
795	.8b7d		20 84 8e	jsr $8e84	                jsr readDefaultSerialBaudRateIndex
796	.8b80		80 a6		bra $8b28	                bra printDecimalByteThenNewLine
797							                .endif

799							;-------------------------------------------------------------------------

801							                .if version<400
802	.8b82						printDefaultSerialDataFormat:
803	.8b82		20 97 8e	jsr $8e97	                jsr readDefaultSerialDataFormat
804	.8b85		80 a1		bra $8b28	                bra printDecimalByteThenNewLine
805							                .endif

807							;-------------------------------------------------------------------------

809							                .if version<400
810	.8b87						printDefaultFDRIVE:
811	.8b87		20 ad 8e	jsr $8ead	                jsr readDefaults1
812	.8b8a		29 07		and #$07	                and #CMOSBytes.defaults1.defaultFDRIVEMask
813	.8b8c		80 9a		bra $8b28	                bra printDecimalByteThenNewLine
814							                .endif

816							;-------------------------------------------------------------------------

818							                .if version<400
819	.8b8e						printDefaultFloppyDrive:
820	.8b8e		20 ad 8e	jsr $8ead	                jsr readDefaults1
821	.8b91		0a		asl a		                asl a                        ;C=1=floppy, C=0=hard
822	.8b92		b0 0a		bcs $8b9e	                bcs +                    ;taken if floppy
823	.8b94		20 58 a9	jsr $a958	                jsr alwaysPrintFollowingMessage
824	>8b97		48 61 72 64 0d 00		                .text "Hard",13,0
825	.8b9d		60		rts		                rts

827	.8b9e						+
828	.8b9e		20 58 a9	jsr $a958	                jsr alwaysPrintFollowingMessage
829	>8ba1		46 6c 6f 70 70 79 0d 00		                .text "Floppy",13,0
830	.8ba9		60		rts		                rts
831							                .endif

833							;-------------------------------------------------------------------------

835							                .if version<400
836	.8baa						printDefaultADFSLoadDir:
837	.8baa		20 ad 8e	jsr $8ead	                jsr readDefaults1
838	.8bad		0a		asl a		                asl a                        ;C=defaultFloppyDrive
839	.8bae		0a		asl a		                asl a                        ;C=defaultADFSLoadDir
840	.8baf		90 03		bcc $8bb4	                bcc +                    ;taken if NODIR - print "Directory"
841	.8bb1		20 b1 8e	jsr $8eb1	                jsr printNo_             ;print "No Directory"
842	.8bb4						+
843	.8bb4		20 58 a9	jsr $a958	                jsr alwaysPrintFollowingMessage
844	>8bb7		44 69 72 65 63 74 6f 72		                .text "Directory",13,0
	>8bbf		79 0d 00
845	.8bc2		60		rts		                rts
846							                .endif

848							;-------------------------------------------------------------------------
849							;
850							;
851							;
852	.8bc3						printDecimalByteY:
853	.8bc3		98		tya		                tya
854	.8bc4						printDecimalByte:
855	.8bc4		38		sec		                sec                          ;in leading 0s state
856	.8bc5		a0 ff		ldy #$ff	                ldy #$FF                     ;digit = -1
857	.8bc7		08		php		                php                          ;save leading 0s state
858	.8bc8						hundredsLoop:
859	.8bc8		c8		iny		                iny
860	.8bc9		e9 64		sbc #$64	                sbc #100
861	.8bcb		b0 fb		bcs $8bc8	                bcs hundredsLoop
862	.8bcd		69 64		adc #$64	                adc #100                     ;undo the step too far
863	.8bcf		28		plp		                plp                        ;restore leading 0s state
864	.8bd0		20 e4 8b	jsr $8be4	                jsr printDecimalDigit
865	.8bd3		a0 ff		ldy #$ff	                ldy #$FF
866	.8bd5		08		php		                php
867	.8bd6		38		sec		                sec
868	.8bd7						tensLoop:
869	.8bd7		c8		iny		                iny
870	.8bd8		e9 0a		sbc #$0a	                sbc #10
871	.8bda		b0 fb		bcs $8bd7	                bcs tensLoop
872	.8bdc		69 0a		adc #$0a	                adc #10                      ;undo the step too far
873	.8bde		28		plp		                plp                          ;restore leading 0s state
874	.8bdf		20 e4 8b	jsr $8be4	                jsr printDecimalDigit
875	.8be2		18		clc		                clc                      ;definitely not leading 0 now
876	.8be3		a8		tay		                tay
877	.8be4						printDecimalDigit:
878	.8be4		48		pha		                pha
879	.8be5		98		tya		                tya                          ;A=digit index
880	.8be6		d0 02		bne $8bea	                bne +             ;taken if definitely not a leading 0
881	.8be8		b0 04		bcs $8bee	                bcs ++            ;skip the print if a leading 0
882	.8bea						+
883	.8bea		20 73 a8	jsr $a873	                jsr printHexDigit
884	.8bed		18		clc		                clc                          ;clear leading 0 flag
885	.8bee						+
886	.8bee		68		pla		                pla
887	.8bef		60		rts		                rts

889							;-------------------------------------------------------------------------
890							;
891							; Print *CONFIGURE help
892							;
893	.8bf0						printCONFIGUREHelp:
894	.8bf0		20 87 89	jsr $8987	                jsr ensureCommandLineTailEmpty
895	.8bf3		5a		phy		                phy
896	.8bf4		20 58 a9	jsr $a958	                jsr alwaysPrintFollowingMessage
897	>8bf7		43 6f 6e 66 69 67 75 72		                .text "Configuration options:",13
	>8bff		61 74 69 6f 6e 20 6f 70 74 69 6f 6e 73 3a 0d
898							                .if version<400
899	>8c0e		42 61 75 64 20 20 20 20		                .text "Baud     <D>",13
	>8c16		20 3c 44 3e 0d
900							                .endif
901	>8c1b		42 6f 6f 74 0d			                .text "Boot",13
902	>8c20		43 61 70 73 0d			                .text "Caps",13
903							                .if version<400
904	>8c25		44 61 74 61 20 20 20 20		                .text "Data     <D>",13
	>8c2d		20 3c 44 3e 0d
905							                .endif
906	>8c32		44 65 6c 61 79 20 20 20		                .text "Delay    <D>",13
	>8c3a		20 3c 44 3e 0d
907							                .if version<400
908	>8c3f		44 69 72 0d			                .text "Dir",13
909							                .endif
910	>8c43		45 78 54 75 62 65 0d		                .text "ExTube",13
911							                .if version<400
912	>8c4a		46 44 72 69 76 65 20 20		                .text "FDrive   <D>",13
	>8c52		20 3c 44 3e 0d
913							                .endif
914	>8c57		46 69 6c 65 20 20 20 20		                .text "File     <D>",13
	>8c5f		20 3c 44 3e 0d
915							                .if version<400
916	>8c64		46 6c 6f 70 70 79 0d		                .text "Floppy",13
917							                .endif
918							                .if version<400
919	>8c6b		48 61 72 64 0d			                .text "Hard",13
920							                .endif
921	>8c70		49 67 6e 6f 72 65 20 20		                .text "Ignore   [<D>]",13
	>8c78		20 5b 3c 44 3e 5d 0d
922	>8c7f		49 6e 54 75 62 65 0d		                .text "InTube",13
923	>8c86		4c 61 6e 67 20 20 20 20		                .text "Lang     <D>",13
	>8c8e		20 3c 44 3e 0d
924	>8c93		4c 6f 75 64 0d			                .text "Loud",13
925	>8c98		4d 6f 64 65 20 20 20 20		                .text "Mode     <D>",13
	>8ca0		20 3c 44 3e 0d
926	>8ca5		4e 6f 42 6f 6f 74 0d		                .text "NoBoot",13
927	>8cac		4e 6f 43 61 70 73 0d		                .text "NoCaps",13
928							                .if version<400
929	>8cb3		4e 6f 44 69 72 0d		                .text "NoDir",13
930							                .endif
931	>8cb9		4e 6f 53 63 72 6f 6c 6c		                .text "NoScroll",13
	>8cc1		0d
932	>8cc2		4e 6f 54 75 62 65 0d		                .text "NoTube",13
933	>8cc9		50 72 69 6e 74 20 20 20		                .text "Print    <D>",13
	>8cd1		20 3c 44 3e 0d
934	>8cd6		51 75 69 65 74 0d		                .text "Quiet",13
935	>8cdc		52 65 70 65 61 74 20 20		                .text "Repeat   <D>",13
	>8ce4		20 3c 44 3e 0d
936	>8ce9		53 63 72 6f 6c 6c 0d		                .text "Scroll",13
937	>8cf0		53 68 43 61 70 73 0d		                .text "ShCaps",13
938	>8cf7		54 75 62 65 0d			                .text "Tube",13
939	>8cfc		54 56 20 20 20 20 20 20		                .text "TV       [<D>[,<D>]]",13
	>8d04		20 5b 3c 44 3e 5b 2c 3c 44 3e 5d 5d 0d
940	>8d11		00				                .byte 0
941	.8d12		7a		ply		                ply
942	.8d13		a2 28		ldx #$28	                ldx #romServiceCallUnknownCONFIG
943	.8d15		20 72 ee	jsr $ee72	                jsr mos.makeROMServiceCall
944	.8d18		20 58 a9	jsr $a958	                jsr alwaysPrintFollowingMessage
945	>8d1b		57 68 65 72 65 3a 0d		                .text "Where:",13
946	>8d22		44 20 69 73 20 61 20 64		                .text "D is a decimal number, or",13
	>8d2a		65 63 69 6d 61 6c 20 6e 75 6d 62 65 72 2c 20 6f
	>8d3a		72 0d
947	>8d3c		61 20 68 65 78 61 64 65		                .text "a hexadecimal number preceded by &",13
	>8d44		63 69 6d 61 6c 20 6e 75 6d 62 65 72 20 70 72 65
	>8d54		63 65 64 65 64 20 62 79 20 26 0d
948	>8d5f		49 74 65 6d 73 20 77 69		                .text "Items within [ ] are optional",13
	>8d67		74 68 69 6e 20 5b 20 5d 20 61 72 65 20 6f 70 74
	>8d77		69 6f 6e 61 6c 0d
949	>8d7d		00				                .byte $00
950	.8d7e		60		rts		                rts

952							;-------------------------------------------------------------------------
953							;
954							;
955	.8d7f						printSTATUSHelp:
956	.8d7f		20 87 89	jsr $8987	                jsr ensureCommandLineTailEmpty
957	.8d82		5a		phy		                phy

959	.8d83		20 58 a9	jsr $a958	                jsr alwaysPrintFollowingMessage
960	>8d86		43 6f 6e 66 69 67 75 72		                .text "Configuration status:",13
	>8d8e		61 74 69 6f 6e 20 73 74 61 74 75 73 3a 0d
961							                .if version<400
962	>8d9c		42 61 75 64 20 20 20 20		                .text "Baud     ",0
	>8da4		20 00
963	.8da6		20 7d 8b	jsr $8b7d	                jsr printDefaultSerialBaudRateIndex
966							                .endif

968	.8da9		20 e1 8a	jsr $8ae1	                jsr printDefaultAutoBoot

970	.8dac		20 66 8a	jsr $8a66	                jsr printDefaultCaps

972							                .if version<400
973	.8daf		20 58 a9	jsr $a958	                jsr alwaysPrintFollowingMessage
974	>8db2		44 61 74 61 20 20 20 20		                .text "Data     ",0
	>8dba		20 00
975	.8dbc		20 82 8b	jsr $8b82	                jsr printDefaultSerialDataFormat
976							                .endif

978	.8dbf		20 58 a9	jsr $a958	                jsr alwaysPrintFollowingMessage
979	>8dc2		44 65 6c 61 79 20 20 20		                .text "Delay    ",0
	>8dca		20 00
980	.8dcc		20 2e 8b	jsr $8b2e	                jsr printDefaultKeyboardAutoRepeatDelay

982							                .if version<400
983	.8dcf		20 aa 8b	jsr $8baa	                jsr printDefaultADFSLoadDir
984							                .endif

986	.8dd2		20 bb 8a	jsr $8abb	                jsr printDefaultExtTube

988							                .if version<400
989	.8dd5		20 58 a9	jsr $a958	                jsr alwaysPrintFollowingMessage
990	>8dd8		46 44 72 69 76 65 20 20		                .text "FDrive   ",0
	>8de0		20 00
991	.8de2		20 87 8b	jsr $8b87	                jsr printDefaultFDRIVE
992							                .endif

994	.8de5		20 58 a9	jsr $a958	                jsr alwaysPrintFollowingMessage
995	>8de8		46 69 6c 65 20 20 20 20		                .text "File     ",0
	>8df0		20 00
996	.8df2		20 10 8b	jsr $8b10	                jsr printDefaultFSROM

998							                .if version<400
999	.8df5		20 8e 8b	jsr $8b8e	                jsr printDefaultFloppyDrive
1000							                .endif

1002	.8df8		20 62 8b	jsr $8b62	                jsr printDefaultPrinterIgnoreChar2

1004	.8dfb		20 58 a9	jsr $a958	                jsr alwaysPrintFollowingMessage
1005	>8dfe		4c 61 6e 67 20 20 20 20		                .text "Lang     ",0
	>8e06		20 00
1006	.8e08		20 08 8b	jsr $8b08	                jsr printDefaultLanguageROM

1008	.8e0b		20 58 a9	jsr $a958	                jsr alwaysPrintFollowingMessage
1009	>8e0e		4d 6f 64 65 20 20 20 20		                .text "Mode     ",0
	>8e16		20 00
1010	.8e18		20 25 8b	jsr $8b25	                jsr printDefaultMODE

1012	.8e1b		20 f5 8a	jsr $8af5	                jsr printDefaultTubeOn

1014	.8e1e		20 9f 8a	jsr $8a9f	                jsr printDefaultLoud

1016	.8e21		20 58 a9	jsr $a958	                jsr alwaysPrintFollowingMessage
1017	>8e24		50 72 69 6e 74 20 20 20		                .text "Print    "
	>8e2c		20
1018	>8e2d		00				                .byte 0
1019	.8e2e		20 78 8b	jsr $8b78	                jsr printDefaultFX5Settings

1021	.8e31		20 58 a9	jsr $a958	                jsr alwaysPrintFollowingMessage
1022	>8e34		52 65 70 65 61 74 20 20		                .text "Repeat   ",0
	>8e3c		20 00
1023	.8e3e		20 34 8b	jsr $8b34	                jsr printDefaultKeyboardRepeatRate

1025	.8e41		20 89 8a	jsr $8a89	                jsr printDefaultProtectedScrolling

1027	.8e44		20 58 a9	jsr $a958	                jsr alwaysPrintFollowingMessage
1028	>8e47		54 56 20 20 20 20 20 20		                .text "TV       ",0
	>8e4f		20 00
1029	.8e51		20 17 8b	jsr $8b17	                jsr printDefaultTVSettings

1031	.8e54		7a		ply		                ply
1032	.8e55		a2 29		ldx #$29	                ldx #romServiceCallUnknownSTATUS
1033	.8e57		4c 72 ee	jmp $ee72	                jmp mos.makeROMServiceCall


:6	;******  Return to file: src/terminal.s65

937							                .endif

939							;-------------------------------------------------------------------------

941							                .if version>=500
949							                .endif

951							;-------------------------------------------------------------------------

953							                .if version<500&&version!=350
954							;-------------------------------------------------------------------------
955							;
956							; Read default *TV settings.
957							;
958							; exit:
959							;
960							; X = interlace flag (0=off, 1=on)
961							;
962							; Y = *TV offset
963	.8e5a						readDefaultTVSettings:
964	.8e5a		a2 18		ldx #$18	                ldx #CMOSBytes.defaults0+cmosBytesOffset
965	.8e5c		20 b7 98	jsr $98b7	                jsr readRTCByte
966	.8e5f		5a		phy		                phy
967	.8e60		29 e0		and #$e0	                and #%11100000
968	.8e62		0a		asl a		                asl a
969	.8e63		2a		rol a		                rol a
970	.8e64		2a		rol a		                rol a
971	.8e65		2a		rol a		                rol a                        ;move into bottom 3 bits
972	.8e66		89 04		bit #$04	                bit #$04                     ;sign bit?
973	.8e68		f0 02		beq $8e6c	                beq +                        ;taken if positive
974	.8e6a		09 fc		ora #$fc	                ora #%11111100               ;sign extent from bit 2
975	.8e6c						+
976	.8e6c		a8		tay		                tay
977	.8e6d		68		pla		                pla
978	.8e6e		a2 00		ldx #$00	                ldx #$00                     ;X=0 - interlace off
979	.8e70		89 10		bit #$10	                bit #CMOSBytes.defaults0.defaultInterlaceMask
980	.8e72		f0 01		beq $8e75	                beq +
981	.8e74		e8		inx		                inx                          ;X=1 - interlace on
982	.8e75						+
983	.8e75		60		rts		                rts

985							;-------------------------------------------------------------------------
986							;
987							; Read configured MODE
988							; --------------------
989	.8e76						readDefaultMODE:
990	.8e76		a2 18		ldx #$18	                ldx #CMOSBytes.defaults0+cmosBytesOffset
991	.8e78		20 b7 98	jsr $98b7	                jsr readRTCByte
992	.8e7b		29 0f		and #$0f	                and #CMOSBytes.defaults0.defaultMODEMask|CMOSBytes.defaults0.defaultSHADOWMask
993	.8e7d		89 08		bit #$08	                bit #CMOSBytes.defaults0.defaultSHADOWMask
994	.8e7f		f0 02		beq $8e83	                beq +
995	.8e81		49 88		eor #$88	                eor #$80|CMOSBytes.defaults0.defaultSHADOWMask ;reset defaultSHADOWMask bit, set bit 7
996	.8e83						+
997	.8e83		60		rts		                rts

999							;-------------------------------------------------------------------------
1000							;
1001							;
1002							                .if version!=400
1003	.8e84						readDefaultSerialBaudRateIndex:
1004	.8e84		20 aa 98	jsr $98aa	                jsr readDefaults2
1005	.8e87		29 1c		and #$1c	                and #CMOSBytes.defaults2.serialBaudRateIndexMask<<CMOSBytes.defaults2.serialBaudRateIndexShift
1006	.8e89		4a		lsr a		                lsr a
1007	.8e8a		4a		lsr a		                lsr a
1008	.8e8b		1a		inc a		                inc a
1009	.8e8c		60		rts		                rts
1010							                .endif

1012							;-------------------------------------------------------------------------

1014	.8e8d						readDefaultFX5Settings:
1015	.8e8d		20 aa 98	jsr $98aa	                jsr readDefaults2
1016	.8e90						getTop3Bits:
1017	.8e90		29 e0		and #$e0	                and #%11100000               ;? %abc00000
1018	.8e92		0a		asl a		                asl a                        ;a %bc000000
1019	.8e93		2a		rol a		                rol a                        ;b %c000000a
1020	.8e94		2a		rol a		                rol a                        ;c %000000ab
1021	.8e95		2a		rol a		                rol a                        ;0 %00000abc
1022	.8e96		60		rts		                rts

1024							;-------------------------------------------------------------------------
1025							;
1026							;
1027							                .if version!=400
1028	.8e97						readDefaultSerialDataFormat:
1029	.8e97		20 ae 98	jsr $98ae	                jsr readDefaults3
1030	.8e9a		80 f4		bra $8e90	                bra getTop3Bits
1031							                .endif

1033							;-------------------------------------------------------------------------

1035	.8e9c						readDefaultLanguageROM:
1036	.8e9c		20 a4 8e	jsr $8ea4	                jsr readDefaultROMs
1037	.8e9f		4a		lsr a		                lsr a
1038	.8ea0		4a		lsr a		                lsr a
1039	.8ea1		4a		lsr a		                lsr a
1040	.8ea2		4a		lsr a		                lsr a
1041	.8ea3		60		rts		                rts

1043							;-------------------------------------------------------------------------
1044							;
1045							;
1046	.8ea4						readDefaultROMs:
1047	.8ea4		a2 13		ldx #$13	                ldx #CMOSBytes.defaultROMs+cmosBytesOffset;
1048	.8ea6		80 02		bra $8eaa	                bra jmpReadRTCByte

1050							;-------------------------------------------------------------------------

1052	.8ea8						readDefaultPrinterIgnoreChar:
1053	.8ea8		a2 1c		ldx #$1c	                ldx #CMOSBytes.printerIgnoreChar+cmosBytesOffset
1054	.8eaa						jmpReadRTCByte:
1055	.8eaa		4c b7 98	jmp $98b7	                jmp readRTCByte

1057							;-------------------------------------------------------------------------

1059	.8ead						readDefaults1:
1060	.8ead		a2 19		ldx #$19	                ldx #CMOSBytes.defaults1+cmosBytesOffset
1061	.8eaf		80 f9		bra $8eaa	                bra jmpReadRTCByte

1063							;-------------------------------------------------------------------------

1065	.8eb1						printNo_:
1066	.8eb1		20 58 a9	jsr $a958	                jsr alwaysPrintFollowingMessage
1067	>8eb4		4e 6f 20 00			                .text "No ",0
1068	.8eb8		60		rts		                rts

1070							;-------------------------------------------------------------------------
1071							                .endif

1073							;-------------------------------------------------------------------------
1074							;
1075							; [MasRef G.5-8]
1076							;
1077	.8eb9						starPRINT:
1078	.8eb9		a9 c0		lda #$c0	                lda #$C0
1079	.8ebb		8d c2 df	sta $dfc2	                sta hazel.fsFlags
1080	.8ebe		80 12		bra $8ed2	                bra L8ED2

1082							;-------------------------------------------------------------------------

1084	.8ec0						starLIST:
1085	.8ec0		4e c2 df	lsr $dfc2	                lsr hazel.fsFlags
1086	.8ec3		9c c3 df	stz $dfc3	                stz hazel.lineNumberBCD+0
1087	.8ec6		9c c4 df	stz $dfc4	                stz hazel.lineNumberBCD+1
1088	.8ec9		80 04		bra $8ecf	                bra L8ECF

1090							;-------------------------------------------------------------------------

1092	.8ecb						starTYPE:
1093	.8ecb		38		sec		                sec
1094	.8ecc		6e c2 df	ror $dfc2	                ror hazel.fsFlags
1095	.8ecf						L8ECF:
1096	.8ecf		4e c2 df	lsr $dfc2	                lsr hazel.fsFlags
1097	.8ed2						L8ED2:
1098	.8ed2		9c c5 df	stz $dfc5	                stz hazel.lastCharPrinted
1099	.8ed5		20 45 a5	jsr $a545	                jsr openFileForReading
1100	.8ed8						L8ED8:
1101	.8ed8		24 ff		bit $ff		                bit $FF
1102	.8eda		30 52		bmi $8f2e	                bmi handleESCAPEWithFileOpen
1103	.8edc		20 d7 ff	jsr $ffd7	                jsr OSBGET
1104	.8edf		b0 2e		bcs $8f0f	                bcs closeFile
1105	.8ee1		2c c2 df	bit $dfc2	                bit hazel.fsFlags
1106	.8ee4		70 05		bvs $8eeb	                bvs L8EEB
1107	.8ee6		48		pha		                pha
1108	.8ee7		20 eb 91	jsr $91eb	                jsr printLineNumber
1109	.8eea		68		pla		                pla
1110	.8eeb						L8EEB:
1111	.8eeb		2c c2 df	bit $dfc2	                bit hazel.fsFlags
1112	.8eee		30 14		bmi $8f04	                bmi L8F04
1113	.8ef0		c9 0d		cmp #$0d	                cmp #$0D
1114	.8ef2		f0 20		beq $8f14	                beq L8F14
1115	.8ef4		c9 0a		cmp #$0a	                cmp #$0A
1116	.8ef6		f0 1c		beq $8f14	                beq L8F14
1117	.8ef8		8d c5 df	sta $dfc5	                sta hazel.lastCharPrinted
1118	.8efb		c9 22		cmp #$22	                cmp #'"'
1119	.8efd		f0 05		beq $8f04	                beq L8F04
1120	.8eff		20 06 96	jsr $9606	                jsr printGSREADChar
1121	.8f02		80 03		bra $8f07	                bra L8F07

1123	.8f04						L8F04:
1124	.8f04		20 ee ff	jsr $ffee	                jsr OSWRCH
1125	.8f07						L8F07:
1126	.8f07		20 3a 8f	jsr $8f3a	                jsr bgetAndCheckForESCAPE
1127	.8f0a		90 df		bcc $8eeb	                bcc L8EEB
1128	.8f0c						printNewLineThenCloseFile:
1129	.8f0c		20 e7 ff	jsr $ffe7	                jsr OSNEWL
1130	.8f0f						closeFile:
1131	.8f0f		a9 00		lda #$00	                lda #$00
1132	.8f11		4c ce ff	jmp $ffce	                jmp OSFIND

1134	.8f14						L8F14:
1135	.8f14		cd c5 df	cmp $dfc5	                cmp hazel.lastCharPrinted
1136	.8f17		f0 10		beq $8f29	                beq L8F29
1137	.8f19		48		pha		                pha
1138	.8f1a		ad c5 df	lda $dfc5	                lda hazel.lastCharPrinted
1139	.8f1d		c9 0d		cmp #$0d	                cmp #$0D
1140	.8f1f		f0 13		beq $8f34	                beq L8F34
1141	.8f21		c9 0a		cmp #$0a	                cmp #$0A
1142	.8f23		f0 0f		beq $8f34	                beq L8F34
1143	.8f25		68		pla		                pla
1144	.8f26		8d c5 df	sta $dfc5	                sta hazel.lastCharPrinted
1145	.8f29						L8F29:
1146	.8f29		20 e7 ff	jsr $ffe7	                jsr OSNEWL
1147	.8f2c		80 aa		bra $8ed8	                bra L8ED8

1149							;-------------------------------------------------------------------------
1150							;
1151							; Tidily handle ESCAPE when a file is open during *DUMP or whatever.
1152							; Prints a new line, closes the file, then does an Escape error.
1153							;
1154							; entry:
1155							;
1156							; Y = file handle
1157							;
1158	.8f2e						handleESCAPEWithFileOpen:
1159	.8f2e		20 0c 8f	jsr $8f0c	                jsr printNewLineThenCloseFile
1160	.8f31		4c 91 a8	jmp $a891	                jmp escapeError

1162							;-------------------------------------------------------------------------

1164	.8f34						L8F34:
1165	.8f34		68		pla		                pla
1166	.8f35		9c c5 df	stz $dfc5	                stz hazel.lastCharPrinted
1167	.8f38		80 cd		bra $8f07	                bra L8F07

1169							;-------------------------------------------------------------------------
1170							;
1171							; Does an OSBGET and handles ESCAPE.
1172							;
1173							; entry:
1174							;
1175							; Y = file handle
1176							;
1177							; exit:
1178							;
1179							; A = byte read
1180							; C=1 if EOF
1181							; (as per OSBGET)
1182							;
1183	.8f3a						bgetAndCheckForESCAPE:
1184	.8f3a		20 d7 ff	jsr $ffd7	                jsr OSBGET
1185	.8f3d		24 ff		bit $ff		                bit $FF
1186	.8f3f		30 ed		bmi $8f2e	                bmi handleESCAPEWithFileOpen
1187	.8f41		60		rts		                rts

1189							;-------------------------------------------------------------------------
1190							;
1191							; *DUMP [MasRef G.5-4]
1192							;
1193	.8f42						starDUMP:
1194	.8f42		86 f2		stx $f2		                stx stringInputBufferAddress+0
1195	.8f44		84 f3		sty $f3		                sty stringInputBufferAddress+1
1196	.8f46		a2 00		ldx #$00	                ldx #$00
1197	.8f48		20 bc 92	jsr $92bc	                jsr clearOSFILEParameterBlockDWORD
1198	.8f4b		a2 04		ldx #$04	                ldx #$04
1199	.8f4d		20 bc 92	jsr $92bc	                jsr clearOSFILEParameterBlockDWORD
1200	.8f50		a0 00		ldy #$00	                ldy #$00
1201	.8f52		4e c6 df	lsr $dfc6	                lsr hazel.tempFSFlag
1202	.8f55		20 6d f2	jsr $f26d	                jsr mos.gsinitForFilenameParsing
1203	.8f58						L8F58:
1204	.8f58		20 7f f2	jsr $f27f	                jsr mos.gsreadEntryPoint
1205	.8f5b		90 fb		bcc $8f58	                bcc L8F58
1206	.8f5d		f0 1a		beq $8f79	                beq L8F79
1207	.8f5f		a2 00		ldx #$00	                ldx #$00
1208	.8f61		20 5b 93	jsr $935b	                jsr parseHexAddressFromCommandLine

1210	.8f64		a2 03		ldx #$03	                ldx #$03
1211	.8f66						-
1212	.8f66		bd ed 02	lda $02ed,x	                lda osfileParameterBlock+0,x
1213	.8f69		9d f1 02	sta $02f1,x	                sta osfileParameterBlock+4,x
1214	.8f6c		ca		dex		                dex
1215	.8f6d		10 f7		bpl $8f66	                bpl -

1217	.8f6f		20 ff f2	jsr $f2ff	                jsr mos.skipSpacesAndCheckForCRInStringInput
1218	.8f72		f0 05		beq $8f79	                beq L8F79
1219	.8f74		a2 04		ldx #$04	                ldx #$04
1220	.8f76		20 5b 93	jsr $935b	                jsr parseHexAddressFromCommandLine
1221	.8f79						L8F79:
1222	.8f79		a4 f3		ldy $f3		                ldy stringInputBufferAddress+1
1223	.8f7b		a6 f2		ldx $f2		                ldx stringInputBufferAddress+0
1224	.8f7d		0e c6 df	asl $dfc6	                asl hazel.tempFSFlag
1225	.8f80		20 45 a5	jsr $a545	                jsr openFileForReading

1227	.8f83		a9 02		lda #$02	                lda #argsFileGetEXT
1228	.8f85		20 61 94	jsr $9461	                jsr callOSARGSWithBuffer

1230	.8f88		a2 03		ldx #$03	                ldx #$03
1231	.8f8a						L8F8A:
1232	.8f8a		b5 a8		lda $a8,x	                lda osargsBuffer,x
1233	.8f8c		dd ed 02	cmp $02ed,x	                cmp osfileParameterBlock+0,x
1234	.8f8f		90 6a		bcc $8ffb	                bcc L8FFB
1235	.8f91		d0 03		bne $8f96	                bne L8F96
1236	.8f93		ca		dex		                dex
1237	.8f94		10 f4		bpl $8f8a	                bpl L8F8A
1238	.8f96						L8F96:
1239	.8f96		a2 03		ldx #$03	                ldx #$03
1240	.8f98						-
1241	.8f98		bd ed 02	lda $02ed,x	                lda osfileParameterBlock+0,x
1242	.8f9b		95 a8		sta $a8,x	                sta osargsBuffer,x
1243	.8f9d		ca		dex		                dex
1244	.8f9e		10 f8		bpl $8f98	                bpl -
1245	.8fa0		20 5f 94	jsr $945f	                jsr setFilePointerFromOSARGSBuffer
1246	.8fa3						L8FA3:
1247	.8fa3		a2 00		ldx #$00	                ldx #$00
1248	.8fa5		20 d7 ff	jsr $ffd7	                jsr OSBGET
1249	.8fa8		b0 46		bcs $8ff0	                bcs L8FF0
1250	.8faa		20 39 92	jsr $9239	                jsr L9239
1251	.8fad		48		pha		                pha
1252	.8fae		ad f1 02	lda $02f1	                lda osfileParameterBlock+4
1253	.8fb1		29 07		and #$07	                and #$07
1254	.8fb3		f0 15		beq $8fca	                beq L8FCA
1255	.8fb5		5a		phy		                phy
1256	.8fb6		a8		tay		                tay
1257	.8fb7						L8FB7:
1258	.8fb7		5a		phy		                phy
1259	.8fb8		20 58 a9	jsr $a958	                jsr alwaysPrintFollowingMessage
1260	>8fbb		20 20 20 00			                .text "   ",0
1261	.8fbf		7a		ply		                ply
1262	.8fc0		a9 20		lda #$20	                lda #$20
1263	.8fc2		9d f5 02	sta $02f5,x	                sta osfileParameterBlock+8,x
1264	.8fc5		e8		inx		                inx
1265	.8fc6		88		dey		                dey
1266	.8fc7		d0 ee		bne $8fb7	                bne L8FB7
1267	.8fc9		7a		ply		                ply
1268	.8fca						L8FCA:
1269	.8fca		68		pla		                pla
1270	.8fcb						L8FCB:
1271	.8fcb		48		pha		                pha
1272	.8fcc		c9 20		cmp #$20	                cmp #32
1273	.8fce		90 04		bcc $8fd4	                bcc nonPrintable
1274	.8fd0		c9 7f		cmp #$7f	                cmp #127
1275	.8fd2		90 02		bcc $8fd6	                bcc L8FD6                    ;taken if printable
1276	.8fd4						nonPrintable:
1277	.8fd4		a9 2e		lda #$2e	                lda #'.'          ;placeholder for non-printable chars
1278	.8fd6						L8FD6:
1279	.8fd6		9d f5 02	sta $02f5,x	                sta osfileParameterBlock+8,x
1280	.8fd9		68		pla		                pla
1281	.8fda		20 65 a8	jsr $a865	                jsr printSpaceThenPrintHexByte
1282	.8fdd		e8		inx		                inx
1283	.8fde		20 48 92	jsr $9248	                jsr L9248
1284	.8fe1		ad f1 02	lda $02f1	                lda osfileParameterBlock+4
1285	.8fe4		29 07		and #$07	                and #$07
1286	.8fe6		f0 0b		beq $8ff3	                beq L8FF3
1287	.8fe8		20 3a 8f	jsr $8f3a	                jsr bgetAndCheckForESCAPE
1288	.8feb		90 de		bcc $8fcb	                bcc L8FCB
1289	.8fed		20 57 92	jsr $9257	                jsr L9257
1290	.8ff0						L8FF0:
1291	.8ff0		4c 0f 8f	jmp $8f0f	                jmp closeFile

1293	.8ff3						L8FF3:
1294	.8ff3		20 57 92	jsr $9257	                jsr L9257
1295	.8ff6		80 ab		bra $8fa3	                bra L8FA3

1297	.8ff8						L8FF8:
1298	.8ff8		4c 4d a5	jmp $a54d	                jmp notFoundError

1300	.8ffb						L8FFB:
1301	.8ffb		20 0f 8f	jsr $8f0f	                jsr closeFile
1302	.8ffe		20 ed aa	jsr $aaed	                jsr doFollowingError
1303	>9001		b7 4f 75 74 73 69 64 65		                .text $b7,"Outside file",0
	>9009		20 66 69 6c 65 00

1305							;-------------------------------------------------------------------------
1306							;
1307							; *BUILD
1308							;
1309	.900f						starBUILD:
1310	.900f		4e c2 df	lsr $dfc2	                lsr hazel.fsFlags            ;clear bit 7 of fsFlags
1311	.9012		80 04		bra $9018	                bra starBUILDOrAPPEND

1313							;-------------------------------------------------------------------------
1314							;
1315							; *APPEND
1316							;
1317	.9014						starAPPEND:
1318	.9014		38		sec		                sec
1319	.9015		6e c2 df	ror $dfc2	                ror hazel.fsFlags            ;set bit 7 of fsFlags
1320	.9018						starBUILDOrAPPEND:
1321							                ; bit 7 of fsFlags indicates *BUILD (clear) or *APPEND
1322							                ; (set).
1323	.9018		9c c3 df	stz $dfc3	                stz hazel.lineNumberBCD+0    ;reset line number
1324	.901b		9c c4 df	stz $dfc4	                stz hazel.lineNumberBCD+1    ;reset line number
1325	.901e		a9 80		lda #$80	                lda #$80                     ;open for output. Assume *BUILD
1326	.9020		2c c2 df	bit $dfc2	                bit hazel.fsFlags            ;test *BUILD/*APPEND
1327	.9023		10 02		bpl $9027	                bpl +                        ;branch taken if *BUILD
1328	.9025		a9 c0		lda #$c0	                lda #$C0                     ;*APPEND, so open for update
1329	.9027						+
1330	.9027		20 ce ff	jsr $ffce	                jsr OSFIND                   ;open the file
1331	.902a		a8		tay		                tay                          ;Y=file handle
1332	.902b		f0 cb		beq $8ff8	                beq L8FF8                    ;branch taken if open failed
1333	.902d		8c ed 02	sty $02ed	                sty osfileParameterBlock+0   ;save file handle
1334	.9030		20 5a 94	jsr $945a	                jsr setPTRToEOF ;move to EOF (effective no-op when *BUILD)
1335	.9033						L9033:
1336	.9033		20 eb 91	jsr $91eb	                jsr printLineNumber
1337	.9036						L9036:
1338							                .if version<500&&version!=350
1339	.9036		20 9d 86	jsr $869d	                jsr readCommandLine
1345							                .endif
1346	.9039		08		php		                php
1347	.903a		90 0f		bcc $904b	                bcc L904B
1348							                ; Handle ESCAPE
1349	.903c		20 e7 ff	jsr $ffe7	                jsr OSNEWL
1350	.903f		a9 0d		lda #$0d	                lda #$0D
1351	.9041		99 00 dc	sta $dc00,y	                sta hazel.commandLine,y      ;terminate current line
1352	.9044						L9044:
1353	.9044		5a		phy		                phy                          ;save line length
1354	.9045		a9 7e		lda #$7e	                lda #$7E
1355	.9047		20 f4 ff	jsr $fff4	                jsr OSBYTE                   ;acknowledge ESCAPE
1356	.904a		7a		ply		                ply                          ;restore line length
1357	.904b						L904B:
1358	.904b		98		tya		                tya                          ;A=line length
1359	.904c		f0 50		beq $909e	                beq L909E                    ;taken if line empty
1360	.904e		20 ab 90	jsr $90ab	                jsr setStringInputBufferToCommandLine
1361	.9051		a0 00		ldy #$00	                ldy #$00
1362	.9053		a2 00		ldx #$00	                ldx #$00
1363	.9055						L9055:
1364	.9055		20 9c f2	jsr $f29c	                jsr mos.LF29C
1365	.9058		9d 00 dc	sta $dc00,x	                sta hazel.commandLine,x
1366	.905b		a9 01		lda #$01	                lda #stringInputOptions.goodString
1367	.905d		24 e4		bit $e4		                bit stringInputOptions
1368	.905f		d0 0b		bne $906c	                bne L906C
1369	.9061		a9 07		lda #$07	                lda #7
1370	.9063		20 ee ff	jsr $ffee	                jsr OSWRCH                   ;beep
1371	.9066		20 f5 91	jsr $91f5	                jsr L91F5
1372	.9069		28		plp		                plp
1373	.906a		80 ca		bra $9036	                bra L9036

1375	.906c						L906C:
1376	.906c		e8		inx		                inx
1377	.906d		90 e6		bcc $9055	                bcc L9055
1378	.906f		28		plp		                plp
1379	.9070		90 01		bcc $9073	                bcc L9073
1380	.9072		ca		dex		                dex
1381	.9073						L9073:
1382	.9073		08		php		                php
1383	.9074		da		phx		                phx
1384	.9075		a2 0b		ldx #$0b	                ldx #size(OSGBPBParameterBlock)-2
1385	.9077						L9077:
1386	.9077		9e ee 02	stz $02ee,x	                stz osfileParameterBlock+1,x
1387	.907a		ca		dex		                dex
1388	.907b		10 fa		bpl $9077	                bpl L9077
1389	.907d		fa		plx		                plx
1390	.907e		8e f2 02	stx $02f2	                stx osfileParameterBlock+OSGBPBParameterBlock.count+0
1391							                .cerror (<hazel.commandLine)!=0,"hazel.commandLine must be page aligned"
1392	.9081		a9 dc		lda #$dc	                lda #>hazel.commandLine
1393	.9083		8d ef 02	sta $02ef	                sta osfileParameterBlock+OSGBPBParameterBlock.address+1
1394	.9086		ce f0 02	dec $02f0	                dec osfileParameterBlock+OSGBPBParameterBlock.address+2
1395	.9089		ce f1 02	dec $02f1	                dec osfileParameterBlock+OSGBPBParameterBlock.address+3
1396	.908c		a9 02		lda #$02	                lda #gbppPutBytesCurrentPTR
1397	.908e		a2 ed		ldx #$ed	                ldx #<osfileParameterBlock
1398	.9090		a0 02		ldy #$02	                ldy #>osfileParameterBlock
1399	.9092		20 d1 ff	jsr $ffd1	                jsr OSGBPB
1400	.9095		28		plp		                plp
1401	.9096		90 9b		bcc $9033	                bcc L9033
1402	.9098						L9098:
1403	.9098		ac ed 02	ldy $02ed	                ldy osfileParameterBlock+0
1404	.909b		4c 0f 8f	jmp $8f0f	                jmp closeFile

1406	.909e						L909E:
1407	.909e		28		plp		                plp
1408	.909f		b0 f7		bcs $9098	                bcs L9098
1409	.90a1		a9 0d		lda #$0d	                lda #13
1410	.90a3		ac ed 02	ldy $02ed	                ldy osfileParameterBlock
1411	.90a6		20 d4 ff	jsr $ffd4	                jsr OSBPUT
1412	.90a9		80 88		bra $9033	                bra L9033

1414	.90ab						setStringInputBufferToCommandLine:
1415	.90ab		a9 41		lda #$41	                lda #$41
1416	.90ad		85 e4		sta $e4		                sta $E4
1417							                .cerror (<hazel.commandLine)!=0,"hazel.commandLine must be page aligned"
1418	.90af		64 f2		stz $f2		                stz stringInputBufferAddress+0
1419	.90b1		a9 dc		lda #$dc	                lda #>hazel.commandLine
1420	.90b3		85 f3		sta $f3		                sta stringInputBufferAddress+1
1421	.90b5		60		rts		                rts

1423							;-------------------------------------------------------------------------

1425							                .if version>=500||version==350
1431							                .endif

1433							;-------------------------------------------------------------------------
1434							;
1435							; *MOVE
1436							;
1437	.90b6						starMOVE:
1438	.90b6		ad 34 fe	lda $fe34	                lda ACCCON                    ; Save ACCCON
1439	.90b9		8d dc df	sta $dfdc	                sta hazel.oldACCCON
1440	.90bc		48		pha		                pha                          ; Save ACCCON and command line pointer
1441	.90bd		da		phx		                phx
1442	.90be		5a		phy		                phy
1443	.90bf		a0 80		ldy #$80	                ldy #$80                     ; Top of available shadow memory at &8000
1444	.90c1		a5 d0		lda $d0		                lda STATE                      ; Get VDU status
1445	.90c3		89 10		bit #$10	                bit #$10                     ; Jump if not shadow screen, spare up to &8000
1446	.90c5		f0 07		beq $90ce	                beq L90CE
1447							; Shadow screen selected
1448	.90c7		20 c0 f1	jsr $f1c0	                jsr mos.LF1C0                ; Get screen bottom to XY
1449	.90ca		c0 30		cpy #$30	                cpy #$30                     ; Screen at &3000, no spare memory, jump to use Hazel
1450	.90cc		f0 14		beq $90e2	                beq L90E2

1452							; Non-shadow or small shadow screen selected
1453							; Y=top of available memory in shadow memory
1454	.90ce						L90CE:
1455	.90ce		a9 30		lda #$30	                lda #$30                     ; &3000=start of shadow memory
1456	.90d0		8d d6 df	sta $dfd6	                sta hazel.moveBufferMSB
1457	.90d3		a9 04		lda #$04	                lda #ACCCON.X
1458	.90d5		0c 34 fe	tsb $fe34	                tsb ACCCON
1459	.90d8		8d dd df	sta $dfdd	                sta hazel.hasACCCONChanged      ; set 'ACCCON changed'
1460	.90db		98		tya		                tya                          ; A=length of space in shadow memory
1461	.90dc		38		sec		                sec
1462	.90dd		ed d6 df	sbc $dfd6	                sbc hazel.moveBufferMSB
1463	.90e0		80 07		bra $90e9	                bra L90E9

1465							; No shadow memory available, use Hazel
1466	.90e2						L90E2:
1467	.90e2		a9 dd		lda #$dd	                lda #$DD                     ; Buffer at &DD00
1468	.90e4		8d d6 df	sta $dfd6	                sta hazel.moveBufferMSB
1469	.90e7		a9 02		lda #$02	                lda #$02                     ; Buffer length=&200

1471							; &DFD6=high byte of buffer address
1472							; A=high byte of buffer length
1473	.90e9						L90E9:
1474	.90e9		8d d7 df	sta $dfd7	                sta hazel.moveNumPages      ; Store buffer length
1475	.90ec		7a		ply		                ply                          ; Get command line pointer
1476	.90ed		fa		plx		                plx
1477	.90ee		da		phx		                phx
1478	.90ef		5a		phy		                phy
1479	.90f0		a9 40		lda #$40	                lda #$40                     ; Open source file
1480	.90f2		20 ce ff	jsr $ffce	                jsr OSFIND
1481	.90f5		a8		tay		                tay                          ; Store source handle, jump if not found
1482	.90f6		8c d4 df	sty $dfd4	                sty hazel.moveSrcHandle
1483	.90f9		f0 39		beq $9134	                beq L9134
1484	.90fb		7a		ply		                ply                          ; Get command line back again
1485	.90fc		fa		plx		                plx
1486	.90fd		86 f2		stx $f2		                stx $F2
1487	.90ff		84 f3		sty $f3		                sty $F3
1488	.9101		da		phx		                phx                          ; And save it again
1489	.9102		5a		phy		                phy
1490	.9103		a0 00		ldy #$00	                ldy #$00                     ; Step past first parameter
1491	.9105		20 6d f2	jsr $f26d	                jsr mos.gsinitForFilenameParsing
1492	.9108						L9108:
1493	.9108		20 7f f2	jsr $f27f	                jsr mos.gsreadEntryPoint     ;
1494	.910b		90 fb		bcc $9108	                bcc L9108
1495	.910d		98		tya		                tya                          ; Save address of dest filename
1496	.910e		18		clc		                clc
1497	.910f		65 f2		adc $f2		                adc $F2
1498	.9111		8d d8 df	sta $dfd8	                sta hazel.moveDestName+0
1499	.9114		aa		tax		                tax
1500	.9115		a5 f3		lda $f3		                lda $F3
1501	.9117		69 00		adc #$00	                adc #$00
1502	.9119		8d d9 df	sta $dfd9	                sta hazel.moveDestName+1
1503	.911c		a8		tay		                tay                          ; Temporary filing system flag
1504	.911d		0e c6 df	asl $dfc6	                asl hazel.tempFSFlag
1505	.9120		a9 80		lda #$80	                lda #$80                     ; Open destination file
1506	.9122		20 ce ff	jsr $ffce	                jsr OSFIND
1507	.9125		a8		tay		                tay                          ; Store dest handle, jump if opened
1508	.9126		8c d5 df	sty $dfd5	                sty hazel.moveDestHandle
1509	.9129		d0 0c		bne $9137	                bne L9137

1511							; Couldn't open destination
1512	.912b		ac d4 df	ldy $dfd4	                ldy hazel.moveSrcHandle      ; Get source handle and clear it
1513	.912e		9c d4 df	stz $dfd4	                stz hazel.moveSrcHandle
1514	.9131		20 ce ff	jsr $ffce	                jsr OSFIND                   ; Close source file
1515	.9134						L9134:
1516	.9134		4c 4d a5	jmp $a54d	                jmp notFoundError                    ; Jump to 'Not found' error

1518							; Source and dest opened
1519							; ----------------------
1520							; Build OSGBPB source file control block at &02ED
1521							; and destination control block at &DFC7
1522	.9137						L9137:
1523	.9137		a2 07		ldx #$07	                ldx #$07
1524	.9139						L9139:
1525	.9139		9e ee 02	stz $02ee,x	                stz @w osfileParameterBlock+OSGBPBParameterBlock.address,x ; Addr=0, Num=0
1526	.913c		9e c8 df	stz $dfc8,x	                stz hazel.moveOSGBPB+1,x
1527	.913f		ca		dex		                dex
1528	.9140		10 f7		bpl $9139	                bpl L9139
1529	.9142		ad d4 df	lda $dfd4	                lda hazel.moveSrcHandle      ; Source handle
1530	.9145		8d ed 02	sta $02ed	                sta osfileParameterBlock+OSGBPBParameterBlock.handle
1531	.9148		ad d6 df	lda $dfd6	                lda hazel.moveBufferMSB      ; Buffer address
1532	.914b		8d ef 02	sta $02ef	                sta osfileParameterBlock+OSGBPBParameterBlock.address+1
1533	.914e		8d c9 df	sta $dfc9	                sta hazel.moveOSGBPB.addr+1
1534	.9151		ad d7 df	lda $dfd7	                lda hazel.moveNumPages
1535	.9154		8d f3 02	sta $02f3	                sta osfileParameterBlock+OSGBPBParameterBlock.count+1
1536	.9157		8d cd df	sta $dfcd	                sta hazel.moveOSGBPB.numBytes+1
1537	.915a		ce f0 02	dec $02f0	                dec osfileParameterBlock+OSGBPBParameterBlock.address+2 ; Source addr=&FFFFxxxx
1538	.915d		ce f1 02	dec $02f1	                dec osfileParameterBlock+OSGBPBParameterBlock.address+3
1539	.9160		ce ca df	dec $dfca	                dec hazel.moveOSGBPB.addr+2
1540	.9163		ce cb df	dec $dfcb	                dec hazel.moveOSGBPB.addr+3

1542							; Should use &FFFExxxx and let filing system select correct memory
1543							; Unfortunately, CFS/RFS and DFS do not recognise &FFFExxxx, so
1544							; *MOVE has to do it itself, causing problems for filing systems
1545							; that /do/ recognise &FFFExxxx where they have to remember to
1546							; *do* *nothing* for &FFFFxxxx instead of select main memory as
1547							; &FFFFxxxx implies.

1549	.9166		a2 ed		ldx #$ed	                ldx #<osfileParameterBlock                     ; XY=>source OSGBPB block
1550	.9168		a0 02		ldy #$02	                ldy #>osfileParameterBlock
1551	.916a		a9 04		lda #$04	                lda #$04                     ; Read data from source
1552	.916c		20 d1 ff	jsr $ffd1	                jsr OSGBPB
1553	.916f		08		php		                php                          ; Jump if not at end of file
1554	.9170		90 11		bcc $9183	                bcc L9183
1555							; End of file, adjust destination buffer length for final part
1556	.9172		a9 00		lda #$00	                lda #$00
1557	.9174		ed f2 02	sbc $02f2	                sbc osfileParameterBlock+OSGBPBParameterBlock.count+0
1558	.9177		8d cc df	sta $dfcc	                sta hazel.moveOSGBPB.numBytes+0
1559	.917a		ad cd df	lda $dfcd	                lda hazel.moveOSGBPB.numBytes+1
1560	.917d		ed f3 02	sbc $02f3	                sbc osfileParameterBlock+OSGBPBParameterBlock.count+1
1561	.9180		8d cd df	sta $dfcd	                sta hazel.moveOSGBPB.numBytes+1
1562	.9183						L9183:
1563	.9183		ad d5 df	lda $dfd5	                lda hazel.moveDestHandle      ; Destination handle
1564	.9186		8d c7 df	sta $dfc7	                sta hazel.moveOSGBPB.handle
1565	.9189		a9 02		lda #$02	                lda #$02                     ; XY=>control block, A=write
1566	.918b		a2 c7		ldx #$c7	                ldx #<hazel.moveOSGBPB
1567	.918d		a0 df		ldy #$df	                ldy #>hazel.moveOSGBPB
1568	.918f		20 d1 ff	jsr $ffd1	                jsr OSGBPB
1569	.9192		28		plp		                plp                          ; Loop until end of file
1570	.9193		90 a2		bcc $9137	                bcc L9137
1571	.9195		a9 00		lda #$00	                lda #$00
1572	.9197		ac d4 df	ldy $dfd4	                ldy hazel.moveSrcHandle      ; Get and clear source handle
1573	.919a		9c d4 df	stz $dfd4	                stz hazel.moveSrcHandle
1574	.919d		5a		phy		                phy                          ; Close source file
1575	.919e		20 ce ff	jsr $ffce	                jsr OSFIND
1576	.91a1		a9 00		lda #$00	                lda #$00                     ; Get dest handle
1577	.91a3		ac d5 df	ldy $dfd5	                ldy hazel.moveDestHandle
1578	.91a6		5a		phy		                phy                          ; Clear dest handle and close file
1579	.91a7		9c d5 df	stz $dfd5	                stz hazel.moveDestHandle
1580	.91aa		20 ce ff	jsr $ffce	                jsr OSFIND
1581	.91ad		7a		ply		                ply                          ; Dest not CFS/RFS, jump to...
1582	.91ae		c0 04		cpy #$04	                cpy #$04
1583	.91b0		b0 0b		bcs $91bd	                bcs L91BD
1584	.91b2		7a		ply		                ply                          ; Pop source handle
1585	.91b3						L91B3:
1586	.91b3		7a		ply		                ply                          ; Restore XY
1587	.91b4		fa		plx		                plx
1588	.91b5						L91B5:
1589	.91b5		68		pla		                pla                          ; Clear 'ACCCON changed', restore ACCCON
1590	.91b6		9c dd df	stz $dfdd	                stz hazel.hasACCCONChanged
1591	.91b9		8d 34 fe	sta $fe34	                sta ACCCON
1592	.91bc		60		rts		                rts

1594	.91bd						L91BD:
1595	.91bd		7a		ply		                ply                          ; Source was CFS/RFS, jump to exit
1596	.91be		c0 04		cpy #$04	                cpy #$04
1597	.91c0		90 f1		bcc $91b3	                bcc L91B3
1598	.91c2		7a		ply		                ply                          ; Point to first parameter
1599	.91c3		8c ee 02	sty $02ee	                sty osfileParameterBlock+OSFILEParameterBlock.fileName+1
1600	.91c6		fa		plx		                plx
1601	.91c7		8e ed 02	stx $02ed	                stx osfileParameterBlock+OSFILEParameterBlock.fileName+0
1602	.91ca		a2 ed		ldx #$ed	                ldx #<osfileParameterBlock
1603	.91cc		a0 02		ldy #$02	                ldy #>osfileParameterBlock
1604	.91ce		a9 05		lda #$05	                lda #$05                     ; Read info on source file
1605	.91d0		20 dd ff	jsr $ffdd	                jsr OSFILE
1606	.91d3		ad d8 df	lda $dfd8	                lda hazel.moveDestName+0      ; Get address of dest filename
1607	.91d6		8d ed 02	sta $02ed	                sta osfileParameterBlock+OSFILEParameterBlock.fileName+0
1608	.91d9		ad d9 df	lda $dfd9	                lda hazel.moveDestName+1      ;  and put in control block
1609	.91dc		8d ee 02	sta $02ee	                sta osfileParameterBlock+OSFILEParameterBlock.fileName+1
1610	.91df		a9 f0		lda #$f0	                lda #$F0                     ; Mask out 'public' access bits
1611	.91e1		1c fb 02	trb $02fb	                trb osfileParameterBlock+OSFILEParameterBlock.attributes+0
1612	.91e4		a9 01		lda #$01	                lda #$01                     ; Write info on dest file
1613	.91e6		20 dd ff	jsr $ffdd	                jsr OSFILE
1614	.91e9		80 ca		bra $91b5	                bra L91B5                    ; Jump to restore ACCCON and exit

1616	.91eb						printLineNumber:
1617	.91eb		a2 00		ldx #$00	                ldx #$00
1618	.91ed		38		sec		                sec
1619	.91ee		20 2e 92	jsr $922e	                jsr adcLineNumberBCDX        ;increment line number LSB
1620	.91f1		e8		inx		                inx
1621	.91f2		20 2e 92	jsr $922e	                jsr adcLineNumberBCDX        ;carry into line number MSB
1622	.91f5						L91F5:
1623	.91f5		38		sec		                sec                          ;printing leading 0s
1624	.91f6		ad c4 df	lda $dfc4	                lda hazel.lineNumberBCD+1    ;get line number MSB
1625	.91f9		20 11 92	jsr $9211	                jsr printPossiblyLeading0s
1626	.91fc		ad c3 df	lda $dfc3	                lda hazel.lineNumberBCD+0    ;get line number LSB
1627	.91ff		48		pha		                pha                          ;save line number LSB
1628	.9200		08		php		                php                          ;save C
1629							                .if version==350
1631							                .else
1632	.9201		4a		lsr a		                lsr a
1633	.9202		4a		lsr a		                lsr a
1634	.9203		4a		lsr a		                lsr a
1635	.9204		4a		lsr a		                lsr a
1636							                .endif
1637	.9205		28		plp		                plp                          ;restore  C
1638	.9206		20 1c 92	jsr $921c	                jsr printPossiblyLeading0    ;print line number 3rd digit
1639	.9209		68		pla		                pla                          ;restore line number LSB
1640	.920a		18		clc		                clc                ;always print line number 4th digit
1641	.920b		20 1c 92	jsr $921c	                jsr printPossiblyLeading0    ;
1642	.920e		4c 0c 9f	jmp $9f0c	                jmp printSpace                    ;

1644	.9211						printPossiblyLeading0s:
1645	.9211		48		pha		                pha                          ;save value
1646	.9212		08		php		                php                          ;save C
1647							                .if version==350
1649							                .else
1650	.9213		4a		lsr a		                lsr a
1651	.9214		4a		lsr a		                lsr a
1652	.9215		4a		lsr a		                lsr a
1653	.9216		4a		lsr a		                lsr a
1654							                .endif
1655	.9217		28		plp		                plp                          ;restore C
1656	.9218		20 1c 92	jsr $921c	                jsr printPossiblyLeading0    ;print 1st digit
1657	.921b		68		pla		                pla                          ;restore value
1658	.921c						printPossiblyLeading0:
1659	.921c		29 0f		and #$0f	                and #$0F                     ;get digit to print
1660	.921e		d0 09		bne $9229	                bne printNonLeading0         ;always print if non-0
1661	.9220		90 07		bcc $9229	                bcc printNonLeading0 ;branch taken if not leading 0
1662	.9222		a9 20		lda #$20	                lda #$20             ;print space instead of leading 0
1663	.9224		20 ee ff	jsr $ffee	                jsr OSWRCH
1664	.9227		38		sec		                sec                ;indicate still in leading 0s state
1665	.9228		60		rts		                rts

1667	.9229						printNonLeading0:
1668	.9229		20 73 a8	jsr $a873	                jsr printHexDigit            ;print digit
1669	.922c		18		clc		                clc                          ;no longer in leading 0s state
1670	.922d		60		rts		                rts                          ;

1672	.922e						adcLineNumberBCDX:
1673	.922e		a9 00		lda #$00	                lda #$00
1674	.9230		f8		sed		                sed
1675	.9231		7d c3 df	adc $dfc3,x	                adc hazel.lineNumberBCD,x
1676	.9234		9d c3 df	sta $dfc3,x	                sta hazel.lineNumberBCD,x
1677	.9237		d8		cld		                cld
1678	.9238						rts9238:
1679	.9238		60		rts		                rts

1681							;-------------------------------------------------------------------------

1683	.9239						L9239:
1684	.9239		da		phx		                phx
1685	.923a		48		pha		                pha
1686	.923b		a2 02		ldx #$02	                ldx #$02
1687	.923d						L923D:
1688	.923d		bd f1 02	lda $02f1,x	                lda osfileParameterBlock+4,x
1689	.9240		20 6a a8	jsr $a86a	                jsr printHexByte
1690	.9243		ca		dex		                dex
1691	.9244		10 f7		bpl $923d	                bpl L923D
1692	.9246		80 0c		bra $9254	                bra L9254

1694							;-------------------------------------------------------------------------

1696	.9248						L9248:
1697	.9248		da		phx		                phx
1698	.9249		48		pha		                pha
1699	.924a		a2 fc		ldx #$fc	                ldx #256-4
1700	.924c						L924C:
1701	.924c		fe f5 01	inc $01f5,x	                inc osfileParameterBlock+4-(256-4),x
1702	.924f		d0 03		bne $9254	                bne L9254
1703	.9251		e8		inx		                inx
1704	.9252		d0 f8		bne $924c	                bne L924C
1705	.9254						L9254:
1706	.9254		68		pla		                pla
1707	.9255		fa		plx		                plx
1708	.9256		60		rts		                rts

1710	.9257						L9257:
1711	.9257		5a		phy		                phy
1712	.9258		da		phx		                phx
1713	.9259						L9259:
1714	.9259		e0 08		cpx #$08	                cpx #$08
1715	.925b		f0 0a		beq $9267	                beq L9267
1716	.925d		20 58 a9	jsr $a958	                jsr alwaysPrintFollowingMessage
1717	>9260		20 20 20 00			                .text "   ",0
1718	.9264		e8		inx		                inx
1719	.9265		80 f2		bra $9259	                bra L9259

1721	.9267						L9267:
1722	.9267		fa		plx		                plx
1723	.9268		20 0c 9f	jsr $9f0c	                jsr printSpace
1724	.926b		a0 00		ldy #$00	                ldy #$00
1725	.926d						L926D:
1726	.926d		b9 f5 02	lda $02f5,y	                lda osfileParameterBlock+8,y
1727	.9270		20 ee ff	jsr $ffee	                jsr OSWRCH
1728	.9273		c8		iny		                iny
1729	.9274		ca		dex		                dex
1730	.9275		d0 f6		bne $926d	                bne L926D
1731	.9277		7a		ply		                ply
1732	.9278		4c e7 ff	jmp $ffe7	                jmp OSNEWL

1734							;-------------------------------------------------------------------------

1736							                .if version!=350
1737							                .include "restore_font.s65"

:9	;******  Processing file: src/restore_font.s65

1							;-------------------------------------------------------------------------
2							;
3							; restore entire font.
4							;
5	.927b						restoreFont32To255:
6	.927b		a2 07		ldx #$07	                ldx #$07                     ;224 chars - 32-255
7							                .cerror *!=restoreFont32ToN
8							                ; fall through to restoreFont32ToN

10							;-------------------------------------------------------------------------
11							;
12							; Restore part of the font, starting from char 32.
13							;
14							; entry:
15							;
16							; X = number of pages of font data to restore - X*32 chars will be
17							; restored
18							;
19	.927d						restoreFont32ToN:
20	.927d		08		php		                php
21	.927e		78		sei		                sei
22	.927f		a9 b9		lda #$b9	                lda #>LB900                ;start at beginning of font
23	.9281		85 f1		sta $f1		                sta $F1
24	.9283		a9 89		lda #$89	                lda #>andy.softCharacterDefinitions ;write to beginning of soft character definitions
25							                .cerror *!=restoreFontPart
26							                ; fall through to restoreFontPart

28							;-------------------------------------------------------------------------
29							;
30							; Restore part of the font.
31							;
32							; entry:
33							;
34							; ?$f1 = MSB of font data
35							;
36							; A = MSB of dest page in ANDY - should be part of the soft character
37							; definitions!
38							;
39							; X = number of pages of font data to restore - X*32 chars will be
40							; restored
41							;
42							; preserves: Y

44	.9285						restoreFontPart:
45	.9285		85 fb		sta $fb		                sta $FB                      ;save MSB of dest
46	.9287		20 98 e5	jsr $e598	                jsr mos.selectTerminalROMAndANDY2
47	.928a		5a		phy		                phy                          ;
48	.928b		a0 00		ldy #$00	                ldy #$00                     ;
49	.928d		64 fa		stz $fa		                stz $FA                      ;initialize LSB of src
50	.928f		64 f0		stz $f0		                stz $F0                      ;initialize LSB of dest
51	.9291						-
52	.9291		b1 f0		lda ($f0),y	                lda ($F0),y
53	.9293		91 fa		sta ($fa),y	                sta ($FA),y
54	.9295		c8		iny		                iny
55	.9296		d0 f9		bne $9291	                bne -
56	.9298		e6 f1		inc $f1		                inc $F1
57	.929a		e6 fb		inc $fb		                inc $FB
58	.929c		ca		dex		                dex
59	.929d		d0 f2		bne $9291	                bne -
60	.929f		7a		ply		                ply
61	.92a0		28		plp		                plp
62	.92a1		4c 90 e5	jmp $e590	                jmp mos.selectTerminalROM

64							;-------------------------------------------------------------------------

66							                .if version==350
68							                .endif
69	.92a4						restoreFont32To126:
70	.92a4		a2 03		ldx #$03	                ldx #$03                     ;96 chars - 32-126
71	.92a6		80 d5		bra $927d	                bra restoreFont32ToN

73							;-------------------------------------------------------------------------
74							;
75							; OSBYTE 25 (&19) Restore a group of font definitions
76							;
77							; MasRef D.2-28
78							;
79	.92a8						osbyte19:
80	.92a8		8a		txa		                txa                          ;A=group identifier
81	.92a9		f0 d0		beq $927b	                beq restoreFont32To255   ;taken if group 0 - all chars
82							                .if version<500
83	.92ab		c9 08		cmp #$08	                cmp #$08
84							                .if version==350
86							                .else
87	.92ad		b0 89		bcs $9238	                bcs rts9238         ;taken if group >= 8 (not invalid)
88							                .endif
94							                .endif
95	.92af		08		php		                php
96	.92b0		78		sei		                sei
97	.92b1		69 b8		adc #$b8	                adc #(>LB900)-1 ;form address of ROM font data for group
98	.92b3		85 f1		sta $f1		                sta $F1
99	.92b5		8a		txa		                txa
100	.92b6		a2 01		ldx #$01	                ldx #$01                   ;copy 1 page, 32 chars
101	.92b8		69 88		adc #$88	                adc #(>andy.softCharacterDefinitions)-1 ;get page in ANDY for group
102	.92ba		80 c9		bra $9285	                bra restoreFontPart


:6	;******  Return to file: src/terminal.s65

1738							                .endif

1740							;-------------------------------------------------------------------------
1741							;
1742							; Clear 4 bytes in the OSFILE parameter block.
1743							;
1744							; entry:
1745							;
1746							; X = offset of the 4 bytes to clear
1747							;
1748	.92bc						clearOSFILEParameterBlockDWORD:
1749	.92bc		9e ed 02	stz $02ed,x	                stz osfileParameterBlock+0,x
1750	.92bf		9e ee 02	stz $02ee,x	                stz osfileParameterBlock+1,x
1751	.92c2		9e ef 02	stz $02ef,x	                stz osfileParameterBlock+2,x
1752	.92c5		9e f0 02	stz $02f0,x	                stz osfileParameterBlock+3,x
1753	.92c8						rts94A4:
1754	.92c8		60		rts		                rts

1756							;-------------------------------------------------------------------------
1757							;
1758							; Read a 32-bit hex value from a string.
1759							;
1760							; entry:
1761							;
1762							; X = offset into osfileParameterBlock to store the value
1763							;
1764							; exit:
1765							;
1766							; C=0 if error

1768	.92c9						parseHexAddressFromString:
1769	.92c9		20 ff f2	jsr $f2ff	                jsr mos.skipSpacesAndCheckForCRInStringInput ; Skip spaces
1770	.92cc		20 48 86	jsr $8648	                jsr readHexDigit
1771	.92cf		90 23		bcc $92f4	                bcc rts92F4
1772	.92d1		20 bc 92	jsr $92bc	                jsr clearOSFILEParameterBlockDWORD
1773	.92d4						readDigitsLoop:
1774	.92d4		5a		phy		                phy
1775	.92d5		2a		rol a		                rol a
1776	.92d6		2a		rol a		                rol a
1777	.92d7		2a		rol a		                rol a
1778	.92d8		2a		rol a		                rol a                        ;put digit in top 4 bits
1779	.92d9		a0 04		ldy #$04	                ldy #$04
1780	.92db						shiftIn1DigitLoop:
1781	.92db		2a		rol a		                rol a
1782	.92dc		3e ed 02	rol $02ed,x	                rol osfileParameterBlock+0,x
1783	.92df		3e ee 02	rol $02ee,x	                rol osfileParameterBlock+1,x
1784	.92e2		3e ef 02	rol $02ef,x	                rol osfileParameterBlock+2,x
1785	.92e5		3e f0 02	rol $02f0,x	                rol osfileParameterBlock+3,x
1786	.92e8		b0 61		bcs $934b	                bcs badAddressError ;carry out of bit 31 implies too many digits
1787	.92ea		88		dey		                dey
1788	.92eb		d0 ee		bne $92db	                bne shiftIn1DigitLoop
1789	.92ed		7a		ply		                ply
1790	.92ee		20 48 86	jsr $8648	                jsr readHexDigit
1791	.92f1		b0 e1		bcs $92d4	                bcs readDigitsLoop   ;keep going until hex digits stop
1792	.92f3		38		sec		                sec       ;got at least 1 hex digit, so result is good
1793	.92f4						rts92F4:
1794	.92f4		60		rts		                rts

1796							;-------------------------------------------------------------------------
1797							;
1798							; *GO (<addr>) [MasRef C.5-6]
1799							;
1800	.92f5						starGO:
1801	.92f5		20 ff f2	jsr $f2ff	                jsr mos.skipSpacesAndCheckForCRInStringInput ; Skip spaces
1802	.92f8		d0 03		bne $92fd	                bne starGOIO             ; Jump to read parameters
1803	.92fa		4c 61 86	jmp $8661	                jmp commandLineUI        ; No parameters, enter CLICOM

1805							;-------------------------------------------------------------------------
1806							;
1807							; *GOIO <addr> [MasRef C.5-7]
1808							;
1809	.92fd						starGOIO:
1810	.92fd		a2 00		ldx #$00	                ldx #$00
1811	.92ff		20 5b 93	jsr $935b	                jsr parseHexAddressFromCommandLine ; Read hex address
1812	.9302		20 ff f2	jsr $f2ff	                jsr mos.skipSpacesAndCheckForCRInStringInput ; Skip spaces
1813	.9305		08		php		                php  ; Update &F2/3 to point to any further parameters
1814	.9306		98		tya		                tya
1815	.9307		18		clc		                clc
1816	.9308		65 f2		adc $f2		                adc stringInputBufferAddress+0
1817	.930a		85 f2		sta $f2		                sta stringInputBufferAddress+0
1818	.930c		90 02		bcc $9310	                bcc +
1819	.930e		e6 f3		inc $f3		                inc stringInputBufferAddress+1
1820	.9310						+
1821	.9310		a0 00		ldy #$00	                ldy #$00    ; (&F2),y=>parameters, EQ if no parameters
1822	.9312		28		plp		                plp
1823	.9313		6c ed 02	jmp ($02ed)	                jmp (osfileParameterBlock+0) ; Jump to address

1825							;-------------------------------------------------------------------------

1827	.9316						starLOAD:
1828	.9316		a9 ff		lda #$ff	                lda #fileLoad
1829	.9318						starCommandThroughOSFILE:
1830	.9318		4e c6 df	lsr $dfc6	                lsr hazel.tempFSFlag
1831	.931b						L931B:
1832	.931b		86 f2		stx $f2		                stx stringInputBufferAddress+0
1833	.931d		84 f3		sty $f3		                sty stringInputBufferAddress+1
1834	.931f		8e ed 02	stx $02ed	                stx osfileParameterBlock+OSFILEParameterBlock.fileName+0
1835	.9322		8c ee 02	sty $02ee	                sty osfileParameterBlock+OSFILEParameterBlock.fileName+1
1836	.9325		48		pha		                pha                          ;save OSFILE reason
1837	.9326		a2 02		ldx #$02	                ldx #OSFILEParameterBlock.load
1838	.9328		20 bc 92	jsr $92bc	                jsr clearOSFILEParameterBlockDWORD
1839	.932b		a2 0a		ldx #$0a	                ldx #OSFILEParameterBlock.length
1840	.932d		20 bc 92	jsr $92bc	                jsr clearOSFILEParameterBlockDWORD
1841	.9330		a0 ff		ldy #$ff	                ldy #$FF
1842	.9332		8c f3 02	sty $02f3	                sty osfileParameterBlock+OSFILEParameterBlock.exec+0 ;by default, load to file's load address
1843	.9335		c8		iny		                iny                                                  ;Y=0
1844	.9336		20 6d f2	jsr $f26d	                jsr mos.gsinitForFilenameParsing
1845	.9339						L9339:
1846	.9339		20 7f f2	jsr $f27f	                jsr mos.gsreadEntryPoint
1847	.933c		90 fb		bcc $9339	                bcc L9339
1848	.933e		68		pla		                pla                          ;restore OSFILE reason
1849	.933f		48		pha		                pha                          ;save OSFILE reason
1850	.9340		10 50		bpl $9392	                bpl finishStarSAVE                    ;taken if *SAVE
1851	.9342		a2 02		ldx #$02	                ldx #OSFILEParameterBlock.load
1852	.9344		20 c9 92	jsr $92c9	                jsr parseHexAddressFromString ;parse *LOAD address
1853	.9347		b0 18		bcs $9361	                bcs doStarLOADWithExplicitAddress ;taken if good address
1854	.9349		f0 1b		beq $9366	                beq L9366        ;taken if CR encountered (this is ok)
1855	.934b						badAddressError:
1856	.934b		20 ed aa	jsr $aaed	                jsr doFollowingError
1857	>934e		fc 42 61 64 20 61 64 64		                .text $fc,"Bad address",0
	>9356		72 65 73 73 00

1859							;-------------------------------------------------------------------------
1860							;
1861							; Parse hex address from command line.
1862							;
1863	.935b						parseHexAddressFromCommandLine:
1864	.935b		20 c9 92	jsr $92c9	                jsr parseHexAddressFromString ; Read hex address
1865	.935e		90 eb		bcc $934b	                bcc badAddressError           ; Jump with bad address
1866	.9360		60		rts		                rts

1868							;-------------------------------------------------------------------------

1870	.9361						doStarLOADWithExplicitAddress:
1871	.9361		d0 7f		bne $93e2	                bne badCommandError93E2
1872	.9363		ee f3 02	inc $02f3	                inc osfileParameterBlock+OSFILEParameterBlock.exec+0 ;load to parameter block load address
1873	.9366						L9366:
1874	.9366		0e c6 df	asl $dfc6	                asl hazel.tempFSFlag
1875	.9369						callOSFILEWithOSFILEParameterBlock:
1876	.9369		a2 ed		ldx #$ed	                ldx #<osfileParameterBlock
1877	.936b		a0 02		ldy #$02	                ldy #>osfileParameterBlock
1878	.936d		68		pla		                pla
1879	.936e		4c dd ff	jmp $ffdd	                jmp OSFILE

1881							;-------------------------------------------------------------------------
1882							;
1883							; *REMOVE [MasRef G.5-9]
1884							;
1885	.9371						starREMOVE:
1886	.9371		8e ed 02	stx $02ed	                stx osfileParameterBlock+OSFILEParameterBlock.fileName+0
1887	.9374		8c ee 02	sty $02ee	                sty osfileParameterBlock+OSFILEParameterBlock.fileName+1
1888							                .if version>=510||version==350
1899							                .endif
1900	.9377		a9 06		lda #$06	                lda #fileDelete
1901	.9379		48		pha		                pha
1902	.937a		80 ed		bra $9369	                bra callOSFILEWithOSFILEParameterBlock

1904							;-------------------------------------------------------------------------
1905							                .if version<510&&version!=350
1906							;
1907							; *CLOSE [MasRef G.5-3]
1908							;
1909	.937c						starCLOSE:
1910	.937c		20 ff f2	jsr $f2ff	                jsr mos.skipSpacesAndCheckForCRInStringInput
1911	.937f		d0 61		bne $93e2	                bne badCommandError93E2
1912	.9381		a9 00		lda #$00	                lda #$00
1913	.9383		a8		tay		                tay
1914	.9384		6c 1c 02	jmp ($021c)	                jmp (FINDV)                  ;OSFIND A=0 Y=0
1915							                .endif
1916							;-------------------------------------------------------------------------
1917							                .if version<510&&version!=350
1918							;
1919							; *IGNORE [MasRef C.5-7]
1920							;
1921	.9387						starIGNORE:
1922	.9387		d0 05		bne $938e	                bne L938E
1923	.9389		38		sec		                sec
1924	.938a		6e 46 02	ror $0246	                ror noignoreState
1925	.938d		60		rts		                rts

1927	.938e						L938E:
1928	.938e		a9 06		lda #$06	                lda #$06
1929	.9390		80 59		bra $93eb	                bra starCommandThroughOSBYTE
1930							                .endif
1931							;-------------------------------------------------------------------------

1933	.9392						finishStarSAVE:
1934	.9392		d0 07		bne $939b	                bne L939B
1935	.9394		a2 0a		ldx #$0a	                ldx #OSFILEParameterBlock.saveStart
1936	.9396		20 c9 92	jsr $92c9	                jsr parseHexAddressFromString
1937	.9399		90 47		bcc $93e2	                bcc badCommandError93E2
1938	.939b						L939B:
1939	.939b		b8		clv		                clv
1940	.939c		b1 f2		lda ($f2),y	                lda (stringInputBufferAddress),y
1941	.939e		c9 2b		cmp #$2b	                cmp #'+'
1942	.93a0		d0 04		bne $93a6	                bne L93A6                    ;taken if "*SAVE START END..."
1943	.93a2		2c 4e e3	bit $e34e	                bit mos.valueFF              ;V=1
1944	.93a5		c8		iny		                iny
1945	.93a6						L93A6:
1946	.93a6		a2 0e		ldx #$0e	                ldx #OSFILEParameterBlock.saveEnd
1947	.93a8		20 c9 92	jsr $92c9	                jsr parseHexAddressFromString
1948	.93ab		90 35		bcc $93e2	                bcc badCommandError93E2
1949	.93ad		08		php		                php
1950	.93ae		50 0f		bvc $93bf	                bvc L93BF                    ;taken if "*SAVE START END"

1952							                ; Get the save end address.
1953	.93b0		a2 fc		ldx #$fc	                ldx #256-4
1954	.93b2		18		clc		                clc
1955	.93b3						-
1956							                ; TODO - not sure why the @w notation is required here?
1957	.93b3		bd fb 01	lda $01fb,x	                lda@w osfileParameterBlock+OSFILEParameterBlock.saveStart-(256-4),x
1958	.93b6		7d ff 01	adc $01ff,x	                adc@w osfileParameterBlock+OSFILEParameterBlock.saveEnd-(256-4),x
1959	.93b9		9d ff 01	sta $01ff,x	                sta@w osfileParameterBlock+OSFILEParameterBlock.saveEnd-(256-4),x
1960	.93bc		e8		inx		                inx
1961	.93bd		d0 f4		bne $93b3	                bne -
1962	.93bf						L93BF:

1964							                ; Initialize load and exec addresses to save start
1965							                ; address.
1966	.93bf		a2 03		ldx #$03	                ldx #$03
1967	.93c1						-
1968	.93c1		bd f7 02	lda $02f7,x	                lda@w osfileParameterBlock+OSFILEParameterBlock.saveStart,x
1969	.93c4		9d f3 02	sta $02f3,x	                sta@w osfileParameterBlock+OSFILEParameterBlock.exec,x
1970	.93c7		9d ef 02	sta $02ef,x	                sta@w osfileParameterBlock+OSFILEParameterBlock.load,x
1971	.93ca		ca		dex		                dex
1972	.93cb		10 f4		bpl $93c1	                bpl -

1974	.93cd		28		plp		                plp
1975	.93ce		f0 96		beq $9366	                beq L9366

1977	.93d0		a2 06		ldx #$06	                ldx #OSFILEParameterBlock.exec
1978	.93d2		20 c9 92	jsr $92c9	                jsr parseHexAddressFromString
1979	.93d5		90 0b		bcc $93e2	                bcc badCommandError93E2
1980	.93d7		f0 8d		beq $9366	                beq L9366

1982	.93d9		a2 02		ldx #$02	                ldx #OSFILEParameterBlock.load
1983	.93db		20 c9 92	jsr $92c9	                jsr parseHexAddressFromString
1984	.93de		90 02		bcc $93e2	                bcc badCommandError93E2
1985	.93e0		f0 84		beq $9366	                beq L9366

1987	.93e2						badCommandError93E2:
1988	.93e2		4c ed fb	jmp $fbed	                jmp mos.badCommandError

1990							;-------------------------------------------------------------------------

1992	.93e5						starFX:
1993	.93e5		20 e6 85	jsr $85e6	                jsr parseNumberFromString
1994	.93e8		90 f8		bcc $93e2	                bcc badCommandError93E2
1995	.93ea		8a		txa		                txa
1996	.93eb						starCommandThroughOSBYTE:
1997	.93eb		08		php		                php
1998	.93ec		4e c6 df	lsr $dfc6	                lsr hazel.tempFSFlag
1999	.93ef		28		plp		                plp
2000	.93f0		48		pha		                pha
2001	.93f1		64 e5		stz $e5		                stz $E5
2002	.93f3		64 e4		stz $e4		                stz $E4
2003	.93f5		20 08 f3	jsr $f308	                jsr mos.LF308
2004	.93f8		f0 18		beq $9412	                beq L9412
2005	.93fa		20 e6 85	jsr $85e6	                jsr parseNumberFromString
2006	.93fd		90 e3		bcc $93e2	                bcc badCommandError93E2
2007	.93ff		86 e5		stx $e5		                stx $E5
2008	.9401		20 0a f3	jsr $f30a	                jsr mos.LF30A
2009	.9404		f0 0c		beq $9412	                beq L9412
2010	.9406		20 e6 85	jsr $85e6	                jsr parseNumberFromString
2011	.9409		90 d7		bcc $93e2	                bcc badCommandError93E2
2012	.940b		86 e4		stx $e4		                stx $E4
2013	.940d		20 ff f2	jsr $f2ff	                jsr mos.skipSpacesAndCheckForCRInStringInput
2014	.9410						L9625:
2015	.9410		d0 d0		bne $93e2	                bne badCommandError93E2
2016	.9412						L9412:
2017	.9412		a4 e4		ldy $e4		                ldy $E4
2018	.9414		a6 e5		ldx $e5		                ldx $E5
2019	.9416		68		pla		                pla
2020	.9417		0e c6 df	asl $dfc6	                asl hazel.tempFSFlag
2021	.941a		20 f4 ff	jsr $fff4	                jsr OSBYTE
2022	.941d		70 c3		bvs $93e2	                bvs badCommandError93E2
2023	.941f						L941F:
2024	.941f		60		rts		                rts

2026							;-------------------------------------------------------------------------

2028	.9420						starSPOOLON:
2029	.9420		38		sec		                sec
2030	.9421		80 10		bra $9433	                bra starSPOOL

2032							;-------------------------------------------------------------------------

2034							                .if version>=510||version==350
2039							                .endif

2041							;-------------------------------------------------------------------------

2043	.9423						L9423:
2044	.9423		a2 10		ldx #$10	                ldx #romServiceCallSpoolExecClosureWarning
2045	.9425		20 72 ee	jsr $ee72	                jsr mos.makeROMServiceCall
2046	.9428		f0 f5		beq $941f	                beq L941F
2047	.942a		20 8b a5	jsr $a58b	                jsr LA58B
2048	.942d		ad 57 02	lda $0257	                lda spoolFileHandle
2049	.9430		20 6b a5	jsr $a56b	                jsr LA56B
2050	.9433						starSPOOL:
2051	.9433		08		php		                php
2052	.9434		5a		phy		                phy
2053	.9435		ac 57 02	ldy $0257	                ldy spoolFileHandle
2054	.9438		8d 57 02	sta $0257	                sta spoolFileHandle
2055	.943b		f0 03		beq $9440	                beq L9440
2056	.943d		20 ce ff	jsr $ffce	                jsr OSFIND
2057	.9440						L9440:
2058	.9440		4e c6 df	lsr $dfc6	                lsr hazel.tempFSFlag
2059	.9443		7a		ply		                ply
2060	.9444		28		plp		                plp
2061	.9445		f0 d8		beq $941f	                beq L941F
2062	.9447		a9 80		lda #$80	                lda #$80
2063	.9449		90 02		bcc $944d	                bcc L944D
2064	.944b		a9 c0		lda #$c0	                lda #$C0
2065	.944d						L944D:
2066	.944d		0e c6 df	asl $dfc6	                asl hazel.tempFSFlag
2067	.9450		20 ce ff	jsr $ffce	                jsr OSFIND
2068	.9453		a8		tay		                tay
2069	.9454		f0 8c		beq $93e2	                beq badCommandError93E2
2070	.9456		8d 57 02	sta $0257	                sta spoolFileHandle
2071	.9459		a8		tay		                tay
2072	.945a						setPTRToEOF:
2073	.945a		a9 02		lda #$02	                lda #argsFileGetEXT
2074	.945c		20 61 94	jsr $9461	                jsr callOSARGSWithBuffer
2075	.945f						setFilePointerFromOSARGSBuffer:
2076	.945f		a9 01		lda #$01	                lda #argsFileSetPTR
2077	.9461						callOSARGSWithBuffer:
2078	.9461		a2 a8		ldx #$a8	                ldx #osargsBuffer
2079	.9463		4c da ff	jmp $ffda	                jmp OSARGS

2081							;-------------------------------------------------------------------------

2083							                .if version<510&&version!=350
2084	.9466						starSHADOW:
2085	.9466		a9 72		lda #$72	                lda #$72
2086	.9468		80 81		bra $93eb	                bra starCommandThroughOSBYTE
2087							                .endif

2089							;-------------------------------------------------------------------------

2091							                .if version>=510||version==350
2098							                .endif

2100							;-------------------------------------------------------------------------

2102							                .if version>=510||version==350
2112							                .endif

2114							;-------------------------------------------------------------------------
2115							;
2116	.946a						starDELETE:
2117	.946a		20 71 93	jsr $9371	                jsr starREMOVE
2118	.946d		a8		tay		                tay
2119	.946e		d0 af		bne $941f	                bne L941F
2120	.9470		4c 4d a5	jmp $a54d	                jmp notFoundError

2122							;-------------------------------------------------------------------------

2124							                .if version==350
2127							                .endif

2129							;-------------------------------------------------------------------------

2131							                .if version==350
2146							                .endif

2148							;-------------------------------------------------------------------------

2150							                .if version>=510||version==350
2177							                .endif

2179							;-------------------------------------------------------------------------

2181							                .if version<510&&version!=350
2182	.9473						parseSoftKeyNumberFromCommandLine:
2183	.9473		20 e6 85	jsr $85e6	                jsr parseNumberFromString
2184	.9476		90 04		bcc $947c	                bcc badKeyError
2185	.9478		e0 10		cpx #$10	                cpx #softKeyCount
2186	.947a		90 a3		bcc $941f	                bcc L941F
2187	.947c						badKeyError:
2188	.947c		20 ed aa	jsr $aaed	                jsr doFollowingError
2189	>947f		fb				                .byte $FB
2190	>9480		42 61 64 20 6b 65 79		                .text "Bad key"
2191	>9487		00				                .byte 0
2192							                .endif

2194							;-------------------------------------------------------------------------
2195							;
2196							; [MasRef C.5-11]
2197							;

2199							                .if version<510&&version!=350
2200	.9488						starSHOW:
2201	.9488		20 73 94	jsr $9473	                jsr parseSoftKeyNumberFromCommandLine
2202	.948b		20 ff f2	jsr $f2ff	                jsr mos.skipSpacesAndCheckForCRInStringInput
2203	.948e		d0 ec		bne $947c	                bne badKeyError
2206							                .endif
2207	.9490		a9 22		lda #$22	                lda #'"'
2208	.9492		20 ee ff	jsr $ffee	                jsr OSWRCH
2209	.9495		a5 f4		lda $f4		                lda $F4
2210	.9497		48		pha		                pha
2211	.9498		20 98 e5	jsr $e598	                jsr mos.selectTerminalROMAndANDY2
2212	.949b		bd 00 80	lda $8000,x	                lda andy.softKeys.stringLSBs,x
2213	.949e		85 f2		sta $f2		                sta stringInputBufferAddress+0
2214	.94a0		bd 11 80	lda $8011,x	                lda andy.softKeys.stringMSBs,x
2215	.94a3		85 f3		sta $f3		                sta stringInputBufferAddress+1
2216							                .if version<510&&version!=350
2217	.94a5		a4 e6		ldy $e6		                ldy $E6
2221							                .endif
2222	.94a7		20 55 eb	jsr $eb55	                jsr mos.getSoftKeyStringLength
2223	.94aa		a8		tay		                tay                          ;Y = string length
2224	.94ab		f0 0e		beq $94bb	                beq starSHOWDone                    ;done if length=0
2225	.94ad						-
2226	.94ad		b2 f2		lda ($f2)	                lda (stringInputBufferAddress)
2227	.94af		20 06 96	jsr $9606	                jsr printGSREADChar
2228	.94b2		e6 f2		inc $f2		                inc stringInputBufferAddress+0
2229	.94b4		d0 02		bne $94b8	                bne +
2230	.94b6		e6 f3		inc $f3		                inc stringInputBufferAddress+1
2231	.94b8						+
2232	.94b8		88		dey		                dey
2233	.94b9		d0 f2		bne $94ad	                bne -
2234	.94bb						starSHOWDone:
2235	.94bb		68		pla		                pla
2236	.94bc		20 92 e5	jsr $e592	                jsr mos.selectROMA
2237	.94bf		a9 22		lda #$22	                lda #'"'
2238	.94c1		20 ee ff	jsr $ffee	                jsr OSWRCH
2239	.94c4		4c e7 ff	jmp $ffe7	                jmp OSNEWL

2241							;-------------------------------------------------------------------------

2243							                .if version>=510
2254							                .endif

2256							;-------------------------------------------------------------------------
2257							;
2258							; [MasRef C.5-8]
2259							;
2260	.94c7						starKEY: .proc
2261	.94c7		20 73 94	jsr $9473	                jsr parseSoftKeyNumberFromCommandLine
2262	.94ca		a5 f4		lda $f4		                lda $F4
2263	.94cc		48		pha		                pha
2264	.94cd		20 7f e5	jsr $e57f	                jsr mos.selectTerminalROMAndANDY
2265	.94d0		20 ff f2	jsr $f2ff	                jsr mos.skipSpacesAndCheckForCRInStringInput
2266	.94d3		64 b0		stz $b0		                stz starKEYWorkspace.newStringLength
2267	.94d5		f0 15		beq $94ec	                beq commandLineTailEmpty
2268	.94d7		a2 00		ldx #$00	                ldx #$00
2269	.94d9		38		sec		                sec
2270	.94da		20 6e f2	jsr $f26e	                jsr mos.gsinitEntryPoint
2271	.94dd						-
2272	.94dd		20 7f f2	jsr $f27f	                jsr mos.gsreadEntryPoint
2273	.94e0		b0 06		bcs $94e8	                bcs bneBadKeyError
2274	.94e2		9d 00 dc	sta $dc00,x	                sta hazel.commandLine,x
2275	.94e5		e8		inx		                inx
2276	.94e6		80 f5		bra $94dd	                bra -

2278	.94e8						bneBadKeyError:
2279							                .if version==350
2281							                .else
2282	.94e8		d0 92		bne $947c	                bne badKeyError
2283							                .endif
2284	.94ea		86 b0		stx $b0		                stx starKEYWorkspace.newStringLength
2285	.94ec						commandLineTailEmpty:
2286	.94ec		a4 e6		ldy $e6		                ldy $E6                        ;Y = soft key number
2287	.94ee		20 55 eb	jsr $eb55	                jsr mos.getSoftKeyStringLength
2288	.94f1		85 b5		sta $b5		                sta starKEYWorkspace.counter+0
2289	.94f3		38		sec		                sec
2290	.94f4		e5 b0		sbc $b0		                sbc starKEYWorkspace.newStringLength ;A=existing len-new len
2291	.94f6		b0 16		bcs $950e	                bcs newStringWillFit            ;taken if new string shorter, meaning it'll definitely fit

2293	.94f8		49 ff		eor #$ff	                eor #$FF
2294	.94fa		69 01		adc #$01	                adc #$01                     ;A=new len-existing len
2295	.94fc		6d 10 80	adc $8010	                adc andy.softKeys.endLSB
2296	.94ff		aa		tax		                tax
2297	.9500		ad 21 80	lda $8021	                lda andy.softKeys.endMSB
2298	.9503		69 00		adc #$00	                adc #$00
2299	.9505		c9 84		cmp #$84	                cmp #>(andy.softKeys.end)
2300	.9507		90 05		bcc $950e	                bcc newStringWillFit

2302							                ; Produce slightly cryptic "Bad key" if string won't
2303							                ; fit.
2304	.9509		d0 dd		bne $94e8	                bne bneBadKeyError
2305	.950b		8a		txa		                txa
2306	.950c		d0 da		bne $94e8	                bne bneBadKeyError
2307	.950e						newStringWillFit:
2308	.950e		ad 68 02	lda $0268	                lda softKeyStringLength
2309	.9511		f0 32		beq $9545	                beq storeNewString          ;taken if new string empty
2310	.9513		ad c9 02	lda $02c9	                lda currentSoftKey
2311	.9516		c5 e6		cmp $e6		                cmp $E6
2312	.9518		90 2b		bcc $9545	                bcc storeNewString ;taken if current soft key<key - expansion will not need to relocate
2313	.951a		d0 0f		bne $952b	                bne relocateCurrentSoftKeyExpansion ;taken if current soft key>key - expansion must relocate
2314	.951c		20 ed aa	jsr $aaed	                jsr doFollowingError
2315	>951f		fa 4b 65 79 20 69 6e 20		                .text $fa,"Key in use",0
	>9527		75 73 65 00
2316	.952b						relocateCurrentSoftKeyExpansion:
2317	.952b		64 b2		stz $b2		                stz starKEYWorkspace.destPtr+1
2318	.952d		38		sec		                sec
2319	.952e		a5 b0		lda $b0		                lda starKEYWorkspace.newStringLength
2320	.9530		e5 b5		sbc $b5		                sbc starKEYWorkspace.counter+0
2321	.9532		85 b1		sta $b1		                sta starKEYWorkspace.destPtr+0
2322	.9534		b0 02		bcs $9538	                bcs +
2323	.9536		c6 b2		dec $b2		                dec starKEYWorkspace.destPtr+1
2324	.9538						+
2325	.9538		18		clc		                clc
2326	.9539		a5 f8		lda $f8		                lda softKeyExpansionPtr+0
2327	.953b		65 b1		adc $b1		                adc starKEYWorkspace.destPtr+0
2328	.953d		85 f8		sta $f8		                sta softKeyExpansionPtr+0
2329	.953f		a5 f9		lda $f9		                lda softKeyExpansionPtr+1
2330	.9541		65 b2		adc $b2		                adc starKEYWorkspace.destPtr+1
2331	.9543		85 f9		sta $f9		                sta softKeyExpansionPtr+1
2332	.9545						storeNewString:
2333	.9545		ce 84 02	dec $0284	                dec softKeyConsistencyFlag   ;mark soft keys inconsistent
2334	.9548		a6 e6		ldx $e6		                ldx $E6                      ;X=key number
2335	.954a		a5 b5		lda $b5		                lda starKEYWorkspace.counter+0
2336	.954c		f0 45		beq $9593	                beq makeSpaceForNewString ;taken if no existing string for this soft key

2338							                ; delete existing string
2339	.954e		bd 00 80	lda $8000,x	                lda andy.softKeys.stringLSBs,x
2340	.9551		85 b1		sta $b1		                sta starKEYWorkspace.destPtr+0
2341	.9553		bd 11 80	lda $8011,x	                lda andy.softKeys.stringMSBs,x
2342	.9556		85 b2		sta $b2		                sta starKEYWorkspace.destPtr+1
2343	.9558		bd 01 80	lda $8001,x	                lda andy.softKeys.stringLSBs+1,x
2344	.955b		85 b3		sta $b3		                sta starKEYWorkspace.srcPtr+0
2345	.955d		bd 12 80	lda $8012,x	                lda andy.softKeys.stringMSBs+1,x
2346	.9560		85 b4		sta $b4		                sta starKEYWorkspace.srcPtr+1
2347	.9562						deleteExistingStringLoop:
2348							                ; copy byte (with postincrement)
2349	.9562		b2 b3		lda ($b3)	                lda (starKEYWorkspace.srcPtr)
2350	.9564		92 b1		sta ($b1)	                sta (starKEYWorkspace.destPtr)

2352							                ; increment destPtr
2353	.9566		e6 b1		inc $b1		                inc starKEYWorkspace.destPtr+0
2354	.9568		d0 02		bne $956c	                bne +
2355	.956a		e6 b2		inc $b2		                inc starKEYWorkspace.destPtr+1
2356	.956c						+

2358							                ; increment srcPtr
2359	.956c		e6 b3		inc $b3		                inc starKEYWorkspace.srcPtr+0
2360	.956e		d0 02		bne $9572	                bne +
2361	.9570		e6 b4		inc $b4		                inc starKEYWorkspace.srcPtr+1
2362	.9572						+

2364							                ; keep copying until end of buffer reached.
2365	.9572		a5 b3		lda $b3		                lda starKEYWorkspace.srcPtr+0
2366	.9574		cd 10 80	cmp $8010	                cmp andy.softKeys.endLSB
2367	.9577		a5 b4		lda $b4		                lda starKEYWorkspace.srcPtr+1
2368	.9579		ed 21 80	sbc $8021	                sbc andy.softKeys.endMSB
2369	.957c		90 e4		bcc $9562	                bcc deleteExistingStringLoop

2371							                ; update following strings' start addresses, which all
2372							                ; move down by the old string's length.
2373	.957e						updateAddressesLoop:
2374	.957e		e8		inx		                inx
2375	.957f		e0 11		cpx #$11	                cpx #softKeyCount+1
2376	.9581		b0 10		bcs $9593	                bcs makeSpaceForNewString
2377	.9583		38		sec		                sec
2378	.9584		bd 00 80	lda $8000,x	                lda andy.softKeys.stringLSBs,x
2379	.9587		e5 b5		sbc $b5		                sbc starKEYWorkspace.counter+0
2380	.9589		9d 00 80	sta $8000,x	                sta andy.softKeys.stringLSBs,x
2381	.958c		b0 f0		bcs $957e	                bcs updateAddressesLoop
2382	.958e		de 11 80	dec $8011,x	                dec andy.softKeys.stringMSBs,x
2383	.9591		80 eb		bra $957e	                bra updateAddressesLoop

2385	.9593						makeSpaceForNewString:
2386	.9593		a6 e6		ldx $e6		                ldx $E6
2387	.9595		a5 b0		lda $b0		                lda starKEYWorkspace.newStringLength
2388	.9597		f0 66		beq $95ff	                beq done
2389	.9599		ad 10 80	lda $8010	                lda andy.softKeys.endLSB
2390	.959c		85 b3		sta $b3		                sta starKEYWorkspace.srcPtr+0
2391	.959e		18		clc		                clc
2392	.959f		65 b0		adc $b0		                adc starKEYWorkspace.newStringLength
2393	.95a1		85 b1		sta $b1		                sta starKEYWorkspace.destPtr+0 ;new end ptr LSB
2394	.95a3		ad 21 80	lda $8021	                lda andy.softKeys.endMSB
2395	.95a6		85 b4		sta $b4		                sta starKEYWorkspace.srcPtr+1
2396	.95a8		69 00		adc #$00	                adc #$00
2397	.95aa		85 b2		sta $b2		                sta starKEYWorkspace.destPtr+1 ;new end ptr MSB
2398	.95ac		a5 b3		lda $b3		                lda starKEYWorkspace.srcPtr+0
2399	.95ae		38		sec		                sec
2400	.95af		fd 00 80	sbc $8000,x	                sbc andy.softKeys.stringLSBs,x
2401	.95b2		85 b5		sta $b5		                sta starKEYWorkspace.counter+0
2402	.95b4		a5 b4		lda $b4		                lda starKEYWorkspace.srcPtr+1
2403	.95b6		fd 11 80	sbc $8011,x	                sbc andy.softKeys.stringMSBs,x
2404	.95b9		85 b6		sta $b6		                sta starKEYWorkspace.counter+1
2405	.95bb						makeSpaceForNewStringLoop:
2406							                ; loop while counter>0
2407	.95bb		a5 b5		lda $b5		                lda starKEYWorkspace.counter+0
2408	.95bd		05 b6		ora $b6		                ora starKEYWorkspace.counter+1
2409	.95bf		f0 1e		beq $95df	                beq updateAddressesLoop2

2411							                ; decrement destPtr
2412	.95c1		a5 b1		lda $b1		                lda starKEYWorkspace.destPtr+0
2413	.95c3		d0 02		bne $95c7	                bne +
2414	.95c5		c6 b2		dec $b2		                dec starKEYWorkspace.destPtr+1
2415	.95c7						+
2416	.95c7		c6 b1		dec $b1		                dec starKEYWorkspace.destPtr+0

2418							                ; decrement srcPtr
2419	.95c9		a5 b3		lda $b3		                lda starKEYWorkspace.srcPtr+0
2420	.95cb		d0 02		bne $95cf	                bne +
2421	.95cd		c6 b4		dec $b4		                dec starKEYWorkspace.srcPtr+1
2422	.95cf						+
2423	.95cf		c6 b3		dec $b3		                dec starKEYWorkspace.srcPtr+0

2425							                ; copy byte (with predecrement)
2426	.95d1		b2 b3		lda ($b3)	                lda (starKEYWorkspace.srcPtr)
2427	.95d3		92 b1		sta ($b1)	                sta (starKEYWorkspace.destPtr)

2429							                ; decrement counter
2430	.95d5		a5 b5		lda $b5		                lda starKEYWorkspace.counter+0
2431	.95d7		d0 02		bne $95db	                bne +
2432	.95d9		c6 b6		dec $b6		                dec starKEYWorkspace.counter+1
2433	.95db						+
2434	.95db		c6 b5		dec $b5		                dec starKEYWorkspace.counter+0

2436	.95dd		80 dc		bra $95bb	                bra makeSpaceForNewStringLoop

2438							                ; update following strings' start addresses, which all
2439							                ; move up by the new string's length.
2440	.95df						updateAddressesLoop2:
2441	.95df		e8		inx		                inx
2442	.95e0		e0 11		cpx #$11	                cpx #softKeyCount+1
2443	.95e2		b0 0f		bcs $95f3	                bcs copyNewString
2444	.95e4		bd 00 80	lda $8000,x	                lda andy.softKeys.stringLSBs,x
2445	.95e7		65 b0		adc $b0		                adc starKEYWorkspace.newStringLength
2446	.95e9		9d 00 80	sta $8000,x	                sta andy.softKeys.stringLSBs,x
2447	.95ec		90 f1		bcc $95df	                bcc updateAddressesLoop2
2448	.95ee		fe 11 80	inc $8011,x	                inc andy.softKeys.stringMSBs,x
2449	.95f1		80 ec		bra $95df	                bra updateAddressesLoop2

2451	.95f3						copyNewString:
2452	.95f3		a0 00		ldy #$00	                ldy #$00
2453	.95f5						copyNewStringLoop:
2454	.95f5		b9 00 dc	lda $dc00,y	                lda hazel.commandLine,y
2455	.95f8		91 b3		sta ($b3),y	                sta (starKEYWorkspace.srcPtr),y
2456	.95fa		c8		iny		                iny
2457	.95fb		c6 b0		dec $b0		                dec starKEYWorkspace.newStringLength
2458	.95fd		d0 f6		bne $95f5	                bne copyNewStringLoop
2459	.95ff						done:
2460	.95ff		ee 84 02	inc $0284	                inc softKeyConsistencyFlag   ;mark soft keys consistent
2461	.9602		68		pla		                pla
2462	.9603		4c 92 e5	jmp $e592	                jmp mos.selectROMA
2463							                .endproc

2465							;-------------------------------------------------------------------------
2466							;
2467							; Print char, printing control codes using the string reader escape
2468							; syntax. [MasRef C.5-8]
2469							;
2470	.9606						printGSREADChar: .proc
2471	.9606		aa		tax		                tax                          ;X=char
2472	.9607		30 28		bmi $9631	                bmi printHighBitChar
2473	.9609		c9 20		cmp #$20	                cmp #$20
2474	.960b		90 1f		bcc $962c	                bcc printControlChar
2475	.960d		e8		inx		                inx
2476	.960e		30 0f		bmi $961f	                bmi vdu127
2477	.9610		ca		dex		                dex                          ;restore old char
2478	.9611		c9 22		cmp #$22	                cmp #'"'
2479	.9613		f0 11		beq $9626	                beq printEscapedX
2480	.9615		c9 7c		cmp #$7c	                cmp #'|'
2481	.9617		d0 03		bne $961c	                bne printA
2482							                ; print "||"
2483	.9619		20 ee ff	jsr $ffee	                jsr OSWRCH
2484	.961c						printA:
2485	.961c		4c ee ff	jmp $ffee	                jmp OSWRCH

2487	.961f						vdu127:
2488							                ; print "|?"
2489	.961f		20 3c 96	jsr $963c	                jsr printEscapeChar
2490	.9622		a9 3f		lda #$3f	                lda #'?'
2491	.9624		80 f6		bra $961c	                bra printA

2493	.9626						printEscapedX:
2494	.9626		20 3c 96	jsr $963c	                jsr printEscapeChar
2495	.9629		8a		txa		                txa
2496	.962a		80 f0		bra $961c	                bra printA

2498	.962c						printControlChar:
2499	.962c		09 40		ora #$40	                ora #$40
2500	.962e		aa		tax		                tax
2501	.962f		80 f5		bra $9626	                bra printEscapedX

2503	.9631						printHighBitChar:
2504	.9631		48		pha		                pha
2505	.9632		a2 21		ldx #$21	                ldx #'!'
2506	.9634		20 26 96	jsr $9626	                jsr printEscapedX
2507	.9637		68		pla		                pla
2508	.9638		29 7f		and #$7f	                and #$7F
2509	.963a		80 ca		bra $9606	                bra printGSREADChar

2511	.963c						printEscapeChar:
2512	.963c		a9 7c		lda #$7c	                lda #'|'
2513	.963e		80 dc		bra $961c	                bra printA
2514							                .endproc

2516							;-------------------------------------------------------------------------

2518							                .if version!=350
2519							                .include "rtc.s65"

:10	;******  Processing file: src/rtc.s65

1							                .if version<500
2							; Day string not matched
3							; ----------------------
4	.9640						nextDayString:
5	.9640		68		pla		                pla                          ; Drop number of characters matched
6	.9641		68		pla		                pla                          ; Get offset to string table
7	.9642		7a		ply		                ply                          ; Get start of supplied string
8	.9643		18		clc		                clc                          ; Step to next string table entry
9	.9644		69 04		adc #$04	                adc #$04
10	.9646		c9 1c		cmp #$1c	                cmp #size(dayOfWeekStrings) ; If not checked 28/4=7 entries, keep looking
11	.9648		90 1c		bcc $9666	                bcc checkDayString
12	.964a		60		rts		                rts                          ; Otherwise exit silently

14							; Month string not matched
15							; ------------------------
16	.964b						nextMonthString:
17	.964b		68		pla		                pla                          ; Drop number of characters matched
18	.964c		68		pla		                pla                          ; Get offset to string table
19	.964d		7a		ply		                ply                          ; Get start of supplied string
20	.964e		18		clc		                clc                          ; Step to next string table entry
21	.964f		69 04		adc #$04	                adc #$04
22	.9651		c9 30		cmp #$30	                cmp #size(monthStrings) ; If not checked 48/4=12 entries, keep looking
23	.9653		90 43		bcc $9698	                bcc checkMonthString
24	.9655						rts9655:
25	.9655		60		rts		                rts                          ; Otherwise exit silently

27							;-------------------------------------------------------------------------
28							;
29							; OSWORD 15 (&0F) Write CMOS clock [MasRef D.3-24]
30							;
31	.9656						osword0F:
32	.9656		9c ed 02	stz $02ed	                stz osfileParameterBlock     ;got no time, got no date
33	.9659		49 0f		eor #$0f	                eor #15                     ; len=15, set date
34	.965b		f0 08		beq $9665	                beq setDate
35	.965d		49 07		eor #$07	                eor #15^8
36	.965f		f0 76		beq $96d7	                beq setTime
37	.9661		49 10		eor #$10	                eor #(15^8)^23
38	.9663		d0 f0		bne $9655	                bne rts9655

40							; Set date and set date+time
41							; --------------------------
42							; (&F0),1=>"Day,00 Mon 0000"
43							; (&F0),1=>"Day,00 Mon 0000.00:00:00"
44							; A=0, Y=0
45	.9665						setDate:
46	.9665		c8		iny		                iny                          ; Point to supplied data
47							; Translate day string into day number
48	.9666						checkDayString:
49	.9666		5a		phy		                phy                          ; Push pointer to data string
50	.9667		48		pha		                pha                          ; Push offset to match strings
51	.9668		aa		tax		                tax                          ; X=>match strings
52	.9669		a9 03		lda #$03	                lda #$03                     ; A=3 characters to match
53	.966b						checkDayStringLoop:
54	.966b		48		pha		                pha                          ; Save number of characters to match
55	.966c		b1 f0		lda ($f0),y	                lda (originalX),y      ; Get character from string
56	.966e		5d 68 97	eor $9768,x	                eor dayOfWeekStrings,x ; Compare with day string table
57	.9671		29 df		and #$df	                and #$DF                     ; Force to upper case
58	.9673		d0 cb		bne $9640	                bne nextDayString  ; No match step to check next entry
59	.9675		e8		inx		                inx                          ; Step to next character to match
60	.9676		c8		iny		                iny                          ; Step to next data character
61	.9677		68		pla		                pla                          ; Get character count back
62	.9678		3a		dec a		                dec a                        ; Decrement and loop until 3 characters matched
63	.9679		d0 f0		bne $966b	                bne checkDayStringLoop
64	.967b		bd 68 97	lda $9768,x	                lda dayOfWeekStrings,x ; Get translation byte from string table
65	.967e		8d f4 02	sta $02f4	                sta osfileParameterBlock+1+RTC.dayOfWeek ; Store it in workspace
66							; Translates Sun,Mon,Tue,etc to &01,&02,&03,etc
67	.9681		fa		plx		                plx                          ; Drop char count and table offset
68	.9682		fa		plx		                plx
69	.9683		b1 f0		lda ($f0),y	                lda ($F0),y                  ; Get next character
70	.9685		c9 2c		cmp #$2c	                cmp #','                     ; Not followed by a comma, so exit silently
71	.9687		d0 cc		bne $9655	                bne rts9655
72	.9689		a2 07		ldx #$07	                ldx #$07                     ; Get day of month
73	.968b		20 30 97	jsr $9730	                jsr readDecimalBCDByte
74	.968e		90 c5		bcc $9655	                bcc rts9655                    ; Bad number, exit silently
75	.9690		c8		iny		                iny                          ; Get next character
76	.9691		b1 f0		lda ($f0),y	                lda ($F0),y
77	.9693		49 20		eor #$20	                eor #' '                     ; Not space, exit silently
78	.9695		d0 be		bne $9655	                bne rts9655
79	.9697		c8		iny		                iny                          ; Step to first character of month
80							; Translate month string into month number
81							; This could use the same code as the Day translation
82	.9698						checkMonthString:
83	.9698		5a		phy		                phy                          ; Push pointer to data string
84	.9699		48		pha		                pha                          ; Push offset to match strings
85	.969a		aa		tax		                tax                          ; X=>match strings
86	.969b		a9 03		lda #$03	                lda #$03                     ; A=3 characters to match
87	.969d						checkMonthStringLoop:
88	.969d		48		pha		                pha
89	.969e		b1 f0		lda ($f0),y	                lda (originalX),y
90	.96a0		5d 84 97	eor $9784,x	                eor monthStrings,x
91	.96a3		29 df		and #$df	                and #$DF
92	.96a5		d0 a4		bne $964b	                bne nextMonthString
93	.96a7		e8		inx		                inx
94	.96a8		c8		iny		                iny
95	.96a9		68		pla		                pla
96	.96aa		3a		dec a		                dec a
97	.96ab		d0 f0		bne $969d	                bne checkMonthStringLoop
98	.96ad		bd 84 97	lda $9784,x	                lda monthStrings,x
99	.96b0		8d f6 02	sta $02f6	                sta osfileParameterBlock+1+RTC.month
100							; Translates Jan,Feb,Mar,etc to &01,&02,&03,etc..&09,&10,&11,&12
101	.96b3		fa		plx		                plx                          ; Drop char count and table offset
102	.96b4		fa		plx		                plx
103	.96b5		b1 f0		lda ($f0),y	                lda ($F0),y                  ; Get next character
104	.96b7		c9 20		cmp #$20	                cmp #' '                     ; Not followed by space, exit silently
105	.96b9		d0 9a		bne $9655	                bne rts9655
106	.96bb		a2 09		ldx #$09	                ldx #RTC.year
107	.96bd		20 30 97	jsr $9730	                jsr readDecimalBCDByte
108	.96c0		90 93		bcc $9655	                bcc rts9655                    ; Bad number, exit silently
109	.96c2		20 30 97	jsr $9730	                jsr readDecimalBCDByte                    ; Get year number
110	.96c5		90 8e		bcc $9655	                bcc rts9655                    ; Bad number, exit silently
111	.96c7		6e ed 02	ror $02ed	                ror osfileParameterBlock+0     ;got date
112	.96ca		b2 f0		lda ($f0)	                lda (originalX)        ; Get data length
113	.96cc		c9 0f		cmp #$0f	                cmp #$0F                     ; len=15, jump to just set date
114	.96ce		f0 2f		beq $96ff	                beq setRTCDate
115							; Must be len=24 to set date+time
116	.96d0		c8		iny		                iny                          ; Get next character
117	.96d1		b1 f0		lda ($f0),y	                lda (originalX),y
118	.96d3		c9 2e		cmp #$2e	                cmp #'.'                     ; If not full stop, exit silently
119	.96d5		d0 7c		bne $9753	                bne rts9753

121	.96d7						setTime:
122	.96d7		a2 04		ldx #$04	                ldx #RTC.hours
123	.96d9		20 30 97	jsr $9730	                jsr readDecimalBCDByte
124	.96dc		90 75		bcc $9753	                bcc rts9753
125	.96de		c8		iny		                iny
126	.96df		b1 f0		lda ($f0),y	                lda (originalX),y
127	.96e1		c9 3a		cmp #$3a	                cmp #':'
128	.96e3		d0 6e		bne $9753	                bne rts9753
129	.96e5		a2 02		ldx #$02	                ldx #RTC.minutes
130	.96e7		20 30 97	jsr $9730	                jsr readDecimalBCDByte
131	.96ea		90 67		bcc $9753	                bcc rts9753
132	.96ec		c8		iny		                iny
133	.96ed		b1 f0		lda ($f0),y	                lda (originalX),y
134	.96ef		c9 3a		cmp #$3a	                cmp #':'
135	.96f1		d0 60		bne $9753	                bne rts9753
136	.96f3		a2 00		ldx #$00	                ldx #RTC.seconds
137	.96f5		20 30 97	jsr $9730	                jsr readDecimalBCDByte
138	.96f8		90 59		bcc $9753	                bcc rts9753
139	.96fa		a9 40		lda #$40	                lda #$40
140	.96fc		0c ed 02	tsb $02ed	                tsb osfileParameterBlock+0   ;got time
141	.96ff						setRTCDate:
142	.96ff		58		cli		                cli
143	.9700		78		sei		                sei
144	.9701		a0 83		ldy #$83	                ldy #RTC.b.set|RTC.b._24h|RTC.b.dse
145	.9703		a2 0b		ldx #$0b	                ldx #RTC.b
146	.9705		20 e4 98	jsr $98e4	                jsr writeRTCByte
147	.9708		2c ed 02	bit $02ed	                bit osfileParameterBlock+0 ;N=1 if got date; V=1 if got time
148	.970b		10 0f		bpl $971c	                bpl setRTCTime ;taken if not got date - must then have time
149	.970d		a2 06		ldx #$06	                ldx #$06
150	.970f						-
151	.970f		bc ee 02	ldy $02ee,x	                ldy osfileParameterBlock+1,x
152	.9712		20 e4 98	jsr $98e4	                jsr writeRTCByte
153	.9715		e8		inx		                inx
154	.9716		e0 0a		cpx #$0a	                cpx #RTC.a
155	.9718		90 f5		bcc $970f	                bcc -
156	.971a		50 0d		bvc $9729	                bvc finishRTCUpdate                    ;taken if not got date
157	.971c						setRTCTime:
158	.971c		a2 00		ldx #$00	                ldx #RTC.seconds
159	.971e						-
160	.971e		bc ee 02	ldy $02ee,x	                ldy osfileParameterBlock+1,x
161	.9721		20 e4 98	jsr $98e4	                jsr writeRTCByte
162	.9724		e8		inx		                inx
163	.9725		e0 06		cpx #$06	                cpx #RTC.dayOfWeek
164	.9727		90 f5		bcc $971e	                bcc -
165	.9729						finishRTCUpdate:
166	.9729		a2 0b		ldx #$0b	                ldx #RTC.b
167	.972b		a0 02		ldy #$02	                ldy #RTC.b._24h
168	.972d		4c e4 98	jmp $98e4	                jmp writeRTCByte

170	.9730						readDecimalBCDByte:
171	.9730		20 54 97	jsr $9754	                jsr readDecimalDigit
172	.9733		49 20		eor #$20	                eor #$20         ;check for ' '
173	.9735		f0 04		beq $973b	                beq +        ;taken if leading space - that's fine
174	.9737		49 20		eor #$20	                eor #$20         ;reinstate old value
175	.9739		90 18		bcc $9753	                bcc rts9753      ;taken if non-space non-digits
176	.973b						+
177	.973b		9d ee 02	sta $02ee,x	                sta osfileParameterBlock+1,x
178	.973e		20 54 97	jsr $9754	                jsr readDecimalDigit
179	.9741		90 10		bcc $9753	                bcc rts9753                  ;taken if invalid digit

181							                ; rotate new digit into place
182	.9743		5a		phy		                phy
183	.9744		a0 04		ldy #$04	                ldy #$04
184	.9746		0a		asl a		                asl a
185	.9747		0a		asl a		                asl a
186	.9748		0a		asl a		                asl a
187	.9749		0a		asl a		                asl a
188	.974a						-
189	.974a		0a		asl a		                asl a
190	.974b		3e ee 02	rol $02ee,x	                rol osfileParameterBlock+1,x
191	.974e		88		dey		                dey
192	.974f		d0 f9		bne $974a	                bne -
193	.9751		7a		ply		                ply
194	.9752		38		sec		                sec
195	.9753						rts9753:
196	.9753		60		rts		                rts

198	.9754						readDecimalDigit:
199	.9754		c8		iny		                iny
200	.9755		b1 f0		lda ($f0),y	                lda (originalX),y
201	.9757		c9 3a		cmp #$3a	                cmp #'9'+1
202	.9759		b0 07		bcs $9762	                bcs notDecimalDigit
203	.975b		c9 30		cmp #$30	                cmp #'0'
204	.975d		90 03		bcc $9762	                bcc notDecimalDigit
205	.975f		29 0f		and #$0f	                and #$0F
206	.9761		60		rts		                rts

208	.9762						notDecimalDigit:
209	.9762		18		clc		                clc
210	.9763		60		rts		                rts
211							                .endif

213							;-------------------------------------------------------------------------

215							; TODO - is this necessary?
216							;
217							; There's a reference to dayOfWeekStrings-4, but that seems to be
218							; because days are 1-based. The data here is presumably never
219							; accesssed.
220	>9764		20 20 20 00			                .text "   ",0

222							;-------------------------------------------------------------------------

224	.9768						dayOfWeekStrings: .block
225	>9768		53 75 6e 01			                .text "Sun",$01
226	>976c		4d 6f 6e 02			                .text "Mon",$02
227	>9770		54 75 65 03			                .text "Tue",$03
228	>9774		57 65 64 04			                .text "Wed",$04
229	>9778		54 68 75 05			                .text "Thu",$05
230	>977c		46 72 69 06			                .text "Fri",$06
231	>9780		53 61 74 07			                .text "Sat",$07
232							                .endblock

234							;-------------------------------------------------------------------------

236	.9784						monthStrings: .block
237	>9784		4a 61 6e 01			                .text "Jan",$01
238	>9788		46 65 62 02			                .text "Feb",$02
239	>978c		4d 61 72 03			                .text "Mar",$03
240	>9790		41 70 72 04			                .text "Apr",$04
241	>9794		4d 61 79 05			                .text "May",$05
242	>9798		4a 75 6e 06			                .text "Jun",$06
243	>979c		4a 75 6c 07			                .text "Jul",$07
244	>97a0		41 75 67 08			                .text "Aug",$08
245	>97a4		53 65 70 09			                .text "Sep",$09
246	>97a8		4f 63 74 10			                .text "Oct",$10
247	>97ac		4e 6f 76 11			                .text "Nov",$11
248	>97b0		44 65 63 12			                .text "Dec",$12
249							                .endblock

251							;-------------------------------------------------------------------------

253							                .if version>=500
262							                .endif

264							;-------------------------------------------------------------------------

266							                .if version>=500
270							                .endif

272							;-------------------------------------------------------------------------
273							;
274							; OSWORD 14 (&0E) Read CMOS clock [MasRef D.3-22]
275							;

277	.97b4						osword0E:
278							                .if version<500
279	.97b4		48		pha		                pha                          ;save reason code
280	.97b5		49 02		eor #$02	                eor #$02                     ;
281	.97b7		d0 1b		bne $97d4	                bne readClock
325							                .endif

327							                ; Convert given time to string. Fill out the RTC temp
328							                ; data with the info from the parameter block, then
329							                ; pass on to the common code.
330	.97b9		a0 07		ldy #$07	                ldy #$07

332							                ; Copy hours, mins, secs.
333	.97bb		a2 00		ldx #$00	                ldx #$00
334	.97bd						-
335	.97bd		b1 f0		lda ($f0),y	                lda ($F0),y
336	.97bf		9d ee 02	sta $02ee,x	                sta osfileParameterBlock+1,x
337	.97c2		88		dey		                dey
338	.97c3		e8		inx		                inx
339	.97c4		e8		inx		                inx
340	.97c5		e0 06		cpx #$06	                cpx #$06
341	.97c7		90 f4		bcc $97bd	                bcc -

343							                ; Copy day of week, day of month, month, year.
344	.97c9						-
345	.97c9		b1 f0		lda ($f0),y	                lda (originalX),y
346	.97cb		9d ee 02	sta $02ee,x	                sta osfileParameterBlock+1,x
347	.97ce		e8		inx		                inx
348	.97cf		88		dey		                dey
349	.97d0		d0 f7		bne $97c9	                bne -

351							                .if version<500
352	.97d2		80 30		bra $9804	                bra maybeConvertToString ; (called from here, there's no maybe about it)

354	.97d4						readClock:
355	.97d4		a5 f0		lda $f0		                lda originalX
356	.97d6		48		pha		                pha
357	.97d7		a5 f1		lda $f1		                lda originalY
358	.97d9		48		pha		                pha
359	.97da						readRTCClock:
360	.97da		a2 0c		ldx #$0c	                ldx #RTC.c
361	.97dc		20 b7 98	jsr $98b7	                jsr readRTCByte ;clear the various IRQ flags with a read of register C
362	.97df		a2 09		ldx #$09	                ldx #RTC.year
363	.97e1						-
364	.97e1		20 b7 98	jsr $98b7	                jsr readRTCByte
365	.97e4		9d ee 02	sta $02ee,x	                sta osfileParameterBlock+1,x
366	.97e7		ca		dex		                dex
367	.97e8		10 f7		bpl $97e1	                bpl -
368	.97ea		a2 0a		ldx #$0a	                ldx #RTC.a
369	.97ec		20 b7 98	jsr $98b7	                jsr readRTCByte
370	.97ef		10 04		bpl $97f5	                bpl L97F5 ;taken if update not in progress - result is good
371	.97f1						retryReadRTCClock:
372	.97f1		58		cli		                cli
373	.97f2		78		sei		                sei
374	.97f3		80 e5		bra $97da	                bra readRTCClock

376	.97f5						L97F5:
377	.97f5		a2 0c		ldx #$0c	                ldx #RTC.c
378	.97f7		20 b7 98	jsr $98b7	                jsr readRTCByte
379	.97fa		29 10		and #$10	                and #RTC.c.uf
380	.97fc		d0 f3		bne $97f1	                bne retryReadRTCClock
381	.97fe		68		pla		                pla
382	.97ff		85 f1		sta $f1		                sta originalY
383	.9801		68		pla		                pla
384	.9802		85 f0		sta $f0		                sta originalX
385	.9804						maybeConvertToString:
386	.9804		68		pla		                pla                          ;get reason code
387	.9805		3a		dec a		                dec a
388	.9806		d0 1a		bne $9822	                bne convertTimeToString                    ;taken if 0 or 2

390							                ; Copy year, month, day of month, day of week.
391	.9808		a0 00		ldy #$00	                ldy #$00
392	.980a		a2 09		ldx #$09	                ldx #RTC.year
393	.980c						-
394	.980c		bd ee 02	lda $02ee,x	                lda osfileParameterBlock+1,x
395	.980f		91 f0		sta ($f0),y	                sta (originalX),y
396	.9811		c8		iny		                iny
397	.9812		ca		dex		                dex
398	.9813		e0 06		cpx #$06	                cpx #RTC.dayOfWeek
399	.9815		b0 f5		bcs $980c	                bcs -

401							                ; Copy hours, minutes, seconds.
402	.9817						-
403	.9817		bd ed 02	lda $02ed,x	                lda osfileParameterBlock,x
404	.981a		91 f0		sta ($f0),y	                sta (originalX),y
405	.981c		c8		iny		                iny
406	.981d		ca		dex		                dex
407	.981e		ca		dex		                dex
408	.981f		10 f6		bpl $9817	                bpl -
409	.9821		60		rts		                rts

411							                .endif

413	.9822						convertTimeToString:
414							                ; Store terminating CR.
415	.9822		a0 18		ldy #$18	                ldy #ClockStringFormat.cr
416	.9824		a9 0d		lda #$0d	                lda #13
417	.9826		91 f0		sta ($f0),y	                sta (originalX),y
418	.9828		a2 00		ldx #$00	                ldx #$00
419	.982a		88		dey		                dey
420	.982b		20 90 98	jsr $9890	                jsr storeRTCDataByteString
421	.982e		a9 3a		lda #$3a	                lda #':'
422	.9830		91 f0		sta ($f0),y	                sta (originalX),y
423	.9832		a0 12		ldy #$12	                ldy #ClockStringFormat.hh+2
424	.9834		91 f0		sta ($f0),y	                sta (originalX),y
425	.9836		a2 02		ldx #$02	                ldx #RTC.minutes
426	.9838		a0 14		ldy #$14	                ldy #ClockStringFormat.mm+1
427	.983a		20 90 98	jsr $9890	                jsr storeRTCDataByteString
428	.983d		a2 04		ldx #$04	                ldx #RTC.hours
429	.983f		a0 11		ldy #$11	                ldy #ClockStringFormat.hh+1
430	.9841		20 90 98	jsr $9890	                jsr storeRTCDataByteString
431	.9844		a9 2e		lda #$2e	                lda #'.'
432	.9846		91 f0		sta ($f0),y	                sta (originalX),y
433	.9848		ad f4 02	lda $02f4	                lda osfileParameterBlock+1+RTC.dayOfWeek;
434	.984b		0a		asl a		                asl a
435	.984c		0a		asl a		                asl a
436	.984d		a0 00		ldy #$00	                ldy #$00
437	.984f		aa		tax		                tax
438	.9850						-
439	.9850		bd 64 97	lda $9764,x	                lda dayOfWeekStrings-4,x     ;-4 as 1=Sunday
440	.9853		91 f0		sta ($f0),y	                sta (originalX),y
441	.9855		e8		inx		                inx
442	.9856		c8		iny		                iny
443	.9857		c0 03		cpy #$03	                cpy #$03
444	.9859		90 f5		bcc $9850	                bcc -
445	.985b		a9 2c		lda #$2c	                lda #','
446	.985d		91 f0		sta ($f0),y	                sta (originalX),y
447	.985f		ad f6 02	lda $02f6	                lda osfileParameterBlock+1+RTC.month
448	.9862		c9 10		cmp #$10	                cmp #$10
449	.9864		90 02		bcc $9868	                bcc +
450	.9866		e9 06		sbc #$06	                sbc #$06            ;convert $10, $11 and $12 from BCD
451	.9868						+
452	.9868		3a		dec a		                dec a                        ;make month 0-based
453	.9869		0a		asl a		                asl a
454	.986a		0a		asl a		                asl a
455	.986b		aa		tax		                tax
456	.986c		a0 07		ldy #$07	                ldy #ClockStringFormat.mmm
457	.986e						-
458	.986e		bd 84 97	lda $9784,x	                lda monthStrings,x
459	.9871		91 f0		sta ($f0),y	                sta ($F0),y
460	.9873		e8		inx		                inx
461	.9874		c8		iny		                iny
462	.9875		c0 0a		cpy #$0a	                cpy #ClockStringFormat.mmm+3
463	.9877		90 f5		bcc $986e	                bcc -
464	.9879		a2 09		ldx #$09	                ldx #RTC.year
465	.987b		a0 0e		ldy #$0e	                ldy #ClockStringFormat.yyyy+3
466	.987d		20 90 98	jsr $9890	                jsr storeRTCDataByteString
467							                .if multios
468	.9880		20 e0 b8	jsr $b8e0	                jsr fixUpYear
469	.9883		ea		nop		                nop
470	.9884		ea		nop		                nop
474							                .endif
475	.9885		a9 20		lda #$20	                lda #$20
476	.9887		91 f0		sta ($f0),y	                sta ($F0),y
477	.9889		a0 06		ldy #$06	                ldy #ClockStringFormat.nn+2
478	.988b		91 f0		sta ($f0),y	                sta ($F0),y
479	.988d		88		dey		                dey
480	.988e		a2 07		ldx #$07	                ldx #RTC.dayOfMonth
481	.9890						storeRTCDataByteString:
482	.9890		bd ee 02	lda $02ee,x	                lda osfileParameterBlock+1,x
483	.9893						storeBCDByteString:
484	.9893		48		pha		                pha
485	.9894		20 9c 98	jsr $989c	                jsr storeNybbleString
486	.9897		68		pla		                pla
487							                .if version==350
489							                .else
490	.9898		4a		lsr a		                lsr a
491	.9899		4a		lsr a		                lsr a
492	.989a		4a		lsr a		                lsr a
493	.989b		4a		lsr a		                lsr a
494							                .endif
495	.989c						storeNybbleString:
496	.989c		29 0f		and #$0f	                and #$0F
497	.989e		09 30		ora #$30	                ora #'0'
498	.98a0		c9 3a		cmp #$3a	                cmp #'9'+1
499	.98a2		90 02		bcc $98a6	                bcc +
500	.98a4		69 06		adc #$06	                adc #('A'-'9'-1)-1           ;(-1 because C set)
501	.98a6						+
502	.98a6		91 f0		sta ($f0),y	                sta (originalX),y
503	.98a8		88		dey		                dey
504	.98a9		60		rts		                rts

506							;-------------------------------------------------------------------------

508							                .if version<500
509							                .if version==350
512							                .endif
513	.98aa						readDefaults2:
514	.98aa		a2 1d		ldx #$1d	                ldx #CMOSBytes.defaults2+cmosBytesOffset
515	.98ac		80 09		bra $98b7	                bra readRTCByte
516							                .endif

518							;-------------------------------------------------------------------------

520							                .if version<500
521	.98ae						readDefaults3:
522							                .if version==350
525							                .endif
526	.98ae		a2 1e		ldx #$1e	                ldx #CMOSBytes.defaults3+cmosBytesOffset
527	.98b0		80 05		bra $98b7	                bra readRTCByte
528							                .endif

530							;-------------------------------------------------------------------------
531							;
532							; Read byte from RTC, either by 0-based CMOS RAM offset (readCMOSByte)
533							; or by RTC register index (readRTCByte).
534							;
535							; entry:
536							;
537							; X = address to read from
538							;
539							; exit:
540							;
541							; A = byte read
542							;
543							; N,Z = set as per byte read
544							;
545							                .if version<500
546	.98b2						readCMOSByte:
547	.98b2		20 fd 98	jsr $98fd	                jsr getRTCAddressForCMOSByte
548							                .if version==350
551							                .else
552	.98b5		b0 24		bcs $98db	                bcs rts98DB                  ;taken if invalid address
553							                .endif
554							                .if version==350
557							                .endif
558	.98b7						readRTCByte:
559	.98b7		08		php		                php
560	.98b8		78		sei		                sei
561	.98b9		20 06 99	jsr $9906	                jsr setRTCAddress
562	.98bc		a9 49		lda #$49	                lda #$49
563	.98be		8d 40 fe	sta $fe40	                sta systemVIA.orb
564	.98c1		9c 43 fe	stz $fe43	                stz systemVIA.ddra
565	.98c4		a9 4a		lda #$4a	                lda #$4A
566	.98c6		8d 40 fe	sta $fe40	                sta systemVIA.orb
567	.98c9		ac 4f fe	ldy $fe4f	                ldy systemVIA.iraNoHandshake ;read value
568	.98cc						deselectRTC:
569	.98cc		a9 42		lda #$42	                lda #$42
570	.98ce		8d 40 fe	sta $fe40	                sta systemVIA.orb            ;RTC AS=0 CS=1 DS=0 R=0
571	.98d1		a9 02		lda #$02	                lda #$02
572	.98d3		8d 40 fe	sta $fe40	                sta systemVIA.orb            ;RTC AS=0 CS=0 DS=0 R=0
573	.98d6		9c 43 fe	stz $fe43	                stz systemVIA.ddra           ;all bits inputs
574	.98d9		28		plp		                plp
575	.98da		98		tya		                tya
576	.98db						rts98DB:
577	.98db		60		rts		                rts
578							                .endif

580							;-------------------------------------------------------------------------
581							;
582							; Write byte to RTC, either by 0-based CMOS RAM offset (writeCMOSByte)
583							; or by RTC register index (writeRTCByte).
584							;
585							; (For some reason, writeCMOSByte can't be used to write to CMOS RAM
586							; offset 0.)
587							;
588							; entry:
589							;
590							; X = address to write to
591							;
592							; Y = value to write
593							;
594							                .if version<500
595	.98dc						writeCMOSByte:
596	.98dc		8a		txa		                txa
597	.98dd		f0 fc		beq $98db	                beq rts98DB
598	.98df		20 fd 98	jsr $98fd	                jsr getRTCAddressForCMOSByte
599	.98e2		b0 f7		bcs $98db	                bcs rts98DB
600	.98e4						writeRTCByte:
601	.98e4		08		php		                php
602	.98e5		78		sei		                sei
603	.98e6		20 06 99	jsr $9906	                jsr setRTCAddress            ;X=address
604	.98e9		a9 41		lda #$41	                lda #$41
605	.98eb		8d 40 fe	sta $fe40	                sta systemVIA.orb            ;RTC AS=0 CS=1 DS=0 R=0
606	.98ee		a9 ff		lda #$ff	                lda #$FF
607	.98f0		8d 43 fe	sta $fe43	                sta systemVIA.ddra           ;all bits outputs
608	.98f3		a9 4a		lda #$4a	                lda #$4A
609	.98f5		8d 40 fe	sta $fe40	                sta systemVIA.orb            ;RTC AS=0 CS=1 DS=0 R=1
610	.98f8		8c 4f fe	sty $fe4f	                sty systemVIA.oraNoHandshake ;store value
611	.98fb		80 cf		bra $98cc	                bra deselectRTC
612							                .endif

614							;-------------------------------------------------------------------------
615							;
616							; Convert CMOS byte offset to actual RTC address.
617							;
618							; entry:
619							;
620							; X = CMOS byte offset - 0-49
621							;
622							; exit:
623							;
624							; C=1 = invalid address
625							;
626							; C=0 = valid address: X = register index
627							;
628							                .if version<500
629	.98fd						getRTCAddressForCMOSByte:
630	.98fd		e0 32		cpx #$32	                cpx #size(RTC.ram)
631	.98ff		b0 04		bcs $9905	                bcs rts9905
632	.9901		8a		txa		                txa
633	.9902		69 0e		adc #$0e	                adc #RTC.ram
634	.9904		aa		tax		                tax
635	.9905						rts9905:
636	.9905		60		rts		                rts
637							                .endif

639							;-------------------------------------------------------------------------
640							;
641							; set RTC address for future read/write operation.
642							;
643							; entry:
644							;
645							; X = address to set
646							;
647							; preserves: Y
648							;
649							                .if version<500
650	.9906						setRTCAddress:
651	.9906		a9 02		lda #$02	                lda #$02
652	.9908		8d 40 fe	sta $fe40	                sta systemVIA.orb            ;RTC AS=0 CS=0 DS=0 R=0
653	.990b		a9 82		lda #$82	                lda #$82
654	.990d		8d 40 fe	sta $fe40	                sta systemVIA.orb            ;RTC AS=1 CS=0 DS=0 R=0
655	.9910		a9 ff		lda #$ff	                lda #$FF
656	.9912		8d 43 fe	sta $fe43	                sta systemVIA.ddra           ;all bits outputs
657	.9915		8e 4f fe	stx $fe4f	                stx systemVIA.oraNoHandshake ;write RTC address
658	.9918		a9 c2		lda #$c2	                lda #$c2
659	.991a		8d 40 fe	sta $fe40	                sta systemVIA.orb            ;RTC AS=1 CS=1 DS=0 R=0
660	.991d		a9 42		lda #$42	                lda #$42
661	.991f		8d 40 fe	sta $fe40	                sta systemVIA.orb            ;RTC AS=0 CS=1 DS=0 R=0
662	.9922						rts9922:
663	.9922		60		rts		                rts
664							                .endif

:6	;******  Return to file: src/terminal.s65

2520							                .endif

2522							;-------------------------------------------------------------------------

2524	.9923						L9923:
2525	.9923		a9 03		lda #$03	                lda #$03
2526	.9925		20 98 d2	jsr $d298	                jsr mos.LD298
2527	.9928		90 12		bcc $993c	                bcc L993C
2528	.992a		20 30 99	jsr $9930	                jsr L9930
2529	.992d		20 a9 d8	jsr $d8a9	                jsr mos.LD8A9
2530	.9930						L9930:
2531	.9930		a2 20		ldx #$20	                ldx #$20
2532	.9932		4c b8 e2	jmp $e2b8	                jmp mos.LE2B8

2534	.9935						L9935:
2535	.9935		a9 02		lda #$02	                lda #$02
2536	.9937		20 98 d2	jsr $d298	                jsr mos.LD298
2537	.993a		b0 64		bcs $99a0	                bcs L99A0
2538	.993c						L993C:
2539	.993c		20 d2 d3	jsr $d3d2	                jsr mos.LD3D2
2540	.993f		20 bf 9a	jsr $9abf	                jsr L9ABF
2541	.9942		80 08		bra $994c	                bra L994C

2543	.9944						L9944:
2544	.9944		20 1a d4	jsr $d41a	                jsr mos.LD41A
2545	.9947		f0 57		beq $99a0	                beq L99A0
2546	.9949		20 d2 d3	jsr $d3d2	                jsr mos.LD3D2
2547	.994c						L994C:
2548	.994c		a5 e1		lda $e1		                lda $E1
2549	.994e		89 20		bit #$20	                bit #$20
2550	.9950		f0 05		beq $9957	                beq L9957
2551	.9952		48		pha		                pha
2552	.9953		20 a3 d6	jsr $d6a3	                jsr mos.LD6A3
2553	.9956		68		pla		                pla
2554	.9957						L9957:
2555	.9957		89 10		bit #$10	                bit #$10
2556	.9959		f0 03		beq $995e	                beq L995E
2557	.995b		20 98 d6	jsr $d698	                jsr mos.LD698
2558	.995e						L995E:
2559	.995e		20 fc 99	jsr $99fc	                jsr L99FC
2560	.9961		08		php		                php
2561	.9962		20 5a 9a	jsr $9a5a	                jsr L9A5A
2562	.9965		a2 42		ldx #$42	                ldx #$42
2563	.9967		a0 46		ldy #$46	                ldy #$46
2564	.9969		a9 20		lda #$20	                lda #$20
2565	.996b		2c 49 88	bit $8849	                bit L8849
2566	.996e		f0 1c		beq $998c	                beq L998C
2567	.9970		30 18		bmi $998a	                bmi L998A
2568	.9972		ad 2c 03	lda $032c	                lda $032C
2569	.9975		cd 37 03	cmp $0337	                cmp $0337
2570	.9978		d0 08		bne $9982	                bne L9982
2571	.997a		ad 2d 03	lda $032d	                lda $032D
2572	.997d		cd 38 03	cmp $0338	                cmp $0338
2573	.9980		f0 10		beq $9992	                beq L9992
2574	.9982						L9982:
2575	.9982		a2 37		ldx #$37	                ldx #$37
2576	.9984		20 4d d2	jsr $d24d	                jsr mos.LD24D
2577	.9987		a2 42		ldx #$42	                ldx #$42
2578	.9989		b8		clv		                clv
2579	.998a						L998A:
2580	.998a		a0 2c		ldy #$2c	                ldy #$2C
2581	.998c						L998C:
2582	.998c		30 07		bmi $9995	                bmi L9995
2583	.998e		50 02		bvc $9992	                bvc L9992
2584	.9990		a2 37		ldx #$37	                ldx #$37
2585	.9992						L9992:
2586	.9992		20 4d d2	jsr $d24d	                jsr mos.LD24D
2587	.9995						L9995:
2588	.9995		28		plp		                plp
2589	.9996		90 b4		bcc $994c	                bcc L994C
2590	.9998		60		rts		                rts

2592	.9999						L9999:
2593	.9999		a9 01		lda #$01	                lda #$01
2594	.999b		20 98 d2	jsr $d298	                jsr mos.LD298
2595	.999e		90 09		bcc $99a9	                bcc L99A9
2596	.99a0						L99A0:
2597	.99a0		a2 24		ldx #$24	                ldx #$24
2598	.99a2		80 37		bra $99db	                bra L99DB

2600	.99a4						L99A4:
2601	.99a4		20 1a d4	jsr $d41a	                jsr mos.LD41A
2602	.99a7		f0 f7		beq $99a0	                beq L99A0
2603	.99a9						L99A9:
2604	.99a9		20 d2 d3	jsr $d3d2	                jsr mos.LD3D2
2605	.99ac		20 c9 99	jsr $99c9	                jsr L99C9
2606	.99af						L99AF:
2607	.99af		20 e6 d5	jsr $d5e6	                jsr mos.LD5E6
2608	.99b2		20 c9 99	jsr $99c9	                jsr L99C9
2609	.99b5		ad 30 88	lda $8830	                lda L8830
2610	.99b8		0d 31 88	ora $8831	                ora L8831
2611	.99bb		f0 3e		beq $99fb	                beq L99FB
2612	.99bd		2c 48 88	bit $8848	                bit L8848
2613	.99c0		70 ed		bvs $99af	                bvs L99AF
2614	.99c2		a2 42		ldx #$42	                ldx #$42
2615	.99c4		20 d6 99	jsr $99d6	                jsr L99D6
2616	.99c7		80 e6		bra $99af	                bra L99AF

2618	.99c9						L99C9:
2619	.99c9		20 34 d3	jsr $d334	                jsr mos.LD334
2620	.99cc		20 de 99	jsr $99de	                jsr L99DE
2621	.99cf		2c 48 88	bit $8848	                bit L8848
2622	.99d2		30 27		bmi $99fb	                bmi L99FB
2623	.99d4		a2 46		ldx #$46	                ldx #$46
2624	.99d6						L99D6:
2625	.99d6		da		phx		                phx
2626	.99d7		20 80 d2	jsr $d280	                jsr mos.LD280
2627	.99da		fa		plx		                plx
2628	.99db						L99DB:
2629	.99db		4c 4c db	jmp $db4c	                jmp mos.LDB4C

2631	.99de						L99DE:
2632	.99de		a2 03		ldx #$03	                ldx #$03
2633	.99e0						L99E0:
2634	.99e0		bd 30 88	lda $8830,x	                lda L8830,x
2635	.99e3		9d 42 03	sta $0342,x	                sta $0342,x
2636	.99e6		9d 46 03	sta $0346,x	                sta $0346,x
2637	.99e9		ca		dex		                dex
2638	.99ea		10 f4		bpl $99e0	                bpl L99E0
2639	.99ec						L99EC:
2640	.99ec		ac 42 03	ldy $0342	                ldy $0342
2641	.99ef		ad 43 03	lda $0343	                lda $0343
2642	.99f2		20 2e c9	jsr $c92e	                jsr mos.negateAY
2643	.99f5		8c 42 03	sty $0342	                sty $0342
2644	.99f8		8d 43 03	sta $0343	                sta $0343
2645	.99fb						L99FB:
2646	.99fb		60		rts		                rts

2648	.99fc						L99FC:
2649	.99fc		a5 e1		lda $e1		                lda $E1
2650	.99fe		8d 49 88	sta $8849	                sta L8849
2651	.9a01		20 de 99	jsr $99de	                jsr L99DE
2652	.9a04		a2 01		ldx #$01	                ldx #$01
2653	.9a06						L9A06:
2654	.9a06		9e 42 03	stz $0342,x	                stz $0342,x
2655	.9a09		9e 46 03	stz $0346,x	                stz $0346,x
2656	.9a0c		ca		dex		                dex
2657	.9a0d		10 f7		bpl $9a06	                bpl L9A06
2658	.9a0f						L9A0F:
2659	.9a0f		20 2e 9a	jsr $9a2e	                jsr L9A2E
2660	.9a12		ad 30 88	lda $8830	                lda L8830
2661	.9a15		0d 31 88	ora $8831	                ora L8831
2662	.9a18		d0 06		bne $9a20	                bne L9A20
2663	.9a1a		38		sec		                sec
2664	.9a1b		ad 47 88	lda $8847	                lda L8847
2665	.9a1e		d0 cc		bne $99ec	                bne L99EC
2666	.9a20						L9A20:
2667	.9a20		20 e6 d5	jsr $d5e6	                jsr mos.LD5E6
2668	.9a23		ad 32 88	lda $8832	                lda L8832
2669	.9a26		cd 44 03	cmp $0344	                cmp $0344
2670	.9a29		f0 e4		beq $9a0f	                beq L9A0F
2671	.9a2b		18		clc		                clc
2672	.9a2c		80 be		bra $99ec	                bra L99EC

2674	.9a2e						L9A2E:
2675	.9a2e		20 34 d3	jsr $d334	                jsr mos.LD334
2676	.9a31		2c 48 88	bit $8848	                bit L8848
2677	.9a34		30 07		bmi $9a3d	                bmi L9A3D
2678	.9a36		08		php		                php
2679	.9a37		a2 46		ldx #$46	                ldx #$46
2680	.9a39		20 41 9a	jsr $9a41	                jsr L9A41
2681	.9a3c		28		plp		                plp
2682	.9a3d						L9A3D:
2683	.9a3d		70 1a		bvs $9a59	                bvs L9A59
2684	.9a3f		a2 42		ldx #$42	                ldx #$42
2685	.9a41						L9A41:
2686	.9a41		ad 30 88	lda $8830	                lda L8830
2687	.9a44		a8		tay		                tay
2688	.9a45		dd 00 03	cmp $0300,x	                cmp $0300,x
2689	.9a48		ad 31 88	lda $8831	                lda L8831
2690	.9a4b		48		pha		                pha
2691	.9a4c		fd 01 03	sbc $0301,x	                sbc $0301,x
2692	.9a4f		68		pla		                pla
2693	.9a50		90 07		bcc $9a59	                bcc L9A59
2694	.9a52		9d 01 03	sta $0301,x	                sta $0301,x
2695	.9a55		98		tya		                tya
2696	.9a56		9d 00 03	sta $0300,x	                sta $0300,x
2697	.9a59						L9A59:
2698	.9a59		60		rts		                rts

2700	.9a5a						L9A5A:
2701	.9a5a		ad 44 03	lda $0344	                lda $0344
2702	.9a5d		0d 45 03	ora $0345	                ora $0345
2703	.9a60		d0 5c		bne $9abe	                bne L9ABE
2704	.9a62		a5 e1		lda $e1		                lda $E1
2705	.9a64		1a		inc a		                inc a
2706	.9a65		29 03		and #$03	                and #$03
2707	.9a67		d0 55		bne $9abe	                bne L9ABE
2708	.9a69		a9 20		lda #$20	                lda #$20
2709	.9a6b		2c 49 88	bit $8849	                bit L8849
2710	.9a6e		10 09		bpl $9a79	                bpl L9A79
2711	.9a70		f0 07		beq $9a79	                beq L9A79
2712	.9a72		a2 2c		ldx #$2c	                ldx #$2C
2713	.9a74		a0 46		ldy #$46	                ldy #$46
2714	.9a76		20 1e c9	jsr $c91e	                jsr mos.copyFourBytesWithinVDUVariables
2715	.9a79						L9A79:
2716	.9a79		a9 10		lda #$10	                lda #$10
2717	.9a7b		2c 49 88	bit $8849	                bit L8849
2718	.9a7e		50 09		bvc $9a89	                bvc L9A89
2719	.9a80		f0 07		beq $9a89	                beq L9A89
2720	.9a82		a2 37		ldx #$37	                ldx #$37
2721	.9a84		a0 42		ldy #$42	                ldy #$42
2722	.9a86		20 1e c9	jsr $c91e	                jsr mos.copyFourBytesWithinVDUVariables
2723	.9a89						L9A89:
2724	.9a89		20 bf 9a	jsr $9abf	                jsr L9ABF
2725	.9a8c		a5 e1		lda $e1		                lda $E1
2726	.9a8e		49 3c		eor #$3c	                eor #$3C
2727	.9a90		2a		rol a		                rol a
2728	.9a91		20 6f c6	jsr $c66f	                jsr mos.fixUpVPALETTEFor4Colours
2729	.9a94		6a		ror a		                ror a
2730	.9a95		85 e1		sta $e1		                sta $E1
2731	.9a97		89 20		bit #$20	                bit #$20
2732	.9a99		f0 10		beq $9aab	                beq L9AAB
2733	.9a9b		48		pha		                pha
2734	.9a9c		a2 2c		ldx #$2c	                ldx #$2C
2735	.9a9e		a0 46		ldy #$46	                ldy #$46
2736	.9aa0		20 cc d5	jsr $d5cc	                jsr mos.sortVDUVariableWords
2737	.9aa3		98		tya		                tya
2738	.9aa4		aa		tax		                tax
2739	.9aa5		a0 46		ldy #$46	                ldy #$46
2740	.9aa7		20 1e c9	jsr $c91e	                jsr mos.copyFourBytesWithinVDUVariables
2741	.9aaa		68		pla		                pla
2742	.9aab						L9AAB:
2743	.9aab		89 10		bit #$10	                bit #$10
2744	.9aad		f0 0c		beq $9abb	                beq L9ABB
2745	.9aaf		a2 37		ldx #$37	                ldx #$37
2746	.9ab1		a0 42		ldy #$42	                ldy #$42
2747	.9ab3		20 cc d5	jsr $d5cc	                jsr mos.sortVDUVariableWords
2748	.9ab6		a0 42		ldy #$42	                ldy #$42
2749	.9ab8		20 1e c9	jsr $c91e	                jsr mos.copyFourBytesWithinVDUVariables
2750	.9abb						L9ABB:
2751	.9abb		9c 49 88	stz $8849	                stz L8849
2752	.9abe						L9ABE:
2753	.9abe		60		rts		                rts

2755	.9abf						L9ABF:
2756	.9abf		a2 03		ldx #$03	                ldx #$03
2757	.9ac1						L9AC1:
2758	.9ac1		9e 3b 03	stz $033b,x	                stz $033B,x
2759	.9ac4		ca		dex		                dex
2760	.9ac5		10 fa		bpl $9ac1	                bpl L9AC1
2761	.9ac7		a0 28		ldy #$28	                ldy #$28
2762	.9ac9		a2 1b		ldx #$1b	                ldx #$1B
2763	.9acb		a9 2c		lda #$2c	                lda #$2C
2764	.9acd		20 df 9a	jsr $9adf	                jsr L9ADF
2765	.9ad0		20 a8 d6	jsr $d6a8	                jsr mos.LD6A8
2766	.9ad3		a0 1b		ldy #$1b	                ldy #$1B
2767	.9ad5		a2 28		ldx #$28	                ldx #$28
2768	.9ad7		a9 37		lda #$37	                lda #$37
2769	.9ad9		20 df 9a	jsr $9adf	                jsr L9ADF
2770	.9adc		4c 9d d6	jmp $d69d	                jmp mos.LD69D

2772	.9adf						L9ADF:
2773	.9adf		48		pha		                pha
2774	.9ae0		a5 e1		lda $e1		                lda $E1
2775	.9ae2		4a		lsr a		                lsr a
2776	.9ae3		90 0b		bcc $9af0	                bcc L9AF0
2777	.9ae5		ad 47 88	lda $8847	                lda L8847
2778	.9ae8		d0 04		bne $9aee	                bne L9AEE
2779	.9aea		a2 3b		ldx #$3b	                ldx #$3B
2780	.9aec		80 02		bra $9af0	                bra L9AF0

2782	.9aee						L9AEE:
2783	.9aee		a0 3b		ldy #$3b	                ldy #$3B
2784	.9af0						L9AF0:
2785	.9af0		8a		txa		                txa
2786	.9af1		fa		plx		                plx
2787	.9af2		da		phx		                phx
2788	.9af3		48		pha		                pha
2789	.9af4		5a		phy		                phy
2790	.9af5		a8		tay		                tay
2791	.9af6		a9 03		lda #$03	                lda #$03
2792	.9af8		85 da		sta $da		                sta $DA
2793	.9afa						L9AFA:
2794	.9afa		b9 00 03	lda $0300,y	                lda $0300,y
2795	.9afd		9d 1e 88	sta $881e,x	                sta L881E,x
2796	.9b00		c8		iny		                iny
2797	.9b01		e8		inx		                inx
2798	.9b02		c6 da		dec $da		                dec $DA
2799	.9b04		10 f4		bpl $9afa	                bpl L9AFA
2800	.9b06		7a		ply		                ply
2801	.9b07		68		pla		                pla
2802	.9b08		fa		plx		                plx
2803	.9b09						L9B09:
2804	.9b09		48		pha		                pha
2805	.9b0a		5a		phy		                phy
2806	.9b0b		20 61 9b	jsr $9b61	                jsr L9B61
2807	.9b0e		ca		dex		                dex
2808	.9b0f		7a		ply		                ply
2809	.9b10		68		pla		                pla
2810	.9b11		da		phx		                phx
2811	.9b12		c8		iny		                iny
2812	.9b13		c8		iny		                iny
2813	.9b14		1a		inc a		                inc a
2814	.9b15		1a		inc a		                inc a
2815	.9b16		e8		inx		                inx
2816	.9b17		e8		inx		                inx
2817	.9b18		20 61 9b	jsr $9b61	                jsr L9B61
2818	.9b1b		fa		plx		                plx
2819	.9b1c		20 90 9b	jsr $9b90	                jsr L9B90
2820	.9b1f		08		php		                php
2821	.9b20		48		pha		                pha
2822	.9b21		bd 05 03	lda $0305,x	                lda $0305,x
2823	.9b24		0a		asl a		                asl a
2824	.9b25		7e 0a 03	ror $030a,x	                ror $030A,x
2825	.9b28		10 03		bpl $9b2d	                bpl L9B2D
2826	.9b2a		20 7f 9b	jsr $9b7f	                jsr L9B7F
2827	.9b2d						L9B2D:
2828	.9b2d		68		pla		                pla
2829	.9b2e		0a		asl a		                asl a
2830	.9b2f		7e 0a 03	ror $030a,x	                ror $030A,x
2831	.9b32		10 07		bpl $9b3b	                bpl L9B3B
2832	.9b34		e8		inx		                inx
2833	.9b35		e8		inx		                inx
2834	.9b36		20 7f 9b	jsr $9b7f	                jsr L9B7F
2835	.9b39		ca		dex		                dex
2836	.9b3a		ca		dex		                dex
2837	.9b3b						L9B3B:
2838	.9b3b		20 90 9b	jsr $9b90	                jsr L9B90
2839	.9b3e		10 06		bpl $9b46	                bpl L9B46
2840	.9b40		bd 05 03	lda $0305,x	                lda $0305,x
2841	.9b43		bc 04 03	ldy $0304,x	                ldy $0304,x
2842	.9b46						L9B46:
2843	.9b46		28		plp		                plp
2844	.9b47		30 06		bmi $9b4f	                bmi L9B4F
2845	.9b49		c0 00		cpy #$00	                cpy #$00
2846	.9b4b		d0 01		bne $9b4e	                bne L9B4E
2847	.9b4d		3a		dec a		                dec a
2848	.9b4e						L9B4E:
2849	.9b4e		88		dey		                dey
2850	.9b4f						L9B4F:
2851	.9b4f		4a		lsr a		                lsr a
2852	.9b50		48		pha		                pha
2853	.9b51		98		tya		                tya
2854	.9b52		6a		ror a		                ror a
2855	.9b53		38		sec		                sec
2856	.9b54		ca		dex		                dex
2857	.9b55		20 5a 9b	jsr $9b5a	                jsr L9B5A
2858	.9b58		e8		inx		                inx
2859	.9b59		68		pla		                pla
2860	.9b5a						L9B5A:
2861	.9b5a		fd 07 03	sbc $0307,x	                sbc $0307,x
2862	.9b5d		9d 09 03	sta $0309,x	                sta $0309,x
2863	.9b60		60		rts		                rts

2865	.9b61						L9B61:
2866	.9b61		48		pha		                pha
2867	.9b62		b9 00 03	lda $0300,y	                lda $0300,y
2868	.9b65		9d 00 03	sta $0300,x	                sta $0300,x
2869	.9b68		b9 01 03	lda $0301,y	                lda $0301,y
2870	.9b6b		9d 01 03	sta $0301,x	                sta $0301,x
2871	.9b6e		7a		ply		                ply
2872	.9b6f		38		sec		                sec
2873	.9b70		20 75 9b	jsr $9b75	                jsr L9B75
2874	.9b73		e8		inx		                inx
2875	.9b74		c8		iny		                iny
2876	.9b75						L9B75:
2877	.9b75		b9 00 03	lda $0300,y	                lda $0300,y
2878	.9b78		fd 00 03	sbc $0300,x	                sbc $0300,x
2879	.9b7b		9d 04 03	sta $0304,x	                sta $0304,x
2880	.9b7e		60		rts		                rts

2882	.9b7f						L9B7F:
2883	.9b7f		bd 05 03	lda $0305,x	                lda $0305,x
2884	.9b82		bc 04 03	ldy $0304,x	                ldy $0304,x
2885	.9b85		20 2e c9	jsr $c92e	                jsr mos.negateAY
2886	.9b88		9d 05 03	sta $0305,x	                sta $0305,x
2887	.9b8b		98		tya		                tya
2888	.9b8c		9d 04 03	sta $0304,x	                sta $0304,x
2889	.9b8f		60		rts		                rts

2891	.9b90						L9B90:
2892	.9b90		bd 06 03	lda $0306,x	                lda $0306,x
2893	.9b93		a8		tay		                tay
2894	.9b94		dd 04 03	cmp $0304,x	                cmp $0304,x
2895	.9b97		bd 07 03	lda $0307,x	                lda $0307,x
2896	.9b9a		fd 05 03	sbc $0305,x	                sbc $0305,x
2897	.9b9d		08		php		                php
2898	.9b9e		bd 07 03	lda $0307,x	                lda $0307,x
2899	.9ba1		28		plp		                plp
2900	.9ba2		60		rts		                rts

2902							;-------------------------------------------------------------------------
2903							;
2904							; 112â<80><93>119 = Plot parallelogram [MasRef E.3-27]
2905							;
2906	.9ba3						plotParallelogram:
2907	.9ba3		a2 28		ldx #$28	                ldx #$28
2908	.9ba5		86 da		stx $da		                stx $DA
2909	.9ba7		a2 14		ldx #$14	                ldx #$14
2910	.9ba9		a0 20		ldy #$20	                ldy #$20
2911	.9bab		a9 24		lda #$24	                lda #$24
2912	.9bad		20 80 d5	jsr $d580	                jsr mos.addRegionDimensionsToVDUVariableCoordinates
2913	.9bb0		a0 14		ldy #$14	                ldy #$14
2914	.9bb2		a2 24		ldx #$24	                ldx #$24
2915	.9bb4		20 b7 d5	jsr $d5b7	                jsr mos.sortVDUVariableCoordinates
2916	.9bb7		8e 30 88	stx $8830	                stx L8830
2917	.9bba		a2 20		ldx #$20	                ldx #$20
2918	.9bbc		20 b7 d5	jsr $d5b7	                jsr mos.sortVDUVariableCoordinates
2919	.9bbf		8e 31 88	stx $8831	                stx L8831
2920	.9bc2		a2 28		ldx #$28	                ldx #$28
2921	.9bc4		20 b7 d5	jsr $d5b7	                jsr mos.sortVDUVariableCoordinates
2922	.9bc7		8c 33 88	sty $8833	                sty L8833
2923	.9bca		ac 31 88	ldy $8831	                ldy L8831
2924	.9bcd		20 b7 d5	jsr $d5b7	                jsr mos.sortVDUVariableCoordinates
2925	.9bd0		8c 32 88	sty $8832	                sty L8832
2926	.9bd3		ac 30 88	ldy $8830	                ldy L8830
2927	.9bd6		20 0f 9c	jsr $9c0f	                jsr L9C0F
2928	.9bd9		ad 33 88	lda $8833	                lda L8833
2929	.9bdc		85 e0		sta $e0		                sta $E0
2930	.9bde		a2 2c		ldx #$2c	                ldx #$2C
2931	.9be0		20 09 9b	jsr $9b09	                jsr L9B09
2932	.9be3		a4 e1		ldy $e1		                ldy $E1
2933	.9be5		20 56 9c	jsr $9c56	                jsr L9C56
2934	.9be8		ac 32 88	ldy $8832	                ldy L8832
2935	.9beb		ad 33 88	lda $8833	                lda L8833
2936	.9bee		85 e1		sta $e1		                sta $E1
2937	.9bf0		a2 37		ldx #$37	                ldx #$37
2938	.9bf2		20 51 9c	jsr $9c51	                jsr L9C51
2939	.9bf5		80 15		bra $9c0c	                bra L9C0C

2941	.9bf7						L9BF7;
2942	.9bf7		a0 14		ldy #$14	                ldy #$14
2943	.9bf9		a2 24		ldx #$24	                ldx #$24
2944	.9bfb		20 b7 d5	jsr $d5b7	                jsr mos.sortVDUVariableCoordinates
2945	.9bfe		8c 32 88	sty $8832	                sty L8832
2946	.9c01		a0 20		ldy #$20	                ldy #$20
2947	.9c03		20 0f 9c	jsr $9c0f	                jsr L9C0F
2948	.9c06		ad 32 88	lda $8832	                lda L8832
2949	.9c09		20 4d 9c	jsr $9c4d	                jsr L9C4D
2950	.9c0c						L9C0C:
2951	.9c0c		4c e4 da	jmp $dae4	                jmp mos.LDAE4

2953	.9c0f						L9C0F:
2954	.9c0f		20 b7 d5	jsr $d5b7	                jsr mos.sortVDUVariableCoordinates
2955	.9c12		8e 30 88	stx $8830	                stx L8830
2956	.9c15		ae 32 88	ldx $8832	                ldx L8832
2957	.9c18		20 b7 d5	jsr $d5b7	                jsr mos.sortVDUVariableCoordinates
2958	.9c1b		8c 32 88	sty $8832	                sty L8832
2959	.9c1e		8e 31 88	stx $8831	                stx L8831
2960	.9c21		ac 30 88	ldy $8830	                ldy L8830
2961	.9c24		a2 fc		ldx #$fc	                ldx #$FC
2962	.9c26						L9C26:
2963	.9c26		b9 00 03	lda $0300,y	                lda $0300,y
2964	.9c29		9d 46 02	sta $0246,x	                sta vduv.workspace._42-$fc,x
2965	.9c2c		9d 4a 02	sta $024a,x	                sta vduv.workspace._46-$fc,x
2966	.9c2f		c8		iny		                iny
2967	.9c30		e8		inx		                inx
2968	.9c31		d0 f3		bne $9c26	                bne L9C26
2969	.9c33		ac 30 88	ldy $8830	                ldy L8830
2970	.9c36		ad 32 88	lda $8832	                lda L8832
2971	.9c39		85 e1		sta $e1		                sta $E1
2972	.9c3b		a2 37		ldx #$37	                ldx #$37
2973	.9c3d		20 09 9b	jsr $9b09	                jsr L9B09
2974	.9c40		ac 30 88	ldy $8830	                ldy L8830
2975	.9c43		ad 31 88	lda $8831	                lda L8831
2976	.9c46		20 4d 9c	jsr $9c4d	                jsr L9C4D
2977	.9c49		ac 31 88	ldy $8831	                ldy L8831
2978	.9c4c		60		rts		                rts

2980	.9c4d						L9C4D:
2981	.9c4d		85 e0		sta $e0		                sta $E0
2982	.9c4f		a2 2c		ldx #$2c	                ldx #$2C
2983	.9c51						L9C51:
2984	.9c51		20 09 9b	jsr $9b09	                jsr L9B09
2985	.9c54		a4 e0		ldy $e0		                ldy $E0
2986	.9c56						L9C56:
2987	.9c56		5a		phy		                phy
2988	.9c57		b9 02 03	lda $0302,y	                lda $0302,y
2989	.9c5a		cd 44 03	cmp $0344	                cmp $0344
2990	.9c5d		d0 08		bne $9c67	                bne L9C67
2991	.9c5f		b9 03 03	lda $0303,y	                lda $0303,y
2992	.9c62		cd 45 03	cmp $0345	                cmp $0345
2993	.9c65		f0 39		beq $9ca0	                beq L9CA0
2994	.9c67						L9C67:
2995	.9c67		a2 2c		ldx #$2c	                ldx #$2C
2996	.9c69		20 c0 9c	jsr $9cc0	                jsr L9CC0
2997	.9c6c		a2 37		ldx #$37	                ldx #$37
2998	.9c6e		20 c0 9c	jsr $9cc0	                jsr L9CC0
2999	.9c71		20 e4 da	jsr $dae4	                jsr mos.LDAE4
3000	.9c74		a2 37		ldx #$37	                ldx #$37
3001	.9c76		20 26 d7	jsr $d726	                jsr mos.LD726
3002	.9c79		a2 2c		ldx #$2c	                ldx #$2C
3003	.9c7b		20 26 d7	jsr $d726	                jsr mos.LD726
3004	.9c7e		a0 37		ldy #$37	                ldy #$37
3005	.9c80		20 cc d5	jsr $d5cc	                jsr mos.sortVDUVariableWords
3006	.9c83		da		phx		                phx
3007	.9c84		a2 fc		ldx #$fc	                ldx #$FC
3008	.9c86						L9C86:
3009	.9c86		b9 00 03	lda $0300,y	                lda $0300,y
3010	.9c89		9d 4a 02	sta $024a,x	                sta vduv.workspace._46-$fc,x
3011	.9c8c		c8		iny		                iny
3012	.9c8d		e8		inx		                inx
3013	.9c8e		d0 f6		bne $9c86	                bne L9C86
3014	.9c90		fa		plx		                plx
3015	.9c91		a0 fc		ldy #$fc	                ldy #$FC
3016	.9c93						L9C93:
3017	.9c93		bd 00 03	lda $0300,x	                lda $0300,x
3018	.9c96		99 46 02	sta $0246,y	                sta vduv.workspace._42-$fc,y
3019	.9c99		e8		inx		                inx
3020	.9c9a		c8		iny		                iny
3021	.9c9b		d0 f6		bne $9c93	                bne L9C93
3022	.9c9d		7a		ply		                ply
3023	.9c9e		80 b6		bra $9c56	                bra L9C56

3025	.9ca0						L9CA0:
3026	.9ca0		a9 2c		lda #$2c	                lda #$2C
3027	.9ca2		a6 e0		ldx $e0		                ldx $E0
3028	.9ca4		20 ac 9c	jsr $9cac	                jsr L9CAC
3029	.9ca7		7a		ply		                ply
3030	.9ca8		a9 37		lda #$37	                lda #$37
3031	.9caa		a6 e1		ldx $e1		                ldx $E1
3032	.9cac						L9CAC:
3033	.9cac		85 de		sta $de		                sta $DE
3034	.9cae		bd 02 03	lda $0302,x	                lda vduv.graphicsWindowPixelsBottom+0,x
3035	.9cb1		d9 02 03	cmp $0302,y	                cmp vduv.graphicsWindowPixelsBottom+0,y
3036	.9cb4		d0 08		bne $9cbe	                bne L9CBE
3037	.9cb6		bd 03 03	lda $0303,x	                lda vduv.graphicsWindowPixelsBottom+1,x
3038	.9cb9		d9 03 03	cmp $0303,y	                cmp vduv.graphicsWindowPixelsBottom+1,y
3039	.9cbc		f0 05		beq $9cc3	                beq L9CC3
3040	.9cbe						L9CBE:
3041	.9cbe		a6 de		ldx $de		                ldx $DE
3042	.9cc0						L9CC0:
3043	.9cc0		20 1d d7	jsr $d71d	                jsr mos.LD71D
3044	.9cc3						L9CC3:
3045	.9cc3		bd 00 03	lda $0300,x	                lda $0300,x
3046	.9cc6		cd 42 03	cmp $0342	                cmp $0342
3047	.9cc9		bd 01 03	lda $0301,x	                lda $0301,x
3048	.9ccc		ed 43 03	sbc $0343	                sbc $0343
3049	.9ccf		10 0d		bpl $9cde	                bpl L9CDE
3050	.9cd1		bd 00 03	lda $0300,x	                lda $0300,x
3051	.9cd4		8d 42 03	sta $0342	                sta $0342
3052	.9cd7		bd 01 03	lda $0301,x	                lda $0301,x
3053	.9cda		8d 43 03	sta $0343	                sta $0343
3054	.9cdd		60		rts		                rts

3056	.9cde						L9CDE:
3057	.9cde		ad 46 03	lda $0346	                lda $0346
3058	.9ce1		dd 00 03	cmp $0300,x	                cmp $0300,x
3059	.9ce4		ad 47 03	lda $0347	                lda $0347
3060	.9ce7		fd 01 03	sbc $0301,x	                sbc $0301,x
3061	.9cea		10 0c		bpl $9cf8	                bpl L9CF8
3062	.9cec		bd 00 03	lda $0300,x	                lda $0300,x
3063	.9cef		8d 46 03	sta $0346	                sta $0346
3064	.9cf2		bd 01 03	lda $0301,x	                lda $0301,x
3065	.9cf5		8d 47 03	sta $0347	                sta $0347
3066	.9cf8						L9CF8:
3067	.9cf8		60		rts		                rts

3069	.9cf9						L9CF9:
3070	.9cf9		20 a1 dd	jsr $dda1	                jsr mos.LDDA1
3071	.9cfc		9c 36 03	stz $0336	                stz $0336
3072	.9cff		9c 37 03	stz $0337	                stz $0337
3073	.9d02		20 b0 dc	jsr $dcb0	                jsr mos.LDCB0
3074	.9d05		d0 4f		bne $9d56	                bne L9D56
3075	.9d07		20 1c dc	jsr $dc1c	                jsr mos.LDC1C
3076	.9d0a						L9D0A:
3077	.9d0a		24 ff		bit $ff		                bit $FF
3078	.9d0c		30 48		bmi $9d56	                bmi L9D56
3079	.9d0e		ad 36 03	lda $0336	                lda $0336
3080	.9d11		cd 37 03	cmp $0337	                cmp $0337
3081	.9d14		f0 40		beq $9d56	                beq L9D56
3082	.9d16		1a		inc a		                inc a
3083	.9d17		8d 36 03	sta $0336	                sta $0336
3084	.9d1a		aa		tax		                tax
3085	.9d1b		bd 00 84	lda $8400,x	                lda L8400,x
3086	.9d1e		8d 28 03	sta $0328	                sta $0328
3087	.9d21		bd 00 85	lda $8500,x	                lda L8500,x
3088	.9d24		8d 2c 03	sta $032c	                sta $032C
3089	.9d27		bd 00 86	lda $8600,x	                lda L8600,x
3090	.9d2a		48		pha		                pha
3091	.9d2b		4a		lsr a		                lsr a
3092	.9d2c		4a		lsr a		                lsr a
3093	.9d2d		8d 29 03	sta $0329	                sta $0329
3094	.9d30		68		pla		                pla
3095	.9d31		29 03		and #$03	                and #$03
3096	.9d33		8d 2d 03	sta $032d	                sta $032D
3097	.9d36		bd 00 87	lda $8700,x	                lda L8700,x
3098	.9d39		9c 2b 03	stz $032b	                stz $032B
3099	.9d3c		cd 06 03	cmp $0306	                cmp $0306
3100	.9d3f		f0 0a		beq $9d4b	                beq L9D4B
3101	.9d41		85 e0		sta $e0		                sta $E0
3102	.9d43		1a		inc a		                inc a
3103	.9d44		20 48 dc	jsr $dc48	                jsr mos.LDC48
3104	.9d47		b0 0d		bcs $9d56	                bcs L9D56
3105	.9d49		a5 e0		lda $e0		                lda $E0
3106	.9d4b						L9D4B:
3107	.9d4b		cd 02 03	cmp $0302	                cmp $0302
3108	.9d4e		f0 ba		beq $9d0a	                beq L9D0A
3109	.9d50		3a		dec a		                dec a
3110	.9d51		20 48 dc	jsr $dc48	                jsr mos.LDC48
3111	.9d54		90 b4		bcc $9d0a	                bcc L9D0A
3112	.9d56						L9D56:
3113	.9d56		60		rts		                rts

3115	.9d57						L9D57:
3116	.9d57		ad 32 03	lda $0332	                lda $0332
3117	.9d5a		a8		tay		                tay
3118	.9d5b		cd 2c 03	cmp $032c	                cmp $032C
3119	.9d5e		ad 33 03	lda $0333	                lda $0333
3120	.9d61		aa		tax		                tax
3121	.9d62		ed 2d 03	sbc $032d	                sbc $032D
3122	.9d65		b0 0a		bcs $9d71	                bcs L9D71
3123	.9d67		c8		iny		                iny
3124	.9d68		d0 01		bne $9d6b	                bne L9D6B
3125	.9d6a		e8		inx		                inx
3126	.9d6b						L9D6B:
3127	.9d6b		8c 2e 03	sty $032e	                sty $032E
3128	.9d6e		8e 2f 03	stx $032f	                stx $032F
3129	.9d71						L9D71:
3130	.9d71		60		rts		                rts

3132							;-------------------------------------------------------------------------

3134							                .if version>=500
3138							                .endif

3140							;-------------------------------------------------------------------------

3142							                .if version>=500
3146							                .endif

3148							;-------------------------------------------------------------------------

3150							                .if version>=500
3168							                .endif

3170							                .if version>=500
3227							                .endif

3229							;-------------------------------------------------------------------------

3231							                .if version>=500
3234							                .endif

3236							;-------------------------------------------------------------------------

3238							                .if version>=500
3253							                .endif

3255							;-------------------------------------------------------------------------

3257							                .if version>=500
3267							                .endif

3269							;-------------------------------------------------------------------------

3271							                .if version>=500
3280							                .endif

3282							;-------------------------------------------------------------------------

3284							                .if version>=500
3292							                .endif

3294							;-------------------------------------------------------------------------

3296							                .if version>=500
3310							                .endif

3312							;-------------------------------------------------------------------------

3314							                .if version>=500
3322							                .endif

3324							;-------------------------------------------------------------------------

3326							                .if version>=500
3346							                .endif

3348							;-------------------------------------------------------------------------

3350							                .if version>=500
3360							                .endif

3362							;-------------------------------------------------------------------------

3364							                .if version>=500
3376							                .endif

3378							;-------------------------------------------------------------------------

3380							                .if version>=500
3455							                .endif

3457							;-------------------------------------------------------------------------

3459							                .if version>=500
3470							                .endif

3472							;-------------------------------------------------------------------------

3474							                .if version>=500
3503							                .endif

3505							;-------------------------------------------------------------------------

3507							                .if version>=500
3509							                .endif

3511							;-------------------------------------------------------------------------

3513							                .if version==400
3515							                .endif

3517							;-------------------------------------------------------------------------
3518							;
3519							; Utils/Terminal ROM service entry point.
3520							;
3521	.9d72						utilsServiceEntryPoint:
3522							                .if version==400
3529							                .endif
3530							                .if version<500
3531	.9d72		c9 fe		cmp #$fe	                cmp #romServiceCallTubeSystemPostInitialisation
3532	.9d74		90 56		bcc $9dcc	                bcc L9DCC        ;taken if definitely not Tube-related
3533	.9d76		d0 14		bne $9d8c	                bne handleTubeMainInitialisation
3534	.9d78						handleTubeSystemPostInitialisation:
3535	.9d78		c0 00		cpy #$00	                cpy #$00
3536	.9d7a		f0 50		beq $9dcc	                beq L9DCC

3538							                ; [Tube p28] - write out the startup message that the
3539							                ; second processor has been stuck trying to write out.
3540	.9d7c						writeSecondProcessorStartupMessageLoop:
3541	.9d7c		2c e0 fe	bit $fee0	                bit tube.status1
3542	.9d7f		10 fb		bpl $9d7c	                bpl writeSecondProcessorStartupMessageLoop
3543	.9d81		ad e1 fe	lda $fee1	                lda tube.data1
3544	.9d84		f0 44		beq $9dca	                beq L9DCA
3545	.9d86		20 ee ff	jsr $ffee	                jsr OSWRCH
3546	.9d89		4c 7c 9d	jmp $9d7c	                jmp writeSecondProcessorStartupMessageLoop

3548	.9d8c						handleTubeMainInitialisation:
3549	.9d8c		a9 7b		lda #$7b	                lda #<tubeHost.eventHandler
3550	.9d8e		8d 20 02	sta $0220	                sta EVENTV+0
3551	.9d91		a9 06		lda #$06	                lda #>tubeHost.eventHandler
3552	.9d93		8d 21 02	sta $0221	                sta EVENTV+1
3553	.9d96		a9 16		lda #$16	                lda #<tubeBrkHandlerAddr
3554	.9d98		8d 02 02	sta $0202	                sta BRKV+0
3555	.9d9b		a9 00		lda #$00	                lda #>tubeBrkHandlerAddr
3556	.9d9d		8d 03 02	sta $0203	                sta BRKV+1
3557	.9da0		a9 8e		lda #$8e	                lda #tube.status1.S|tube.status1.M|tube.status1.J|tube.status1.I;
3558	.9da2		8d e0 fe	sta $fee0	                sta tube.status1

3560							                ; Copy Tube host code into main RAM.
3561	.9da5		a0 00		ldy #$00	                ldy #$00
3562	.9da7						-
3563	.9da7		b9 6e ab	lda $ab6e,y	                lda tubeHost.codePage0,y
3564	.9daa		99 00 04	sta $0400,y	                sta tubeHostAddr+0*256,y
3565	.9dad		b9 65 ac	lda $ac65,y	                lda tubeHost.codePages12,y
3566	.9db0		99 00 05	sta $0500,y	                sta tubeHostAddr+1*256,y
3567	.9db3		b9 65 ad	lda $ad65,y	                lda tubeHost.codePages12+256,y
3568	.9db6		99 00 06	sta $0600,y	                sta tubeHostAddr+2*256,y
3569	.9db9		88		dey		                dey
3570	.9dba		d0 eb		bne $9da7	                bne -

3572	.9dbc		20 1f 04	jsr $041f	                jsr tubeHost.resetTubeClaim

3574							                ; Copy BRK handler into zero page.
3575	.9dbf		a2 41		ldx #$41	                ldx #size(tubeHost.brkHandler)
3576	.9dc1						-
3577	.9dc1		bd 2d ab	lda $ab2d,x	                lda tubeHost.brkHandler,x
3578	.9dc4		9d 16 00	sta $0016,x	                sta @w tubeBrkHandlerAddr,x
3579	.9dc7		ca		dex		                dex
3580	.9dc8		10 f7		bpl $9dc1	                bpl -

3582	.9dca						L9DCA:
3583	.9dca		a9 00		lda #$00	                lda #$00                     ; Claim call and return

3585	.9dcc						L9DCC:
3595							                .endif
3596	.9dcc		c9 12		cmp #$12	                cmp #romServiceCallInitialiseFilingSystem
3597	.9dce		d0 1a		bne $9dea	                bne L9DEA
3598							                .if version==400
3601							                .else
3602	.9dd0		c0 04		cpy #$04	                cpy #$04                     ; Exit if not TAPE/ROM
3603	.9dd2		b0 42		bcs $9e16	                bcs L9E16
3604	.9dd4		c0 00		cpy #$00	                cpy #$00                     ; Exit if Y=0, no FS
3605	.9dd6		f0 3e		beq $9e16	                beq L9E16
3606	.9dd8		a2 03		ldx #$03	                ldx #$03                     ; X=ROMFS, A=FS number
3607	.9dda		98		tya		                tya
3608	.9ddb		c9 02		cmp #$02	                cmp #$02                     ; If A=2, ROMFS, jump to select it
3609	.9ddd		b0 04		bcs $9de3	                bcs L9DE3
3610	.9ddf		a2 00		ldx #$00	                ldx #$00                     ; X=TAPE, A=speed+2
3611	.9de1		69 02		adc #$02	                adc #$02
3612	.9de3						L9DE3:
3613	.9de3		69 89		adc #$89	                adc #$89                     ; Convert to TAPE/ROM select value
3614							                .endif
3615	.9de5		20 c0 ed	jsr $edc0	                jsr mos.selectROMOrTAPEByOSBYTE
3616	.9de8		80 e0		bra $9dca	                bra L9DCA                    ; Jump to claim and return

3618	.9dea						L9DEA:
3619	.9dea		c9 06		cmp #$06	                cmp #romServiceCallBreakInstruction
3620	.9dec		d0 29		bne $9e17	                bne L9E17
3621	.9dee		ad dd df	lda $dfdd	                lda hazel.hasACCCONChanged ; Skip if ACCCON not changed
3622	.9df1		f0 09		beq $9dfc	                beq L9DFC
3623	.9df3		9c dd df	stz $dfdd	                stz hazel.hasACCCONChanged ; Clear ACCCON changed flag
3624	.9df6		ad dc df	lda $dfdc	                lda hazel.oldACCCON        ; Restore ACCCON
3625	.9df9		8d 34 fe	sta $fe34	                sta ACCCON
3626	.9dfc						L9DFC:
3627	.9dfc		5a		phy		                phy
3628	.9dfd		ac d4 df	ldy $dfd4	                ldy hazel.moveSrcHandle
3629	.9e00		f0 06		beq $9e08	                beq L9E08
3630	.9e02		9c d4 df	stz $dfd4	                stz hazel.moveSrcHandle
3631	.9e05		20 0f 8f	jsr $8f0f	                jsr closeFile
3632	.9e08						L9E08:
3633	.9e08		ac d5 df	ldy $dfd5	                ldy hazel.moveDestHandle
3634	.9e0b		f0 06		beq $9e13	                beq L9E13
3635	.9e0d		9c d5 df	stz $dfd5	                stz hazel.moveDestHandle
3636	.9e10		20 0f 8f	jsr $8f0f	                jsr closeFile
3637	.9e13						L9E13:
3638	.9e13		7a		ply		                ply
3639	.9e14		a9 06		lda #$06	                lda #$06
3640	.9e16						L9E16:
3641	.9e16		60		rts		                rts
3642	.9e17						L9E17:
3643	.9e17		c9 26		cmp #$26	                cmp #romServiceCallCloseAllOpenFiles
3644	.9e19		d0 1d		bne $9e38	                bne L9E38
3645							                .if version!=400
3646	.9e1b		a9 8d		lda #$8d	                lda #$8D
3647	.9e1d		20 2c 9e	jsr $9e2c	                jsr L9E2C
3648	.9e20		a2 03		ldx #$03	                ldx #$03
3649	.9e22		a9 04		lda #$04	                lda #$04
3650	.9e24		24 c6		bit $c6		                bit $C6
3651	.9e26		f0 02		beq $9e2a	                beq L9E2A
3652	.9e28		a2 00		ldx #$00	                ldx #$00
3653	.9e2a						L9E2A:
3654	.9e2a		a9 8c		lda #$8c	                lda #$8C
3655	.9e2c						L9E2C:
3656							                .endif
3657	.9e2c		20 c0 ed	jsr $edc0	                jsr mos.selectROMOrTAPEByOSBYTE
3658	.9e2f		a9 00		lda #$00	                lda #$00
3659	.9e31		a8		tay		                tay
3660	.9e32		20 f9 a1	jsr $a1f9	                jsr osfindTapeOrROM
3661	.9e35		a9 26		lda #$26	                lda #$26
3662	.9e37		60		rts		                rts

3664	.9e38						L9E38:
3665	.9e38		c9 09		cmp #$09	                cmp #romServiceCallHelp
3666							                .if version<400
3667	.9e3a		d0 53		bne $9e8f	                bne L9E8F
3670							                .endif
3671	.9e3c		5a		phy		                phy
3672	.9e3d		b1 f2		lda ($f2),y	                lda ($F2),y
3673	.9e3f		c9 0d		cmp #$0d	                cmp #$0D
3674	.9e41		d0 1e		bne $9e61	                bne L9E61
3675	.9e43		20 fc 9e	jsr $9efc	                jsr L9EFC
3676	.9e46		20 58 a9	jsr $a958	                jsr alwaysPrintFollowingMessage
3677	>9e49		20 20 4d 4f 53 0d		                .text "  MOS",13
3678							                .if version<400
3679	>9e4f		0d 54 45 52 4d 49 4e 41		                .text 13,"TERMINAL 1.20",13
	>9e57		4c 20 31 2e 32 30 0d
3690							                .endif
3691	>9e5e		00				                .text 0
3692	.9e5f		80 2a		bra $9e8b	                bra L9E8B
3693	.9e61						L9E61:
3694	.9e61		a2 02		ldx #$02	                ldx #size(mosHelpSubject)-1
3695	.9e63						L9E63:
3696	.9e63		b1 f2		lda ($f2),y	                lda (stringInputBufferAddress),y
3697	.9e65		c9 2e		cmp #$2e	                cmp #'.'
3698	.9e67		f0 2c		beq $9e95	                beq L9E95
3699	.9e69		29 df		and #$df	                and #$DF
3700	.9e6b		dd 92 9e	cmp $9e92,x	                cmp mosHelpSubject,x
3701	.9e6e		d0 0b		bne $9e7b	                bne L9E7B
3702	.9e70		c8		iny		                iny
3703	.9e71		ca		dex		                dex
3704	.9e72		10 ef		bpl $9e63	                bpl L9E63
3705	.9e74		b1 f2		lda ($f2),y	                lda (stringInputBufferAddress),y
3706	.9e76		20 71 ea	jsr $ea71	                jsr mos.isLetter
3707	.9e79		b0 1a		bcs $9e95	                bcs L9E95
3708	.9e7b						L9E7B:
3709	.9e7b		b1 f2		lda ($f2),y	                lda (stringInputBufferAddress),y
3710	.9e7d		c9 0d		cmp #$0d	                cmp #13
3711	.9e7f		f0 0a		beq $9e8b	                beq L9E8B
3712	.9e81		c8		iny		                iny
3713	.9e82		c9 20		cmp #$20	                cmp #' '
3714	.9e84		d0 f5		bne $9e7b	                bne L9E7B
3715	.9e86		20 ff f2	jsr $f2ff	                jsr mos.skipSpacesAndCheckForCRInStringInput
3716	.9e89		d0 d6		bne $9e61	                bne L9E61
3717	.9e8b						L9E8B:
3718	.9e8b		7a		ply		                ply
3719	.9e8c		a9 09		lda #$09	                lda #romServiceCallHelp
3720	.9e8e						LA304:
3721	.9e8e		60		rts		                rts

3723							                .if version<400
3724	.9e8f						L9E8F:
3725	.9e8f		4c 19 ae	jmp $ae19	                jmp terminalServiceEntryPoint
3726							                .endif

3728	>9e92		53 4f 4d			mosHelpSubject: .text "SOM"

3730	.9e95						L9E95:
3731	.9e95		20 fc 9e	jsr $9efc	                jsr L9EFC
3732	.9e98		a9 68		lda #$68	                lda #<mosCommandTable
3733	.9e9a		85 b0		sta $b0		                sta terminalHELPWorkspace.tablePtr+0
3734	.9e9c		a9 83		lda #$83	                lda #>mosCommandTable
3735	.9e9e		85 b1		sta $b1		                sta terminalHELPWorkspace.tablePtr+1
3736	.9ea0						L9EA0:
3737	.9ea0		b2 b0		lda ($b0)	                lda (terminalHELPWorkspace.tablePtr)
3738	.9ea2		30 50		bmi $9ef4	                bmi L9EF4
3739							                .if version==400
3742							                .endif
3743	.9ea4		20 0c 9f	jsr $9f0c	                jsr printSpace
3744	.9ea7		20 0c 9f	jsr $9f0c	                jsr printSpace
3745	.9eaa		b2 b0		lda ($b0)	                lda (terminalHELPWorkspace.tablePtr)
3746	.9eac						L9EAC:
3747							                .if version==400
3750							                .endif
3751	.9eac		20 0e 9f	jsr $9f0e	                jsr L9F0E
3752	.9eaf						LA711:
3753	.9eaf		e6 b0		inc $b0		                inc terminalHELPWorkspace.tablePtr+0
3754	.9eb1		d0 02		bne $9eb5	                bne L9EB5
3755	.9eb3		e6 b1		inc $b1		                inc terminalHELPWorkspace.tablePtr+1
3756	.9eb5						L9EB5:
3757	.9eb5		b2 b0		lda ($b0)	                lda (terminalHELPWorkspace.tablePtr)
3758	.9eb7		10 f3		bpl $9eac	                bpl L9EAC

3760							                ; add 4 to tablePtr
3761	.9eb9		a9 04		lda #$04	                lda #$04
3762	.9ebb		18		clc		                clc
3763	.9ebc		65 b0		adc $b0		                adc terminalHELPWorkspace.tablePtr+0
3764	.9ebe		85 b0		sta $b0		                sta terminalHELPWorkspace.tablePtr+0
3765	.9ec0		90 02		bcc $9ec4	                bcc +
3766	.9ec2		e6 b1		inc $b1		                inc terminalHELPWorkspace.tablePtr+1
3767	.9ec4						+
3768	.9ec4		20 5c e2	jsr $e25c	                jsr mos.LE25C
3769	.9ec7		e0 13		cpx #$13	                cpx #19
3770	.9ec9		f0 24		beq $9eef	                beq L9EEF
3771	.9ecb						L9ECB:
3772	.9ecb		20 52 e2	jsr $e252	                jsr mos.getTextCursorPositionWithColumn81
3773	.9ece		8a		txa		                txa
3774	.9ecf		f0 cf		beq $9ea0	                beq L9EA0
3775	.9ed1		e0 14		cpx #$14	                cpx #20
3776	.9ed3		f0 cb		beq $9ea0	                beq L9EA0
3777	.9ed5		90 0d		bcc $9ee4	                bcc L9EE4
3778	.9ed7		e0 28		cpx #$28	                cpx #40
3779	.9ed9		f0 c5		beq $9ea0	                beq L9EA0
3780	.9edb		b0 0c		bcs $9ee9	                bcs L9EE9
3781	.9edd		20 5c e2	jsr $e25c	                jsr mos.LE25C
3782	.9ee0		e0 27		cpx #$27	                cpx #39
3783	.9ee2		f0 0b		beq $9eef	                beq L9EEF
3784	.9ee4						L9EE4:
3785	.9ee4		20 0c 9f	jsr $9f0c	                jsr printSpace
3786	.9ee7		80 e2		bra $9ecb	                bra L9ECB

3788	.9ee9						L9EE9:
3789	.9ee9		e0 3c		cpx #$3c	                cpx #60
3790	.9eeb		90 f7		bcc $9ee4	                bcc L9EE4
3791	.9eed		f0 b1		beq $9ea0	                beq L9EA0
3792	.9eef						L9EEF:
3793	.9eef		20 1e 9f	jsr $9f1e	                jsr printNewLine
3794	.9ef2		80 ac		bra $9ea0	                bra L9EA0

3796	.9ef4						L9EF4:
3797	.9ef4		20 52 e2	jsr $e252	                jsr mos.getTextCursorPositionWithColumn81
3798	.9ef7		8a		txa		                txa
3799	.9ef8		f0 91		beq $9e8b	                beq L9E8B
3800	.9efa		80 f3		bra $9eef	                bra L9EEF

3802	.9efc						L9EFC:
3803	.9efc		5a		phy		                phy
3804	.9efd		20 58 a9	jsr $a958	                jsr alwaysPrintFollowingMessage
3805	>9f00		0d				                .text 13
3806							                .if version==320
3807	>9f01		4f 53 20 33 2e 32 30		                .text "OS 3.20"
3834							                .endif
3835	>9f08		0d 00				                .text 13,0
3836	.9f0a		7a		ply		                ply
3837	.9f0b		60		rts		                rts

3839							;-------------------------------------------------------------------------
3840							;
3841	.9f0c						printSpace:
3842	.9f0c		a9 20		lda #$20	                lda #$20
3843	.9f0e						L9F0E:
3844	.9f0e		da		phx		                phx
3845	.9f0f		a6 b0		ldx $b0		                ldx $B0
3846	.9f11		da		phx		                phx
3847	.9f12		a6 b1		ldx $b1		                ldx $B1
3848	.9f14		20 ee ff	jsr $ffee	                jsr OSWRCH
3849	.9f17						restoreB1AndB0:
3850	.9f17		86 b1		stx $b1		                stx $B1
3851	.9f19		fa		plx		                plx
3852	.9f1a		86 b0		stx $b0		                stx $B0
3853	.9f1c		fa		plx		                plx
3854	.9f1d		60		rts		                rts

3856							;-------------------------------------------------------------------------

3858	.9f1e						printNewLine:
3859	.9f1e		da		phx		                phx
3860	.9f1f		a6 b0		ldx $b0		                ldx $B0
3861	.9f21		da		phx		                phx
3862	.9f22		a6 b1		ldx $b1		                ldx $B1
3863	.9f24		20 e7 ff	jsr $ffe7	                jsr OSNEWL
3864	.9f27		80 ee		bra $9f17	                bra restoreB1AndB0

3866							;-------------------------------------------------------------------------

3868							; TAPE/ROM OSARGS handler
3869							; =======================
3870	.9f29						osargsTapeOrROM:
3871	.9f29		c0 00		cpy #$00	                cpy #$00       ; Handle<>0 - read/write open file info
3872	.9f2b		d0 0e		bne $9f3b	                bne L9F3B
3873	.9f2d		09 00		ora #$00	                ora #$00 ; A<>0 - read/write filing system info - exit
3874	.9f2f		d0 09		bne $9f3a	                bne L9F3A

3876							; A=0, Y=0 - read current filing system
3877							; -------------------------------------
3878	.9f31		a9 03		lda #$03	                lda #$03                     ; Prepare A=ROMFS
3879							                .if version!=400
3880	.9f33		2c 47 02	bit $0247	                bit cfsRFSFSSwitch           ; If TAPE/ROM switch
3881	.9f36		d0 02		bne $9f3a	                bne L9F3A
3882	.9f38		25 c6		and $c6		                and $C6           ; Mask with speed to give A=2 or A=1
3883							                .endif

3885							; TAPE/ROM FSC 6 - shut down FS
3886							; TAPE/ROM FSC 8 - OS command
3887							; TAPE/ROM FSC 10 - *INFO
3888							; -----------------------------
3889	.9f3a						L9F3A:
3890	.9f3a		60		rts		                rts

3892							; OSARGS handle<>0 - red/write open file info
3893							; -------------------------------------------
3894	.9f3b						L9F3B:
3895	.9f3b		c9 00		cmp #$00	                cmp #$00                     ; Not =PTR, exit unsupported
3896	.9f3d		d0 fb		bne $9f3a	                bne L9F3A
3897	.9f3f		c0 02		cpy #$02	                cpy #$02                     ; =PTR#2 - read PTR on output handle
3898	.9f41		f0 1d		beq $9f60	                beq L9F60

3900							; Read PTR on CFS/RFS input file
3901							; ------------------------------
3902	.9f43		a9 01		lda #$01	                lda #$01                     ; Check if this is input channel and is open
3903	.9f45		20 68 aa	jsr $aa68	                jsr LAA68
3904	.9f48		ad 9e 03	lda $039e	                lda $039E
3905	.9f4b		95 00		sta $00,x	                sta $00,x
3906	.9f4d		5a		phy		                phy
3907	.9f4e		ad de 03	lda $03de	                lda $03DE
3908	.9f51		ac dd 03	ldy $03dd	                ldy $03DD
3909	.9f54		d0 01		bne $9f57	                bne L9F57
3910	.9f56		3a		dec a		                dec a
3911	.9f57						L9F57:
3912	.9f57		88		dey		                dey
3913	.9f58		94 01		sty $01,x	                sty $01,x
3914	.9f5a		7a		ply		                ply
3915	.9f5b						L9F5B:
3916	.9f5b		95 02		sta $02,x	                sta $02,x
3917	.9f5d		74 03		stz $03,x	                stz $03,x
3918	.9f5f		60		rts		                rts

3920							; Read PTR on TAPE output file
3921							; ----------------------------
3922	.9f60						L9F60:
3923	.9f60		a9 02		lda #$02	                lda #$02                     ; Check if this is output channel and is open
3924	.9f62		20 68 aa	jsr $aa68	                jsr LAA68
3925	.9f65		ad 9d 03	lda $039d	                lda $039D                    ; Copy PTR to control block
3926	.9f68		95 00		sta $00,x	                sta $00,x
3927	.9f6a		ad 94 03	lda $0394	                lda $0394
3928	.9f6d		95 01		sta $01,x	                sta $01,x
3929	.9f6f		ad 95 03	lda $0395	                lda $0395
3930	.9f72		80 e7		bra $9f5b	                bra L9F5B

3932							; TAPE/ROM FSC dispatch table
3933							; ---------------------------

3935	=[]						_:=[]
3936	=[$a422]					_..=[LA422]          ;0 - *OPT
3937	=[$a422,$a4f1]					_..=[LA4F1]          ;1 - EOF
3938	=[$a422,$a4f1,$a110]				_..=[LA110]          ;2 - */
3939	=[$a422,$a4f1,$a110,$a129]			_..=[LA129]          ;3 - unknown * command
3940	=[$a422,$a4f1,$a110,$a129,$a110]		_..=[LA110]          ;4 - *RUN
3941	=[$a422,$a4f1,$a110,$a129,$a110,$a168]		_..=[LA168]          ;5 - *CAT
3942	=[$a422,$a4f1,$a110,$a129,$a110,$a168,$9f3a]	_..=[L9F3A]          ;6 - shut down FS
3943	=[$a422,$a4f1,$a110,$a129,$a110,$a168,$9f3a,$9f9e]
							_..=[L9F9E]          ;7 - obtain file handle range
3944	=[$a422,$a4f1,$a110,$a129,$a110,$a168,$9f3a,$9f9e,$9f3a]
							_..=[L9F3A]          ;8 - OS command
3945	=[$a422,$a4f1,$a110,$a129,$a110,$a168,$9f3a,$9f9e,$9f3a,$a155]
							_..=[LA155]          ;9 - *EX
3946	=[$a422,$a4f1,$a110,$a129,$a110,$a168,$9f3a,$9f9e,$9f3a,$a155,$9f3a]
							_..=[L9F3A]          ;10 - *INFO
3947	=[$a422,$a4f1,$a110,$a129,$a110,$a168,$9f3a,$9f9e,$9f3a,$a155,$9f3a,$a113]
							_..=[LA113]          ;11 - *RUN command for library
3948	=[$a422,$a4f1,$a110,$a129,$a110,$a168,$9f3a,$9f9e,$9f3a,$a155,$9f3a,$a113]
							tape_and_rom_dispatch_fsc_routines=_

3950	.9f74						L9F74:
3951	>9f74		21 f0 0f 28 0f 67 39 9d		                .byte <tape_and_rom_dispatch_fsc_routines-1
	>9f7c		39 54 39 12
3952	.9f80						L9F80:
3953	>9f80		a4 a4 a1 a1 a1 a1 9f 9f		                .byte >tape_and_rom_dispatch_fsc_routines-1
	>9f88		9f a1 9f a1

3955							; TAPE/ROM FSC
3956							; ============
3957	.9f8c						fscTapeOrROM:
3958	.9f8c		c9 0c		cmp #$0c	                cmp #$0C                     ; function<12 - exit unchanged
3959	.9f8e		b0 aa		bcs $9f3a	                bcs L9F3A
3960	.9f90		86 bc		stx $bc		                stx $BC                      ; Index into dispatch table
3961	.9f92		aa		tax		                tax
3962	.9f93		bd 80 9f	lda $9f80,x	                lda L9F80,x
3963	.9f96		48		pha		                pha
3964	.9f97		bd 74 9f	lda $9f74,x	                lda L9F74,x
3965	.9f9a		48		pha		                pha
3966	.9f9b		a6 bc		ldx $bc		                ldx $BC
3967	.9f9d		60		rts		                rts

3969							; TAPE/ROM FSC 7 - obtain file handle range
3970							; -----------------------------------------
3971	.9f9e						L9F9E:
3972	.9f9e		a2 03		ldx #$03	                ldx #$03
3973	.9fa0		a0 03		ldy #$03	                ldy #$03
3974							                .if version!=400
3975	.9fa2		ad 47 02	lda $0247	                lda cfsRFSFSSwitch
3976	.9fa5		d0 93		bne $9f3a	                bne L9F3A
3977	.9fa7		88		dey		                dey
3978	.9fa8		a2 01		ldx #$01	                ldx #$01
3979							                .endif
3980	.9faa		60		rts		                rts

3982	.9fab						L9FAB:
3983	.9fab		68		pla		                pla
3984	.9fac		28		plp		                plp
3985	.9fad		38		sec		                sec
3986	.9fae		60		rts		                rts

3988	.9faf						L9FAF:
3989	.9faf		08		php		                php
3990	.9fb0		48		pha		                pha
3991	.9fb1		20 f3 a9	jsr $a9f3	                jsr LA9F3
3992	.9fb4		ad c2 03	lda $03c2	                lda $03C2
3993	.9fb7		48		pha		                pha
3994	.9fb8		20 02 a5	jsr $a502	                jsr LA502
3995	.9fbb		68		pla		                pla
3996	.9fbc		b0 ed		bcs $9fab	                bcs L9FAB
3997	.9fbe		f0 19		beq $9fd9	                beq L9FD9
3998	.9fc0		a2 03		ldx #$03	                ldx #$03
3999	.9fc2		a9 ff		lda #$ff	                lda #$FF
4000	.9fc4						L9FC4:
4001	.9fc4		48		pha		                pha
4002	.9fc5		bd be 03	lda $03be,x	                lda $03BE,x
4003	.9fc8		95 b0		sta $b0,x	                sta $B0,x
4004	.9fca		68		pla		                pla
4005	.9fcb		35 b0		and $b0,x	                and $B0,x
4006	.9fcd		ca		dex		                dex
4007	.9fce		10 f4		bpl $9fc4	                bpl L9FC4
4008	.9fd0		1a		inc a		                inc a
4009	.9fd1		d0 06		bne $9fd9	                bne L9FD9
4010	.9fd3		20 b1 a9	jsr $a9b1	                jsr LA9B1
4011	.9fd6		4c 4b 93	jmp $934b	                jmp badAddressError

4013	.9fd9						L9FD9:
4014	.9fd9		ad ca 03	lda $03ca	                lda $03CA
4015	.9fdc		4a		lsr a		                lsr a
4016	.9fdd		68		pla		                pla
4017	.9fde		48		pha		                pha
4018	.9fdf		f0 10		beq $9ff1	                beq L9FF1
4019	.9fe1		90 15		bcc $9ff8	                bcc L9FF8
4020	.9fe3						L9FE3:
4021	.9fe3		20 bb a9	jsr $a9bb	                jsr LA9BB
4022	.9fe6		20 ed aa	jsr $aaed	                jsr doFollowingError
4023	>9fe9		d5 4c 6f 63 6b 65 64 00		                .text $d5,"Locked",0
4024	.9ff1						L9FF1:
4025	.9ff1		90 05		bcc $9ff8	                bcc L9FF8
4026	.9ff3		a9 03		lda #$03	                lda #$03
4027	.9ff5		8d 58 02	sta $0258	                sta breakAndESCAPEEffect
4028	.9ff8						L9FF8:
4029	.9ff8		a9 30		lda #$30	                lda #$30
4030	.9ffa		25 bb		and $bb		                and $BB
4031	.9ffc		f0 04		beq $a002	                beq LA002
4032	.9ffe		a5 c1		lda $c1		                lda $C1
4033	.a000						LA000:
4034	.a000		d0 08		bne $a00a	                bne LA00A
4035	.a002						LA002:
4036							                .if version<500
4037	.a002		5a		phy		                phy
4038	.a003		20 a4 aa	jsr $aaa4	                jsr LAAA4
4039	.a006		7a		ply		                ply
4040							                .endif
4041	.a007		20 d2 a6	jsr $a6d2	                jsr LA6D2
4042	.a00a						LA00A:
4043	.a00a		20 a1 a8	jsr $a8a1	                jsr LA8A1
4044	.a00d		d0 57		bne $a066	                bne LA066
4045	.a00f		20 35 aa	jsr $aa35	                jsr LAA35
4046	.a012		2c ca 03	bit $03ca	                bit $03CA
4047	.a015		30 08		bmi $a01f	                bmi LA01F
4048	.a017		20 5b a8	jsr $a85b	                jsr LA85B
4049	.a01a		20 78 a6	jsr $a678	                jsr LA678
4050	.a01d		80 d9		bra $9ff8	                bra L9FF8

4052	.a01f						LA01F:
4053	.a01f		68		pla		                pla                          ; RUN, no control block to update
4054	.a020		f0 33		beq $a055	                beq LA055
4055	.a022		a0 02		ldy #$02	                ldy #$02
4056	.a024						LA024:
4057	.a024		b9 bc 03	lda $03bc,y	                lda $03BC,y                  ; Copy load/exec to control block
4058	.a027		91 c8		sta ($c8),y	                sta ($C8),y
4059	.a029		c8		iny		                iny
4060	.a02a		c0 0a		cpy #$0a	                cpy #$0A
4061	.a02c		d0 f6		bne $a024	                bne LA024
4062	.a02e		ad c8 03	lda $03c8	                lda $03C8                    ; Length b0-b7=Block Length b0-b7
4063	.a031		91 c8		sta ($c8),y	                sta ($C8),y
4064	.a033		c8		iny		                iny
4065	.a034		ad c9 03	lda $03c9	                lda $03C9
4066	.a037		18		clc		                clc
4067	.a038		6d c6 03	adc $03c6	                adc $03C6                    ; Length b8-b15=Block Number+Block Length b8-b15
4068	.a03b		91 c8		sta ($c8),y	                sta ($C8),y
4069	.a03d		c8		iny		                iny
4070	.a03e		a9 00		lda #$00	                lda #$00
4071	.a040		6d c7 03	adc $03c7	                adc $03C7                    ; Length b16-b23=overflow
4072	.a043		91 c8		sta ($c8),y	                sta ($C8),y
4073	.a045		c8		iny		                iny                          ; Length b24-b31=&00
4074	.a046		a9 00		lda #$00	                lda #$00
4075	.a048		91 c8		sta ($c8),y	                sta ($C8),y
4076	.a04a		c8		iny		                iny
4077	.a04b						LA04B:
4078	.a04b		b9 bd 03	lda $03bd,y	                lda $03BD,y                  ; Attrs=&00000000
4079	.a04e		91 c8		sta ($c8),y	                sta ($C8),y
4080	.a050		c8		iny		                iny
4081	.a051		c0 12		cpy #$12	                cpy #$12
4082	.a053		d0 f6		bne $a04b	                bne LA04B
4083	.a055						LA055:
4084	.a055		28		plp		                plp
4085	.a056						LA056:
4086	.a056		20 b1 a9	jsr $a9b1	                jsr LA9B1
4087	.a059						LA059:
4088	.a059		24 ba		bit $ba		                bit $BA                      ; If flag set, skip printing newline
4089	.a05b		30 07		bmi $a064	                bmi LA064
4090	.a05d						LA05D:
4091	.a05d		08		php		                php                          ; Print inline text
4092	.a05e		20 23 a9	jsr $a923	                jsr LA923
4093	>a061		0d				                .byte 13                     ; Could just do JSR OSNEWL
4094	>a062		00				                .byte 0
4095	.a063		28		plp		                plp
4096	.a064						LA064:
4097	.a064		18		clc		                clc
4098	.a065		60		rts		                rts

4100	.a066						LA066:
4101	.a066		20 06 a5	jsr $a506	                jsr LA506
4102	.a069		d0 8d		bne $9ff8	                bne L9FF8
4103	.a06b						LA06B:
4104	.a06b		86 f2		stx $f2		                stx $F2
4105	.a06d		84 f3		sty $f3		                sty $F3
4106	.a06f		a0 00		ldy #$00	                ldy #$00
4107	.a071		20 6d f2	jsr $f26d	                jsr mos.gsinitForFilenameParsing
4108	.a074		a2 00		ldx #$00	                ldx #$00
4109	.a076						LA076:
4110	.a076		20 7f f2	jsr $f27f	                jsr mos.gsreadEntryPoint
4111	.a079		b0 0d		bcs $a088	                bcs LA088
4112	.a07b		f0 08		beq $a085	                beq LA085
4113	.a07d		9d d2 03	sta $03d2,x	                sta $03D2,x
4114	.a080		e8		inx		                inx
4115	.a081		e0 0b		cpx #$0b	                cpx #$0B
4116	.a083		d0 f1		bne $a076	                bne LA076
4117	.a085						LA085:
4118	.a085		4c 8f f2	jmp $f28f	                jmp mos.badStringError

4120	.a088						LA088:
4121	.a088		9e d2 03	stz $03d2,x	                stz $03D2,x
4122	.a08b		60		rts		                rts

4124							; CFS/RFS OSFILE
4125							; ==============
4126	.a08c						osfileTapeOrROM:
4127	.a08c		48		pha		                pha
4128	.a08d		86 c8		stx $c8		                stx $C8                      ; C8/9=>control block
4129	.a08f		84 c9		sty $c9		                sty $C9
4130	.a091		b2 c8		lda ($c8)	                lda ($C8)                    ; Get XY=>filename
4131	.a093		aa		tax		                tax
4132	.a094		a0 01		ldy #$01	                ldy #$01
4133	.a096		b1 c8		lda ($c8),y	                lda ($C8),y
4134	.a098		a8		tay		                tay
4135	.a099		20 6b a0	jsr $a06b	                jsr LA06B                    ; Parse filename
4136	.a09c		a0 02		ldy #$02	                ldy #$02
4137	.a09e						LA09E:
4138	.a09e		b1 c8		lda ($c8),y	                lda ($C8),y
4139	.a0a0		99 bc 03	sta $03bc,y	                sta $03BC,y
4140	.a0a3		99 ae 00	sta $00ae,y	                sta $00AE,y
4141	.a0a6		c8		iny		                iny
4142	.a0a7		c0 0a		cpy #$0a	                cpy #$0A
4143	.a0a9		d0 f3		bne $a09e	                bne LA09E
4144	.a0ab		68		pla		                pla
4145	.a0ac		f0 07		beq $a0b5	                beq LA0B5
4146	.a0ae		c9 ff		cmp #$ff	                cmp #$FF
4147	.a0b0		d0 b2		bne $a064	                bne LA064
4148	.a0b2		4c af 9f	jmp $9faf	                jmp L9FAF

4150	.a0b5						LA0B5:
4151							                .if version==400
4153							                .else
4154	.a0b5		8d c6 03	sta $03c6	                sta $03C6
4155	.a0b8		8d c7 03	sta $03c7	                sta $03C7
4156	.a0bb						LA0BB:
4157	.a0bb		b1 c8		lda ($c8),y	                lda ($C8),y
4158	.a0bd		99 a6 00	sta $00a6,y	                sta $00A6,y
4159	.a0c0		c8		iny		                iny
4160	.a0c1		c0 12		cpy #$12	                cpy #$12
4161	.a0c3		d0 f6		bne $a0bb	                bne LA0BB
4162	.a0c5		8a		txa		                txa
4163	.a0c6		f0 bd		beq $a085	                beq LA085
4164	.a0c8		20 f3 a9	jsr $a9f3	                jsr LA9F3
4165	.a0cb		20 22 a8	jsr $a822	                jsr LA822
4166							                .if version<500
4167	.a0ce		a9 00		lda #$00	                lda #$00
4168	.a0d0		20 a6 aa	jsr $aaa6	                jsr LAAA6
4169							                .endif
4170	.a0d3						LA0D3:
4171	.a0d3		38		sec		                sec
4172	.a0d4		a2 fd		ldx #$fd	                ldx #$fd                     ;-3
4173	.a0d6						LA0D6:
4174	.a0d6		bd b7 ff	lda $ffb7,x	                lda ($b4-$fd)&$ffff,x
4175	.a0d9		fd b3 ff	sbc $ffb3,x	                sbc ($b0-$fd)&$ffff,x
4176	.a0dc		9d cb 02	sta $02cb,x	                sta $3c8-$fd,x
4177	.a0df		e8		inx		                inx
4178	.a0e0		d0 f4		bne $a0d6	                bne LA0D6
4179	.a0e2		a8		tay		                tay
4180	.a0e3		d0 0e		bne $a0f3	                bne LA0F3
4181	.a0e5		ec c8 03	cpx $03c8	                cpx $03C8
4182	.a0e8		a9 01		lda #$01	                lda #$01
4183	.a0ea		ed c9 03	sbc $03c9	                sbc $03C9
4184	.a0ed		90 04		bcc $a0f3	                bcc LA0F3
4185	.a0ef		a2 80		ldx #$80	                ldx #$80
4186	.a0f1		80 08		bra $a0fb	                bra LA0FB

4188	.a0f3						LA0F3:
4189	.a0f3		a9 01		lda #$01	                lda #$01
4190	.a0f5		8d c9 03	sta $03c9	                sta $03C9
4191	.a0f8		8e c8 03	stx $03c8	                stx $03C8
4192	.a0fb						LA0FB:
4193	.a0fb		8e ca 03	stx $03ca	                stx $03CA
4194	.a0fe		20 e9 a6	jsr $a6e9	                jsr LA6E9
4195	.a101		30 78		bmi $a17b	                bmi LA17B
4196	.a103		20 5b a8	jsr $a85b	                jsr LA85B
4197	.a106		ee c6 03	inc $03c6	                inc $03C6
4198	.a109		d0 c8		bne $a0d3	                bne LA0D3
4199	.a10b		ee c7 03	inc $03c7	                inc $03C7
4200	.a10e		80 c3		bra $a0d3	                bra LA0D3
4201							                .endif

4203							; TAPE/ROM FSC 2 - */
4204							; TAPE/ROM FSC 4 - *RUN
4205							; ---------------------
4206	.a110						LA110:
4207	.a110		38		sec		                sec
4208	.a111		66 ce		ror $ce		                ror $CE
4209							; TAPE/ROM FSC 11 - *RUN command for library
4210							; ------------------------------------------
4211	.a113						LA113:
4212	.a113		da		phx		                phx
4213	.a114		5a		phy		                phy
4214	.a115		20 6b a0	jsr $a06b	                jsr LA06B
4215	.a118		a9 00		lda #$00	                lda #$00
4216	.a11a		a2 ff		ldx #$ff	                ldx #$FF
4217	.a11c		8e c2 03	stx $03c2	                stx $03C2
4218	.a11f		20 af 9f	jsr $9faf	                jsr L9FAF
4219	.a122		7a		ply		                ply
4220	.a123		fa		plx		                plx
4221	.a124		90 08		bcc $a12e	                bcc LA12E
4222							                .if version!=400
4223	.a126		20 ca a9	jsr $a9ca	                jsr LA9CA
4224							                .endif

4226							; TAPE/ROM FSC 3 - unknown * command
4227							; ----------------------------------
4228	.a129						LA129:
4229	.a129		a9 0b		lda #$0b	                lda #$0B
4230	.a12b		6c 1e 02	jmp ($021e)	                jmp (FSCV)

4232	.a12e						LA12E:
4233							                .if version<500
4234	.a12e		2c 7a 02	bit $027a	                bit tubePresence
4235	.a131		10 09		bpl $a13c	                bpl LA13C
4236	.a133		ad c4 03	lda $03c4	                lda $03C4
4237	.a136		2d c5 03	and $03c5	                and $03C5
4238	.a139		1a		inc a		                inc a
4239	.a13a		d0 10		bne $a14c	                bne LA14C
4240	.a13c						LA13C:
4241							                .endif

4243	.a13c		ae c2 03	ldx $03c2	                ldx $03C2
4244	.a13f		ac c3 03	ldy $03c3	                ldy $03C3
4245	.a142		a9 a4		lda #$a4	                lda #$A4
4246	.a144		20 f4 ff	jsr $fff4	                jsr OSBYTE
4247	.a147		a9 01		lda #$01	                lda #$01
4248	.a149		6c c2 03	jmp ($03c2)	                jmp ($03C2)

4250							                .if version<500
4251	.a14c						LA14C:
4252	.a14c		a2 c2		ldx #$c2	                ldx #$C2
4253	.a14e		a0 03		ldy #$03	                ldy #$03
4254	.a150		a9 04		lda #$04	                lda #$04
4255	.a152		4c b0 aa	jmp $aab0	                jmp LAAB0
4256							                .endif

4258							; TAPE/ROM FSC 9 - *EX
4259							; --------------------
4260	.a155						LA155:
4261	.a155		a9 08		lda #$08	                lda #$08
4262	.a157		04 e2		tsb $e2		                tsb $E2
4263	.a159		a5 e3		lda $e3		                lda $E3
4264	.a15b		48		pha		                pha
4265	.a15c		09 cc		ora #$cc	                ora #$CC
4266	.a15e		85 e3		sta $e3		                sta $E3
4267	.a160		20 f3 a9	jsr $a9f3	                jsr LA9F3
4268	.a163		68		pla		                pla
4269	.a164		85 e3		sta $e3		                sta $E3
4270	.a166		80 07		bra $a16f	                bra LA16F

4272							; TAPE/ROM FSC 5 - *CAT
4273							; ---------------------
4274	.a168						LA168:
4275	.a168		a9 08		lda #$08	                lda #$08
4276	.a16a		04 e2		tsb $e2		                tsb $E2
4277	.a16c		20 f3 a9	jsr $a9f3	                jsr LA9F3
4278	.a16f						LA16F:
4279	.a16f		a9 00		lda #$00	                lda #$00
4280	.a171		20 7c a1	jsr $a17c	                jsr LA17C
4281							                .if version!=400
4282	.a174		20 ca a9	jsr $a9ca	                jsr LA9CA
4283							                .endif
4284	.a177						LA177:
4285	.a177		a9 08		lda #$08	                lda #$08
4286	.a179		14 e2		trb $e2		                trb $E2
4287	.a17b						LA17B:
4288	.a17b		60		rts		                rts

4290	.a17c						LA17C:
4291	.a17c		48		pha		                pha
4292							                .if version!=400
4293	.a17d		ad 47 02	lda $0247	                lda cfsRFSFSSwitch
4294	.a180		f0 09		beq $a18b	                beq LA18B
4295							                .endif
4296	.a182		20 fc f6	jsr $f6fc	                jsr mos.LF6FC
4297	.a185		20 01 f7	jsr $f701	                jsr mos.LF701
4298	.a188		b8		clv		                clv
4299	.a189		b0 50		bcs $a1db	                bcs LA1DB
4300	.a18b						LA18B:
4301	.a18b		20 78 a6	jsr $a678	                jsr LA678
4302	.a18e		ad c6 03	lda $03c6	                lda $03C6
4303	.a191		85 b4		sta $b4		                sta $B4
4304	.a193		ad c7 03	lda $03c7	                lda $03C7
4305	.a196		85 b5		sta $b5		                sta $B5
4306	.a198		a2 ff		ldx #$ff	                ldx #$FF
4307	.a19a		8e df 03	stx $03df	                stx $03DF
4308	.a19d		64 ba		stz $ba		                stz $BA
4309	.a19f		80 16		bra $a1b7	                bra LA1B7

4311	.a1a1						LA1A1:
4312							                .if version!=400
4313	.a1a1		ad 47 02	lda $0247	                lda cfsRFSFSSwitch
4314	.a1a4		f0 37		beq $a1dd	                beq LA1DD
4315							                .endif
4316	.a1a6						LA1A6:
4317	.a1a6		20 17 f7	jsr $f717	                jsr mos.LF717
4318	.a1a9						LA1A9:
4319	.a1a9		a9 ff		lda #$ff	                lda #$FF
4320	.a1ab		8d c6 03	sta $03c6	                sta $03C6
4321	.a1ae		8d c7 03	sta $03c7	                sta $03C7
4322	.a1b1						LA1B1:
4323	.a1b1		20 35 aa	jsr $aa35	                jsr LAA35
4324	.a1b4		20 78 a6	jsr $a678	                jsr LA678
4325	.a1b7						LA1B7:
4326							                .if version!=400
4327	.a1b7		ad 47 02	lda $0247	                lda cfsRFSFSSwitch
4328	.a1ba		f0 02		beq $a1be	                beq LA1BE
4329							                .endif
4330	.a1bc		50 1d		bvc $a1db	                bvc LA1DB
4331	.a1be						LA1BE:
4332	.a1be		68		pla		                pla
4333	.a1bf		48		pha		                pha
4334	.a1c0		f0 1b		beq $a1dd	                beq LA1DD
4335	.a1c2		20 5c a9	jsr $a95c	                jsr LA95C
4336	.a1c5		d0 da		bne $a1a1	                bne LA1A1
4337	.a1c7		a9 30		lda #$30	                lda #$30
4338	.a1c9		25 bb		and $bb		                and $BB
4339	.a1cb		f0 0e		beq $a1db	                beq LA1DB
4340	.a1cd		ad c6 03	lda $03c6	                lda $03C6
4341	.a1d0		c5 b6		cmp $b6		                cmp $B6
4342	.a1d2		d0 cd		bne $a1a1	                bne LA1A1
4343	.a1d4		ad c7 03	lda $03c7	                lda $03C7
4344	.a1d7		c5 b7		cmp $b7		                cmp $B7
4345	.a1d9		d0 c6		bne $a1a1	                bne LA1A1
4346	.a1db						LA1DB:
4347	.a1db		68		pla		                pla
4348	.a1dc		60		rts		                rts

4350	.a1dd						LA1DD:
4351	.a1dd		50 05		bvc $a1e4	                bvc LA1E4
4352	.a1df		a9 ff		lda #$ff	                lda #$FF
4353	.a1e1		20 d4 a6	jsr $a6d4	                jsr LA6D4
4354	.a1e4						LA1E4:
4355	.a1e4		a2 00		ldx #$00	                ldx #$00
4356	.a1e6		20 c4 a8	jsr $a8c4	                jsr LA8C4
4357							                .if version!=400
4358	.a1e9		ad 47 02	lda $0247	                lda cfsRFSFSSwitch
4359	.a1ec		f0 04		beq $a1f2	                beq LA1F2
4360							                .endif
4361	.a1ee		24 bb		bit $bb		                bit $BB
4362	.a1f0		50 b4		bvc $a1a6	                bvc LA1A6
4363	.a1f2						LA1F2:
4364	.a1f2		2c ca 03	bit $03ca	                bit $03CA
4365	.a1f5		30 b2		bmi $a1a9	                bmi LA1A9
4366	.a1f7		80 b8		bra $a1b1	                bra LA1B1

4368							; CFS/RFS OSFIND HANDLER
4369							; ======================
4370	.a1f9						osfindTapeOrROM:
4371	.a1f9		85 bc		sta $bc		                sta $BC
4372	.a1fb		da		phx		                phx
4373	.a1fc		5a		phy		                phy
4374	.a1fd		09 00		ora #$00	                ora #$00
4375	.a1ff		d0 1f		bne $a220	                bne LA220
4376	.a201		98		tya		                tya
4377	.a202		d0 0e		bne $a212	                bne LA212
4378							                .if version!=400
4379	.a204		ad 47 02	lda $0247	                lda cfsRFSFSSwitch
4380	.a207		d0 03		bne $a20c	                bne LA20C
4381	.a209		20 9c a2	jsr $a29c	                jsr LA29C
4382							                .endif
4383	.a20c						LA20C:
4384	.a20c		a9 01		lda #$01	                lda #$01
4385	.a20e		14 e2		trb $e2		                trb $E2
4386							                .if version==400
4388							                .else
4389	.a210		80 0c		bra $a21e	                bra LA21E
4390							                .endif
4391	.a212						LA212:
4392	.a212		4a		lsr a		                lsr a
4393	.a213		b0 f7		bcs $a20c	                bcs LA20C
4394							                .if version!=400
4395	.a215		4a		lsr a		                lsr a
4396	.a216		b0 03		bcs $a21b	                bcs LA21B
4397							                .endif
4398	.a218		4c 81 aa	jmp $aa81	                jmp LAA81

4400							                .if version!=400
4401	.a21b						LA21B:
4402	.a21b		20 9c a2	jsr $a29c	                jsr LA29C
4403	.a21e						LA21E:
4404	.a21e		80 77		bra $a297	                bra LA297
4405							                .endif

4407	.a220						LA220:
4408	.a220		20 6b a0	jsr $a06b	                jsr LA06B
4409	.a223		24 bc		bit $bc		                bit $BC
4410	.a225		50 39		bvc $a260	                bvc LA260
4411	.a227		9c 9e 03	stz $039e	                stz $039E
4412	.a22a		9c dd 03	stz $03dd	                stz $03DD
4413	.a22d		9c de 03	stz $03de	                stz $03DE
4414	.a230		a9 c1		lda #$c1	                lda #$C1
4415	.a232		14 e2		trb $e2		                trb $E2
4416	.a234		20 e6 a9	jsr $a9e6	                jsr LA9E6
4417	.a237		08		php		                php
4418	.a238		20 02 a5	jsr $a502	                jsr LA502
4419	.a23b		20 b7 a5	jsr $a5b7	                jsr LA5B7
4420	.a23e		28		plp		                plp
4421	.a23f		a2 ff		ldx #$ff	                ldx #$FF
4422	.a241						LA241:
4423	.a241		e8		inx		                inx
4424	.a242		bd b2 03	lda $03b2,x	                lda $03B2,x
4425	.a245		9d a7 03	sta $03a7,x	                sta $03A7,x
4426	.a248		d0 f7		bne $a241	                bne LA241
4427	.a24a		1a		inc a		                inc a
4428	.a24b		04 e2		tsb $e2		                tsb $E2
4429	.a24d		ad e9 02	lda $02e9	                lda tapeInputCurrentBlockSize+0
4430	.a250		0d ea 02	ora $02ea	                ora tapeInputCurrentBlockSize+1
4431	.a253		d0 04		bne $a259	                bne LA259
4432	.a255		a9 40		lda #$40	                lda #$40
4433	.a257		04 e2		tsb $e2		                tsb $E2
4434	.a259						LA259:
4435							                .if version==400
4440							                .else
4441	.a259		a9 01		lda #$01	                lda #$01
4442	.a25b		0d 47 02	ora $0247	                ora cfsRFSFSSwitch
4443	.a25e		d0 35		bne $a295	                bne LA295
4444	.a260						LA260:
4445	.a260		8a		txa		                txa
4446	.a261		d0 03		bne $a266	                bne LA266
4447	.a263		4c 8f f2	jmp $f28f	                jmp mos.badStringError

4449	.a266						LA266:
4450	.a266		a2 ff		ldx #$ff	                ldx #$FF
4451	.a268						LA268:
4452	.a268		e8		inx		                inx
4453	.a269		bd d2 03	lda $03d2,x	                lda $03D2,x
4454	.a26c		9d 80 03	sta $0380,x	                sta $0380,x
4455	.a26f		d0 f7		bne $a268	                bne LA268
4456	.a271		3a		dec a		                dec a
4457	.a272		a2 08		ldx #$08	                ldx #$08
4458	.a274						LA274:
4459	.a274		9d 8b 03	sta $038b,x	                sta $038B,x
4460	.a277		ca		dex		                dex
4461	.a278		d0 fa		bne $a274	                bne LA274
4462	.a27a		8a		txa		                txa
4463	.a27b		a2 14		ldx #$14	                ldx #$14
4464	.a27d						LA27D:
4465	.a27d		9d 80 03	sta $0380,x	                sta $0380,x
4466	.a280		e8		inx		                inx
4467	.a281		e0 1e		cpx #$1e	                cpx #$1E
4468	.a283		d0 f8		bne $a27d	                bne LA27D
4469	.a285		2e 97 03	rol $0397	                rol $0397
4470	.a288		20 f3 a9	jsr $a9f3	                jsr LA9F3
4471	.a28b		20 22 a8	jsr $a822	                jsr LA822
4472	.a28e		20 bb a9	jsr $a9bb	                jsr LA9BB
4473	.a291		a9 02		lda #$02	                lda #$02
4474	.a293		04 e2		tsb $e2		                tsb $E2
4475							                .endif
4476	.a295						LA295:
4477	.a295		85 bc		sta $bc		                sta $BC
4478	.a297						LA297:
4479	.a297		7a		ply		                ply
4480	.a298		fa		plx		                plx
4481	.a299		a5 bc		lda $bc		                lda $BC
4482	.a29b						LA29B:
4483	.a29b		60		rts		                rts

4485							                .if version!=400
4486	.a29c						LA29C:
4487	.a29c		a9 02		lda #$02	                lda #$02
4488	.a29e		25 e2		and $e2		                and $E2
4489	.a2a0		f0 f9		beq $a29b	                beq LA29B
4490	.a2a2		9c 97 03	stz $0397	                stz $0397
4491	.a2a5		a9 80		lda #$80	                lda #$80
4492	.a2a7		ae 9d 03	ldx $039d	                ldx $039D
4493	.a2aa		8e 96 03	stx $0396	                stx $0396
4494	.a2ad		8d 98 03	sta $0398	                sta $0398
4495	.a2b0		20 b8 a2	jsr $a2b8	                jsr LA2B8
4496	.a2b3		a9 02		lda #$02	                lda #$02
4497	.a2b5		14 e2		trb $e2		                trb $E2
4498	.a2b7		60		rts		                rts

4500	.a2b8						LA2B8:
4501	.a2b8		20 e6 a9	jsr $a9e6	                jsr LA9E6
4502	.a2bb		a2 11		ldx #$11	                ldx #$11
4503	.a2bd						LA2BD:
4504	.a2bd		bd 8c 03	lda $038c,x	                lda $038C,x
4505	.a2c0		9d be 03	sta $03be,x	                sta $03BE,x
4506	.a2c3		ca		dex		                dex
4507	.a2c4		10 f7		bpl $a2bd	                bpl LA2BD
4508	.a2c6		86 b2		stx $b2		                stx $B2
4509	.a2c8		86 b3		stx $b3		                stx $B3
4510	.a2ca		64 b0		stz $b0		                stz $B0
4511	.a2cc		a9 09		lda #$09	                lda #$09
4512	.a2ce		85 b1		sta $b1		                sta $B1
4513	.a2d0		a2 7f		ldx #$7f	                ldx #$7F
4514	.a2d2		20 4d aa	jsr $aa4d	                jsr LAA4D
4515	.a2d5		8d df 03	sta $03df	                sta $03DF
4516	.a2d8		20 5a aa	jsr $aa5a	                jsr LAA5A
4517	.a2db		20 a0 aa	jsr $aaa0	                jsr LAAA0
4518	.a2de		20 e9 a6	jsr $a6e9	                jsr LA6E9
4519	.a2e1		ee 94 03	inc $0394	                inc $0394
4520	.a2e4		d0 03		bne $a2e9	                bne LA2E9
4521	.a2e6		ee 95 03	inc $0395	                inc $0395
4522	.a2e9						LA2E9:
4523	.a2e9		60		rts		                rts
4524							                .endif

4526	.a2ea						bputTapeOrROM:
4527	.a2ea		da		phx		                phx
4528	.a2eb		5a		phy		                phy
4529	.a2ec		a9 01		lda #$01	                lda #$01
4530	.a2ee						LA2EE:
4531	.a2ee		20 68 aa	jsr $aa68	                jsr LAA68
4532	.a2f1		a5 e2		lda $e2		                lda $E2
4533	.a2f3		0a		asl a		                asl a
4534	.a2f4		b0 4d		bcs $a343	                bcs LA343
4535	.a2f6		0a		asl a		                asl a
4536	.a2f7		90 08		bcc $a301	                bcc LA301
4537	.a2f9		a9 80		lda #$80	                lda #$80
4538	.a2fb		04 e2		tsb $e2		                tsb $E2
4539	.a2fd		a9 fe		lda #$fe	                lda #$FE
4540	.a2ff		b0 3a		bcs $a33b	                bcs LA33B
4541	.a301						LA301:
4542	.a301		ae 9e 03	ldx $039e	                ldx $039E
4543	.a304		e8		inx		                inx
4544	.a305		ec e9 02	cpx $02e9	                cpx tapeInputCurrentBlockSize+0
4545	.a308		d0 2c		bne $a336	                bne LA336
4546	.a30a		2c eb 02	bit $02eb	                bit blockFlagOfCurrentlyResidentBlock
4547	.a30d		30 23		bmi $a332	                bmi LA332
4548	.a30f		ad ec 02	lda $02ec	                lda lastCharacterOfCurrentlyResidentBlock
4549	.a312		48		pha		                pha
4550	.a313		20 e6 a9	jsr $a9e6	                jsr LA9E6
4551	.a316		08		php		                php
4552	.a317		20 af a5	jsr $a5af	                jsr LA5AF
4553	.a31a		28		plp		                plp
4554	.a31b		68		pla		                pla
4555	.a31c		85 bc		sta $bc		                sta $BC
4556	.a31e		18		clc		                clc
4557	.a31f		2c eb 02	bit $02eb	                bit blockFlagOfCurrentlyResidentBlock
4558	.a322		10 19		bpl $a33d	                bpl LA33D
4559	.a324		ad e9 02	lda $02e9	                lda tapeInputCurrentBlockSize+0
4560	.a327		0d ea 02	ora $02ea	                ora tapeInputCurrentBlockSize+1
4561	.a32a		d0 11		bne $a33d	                bne LA33D
4562	.a32c		a9 40		lda #$40	                lda #$40
4563	.a32e		04 e2		tsb $e2		                tsb $E2
4564	.a330		80 0b		bra $a33d	                bra LA33D

4566	.a332						LA332:
4567	.a332		a9 40		lda #$40	                lda #$40
4568	.a334		04 e2		tsb $e2		                tsb $E2
4569	.a336						LA336:
4570	.a336		ca		dex		                dex
4571	.a337		18		clc		                clc
4572	.a338		bd 00 0a	lda $0a00,x	                lda $0A00,x
4573	.a33b						LA33B:
4574	.a33b		85 bc		sta $bc		                sta $BC
4575	.a33d						LA33D:
4576	.a33d		ee 9e 03	inc $039e	                inc $039E
4577	.a340		4c 97 a2	jmp $a297	                jmp LA297

4579	.a343						LA343:
4580	.a343		20 ed aa	jsr $aaed	                jsr doFollowingError
4581	>a346		df 45 4f 46 00			                .text $df,"EOF",0

4583							                .if version==400
4591							                .endif

4593							                .if version!=400
4594	.a34b						bgetTapeOrROM:
4595	.a34b		85 c4		sta $c4		                sta $C4
4596	.a34d		da		phx		                phx
4597	.a34e		5a		phy		                phy
4598	.a34f		a9 02		lda #$02	                lda #$02
4599	.a351		20 68 aa	jsr $aa68	                jsr LAA68
4600	.a354		ae 9d 03	ldx $039d	                ldx $039D
4601	.a357		a5 c4		lda $c4		                lda $C4
4602	.a359		9d 00 09	sta $0900,x	                sta $0900,x
4603	.a35c		e8		inx		                inx
4604	.a35d		d0 06		bne $a365	                bne LA365
4605	.a35f		20 b8 a2	jsr $a2b8	                jsr LA2B8
4606	.a362		20 bb a9	jsr $a9bb	                jsr LA9BB
4607	.a365						LA365:
4608	.a365		ee 9d 03	inc $039d	                inc $039D
4609	.a368		a5 c4		lda $c4		                lda $C4
4610	.a36a		4c 95 a2	jmp $a295	                jmp LA295
4611							                .endif

4613							                .if version!=400
4614							; TAPE/ROM OSGBPB handler
4615							; =======================
4616	.a36d						osgbpbTapeOrROM:
4617	.a36d		4a		lsr a		                lsr a                        ; Odd numbered calls - change PTR - exit with A=changed, SEC
4618	.a36e		b0 06		bcs $a376	                bcs LA376
4619	.a370		f0 04		beq $a376	                beq LA376                    ; OSGBPB 0 - exit with A=unchanged, SEC
4620	.a372		c9 03		cmp #$03	                cmp #$03                     ; function/2<3 - function<6 - function 2 and 4 - jump to do
4621	.a374		90 02		bcc $a378	                bcc LA378
4622	.a376						LA376:
4623	.a376		38		sec		                sec
4624	.a377		60		rts		                rts
4625							                .endif

4627							; Call Return
4628							;  0    A=0   SEC                        - unsupported
4629							;  1    A=0   SEC  Write using new PTR   - unsupported
4630							;  2    A=         Write with current PTR
4631							;  3    A=1   SEC  Read with new PTR     - unsupported
4632							;  4    A=         Read with current PTR
4633							;  5+   A=A/2 SEC                        - unsupported

4635							; TAPE/ROM OSGBPB 2 and 4 - read/write with current PTR
4636							; -----------------------------------------------------
4637	.a378						LA378:
4638							                .if version!=400
4639	.a378		4a		lsr a		                lsr a
4640							                .endif
4641	.a379		86 cc		stx $cc		                stx $CC
4642	.a37b		84 cd		sty $cd		                sty $CD
4643	.a37d		a0 01		ldy #$01	                ldy #$01
4644	.a37f		b1 cc		lda ($cc),y	                lda ($CC),y
4645	.a381		85 c8		sta $c8		                sta $C8
4646	.a383		c8		iny		                iny
4647	.a384		b1 cc		lda ($cc),y	                lda ($CC),y
4648	.a386		85 c9		sta $c9		                sta $C9
4649							                .if version<500
4650	.a388		c8		iny		                iny
4651	.a389		b1 cc		lda ($cc),y	                lda ($CC),y
4652	.a38b		c8		iny		                iny
4653	.a38c		31 cc		and ($cc),y	                and ($CC),y
4654	.a38e		1a		inc a		                inc a
4655	.a38f		2d 7a 02	and $027a	                and tubePresence
4656	.a392		48		pha		                pha
4657							                .if version!=400
4658	.a393		08		php		                php
4659							                .endif
4660	.a394		f0 11		beq $a3a7	                beq LA3A7
4661	.a396		a6 cc		ldx $cc		                ldx $CC
4662	.a398		a4 cd		ldy $cd		                ldy $CD
4663	.a39a		e8		inx		                inx
4664	.a39b		d0 01		bne $a39e	                bne LA39E
4665	.a39d		c8		iny		                iny
4666	.a39e						LA39E:
4667							                .if version==400
4672							                .else
4673	.a39e		a9 00		lda #$00	                lda #$00
4674	.a3a0		28		plp		                plp
4675	.a3a1		08		php		                php
4676	.a3a2		69 00		adc #$00	                adc #$00
4677							                .endif
4678	.a3a4		20 b0 aa	jsr $aab0	                jsr LAAB0
4679	.a3a7						LA3A7:
4680							                .endif
4681	.a3a7		b2 cc		lda ($cc)	                lda ($CC)
4682	.a3a9		a8		tay		                tay
4683	.a3aa		a9 01		lda #$01	                lda #$01
4684							                .if version!=400
4685							                .if version<500
4686	.a3ac		28		plp		                plp
4687							                .endif
4688	.a3ad		08		php		                php
4689	.a3ae		69 00		adc #$00	                adc #$00
4690							                .endif
4691	.a3b0		20 8d aa	jsr $aa8d	                jsr LAA8D
4692	.a3b3		b0 0c		bcs $a3c1	                bcs LA3C1
4693							                .if version!=400
4694	.a3b5		28		plp		                plp
4695							                .endif
4696							                .if version<500
4697	.a3b6		68		pla		                pla
4698	.a3b7		f0 05		beq $a3be	                beq LA3BE
4699	.a3b9		a9 80		lda #$80	                lda #$80
4700	.a3bb		20 06 04	jsr $0406	                jsr tubeHost.entryPoint
4701	.a3be						LA3BE:
4702							                .endif
4703	.a3be		4c 81 aa	jmp $aa81	                jmp LAA81

4705	.a3c1						LA3C1:
4706							                .if version!=400
4707	.a3c1		28		plp		                plp
4708	.a3c2		b0 3d		bcs $a401	                bcs LA401
4709							                .endif
4710	.a3c4		24 e2		bit $e2		                bit $E2
4711	.a3c6		10 0b		bpl $a3d3	                bpl LA3D3
4712							                .if version<500
4713	.a3c8		68		pla		                pla
4714	.a3c9		f0 05		beq $a3d0	                beq LA3D0
4715	.a3cb		a9 80		lda #$80	                lda #$80
4716	.a3cd		20 06 04	jsr $0406	                jsr tubeHost.entryPoint
4717	.a3d0						LA3D0:
4718							                .endif
4719	.a3d0		4c 43 a3	jmp $a343	                jmp LA343

4721	.a3d3						LA3D3:
4722	.a3d3		20 e0 aa	jsr $aae0	                jsr LAAE0
4723	.a3d6		f0 1e		beq $a3f6	                beq LA3F6
4724	.a3d8		b2 cc		lda ($cc)	                lda ($CC)
4725	.a3da		a8		tay		                tay
4726	.a3db		20 ea a2	jsr $a2ea	                jsr bputTapeOrROM
4727	.a3de		b0 16		bcs $a3f6	                bcs LA3F6
4728							                .if version<500
4729	.a3e0		fa		plx		                plx
4730	.a3e1		da		phx		                phx
4731	.a3e2		f0 05		beq $a3e9	                beq LA3E9
4732	.a3e4		8d e5 fe	sta $fee5	                sta tube.data3
4733	.a3e7		80 08		bra $a3f1	                bra LA3F1

4735	.a3e9						LA3E9:
4736							                .endif
4737	.a3e9		92 c8		sta ($c8)	                sta ($C8)
4738	.a3eb		e6 c8		inc $c8		                inc $C8
4739	.a3ed		d0 02		bne $a3f1	                bne LA3F1
4740	.a3ef		e6 c9		inc $c9		                inc $C9
4741	.a3f1						LA3F1:
4742	.a3f1		20 ca aa	jsr $aaca	                jsr LAACA
4743	.a3f4		80 dd		bra $a3d3	                bra LA3D3

4745	.a3f6						LA3F6:
4746							                .if version<500
4747	.a3f6		68		pla		                pla
4748	.a3f7		08		php		                php
4749	.a3f8		f0 05		beq $a3ff	                beq LA3FF
4750	.a3fa		a9 80		lda #$80	                lda #$80
4751	.a3fc		20 06 04	jsr $0406	                jsr tubeHost.entryPoint
4752	.a3ff						LA3FF:
4753	.a3ff		28		plp		                plp
4754							                .endif
4755	.a400		60		rts		                rts

4757							                .if version!=400
4758	.a401						LA401:
4759	.a401		20 e0 aa	jsr $aae0	                jsr LAAE0
4760	.a404		f0 f0		beq $a3f6	                beq LA3F6
4761	.a406		b2 cc		lda ($cc)	                lda ($CC)
4762	.a408		a8		tay		                tay
4763							                .if version<500
4764	.a409		68		pla		                pla
4765	.a40a		48		pha		                pha
4766	.a40b		f0 05		beq $a412	                beq LA412
4767	.a40d		ad e5 fe	lda $fee5	                lda tube.data3
4768	.a410		80 08		bra $a41a	                bra LA41A
4769	.a412						LA412:
4770							                .endif

4772	.a412		b2 c8		lda ($c8)	                lda ($C8)
4773	.a414		e6 c8		inc $c8		                inc $C8
4774	.a416		d0 02		bne $a41a	                bne LA41A
4775	.a418		e6 c9		inc $c9		                inc $C9
4776	.a41a						LA41A:
4777	.a41a		20 4b a3	jsr $a34b	                jsr bgetTapeOrROM
4778	.a41d		20 ca aa	jsr $aaca	                jsr LAACA
4779	.a420		80 df		bra $a401	                bra LA401
4780							                .endif

4782							; TAPE/ROM FSC 0 - *OPT
4783							; ---------------------
4784	.a422						LA422:
4785	.a422		8a		txa		                txa                          ; *OPT 0
4786	.a423		f0 2e		beq $a453	                beq LA453
4787	.a425		e0 03		cpx #$03	                cpx #$03                     ; *OPT 3
4788	.a427		f0 1f		beq $a448	                beq LA448
4789	.a429		c0 03		cpy #$03	                cpy #$03                     ; *OPT n,3+ - error Bad command (*BUG* should be Bad option)
4790	.a42b		b0 06		bcs $a433	                bcs LA433
4791	.a42d		ca		dex		                dex                          ; *OPT 1
4792	.a42e		f0 06		beq $a436	                beq LA436
4793	.a430		ca		dex		                dex                          ; *OPT 2
4794	.a431		f0 0a		beq $a43d	                beq LA43D
4795	.a433						LA433:
4796	.a433		4c ed fb	jmp $fbed	                jmp mos.badCommandError ; *OPT 4+ - error Bad command (*BUG* should be Bad option)

4798							; *OPT 1 - set message level
4799							; --------------------------
4800	.a436						LA436:
4801	.a436		a9 33		lda #$33	                lda #$33
4802	.a438		c8		iny		                iny
4803	.a439		c8		iny		                iny
4804	.a43a		c8		iny		                iny
4805	.a43b		80 02		bra $a43f	                bra LA43F

4807							; *OPT 2 - set error response level
4808							; ---------------------------------
4809	.a43d						LA43D:
4810	.a43d		a9 cc		lda #$cc	                lda #$CC
4811	.a43f						LA43F:
4812	.a43f		c8		iny		                iny
4813	.a440		25 e3		and $e3		                and $E3
4814	.a442						LA442:
4815	.a442		19 56 a4	ora $a456,y	                ora LA456,y
4816	.a445		85 e3		sta $e3		                sta $E3
4817	.a447		60		rts		                rts

4819							; *OPT 3 - set interblock gap
4820							; ---------------------------
4821	.a448						LA448:
4822	.a448		98		tya		                tya                          ; *OPT 3,128+ - set to default
4823	.a449		30 02		bmi $a44d	                bmi LA44D    ;
4824	.a44b		d0 02		bne $a44f	                bne LA44F                    ; *OPT 3,<>0 - use setting
4825	.a44d						LA44D:
4826	.a44d		a9 19		lda #$19	                lda #$19                     ; *OPT 3,0 or *OPT 3,128+ - use default of 2.5 sec
4827	.a44f						LA44F:
4828	.a44f		8d d1 03	sta $03d1	                sta $03D1                    ; Set inter-block gap
4829	.a452		60		rts		                rts

4831	.a453						LA453:
4832	.a453		a8		tay		                tay
4833	.a454		80 ec		bra $a442	                bra LA442

4835	.a456						LA456:
4836							                ; LDA ($00,x)
4837							                ; EQUB $22
4838							                ; ORA ($00),y
4839							                ; DEY
4840							                ; CPY LC0C6
4841	>a456		a1				                .byte $A1
4842	>a457		00				                .byte $00
4843	>a458		22				                .byte $22
4844	>a459		11				                .byte $11
4845	>a45a		00				                .byte $00
4846	>a45b		88				                .byte $88
4847	>a45c		cc				                .byte $CC

4849							                .if version!=400
4850	.a45d						LA45D:
4851	.a45d		c6 c0		dec $c0		                dec $C0
4852	.a45f		ad 47 02	lda $0247	                lda cfsRFSFSSwitch
4853	.a462		f0 07		beq $a46b	                beq LA46B
4854	.a464		20 10 f7	jsr $f710	                jsr mos.LF710
4855	.a467		a8		tay		                tay
4856	.a468		18		clc		                clc
4857	.a469		80 1a		bra $a485	                bra LA485

4859	.a46b						LA46B:
4860	.a46b		ad 08 fe	lda $fe08	                lda ACIA+0
4861	.a46e		48		pha		                pha
4862	.a46f		29 02		and #$02	                and #$02
4863	.a471		f0 0b		beq $a47e	                beq LA47E
4864	.a473		a4 ca		ldy $ca		                ldy $CA
4865	.a475		f0 07		beq $a47e	                beq LA47E
4866	.a477		68		pla		                pla
4867	.a478		a5 bd		lda $bd		                lda $BD
4868	.a47a		8d 09 fe	sta $fe09	                sta ACIA+1
4869	.a47d		60		rts		                rts

4871	.a47e						LA47E:
4872	.a47e		ac 09 fe	ldy $fe09	                ldy ACIA+1
4873	.a481		68		pla		                pla
4874	.a482		4a		lsr a		                lsr a
4875	.a483		4a		lsr a		                lsr a
4876	.a484		4a		lsr a		                lsr a
4877	.a485						LA485:
4878	.a485		a6 c2		ldx $c2		                ldx $C2
4879	.a487		f0 67		beq $a4f0	                beq LA4F0
4880	.a489		ca		dex		                dex
4881	.a48a		d0 06		bne $a492	                bne LA492
4882	.a48c		90 62		bcc $a4f0	                bcc LA4F0
4883	.a48e		a0 02		ldy #$02	                ldy #$02
4884	.a490		80 5c		bra $a4ee	                bra LA4EE
4885							                .endif

4887	.a492						LA492:
4888							                .if version==400
4897							                .else
4898	.a492		ca		dex		                dex
4899	.a493		d0 13		bne $a4a8	                bne LA4A8
4900	.a495		b0 59		bcs $a4f0	                bcs LA4F0
4901							                .endif
4902	.a497		98		tya		                tya
4903	.a498		20 44 aa	jsr $aa44	                jsr LAA44
4904	.a49b		a0 03		ldy #$03	                ldy #$03
4905	.a49d		c9 2a		cmp #$2a	                cmp #$2A
4906	.a49f		f0 4d		beq $a4ee	                beq LA4EE
4907	.a4a1		20 1c aa	jsr $aa1c	                jsr LAA1C
4908	.a4a4		a0 01		ldy #$01	                ldy #$01
4909	.a4a6		80 46		bra $a4ee	                bra LA4EE

4911	.a4a8						LA4A8:
4912	.a4a8		ca		dex		                dex
4913	.a4a9		d0 0a		bne $a4b5	                bne LA4B5
4914							                .if version!=400
4915	.a4ab		b0 03		bcs $a4b0	                bcs LA4B0
4916							                .endif
4917	.a4ad		84 bd		sty $bd		                sty $BD
4918	.a4af		60		rts		                rts

4920							                .if version!=400
4921	.a4b0						LA4B0:
4922	.a4b0		a9 80		lda #$80	                lda #$80
4923	.a4b2		85 c0		sta $c0		                sta $C0
4924	.a4b4		60		rts		                rts
4925							                .endif

4927	.a4b5						LA4B5:
4928	.a4b5		ca		dex		                dex
4929	.a4b6		d0 29		bne $a4e1	                bne LA4E1
4930							                .if version!=400
4931	.a4b8		b0 2f		bcs $a4e9	                bcs LA4E9
4932							                .endif
4933	.a4ba		98		tya		                tya
4934	.a4bb		20 a9 a6	jsr $a6a9	                jsr LA6A9
4935	.a4be		a4 bc		ldy $bc		                ldy $BC
4936	.a4c0		e6 bc		inc $bc		                inc $BC
4937	.a4c2		24 bd		bit $bd		                bit $BD
4938	.a4c4		30 0d		bmi $a4d3	                bmi LA4D3
4939							                .if version<500
4940	.a4c6		20 bc aa	jsr $aabc	                jsr LAABC
4941	.a4c9		f0 05		beq $a4d0	                beq LA4D0
4942	.a4cb		8e e5 fe	stx $fee5	                stx tube.data3
4943	.a4ce		80 03		bra $a4d3	                bra LA4D3

4945	.a4d0						LA4D0:
4946	.a4d0		8a		txa		                txa
4947							                .endif
4948	.a4d1		91 b0		sta ($b0),y	                sta ($B0),y
4949	.a4d3						LA4D3:
4950	.a4d3		c8		iny		                iny
4951	.a4d4		cc c8 03	cpy $03c8	                cpy $03C8
4952	.a4d7		d0 17		bne $a4f0	                bne LA4F0
4953	.a4d9		a9 01		lda #$01	                lda #$01
4954	.a4db		85 bc		sta $bc		                sta $BC
4955	.a4dd		a0 05		ldy #$05	                ldy #$05
4956	.a4df		80 0d		bra $a4ee	                bra LA4EE

4958	.a4e1						LA4E1:
4959	.a4e1		98		tya		                tya
4960	.a4e2		20 a9 a6	jsr $a6a9	                jsr LA6A9
4961	.a4e5		c6 bc		dec $bc		                dec $BC
4962	.a4e7		10 07		bpl $a4f0	                bpl LA4F0
4963							                .if version!=400
4964	.a4e9						LA4E9:
4965	.a4e9		20 12 aa	jsr $aa12	                jsr resetACIA
4966							                .endif
4967	.a4ec		a0 00		ldy #$00	                ldy #$00
4968	.a4ee						LA4EE:
4969	.a4ee		84 c2		sty $c2		                sty $C2
4970	.a4f0						LA4F0:
4971	.a4f0		60		rts		                rts

4973							; TAPE/ROM FSC 1 - =EOF
4974							; ---------------------
4975	.a4f1						LA4F1:
4976	.a4f1		48		pha		                pha
4977	.a4f2		5a		phy		                phy
4978	.a4f3		8a		txa		                txa
4979	.a4f4		a8		tay		                tay
4980	.a4f5		a9 03		lda #$03	                lda #$03                     ; Check if this channel is open for anything
4981	.a4f7		20 68 aa	jsr $aa68	                jsr LAA68
4982	.a4fa		a5 e2		lda $e2		                lda $E2                      ; Get EOF flag
4983	.a4fc		29 40		and #$40	                and #$40
4984	.a4fe		aa		tax		                tax                          ; Return in X
4985	.a4ff		7a		ply		                ply
4986	.a500		68		pla		                pla
4987	.a501		60		rts		                rts

4989	.a502						LA502:
4990	.a502		64 b4		stz $b4		                stz $B4
4991	.a504		64 b5		stz $b5		                stz $B5
4992	.a506						LA506:
4993	.a506		46 ce		lsr $ce		                lsr $CE
4994	.a508		a5 b4		lda $b4		                lda $B4
4995	.a50a		48		pha		                pha
4996	.a50b		85 b6		sta $b6		                sta $B6
4997	.a50d		a5 b5		lda $b5		                lda $B5
4998	.a50f		48		pha		                pha
4999	.a510		85 b7		sta $b7		                sta $B7
5000	.a512		20 23 a9	jsr $a923	                jsr LA923
5001	>a515		53 65 61 72 63 68 69 6e		                .text "Searching",13,0
	>a51d		67 0d 00
5002	.a520		a9 ff		lda #$ff	                lda #$ff
5003	.a522		20 7c a1	jsr $a17c	                jsr LA17C
5004	.a525		68		pla		                pla
5005	.a526		85 b5		sta $b5		                sta $B5
5006	.a528		68		pla		                pla
5007	.a529		85 b4		sta $b4		                sta $B4
5008	.a52b		a5 b6		lda $b6		                lda $B6
5009	.a52d		05 b7		ora $b7		                ora $B7
5010	.a52f		d0 33		bne $a564	                bne LA564
5011	.a531		64 b4		stz $b4		                stz $B4
5012	.a533		64 b5		stz $b5		                stz $B5
5013							                .if version!=400
5014	.a535		ad 47 02	lda $0247	                lda cfsRFSFSSwitch
5015	.a538		f0 21		beq $a55b	                beq LA55B
5016							                .endif
5017	.a53a		70 1f		bvs $a55b	                bvs LA55B
5018							                .if version!=400
5019	.a53c		20 ca a9	jsr $a9ca	                jsr LA9CA
5020							                .endif
5021	.a53f		24 ce		bit $ce		                bit $CE
5022	.a541		50 0a		bvc $a54d	                bvc notFoundError
5023	.a543		38		sec		                sec
5024	.a544						rtsA544:
5025	.a544		60		rts		                rts

5027							;-------------------------------------------------------------------------

5029	.a545						openFileForReading:
5030	.a545		a9 40		lda #$40	                lda #$40                     ;open for reading
5031	.a547		20 ce ff	jsr $ffce	                jsr OSFIND
5032	.a54a		a8		tay		                tay
5033	.a54b		d0 f7		bne $a544	                bne rtsA544
5034	.a54d						notFoundError:
5035	.a54d		20 ed aa	jsr $aaed	                jsr doFollowingError
5036	>a550		d6 4e 6f 74 20 66 6f 75		                .text $d6,"Not found",0
	>a558		6e 64 00

5038							;-------------------------------------------------------------------------

5040	.a55b						LA55B:
5041	.a55b		a5 c1		lda $c1		                lda $C1
5042	.a55d		d0 05		bne $a564	                bne LA564
5043	.a55f		a2 b1		ldx #$b1	                ldx #$B1
5044	.a561		20 4d aa	jsr $aa4d	                jsr LAA4D
5045	.a564						LA564:
5046	.a564		a0 ff		ldy #$ff	                ldy #$FF
5047	.a566		8c df 03	sty $03df	                sty $03DF
5048	.a569		18		clc		                clc
5049	.a56a		60		rts		                rts

5051	.a56b						LA56B:
5052	.a56b		f0 17		beq $a584	                beq LA584
5053	.a56d		48		pha		                pha
5054	.a56e		a9 07		lda #$07	                lda #fscFileHandleRange
5055	.a570		20 e5 f1	jsr $f1e5	                jsr mos.callFSCV
5056	.a573		68		pla		                pla
5057	.a574		18		clc		                clc
5058	.a575		08		php		                php
5059	.a576		78		sei		                sei
5060	.a577		85 fa		sta $fa		                sta $FA
5061	.a579		c4 fa		cpy $fa		                cpy $FA
5062	.a57b		90 06		bcc $a583	                bcc LA583
5063	.a57d		e4 fa		cpx $fa		                cpx $FA
5064	.a57f		90 06		bcc $a587	                bcc LA587
5065	.a581		f0 04		beq $a587	                beq LA587
5066	.a583						LA583:
5067	.a583		28		plp		                plp
5068	.a584						LA584:
5069	.a584		68		pla		                pla
5070	.a585		68		pla		                pla
5071	.a586		60		rts		                rts

5073	.a587						LA587:
5074	.a587		28		plp		                plp
5075	.a588		a9 00		lda #$00	                lda #$00
5076	.a58a		60		rts		                rts

5078	.a58b						LA58B:
5079	.a58b		ad 56 02	lda $0256	                lda execFileHandle
5080	.a58e		20 6b a5	jsr $a56b	                jsr LA56B
5081	.a591						starEXEC:
5082	.a591		08		php		                php
5083	.a592		5a		phy		                phy
5084	.a593		ac 56 02	ldy $0256	                ldy execFileHandle
5085	.a596		8d 56 02	sta $0256	                sta execFileHandle
5086	.a599		f0 03		beq $a59e	                beq LA59E
5087	.a59b		20 ce ff	jsr $ffce	                jsr OSFIND
5088	.a59e						LA59E:
5089	.a59e		4e c6 df	lsr $dfc6	                lsr hazel.tempFSFlag
5090	.a5a1		7a		ply		                ply
5091	.a5a2		28		plp		                plp
5092	.a5a3		f0 09		beq $a5ae	                beq LA5AE
5093	.a5a5		0e c6 df	asl $dfc6	                asl hazel.tempFSFlag
5094	.a5a8		20 45 a5	jsr $a545	                jsr openFileForReading
5095	.a5ab		8d 56 02	sta $0256	                sta execFileHandle
5096	.a5ae						LA5AE:
5097	.a5ae		60		rts		                rts

5099	.a5af						LA5AF:
5100	.a5af		a2 a6		ldx #$a6	                ldx #$A6
5101	.a5b1		20 4d aa	jsr $aa4d	                jsr LAA4D
5102	.a5b4		20 78 a6	jsr $a678	                jsr LA678
5103	.a5b7						LA5B7:
5104	.a5b7		ad ca 03	lda $03ca	                lda $03CA
5105	.a5ba		4a		lsr a		                lsr a
5106	.a5bb		90 03		bcc $a5c0	                bcc LA5C0
5107	.a5bd		4c e3 9f	jmp $9fe3	                jmp L9FE3

5109	.a5c0						LA5C0:
5110	.a5c0		ad dd 03	lda $03dd	                lda $03DD
5111	.a5c3		85 b4		sta $b4		                sta $B4
5112	.a5c5		ad de 03	lda $03de	                lda $03DE
5113	.a5c8		85 b5		sta $b5		                sta $B5
5114	.a5ca		64 b0		stz $b0		                stz $B0
5115	.a5cc		a9 0a		lda #$0a	                lda #$0A
5116	.a5ce		85 b1		sta $b1		                sta $B1
5117	.a5d0		a9 ff		lda #$ff	                lda #$FF
5118	.a5d2		85 b2		sta $b2		                sta $B2
5119	.a5d4		85 b3		sta $b3		                sta $B3
5120	.a5d6		20 d2 a6	jsr $a6d2	                jsr LA6D2
5121	.a5d9		20 a1 a8	jsr $a8a1	                jsr LA8A1
5122	.a5dc		d0 25		bne $a603	                bne LA603
5123	.a5de		ad ff 0a	lda $0aff	                lda $0AFF
5124	.a5e1		8d ec 02	sta $02ec	                sta lastCharacterOfCurrentlyResidentBlock
5125	.a5e4		20 35 aa	jsr $aa35	                jsr LAA35
5126	.a5e7		8e dd 03	stx $03dd	                stx $03DD
5127	.a5ea		8c de 03	sty $03de	                sty $03DE
5128	.a5ed		a2 02		ldx #$02	                ldx #$02
5129	.a5ef						LA5EF:
5130	.a5ef		bd c8 03	lda $03c8,x	                lda $03C8,x
5131	.a5f2		9d e9 02	sta $02e9,x	                sta tapeInputCurrentBlockSize+0,x
5132	.a5f5		ca		dex		                dex
5133	.a5f6		10 f7		bpl $a5ef	                bpl LA5EF
5134	.a5f8		2c eb 02	bit $02eb	                bit blockFlagOfCurrentlyResidentBlock
5135	.a5fb		10 03		bpl $a600	                bpl LA600
5136	.a5fd		20 59 a0	jsr $a059	                jsr LA059
5137	.a600						LA600:
5138	.a600		4c c5 a9	jmp $a9c5	                jmp LA9C5

5140	.a603						LA603:
5141	.a603		20 06 a5	jsr $a506	                jsr LA506
5142	.a606		80 af		bra $a5b7	                bra LA5B7

5144	.a608						LA608:
5145	.a608		c9 2a		cmp #$2a	                cmp #'*'
5146	.a60a		f0 37		beq $a643	                beq LA643
5147	.a60c		c9 23		cmp #$23	                cmp #'#'
5148	.a60e		d0 0f		bne $a61f	                bne LA61F
5149	.a610		ee c6 03	inc $03c6	                inc $03C6
5150	.a613		d0 03		bne $a618	                bne LA618
5151	.a615		ee c7 03	inc $03c7	                inc $03C7
5152	.a618						LA618:
5153	.a618		a2 ff		ldx #$ff	                ldx #$FF
5154	.a61a		2c 4e e3	bit $e34e	                bit mos.valueFF
5155	.a61d		80 51		bra $a670	                bra LA670

5157	.a61f						LA61F:
5158	.a61f		20 77 a1	jsr $a177	                jsr LA177
5159	.a622		20 ed aa	jsr $aaed	                jsr doFollowingError
5160	>a625		d7				                .byte $D7
5161	>a626		42 61 64 20 52 4f 4d		                .text "Bad ROM"
5162	>a62d		00				                .byte 0

5164	.a62e						LA62E:
5165							                .if version!=400
5166	.a62e		a0 ff		ldy #$ff	                ldy #$FF
5167	.a630		20 5c aa	jsr $aa5c	                jsr LAA5C
5168	.a633		a9 01		lda #$01	                lda #$01
5169	.a635		85 c2		sta $c2		                sta $C2
5170	.a637		20 1c aa	jsr $aa1c	                jsr LAA1C
5171	.a63a						LA63A:
5172	.a63a		20 80 a8	jsr $a880	                jsr LA880
5173	.a63d		a9 03		lda #$03	                lda #$03
5174	.a63f		c5 c2		cmp $c2		                cmp $C2
5175	.a641		d0 f7		bne $a63a	                bne LA63A
5176							                .endif
5177	.a643						LA643:
5178	.a643		20 46 aa	jsr $aa46	                jsr LAA46
5179	.a646						LA646:
5180	.a646		20 94 a6	jsr $a694	                jsr LA694
5181	.a649		50 1a		bvc $a665	                bvc LA665
5182	.a64b		99 b2 03	sta $03b2,y	                sta $03B2,y
5183	.a64e		f0 06		beq $a656	                beq LA656
5184	.a650		c8		iny		                iny
5185	.a651		c0 0b		cpy #$0b	                cpy #$0B
5186	.a653		d0 f1		bne $a646	                bne LA646
5187	.a655		88		dey		                dey
5188	.a656						LA656:
5189	.a656		a2 0c		ldx #$0c	                ldx #$0C
5190	.a658						LA658:
5191	.a658		20 94 a6	jsr $a694	                jsr LA694
5192	.a65b		50 08		bvc $a665	                bvc LA665
5193	.a65d		9d b2 03	sta $03b2,x	                sta $03B2,x
5194	.a660		e8		inx		                inx
5195	.a661		e0 1f		cpx #$1f	                cpx #$1F
5196	.a663		d0 f3		bne $a658	                bne LA658
5197	.a665						LA665:
5198	.a665		98		tya		                tya
5199	.a666		aa		tax		                tax
5200	.a667		9e b2 03	stz $03b2,x	                stz $03B2,x
5201	.a66a		a5 be		lda $be		                lda $BE
5202	.a66c		05 bf		ora $bf		                ora $BF
5203	.a66e		85 c1		sta $c1		                sta $C1
5204	.a670						LA670:
5205	.a670		20 44 aa	jsr $aa44	                jsr LAA44
5206	.a673		84 c2		sty $c2		                sty $C2
5207	.a675		8a		txa		                txa
5208							                .if version<500
5209	.a676		d0 54		bne $a6cc	                bne LA6CC
5212							                .endif
5213	.a678						LA678:
5214							                .if version!=400
5215	.a678		ad 47 02	lda $0247	                lda cfsRFSFSSwitch
5216	.a67b		f0 b1		beq $a62e	                beq LA62E
5217							                .endif
5218	.a67d						LA67D:
5219	.a67d		20 10 f7	jsr $f710	                jsr mos.LF710
5220	.a680		c9 2b		cmp #$2b	                cmp #$2B
5221	.a682		d0 84		bne $a608	                bne LA608
5222	.a684		a9 08		lda #$08	                lda #$08
5223	.a686		25 e2		and $e2		                and $E2
5224	.a688		f0 03		beq $a68d	                beq LA68D
5225	.a68a		20 5d a0	jsr $a05d	                jsr LA05D
5226	.a68d						LA68D:
5227	.a68d		20 01 f7	jsr $f701	                jsr mos.LF701
5228	.a690		90 eb		bcc $a67d	                bcc LA67D
5229	.a692		b8		clv		                clv
5230	.a693		60		rts		                rts

5232	.a694						LA694:
5233							                .if version!=400
5234	.a694		ad 47 02	lda $0247	                lda cfsRFSFSSwitch
5235	.a697		f0 0d		beq $a6a6	                beq LA6A6
5236							                .endif
5237	.a699		da		phx		                phx
5238	.a69a		5a		phy		                phy
5239	.a69b		20 10 f7	jsr $f710	                jsr mos.LF710
5240	.a69e		85 bd		sta $bd		                sta $BD
5241	.a6a0		a9 ff		lda #$ff	                lda #$FF
5242	.a6a2		85 c0		sta $c0		                sta $C0
5243	.a6a4		7a		ply		                ply
5244	.a6a5		fa		plx		                plx
5245	.a6a6						LA6A6:
5246	.a6a6		20 78 a7	jsr $a778	                jsr LA778
5247	.a6a9						LA6A9:
5248							                .if version<500
5249	.a6a9		08		php		                php
5250	.a6aa		48		pha		                pha
5251	.a6ab		38		sec		                sec
5252	.a6ac		66 cb		ror $cb		                ror $CB
5253	.a6ae		45 bf		eor $bf		                eor $BF
5254	.a6b0		85 bf		sta $bf		                sta $BF
5255	.a6b2						LA6B2:
5256	.a6b2		a5 bf		lda $bf		                lda $BF
5257	.a6b4		18		clc		                clc
5258	.a6b5		10 0b		bpl $a6c2	                bpl LA6C2
5259	.a6b7		49 08		eor #$08	                eor #$08
5260	.a6b9		85 bf		sta $bf		                sta $BF
5261	.a6bb		a5 be		lda $be		                lda $BE
5262	.a6bd		49 10		eor #$10	                eor #$10
5263	.a6bf		85 be		sta $be		                sta $BE
5264	.a6c1		38		sec		                sec
5265	.a6c2						LA6C2:
5266	.a6c2		26 be		rol $be		                rol $BE
5267	.a6c4		26 bf		rol $bf		                rol $BF
5268	.a6c6		46 cb		lsr $cb		                lsr $CB
5269	.a6c8		d0 e8		bne $a6b2	                bne LA6B2
5270	.a6ca		68		pla		                pla
5271	.a6cb		28		plp		                plp
5272							                .endif
5273	.a6cc						LA6CC:
5274	.a6cc		60		rts		                rts

5276							                .if version!=400
5277	.a6cd						LA6CD:                                       ;AAA6 in MOS 5.00
5278	.a6cd		20 76 a7	jsr $a776	                jsr LA776
5279	.a6d0		80 d7		bra $a6a9	                bra LA6A9
5280							                .endif

5282	.a6d2						LA6D2:                                       ;AAAB in MOS 5.00
5283	.a6d2		a9 00		lda #$00	                lda #$00
5284	.a6d4						LA6D4:
5285	.a6d4		85 bd		sta $bd		                sta $BD
5286	.a6d6		a2 00		ldx #$00	                ldx #$00
5287	.a6d8		64 bc		stz $bc		                stz $BC
5288	.a6da		50 0a		bvc $a6e6	                bvc LA6E6
5289	.a6dc		ad c8 03	lda $03c8	                lda $03C8
5290	.a6df		0d c9 03	ora $03c9	                ora $03C9
5291	.a6e2		f0 02		beq $a6e6	                beq LA6E6
5292	.a6e4		a2 04		ldx #$04	                ldx #$04
5293	.a6e6						LA6E6:
5294	.a6e6		86 c2		stx $c2		                stx $C2
5295	.a6e8						rtsAAC1:
5296	.a6e8		60		rts		                rts

5298							                .if version!=400
5299	.a6e9						LA6E9:                                       ;AAC2 in MOS 5.00
5300	.a6e9		08		php		                php
5301	.a6ea		a2 03		ldx #$03	                ldx #$03
5302	.a6ec						LA6EC:
5303	.a6ec		9e cb 03	stz $03cb,x	                stz $03CB,x
5304	.a6ef		ca		dex		                dex
5305	.a6f0		10 fa		bpl $a6ec	                bpl LA6EC
5306	.a6f2		ad c6 03	lda $03c6	                lda $03C6
5307	.a6f5		0d c7 03	ora $03c7	                ora $03C7
5308	.a6f8		d0 05		bne $a6ff	                bne LA6FF
5309	.a6fa		20 84 a7	jsr $a784	                jsr LA784
5310	.a6fd		80 03		bra $a702	                bra LA702

5312	.a6ff						LA6FF:
5313	.a6ff		20 88 a7	jsr $a788	                jsr LA788
5314	.a702						LA702:
5315	.a702		a9 2a		lda #$2a	                lda #$2A
5316	.a704		85 bd		sta $bd		                sta $BD
5317	.a706		20 44 aa	jsr $aa44	                jsr LAA44
5318	.a709		20 16 aa	jsr $aa16	                jsr LAA16
5319	.a70c		20 78 a7	jsr $a778	                jsr LA778
5320	.a70f		88		dey		                dey
5321	.a710						LA710:
5322	.a710		c8		iny		                iny
5323	.a711		b9 d2 03	lda $03d2,y	                lda $03D2,y
5324	.a714		99 b2 03	sta $03b2,y	                sta $03B2,y
5325	.a717		20 cd a6	jsr $a6cd	                jsr LA6CD
5326	.a71a		d0 f4		bne $a710	                bne LA710
5327	.a71c		a2 0c		ldx #$0c	                ldx #$0C
5328	.a71e						LA71E:
5329	.a71e		bd b2 03	lda $03b2,x	                lda $03B2,x
5330	.a721		20 cd a6	jsr $a6cd	                jsr LA6CD
5331	.a724		e8		inx		                inx
5332	.a725		e0 1d		cpx #$1d	                cpx #$1D
5333	.a727		d0 f5		bne $a71e	                bne LA71E
5334	.a729		20 6f a7	jsr $a76f	                jsr LA76F
5335	.a72c		ad c8 03	lda $03c8	                lda $03C8
5336	.a72f		0d c9 03	ora $03c9	                ora $03C9
5337	.a732		f0 1b		beq $a74f	                beq LA74F
5338	.a734		20 46 aa	jsr $aa46	                jsr LAA46
5339	.a737						LA737:
5340							                .if version<500
5341	.a737		20 bc aa	jsr $aabc	                jsr LAABC
5342	.a73a		f0 05		beq $a741	                beq LA741
5343	.a73c		ad e5 fe	lda $fee5	                lda tube.data3
5344	.a73f		80 02		bra $a743	                bra LA743
5345	.a741						LA741:
5346							                .endif
5347	.a741		b1 b0		lda ($b0),y	                lda ($B0),y
5348	.a743						LA743:
5349	.a743		20 cd a6	jsr $a6cd	                jsr LA6CD
5350	.a746		c8		iny		                iny
5351	.a747		cc c8 03	cpy $03c8	                cpy $03C8
5352	.a74a		d0 eb		bne $a737	                bne LA737
5353	.a74c		20 6f a7	jsr $a76f	                jsr LA76F
5354	.a74f						LA74F:
5355	.a74f		20 78 a7	jsr $a778	                jsr LA778
5356	.a752		20 78 a7	jsr $a778	                jsr LA778
5357	.a755		20 12 aa	jsr $aa12	                jsr resetACIA
5358	.a758		a9 01		lda #$01	                lda #$01
5359	.a75a		20 8a a7	jsr $a78a	                jsr LA78A
5360	.a75d		28		plp		                plp
5361	.a75e		20 ab a7	jsr $a7ab	                jsr LA7AB
5362	.a761		2c ca 03	bit $03ca	                bit $03CA
5363	.a764		10 08		bpl $a76e	                bpl LA76E
5364	.a766		08		php		                php
5365	.a767		20 84 a7	jsr $a784	                jsr LA784
5366	.a76a		20 56 a0	jsr $a056	                jsr LA056
5367	.a76d		28		plp		                plp
5368	.a76e						LA76E:
5369	.a76e		60		rts		                rts

5371	.a76f						LA76F:
5372							                .if version<500
5373	.a76f		a5 bf		lda $bf		                lda $BF
5376							                .endif
5377	.a771		20 76 a7	jsr $a776	                jsr LA776
5378							                .if version<500
5379	.a774		a5 be		lda $be		                lda $BE
5382							                .endif
5383	.a776						LA776:
5384	.a776		85 bd		sta $bd		                sta $BD
5385							                .endif

5387	.a778						LA778:
5388	.a778		20 80 a8	jsr $a880	                jsr LA880
5389	.a77b		24 c0		bit $c0		                bit $C0
5390	.a77d		10 f9		bpl $a778	                bpl LA778
5391	.a77f		64 c0		stz $c0		                stz $C0
5392	.a781		a5 bd		lda $bd		                lda $BD
5393	.a783		60		rts		                rts

5395							                .if version!=400
5396	.a784						LA784:
5397	.a784		a9 32		lda #$32	                lda #$32
5398	.a786		80 02		bra $a78a	                bra LA78A

5400	.a788						LA788:
5401	.a788		a5 c7		lda $c7		                lda $C7
5402	.a78a						LA78A:
5403	.a78a		a2 05		ldx #$05	                ldx #$05
5404	.a78c						LA78C:
5405	.a78c		8d 40 02	sta $0240	                sta cfsTimeoutCounter
5406	.a78f						LA78F:
5407	.a78f		20 80 a8	jsr $a880	                jsr LA880
5408	.a792		2c 40 02	bit $0240	                bit cfsTimeoutCounter
5409	.a795		10 f8		bpl $a78f	                bpl LA78F
5410	.a797		ca		dex		                dex
5411	.a798		d0 f2		bne $a78c	                bne LA78C
5412	.a79a		60		rts		                rts
5413							                .endif

5415	.a79b						LA79B:
5416	.a79b		ad c6 03	lda $03c6	                lda $03C6
5417	.a79e		0d c7 03	ora $03c7	                ora $03C7
5418	.a7a1		f0 05		beq $a7a8	                beq LA7A8
5419	.a7a3		2c df 03	bit $03df	                bit $03DF
5420	.a7a6		10 03		bpl $a7ab	                bpl LA7AB
5421	.a7a8						LA7A8:
5422	.a7a8		20 59 a0	jsr $a059	                jsr LA059
5423	.a7ab						LA7AB:
5424	.a7ab		a0 00		ldy #$00	                ldy #$00
5425	.a7ad		64 ba		stz $ba		                stz $BA
5426	.a7af		ad ca 03	lda $03ca	                lda $03CA
5427	.a7b2		8d df 03	sta $03df	                sta $03DF
5428	.a7b5		20 1b ef	jsr $ef1b	                jsr mos.LEF1B
5429	.a7b8		f0 67		beq $a821	                beq LA821
5430	.a7ba		a9 0d		lda #$0d	                lda #$0D
5431	.a7bc		20 ee ff	jsr $ffee	                jsr OSWRCH
5432	.a7bf						LA7BF:
5433	.a7bf		b9 b2 03	lda $03b2,y	                lda $03B2,y
5434	.a7c2		f0 10		beq $a7d4	                beq LA7D4
5435	.a7c4		c9 20		cmp #$20	                cmp #$20
5436	.a7c6		90 04		bcc $a7cc	                bcc LA7CC
5437	.a7c8		c9 7f		cmp #$7f	                cmp #$7F
5438	.a7ca		90 02		bcc $a7ce	                bcc LA7CE
5439	.a7cc						LA7CC:
5440	.a7cc		a9 3f		lda #$3f	                lda #$3F
5441	.a7ce						LA7CE:
5442	.a7ce		20 ee ff	jsr $ffee	                jsr OSWRCH
5443	.a7d1		c8		iny		                iny
5444	.a7d2		d0 eb		bne $a7bf	                bne LA7BF

5446	.a7d4						LA7D4:
5447							                .if version!=400
5448	.a7d4		ad 47 02	lda $0247	                lda cfsRFSFSSwitch
5449	.a7d7		f0 04		beq $a7dd	                beq LA7DD
5450							                .endif
5451	.a7d9		24 bb		bit $bb		                bit $BB
5452	.a7db		50 44		bvc $a821	                bvc LA821
5453	.a7dd						LA7DD:
5454	.a7dd		20 0c 9f	jsr $9f0c	                jsr printSpace
5455	.a7e0		c8		iny		                iny
5456	.a7e1		c0 0b		cpy #$0b	                cpy #$0B
5457	.a7e3		90 ef		bcc $a7d4	                bcc LA7D4
5458	.a7e5		ad c6 03	lda $03c6	                lda $03C6
5459	.a7e8		aa		tax		                tax
5460	.a7e9		20 6a a8	jsr $a86a	                jsr printHexByte
5461	.a7ec		2c ca 03	bit $03ca	                bit $03CA
5462	.a7ef		10 30		bpl $a821	                bpl LA821
5463	.a7f1		8a		txa		                txa
5464	.a7f2		18		clc		                clc
5465	.a7f3		6d c9 03	adc $03c9	                adc $03C9
5466	.a7f6		20 65 a8	jsr $a865	                jsr printSpaceThenPrintHexByte
5467	.a7f9						LA7F9:
5468	.a7f9		ad c8 03	lda $03c8	                lda $03C8
5469	.a7fc		20 6a a8	jsr $a86a	                jsr printHexByte
5470	.a7ff		24 bb		bit $bb		                bit $BB
5471	.a801		50 1e		bvc $a821	                bvc LA821
5472	.a803		a2 04		ldx #$04	                ldx #$04
5473	.a805						LA805:
5474	.a805		20 0c 9f	jsr $9f0c	                jsr printSpace
5475	.a808		ca		dex		                dex
5476	.a809		d0 fa		bne $a805	                bne LA805
5477	.a80b		a2 0f		ldx #$0f	                ldx #$0F
5478	.a80d		20 15 a8	jsr $a815	                jsr LA815
5479	.a810		20 0c 9f	jsr $9f0c	                jsr printSpace
5480	.a813		a2 13		ldx #$13	                ldx #$13
5481	.a815						LA815:
5482	.a815		a0 04		ldy #$04	                ldy #$04
5483	.a817						LA817:
5484	.a817		bd b2 03	lda $03b2,x	                lda $03B2,x
5485	.a81a		20 6a a8	jsr $a86a	                jsr printHexByte
5486	.a81d		ca		dex		                dex
5487	.a81e		88		dey		                dey
5488	.a81f		d0 f6		bne $a817	                bne LA817
5489	.a821						LA821:
5490	.a821		60		rts		                rts

5492							                .if version!=400
5493	.a822						LA822:
5494	.a822		ad 47 02	lda $0247	                lda cfsRFSFSSwitch
5495	.a825		f0 06		beq $a82d	                beq LA82D
5496	.a827		20 ca a9	jsr $a9ca	                jsr LA9CA
5497	.a82a		4c ed fb	jmp $fbed	                jmp mos.badCommandError

5499	.a82d						LA82D:
5500	.a82d		20 5a aa	jsr $aa5a	                jsr LAA5A
5501	.a830		20 a0 aa	jsr $aaa0	                jsr LAAA0
5502	.a833		20 1b ef	jsr $ef1b	                jsr mos.LEF1B
5503	.a836		f0 e9		beq $a821	                beq LA821
5504	.a838		20 23 a9	jsr $a923	                jsr LA923
5505	>a83b		52 45 43 4f 52 44 20 74		                .text "RECORD then RETURN"
	>a843		68 65 6e 20 52 45 54 55 52 4e
5506	>a84d		00				                .byte $00

5508	.a84e						LA84E:
5509	.a84e		20 80 a8	jsr $a880	                jsr LA880
5510	.a851		20 e0 ff	jsr $ffe0	                jsr OSRDCH
5511	.a854		c9 0d		cmp #$0d	                cmp #$0D
5512	.a856		d0 f6		bne $a84e	                bne LA84E
5513	.a858		4c e7 ff	jmp $ffe7	                jmp OSNEWL
5514							                .endif

5516							;-------------------------------------------------------------------------

5518							                .if version==350
5520							                .endif

5522							;-------------------------------------------------------------------------


5525	.a85b						LA85B:
5526	.a85b		a2 fd		ldx #$fd	                ldx #$FD
5527	.a85d						LA85D:
5528	.a85d		f6 b4		inc $b4,x	                inc $B4,x
5529	.a85f		d0 03		bne $a864	                bne LA864
5530	.a861		e8		inx		                inx
5531	.a862		d0 f9		bne $a85d	                bne LA85D
5532	.a864						LA864:
5533	.a864		60		rts		                rts

5535							;-------------------------------------------------------------------------

5537	.a865						printSpaceThenPrintHexByte:
5538	.a865		48		pha		                pha
5539	.a866		20 0c 9f	jsr $9f0c	                jsr printSpace
5540	.a869		68		pla		                pla
5541	.a86a						printHexByte:
5542	.a86a		48		pha		                pha
5543							                .if version==350
5545							                .else
5546	.a86b		4a		lsr a		                lsr a
5547	.a86c		4a		lsr a		                lsr a
5548	.a86d		4a		lsr a		                lsr a
5549	.a86e		4a		lsr a		                lsr a
5550							                .endif
5551	.a86f		20 73 a8	jsr $a873	                jsr printHexDigit
5552	.a872		68		pla		                pla
5553	.a873						printHexDigit:
5554	.a873		29 0f		and #$0f	                and #$0F
5555	.a875		09 30		ora #$30	                ora #'0'                     ;+'0'
5556	.a877		c9 3a		cmp #$3a	                cmp #'9'+1
5557	.a879		90 02		bcc $a87d	                bcc LA87D                    ;taken if <='9'
5558	.a87b		69 06		adc #$06	                adc #'A'-('9'+1)-1           ;adjust - -1 because C set
5559	.a87d						LA87D:
5560	.a87d		4c ee ff	jmp $ffee	                jmp OSWRCH

5562							;-------------------------------------------------------------------------

5564	.a880						LA880:
5565	.a880		08		php		                php
5566	.a881		24 eb		bit $eb		                bit $EB
5567	.a883		30 04		bmi $a889	                bmi LA889
5568	.a885		24 ff		bit $ff		                bit $FF
5569	.a887		30 02		bmi $a88b	                bmi LA88B
5570	.a889						LA889:
5571	.a889		28		plp		                plp
5572	.a88a		60		rts		                rts

5574	.a88b						LA88B:
5575	.a88b		20 77 a1	jsr $a177	                jsr LA177
5576	.a88e		20 bb a9	jsr $a9bb	                jsr LA9BB
5577	.a891						escapeError:
5578	.a891		a9 7e		lda #$7e	                lda #$7E
5579	.a893		20 f4 ff	jsr $fff4	                jsr OSBYTE
5580	.a896		20 ed aa	jsr $aaed	                jsr doFollowingError
5581	>a899		11				                .byte $11
5582	>a89a		45 73 63 61 70 65		                .text "Escape"
5583	>a8a0		00				                .byte $00

5585							;-------------------------------------------------------------------------

5587	.a8a1						LA8A1:
5588	.a8a1		98		tya		                tya
5589	.a8a2		f0 0d		beq $a8b1	                beq LA8B1
5590	.a8a4		20 23 a9	jsr $a923	                jsr LA923
5591	>a8a7		0d				                .byte $0D
5592	>a8a8		4c 6f 61 64 69 6e 67		                .text "Loading"
5593	>a8af		0d				                .byte $0D
5594	>a8b0		00				                .byte $00
5595	.a8b1						LA8B1:
5596	.a8b1		64 ba		stz $ba		                stz $BA                      ; :
5597	.a8b3		a2 ff		ldx #$ff	                ldx #$FF
5598	.a8b5		a5 c1		lda $c1		                lda $C1
5599	.a8b7		d0 0b		bne $a8c4	                bne LA8C4
5600	.a8b9		20 5c a9	jsr $a95c	                jsr LA95C
5601	.a8bc		08		php		                php
5602	.a8bd		a2 ff		ldx #$ff	                ldx #$FF
5603	.a8bf		a0 11		ldy #$11	                ldy #<fileError
5604							                .cwarn (>fileError)!=(>dataError),"must be on same page"
5605	.a8c1		28		plp		                plp
5606	.a8c2		d0 16		bne $a8da	                bne LA8DA
5607	.a8c4						LA8C4:
5608	.a8c4		a0 04		ldy #$04	                ldy #<dataError
5609	.a8c6		a5 c1		lda $c1		                lda $C1
5610	.a8c8		d0 10		bne $a8da	                bne LA8DA
5611	.a8ca		ad c6 03	lda $03c6	                lda $03C6
5612	.a8cd		c5 b4		cmp $b4		                cmp $B4
5613	.a8cf		d0 07		bne $a8d8	                bne LA8D8
5614	.a8d1		ad c7 03	lda $03c7	                lda $03C7
5615	.a8d4		c5 b5		cmp $b5		                cmp $B5
5616	.a8d6		f0 0b		beq $a8e3	                beq LA8E3
5617	.a8d8						LA8D8:
5618	.a8d8		a0 1e		ldy #$1e	                ldy #<blockError
5619							                .cwarn (>blockError)!=(>dataError),"must be on same page"
5620	.a8da						LA8DA:
5621	.a8da		5a		phy		                phy
5622	.a8db		da		phx		                phx
5623	.a8dc		20 a8 a7	jsr $a7a8	                jsr LA7A8
5624	.a8df		fa		plx		                plx
5625	.a8e0		7a		ply		                ply
5626	.a8e1		80 10		bra $a8f3	                bra LA8F3

5628	.a8e3						LA8E3:
5629	.a8e3		da		phx		                phx
5630	.a8e4		20 9b a7	jsr $a79b	                jsr LA79B
5631	.a8e7		20 a0 a9	jsr $a9a0	                jsr LA9A0
5632	.a8ea		fa		plx		                plx
5633	.a8eb		a5 be		lda $be		                lda $BE
5634	.a8ed		05 bf		ora $bf		                ora $BF
5635	.a8ef		f0 79		beq $a96a	                beq LA96A
5636	.a8f1		a0 04		ldy #$04	                ldy #<dataError
5637	.a8f3						LA8F3:
5638	.a8f3		a9 ab		lda #$ab	                lda #>dataError
5639	.a8f5		c6 ba		dec $ba		                dec $BA
5640	.a8f7		48		pha		                pha
5641	.a8f8		24 eb		bit $eb		                bit $EB
5642	.a8fa		30 0d		bmi $a909	                bmi LA909
5643	.a8fc		8a		txa		                txa
5644							                .if version!=400
5645	.a8fd		2d 47 02	and $0247	                and cfsRFSFSSwitch
5646	.a900						LA900:
5647							                .endif
5648	.a900		d0 07		bne $a909	                bne LA909
5649	.a902		8a		txa		                txa
5650	.a903		29 11		and #$11	                and #$11
5651	.a905		25 bb		and $bb		                and $BB
5652	.a907		f0 0f		beq $a918	                beq LA918
5653	.a909						LA909:
5654	.a909		68		pla		                pla
5655	.a90a		85 b9		sta $b9		                sta $B9
5656	.a90c		84 b8		sty $b8		                sty $B8
5657	.a90e		20 8b a5	jsr $a58b	                jsr LA58B
5658	.a911		46 eb		lsr $eb		                lsr $EB
5659	.a913		20 b1 a9	jsr $a9b1	                jsr LA9B1
5660	.a916		80 3d		bra $a955	                bra LA955

5662	.a918						LA918:
5663	.a918		98		tya		                tya
5664	.a919		18		clc		                clc
5665	.a91a		69 03		adc #$03	                adc #$03
5666	.a91c		a8		tay		                tay
5667	.a91d		90 03		bcc $a922	                bcc LA922
5668	.a91f		68		pla		                pla
5669	.a920		1a		inc a		                inc a
5670	.a921		48		pha		                pha
5671	.a922						LA922:
5672	.a922		5a		phy		                phy
5673	.a923						LA923:
5674	.a923		20 1b ef	jsr $ef1b	                jsr mos.LEF1B
5675	.a926		a8		tay		                tay

5677							;-------------------------------------------------------------------------
5678							;
5679							; Print 0-terminated message using address from stack.
5680							;
5681							; entry:
5682							;
5683							; S=[StrL; StrH] - where Str = (address of string)-1
5684							; Y = 0 to print message; otherwise, don't print message
5685							;
5686	.a927						printFollowingMessage:                       ;
5687	.a927		68		pla		                pla
5688	.a928		85 b8		sta $b8		                sta printMessageAddress+0
5689	.a92a		68		pla		                pla
5690	.a92b		85 b9		sta $b9		                sta printMessageAddress+1
5691	.a92d		5a		phy		                phy                          ;save initial Y
5692	.a92e		98		tya		                tya                          ;Z=1 if Y=0
5693	.a92f		08		php		                php                          ;save Y=0 state
5694	.a930						fetchNextChar:
5695	.a930		e6 b8		inc $b8		                inc printMessageAddress+0
5696	.a932		d0 02		bne $a936	                bne +
5697	.a934		e6 b9		inc $b9		                inc printMessageAddress+1
5698	.a936						+
5699	.a936		b2 b8		lda ($b8)	                lda (printMessageAddress)   ;fetch next char to print
5700	.a938		f0 13		beq $a94d	                beq printingFinished        ;branch taken if last char
5701	.a93a		28		plp		                plp                         ;restore Y=0 state
5702	.a93b		08		php		                php                         ;save Y=0 state
5703	.a93c		f0 f2		beq $a930	                beq fetchNextChar ;branch taken if Y=0 - i.e., skip the
5704							                                  ;printing

5706							                ; printMessageAddress is in the $b0-$bf area, so it
5707							                ; needs saving in case there's a *SPOOL going on.
5708	.a93e		a4 b8		ldy $b8		                ldy printMessageAddress+0
5709	.a940		5a		phy		                phy
5710	.a941		a4 b9		ldy $b9		                ldy printMessageAddress+1
5711	.a943		20 e3 ff	jsr $ffe3	                jsr OSASCI
5712	.a946		84 b9		sty $b9		                sty printMessageAddress+1
5713	.a948		7a		ply		                ply
5714	.a949		84 b8		sty $b8		                sty printMessageAddress+0

5716	.a94b		80 e3		bra $a930	                bra fetchNextChar

5718	.a94d						printingFinished:
5719	.a94d		28		plp		                plp                          ;discard Y=0 state
5720	.a94e		e6 b8		inc $b8		                inc printMessageAddress+0
5721	.a950		d0 02		bne $a954	                bne +
5722	.a952		e6 b9		inc $b9		                inc printMessageAddress+1
5723	.a954						+
5724	.a954		7a		ply		                ply                          ;restore initial Y
5725	.a955						LA955:
5726	.a955		6c b8 00	jmp ($00b8)	                jmp (printMessageAddress)

5728	.a958						alwaysPrintFollowingMessage:
5729	.a958		a0 01		ldy #$01	                ldy #$01
5730	.a95a		80 cb		bra $a927	                bra printFollowingMessage

5732							;-------------------------------------------------------------------------

5734	.a95c						LA95C:
5735	.a95c		a2 ff		ldx #$ff	                ldx #$FF
5736	.a95e						LA95E:
5737	.a95e		e8		inx		                inx
5738	.a95f		bd d2 03	lda $03d2,x	                lda $03D2,x
5739	.a962		d0 07		bne $a96b	                bne LA96B
5740	.a964		8a		txa		                txa
5741	.a965		f0 03		beq $a96a	                beq LA96A
5742	.a967		bd b2 03	lda $03b2,x	                lda $03B2,x
5743	.a96a						LA96A:
5744	.a96a		60		rts		                rts

5746	.a96b						LA96B:
5747	.a96b		20 71 ea	jsr $ea71	                jsr mos.isLetter
5748	.a96e		5d b2 03	eor $03b2,x	                eor $03B2,x
5749	.a971		b0 02		bcs $a975	                bcs LA975
5750	.a973		29 df		and #$df	                and #$DF
5751	.a975						LA975:
5752	.a975		f0 e7		beq $a95e	                beq LA95E
5753	.a977						LA977:
5754	.a977		60		rts		                rts

5756	.a978						LA978:
5757	.a978		a5 ba		lda $ba		                lda $BA
5758	.a97a		f0 21		beq $a99d	                beq LA99D
5759	.a97c		8a		txa		                txa
5760	.a97d		f0 1e		beq $a99d	                beq LA99D
5761	.a97f		a9 22		lda #$22	                lda #$22
5762	.a981		24 bb		bit $bb		                bit $BB
5763	.a983		f0 18		beq $a99d	                beq LA99D
5764							                .if version!=400
5765	.a985		20 12 aa	jsr $aa12	                jsr resetACIA
5766							                .endif
5767	.a988		a8		tay		                tay
5768	.a989		20 27 a9	jsr $a927	                jsr printFollowingMessage
5769	>a98c		0d				                .byte $0D
5770	>a98d		07				                .byte $07
5771	>a98e		52 65 77 69 6e 64 20 74		                .text "Rewind tape"
	>a996		61 70 65
5772	>a999		0d				                .byte $0D
5773	>a99a		0d				                .byte $0D
5774	>a99b		00				                .byte $00
5775	.a99c		60		rts		                rts

5777	.a99d						LA99D:
5778	.a99d		20 5d a0	jsr $a05d	                jsr LA05D
5779	.a9a0						LA9A0:
5780	.a9a0		a5 c2		lda $c2		                lda $C2
5781	.a9a2		f0 d3		beq $a977	                beq LA977
5782	.a9a4		20 80 a8	jsr $a880	                jsr LA880
5783							                .if version!=400
5784	.a9a7		ad 47 02	lda $0247	                lda cfsRFSFSSwitch
5785	.a9aa		f0 f4		beq $a9a0	                beq LA9A0
5786							                .endif
5787							                .if version==400
5789							                .else
5790	.a9ac		20 5d a4	jsr $a45d	                jsr LA45D
5791							                .endif
5792	.a9af		80 ef		bra $a9a0	                bra LA9A0

5794	.a9b1						LA9B1:
5795	.a9b1		20 1b ef	jsr $ef1b	                jsr mos.LEF1B
5796	.a9b4		f0 05		beq $a9bb	                beq LA9BB
5797	.a9b6						LA9B6:
5798	.a9b6		a9 07		lda #$07	                lda #$07
5799	.a9b8		20 ee ff	jsr $ffee	                jsr OSWRCH
5800	.a9bb						LA9BB:
5801							                .if version<500
5802	.a9bb		ad 7a 02	lda $027a	                lda tubePresence
5803	.a9be		f0 05		beq $a9c5	                beq LA9C5
5804	.a9c0		a9 80		lda #$80	                lda #$80
5805	.a9c2		20 06 04	jsr $0406	                jsr tubeHost.entryPoint
5806							                .endif
5807	.a9c5						LA9C5:
5808							                .if version!=400
5809	.a9c5		a2 00		ldx #$00	                ldx #$00
5810	.a9c7		20 61 aa	jsr $aa61	                jsr LAA61
5811	.a9ca						LA9CA:
5812	.a9ca		08		php		                php
5813	.a9cb		78		sei		                sei
5814	.a9cc		ad 82 02	lda $0282	                lda serialULARegister
5815	.a9cf		8d 10 fe	sta $fe10	                sta SERPROC+0
5816	.a9d2		64 ea		stz $ea		                stz $EA
5817	.a9d4		80 01		bra $a9d7	                bra LA9D7

5819							;-------------------------------------------------------------------------

5821	.a9d6						resetACIAThenRewriteControlRegister:
5822	.a9d6		08		php		                php
5823	.a9d7						LA9D7:
5824	.a9d7		20 12 aa	jsr $aa12	                jsr resetACIA
5825	.a9da		ad 50 02	lda $0250	                lda aciaControlRegister
5826	.a9dd		4c 21 e9	jmp $e921	                jmp mos.writeACIAControlRegister

5828							;-------------------------------------------------------------------------

5830	.a9e0						LA9E0:
5831	.a9e0		28		plp		                plp
5832	.a9e1		24 ff		bit $ff		                bit $FF
5833	.a9e3		10 18		bpl $a9fd	                bpl LA9FD
5834							                .endif
5835	.a9e5		60		rts		                rts

5837	.a9e6						LA9E6:
5838	.a9e6		a5 e3		lda $e3		                lda $E3
5839	.a9e8		0a		asl a		                asl a
5840	.a9e9		0a		asl a		                asl a
5841	.a9ea		0a		asl a		                asl a
5842	.a9eb		0a		asl a		                asl a
5843	.a9ec		85 bb		sta $bb		                sta $BB
5844							                .if version==400
5846							                .else
5847	.a9ee		ad d1 03	lda $03d1	                lda $03D1
5848	.a9f1		80 08		bra $a9fb	                bra LA9FB
5849							                .endif

5851	.a9f3						LA9F3:
5852	.a9f3		a5 e3		lda $e3		                lda $E3
5853	.a9f5		29 f0		and #$f0	                and #$F0
5854	.a9f7		85 bb		sta $bb		                sta $BB
5855							                .if version!=400
5856	.a9f9		a9 06		lda #$06	                lda #$06
5857	.a9fb						LA9FB:
5858	.a9fb		85 c7		sta $c7		                sta $C7
5859	.a9fd						LA9FD:
5860	.a9fd		58		cli		                cli
5861	.a9fe						LA9FE:
5862	.a9fe		08		php		                php
5863	.a9ff		78		sei		                sei
5864	.aa00						LAA00:
5865	.aa00		2c 4f 02	bit $024f	                bit rs423Busy
5866	.aa03		10 db		bpl $a9e0	                bpl LA9E0
5867	.aa05		a5 ea		lda $ea		                lda $EA
5868	.aa07		30 d7		bmi $a9e0	                bmi LA9E0
5869	.aa09		a9 01		lda #$01	                lda #$01
5870	.aa0b		85 ea		sta $ea		                sta $EA
5871	.aa0d		20 12 aa	jsr $aa12	                jsr resetACIA
5872	.aa10		28		plp		                plp
5873							                .endif
5874	.aa11		60		rts		                rts

5876							;-------------------------------------------------------------------------

5878							                .if version!=400
5879	.aa12						resetACIA:
5880	.aa12		a9 03		lda #$03	                lda #ACIA.control.reset
5881	.aa14		80 1b		bra $aa31	                bra writeACIAControlRegister
5882							                .endif

5884							;-------------------------------------------------------------------------

5886	.aa16						LAA16:
5887							                .if version!=400
5888	.aa16		a9 30		lda #$30	                lda #$30
5889	.aa18		85 ca		sta $ca		                sta $CA
5890	.aa1a		80 13		bra $aa2f	                bra LAA2F
5891							                .endif
5892	.aa1c						LAA1C:
5893							                .if version!=400
5894	.aa1c		a9 05		lda #$05	                lda #$05
5895	.aa1e		8d 10 fe	sta $fe10	                sta SERPROC+0
5896	.aa21		a2 ff		ldx #$ff	                ldx #$FF
5897	.aa23						LAA23:
5898	.aa23		ca		dex		                dex
5899	.aa24		d0 fd		bne $aa23	                bne LAA23
5900							                .endif
5901	.aa26		64 ca		stz $ca		                stz $CA
5902							                .if version!=400
5903	.aa28		a9 d0		lda #$d0	                lda #$D0
5904	.aa2a						LAA2A:
5905	.aa2a		a0 85		ldy #$85	                ldy #$85
5906	.aa2c		8c 10 fe	sty $fe10	                sty SERPROC+0
5907	.aa2f						LAA2F:
5908	.aa2f		05 c6		ora $c6		                ora $C6
5909	.aa31						writeACIAControlRegister:
5910	.aa31		8d 08 fe	sta $fe08	                sta ACIA+0
5911							                .endif
5912	.aa34		60		rts		                rts

5914							;-------------------------------------------------------------------------

5916	.aa35						LAA35:
5917	.aa35		ae c6 03	ldx $03c6	                ldx $03C6
5918	.aa38		ac c7 03	ldy $03c7	                ldy $03C7
5919	.aa3b		e8		inx		                inx
5920	.aa3c		86 b4		stx $b4		                stx $B4
5921	.aa3e		d0 01		bne $aa41	                bne LAA41
5922	.aa40		c8		iny		                iny
5923	.aa41						LAA41:
5924	.aa41		84 b5		sty $b5		                sty $B5
5925	.aa43		60		rts		                rts

5927	.aa44						LAA44:
5928	.aa44		64 c0		stz $c0		                stz $C0
5929	.aa46						LAA46:
5930	.aa46		a0 00		ldy #$00	                ldy #$00
5931	.aa48		64 be		stz $be		                stz $BE
5932	.aa4a		64 bf		stz $bf		                stz $BF
5933	.aa4c		60		rts		                rts

5935	.aa4d						LAA4D:
5936	.aa4d		a0 ff		ldy #$ff	                ldy #$FF
5937	.aa4f						LAA4F:
5938	.aa4f		c8		iny		                iny
5939	.aa50		e8		inx		                inx
5940	.aa51		bd 00 03	lda $0300,x	                lda $0300,x
5941	.aa54		99 d2 03	sta $03d2,y	                sta $03D2,y
5942	.aa57		d0 f6		bne $aa4f	                bne LAA4F
5943	.aa59		60		rts		                rts

5945							                .if version!=400
5946	.aa5a						LAA5A:
5947	.aa5a		a0 00		ldy #$00	                ldy #$00
5948	.aa5c						LAA5C:
5949	.aa5c		58		cli		                cli
5950	.aa5d		a2 01		ldx #$01	                ldx #$01
5951	.aa5f		84 c3		sty $c3		                sty $C3
5952	.aa61						LAA61:
5953	.aa61		a9 89		lda #$89	                lda #$89
5954	.aa63		a4 c3		ldy $c3		                ldy $C3
5955	.aa65		4c f4 ff	jmp $fff4	                jmp OSBYTE
5956							                .endif

5958							; Check if TAPE/ROM channel is open
5959							; ---------------------------------
5960							; Y=handle to check, A=status mask to use
5961	.aa68						LAA68:
5962	.aa68		5a		phy		                phy
5963	.aa69		20 8d aa	jsr $aa8d	                jsr LAA8D
5964	.aa6c		7a		ply		                ply
5965							                .if version<500
5966	.aa6d		b0 5a		bcs $aac9	                bcs LAAC9                    ; Channel open, exit
5969							                .endif
5970	.aa6f		cc 57 02	cpy $0257	                cpy spoolFileHandle                    ; Not SPOOL handle
5971	.aa72		d0 05		bne $aa79	                bne LAA79
5972	.aa74		9c 57 02	stz $0257	                stz spoolFileHandle                    ; Clear the SPOOL handle
5973	.aa77		80 08		bra $aa81	                bra LAA81
5974	.aa79						LAA79:
5975	.aa79		cc 56 02	cpy $0256	                cpy execFileHandle                    ; Not EXEC handle
5976	.aa7c		d0 03		bne $aa81	                bne LAA81
5977	.aa7e		9c 56 02	stz $0256	                stz execFileHandle                    ; Clear the EXEC handle
5978	.aa81						LAA81:
5979	.aa81		20 ed aa	jsr $aaed	                jsr doFollowingError                    ; Generate error
5980	>aa84		de				                .byte $DE
5981	>aa85		43 68 61 6e 6e 65 6c		                .text "Channel"
5982	.aa8c		00		brk #		                brk

5984	.aa8d						LAA8D:
5985	.aa8d		48		pha		                pha                          ; Toggle channel with CFS/RFS switch
5986	.aa8e		98		tya		                tya
5987							                .if version==400
5989							                .else
5990	.aa8f		4d 47 02	eor $0247	                eor cfsRFSFSSwitch
5991							                .endif
5992	.aa92		a8		tay		                tay                          ; If CFS=unchanged, if RFS 1/2/3->3/0/1
5993	.aa93		68		pla		                pla
5994	.aa94		25 e2		and $e2		                and $E2                      ; Mask with open channels bitmask
5995	.aa96		4a		lsr a		                lsr a                        ; Move 'input open if tested' into Carry
5996	.aa97		88		dey		                dey                          ; Exit if testing CFS#1 or RFS#3
5997	.aa98		f0 05		beq $aa9f	                beq LAA9F
5998	.aa9a		4a		lsr a		                lsr a                        ; Move 'output open if tested' into Carry
5999	.aa9b		88		dey		                dey                          ; Exit if testing CFS#2
6000	.aa9c		f0 01		beq $aa9f	                beq LAA9F
6001	.aa9e		18		clc		                clc                          ; Otherwise, Carry=Not Open
6002	.aa9f						LAA9F:
6003	.aa9f		60		rts		                rts

6005							                .if version!=400
6006	.aaa0						LAAA0:
6007	.aaa0		a9 10		lda #$10	                lda #$10
6008	.aaa2		80 86		bra $aa2a	                bra LAA2A
6009							                .endif

6011							                .if version<500
6012	.aaa4						LAAA4:
6013	.aaa4		a9 01		lda #$01	                lda #$01
6014	.aaa6						LAAA6:
6015	.aaa6		20 bc aa	jsr $aabc	                jsr LAABC
6016	.aaa9		f0 1e		beq $aac9	                beq LAAC9
6017	.aaab		8a		txa		                txa
6018	.aaac		a2 b0		ldx #$b0	                ldx #$B0
6019	.aaae		a0 00		ldy #$00	                ldy #$00
6020	.aab0						LAAB0:
6021	.aab0		48		pha		                pha
6022	.aab1		a9 c0		lda #$c0	                lda #$C0
6023	.aab3						LAAB3:
6024	.aab3		20 06 04	jsr $0406	                jsr tubeHost.entryPoint
6025	.aab6		90 fb		bcc $aab3	                bcc LAAB3
6026	.aab8		68		pla		                pla
6027	.aab9		4c 06 04	jmp $0406	                jmp tubeHost.entryPoint

6029	.aabc						LAABC:
6030	.aabc		aa		tax		                tax
6031	.aabd		a5 b2		lda $b2		                lda $B2
6032	.aabf		25 b3		and $b3		                and $B3
6033	.aac1		1a		inc a		                inc a
6034	.aac2		f0 05		beq $aac9	                beq LAAC9
6035	.aac4		ad 7a 02	lda $027a	                lda tubePresence
6036	.aac7		29 80		and #$80	                and #$80
6037	.aac9						LAAC9:
6038	.aac9		60		rts		                rts
6039							                .endif

6041	.aaca						LAACA:
6042	.aaca		a0 05		ldy #$05	                ldy #$05
6043	.aacc						LAACC:
6044	.aacc		b1 cc		lda ($cc),y	                lda ($CC),y
6045	.aace		d0 07		bne $aad7	                bne LAAD7
6046	.aad0		c8		iny		                iny
6047	.aad1		c0 08		cpy #$08	                cpy #$08
6048	.aad3		90 f7		bcc $aacc	                bcc LAACC
6049	.aad5						LAAD5:
6050	.aad5		b1 cc		lda ($cc),y	                lda ($CC),y
6051	.aad7						LAAD7:
6052	.aad7		3a		dec a		                dec a
6053	.aad8		91 cc		sta ($cc),y	                sta ($CC),y
6054	.aada		88		dey		                dey
6055	.aadb		c0 05		cpy #$05	                cpy #$05
6056	.aadd		b0 f6		bcs $aad5	                bcs LAAD5
6057	.aadf		60		rts		                rts

6059	.aae0						LAAE0:
6060	.aae0		a0 08		ldy #$08	                ldy #$08
6061	.aae2		a9 00		lda #$00	                lda #$00
6062	.aae4						LAAE4:
6063	.aae4		11 cc		ora ($cc),y	                ora ($CC),y
6064	.aae6		88		dey		                dey
6065	.aae7		c0 05		cpy #$05	                cpy #$05
6066	.aae9		b0 f9		bcs $aae4	                bcs LAAE4
6067	.aaeb		aa		tax		                tax
6068	.aaec		60		rts		                rts

6070	.aaed						doFollowingError:
6071	.aaed		78		sei		                sei
6072	.aaee		68		pla		                pla
6073	.aaef		85 fa		sta $fa		                sta SEIWKA+0
6074	.aaf1		68		pla		                pla
6075	.aaf2		85 fb		sta $fb		                sta SEIWKA+1
6076	.aaf4		9c 00 01	stz $0100	                stz $0100
6077	.aaf7		a0 00		ldy #$00	                ldy #$00
6078	.aaf9						-
6079	.aaf9		c8		iny		                iny
6080	.aafa		b1 fa		lda ($fa),y	                lda (SEIWKA),y
6081	.aafc		99 00 01	sta $0100,y	                sta $0100,y
6082	.aaff		d0 f8		bne $aaf9	                bne -
6083	.ab01		4c 00 01	jmp $0100	                jmp $0100


6086							                .if version!=350
6087							                .include "cfs_errors.s65"

:11	;******  Processing file: src/cfs_errors.s65

1	.ab04						dataError:
2	.ab04		20 ed aa	jsr $aaed	                jsr doFollowingError
3	>ab07		d8 0d 44 61 74 61 3f 00		                .text $d8,13,"Data?",0
4	.ab0f		80 19		bra $ab2a	                bra LAB2A

6	.ab11						fileError:
7	.ab11		20 ed aa	jsr $aaed	                jsr doFollowingError
8	>ab14		db 0d 46 69 6c 65 3f 00		                .text $db,13,"File?",0
9	.ab1c		80 0c		bra $ab2a	                bra LAB2A

11	.ab1e						blockError:
12	.ab1e		20 ed aa	jsr $aaed	                jsr doFollowingError
13	>ab21		da 0d 42 6c 6f 63 6b 3f		                .text $da,13,"Block?",0
	>ab29		00
14	.ab2a						LAB2A:
15	.ab2a		4c 78 a9	jmp $a978	                jmp LA978

:6	;******  Return to file: src/terminal.s65

6088							                .endif

6090							                .if version<500
6091							;-------------------------------------------------------------------------
6092							;
6093							; Tube host code
6094							;
6095							; See http://mdfs.net/Software/Tube/M128/Host320.lst
6096							;
6097							; I mostly just copied JGH's comments here.

6099	.ab2d						tubeHost: .block          ;tube code

6101	.ab2d						brkHandler: .block
6102							                .logical tubeBrkHandlerAddr
6103	.ab2d	0016	a9 ff		lda #$ff	                lda #$FF
6104	.ab2f	0018	20 6c 06	jsr $066c	                jsr sendR4       ;send $ff via R4 to interrupt copro
6105	.ab32	001b	ad e3 fe	lda $fee3	                lda tube.data2   ;get ACK byte from copro
6106	.ab35	001e	a9 00		lda #$00	                lda #$00
6107	.ab37	0020	20 61 06	jsr $0661	                jsr sendR2A       ;send $00 via R2 to specify ERROR
6108	.ab3a	0023	a8		tay		                tay               ;Y=0
6109	.ab3b	0024	b1 fd		lda ($fd),y	                lda ($FD),y       ;get error number
6110	.ab3d	0026	20 61 06	jsr $0661	                jsr sendR2A       ;send error number via R2
6111	.ab40	0029					-
6112	.ab40	0029	c8		iny		                iny             ;next char
6113	.ab41	002a	b1 fd		lda ($fd),y	                lda ($FD),y     ;fetch error string char
6114	.ab43	002c	20 61 06	jsr $0661	                jsr sendR2A     ;send via R2
6115	.ab46	002f	aa		tax		                tax             ;set N/Z as per error string char
6116	.ab47	0030	d0 f7		bne $0029	                bne -           ;repeat until terminating $00 sent
6117	.ab49	0032					idleStartup:
6118	.ab49	0032	a2 ff		ldx #$ff	                ldx #$FF
6119	.ab4b	0034	9a		txs		                txs             ;clear stack
6120	.ab4c	0035	58		cli		                cli
6121	.ab4d	0036					idleLoop:
6122	.ab4d	0036	2c e0 fe	bit $fee0	                bit tube.status1 ;is there a char in R1?
6123	.ab50	0039	10 06		bpl $0041	                bpl LAB58        ;branch taken if no char in R1
6124	.ab52	003b					handleOSWRCH:
6125	.ab52	003b	ad e1 fe	lda $fee1	                lda tube.data1  ;get char from R1
6126	.ab55	003e	20 ee ff	jsr $ffee	                jsr OSWRCH      ;pass to OSWRCH
6127	.ab58	0041					LAB58:
6128	.ab58	0041	2c e2 fe	bit $fee2	                bit tube.status2 ;is there a command in R2?
6129	.ab5b	0044	10 f0		bpl $0036	                bpl idleLoop     ;branch taken if no command in R2
6130	.ab5d	0046	2c e0 fe	bit $fee0	                bit tube.status1 ;is there a char in R1?
6131	.ab60	0049	30 f0		bmi $003b	                bmi handleOSWRCH ;branch taken if char in R1
6132	.ab62	004b	ae e3 fe	ldx $fee3	                ldx tube.data2   ;get command from R2
6133	.ab65	004e	86 51		stx $51		                stx callCommandRoutine+1 ;use as index into command
6134							                                         ;table
6135	.ab67	0050					callCommandRoutine:
6136							                ; not sure why this can't be jmp
6137							                ; (tubeHost.commandRoutines,x)? - and then the table
6138							                ; wouldn't have to be page-aligned.
6139	.ab67	0050	6c 00 05	jmp ($0500)	                jmp (tubeHost.commandRoutines)

6141							                ; ???
6142	>ab6a	0053	00 80 00 00			                .dword $8000
6143							                .here
6144							                .endblock

6146							; Slightly ugly aliases for inner symbol :(
6147	=$32						idleStartup=brkHandler.idleStartup
6148	=$36						idleLoop=brkHandler.idleLoop

6150	.ab6e						codePage0:
6151							                .logical tubeHostAddr
6152	.ab6e	0400					copyLanguage:
6153	.ab6e	0400	4c c2 04	jmp $04c2	                jmp LAC30

6155	.ab71	0403					copyEscapeStatus:
6156	.ab71	0403	4c 75 06	jmp $0675	                jmp LADDA

6158							; Tube transfer/claim/release
6159	.ab74	0406					entryPoint:
6160	.ab74	0406	c9 80		cmp #$80	                cmp #$80
6161	.ab76	0408	90 29		bcc $0433	                bcc dataTransfer
6162	.ab78	040a	c9 c0		cmp #$c0	                cmp #$C0
6163	.ab7a	040c	b0 18		bcs $0426	                bcs claim
6164	.ab7c	040e	09 40		ora #$40	                ora #$40
6165	.ab7e	0410	c5 15		cmp $15		                cmp $15
6166	.ab80	0412	d0 1e		bne $0432	                bne done
6167	.ab82	0414					release:
6168	.ab82	0414	08		php		                php
6169	.ab83	0415	78		sei		                sei
6170	.ab84	0416	a9 05		lda #$05	                lda #$05
6171	.ab86	0418	20 6c 06	jsr $066c	                jsr sendR4
6172	.ab89	041b	20 6a 06	jsr $066a	                jsr sendR4TubeClaimantID
6173	.ab8c	041e	28		plp		                plp
6174	.ab8d	041f					resetTubeClaim:
6175	.ab8d	041f	a9 80		lda #$80	                lda #$80
6176	.ab8f	0421	85 15		sta $15		                sta tubeClaimantID
6177	.ab91	0423	85 14		sta $14		                sta tubeNotClaimed
6178	.ab93	0425	60		rts		                rts

6180	.ab94	0426					claim:
6181	.ab94	0426	06 14		asl $14		                asl tubeNotClaimed    ;test if Tube free
6182	.ab96	0428	b0 06		bcs $0430	                bcs claim2         ;taken if Tube free - with C=1 and
6183							                                   ;tube marked as claimed
6184	.ab98	042a	c5 15		cmp $15		                cmp tubeClaimantID
6185	.ab9a	042c	f0 04		beq $0432	                beq done       ;taken with C=1 if already claimed
6186	.ab9c	042e	18		clc		                clc            ;signal claim failure
6187	.ab9d	042f	60		rts		                rts

6189	.ab9e	0430					claim2:
6190	.ab9e	0430	85 15		sta $15		                sta tubeClaimantID ; store claimant ID
6191	.aba0	0432					done:
6192	.aba0	0432	60		rts		                rts

6194	.aba1	0433					dataTransfer:
6195	.aba1	0433	08		php		                php
6196	.aba2	0434	78		sei		                sei
6197	.aba3	0435	84 13		sty $13		                sty tubeTransferAddr+1
6198	.aba5	0437	86 12		stx $12		                stx tubeTransferAddr+0
6199	.aba7	0439	20 6c 06	jsr $066c	                jsr sendR4      ;send reason code to interrupt copro
6200	.abaa	043c	aa		tax		                tax             ;save reason code
6201	.abab	043d	a0 03		ldy #$03	                ldy #$03        ;will send 4 bytes
6202	.abad	043f	20 6a 06	jsr $066a	                jsr sendR4TubeClaimantID ;send Tube claimant ID
6203	.abb0	0442					-
6204	.abb0	0442	b1 12		lda ($12),y	                lda (tubeTransferAddr),y
6205	.abb2	0444	20 6c 06	jsr $066c	                jsr sendR4
6206	.abb5	0447	88		dey		                dey
6207	.abb6	0448	10 f8		bpl $0442	                bpl -

6209							                ; disable R3 FIFO, disable R3 NMI
6210	.abb8	044a	a0 18		ldy #$18	                ldy #tube.status1.V|tube.status1.M
6211	.abba	044c	8c e0 fe	sty $fee0	                sty tube.status1

6213							                ; disable/enable other per-transfer type flags as
6214							                ; appropriate.
6215	.abbd	044f	bd 18 05	lda $0518,x	                lda dataTransferFlags,x
6216	.abc0	0452	8d e0 fe	sta $fee0	                sta tube.status1 ;STPVMJIQ

6218	.abc3	0455	4a		lsr a		                lsr a           ;0STPVMJI Q
6219	.abc4	0456	4a		lsr a		                lsr a           ;00STPVMJ I
6220	.abc5	0457	90 06		bcc $045f	                bcc +           ;branch taken if CoPro->I/O transfer

6222							                ; Read R3 twice to delay and empty FIFO
6223	.abc7	0459	2c e5 fe	bit $fee5	                bit tube.data3
6224	.abca	045c	2c e5 fe	bit $fee5	                bit tube.data3
6225	.abcd	045f					+
6226	.abcd	045f	20 6c 06	jsr $066c	                jsr sendR4      ;send value to synchronize
6227	.abd0	0462					-
6228	.abd0	0462	2c e6 fe	bit $fee6	                bit tube.status4
6229	.abd3	0465	50 fb		bvc $0462	                bvc -
6230	.abd5	0467	b0 0d		bcs $0476	                bcs LABE4       ;branch taken if I/O->CoPro transfer
6231	.abd7	0469	e0 04		cpx #$04	                cpx #$04        ;$04 = execute in CoPro
6232	.abd9	046b	d0 11		bne $047e	                bne LABEC       ;taken if not execute in CoPro
6233	.abdb	046d					LABDB:
6234	.abdb	046d	20 14 04	jsr $0414	                jsr release
6235	.abde	0470	20 61 06	jsr $0661	                jsr sendR2A
6236	.abe1	0473	4c 32 00	jmp $0032	                jmp idleStartup

6238	.abe4	0476					LABE4:
6239	.abe4	0476	4a		lsr a		                lsr a            ;000STPVM J
6240	.abe5	0477	90 05		bcc $047e	                bcc LABEC        ;branch taken if J=0
6241	.abe7	0479	a0 88		ldy #$88	                ldy #tube.status1.S|tube.status1.M
6242	.abe9	047b	8c e0 fe	sty $fee0	                sty tube.status1
6243	.abec	047e					LABEC:
6244	.abec	047e	28		plp		                plp
6245	.abed	047f	60		rts		                rts

6247	.abee	0480					LABEE:
6248	.abee	0480	ae 8d 02	ldx $028d	                ldx lastBREAKType            ;get last BREAK type
6249	.abf1	0483	f0 e8		beq $046d	                beq LABDB   ;if soft break, release Tube, send $80 via
6250							                            ;R2, and enter idle loop.

6252							; The current language is not copied across the Tube on soft Break,
6253							; only on Power-On Break and Hard Break, or when entered explicitly
6254							; with OSBYTE 142.

6256	.abf3	0485					enterNewLanguage: .proc
6257	.abf3	0485	a9 ff		lda #$ff	                lda #$FF
6258	.abf5	0487	20 06 04	jsr $0406	                jsr tubeHost.entryPoint ;claim with ID=$3f
6259	.abf8	048a	90 f9		bcc $0485	                bcc enterNewLanguage    ;repeat until claimed
6260	.abfa	048c	20 c9 04	jsr $04c9	                jsr getLanguageParasiteAddr ;sort out addresses

6262	.abfd	048f					transferPage:
6263							                .if version==350
6265							                .endif
6266	.abfd	048f	08		php		                php
6267	.abfe	0490	78		sei		                sei

6269							                ; initiate I/O->CoPro 256 bytes, then transfer the
6270							                ; next 256 bytes of the language ROM.
6271	.abff	0491	a9 07		lda #$07	                lda #$07
6272	.ac01	0493	20 bb 04	jsr $04bb	                jsr doTube

6274	.ac04	0496	a0 00		ldy #$00	                ldy #$00
6275							                .if version==350
6281							                .else
6282	.ac06	0498	64 00		stz $00		                stz tubeLanguageHostAddr+0
6283	.ac08	049a					transferPageLoop:
6284	.ac08	049a	b1 00		lda ($00),y	                lda (tubeLanguageHostAddr),y
6285	.ac0a	049c	8d e5 fe	sta $fee5	                sta tube.data3
6286	.ac0d	049f	ea		nop		                nop
6287	.ac0e	04a0	ea		nop		                nop
6288	.ac0f	04a1	ea		nop		                nop
6289							                .endif
6290	.ac10	04a2	c8		iny		                iny
6291	.ac11	04a3	d0 f5		bne $049a	                bne transferPageLoop
6292	.ac13	04a5	28		plp		                plp

6294							                ; advance to next dest page.
6295	.ac14	04a6	e6 54		inc $54		                inc tubeLanguageParasiteAddr+1
6296	.ac16	04a8	d0 06		bne $04b0	                bne +
6297	.ac18	04aa	e6 55		inc $55		                inc tubeLanguageParasiteAddr+2
6298	.ac1a	04ac	d0 02		bne $04b0	                bne +
6299	.ac1c	04ae	e6 56		inc $56		                inc tubeLanguageParasiteAddr+3
6300	.ac1e	04b0					+

6302							                .if version!=350
6303	.ac1e	04b0	e6 01		inc $01		                inc tubeLanguageHostAddr+1 ;next source page
6304							                .endif
6305	.ac20	04b2	24 01		bit $01		                bit tubeLanguageHostAddr+1
6306	.ac22	04b4	50 d9		bvc $048f	                bvc transferPage ;branch taken if source page $c0 not
6307							                                 ;reached yet

6309							                ; copy done - execute language in parasite
6310							                .if version==350
6312							                .else
6313	.ac24	04b6	20 c9 04	jsr $04c9	                jsr getLanguageParasiteAddr
6314							                .endif
6315	.ac27	04b9	a9 04		lda #$04	                lda #$04        ;execute in copro

6317							                ; call Tube entry point with whatever reason code,
6318							                ; supplying language parasite address as the parasite
6319							                ; address.
6320	.ac29	04bb					doTube:
6321	.ac29	04bb	a0 00		ldy #$00	                ldy #>tubeLanguageParasiteAddr
6322	.ac2b	04bd	a2 53		ldx #$53	                ldx #<tubeLanguageParasiteAddr
6323	.ac2d	04bf	4c 06 04	jmp $0406	                jmp tubeHost.entryPoint
6324							                .pend

6326	.ac30	04c2					LAC30:
6327	.ac30	04c2	58		cli		                cli
6328	.ac31	04c3	b0 c0		bcs $0485	                bcs enterNewLanguage
6329	.ac33	04c5	d0 b9		bne $0480	                bne LABEE
6330	.ac35	04c7	80 61		bra $052a	                bra LAC8F

6332	.ac37	04c9					getLanguageParasiteAddr: .proc
6333	.ac37	04c9	a9 80		lda #$80	                lda #$80
6334	.ac39	04cb	85 54		sta $54		                sta tubeLanguageParasiteAddr+1 ;$xxxx80xx
6335	.ac3b	04cd	85 01		sta $01		                sta tubeLanguageHostAddr+1     ;$80xx
6336	.ac3d	04cf	a9 20		lda #$20	                lda #$20
6337	.ac3f	04d1	2d 06 80	and $8006	                and $8006  ;test parasite address flag
6338	.ac42	04d4	a8		tay		                tay        ;Y=0 if $8000, Y=$20 if parasite address
6339							                .if version==350
6341							                .else
6342	.ac43	04d5	84 53		sty $53		                sty tubeLanguageParasiteAddr+0
6343							                .endif
6344	.ac45	04d7	f0 19		beq $04f2	                beq LAC60       ;branch taken if good to go with A=0
6345							                                ;and Y=0

6347	.ac47	04d9	ae 07 80	ldx $8007	                ldx $8007       ;get copyright offset
6348							                ; skip copyright message
6349	.ac4a	04dc					-
6350	.ac4a	04dc	e8		inx		                inx
6351	.ac4b	04dd	bd 00 80	lda $8000,x	                lda $8000,x
6352	.ac4e	04e0	d0 fa		bne $04dc	                bne -

6354	.ac50	04e2	bd 01 80	lda $8001,x	                lda $8000+1,x
6355	.ac53	04e5	85 53		sta $53		                sta tubeLanguageParasiteAddr+0
6356	.ac55	04e7	bd 02 80	lda $8002,x	                lda $8000+2,x
6357	.ac58	04ea	85 54		sta $54		                sta tubeLanguageParasiteAddr+1
6358	.ac5a	04ec	bc 03 80	ldy $8003,x	                ldy $8000+3,x
6359	.ac5d	04ef	bd 04 80	lda $8004,x	                lda $8000+4,x
6360	.ac60	04f2					LAC60:
6361							                .if version==350
6363							                .else
6364	.ac60	04f2	85 56		sta $56		                sta tubeLanguageParasiteAddr+3
6365	.ac62	04f4	84 55		sty $55		                sty tubeLanguageParasiteAddr+2
6366	.ac64	04f6	60		rts		                rts

6368							                .endif
6369							                .pend
6370							                .here

6372	.ac65						codePages12:
6373							                .logical tubeHostAddr+256

6375							; names of the indexes here come from app note 004
6376	.ac65	0500					commandRoutines:
6377							                .cerror (*&$ff)!=0,"commandRoutines must be paged aligned"
6378	>ac65	0500	35 05				                .word doRDCH    ;RDCHNO = $00
6379	>ac67	0502	88 05				                .word doCLI     ;CLINO = $02
6380	>ac69	0504	da 05				                .word doSBYT    ;SBYTNO = $04
6381	>ac6b	0506	eb 05				                .word doBYTE    ;BYTENO = $06
6382	>ac6d	0508	07 06				                .word doWORD    ;WORDNO = $08
6383	>ac6f	050a	36 06				                .word doRDLN    ;RDLNNO = $0a
6384	>ac71	050c	59 05				                .word doARGS     ;ARGSNO = $0c
6385	>ac73	050e	2c 05				                .word doBGET     ;BGETNO = $0e
6386	>ac75	0510	20 05				                .word doBPUT     ;BPUTNO = $10
6387	>ac77	0512	3f 05				                .word doFIND     ;FINDNO = $12
6388	>ac79	0514	b2 05				                .word doFILE    ;FILENO = $14
6389	>ac7b	0516	9a 05				                .word doGBPB     ;GBPBNO = $16

6391							                ; Tube data transfer flags
6392	.ac7d	0518					dataTransferFlags:
6393							                ; 0 - CoPro->I/O bytes
6394							                ;
6395							                ; Enable: PIRQ from R3, PIRQ from R1
6396	>ac7d	0518	86				                .byte tube.status1.S|tube.status1.J|tube.status1.I

6398							                ; 1 - I/O->CoPro bytes
6399							                ;
6400							                ; Enable: PNMI from R3
6401	>ac7e	0519	88				                .byte tube.status1.S|tube.status1.M

6403							                ; 2 - CoPro->I/O words
6404							                ;
6405							                ; Enable: 2-byte R3, PIRQ from R2, PIRQ from R1
6406	>ac7f	051a	96				                .byte tube.status1.S|tube.status1.V|tube.status1.J|tube.status1.I

6408							                ; 3 - I/O->CoPro words
6409							                ;
6410							                ; Enable: 2-byte R3, PNMI from R3
6411	>ac80	051b	98				                .byte tube.status1.S|tube.status1.V|tube.status1.M

6413							                ; 4 - Execute in CoPro
6414							                ;
6415							                ; Disable: 2-byte R3, PNMI from R3
6416	>ac81	051c	18				                .byte tube.status1.V|tube.status1.M

6418							                ; 5 - Reserved
6419							                ;
6420							                ; Disable: 2-byte R3, PNMI from R3
6421	>ac82	051d	18				                .byte tube.status1.V|tube.status1.M

6423							                ; 6 - CoPro->I/O 256 bytes
6424							                ;
6425							                ; Enable: PIRQ from R1
6426	>ac83	051e	82				                .byte tube.status1.S|tube.status1.I

6428							                ; 7 - I/O->CoPro 256 bytes
6429							                ;
6430							                ; Disable: 2-byte R3, PNMI from R3
6431	>ac84	051f	18				                .byte tube.status1.V|tube.status1.M

6433	.ac85	0520					doBPUT:
6434	.ac85	0520	20 a1 06	jsr $06a1	                jsr recvR2      ;Receive file handle
6435	.ac88	0523	a8		tay		                tay             ;Y = file handle
6436	.ac89	0524	20 a1 06	jsr $06a1	                jsr recvR2      ;Receive byte
6437	.ac8c	0527	20 d4 ff	jsr $ffd4	                jsr OSBPUT      ;Do OSBPUT
6438	.ac8f	052a					LAC8F:
6439	.ac8f	052a	80 62		bra $058e	                bra sendR27FThenGoIdle

6441	.ac91	052c					doBGET:
6442	.ac91	052c	20 a1 06	jsr $06a1	                jsr recvR2      ;Receive file handle
6443	.ac94	052f	a8		tay		                tay             ;Y = file handle
6444	.ac95	0530	20 d7 ff	jsr $ffd7	                jsr OSBGET      ;Do OSBGET
6445	.ac98	0533					LAC98:
6446	.ac98	0533	80 03		bra $0538	                bra sendR2CAThenGoIdle

6448	.ac9a	0535					doRDCH:
6449	.ac9a	0535	20 e0 ff	jsr $ffe0	                jsr OSRDCH      ;Do OSRDCH
6450	.ac9d	0538					sendR2CAThenGoIdle:
6451	.ac9d	0538	6a		ror a		                ror a           ;set A bit 7 as per carry
6452	.ac9e	0539	20 61 06	jsr $0661	                jsr sendR2A     ;send via R2
6453	.aca1	053c	2a		rol a		                rol a           ;restore A
6454	.aca2	053d	80 51		bra $0590	                bra sendR2AThenGoIdle

6456	.aca4	053f					doFIND: .proc
6457	.aca4	053f	20 a1 06	jsr $06a1	                jsr recvR2            ;Receive reason code
6458	.aca7	0542	f0 0a		beq $054e	                beq close             ;taken if A=$00 - CLOSE#
6459	.aca9	0544	48		pha		                pha                   ;save reason code
6460	.acaa	0545	20 74 05	jsr $0574	                jsr recvR2String      ;receive file name
6461	.acad	0548	68		pla		                pla                   ;restore reason code
6462	.acae	0549	20 ce ff	jsr $ffce	                jsr OSFIND            ;call OSFIND
6463	.acb1	054c	80 42		bra $0590	                bra sendR2AThenGoIdle

6465	.acb3	054e					close:
6466	.acb3	054e	20 a1 06	jsr $06a1	                jsr recvR2      ;Receive file handle
6467	.acb6	0551	a8		tay		                tay             ;Y = file handle
6468	.acb7	0552	a9 00		lda #$00	                lda #$00        ;A = $00 - CLOSE#
6469	.acb9	0554	20 ce ff	jsr $ffce	                jsr OSFIND      ;call OSFIND
6470	.acbc	0557	80 35		bra $058e	                bra sendR27FThenGoIdle
6471							                .pend

6473							;-------------------------------------------------------------------------
6474							;
6475							; Handle a Tube OSARGS request.
6476							;
6477							; [Tube p24]
6478							;
6479	.acbe	0559					doARGS:
6480	.acbe	0559	20 a1 06	jsr $06a1	                jsr recvR2                   ;receive file handle
6481	.acc1	055c	a8		tay		                tay                          ;Y = file handle
6482	.acc2	055d	a2 04		ldx #$04	                ldx #$04
6483	.acc4	055f	20 93 06	jsr $0693	                jsr recvR2N ;receive 4 bytes OSARGS data, + operation code
6484	.acc7	0562	20 da ff	jsr $ffda	                jsr OSARGS  ;call OSARGS
6485	.acca	0565	20 61 06	jsr $0661	                jsr sendR2A ;send OSARGS result

6487							                ; send 4 bytes OSARGS data
6488	.accd	0568	a2 03		ldx #$03	                ldx #$03
6489	.accf	056a					-
6490							                .if version==350
6492							                .else
6493	.accf	056a	b5 00		lda $00,x	                lda $00,x
6494							                .endif
6495	.acd1	056c	20 61 06	jsr $0661	                jsr sendR2A
6496	.acd4	056f	ca		dex		                dex
6497	.acd5	0570	10 f8		bpl $056a	                bpl -

6499	.acd7	0572	80 24		bra $0598	                bra goIdle_0

6501							;-------------------------------------------------------------------------
6502							;
6503							; Receive a CR-terminated string over the Tube via R2.
6504							;
6505							; exit:
6506							; YX = pointer to received string (here, always $0700)
6507							;
6508	.acd9	0574					recvR2String: .proc
6509	.acd9	0574	a2 00		ldx #$00	                ldx #$00
6510	.acdb	0576	a0 00		ldy #$00	                ldy #$00        ;index
6511	.acdd	0578					-
6512	.acdd	0578	20 a1 06	jsr $06a1	                jsr recvR2      ;get next string char
6513	.ace0	057b	99 00 07	sta $0700,y	                sta tubeStringBuffer,y     ;store in string buffer
6514	.ace3	057e	c8		iny		                iny
6515	.ace4	057f	f0 04		beq $0585	                beq +           ;taken if too many bytes received
6516	.ace6	0581	c9 0d		cmp #$0d	                cmp #$0D
6517	.ace8	0583	d0 f3		bne $0578	                bne -           ;taken if end of string data not reached
6518	.acea	0585					+
6519	.acea	0585	a0 07		ldy #$07	                ldy #>tubeStringBuffer
6520							                .cerror (<tubeStringBuffer)!=0,"tubeStringBuffer must be page-aligned"
6521	.acec	0587	60		rts		                rts
6522							                .pend

6524							;-------------------------------------------------------------------------
6525							;
6526							; Handle a Tube OSCLI request.
6527							;
6528							; [Tube p22]
6529							;
6530	.aced	0588					doCLI:
6531	.aced	0588	20 74 05	jsr $0574	                jsr recvR2String
6532	.acf0	058b	20 f7 ff	jsr $fff7	                jsr OSCLI
6533	.acf3	058e					sendR27FThenGoIdle:
6534	.acf3	058e	a9 7f		lda #$7f	                lda #$7F
6535	.acf5	0590					sendR2AThenGoIdle:
6536	.acf5	0590					-
6537	.acf5	0590	2c e2 fe	bit $fee2	                bit tube.status2
6538	.acf8	0593	50 fb		bvc $0590	                bvc -
6539	.acfa	0595	8d e3 fe	sta $fee3	                sta tube.data2
6540	.acfd	0598					goIdle_0:
6541	.acfd	0598	80 4e		bra $05e8	                bra goIdle_1

6543							;-------------------------------------------------------------------------
6544							;
6545							; Handle a Tube OSGBPB request.
6546							;
6547							; [Tube p25]
6548							;
6549	.acff	059a					doGBPB:
6550	.acff	059a	a2 0d		ldx #$0d	                ldx #size(OSGBPBParameterBlock)
6551							                .cerror tubeOSGBPBParameterBlock!=0,"Tube OSGBPB parameter block must be at $0000"
6552	.ad01	059c	20 93 06	jsr $0693	                jsr recvR2N     ;receive parameter block + reason code
6553	.ad04	059f	a0 00		ldy #$00	                ldy #>tubeOSGBPBParameterBlock
6554	.ad06	05a1	20 d1 ff	jsr $ffd1	                jsr OSGBPB      ;call OSGBPB
6555	.ad09	05a4	48		pha		                pha             ;save OSGBPB A result

6557							                ; Send updated OSGBPB parameter block.
6558	.ad0a	05a5	a2 0c		ldx #$0c	                ldx #size(OSGBPBParameterBlock)-1
6559	.ad0c	05a7					-
6560							                .if version==350
6562							                .else
6563	.ad0c	05a7	b5 00		lda $00,x	                lda tubeOSGBPBParameterBlock,x
6564							                .endif
6565	.ad0e	05a9	20 61 06	jsr $0661	                jsr sendR2A
6566	.ad11	05ac	ca		dex		                dex
6567	.ad12	05ad	10 f8		bpl $05a7	                bpl -
6568	.ad14	05af	68		pla		                pla                          ;restore OSGBPB A result
6569	.ad15	05b0	80 86		bra $0538	                bra sendR2CAThenGoIdle       ;send OSGBPB full result

6571							;-------------------------------------------------------------------------
6572							;
6573							; Handle a Tube OSFILE request.
6574							;
6575							; [Tube p24]
6576							;
6577	.ad17	05b2					doFILE: .proc
6578							                ; receive non-name part of OSFILE parameter block
6579	.ad17	05b2	a2 10		ldx #$10	                ldx #size(OSFILEParameterBlock)-2
6580	.ad19	05b4					-
6581	.ad19	05b4	20 a1 06	jsr $06a1	                jsr recvR2
6582							                .if version==350
6584							                .else
6585	.ad1c	05b7	95 01		sta $01,x	                sta tubeOSFILEParameterBlock.addresses-1,x
6586							                .endif
6587	.ad1e	05b9	ca		dex		                dex
6588	.ad1f	05ba	d0 f8		bne $05b4	                bne -
6589	.ad21	05bc	20 74 05	jsr $0574	                jsr recvR2String
6590							                .if version==350
6593							                .else
6594	.ad24	05bf	86 00		stx $00		                stx tubeOSFILEParameterBlock+0
6595	.ad26	05c1	84 01		sty $01		                sty tubeOSFILEParameterBlock+1
6596							                .endif
6597	.ad28	05c3	a0 00		ldy #$00	                ldy #>tubeOSFILEParameterBlock
6598							                .cerror (<tubeOSFILEParameterBlock)!=0,"Tube OSFILE parameter block must be at $0000"
6599	.ad2a	05c5	20 a1 06	jsr $06a1	                jsr recvR2                   ;receive OSFILE reason code
6600	.ad2d	05c8	20 dd ff	jsr $ffdd	                jsr OSFILE                   ;call OSFILE
6601	.ad30	05cb	20 61 06	jsr $0661	                jsr sendR2A                  ;send OSFILE result

6603							                ; send non-name part of updated OSFILE parameter block
6604	.ad33	05ce	a2 10		ldx #$10	                ldx #size(OSFILEParameterBlock)-2
6605	.ad35	05d0					-
6606							                .if version==350
6608							                .else
6609	.ad35	05d0	b5 01		lda $01,x	                lda tubeOSFILEParameterBlock.addresses-1,x
6610							                .endif
6611	.ad37	05d2	20 61 06	jsr $0661	                jsr sendR2A
6612	.ad3a	05d5	ca		dex		                dex
6613	.ad3b	05d6	d0 f8		bne $05d0	                bne -
6614	.ad3d	05d8	80 0e		bra $05e8	                bra goIdle_1
6615							                .pend

6617							;-------------------------------------------------------------------------
6618							;
6619							; Handle a Tube small (A<$80) OSBYTE.
6620							;
6621							; [Tube p22]
6622							;
6623	.ad3f	05da					doSBYT:
6624	.ad3f	05da	20 9d 06	jsr $069d	                jsr recvR2XA    ;receive X and A arguments
6625	.ad42	05dd	20 f4 ff	jsr $fff4	                jsr OSBYTE
6626	.ad45	05e0					sendR2X:
6627	.ad45	05e0	2c e2 fe	bit $fee2	                bit tube.status2
6628	.ad48	05e3	50 fb		bvc $05e0	                bvc sendR2X
6629	.ad4a	05e5	8e e3 fe	stx $fee3	                stx tube.data2
6630	.ad4d	05e8					goIdle_1:
6631	.ad4d	05e8	4c 36 00	jmp $0036	                jmp idleLoop

6633							;-------------------------------------------------------------------------
6634							;
6635							; Handle a Tube non-small OSBYTE.
6636							;
6637							; [Tube p22]
6638	.ad50	05eb					doBYTE:
6639	.ad50	05eb	20 9d 06	jsr $069d	                jsr recvR2XA                ;receive X and Y arguments
6640	.ad53	05ee	a8		tay		                tay                         ;Y = Y argument
6641	.ad54	05ef	20 a1 06	jsr $06a1	                jsr recvR2                  ;receive A argument
6642	.ad57	05f2	20 f4 ff	jsr $fff4	                jsr OSBYTE                  ;call OSBYTE
6643	.ad5a	05f5	49 9d		eor #$9d	                eor #$9D                    ;was it Fast Tube BPUT?
6644	.ad5c	05f7	f0 ef		beq $05e8	                beq goIdle_1      ;if it was, done.
6645	.ad5e	05f9	6a		ror a		                ror a
6646	.ad5f	05fa	20 61 06	jsr $0661	                jsr sendR2A       ;send carry result
6647	.ad62	05fd					-
6648	.ad62	05fd	2c e2 fe	bit $fee2	                bit tube.status2
6649	.ad65	0600	50 fb		bvc $05fd	                bvc -
6650	.ad67	0602	8c e3 fe	sty $fee3	                sty tube.data2               ;send Y result
6651	.ad6a	0605	80 d9		bra $05e0	                bra sendR2X                  ;send X result

6653							;-------------------------------------------------------------------------
6654							;
6655							; Handle a Tube OSWORD request.
6656							;
6657							; [Tube p22]
6658							;
6659	.ad6c	0607					doWORD:
6660	.ad6c	0607	20 a1 06	jsr $06a1	                jsr recvR2
6661	.ad6f	060a	a8		tay		                tay
6662	.ad70	060b	20 aa 06	jsr $06aa	                jsr LAE0F
6663	.ad73	060e	30 0a		bmi $061a	                bmi LAD7F
6664	.ad75	0610					LAD75:
6665	.ad75	0610	20 a1 06	jsr $06a1	                jsr recvR2
6666	.ad78	0613	9d 28 01	sta $0128,x	                sta tubeOSWORDBuffer,x
6667	.ad7b	0616	ca		dex		                dex
6668	.ad7c	0617	10 f7		bpl $0610	                bpl LAD75
6669	.ad7e	0619	98		tya		                tya
6670	.ad7f	061a					LAD7F:
6671	.ad7f	061a	a2 28		ldx #$28	                ldx #<tubeOSWORDBuffer
6672	.ad81	061c	a0 01		ldy #$01	                ldy #>tubeOSWORDBuffer
6673	.ad83	061e	20 f1 ff	jsr $fff1	                jsr OSWORD
6674	.ad86	0621	20 aa 06	jsr $06aa	                jsr LAE0F
6675	.ad89	0624	30 c2		bmi $05e8	                bmi goIdle_1
6676	.ad8b	0626					LAD8B:
6677	.ad8b	0626	bc 28 01	ldy $0128,x	                ldy tubeOSWORDBuffer,x
6678	.ad8e	0629					LAD8E:
6679	.ad8e	0629	2c e2 fe	bit $fee2	                bit tube.status2
6680	.ad91	062c	50 fb		bvc $0629	                bvc LAD8E
6681	.ad93	062e	8c e3 fe	sty $fee3	                sty tube.data2
6682	.ad96	0631	ca		dex		                dex
6683	.ad97	0632	10 f2		bpl $0626	                bpl LAD8B
6684	.ad99	0634					LAD99:
6685	.ad99	0634	80 b2		bra $05e8	                bra goIdle_1

6687							;-------------------------------------------------------------------------

6689	.ad9b	0636					doRDLN:
6690	.ad9b	0636	a2 04		ldx #$04	                ldx #$04
6691	.ad9d	0638					LAD9D:
6692	.ad9d	0638	20 a1 06	jsr $06a1	                jsr recvR2
6693							                .if version==350
6695							                .else
6696	.ada0	063b	95 00		sta $00,x	                sta $00,x
6697							                .endif
6698	.ada2	063d	ca		dex		                dex
6699	.ada3	063e	10 f8		bpl $0638	                bpl LAD9D
6700	.ada5	0640	e8		inx		                inx
6701	.ada6	0641	8a		txa		                txa
6702	.ada7	0642	a8		tay		                tay
6703	.ada8	0643	20 f1 ff	jsr $fff1	                jsr OSWORD
6704	.adab	0646	90 05		bcc $064d	                bcc LADB2
6705	.adad	0648	a9 ff		lda #$ff	                lda #$FF
6706	.adaf	064a	4c 90 05	jmp $0590	                jmp sendR2AThenGoIdle

6708	.adb2	064d					LADB2:
6709	.adb2	064d	a2 00		ldx #$00	                ldx #$00
6710	.adb4	064f	a9 7f		lda #$7f	                lda #$7F
6711	.adb6	0651	20 61 06	jsr $0661	                jsr sendR2A
6712	.adb9	0654					LADB9:
6713	.adb9	0654	bd 00 07	lda $0700,x	                lda $0700,x
6714	.adbc	0657	20 61 06	jsr $0661	                jsr sendR2A
6715	.adbf	065a	e8		inx		                inx
6716	.adc0	065b	c9 0d		cmp #$0d	                cmp #$0D
6717	.adc2	065d	d0 f5		bne $0654	                bne LADB9
6718	.adc4	065f	80 d3		bra $0634	                bra LAD99

6720	.adc6	0661					sendR2A:                          ;adc6/0661
6721	.adc6	0661	2c e2 fe	bit $fee2	                bit tube.status2
6722	.adc9	0664	50 fb		bvc $0661	                bvc sendR2A
6723	.adcb	0666	8d e3 fe	sta $fee3	                sta tube.data2
6724	.adce	0669	60		rts		                rts

6726	.adcf	066a					sendR4TubeClaimantID:              ;adcf
6727	.adcf	066a	a5 15		lda $15		                lda tubeClaimantID ;get Tube ID
6728	.add1	066c					sendR4:                          ;add1/066c
6729	.add1	066c	2c e6 fe	bit $fee6	                bit tube.status4 ;check R4 status
6730	.add4	066f	50 fb		bvc $066c	                bvc sendR4       ;branch taken if FIFO full
6731	.add6	0671	8d e7 fe	sta $fee7	                sta tube.data4   ;put byte in FIFO
6732	.add9	0674	60		rts		                rts

6734	.adda	0675					LADDA:
6735	.adda	0675	a5 ff		lda $ff		                lda $FF
6736	.addc	0677	38		sec		                sec
6737	.addd	0678	6a		ror a		                ror a
6738	.adde	0679	80 0f		bra $068a	                bra LADEF

6740	.ade0	067b					eventHandler:
6741	.ade0	067b	48		pha		                pha
6742	.ade1	067c	a9 00		lda #$00	                lda #$00
6743	.ade3	067e	20 8a 06	jsr $068a	                jsr LADEF
6744	.ade6	0681	98		tya		                tya
6745	.ade7	0682	20 8a 06	jsr $068a	                jsr LADEF
6746	.adea	0685	8a		txa		                txa
6747	.adeb	0686	20 8a 06	jsr $068a	                jsr LADEF
6748	.adee	0689	68		pla		                pla
6749	.adef	068a					LADEF:
6750	.adef	068a	2c e0 fe	bit $fee0	                bit tube.status1
6751	.adf2	068d	50 fb		bvc $068a	                bvc LADEF
6752	.adf4	068f	8d e1 fe	sta $fee1	                sta tube.data1
6753	.adf7	0692	60		rts		                rts

6755							;-------------------------------------------------------------------------
6756							;
6757							; Receive multiple bytes via R2: some kind of parameter block,
6758							; followed by the reason code. Store the first N-1 received in zero
6759							; page, starting at $00.
6760							;
6761							; entry:
6762							;
6763							; X = number of bytes to receive, minus 1
6764							;
6765							; exit:
6766							;
6767							; ?$00, ?$01... = first N-1 bytes received
6768							;
6769							; A = final byte received
6770							;
6771							; X = 0
6772							;
6773	.adf8	0693					recvR2N:
6774	.adf8	0693	20 a1 06	jsr $06a1	                jsr recvR2
6775	.adfb	0696	95 ff		sta $ff,x	                sta $ff,x
6776	.adfd	0698	ca		dex		                dex
6777	.adfe	0699	d0 f8		bne $0693	                bne recvR2N
6778	.ae00	069b	80 04		bra $06a1	                bra recvR2

6780							;-------------------------------------------------------------------------
6781							;
6782							; Receive 2 bytes via R2.
6783							;
6784							; exit:
6785							;
6786							; X = first byte received
6787							;
6788							; A = second byte received
6789							;
6790	.ae02	069d					recvR2XA:
6791	.ae02	069d	20 a1 06	jsr $06a1	                jsr recvR2
6792	.ae05	06a0	aa		tax		                tax

6794							;-------------------------------------------------------------------------
6795							;
6796							; Receive 1 byte via R2.
6797							;
6798							; exit:
6799							;
6800							; A = byte received
6801							;
6802	.ae06	06a1					recvR2:
6803	.ae06	06a1	2c e2 fe	bit $fee2	                bit tube.status2
6804	.ae09	06a4	10 fb		bpl $06a1	                bpl recvR2
6805	.ae0b	06a6	ad e3 fe	lda $fee3	                lda tube.data2
6806	.ae0e	06a9	60		rts		                rts

6808							;-------------------------------------------------------------------------

6810	.ae0f	06aa					LAE0F:
6811	.ae0f	06aa	2c e2 fe	bit $fee2	                bit tube.status2
6812	.ae12	06ad	10 fb		bpl $06aa	                bpl LAE0F
6813	.ae14	06af	ae e3 fe	ldx $fee3	                ldx tube.data2
6814	.ae17	06b2	ca		dex		                dex
6815	.ae18	06b3	60		rts		                rts
6816							                .here
6817							                .bend

6819							;-------------------------------------------------------------------------
6820							                .endif

6822							                .if version<400
6823							                .include "terminal_code.s65"

:12	;******  Processing file: src/terminal_code.s65

1							;-------------------------------------------------------------------------

3	.ae19						terminalServiceEntryPoint:
4	.ae19		08		php		                php
5	.ae1a		5a		phy		                phy
6	.ae1b		da		phx		                phx
7	.ae1c		48		pha		                pha
8	.ae1d		c9 04		cmp #$04	                cmp #romServiceCallUnrecognisedCommand
9	.ae1f		f0 0d		beq $ae2e	                beq handleUnrecognisedCommand
10	.ae21		c9 07		cmp #$07	                cmp #romServiceCallUnrecognisedOSBYTE
11	.ae23		f0 25		beq $ae4a	                beq handleUnrecognisedOSBYTE
12	.ae25		c9 2a		cmp #$2a	                cmp #romServiceCallLanguageChange
13	.ae27		f0 74		beq $ae9d	                beq handleLanguageChange
14	.ae29						LAE29:
15	.ae29		68		pla		                pla
16	.ae2a		fa		plx		                plx
17	.ae2b		7a		ply		                ply
18	.ae2c		28		plp		                plp
19	.ae2d		60		rts		                rts

21	.ae2e						handleUnrecognisedCommand:
22	.ae2e		20 32 b8	jsr $b832	                jsr LB832
23	.ae31		c9 0b		cmp #$0b	                cmp #$0B
24	.ae33		d0 f4		bne $ae29	                bne LAE29
25	.ae35		68		pla		                pla
26	.ae36		fa		plx		                plx
27	.ae37		a9 8e		lda #$8e	                lda #$8E
28	.ae39		20 f4 ff	jsr $fff4	                jsr OSBYTE
29	.ae3c						LAE3C:
30	.ae3c		a2 04		ldx #$04	                ldx #$04
31	.ae3e						LAE3E:
32	.ae3e		bd 29 02	lda $0229,x	                lda INSV-1,x
33	.ae41		dd 92 ae	cmp $ae92,x	                cmp LAE93-1,x
34	.ae44		d0 03		bne $ae49	                bne LAE49
35	.ae46		ca		dex		                dex
36	.ae47		d0 f5		bne $ae3e	                bne LAE3E
37	.ae49						LAE49:
38	.ae49		60		rts		                rts

40	.ae4a						handleUnrecognisedOSBYTE:
41	.ae4a		5a		phy		                phy
42	.ae4b		7a		ply		                ply
43	.ae4c		d0 db		bne $ae29	                bne LAE29
44	.ae4e		a5 ef		lda $ef		                lda $EF
45	.ae50		c9 60		cmp #$60	                cmp #$60
46	.ae52		d0 d5		bne $ae29	                bne LAE29

48							                ; handle OSBYTE $60
49	.ae54						osbyte60:
50	.ae54		68		pla		                pla
51	.ae55		5a		phy		                phy
52	.ae56		78		sei		                sei
53	.ae57		a5 f0		lda $f0		                lda $F0
54	.ae59		30 11		bmi $ae6c	                bmi LAE6C
55	.ae5b		4a		lsr a		                lsr a
56	.ae5c		d0 08		bne $ae66	                bne LAE66
57	.ae5e		a9 11		lda #$11	                lda #$11
58	.ae60		85 76		sta $76		                sta $76
59	.ae62		66 74		ror $74		                ror $74
60	.ae64		80 c3		bra $ae29	                bra LAE29

62	.ae66						LAE66:

64	.ae66		64 78		stz $78		                stz $78
65	.ae68		66 77		ror $77		                ror $77

67	.ae6a						LAE6A:
68	.ae6a		80 bd		bra $ae29	                bra LAE29

70	.ae6c						LAE6C:
71	.ae6c		4a		lsr a		                lsr a
72	.ae6d		90 2e		bcc $ae9d	                bcc handleLanguageChange
73	.ae6f		64 75		stz $75		                stz $75
74	.ae71		20 3c ae	jsr $ae3c	                jsr LAE3C
75	.ae74		f0 b3		beq $ae29	                beq LAE29
76	.ae76		a2 04		ldx #$04	                ldx #$04
77	.ae78						LAE78:
78	.ae78		bd 29 02	lda $0229,x	                lda INSV-1,x
79	.ae7b		95 6f		sta $6f,x	                sta oldINSV-1,x
80	.ae7d		bd 92 ae	lda $ae92,x	                lda LAE93-1,x
81	.ae80		9d 29 02	sta $0229,x	                sta INSV-1,x
82	.ae83		ca		dex		                dex
83	.ae84		d0 f2		bne $ae78	                bne LAE78
84	.ae86		a2 06		ldx #$06	                ldx #$06
85	.ae88						LAE88:
86	.ae88		bd 96 ae	lda $ae96,x	                lda LAE97-1,x
87	.ae8b		9d dd 0d	sta $0ddd,x	                sta ExtendedVectorAddress(INSV)-1,x
88	.ae8e		ca		dex		                dex
89	.ae8f		d0 f7		bne $ae88	                bne LAE88
90	.ae91		80 d7		bra $ae6a	                bra LAE6A

92	.ae93						LAE93:
93	>ae93		3f ff				                .word mos.E_INSV
94	>ae95		42 ff				                .word mos.E_REMV
95	.ae97						LAE97:
96	>ae97		d4 ae				                .word LAED4
97	>ae99		0f				                .byte terminalROM
98	>ae9a		13 af				                .word LAF13
99	>ae9c		0f				                .byte terminalROM

101	.ae9d						handleLanguageChange:
102	.ae9d		78		sei		                sei
103	.ae9e		20 3c ae	jsr $ae3c	                jsr LAE3C
104	.aea1		d0 c7		bne $ae6a	                bne LAE6A
105	.aea3		a2 06		ldx #$06	                ldx #$06
106	.aea5						LAEA5:
107	.aea5		bd dd 0d	lda $0ddd,x	                lda ExtendedVectorAddress(INSV)-1,x;extendedVectorSpace+insvIndex*3-1,x
108	.aea8		dd 96 ae	cmp $ae96,x	                cmp LAE97-1,x
109	.aeab		d0 bd		bne $ae6a	                bne LAE6A
110	.aead		ca		dex		                dex
111	.aeae		d0 f5		bne $aea5	                bne LAEA5
112	.aeb0		a2 04		ldx #$04	                ldx #$04
113	.aeb2						LAEB2:
114	.aeb2		b5 6f		lda $6f,x	                lda oldINSV-1,x
115	.aeb4		9d 29 02	sta $0229,x	                sta INSV-1,x
116	.aeb7		ca		dex		                dex
117	.aeb8		d0 f8		bne $aeb2	                bne LAEB2
118	.aeba		a9 e6		lda #$e6	                lda #$E6
119	.aebc		20 23 b8	jsr $b823	                jsr osbyteX00Y00
120	.aebf		a9 cb		lda #$cb	                lda #$CB
121	.aec1		a2 09		ldx #$09	                ldx #$09
122	.aec3		20 25 b8	jsr $b825	                jsr osbyteY00
123	.aec6		20 1a b1	jsr $b11a	                jsr LB11A
124	.aec9		1a		inc a		                inc a
125	.aeca						LAECA:
126	.aeca		20 23 b8	jsr $b823	                jsr osbyteX00Y00
127	.aecd		3a		dec a		                dec a
128	.aece		c9 01		cmp #$01	                cmp #$01
129	.aed0		d0 f8		bne $aeca	                bne LAECA
130	.aed2		80 96		bra $ae6a	                bra LAE6A

132	.aed4						LAED4:
133	.aed4		08		php		                php
134	.aed5		78		sei		                sei
135	.aed6		e0 01		cpx #$01	                cpx #$01
136	.aed8		d0 31		bne $af0b	                bne LAF0B
137	.aeda		24 77		bit $77		                bit $77
138	.aedc		10 0e		bpl $aeec	                bpl LAEEC
139	.aede		c9 13		cmp #$13	                cmp #$13
140	.aee0		f0 05		beq $aee7	                beq LAEE7
141	.aee2		c9 11		cmp #$11	                cmp #$11
142	.aee4		d0 06		bne $aeec	                bne LAEEC
143	.aee6		18		clc		                clc
144	.aee7						LAEE7:
145	.aee7		66 78		ror $78		                ror $78
146	.aee9						LAEE9:
147	.aee9		28		plp		                plp
148	.aeea		18		clc		                clc
149	.aeeb		60		rts		                rts

151	.aeec						LAEEC:
152	.aeec		24 74		bit $74		                bit $74
153	.aeee		10 1b		bpl $af0b	                bpl LAF0B
154	.aef0		48		pha		                pha
155	.aef1		38		sec		                sec
156	.aef2		20 0f af	jsr $af0f	                jsr LAF0F
157	.aef5		98		tya		                tya
158	.aef6		d0 10		bne $af08	                bne LAF08
159	.aef8		e0 20		cpx #$20	                cpx #$20
160	.aefa		b0 0c		bcs $af08	                bcs LAF08
161	.aefc		a9 13		lda #$13	                lda #$13
162	.aefe		e0 10		cpx #$10	                cpx #$10
163	.af00		90 04		bcc $af06	                bcc LAF06
164	.af02		c5 76		cmp $76		                cmp $76
165	.af04		f0 02		beq $af08	                beq LAF08
166	.af06						LAF06:
167	.af06		85 75		sta $75		                sta $75
168	.af08						LAF08:
169	.af08		68		pla		                pla
170	.af09		a2 01		ldx #$01	                ldx #$01
171	.af0b						LAF0B:
172	.af0b		28		plp		                plp
173	.af0c		6c 70 00	jmp ($0070)	                jmp ($0070)

175	.af0f						LAF0F:
176	.af0f		b8		clv		                clv
177	.af10		6c 2e 02	jmp ($022e)	                jmp (CNPV)

179	.af13						LAF13:
180	.af13		08		php		                php
181	.af14		78		sei		                sei
182	.af15		e0 01		cpx #$01	                cpx #$01
183	.af17		d0 1e		bne $af37	                bne LAF37
184	.af19		24 74		bit $74		                bit $74
185	.af1b		10 16		bpl $af33	                bpl LAF33
186	.af1d		18		clc		                clc
187	.af1e		20 0f af	jsr $af0f	                jsr LAF0F
188	.af21		c0 00		cpy #$00	                cpy #$00
189	.af23		d0 0c		bne $af31	                bne LAF31
190	.af25		e0 20		cpx #$20	                cpx #$20
191	.af27		b0 08		bcs $af31	                bcs LAF31
192	.af29		a9 11		lda #$11	                lda #$11
193	.af2b		c5 76		cmp $76		                cmp $76
194	.af2d		f0 02		beq $af31	                beq LAF31
195	.af2f		85 75		sta $75		                sta $75
196	.af31						LAF31:
197	.af31		a2 01		ldx #$01	                ldx #$01
198	.af33						LAF33:
199	.af33		28		plp		                plp
200	.af34		6c 72 00	jmp ($0072)	                jmp ($0072)

202	.af37						LAF37:
203	.af37		e0 02		cpx #$02	                cpx #$02
204	.af39		d0 f8		bne $af33	                bne LAF33
205	.af3b		a5 75		lda $75		                lda $75
206	.af3d		a8		tay		                tay
207	.af3e		f0 08		beq $af48	                beq LAF48
208	.af40		70 a7		bvs $aee9	                bvs LAEE9
209	.af42		64 75		stz $75		                stz $75
210	.af44		85 76		sta $76		                sta $76
211	.af46		80 a1		bra $aee9	                bra LAEE9

213	.af48						LAF48:
214	.af48		a5 78		lda $78		                lda $78
215	.af4a		10 e7		bpl $af33	                bpl LAF33
216	.af4c		28		plp		                plp
217	.af4d		38		sec		                sec
218	.af4e						LAF4E:
219	.af4e		60		rts		                rts

221							;-------------------------------------------------------------------------

223	.af4f						terminalBRKHandler:
224	.af4f		a9 da		lda #$da	                lda #$DA
225	.af51		20 23 b8	jsr $b823	                jsr osbyteX00Y00             ;Set VDU queue length to 0
226	.af54		20 34 b6	jsr $b634	                jsr disableESCAPE
227	.af57		a0 00		ldy #$00	                ldy #$00
228	.af59		b1 fd		lda ($fd),y	                lda (errPtr),y
229	.af5b		d0 06		bne $af63	                bne LAF63
230	.af5d		64 20		stz $20		                stz $20
231	.af5f		a9 16		lda #$16	                lda #$16
232	.af61		85 6f		sta $6f		                sta $6F
233	.af63						LAF63:
234	.af63		a9 0d		lda #$0d	                lda #13
235	.af65						-
236	.af65		20 e3 ff	jsr $ffe3	                jsr OSASCI
237	.af68		c8		iny		                iny
238	.af69		b1 fd		lda ($fd),y	                lda (errPtr),y
239	.af6b		d0 f8		bne $af65	                bne -
240	.af6d		20 e7 ff	jsr $ffe7	                jsr OSNEWL
241	.af70		38		sec		                sec
242	.af71		66 19		ror $19		                ror $19
243	.af73		a5 1a		lda $1a		                lda $1A
244	.af75		d0 7d		bne $aff4	                bne LAFF4
245	.af77						terminalLanguageEntryPoint:
246	.af77		3a		dec a		                dec a
247	.af78		d0 d4		bne $af4e	                bne LAF4E
248	.af7a		a9 01		lda #$01	                lda #$01
249	.af7c		85 6f		sta $6f		                sta $6F
250	.af7e						LAF7E:
251	.af7e		78		sei		                sei
252	.af7f		a2 fe		ldx #$fe	                ldx #$FE
253	.af81		9a		txs		                txs
254	.af82		a9 4f		lda #$4f	                lda #<terminalBRKHandler
255	.af84		8d 02 02	sta $0202	                sta BRKV+0
256	.af87		a9 af		lda #$af	                lda #>terminalBRKHandler
257	.af89		8d 03 02	sta $0203	                sta BRKV+1
258	.af8c		a9 b1		lda #$b1	                lda #<terminalINDnHandler
259	.af8e		8d 30 02	sta $0230	                sta IND1V+0
260	.af91		a9 b7		lda #$b7	                lda #>terminalINDnHandler
261	.af93		8d 31 02	sta $0231	                sta IND1V+1
262	.af96		a9 b1		lda #$b1	                lda #<terminalINDnHandler
263	.af98		8d 32 02	sta $0232	                sta IND2V+0
264	.af9b		a9 b7		lda #$b7	                lda #>terminalINDnHandler
265	.af9d		8d 33 02	sta $0233	                sta IND2V+1

267							                ; Clear zero page
268	.afa0		a2 6e		ldx #$6e	                ldx #$6E
269	.afa2						-
270	.afa2		74 00		stz $00,x	                stz $00,x
271	.afa4		ca		dex		                dex
272	.afa5		10 fb		bpl $afa2	                bpl -

274	.afa7		c6 21		dec $21		                dec $21
275	.afa9		c6 34		dec $34		                dec $34
276	.afab		c6 36		dec $36		                dec $36
277	.afad		58		cli		                cli
278	.afae		a9 0b		lda #$0b	                lda #$0B
279	.afb0		20 90 b6	jsr $b690	                jsr LB690
280	.afb3		a9 87		lda #$87	                lda #$87
281	.afb5		20 f4 ff	jsr $fff4	                jsr OSBYTE                   ;Read screen mode
282	.afb8		98		tya		                tya                          ;A = screen mode
283	.afb9		20 79 b5	jsr $b579	                jsr reinitDisplayMode
284	.afbc		a0 ff		ldy #$ff	                ldy #$FF
285	.afbe						-
286	.afbe		c8		iny		                iny
287	.afbf		b9 ce af	lda $afce,y	                lda initOSBYTEAs,y
288	.afc2		f0 30		beq $aff4	                beq LAFF4
289	.afc4		be e1 af	ldx $afe1,y	                ldx initOSBYTEXs,y
290	.afc7		5a		phy		                phy
291	.afc8		20 25 b8	jsr $b825	                jsr osbyteY00
292	.afcb		7a		ply		                ply
293	.afcc		80 f0		bra $afbe	                bra -

295							;-------------------------------------------------------------------------

297	.afce						initOSBYTEAs:
298	>afce		cb				                .byte $CB ;OSBYTE 203 (&CB) Read/write RS423 input buffer [MasRef D.2-64]
299	>afcf		60				                .byte $60 ;OSBYTE 96 (&60) ???
300	>afd0		60				                .byte $60 ;OSBYTE 96 (&60) ???
301	>afd1		60				                .byte $60 ;OSBYTE 96 (&60) ???
302	>afd2		0f				                .byte $0F ;OSBYTE 15 (&0F) Flush buffer [MasRef D.2-24]
303	>afd3		0f				                .byte $0F ;OSBYTE 15 (&0F) Flush buffer [MasRef D.2-24]
304	>afd4		dd				                .byte $dd ;OSBYTE 221 (&DD) Read/write interpretation of input values 192-207 [MasRef D.2-73]
305	>afd5		de				                .byte $de ;OSBYTE 222 (&DE) Read/write interpretation of input values 208-223 [MasRef D.2-73]
306	>afd6		df				                .byte $df ;OSBYTE 223 (&DF) Read/write interpretation of input values 224-239 [MasRef D.2-73]
307	>afd7		e0				                .byte $e0 ;OSBYTE 224 (&E0) Read/write interpretation of input values 240-255 [MasRef D.2-73]
308	>afd8		e1				                .byte $e1 ;OSBYTE 225 (&E1) Read/write soft key interpretation [MasRef D.2-74]
309	>afd9		e2				                .byte $E2 ;OSBYTE 226 (&E2) Read/write SHIFT+soft key interpretation [MasRef D.2-74]
310	>afda		e3				                .byte $E3 ;OSBYTE 227 (&E3) Read/write CTRL+soft key interpretation [MasRef D.2-74]
311	>afdb		e4				                .byte $e4 ;OSBYTE 228 (&E4) Read/write SHIFT+CTRL+soft key interpretation [MasRef D.2-74]
312	>afdc		e5				                .byte $e5 ;OSBYTE 229 (&E5) Read/write ESCAPE key status [MasRef D.2-75]
313	>afdd		04				                .byte $04 ;OSBYTE 4 (&04) Enable/disable cursor editing [MasRef D.2-19]
314	>afde		7e				                .byte $7e ;OSBYTE 126 (&7E) Acknowledge escape condition [MasRef D.2-37]
315	>afdf		e6				                .byte $e6 ;OSBYTE 230 (&E6) Read/write ESCAPE effects [MasRef D.2-75]
316	>afe0		02				                .byte $02 ;OSBYTE 2 (&02) Specify input stream [MasRef D.2-18]

318	.afe1						initOSBYTEXs:
319	>afe1		00				                .byte $00
320	>afe2		01				                .byte $01
321	>afe3		03				                .byte $03
322	>afe4		ff				                .byte $ff
323	>afe5		01				                .byte $01
324	>afe6		02				                .byte $02
325	>afe7		c0				                .byte $c0
326	>afe8		d0				                .byte $d0
327	>afe9		e0				                .byte $e0
328	>afea		f0				                .byte $f0
329	>afeb		01				                .byte $01
330	>afec		90				                .byte $90
331	>afed		a0				                .byte $a0
332	>afee		a0				                .byte $a0
333	>afef		01				                .byte $01
334	>aff0		00				                .byte $00
335	>aff1		00				                .byte $00
336	>aff2		01				                .byte $01
337	>aff3		02				                .byte $02

339							;-------------------------------------------------------------------------

341	.aff4						LAFF4:
342	.aff4		a2 fe		ldx #$fe	                ldx #$FE
343	.aff6		9a		txs		                txs
344	.aff7		38		sec		                sec
345	.aff8		66 1a		ror $1a		                ror $1A
346	.affa		64 1d		stz $1d		                stz $1D
347	.affc		20 04 b0	jsr $b004	                jsr LB004
348	.afff		20 04 b0	jsr $b004	                jsr LB004
349	.b002		80 2c		bra $b030	                bra LB030

351	.b004						LB004:
352	.b004		20 41 b0	jsr $b041	                jsr LB041
353	.b007		a0 01		ldy #$01	                ldy #$01
354	.b009		91 1b		sta ($1b),y	                sta ($1B),y
355	.b00b		c8		iny		                iny
356	.b00c		8a		txa		                txa
357	.b00d		91 1b		sta ($1b),y	                sta ($1B),y
358	.b00f		c8		iny		                iny
359	.b010		98		tya		                tya
360	.b011		91 1b		sta ($1b),y	                sta ($1B),y
361	.b013		0a		asl a		                asl a
362	.b014		92 1b		sta ($1b)	                sta ($1B)
363	.b016		60		rts		                rts

365	.b017						LB017:
366	.b017		08		php		                php
367	.b018		48		pha		                pha
368	.b019		da		phx		                phx
369	.b01a		5a		phy		                phy
370	.b01b		ba		tsx		                tsx
371	.b01c		e8		inx		                inx
372	.b01d		8a		txa		                txa
373	.b01e		49 ff		eor #$ff	                eor #$FF
374	.b020		92 1b		sta ($1b)	                sta ($1B)
375	.b022		a8		tay		                tay
376	.b023						LB023:
377	.b023		68		pla		                pla
378	.b024		91 1b		sta ($1b),y	                sta ($1B),y
379	.b026		88		dey		                dey
380	.b027		d0 fa		bne $b023	                bne LB023
381	.b029		a9 20		lda #$20	                lda #$20
382	.b02b		85 1e		sta $1e		                sta $1E
383	.b02d		20 41 b0	jsr $b041	                jsr LB041
384	.b030						LB030:
385	.b030		b2 1b		lda ($1b)	                lda ($1B)
386	.b032		aa		tax		                tax
387	.b033		a0 00		ldy #$00	                ldy #$00
388	.b035						LB035:
389	.b035		c8		iny		                iny
390	.b036		b1 1b		lda ($1b),y	                lda ($1B),y
391	.b038		48		pha		                pha
392	.b039		ca		dex		                dex
393	.b03a		d0 f9		bne $b035	                bne LB035
394	.b03c		7a		ply		                ply
395	.b03d		fa		plx		                plx
396	.b03e		68		pla		                pla
397	.b03f		28		plp		                plp
398	.b040		60		rts		                rts

400	.b041						LB041:
401	.b041		a0 04		ldy #$04	                ldy #$04
402	.b043		84 1c		sty $1c		                sty $1C
403	.b045		a0 20		ldy #$20	                ldy #$20
404							                ; Is this an adress?
405							                .if version==350
407							                .else
408	.b047		a2 50		ldx #$50	                ldx #$50
409							                .endif
410	.b049		a9 b6		lda #$b6	                lda #$B6
411	.b04b		46 1d		lsr $1d		                lsr $1D
412	.b04d		b0 0c		bcs $b05b	                bcs LB05B
413	.b04f		e6 1d		inc $1d		                inc $1D
414	.b051		a0 04		ldy #$04	                ldy #$04
415	.b053		84 1c		sty $1c		                sty $1C
416	.b055		a0 00		ldy #$00	                ldy #$00
417							                .if version==350
419							                .else
420	.b057		a2 5d		ldx #$5d	                ldx #$5D
421							                .endif
422	.b059		a9 b0		lda #$b0	                lda #$B0
423	.b05b						LB05B:
424	.b05b		84 1b		sty $1b		                sty $1B
425	.b05d		60		rts		                rts

427	.b05e						LB05E:
428	.b05e		20 63 b0	jsr $b063	                jsr LB063
429	.b061		80 fb		bra $b05e	                bra LB05E

431	.b063						LB063:
432	.b063		24 20		bit $20		                bit $20
433	.b065		10 05		bpl $b06c	                bpl LB06C
434	.b067		20 96 b0	jsr $b096	                jsr LB096
435	.b06a		90 17		bcc $b083	                bcc LB083
436	.b06c						LB06C:
437	.b06c		80 a9		bra $b017	                bra LB017

439	.b06e						LB06E:
440	.b06e		c9 0a		cmp #$0a	                cmp #$0A
441	.b070		90 0f		bcc $b081	                bcc LB081
442	.b072		a2 00		ldx #$00	                ldx #$00
443	.b074						LB074:
444	.b074		e8		inx		                inx
445	.b075		e9 0a		sbc #$0a	                sbc #$0A
446	.b077		c9 0a		cmp #$0a	                cmp #$0A
447	.b079		b0 f9		bcs $b074	                bcs LB074
448	.b07b		48		pha		                pha
449	.b07c		8a		txa		                txa
450	.b07d		20 6e b0	jsr $b06e	                jsr LB06E
451	.b080		68		pla		                pla
452	.b081						LB081:
453	.b081		09 30		ora #$30	                ora #$30
454	.b083						LB083:
455	.b083		48		pha		                pha
456	.b084		5a		phy		                phy
457	.b085		a8		tay		                tay
458	.b086		a9 8a		lda #$8a	                lda #$8A
459	.b088		a2 02		ldx #$02	                ldx #$02
460	.b08a		20 f4 ff	jsr $fff4	                jsr OSBYTE
461	.b08d		7a		ply		                ply
462	.b08e		68		pla		                pla
463	.b08f		90 1f		bcc $b0b0	                bcc LB0B0
464	.b091		20 17 b0	jsr $b017	                jsr LB017
465	.b094		80 ed		bra $b083	                bra LB083

467	.b096						LB096:
468	.b096		a4 6f		ldy $6f		                ldy $6F
469	.b098		f0 17		beq $b0b1	                beq LB0B1
470	.b09a		e6 6f		inc $6f		                inc $6F
471	.b09c		b9 4b b1	lda $b14b,y	                lda LB14C-1,y
472	.b09f		10 0d		bpl $b0ae	                bpl LB0AE
473	.b0a1		64 6f		stz $6f		                stz $6F
474	.b0a3		48		pha		                pha
475	.b0a4		a9 d9		lda #$d9	                lda #$D9
476	.b0a6		20 23 b8	jsr $b823	                jsr osbyteX00Y00
477	.b0a9		68		pla		                pla
478	.b0aa		a0 18		ldy #$18	                ldy #$18
479	.b0ac		84 1f		sty $1f		                sty $1F
480	.b0ae						LB0AE:
481	.b0ae		0a		asl a		                asl a
482	.b0af		4a		lsr a		                lsr a
483	.b0b0						LB0B0:
484	.b0b0		60		rts		                rts

486	.b0b1						LB0B1:
487	.b0b1		a9 81		lda #$81	                lda #$81
488	.b0b3		20 23 b8	jsr $b823	                jsr osbyteX00Y00
489	.b0b6		8a		txa		                txa
490	.b0b7		b0 f7		bcs $b0b0	                bcs LB0B0
491	.b0b9		10 f5		bpl $b0b0	                bpl LB0B0
492	.b0bb		c9 e0		cmp #$e0	                cmp #$E0
493	.b0bd		b0 f1		bcs $b0b0	                bcs LB0B0
494	.b0bf		20 c4 b0	jsr $b0c4	                jsr LB0C4
495	.b0c2		38		sec		                sec
496	.b0c3						LB0C3:
497	.b0c3		60		rts		                rts

499	.b0c4						LB0C4:
500	.b0c4		c9 99		cmp #$99	                cmp #$99
501	.b0c6		f0 62		beq $b12a	                beq LB12A
502	.b0c8		29 0f		and #$0f	                and #$0F
503	.b0ca		f0 1d		beq $b0e9	                beq LB0E9
504	.b0cc		c9 02		cmp #$02	                cmp #$02
505	.b0ce		90 1e		bcc $b0ee	                bcc LB0EE
506	.b0d0		f0 f1		beq $b0c3	                beq LB0C3
507	.b0d2		c9 04		cmp #$04	                cmp #$04
508	.b0d4		90 40		bcc $b116	                bcc LB116
509	.b0d6		f0 42		beq $b11a	                beq LB11A
510	.b0d8		c9 06		cmp #$06	                cmp #$06
511	.b0da		90 2e		bcc $b10a	                bcc LB10A
512	.b0dc		f0 17		beq $b0f5	                beq LB0F5
513	.b0de		c9 08		cmp #$08	                cmp #$08
514	.b0e0		90 e1		bcc $b0c3	                bcc LB0C3
515	.b0e2		f0 3a		beq $b11e	                beq LB11E
516	.b0e4		c9 09		cmp #$09	                cmp #$09
517	.b0e6		f0 46		beq $b12e	                beq LB12E
518	.b0e8		60		rts		                rts

520	.b0e9						LB0E9:
521	.b0e9		a9 0c		lda #$0c	                lda #$0C
522	.b0eb						LB0EB:
523	.b0eb		4c ee ff	jmp $ffee	                jmp OSWRCH

525	.b0ee						LB0EE:
526	.b0ee		a9 16		lda #$16	                lda #$16
527	.b0f0		85 6f		sta $6f		                sta $6F
528	.b0f2		64 20		stz $20		                stz $20
529	.b0f4		60		rts		                rts

531	.b0f5						LB0F5:
532	.b0f5		a2 10		ldx #$10	                ldx #$10
533	.b0f7		20 01 b1	jsr $b101	                jsr LB101
534	.b0fa		29 10		and #$10	                and #$10
535	.b0fc		d0 15		bne $b113	                bne LB113
536	.b0fe						LB0FE:
537	.b0fe		4c b6 b7	jmp $b7b6	                jmp LB7B6

539	.b101						LB101:
540	.b101		a9 ec		lda #$ec	                lda #$EC
541	.b103		a0 ff		ldy #$ff	                ldy #$FF
542	.b105		20 f4 ff	jsr $fff4	                jsr OSBYTE
543	.b108		8a		txa		                txa
544	.b109		60		rts		                rts

546	.b10a						LB10A:
547	.b10a		a2 40		ldx #$40	                ldx #$40
548	.b10c		20 01 b1	jsr $b101	                jsr LB101
549	.b10f		29 40		and #$40	                and #$40
550	.b111		f0 eb		beq $b0fe	                beq LB0FE
551	.b113						LB113:
552	.b113		4c e2 b7	jmp $b7e2	                jmp LB7E2

554	.b116						LB116:
555	.b116		a9 02		lda #$02	                lda #$02
556	.b118		80 d1		bra $b0eb	                bra LB0EB

558	.b11a						LB11A:
559	.b11a		a9 03		lda #$03	                lda #$03
560	.b11c		80 cd		bra $b0eb	                bra LB0EB

562	.b11e						LB11E:
563	.b11e		a9 ff		lda #$ff	                lda #$FF
564	.b120		45 21		eor $21		                eor $21
565	.b122		85 21		sta $21		                sta $21
566	.b124		85 20		sta $20		                sta $20
567	.b126		d0 d6		bne $b0fe	                bne LB0FE
568	.b128		80 e9		bra $b113	                bra LB113

570	.b12a						LB12A:
571	.b12a		a2 0c		ldx #$0c	                ldx #$0C
572	.b12c		80 02		bra $b130	                bra LB130

574	.b12e						LB12E:
575	.b12e		a2 af		ldx #$af	                ldx #$AF
576	.b130						LB130:
577	.b130		da		phx		                phx
578	.b131		a2 60		ldx #$60	                ldx #$60
579	.b133		20 2a b8	jsr $b82a	                jsr LB82A
580	.b136		fa		plx		                plx
581	.b137						LB137:
582	.b137		da		phx		                phx
583	.b138		a9 13		lda #$13	                lda #$13
584	.b13a		20 f4 ff	jsr $fff4	                jsr OSBYTE
585	.b13d		fa		plx		                plx
586	.b13e		ca		dex		                dex
587	.b13f		d0 f6		bne $b137	                bne LB137
588	.b141		a2 00		ldx #$00	                ldx #$00
589	.b143		20 2a b8	jsr $b82a	                jsr LB82A
590	.b146						LB146:
591	.b146		20 98 b1	jsr $b198	                jsr LB198
592	.b149		90 fb		bcc $b146	                bcc LB146
593	.b14b		60		rts		                rts

595	.b14c						LB14C:
596	>b14c		1b				                .byte $1B
597	.b14d		5e 2a 4b	lsr $4b2a,x	                lsr $4B2A,x
598	.b150		45 59		eor $59		                eor $59
599	.b152		39 7c 21	and $217c,y	                and $217C,y
600	.b155		7c 59 1b	jmp ($1b59,x)	                jmp ($1B59,x)

602	>b158		5c				                .byte $5C
603	>b159		54				                .byte $54
604	.b15a		45 52		eor $52		                eor $52
605	.b15c		4d 49 4e	eor $4e49	                eor $4E49
606	.b15f		41 4c		eor ($4c,x)	                eor ($4C,x)
607	.b161		0d 0a 3d	ora $3d0a	                ora $3D0A
608	>b164		1b				                .byte $1B
609							;BNE LB187        :\ B165= D0 20       P
610							;BVS LB11A        :\ B167= 70 B1       p1
611	>b165		d0				                .byte $D0
612	.b166						LB166:
613	.b166		20 70 b1	jsr $b170	                jsr LB170
614	.b169		b0 59		bcs $b1c4	                bcs LB1C4
615	.b16b		c9 1b		cmp #$1b	                cmp #$1B
616	.b16d		d0 f7		bne $b166	                bne LB166
617	.b16f		60		rts		                rts

619	.b170						LB170:
620	.b170		20 7a b1	jsr $b17a	                jsr LB17A
621	.b173		c9 7f		cmp #$7f	                cmp #$7F
622	.b175		f0 f9		beq $b170	                beq LB170
623	.b177		c9 20		cmp #$20	                cmp #$20
624	.b179		60		rts		                rts

626	.b17a						LB17A:
627	.b17a		da		phx		                phx
628	.b17b		5a		phy		                phy
629	.b17c						LB17C:
630	.b17c		20 89 b1	jsr $b189	                jsr LB189
631	.b17f		b0 03		bcs $b184	                bcs LB184
632	.b181		7a		ply		                ply
633	.b182		fa		plx		                plx
634	.b183		60		rts		                rts

636	.b184						LB184:
637	.b184		20 17 b0	jsr $b017	                jsr LB017
638	.b187						LB187:
639	.b187		80 f3		bra $b17c	                bra LB17C

641	.b189						LB189:
642	.b189		24 20		bit $20		                bit $20
643	.b18b		30 03		bmi $b190	                bmi LB190
644	.b18d		4c 96 b0	jmp $b096	                jmp LB096

646	.b190						LB190:
647	.b190		24 25		bit $25		                bit $25
648	.b192		30 4c		bmi $b1e0	                bmi LB1E0
649	.b194		24 23		bit $23		                bit $23
650	.b196		30 0b		bmi $b1a3	                bmi LB1A3
651	.b198						LB198:
652	.b198		a9 91		lda #$91	                lda #$91
653	.b19a		a2 01		ldx #$01	                ldx #$01
654	.b19c		20 f4 ff	jsr $fff4	                jsr OSBYTE
655	.b19f		98		tya		                tya
656	.b1a0		25 22		and $22		                and $22
657	.b1a2						LB1A2:
658	.b1a2		60		rts		                rts

660	.b1a3						LB1A3:
661	.b1a3		20 98 b1	jsr $b198	                jsr LB198
662	.b1a6		b0 fa		bcs $b1a2	                bcs LB1A2
663	.b1a8		20 d0 b1	jsr $b1d0	                jsr LB1D0
664	.b1ab		90 54		bcc $b201	                bcc LB201
665	.b1ad		0a		asl a		                asl a
666	.b1ae		0a		asl a		                asl a
667	.b1af		0a		asl a		                asl a
668	.b1b0		0a		asl a		                asl a
669	.b1b1		85 24		sta $24		                sta $24
670	.b1b3						LB1B3:
671	.b1b3		20 98 b1	jsr $b198	                jsr LB198
672	.b1b6		90 05		bcc $b1bd	                bcc LB1BD
673	.b1b8		20 17 b0	jsr $b017	                jsr LB017
674	.b1bb		80 f6		bra $b1b3	                bra LB1B3

676	.b1bd						LB1BD:
677	.b1bd		20 d0 b1	jsr $b1d0	                jsr LB1D0
678	.b1c0		90 f1		bcc $b1b3	                bcc LB1B3
679	.b1c2		05 24		ora $24		                ora $24
680	.b1c4						LB1C4:
681	.b1c4		18		clc		                clc
682	.b1c5		60		rts		                rts

684	.b1c6						LB1C6:
685	.b1c6		20 66 b1	jsr $b166	                jsr LB166
686	.b1c9		90 05		bcc $b1d0	                bcc LB1D0
687	.b1cb		fa		plx		                plx
688	.b1cc		fa		plx		                plx
689	.b1cd		4c 89 b3	jmp $b389	                jmp LB389

691	.b1d0						LB1D0:
692	.b1d0		c9 3a		cmp #$3a	                cmp #$3A
693	.b1d2		b0 03		bcs $b1d7	                bcs LB1D7
694	.b1d4		e9 2f		sbc #$2f	                sbc #$2F
695	.b1d6		60		rts		                rts

697	.b1d7						LB1D7:
698	.b1d7		e9 37		sbc #$37	                sbc #$37
699	.b1d9		c9 10		cmp #$10	                cmp #$10
700	.b1db		b0 e7		bcs $b1c4	                bcs LB1C4
701	.b1dd		c9 0a		cmp #$0a	                cmp #$0A
702	.b1df						LB1DF:
703	.b1df		60		rts		                rts

705	.b1e0						LB1E0:
706	.b1e0		64 26		stz $26		                stz $26
707	.b1e2		20 98 b1	jsr $b198	                jsr LB198
708	.b1e5		b0 f8		bcs $b1df	                bcs LB1DF
709	.b1e7		c9 7f		cmp #$7f	                cmp #$7F
710	.b1e9		b0 f4		bcs $b1df	                bcs LB1DF
711	.b1eb		c9 20		cmp #$20	                cmp #$20
712	.b1ed		b0 14		bcs $b203	                bcs LB203
713	.b1ef		24 27		bit $27		                bit $27
714	.b1f1		30 0e		bmi $b201	                bmi LB201
715	.b1f3		c9 07		cmp #$07	                cmp #$07
716	.b1f5		90 0a		bcc $b201	                bcc LB201
717	.b1f7		f0 47		beq $b240	                beq LB240
718	.b1f9		c9 0b		cmp #$0b	                cmp #$0B
719	.b1fb		90 43		bcc $b240	                bcc LB240
720	.b1fd		c9 0d		cmp #$0d	                cmp #$0D
721	.b1ff		f0 3f		beq $b240	                beq LB240
722	.b201						LB201:
723	.b201		38		sec		                sec
724	.b202		60		rts		                rts

726	.b203						LB203:
727	.b203		64 27		stz $27		                stz $27
728	.b205		c9 7c		cmp #$7c	                cmp #$7C
729	.b207		d0 35		bne $b23e	                bne LB23E
730	.b209						LB209:
731	.b209		20 98 b1	jsr $b198	                jsr LB198
732	.b20c		90 05		bcc $b213	                bcc LB213
733	.b20e		20 17 b0	jsr $b017	                jsr LB017
734	.b211		80 f6		bra $b209	                bra LB209

736	.b213						LB213:
737	.b213		c9 20		cmp #$20	                cmp #$20
738	.b215		90 2b		bcc $b242	                bcc LB242
739	.b217		c9 21		cmp #$21	                cmp #$21
740	.b219		d0 14		bne $b22f	                bne LB22F
741	.b21b		a9 80		lda #$80	                lda #$80
742	.b21d		85 26		sta $26		                sta $26
743	.b21f						LB21F:
744	.b21f		20 98 b1	jsr $b198	                jsr LB198
745	.b222		90 05		bcc $b229	                bcc LB229
746	.b224		20 17 b0	jsr $b017	                jsr LB017
747	.b227		80 f6		bra $b21f	                bra LB21F

749	.b229						LB229:
750	.b229		c9 20		cmp #$20	                cmp #$20
751	.b22b		90 f2		bcc $b21f	                bcc LB21F
752	.b22d		80 d4		bra $b203	                bra LB203

754	.b22f						LB22F:
755	.b22f		c9 3f		cmp #$3f	                cmp #$3F
756	.b231		d0 03		bne $b236	                bne LB236
757	.b233		a9 7f		lda #$7f	                lda #$7F
758	.b235		18		clc		                clc
759	.b236						LB236:
760	.b236		90 06		bcc $b23e	                bcc LB23E
761	.b238		c9 7c		cmp #$7c	                cmp #$7C
762	.b23a		f0 02		beq $b23e	                beq LB23E
763	.b23c		29 9f		and #$9f	                and #$9F
764	.b23e						LB23E:
765	.b23e		05 26		ora $26		                ora $26
766	.b240						LB240:
767	.b240		18		clc		                clc
768	.b241		60		rts		                rts

770	.b242						LB242:
771	.b242		38		sec		                sec
772	.b243		66 27		ror $27		                ror $27
773	.b245		38		sec		                sec
774	.b246		60		rts		                rts

776	.b247						LB247:
777	.b247		a9 00		lda #$00	                lda #$00
778	.b249		85 f2		sta $f2		                sta $F2
779	.b24b		a9 05		lda #$05	                lda #$05
780	.b24d		85 f3		sta $f3		                sta $F3
781	.b24f		a0 00		ldy #$00	                ldy #$00
782	.b251						LB251:
783	.b251		20 7a b1	jsr $b17a	                jsr LB17A
784	.b254		a6 1f		ldx $1f		                ldx $1F
785	.b256		f0 3e		beq $b296	                beq LB296
786	.b258		64 2b		stz $2b		                stz $2B
787	.b25a		c9 1b		cmp #$1b	                cmp #$1B
788	.b25c		d0 04		bne $b262	                bne LB262
789	.b25e		a0 00		ldy #$00	                ldy #$00
790	.b260		80 04		bra $b266	                bra LB266

792	.b262						LB262:
793	.b262		c9 0d		cmp #$0d	                cmp #$0D
794	.b264		d0 0d		bne $b273	                bne LB273
795	.b266						LB266:
796	.b266		a9 0d		lda #$0d	                lda #$0D
797	.b268		91 f2		sta ($f2),y	                sta ($F2),y
798	.b26a		24 2b		bit $2b		                bit $2B
799	.b26c		30 03		bmi $b271	                bmi LB271
800	.b26e		20 e3 ff	jsr $ffe3	                jsr OSASCI
801	.b271						LB271:
802	.b271		18		clc		                clc
803	.b272		60		rts		                rts

805	.b273						LB273:
806	.b273		c9 7f		cmp #$7f	                cmp #$7F
807	.b275		d0 07		bne $b27e	                bne LB27E
808	.b277		c0 00		cpy #$00	                cpy #$00
809	.b279		f0 d6		beq $b251	                beq LB251
810	.b27b		88		dey		                dey
811	.b27c		80 13		bra $b291	                bra LB291

813	.b27e						LB27E:
814	.b27e		c9 7f		cmp #$7f	                cmp #$7F
815	.b280		b0 cf		bcs $b251	                bcs LB251
816	.b282		c9 20		cmp #$20	                cmp #$20
817	.b284		90 cb		bcc $b251	                bcc LB251
818	.b286		c0 ff		cpy #$ff	                cpy #$FF
819	.b288		b0 c7		bcs $b251	                bcs LB251
820	.b28a		91 f2		sta ($f2),y	                sta ($F2),y
821	.b28c		c8		iny		                iny
822	.b28d		24 2b		bit $2b		                bit $2B
823	.b28f		30 c0		bmi $b251	                bmi LB251
824	.b291						LB291:
825	.b291		20 28 b7	jsr $b728	                jsr LB728
826	.b294		80 bb		bra $b251	                bra LB251

828	.b296						LB296:
829	.b296		c9 1b		cmp #$1b	                cmp #$1B
830	.b298		d0 e4		bne $b27e	                bne LB27E
831	.b29a		20 66 b1	jsr $b166	                jsr LB166
832	.b29d		c9 5c		cmp #$5c	                cmp #$5C
833	.b29f		f0 c5		beq $b266	                beq LB266
834	.b2a1		38		sec		                sec
835	.b2a2		60		rts		                rts

837	.b2a3						LB2A3:
838	.b2a3		a2 19		ldx #$19	                ldx #$19
839	.b2a5						LB2A5:
840	.b2a5		ca		dex		                dex
841	.b2a6		74 00		stz $00,x	                stz $00,x
842	.b2a8		d0 fb		bne $b2a5	                bne LB2A5
843	.b2aa						LB2AA:
844	.b2aa		64 3a		stz $3a		                stz $3A
845	.b2ac		64 3b		stz $3b		                stz $3B
846	.b2ae						LB2AE:
847	.b2ae		20 66 b1	jsr $b166	                jsr LB166
848	.b2b1		b0 2d		bcs $b2e0	                bcs LB2E0
849	.b2b3		20 ad b8	jsr $b8ad	                jsr LB8AD
850	.b2b6		90 2d		bcc $b2e5	                bcc LB2E5
851	.b2b8		48		pha		                pha
852	.b2b9		a5 3a		lda $3a		                lda $3A
853	.b2bb		95 02		sta $02,x	                sta $02,x
854	.b2bd		a5 3b		lda $3b		                lda $3B
855	.b2bf		95 03		sta $03,x	                sta $03,x
856	.b2c1		68		pla		                pla
857	.b2c2		c9 40		cmp #$40	                cmp #$40
858	.b2c4		b0 2f		bcs $b2f5	                bcs LB2F5
859	.b2c6		c9 30		cmp #$30	                cmp #$30
860	.b2c8		90 0d		bcc $b2d7	                bcc LB2D7
861	.b2ca		c9 3c		cmp #$3c	                cmp #$3C
862	.b2cc		b0 15		bcs $b2e3	                bcs LB2E3
863	.b2ce		e6 00		inc $00		                inc $00
864	.b2d0		e8		inx		                inx
865	.b2d1		e8		inx		                inx
866	.b2d2		e8		inx		                inx
867	.b2d3		e0 18		cpx #$18	                cpx #$18
868	.b2d5		90 d3		bcc $b2aa	                bcc LB2AA
869	.b2d7						LB2D7:
870	.b2d7		c9 40		cmp #$40	                cmp #$40
871	.b2d9		b0 1a		bcs $b2f5	                bcs LB2F5
872	.b2db		20 66 b1	jsr $b166	                jsr LB166
873	.b2de		90 f7		bcc $b2d7	                bcc LB2D7
874	.b2e0						LB2E0:
875	.b2e0		4c 89 b3	jmp $b389	                jmp LB389

877	.b2e3						LB2E3:
878	.b2e3		95 01		sta $01,x	                sta $01,x
879	.b2e5						LB2E5:
880	.b2e5		a5 00		lda $00		                lda $00
881	.b2e7		d0 c5		bne $b2ae	                bne LB2AE
882	.b2e9		e6 00		inc $00		                inc $00
883	.b2eb		80 c1		bra $b2ae	                bra LB2AE

885	.b2ed						LB2ED:
886	.b2ed		a9 01		lda #$01	                lda #$01
887	.b2ef		85 02		sta $02		                sta $02
888	.b2f1		64 01		stz $01		                stz $01
889	.b2f3		64 03		stz $03		                stz $03
890	.b2f5						LB2F5:
891	.b2f5		60		rts		                rts

893	.b2f6						LB2F6:
894	.b2f6		a9 03		lda #$03	                lda #$03
895	.b2f8		80 02		bra $b2fc	                bra LB2FC

897	.b2fa						LB2FA:
898	.b2fa		a9 00		lda #$00	                lda #$00
899	.b2fc						LB2FC:
900	.b2fc		da		phx		                phx
901	.b2fd		aa		tax		                tax
902	.b2fe		b5 01		lda $01,x	                lda $01,x
903	.b300		c9 01		cmp #$01	                cmp #$01
904	.b302		b5 03		lda $03,x	                lda $03,x
905	.b304		f0 01		beq $b307	                beq LB307
906	.b306		38		sec		                sec
907	.b307						LB307:
908	.b307		b5 02		lda $02,x	                lda $02,x
909	.b309		fa		plx		                plx
910	.b30a		29 ff		and #$ff	                and #$FF
911	.b30c		60		rts		                rts

913	.b30d						LB30D:
914	.b30d		68		pla		                pla
915	.b30e		85 28		sta $28		                sta $28
916	.b310		68		pla		                pla
917	.b311		85 29		sta $29		                sta $29
918	.b313		a5 01		lda $01		                lda $01
919	.b315		d0 21		bne $b338	                bne LB338
920	.b317		a5 02		lda $02		                lda $02
921	.b319		05 03		ora $03		                ora $03
922	.b31b		d0 02		bne $b31f	                bne LB31F
923	.b31d		e6 02		inc $02		                inc $02
924	.b31f						LB31F:
925	.b31f		a5 02		lda $02		                lda $02
926	.b321		d0 02		bne $b325	                bne LB325
927	.b323		c6 03		dec $03		                dec $03
928	.b325						LB325:
929	.b325		c6 02		dec $02		                dec $02
930	.b327		d0 04		bne $b32d	                bne LB32D
931	.b329		a5 03		lda $03		                lda $03
932	.b32b		f0 05		beq $b332	                beq LB332
933	.b32d						LB32D:
934	.b32d		20 32 b3	jsr $b332	                jsr LB332
935	.b330		80 ed		bra $b31f	                bra LB31F

937	.b332						LB332:
938	.b332		a5 29		lda $29		                lda $29
939	.b334		48		pha		                pha
940	.b335		a5 28		lda $28		                lda $28
941	.b337		48		pha		                pha
942	.b338						LB338:
943	.b338		60		rts		                rts

945	.b339						LB339:
946	.b339		c6 1e		dec $1e		                dec $1E
947	.b33b		d0 03		bne $b340	                bne LB340
948	.b33d		20 17 b0	jsr $b017	                jsr LB017
949	.b340						LB340:
950	.b340		a5 6f		lda $6f		                lda $6F
951	.b342		d0 04		bne $b348	                bne LB348
952	.b344		a5 21		lda $21		                lda $21
953	.b346		85 20		sta $20		                sta $20
954	.b348						LB348:
955	.b348		60		rts		                rts

957	.b349						LB349:
958	.b349		20 4e b3	jsr $b34e	                jsr LB34E
959	.b34c		80 fb		bra $b349	                bra LB349

961	.b34e						LB34E:
962	.b34e		20 39 b3	jsr $b339	                jsr LB339
963	.b351		20 70 b1	jsr $b170	                jsr LB170
964	.b354						LB354:
965	.b354		c9 20		cmp #$20	                cmp #$20
966	.b356		90 09		bcc $b361	                bcc LB361
967	.b358		4c 28 b7	jmp $b728	                jmp LB728

969	.b35b						LB35B:
970	.b35b		4c 6c b4	jmp $b46c	                jmp LB46C

972	.b35e						LB35E:
973	.b35e		4c 93 b4	jmp $b493	                jmp LB493

975	.b361						LB361:
976	.b361		48		pha		                pha
977	.b362		20 ed b2	jsr $b2ed	                jsr LB2ED
978	.b365		68		pla		                pla
979	.b366		c9 07		cmp #$07	                cmp #$07
980	.b368		90 51		bcc $b3bb	                bcc LB3BB
981	.b36a		f0 7d		beq $b3e9	                beq LB3E9
982	.b36c		c9 09		cmp #$09	                cmp #$09
983	.b36e		90 eb		bcc $b35b	                bcc LB35B
984	.b370		f0 ec		beq $b35e	                beq LB35E
985	.b372		c9 0b		cmp #$0b	                cmp #$0B
986	.b374		90 78		bcc $b3ee	                bcc LB3EE
987	.b376		c9 0d		cmp #$0d	                cmp #$0D
988	.b378		f0 6f		beq $b3e9	                beq LB3E9
989	.b37a		c9 1b		cmp #$1b	                cmp #$1B
990	.b37c		d0 3d		bne $b3bb	                bne LB3BB
991	.b37e						LB37E:
992	.b37e		a6 6f		ldx $6f		                ldx $6F
993	.b380		d0 04		bne $b386	                bne LB386
994	.b382		24 2d		bit $2d		                bit $2D
995	.b384		30 35		bmi $b3bb	                bmi LB3BB
996	.b386						LB386:
997	.b386		20 66 b1	jsr $b166	                jsr LB166
998	.b389						LB389:
999	.b389		c9 1b		cmp #$1b	                cmp #$1B
1000	.b38b		f0 f1		beq $b37e	                beq LB37E
1001	.b38d		c9 25		cmp #$25	                cmp #$25
1002	.b38f		f0 70		beq $b401	                beq LB401
1003	.b391		c9 28		cmp #$28	                cmp #$28
1004	.b393		f0 6f		beq $b404	                beq LB404
1005	.b395		c9 44		cmp #$44	                cmp #$44
1006	.b397		f0 55		beq $b3ee	                beq LB3EE
1007	.b399		c9 45		cmp #$45	                cmp #$45
1008	.b39b		f0 4e		beq $b3eb	                beq LB3EB
1009	.b39d		c9 4d		cmp #$4d	                cmp #$4D
1010	.b39f		f0 46		beq $b3e7	                beq LB3E7
1011	.b3a1		c9 50		cmp #$50	                cmp #$50
1012	.b3a3		f0 20		beq $b3c5	                beq LB3C5
1013	.b3a5		c9 5b		cmp #$5b	                cmp #$5B
1014	.b3a7		f0 5e		beq $b407	                beq LB407
1015	.b3a9		c9 5d		cmp #$5d	                cmp #$5D
1016	.b3ab		64 2b		stz $2b		                stz $2B
1017	.b3ad		f0 47		beq $b3f6	                beq LB3F6
1018	.b3af		c9 5e		cmp #$5e	                cmp #$5E
1019	.b3b1		f0 40		beq $b3f3	                beq LB3F3
1020	.b3b3		c9 5f		cmp #$5f	                cmp #$5F
1021	.b3b5		f0 05		beq $b3bc	                beq LB3BC
1022	.b3b7		c9 63		cmp #$63	                cmp #$63
1023	.b3b9		f0 43		beq $b3fe	                beq LB3FE
1024	.b3bb						LB3BB:
1025	.b3bb		60		rts		                rts

1027	.b3bc						LB3BC:
1028	.b3bc		20 47 b2	jsr $b247	                jsr LB247
1029	.b3bf		b0 c8		bcs $b389	                bcs LB389
1030	.b3c1						LB3C1:
1031	.b3c1		38		sec		                sec
1032	.b3c2		6c 32 02	jmp ($0232)	                jmp (IND2V)

1034	.b3c5						LB3C5:
1035	.b3c5		38		sec		                sec
1036	.b3c6		66 2b		ror $2b		                ror $2B
1037	.b3c8		20 47 b2	jsr $b247	                jsr LB247
1038	.b3cb		b0 bc		bcs $b389	                bcs LB389
1039	.b3cd		a6 1f		ldx $1f		                ldx $1F
1040	.b3cf		64 1f		stz $1f		                stz $1F
1041	.b3d1		f0 11		beq $b3e4	                beq LB3E4
1042	.b3d3		a0 00		ldy #$00	                ldy #$00
1043	.b3d5		20 9e b8	jsr $b89e	                jsr LB89E
1044	.b3d8		f0 e1		beq $b3bb	                beq LB3BB
1045	.b3da		86 6f		stx $6f		                stx $6F
1046	.b3dc		c9 2a		cmp #$2a	                cmp #$2A
1047	.b3de		f0 1b		beq $b3fb	                beq LB3FB
1048	.b3e0		c9 21		cmp #$21	                cmp #$21
1049	.b3e2		f0 dd		beq $b3c1	                beq LB3C1
1050	.b3e4						LB3E4:
1051	.b3e4		4c f2 b4	jmp $b4f2	                jmp LB4F2

1053	.b3e7						LB3E7:
1054	.b3e7		a9 0b		lda #$0b	                lda #$0B
1055	.b3e9						LB3E9:
1056	.b3e9		80 05		bra $b3f0	                bra LB3F0

1058	.b3eb						LB3EB:
1059	.b3eb		4c e7 ff	jmp $ffe7	                jmp OSNEWL

1061	.b3ee						LB3EE:
1062	.b3ee		a9 0a		lda #$0a	                lda #$0A
1063	.b3f0						LB3F0:
1064	.b3f0		4c ee ff	jmp $ffee	                jmp OSWRCH

1066	.b3f3						LB3F3:
1067	.b3f3		38		sec		                sec
1068	.b3f4		66 2b		ror $2b		                ror $2B
1069	.b3f6						LB3F6:
1070	.b3f6		20 47 b2	jsr $b247	                jsr LB247
1071	.b3f9		b0 8e		bcs $b389	                bcs LB389
1072	.b3fb						LB3FB:
1073	.b3fb		4c 1f b6	jmp $b61f	                jmp LB61F

1075	.b3fe						LB3FE:
1076	.b3fe		4c 7e af	jmp $af7e	                jmp LAF7E

1078	.b401						LB401:
1079	.b401		4c 40 b6	jmp $b640	                jmp LB640

1081	.b404						LB404:
1082	.b404		4c 8b b6	jmp $b68b	                jmp LB68B

1084	.b407						LB407:
1085	.b407		20 a3 b2	jsr $b2a3	                jsr LB2A3
1086	.b40a		a2 0e		ldx #$0e	                ldx #$0E
1087	.b40c						LB40C:
1088	.b40c		dd 1d b4	cmp $b41d,x	                cmp LB41E-1,x
1089	.b40f		f0 07		beq $b418	                beq LB418
1090	.b411		ca		dex		                dex
1091	.b412		d0 f8		bne $b40c	                bne LB40C
1092	.b414		38		sec		                sec
1093	.b415		6c 30 02	jmp ($0230)	                jmp (IND1V)

1095	.b418						LB418:
1096	.b418		8a		txa		                txa
1097	.b419		0a		asl a		                asl a
1098	.b41a		aa		tax		                tax
1099	.b41b		7c 2a b4	jmp ($b42a,x)	                jmp (LB42C-2,x)
1100	.b41e						LB41E:
1101	>b41e		41 42				                .byte $41,$42
1102	>b420		43				                .byte $43
1103	>b421		44				                .byte $44
1104	>b422		48				                .byte $48
1105	>b423		4a				                .byte $4a
1106	>b424		4b				                .byte $4B
1107	>b425		53				                .byte $53
1108	>b426		58				                .byte $58
1109	>b427		68				                .byte $68
1110	>b428		6c				                .byte $6C
1111	>b429		6e				                .byte $6E
1112	>b42a		66				                .byte $66
1113	>b42b		63				                .byte $63
1114	.b42c						LB42C:
1115	>b42c		c5 b4				                .word LB4C5
1116	>b42e		85 b4				                .word LB485
1117	>b430		93 b4				                .word LB493
1118	>b432		6c b4				                .word LB46C
1119	>b434		a7 b4				                .word LB4A7
1120	>b436		fd b5				                .word LB5FD
1121	>b438		0d b6				                .word LB60D
1122	>b43a		20 b7				                .word LB720
1123	>b43c		e1 b5				                .word LB5E1
1124	>b43e		b1 b6				                .word LB6B1
1125	>b440		ad b6				                .word LB6AD
1126	>b442		a9 b5				                .word LB5A9
1127	>b444		a7 b4				                .word LB4A7
1128	>b446		d1 b4				                .word LB4D1
1129	.b448						LB448:
1130	.b448		20 4d b4	jsr $b44d	                jsr LB44D
1131	.b44b		80 fb		bra $b448	                bra LB448
1132	.b44d						LB44D:
1133	.b44d		20 39 b3	jsr $b339	                jsr LB339
1134	.b450		20 7a b1	jsr $b17a	                jsr LB17A
1135	.b453		c9 1b		cmp #$1b	                cmp #$1B
1136	.b455		d0 0f		bne $b466	                bne LB466
1137	.b457		a9 da		lda #$da	                lda #$DA
1138	.b459		a0 ff		ldy #$ff	                ldy #$FF
1139	.b45b		a2 00		ldx #$00	                ldx #$00
1140	.b45d		20 f4 ff	jsr $fff4	                jsr OSBYTE
1141	.b460		a9 1b		lda #$1b	                lda #$1B
1142	.b462		e0 00		cpx #$00	                cpx #$00
1143	.b464		f0 03		beq $b469	                beq LB469
1144	.b466						LB466:
1145	.b466		4c ee ff	jmp $ffee	                jmp OSWRCH

1147	.b469						LB469:
1148	.b469		4c 7e b3	jmp $b37e	                jmp LB37E

1150	.b46c						LB46C:
1151	.b46c		a9 08		lda #$08	                lda #$08
1152	.b46e		85 2c		sta $2c		                sta $2C
1153	.b470		20 0d b3	jsr $b30d	                jsr LB30D
1154	.b473		20 21 b8	jsr $b821	                jsr LB821
1155	.b476		8a		txa		                txa
1156	.b477		d0 07		bne $b480	                bne LB480
1157	.b479		24 34		bit $34		                bit $34
1158	.b47b		10 65		bpl $b4e2	                bpl LB4E2
1159	.b47d						LB47D:
1160	.b47d		98		tya		                tya
1161	.b47e						LB47E:
1162	.b47e		f0 62		beq $b4e2	                beq LB4E2
1163	.b480						LB480:
1164	.b480		a5 2c		lda $2c		                lda $2C
1165	.b482						LB482:
1166	.b482		4c ee ff	jmp $ffee	                jmp OSWRCH

1168	.b485						LB485:
1169	.b485		a9 0a		lda #$0a	                lda #$0A
1170	.b487		85 2c		sta $2c		                sta $2C
1171	.b489		20 0d b3	jsr $b30d	                jsr LB30D
1172	.b48c		20 21 b8	jsr $b821	                jsr LB821
1173	.b48f						LB48F:
1174	.b48f		c4 39		cpy $39		                cpy zterm.numRowsMinusOne
1175	.b491		80 eb		bra $b47e	                bra LB47E

1177	.b493						LB493:
1178	.b493		a9 09		lda #$09	                lda #$09
1179	.b495		85 2c		sta $2c		                sta $2C
1180	.b497		20 0d b3	jsr $b30d	                jsr LB30D
1181	.b49a		20 21 b8	jsr $b821	                jsr LB821
1182	.b49d		e4 37		cpx $37		                cpx zterm.numColumnsMinusOne
1183	.b49f						LB49F:
1184	.b49f		90 df		bcc $b480	                bcc LB480
1185	.b4a1		a5 34		lda $34		                lda $34
1186	.b4a3		f0 3d		beq $b4e2	                beq LB4E2
1187	.b4a5		80 e8		bra $b48f	                bra LB48F

1189	.b4a7						LB4A7:
1190	.b4a7		20 fa b2	jsr $b2fa	                jsr LB2FA
1191	.b4aa		b0 36		bcs $b4e2	                bcs LB4E2
1192	.b4ac		a8		tay		                tay
1193	.b4ad		f0 01		beq $b4b0	                beq LB4B0
1194	.b4af		88		dey		                dey
1195	.b4b0						LB4B0:
1196	.b4b0		20 f6 b2	jsr $b2f6	                jsr LB2F6
1197	.b4b3		b0 2d		bcs $b4e2	                bcs LB4E2
1198	.b4b5		aa		tax		                tax
1199	.b4b6		f0 01		beq $b4b9	                beq LB4B9
1200	.b4b8		ca		dex		                dex
1201	.b4b9						LB4B9:
1202	.b4b9		a9 1f		lda #$1f	                lda #$1F
1203	.b4bb		20 ee ff	jsr $ffee	                jsr OSWRCH
1204	.b4be		8a		txa		                txa
1205	.b4bf		20 ee ff	jsr $ffee	                jsr OSWRCH
1206	.b4c2		98		tya		                tya
1207	.b4c3		80 bd		bra $b482	                bra LB482

1209	.b4c5						LB4C5:
1210	.b4c5		a9 0b		lda #$0b	                lda #$0B
1211	.b4c7		85 2c		sta $2c		                sta $2C
1212	.b4c9		20 0d b3	jsr $b30d	                jsr LB30D
1213	.b4cc		20 21 b8	jsr $b821	                jsr LB821
1214	.b4cf		80 ac		bra $b47d	                bra LB47D

1216	.b4d1						LB4D1:
1217	.b4d1		20 fa b2	jsr $b2fa	                jsr LB2FA
1218	.b4d4		d0 0c		bne $b4e2	                bne LB4E2
1219	.b4d6		a8		tay		                tay
1220	.b4d7						LB4D7:
1221	.b4d7		a9 1b		lda #$1b	                lda #$1B
1222	.b4d9						LB4D9:
1223	.b4d9		c8		iny		                iny
1224	.b4da		20 83 b0	jsr $b083	                jsr LB083
1225	.b4dd		b9 e2 b4	lda $b4e2,y	                lda LB4E2,y
1226	.b4e0		d0 f7		bne $b4d9	                bne LB4D9
1227	.b4e2						LB4E2:
1228	.b4e2		60		rts		                rts

1230	>b4e3		5b				                .byte $5B
1231	>b4e4		3e 35 63			                .byte $3e,$35,$63
1232	>b4e7		00				                .byte $00
1233	>b4e8		5b				                .byte $5B
1234	>b4e9		30 6e				                .byte $30,$6e
1235	>b4eb		00				                .byte $00
1236	>b4ec		5b				                .byte $5B
1237	>b4ed		33				                .byte $33
1238	>b4ee		6e 00 5b			                .byte $6e,$00,$5b
1239	>b4f1		00				                .byte $00
1240	.b4f2						LB4F2:
1241	.b4f2		20 30 b8	jsr $b830	                jsr LB830
1242	.b4f5		b0 50		bcs $b547	                bcs LB547
1243	.b4f7		c9 07		cmp #$07	                cmp #$07
1244	.b4f9		b0 1d		bcs $b518	                bcs LB518
1245	.b4fb		48		pha		                pha
1246	.b4fc		20 32 b8	jsr $b832	                jsr LB832
1247	.b4ff		64 2e		stz $2e		                stz $2E
1248	.b501		c9 0a		cmp #$0a	                cmp #$0A
1249	.b503		f0 06		beq $b50b	                beq LB50B
1250	.b505		c6 2e		dec $2e		                dec $2E
1251	.b507		c9 09		cmp #$09	                cmp #$09
1252	.b509		d0 3b		bne $b546	                bne LB546
1253	.b50b						LB50B:
1254	.b50b		7a		ply		                ply
1255	.b50c		c0 06		cpy #$06	                cpy #$06
1256	.b50e		d0 05		bne $b515	                bne LB515
1257	.b510		a5 2e		lda $2e		                lda $2E
1258	.b512		85 34		sta $34		                sta $34
1259	.b514						LB514:
1260	.b514		60		rts		                rts

1262	.b515						LB515:
1263	.b515		4c e0 b6	jmp $b6e0	                jmp LB6E0

1265	.b518						LB518:
1266	.b518		c9 08		cmp #$08	                cmp #$08
1267	.b51a		f0 1e		beq $b53a	                beq LB53A
1268	.b51c		b0 2c		bcs $b54a	                bcs LB54A
1269	.b51e						LB51E:
1270	.b51e		20 9e b8	jsr $b89e	                jsr LB89E
1271	.b521		f0 f1		beq $b514	                beq LB514
1272	.b523		20 65 b5	jsr $b565	                jsr LB565
1273	.b526		20 9e b8	jsr $b89e	                jsr LB89E
1274	.b529		f0 0a		beq $b535	                beq LB535
1275	.b52b		c9 2c		cmp #$2c	                cmp #$2C
1276	.b52d		d0 18		bne $b547	                bne LB547
1277	.b52f		c8		iny		                iny
1278	.b530		20 35 b5	jsr $b535	                jsr LB535
1279	.b533		80 e9		bra $b51e	                bra LB51E

1281	.b535						LB535:
1282	.b535		a5 3a		lda $3a		                lda $3A
1283	.b537		4c ee ff	jmp $ffee	                jmp OSWRCH

1285	.b53a						LB53A:
1286	.b53a		20 9e b8	jsr $b89e	                jsr LB89E
1287	.b53d		20 65 b5	jsr $b565	                jsr LB565
1288	.b540		b0 05		bcs $b547	                bcs LB547
1289	.b542		a5 3a		lda $3a		                lda $3A
1290	.b544		80 33		bra $b579	                bra reinitDisplayMode

1292	.b546						LB546:
1293	.b546		68		pla		                pla
1294	.b547						LB547:
1295	.b547		4c b3 b7	jmp $b7b3	                jmp LB7B3

1297	.b54a						LB54A:
1298	.b54a		a0 00		ldy #$00	                ldy #$00
1299	.b54c		c9 0b		cmp #$0b	                cmp #$0B
1300	.b54e		90 f7		bcc $b547	                bcc LB547
1301	.b550		f0 0f		beq $b561	                beq LB561
1302	.b552		c8		iny		                iny
1303	.b553		c9 0e		cmp #$0e	                cmp #$0E
1304	.b555		f0 0a		beq $b561	                beq LB561
1305	.b557		b0 ee		bcs $b547	                bcs LB547
1306	.b559		a0 04		ldy #$04	                ldy #$04
1307	.b55b		c9 0c		cmp #$0c	                cmp #$0C
1308	.b55d		f0 02		beq $b561	                beq LB561
1309	.b55f		a0 05		ldy #$05	                ldy #$05
1310	.b561						LB561:
1311	.b561		98		tya		                tya
1312	.b562		4c 4f b6	jmp $b64f	                jmp LB64F

1314	.b565						LB565:
1315	.b565		20 a9 b8	jsr $b8a9	                jsr LB8A9
1316	.b568		b0 09		bcs $b573	                bcs LB573
1317	.b56a						LB56A:
1318	.b56a		c8		iny		                iny
1319	.b56b		b1 f2		lda ($f2),y	                lda ($F2),y
1320	.b56d		20 ad b8	jsr $b8ad	                jsr LB8AD
1321	.b570		90 f8		bcc $b56a	                bcc LB56A
1322	.b572		18		clc		                clc
1323	.b573						LB573:
1324	.b573		60		rts		                rts

1326	.b574		20 fa b2	jsr $b2fa	                jsr LB2FA
1327	.b577		b0 ce		bcs $b547	                bcs LB547
1328	.b579						reinitDisplayMode:
1329	.b579		a8		tay		                tay              ;Y = screen mode
1330	.b57a		29 7f		and #$7f	                and #$7F         ;mask off shadow bit (unnecessarily!)
1331	.b57c		c9 08		cmp #$08	                cmp #$08
1332	.b57e		b0 c7		bcs $b547	                bcs LB547                    ;branch taken if mode>=8
1333	.b580		aa		tax		                tax                          ;X = mode number
1334	.b581		bd a1 b5	lda $b5a1,x	                lda screenDimensionsForMode,x                  ;
1335	.b584		4a		lsr a		                lsr a       ;A = width -1; C = height flag (1=32 rows,
1336							                            ;0=25 rows)
1337	.b585		a2 1f		ldx #$1f	                ldx #$1F                     ;assume 32 rows
1338	.b587		b0 02		bcs $b58b	                bcs +                        ;taken if 32 rows
1339	.b589		a2 18		ldx #$18	                ldx #$18                     ;25 rows
1340	.b58b						+
1341	.b58b		86 39		stx $39		                stx zterm.numRowsMinusOne    ;store rows
1342	.b58d		85 37		sta $37		                sta zterm.numColumnsMinusOne ;store columns
1343	.b58f		1a		inc a		                inc a                        ;compute column count
1344	.b590		85 38		sta $38		                sta zterm.numColumns

1346							                ; re-select mode
1347	.b592		a9 16		lda #$16	                lda #22
1348	.b594		20 ee ff	jsr $ffee	                jsr OSWRCH
1349	.b597		98		tya		                tya
1350	.b598		20 ee ff	jsr $ffee	                jsr OSWRCH

1352	.b59b		0a		asl a		                asl a
1353	.b59c		c9 0e		cmp #$0e	                cmp #$0E                     ;C=1 if Mode 7
1354	.b59e		66 30		ror $30		                ror $30                      ;?$30 bit 7 set if Mode 7
1355	.b5a0		60		rts		                rts

1357	.b5a1						screenDimensionsForMode:
1358	>b5a1		9f				                .byte 79<<1|1 ;mode 0 - 80 columns, 32 rows
1359	>b5a2		4f				                .byte 39<<1|1 ;mode 1 - 40 columns, 32 rows
1360	>b5a3		27				                .byte 19<<1|1 ;mode 2 - 20 columns, 32 rows
1361	>b5a4		9e				                .byte 79<<1|0 ;mode 3 - 80 columns, 25 rows
1362	>b5a5		4f				                .byte 39<<1|1 ;mode 4 - 40 columns, 32 rows
1363	>b5a6		27				                .byte 19<<1|1 ;mode 5 - 20 columns, 32 rows
1364	>b5a7		4e				                .byte 39<<1|0 ;mode 6 - 40 columns, 25 rows
1365	>b5a8		4e				                .byte 39<<1|0 ;mode 7 - 40 columns, 25 rows

1367	.b5a9						LB5A9:
1368	.b5a9		20 fa b2	jsr $b2fa	                jsr LB2FA
1369	.b5ac		b0 58		bcs $b606	                bcs LB606
1370	.b5ae		c9 05		cmp #$05	                cmp #$05
1371	.b5b0		f0 22		beq $b5d4	                beq LB5D4
1372	.b5b2		c9 06		cmp #$06	                cmp #$06
1373	.b5b4						LB5B4:
1374	.b5b4		d0 50		bne $b606	                bne LB606
1375	.b5b6		20 21 b8	jsr $b821	                jsr LB821
1376	.b5b9		e8		inx		                inx
1377	.b5ba		da		phx		                phx
1378	.b5bb		c8		iny		                iny
1379	.b5bc		5a		phy		                phy
1380	.b5bd		a0 0d		ldy #$0d	                ldy #$0D
1381	.b5bf		20 d7 b4	jsr $b4d7	                jsr LB4D7
1382	.b5c2		68		pla		                pla
1383	.b5c3		20 6e b0	jsr $b06e	                jsr LB06E
1384	.b5c6		a9 3b		lda #$3b	                lda #$3B
1385	.b5c8		20 83 b0	jsr $b083	                jsr LB083
1386	.b5cb		68		pla		                pla
1387	.b5cc		20 6e b0	jsr $b06e	                jsr LB06E
1388	.b5cf		a9 52		lda #$52	                lda #$52
1389	.b5d1		4c 83 b0	jmp $b083	                jmp LB083

1391	.b5d4						LB5D4:
1392	.b5d4		a0 05		ldy #$05	                ldy #$05
1393	.b5d6		24 19		bit $19		                bit $19
1394	.b5d8		64 19		stz $19		                stz $19
1395	.b5da		10 02		bpl $b5de	                bpl LB5DE
1396	.b5dc		a0 09		ldy #$09	                ldy #$09
1397	.b5de						LB5DE:
1398	.b5de		4c d7 b4	jmp $b4d7	                jmp LB4D7

1400	.b5e1						LB5E1:
1401	.b5e1		20 21 b8	jsr $b821	                jsr LB821
1402	.b5e4		da		phx		                phx
1403	.b5e5		5a		phy		                phy
1404	.b5e6		a9 20		lda #$20	                lda #$20
1405	.b5e8		85 2c		sta $2c		                sta $2C
1406	.b5ea		20 f2 b5	jsr $b5f2	                jsr LB5F2
1407	.b5ed		7a		ply		                ply
1408	.b5ee		fa		plx		                plx
1409	.b5ef		4c b9 b4	jmp $b4b9	                jmp LB4B9

1411	.b5f2						LB5F2:
1412	.b5f2		20 0d b3	jsr $b30d	                jsr LB30D
1413	.b5f5		20 21 b8	jsr $b821	                jsr LB821
1414	.b5f8		e4 38		cpx $38		                cpx zterm.numColumns
1415	.b5fa		4c 9f b4	jmp $b49f	                jmp LB49F

1417	.b5fd						LB5FD:
1418	.b5fd		20 fa b2	jsr $b2fa	                jsr LB2FA
1419	.b600		b0 04		bcs $b606	                bcs LB606
1420	.b602		c9 03		cmp #$03	                cmp #$03
1421	.b604		90 12		bcc $b618	                bcc LB618
1422	.b606						LB606:
1423	.b606		60		rts		                rts

1425	.b607						LB607:
1426	>b607		0f				                .byte $0F
1427	>b608		13				                .byte $13
1428	.b609		1a		inc a		                inc a
1429	.b60a		00		brk #		                brk
1430	.b60b		04 0b		tsb $0b		                tsb $0B
1431	.b60d						LB60D:
1432	.b60d		20 fa b2	jsr $b2fa	                jsr LB2FA
1433	.b610		b0 f4		bcs $b606	                bcs LB606
1434	.b612		c9 03		cmp #$03	                cmp #$03
1435	.b614		b0 f0		bcs $b606	                bcs LB606
1436	.b616		69 03		adc #$03	                adc #$03
1437	.b618						LB618:
1438	.b618		aa		tax		                tax
1439	.b619		bd 07 b6	lda $b607,x	                lda LB607,x
1440	.b61c		4c e6 b7	jmp $b7e6	                jmp LB7E6

1442	.b61f						LB61F:
1443	.b61f		a5 20		lda $20		                lda $20
1444	.b621		25 36		and $36		                and $36
1445	.b623		10 03		bpl $b628	                bpl LB628
1446	.b625		4c b3 b7	jmp $b7b3	                jmp LB7B3

1448	.b628						LB628:
1449	.b628		a9 e5		lda #$e5	                lda #$E5
1450	.b62a		20 23 b8	jsr $b823	                jsr osbyteX00Y00
1451	.b62d		a2 00		ldx #$00	                ldx #$00
1452	.b62f		a0 05		ldy #$05	                ldy #$05
1453	.b631		20 f7 ff	jsr $fff7	                jsr OSCLI
1454	.b634						disableESCAPE:
1455	.b634		a9 e5		lda #$e5	                lda #$E5
1456	.b636		a2 01		ldx #$01	                ldx #$01
1457	.b638		20 25 b8	jsr $b825	                jsr osbyteY00                ;disable ESCAPE key
1458	.b63b		a9 7e		lda #$7e	                lda #$7E
1459	.b63d		4c f4 ff	jmp $fff4	                jmp OSBYTE                   ;acknowledge ESCAPE

1461	.b640						LB640:
1462	.b640		20 c6 b1	jsr $b1c6	                jsr LB1C6
1463	.b643		c9 07		cmp #$07	                cmp #$07
1464	.b645		90 08		bcc $b64f	                bcc LB64F
1465	.b647		d0 bd		bne $b606	                bne LB606
1466	.b649		20 66 b1	jsr $b166	                jsr LB166
1467	.b64c		4c 54 b3	jmp $b354	                jmp LB354

1469	.b64f						LB64F:
1470	.b64f		85 2a		sta $2a		                sta $2A
1471	.b651		64 25		stz $25		                stz $25
1472	.b653		64 23		stz $23		                stz $23
1473	.b655		a2 fe		ldx #$fe	                ldx #$FE
1474	.b657		9a		txs		                txs
1475	.b658		e8		inx		                inx
1476	.b659		86 22		stx $22		                stx $22
1477	.b65b		a5 2a		lda $2a		                lda $2A
1478	.b65d		c9 06		cmp #$06	                cmp #$06
1479	.b65f		90 04		bcc $b665	                bcc LB665
1480	.b661		66 23		ror $23		                ror $23
1481	.b663		80 08		bra $b66d	                bra LB66D

1483	.b665						LB665:
1484	.b665		c9 04		cmp #$04	                cmp #$04
1485	.b667		90 12		bcc $b67b	                bcc LB67B
1486	.b669		f0 06		beq $b671	                beq LB671
1487	.b66b		66 25		ror $25		                ror $25
1488	.b66d						LB66D:
1489	.b66d		64 27		stz $27		                stz $27
1490	.b66f		46 22		lsr $22		                lsr $22
1491	.b671						LB671:
1492	.b671		66 30		ror $30		                ror $30
1493	.b673		a9 21		lda #$21	                lda #$21
1494	.b675		20 e6 b7	jsr $b7e6	                jsr LB7E6
1495	.b678		4c 48 b4	jmp $b448	                jmp LB448

1497	.b67b						LB67B:
1498	.b67b		64 30		stz $30		                stz $30
1499	.b67d		4a		lsr a		                lsr a
1500	.b67e		66 2d		ror $2d		                ror $2D
1501	.b680		4a		lsr a		                lsr a
1502	.b681		66 22		ror $22		                ror $22
1503	.b683		a9 1e		lda #$1e	                lda #$1E
1504	.b685		20 e6 b7	jsr $b7e6	                jsr LB7E6
1505	.b688		4c 49 b3	jmp $b349	                jmp LB349

1507	.b68b						LB68B:
1508	.b68b		20 c6 b1	jsr $b1c6	                jsr LB1C6
1509	.b68e		90 0b		bcc $b69b	                bcc LB69B
1510	.b690						LB690:
1511	.b690		4a		lsr a		                lsr a
1512	.b691		29 04		and #$04	                and #$04
1513	.b693		d0 07		bne $b69c	                bne LB69C
1514	.b695		6a		ror a		                ror a
1515	.b696		4a		lsr a		                lsr a
1516	.b697		69 40		adc #$40	                adc #$40
1517	.b699		85 33		sta $33		                sta $33
1518	.b69b						LB69B:
1519	.b69b		60		rts		                rts

1521	.b69c						LB69C:
1522	.b69c		64 33		stz $33		                stz $33
1523	.b69e		a2 60		ldx #$60	                ldx #$60
1524	.b6a0		a0 23		ldy #$23	                ldy #$23
1525	.b6a2		90 04		bcc $b6a8	                bcc LB6A8
1526	.b6a4		da		phx		                phx
1527	.b6a5		5a		phy		                phy
1528	.b6a6		fa		plx		                plx
1529	.b6a7		7a		ply		                ply
1530	.b6a8						LB6A8:
1531	.b6a8		86 31		stx $31		                stx $31
1532	.b6aa		84 32		sty $32		                sty $32
1533	.b6ac		60		rts		                rts

1535	.b6ad						LB6AD:
1536	.b6ad		a9 00		lda #$00	                lda #$00
1537	.b6af		80 02		bra $b6b3	                bra LB6B3

1539	.b6b1						LB6B1:
1540	.b6b1		a9 ff		lda #$ff	                lda #$FF
1541	.b6b3						LB6B3:
1542	.b6b3		85 2e		sta $2e		                sta $2E
1543	.b6b5		64 2f		stz $2f		                stz $2F
1544	.b6b7						LB6B7:
1545	.b6b7		a6 2f		ldx $2f		                ldx $2F
1546	.b6b9		e8		inx		                inx
1547	.b6ba		e8		inx		                inx
1548	.b6bb		e8		inx		                inx
1549	.b6bc		e0 1b		cpx #$1b	                cpx #$1B
1550	.b6be		f0 1f		beq $b6df	                beq LB6DF
1551	.b6c0		86 2f		stx $2f		                stx $2F
1552	.b6c2		20 c7 b6	jsr $b6c7	                jsr LB6C7
1553	.b6c5		80 f0		bra $b6b7	                bra LB6B7

1555	.b6c7						LB6C7:
1556	.b6c7		bc ff ff	ldy $ffff,x	                ldy $FFFF,x
1557	.b6ca		b5 00		lda $00,x	                lda $00,x
1558	.b6cc		d0 11		bne $b6df	                bne LB6DF
1559	.b6ce		bd fe ff	lda $fffe,x	                lda LFFFE,x
1560	.b6d1		c9 3e		cmp #$3e	                cmp #$3E
1561	.b6d3		90 0a		bcc $b6df	                bcc LB6DF
1562	.b6d5		f0 09		beq $b6e0	                beq LB6E0
1563	.b6d7		a5 2e		lda $2e		                lda $2E
1564	.b6d9		c0 07		cpy #$07	                cpy #$07
1565	.b6db		d0 02		bne $b6df	                bne LB6DF
1566	.b6dd		85 34		sta $34		                sta $34
1567	.b6df						LB6DF:
1568	.b6df		60		rts		                rts

1570	.b6e0						LB6E0:
1571	.b6e0		a5 2e		lda $2e		                lda $2E
1572	.b6e2		c0 01		cpy #$01	                cpy #$01
1573	.b6e4		b0 07		bcs $b6ed	                bcs LB6ED
1574	.b6e6		1a		inc a		                inc a
1575	.b6e7		0a		asl a		                asl a
1576	.b6e8		aa		tax		                tax
1577	.b6e9		a9 04		lda #$04	                lda #$04
1578	.b6eb		80 09		bra $b6f6	                bra LB6F6

1580	.b6ed						LB6ED:
1581	.b6ed		d0 0a		bne $b6f9	                bne LB6F9
1582	.b6ef		aa		tax		                tax
1583	.b6f0		f0 02		beq $b6f4	                beq LB6F4
1584	.b6f2		a2 21		ldx #$21	                ldx #$21
1585	.b6f4						LB6F4:
1586	.b6f4		a9 cb		lda #$cb	                lda #$CB
1587	.b6f6						LB6F6:
1588	.b6f6		4c 25 b8	jmp $b825	                jmp osbyteY00

1590	.b6f9						LB6F9:
1591	.b6f9		c0 03		cpy #$03	                cpy #$03
1592	.b6fb		b0 0a		bcs $b707	                bcs LB707
1593	.b6fd		24 20		bit $20		                bit $20
1594	.b6ff		10 03		bpl $b704	                bpl LB704
1595	.b701		a8		tay		                tay
1596	.b702		f0 db		beq $b6df	                beq LB6DF
1597	.b704						LB704:
1598	.b704		85 36		sta $36		                sta $36
1599	.b706						LB706:
1600	.b706		60		rts		                rts

1602	.b707						LB707:
1603	.b707		d0 09		bne $b712	                bne LB712
1604	.b709		2a		rol a		                rol a
1605	.b70a		a9 00		lda #$00	                lda #$00
1606	.b70c						LB70C:
1607	.b70c		2a		rol a		                rol a
1608	.b70d		aa		tax		                tax
1609	.b70e		a9 60		lda #$60	                lda #$60
1610	.b710		80 e4		bra $b6f6	                bra LB6F6

1612	.b712						LB712:
1613	.b712		c0 05		cpy #$05	                cpy #$05
1614	.b714		b0 05		bcs $b71b	                bcs LB71B
1615	.b716		2a		rol a		                rol a
1616	.b717		a9 01		lda #$01	                lda #$01
1617	.b719		80 f1		bra $b70c	                bra LB70C

1619	.b71b						LB71B:
1620	.b71b		d0 e9		bne $b706	                bne LB706
1621	.b71d		85 35		sta $35		                sta $35
1622	.b71f		60		rts		                rts

1624	.b720						LB720:
1625	.b720		20 0d b3	jsr $b30d	                jsr LB30D
1626	.b723		a9 23		lda #$23	                lda #$23
1627	.b725		4c e6 b7	jmp $b7e6	                jmp LB7E6

1629	.b728						LB728:
1630	.b728		5a		phy		                phy
1631	.b729		da		phx		                phx
1632	.b72a		48		pha		                pha
1633	.b72b		24 30		bit $30		                bit $30
1634	.b72d		30 1d		bmi $b74c	                bmi LB74C
1635	.b72f		c9 40		cmp #$40	                cmp #$40
1636	.b731		90 06		bcc $b739	                bcc LB739
1637	.b733		a8		tay		                tay
1638	.b734		30 03		bmi $b739	                bmi LB739
1639	.b736		18		clc		                clc
1640	.b737		65 33		adc $33		                adc $33
1641	.b739						LB739:
1642	.b739		a8		tay		                tay
1643	.b73a		c0 60		cpy #$60	                cpy #$60
1644	.b73c		d0 02		bne $b740	                bne LB740
1645	.b73e		a9 bb		lda #$bb	                lda #$BB
1646	.b740						LB740:
1647	.b740		c0 bb		cpy #$bb	                cpy #$BB
1648	.b742		d0 02		bne $b746	                bne LB746
1649	.b744		a5 32		lda $32		                lda $32
1650	.b746						LB746:
1651	.b746		c0 23		cpy #$23	                cpy #$23
1652	.b748		d0 02		bne $b74c	                bne LB74C
1653	.b74a		a5 31		lda $31		                lda $31
1654	.b74c						LB74C:
1655	.b74c		48		pha		                pha
1656	.b74d		20 21 b8	jsr $b821	                jsr LB821
1657	.b750		e4 38		cpx $38		                cpx zterm.numColumns
1658	.b752		f0 0a		beq $b75e	                beq LB75E
1659	.b754						LB754:
1660	.b754		68		pla		                pla
1661	.b755		20 ee ff	jsr $ffee	                jsr OSWRCH
1662	.b758		48		pha		                pha
1663	.b759						LB759:
1664	.b759		68		pla		                pla
1665	.b75a		68		pla		                pla
1666	.b75b		fa		plx		                plx
1667	.b75c		7a		ply		                ply
1668	.b75d		60		rts		                rts

1670	.b75e						LB75E:
1671	.b75e		24 34		bit $34		                bit $34
1672	.b760		10 f7		bpl $b759	                bpl LB759
1673	.b762		24 35		bit $35		                bit $35
1674	.b764		10 ee		bpl $b754	                bpl LB754
1675	.b766		68		pla		                pla
1676	.b767		48		pha		                pha
1677	.b768		c9 20		cmp #$20	                cmp #$20
1678	.b76a		90 e8		bcc $b754	                bcc LB754
1679	.b76c		d0 05		bne $b773	                bne LB773
1680	.b76e		20 e7 ff	jsr $ffe7	                jsr OSNEWL
1681	.b771		80 e6		bra $b759	                bra LB759

1683	.b773						LB773:
1684	.b773		a9 0d		lda #$0d	                lda #$0D
1685	.b775		20 ee ff	jsr $ffee	                jsr OSWRCH
1686	.b778		20 b9 b4	jsr $b4b9	                jsr LB4B9
1687	.b77b		a0 00		ldy #$00	                ldy #$00
1688	.b77d						LB77D:
1689	.b77d		5a		phy		                phy
1690	.b77e		a9 08		lda #$08	                lda #$08
1691	.b780		20 ee ff	jsr $ffee	                jsr OSWRCH
1692	.b783		a9 87		lda #$87	                lda #$87
1693	.b785		20 f4 ff	jsr $fff4	                jsr OSBYTE
1694	.b788		7a		ply		                ply
1695	.b789		8a		txa		                txa
1696	.b78a		c9 20		cmp #$20	                cmp #$20
1697	.b78c		f0 0d		beq $b79b	                beq LB79B
1698	.b78e		99 40 04	sta $0440,y	                sta $0440,y
1699	.b791		c8		iny		                iny
1700	.b792		c4 38		cpy $38		                cpy zterm.numColumns
1701	.b794		d0 e7		bne $b77d	                bne LB77D
1702	.b796		20 e7 ff	jsr $ffe7	                jsr OSNEWL
1703	.b799		80 b9		bra $b754	                bra LB754

1705	.b79b						LB79B:
1706	.b79b		5a		phy		                phy
1707	.b79c		a9 00		lda #$00	                lda #$00
1708	.b79e		20 e6 b7	jsr $b7e6	                jsr LB7E6
1709	.b7a1		20 e7 ff	jsr $ffe7	                jsr OSNEWL
1710	.b7a4		7a		ply		                ply
1711	.b7a5		c8		iny		                iny
1712	.b7a6						LB7A6:
1713	.b7a6		88		dey		                dey
1714	.b7a7		f0 ab		beq $b754	                beq LB754
1715	.b7a9		b9 3f 04	lda $043f,y	                lda $043F,y
1716	.b7ac		20 ee ff	jsr $ffee	                jsr OSWRCH
1717	.b7af		80 f5		bra $b7a6	                bra LB7A6

1719	.b7b1						terminalINDnHandler:
1720	.b7b1		90 46		bcc $b7f9	                bcc LB7F9
1721	.b7b3						LB7B3:
1722	.b7b3		38		sec		                sec
1723	.b7b4		66 19		ror $19		                ror $19
1724	.b7b6						LB7B6:
1725	.b7b6		a2 32		ldx #$32	                ldx #$32
1726	.b7b8						LB7B8:
1727	.b7b8		a9 d5		lda #$d5	                lda #$D5
1728	.b7ba		20 25 b8	jsr $b825	                jsr osbyteY00
1729	.b7bd		da		phx		                phx
1730	.b7be		a2 01		ldx #$01	                ldx #$01
1731	.b7c0		a9 d6		lda #$d6	                lda #$D6
1732	.b7c2		20 25 b8	jsr $b825	                jsr osbyteY00
1733	.b7c5		da		phx		                phx
1734	.b7c6		a9 ec		lda #$ec	                lda #$EC
1735	.b7c8		a2 14		ldx #$14	                ldx #$14
1736	.b7ca		20 25 b8	jsr $b825	                jsr osbyteY00
1737	.b7cd		a9 07		lda #$07	                lda #$07
1738	.b7cf		20 ee ff	jsr $ffee	                jsr OSWRCH
1739	.b7d2		a9 ec		lda #$ec	                lda #$EC
1740	.b7d4		20 25 b8	jsr $b825	                jsr osbyteY00
1741	.b7d7		fa		plx		                plx
1742	.b7d8		a9 d6		lda #$d6	                lda #$D6
1743	.b7da		20 25 b8	jsr $b825	                jsr osbyteY00
1744	.b7dd		fa		plx		                plx
1745	.b7de		a9 d5		lda #$d5	                lda #$D5
1746	.b7e0		80 43		bra $b825	                bra osbyteY00

1748	.b7e2						LB7E2:
1749	.b7e2		a2 8c		ldx #$8c	                ldx #$8C
1750	.b7e4		80 d2		bra $b7b8	                bra LB7B8

1752	.b7e6						LB7E6:
1753	.b7e6		a8		tay		                tay
1754	.b7e7		a2 0a		ldx #$0a	                ldx #$0A
1755	.b7e9		a9 97		lda #$97	                lda #$97
1756	.b7eb						LB7EB:
1757	.b7eb		0a		asl a		                asl a
1758	.b7ec		b0 01		bcs $b7ef	                bcs LB7EF
1759	.b7ee		c8		iny		                iny
1760	.b7ef						LB7EF:
1761	.b7ef		4a		lsr a		                lsr a
1762	.b7f0		20 ee ff	jsr $ffee	                jsr OSWRCH
1763	.b7f3		b9 fa b7	lda $b7fa,y	                lda LB7FA,y
1764	.b7f6		ca		dex		                dex
1765	.b7f7		d0 f2		bne $b7eb	                bne LB7EB
1766	.b7f9						LB7F9:
1767	.b7f9		60		rts		                rts

1769	.b7fa						LB7FA:
1770							                ; PHP
1771							                ; ORA $06
1772							                ; BRA LB807

1774							                ; TSB $05
1775							                ; BRK
1776							                ; BRK
1777							                ; ORA ($80,x)
1778							                ; PHP
1779							                ; TSB $06
1780							                ; BRA LB812

1782							                ; ORA $0A
1783							                ; BRA LB816

1785							                ; BRK
1786							                ; ORA $00
1787							                ; BRK
1788	>b7fa		08				                .byte $08
1789	>b7fb		05				                .byte $05
1790	>b7fc		06				                .byte $06
1791	>b7fd		80				                .byte $80
1792	>b7fe		08				                .byte $08
1793	>b7ff		04				                .byte $04
1794	>b800		05				                .byte $05
1795	>b801		00				                .byte $00
1796	>b802		00				                .byte $00
1797	>b803		01				                .byte $01
1798	>b804		80				                .byte $80
1799	>b805		08				                .byte $08
1800	>b806		04				                .byte $04
1801	>b807		06				                .byte $06
1802	>b808		80				                .byte $80
1803	>b809		08				                .byte $08
1804	>b80a		05				                .byte $05
1805	>b80b		0a				                .byte $0A
1806	>b80c		80				                .byte $80
1807	>b80d		08				                .byte $08
1808	>b80e		00				                .byte $00
1809	>b80f		05				                .byte $05
1810	>b810		00				                .byte $00
1811	>b811		00				                .byte $00

1813	.b812						LB812:
1814							;ORA (&80,x)      :\ B812= 01 80       ..
1815	>b812		01				                .byte $01
1816	>b813		80				                .byte $80
1817							;PHP              :\ B814= 08          .
1818	>b814		08				                .byte $08
1819							;BRK              :\ B815= 00          .
1820	>b815		00				                .byte $00
1821							;.LB816
1822							;ASL A            :\ B816= 0A          .
1823	>b816		0a				                .byte $0A
1824							;BRA LB829        :\ B817= 80 10       ..
1825	>b817		80				                .byte $80
1826	>b818		10				                .byte $10
1827							;ORA (&80,x)      :\ B819= 01 80       ..
1828	>b819		01				                .byte $01
1829	>b81a		80				                .byte $80
1830							;BPL LB79D        :\ B81B= 10 80       ..
1831	>b81b		10				                .byte $10
1832	>b81c		80				                .byte $80
1833	>b81d		07				                .byte $07
1834	>b81e		00				                .byte $00
1835	>b81f		03				                .byte $03
1836							;BRA LB7CB        :\ B820= 80 A9       .)
1837							; LDA &A2          :\ B822= A5 A2       %"
1838							; BRK              :\ B824= 00          .
1839	>b820		80				                .byte $80
1840	.b821						LB821:
1841	.b821		a9 a5		lda #$a5	                lda #$A5
1842	.b823						osbyteX00Y00:
1843	.b823		a2 00		ldx #$00	                ldx #$00
1844	.b825						osbyteY00:
1845	.b825		a0 00		ldy #$00	                ldy #$00
1846	.b827						-
1847	.b827		4c f4 ff	jmp $fff4	                jmp OSBYTE

1849	.b82a						LB82A:
1850	.b82a		a9 9c		lda #$9c	                lda #$9C
1851	.b82c		a0 9f		ldy #$9f	                ldy #$9F
1852	.b82e		80 f7		bra $b827	                bra -

1854	.b830						LB830:
1855	.b830		a0 00		ldy #$00	                ldy #$00
1856	.b832						LB832:
1857	.b832		a2 ff		ldx #$ff	                ldx #$FF
1858	.b834		da		phx		                phx
1859	.b835						LB835:
1860	.b835		68		pla		                pla
1861	.b836		1a		inc a		                inc a
1862	.b837		48		pha		                pha
1863	.b838		5a		phy		                phy
1864	.b839		20 9e b8	jsr $b89e	                jsr LB89E
1865	.b83c						LB83C:
1866	.b83c		c9 2e		cmp #$2e	                cmp #'.'
1867	.b83e		f0 18		beq $b858	                beq LB858
1868	.b840		c9 40		cmp #$40	                cmp #'@'
1869	.b842		b0 02		bcs $b846	                bcs LB846
1870	.b844		a9 00		lda #$00	                lda #$00
1871	.b846						LB846:
1872	.b846		29 5f		and #$5f	                and #$5F
1873	.b848		e8		inx		                inx
1874	.b849		5d 6b b8	eor $b86b,x	                eor LB86B,x
1875	.b84c		f0 05		beq $b853	                beq LB853
1876	.b84e		0a		asl a		                asl a
1877	.b84f		f0 07		beq $b858	                beq LB858
1878	.b851		80 0a		bra $b85d	                bra LB85D

1880	.b853						LB853:
1881	.b853		c8		iny		                iny
1882	.b854		b1 f2		lda ($f2),y	                lda ($F2),y
1883	.b856		80 e4		bra $b83c	                bra LB83C

1885	.b858						LB858:
1886	.b858		c8		iny		                iny
1887	.b859		68		pla		                pla
1888	.b85a		68		pla		                pla
1889	.b85b		18		clc		                clc
1890	.b85c		60		rts		                rts

1892	.b85d						LB85D:
1893	.b85d		7a		ply		                ply
1894	.b85e						LB85E:
1895	.b85e		bd 6b b8	lda $b86b,x	                lda LB86B,x
1896	.b861		d0 03		bne $b866	                bne LB866
1897	.b863		38		sec		                sec
1898	.b864		68		pla		                pla
1899	.b865		60		rts		                rts

1901	.b866						LB866:
1902	.b866		30 cd		bmi $b835	                bmi LB835
1903	.b868		e8		inx		                inx
1904	.b869		80 f3		bra $b85e	                bra LB85E

1906	.b86b						LB86B:
1907	>b86b		43				                .byte $43
1908	>b86c		4b				                .byte $4B
1909	>b86d		cc 4d 43			                .byte $cc,$4d,$43
1910	>b870		cc 50 52			                .byte $cc,$50,$52
1911	>b873		4f				                .byte $4F
1912	>b874		d4				                .byte $D4
1913	>b875		52 46				                .byte $52,$46
1914	>b877		c3				                .byte $C3
1915	>b878		54				                .byte $54
1916	>b879		46 c3				                .byte $46,$c3
1917	>b87b		57				                .byte $57
1918	>b87c		57				                .byte $57
1919	>b87d		cd 41 57			                .byte $cd,$41,$57
1920	>b880		cd 56 44			                .byte $cd,$56,$44
1921	>b883		d5 4d				                .byte $d5,$4d
1922	>b885		4f				                .byte $4F
1923	>b886		44				                .byte $44
1924	>b887		c5 4f				                .byte $c5,$4f
1925	>b889		ce 4f 46			                .byte $ce,$4f,$46
1926	>b88c		c6 54				                .byte $c6,$54
1927	>b88e		45 52				                .byte $45,$52
1928	>b890		4d 49 4e			                .byte $4d,$49,$4e
1929	>b893		41 cc				                .byte $41,$cc
1930	>b895		42				                .byte $42
1931	>b896		42				                .byte $42
1932	>b897		c3				                .byte $C3
1933	>b898		47				                .byte $47
1934	>b899		d3				                .byte $D3
1935	>b89a		54				                .byte $54
1936	>b89b		54				                .byte $54
1937	>b89c		d9				                .byte $D9
1938	>b89d		00				                .byte $00
1939	.b89e						LB89E:
1940	.b89e		88		dey		                dey
1941	.b89f						LB89F:
1942	.b89f		c8		iny		                iny
1943	.b8a0		b1 f2		lda ($f2),y	                lda ($F2),y
1944	.b8a2		c9 20		cmp #$20	                cmp #$20
1945	.b8a4		f0 f9		beq $b89f	                beq LB89F
1946	.b8a6		c9 0d		cmp #$0d	                cmp #$0D
1947	.b8a8		60		rts		                rts

1949	.b8a9						LB8A9:
1950	.b8a9		64 3a		stz $3a		                stz $3A
1951	.b8ab		64 3b		stz $3b		                stz $3B
1952	.b8ad						LB8AD:
1953	.b8ad		c9 30		cmp #$30	                cmp #$30
1954	.b8af		90 04		bcc $b8b5	                bcc LB8B5
1955	.b8b1		c9 3a		cmp #$3a	                cmp #$3A
1956	.b8b3		90 02		bcc $b8b7	                bcc LB8B7
1957	.b8b5						LB8B5:
1958	.b8b5		38		sec		                sec
1959	.b8b6		60		rts		                rts

1961	.b8b7						LB8B7:
1962	.b8b7		e9 2f		sbc #$2f	                sbc #$2F
1963	.b8b9		48		pha		                pha
1964	.b8ba		a5 3b		lda $3b		                lda $3B
1965	.b8bc		48		pha		                pha
1966	.b8bd		a5 3a		lda $3a		                lda $3A
1967	.b8bf		0a		asl a		                asl a
1968	.b8c0		26 3b		rol $3b		                rol $3B
1969	.b8c2		0a		asl a		                asl a
1970	.b8c3		26 3b		rol $3b		                rol $3B
1971	.b8c5		18		clc		                clc
1972	.b8c6		65 3a		adc $3a		                adc $3A
1973	.b8c8		85 3a		sta $3a		                sta $3A
1974	.b8ca		68		pla		                pla
1975	.b8cb		65 3b		adc $3b		                adc $3B
1976	.b8cd		85 3b		sta $3b		                sta $3B
1977	.b8cf		06 3a		asl $3a		                asl $3A
1978	.b8d1		26 3b		rol $3b		                rol $3B
1979	.b8d3		68		pla		                pla
1980	.b8d4		18		clc		                clc
1981	.b8d5		65 3a		adc $3a		                adc $3A
1982	.b8d7		85 3a		sta $3a		                sta $3A
1983	.b8d9		90 03		bcc $b8de	                bcc LB8DE
1984	.b8db		e6 3b		inc $3b		                inc $3B
1985	.b8dd		18		clc		                clc
1986	.b8de						LB8DE:
1987	.b8de		60		rts		                rts

:6	;******  Return to file: src/terminal.s65

6824							                .endif

6826							                .if version>=500
6828							                .endif

6830							;-------------------------------------------------------------------------

6832							                .if version==320&&multios
6833	>b8df		ff				                .align 16,255
6834	.b8e0						fixUpYear:
6835	.b8e0		c9 38		cmp #$38	                cmp #$38
6836	.b8e2		a9 19		lda #$19	                lda #$19
6837	.b8e4		b0 02		bcs $b8e8	                bcs gotYear
6838	.b8e6		a9 20		lda #$20	                lda #$20
6839	.b8e8						gotYear:
6840	.b8e8		4c 93 98	jmp $9893	                jmp storeBCDByteString
6841							                .endif

6843							;-------------------------------------------------------------------------

6845							; Unused space
6846							; ============
6847	>b8eb		ff ff ff ff ff ff ff ff		                .fill $b900-*,$ff
	>b8f3		ff ff ff ff ff ff ff ff ff ff ff ff ff

6849							; Default font
6850							; ============
6851	.b900						LB900:
6852							                .cerror (<LB900)!=0,"font data must be page aligned"
6853							                ; CHR$32 -
6854	>b900		00				                .byte %00000000
6855	>b901		00				                .byte %00000000
6856	>b902		00				                .byte %00000000
6857	>b903		00				                .byte %00000000
6858	>b904		00				                .byte %00000000
6859	>b905		00				                .byte %00000000
6860	>b906		00				                .byte %00000000
6861	>b907		00				                .byte %00000000

6863							                ; CHR$33 - !
6864	>b908		18				                .byte %00011000
6865	>b909		18				                .byte %00011000
6866	>b90a		18				                .byte %00011000
6867	>b90b		18				                .byte %00011000
6868	>b90c		18				                .byte %00011000
6869	>b90d		00				                .byte %00000000
6870	>b90e		18				                .byte %00011000
6871	>b90f		00				                .byte %00000000

6873							                ; CHR$34 - "
6874	>b910		6c				                .byte %01101100
6875	>b911		6c				                .byte %01101100
6876	>b912		6c				                .byte %01101100
6877	>b913		00				                .byte %00000000
6878	>b914		00				                .byte %00000000
6879	>b915		00				                .byte %00000000
6880	>b916		00				                .byte %00000000
6881	>b917		00				                .byte %00000000

6883							                ; CHR$35 - #
6884	>b918		36				                .byte %00110110
6885	>b919		36				                .byte %00110110
6886	>b91a		7f				                .byte %01111111
6887	>b91b		36				                .byte %00110110
6888	>b91c		7f				                .byte %01111111
6889	>b91d		36				                .byte %00110110
6890	>b91e		36				                .byte %00110110
6891	>b91f		00				                .byte %00000000

6893							                ; CHR$36 - $
6894	>b920		0c				                .byte %00001100
6895	>b921		3f				                .byte %00111111
6896	>b922		68				                .byte %01101000
6897	>b923		3e				                .byte %00111110
6898	>b924		0b				                .byte %00001011
6899	>b925		7e				                .byte %01111110
6900	>b926		18				                .byte %00011000
6901	>b927		00				                .byte %00000000

6903							                ; CHR$37 - %
6904	>b928		60				                .byte %01100000
6905	>b929		66				                .byte %01100110
6906	>b92a		0c				                .byte %00001100
6907	>b92b		18				                .byte %00011000
6908	>b92c		30				                .byte %00110000
6909	>b92d		66				                .byte %01100110
6910	>b92e		06				                .byte %00000110
6911	>b92f		00				                .byte %00000000

6913							                ; CHR$38 - &
6914	>b930		38				                .byte %00111000
6915	>b931		6c				                .byte %01101100
6916	>b932		6c				                .byte %01101100
6917	>b933		38				                .byte %00111000
6918	>b934		6d				                .byte %01101101
6919	>b935		66				                .byte %01100110
6920	>b936		3b				                .byte %00111011
6921	>b937		00				                .byte %00000000

6923							                ; CHR$39 - '
6924	>b938		0c				                .byte %00001100
6925	>b939		18				                .byte %00011000
6926	>b93a		30				                .byte %00110000
6927	>b93b		00				                .byte %00000000
6928	>b93c		00				                .byte %00000000
6929	>b93d		00				                .byte %00000000
6930	>b93e		00				                .byte %00000000
6931	>b93f		00				                .byte %00000000

6933							                ; CHR$40 - (
6934	>b940		0c				                .byte %00001100
6935	>b941		18				                .byte %00011000
6936	>b942		30				                .byte %00110000
6937	>b943		30				                .byte %00110000
6938	>b944		30				                .byte %00110000
6939	>b945		18				                .byte %00011000
6940	>b946		0c				                .byte %00001100
6941	>b947		00				                .byte %00000000

6943							                ; CHR$41 - )
6944	>b948		30				                .byte %00110000
6945	>b949		18				                .byte %00011000
6946	>b94a		0c				                .byte %00001100
6947	>b94b		0c				                .byte %00001100
6948	>b94c		0c				                .byte %00001100
6949	>b94d		18				                .byte %00011000
6950	>b94e		30				                .byte %00110000
6951	>b94f		00				                .byte %00000000

6953							                ; CHR$42 - *
6954	>b950		00				                .byte %00000000
6955	>b951		18				                .byte %00011000
6956	>b952		7e				                .byte %01111110
6957	>b953		3c				                .byte %00111100
6958	>b954		7e				                .byte %01111110
6959	>b955		18				                .byte %00011000
6960	>b956		00				                .byte %00000000
6961	>b957		00				                .byte %00000000

6963							                ; CHR$43 - +
6964	>b958		00				                .byte %00000000
6965	>b959		18				                .byte %00011000
6966	>b95a		18				                .byte %00011000
6967	>b95b		7e				                .byte %01111110
6968	>b95c		18				                .byte %00011000
6969	>b95d		18				                .byte %00011000
6970	>b95e		00				                .byte %00000000
6971	>b95f		00				                .byte %00000000

6973							                ; CHR$44 - ,
6974	>b960		00				                .byte %00000000
6975	>b961		00				                .byte %00000000
6976	>b962		00				                .byte %00000000
6977	>b963		00				                .byte %00000000
6978	>b964		00				                .byte %00000000
6979	>b965		18				                .byte %00011000
6980	>b966		18				                .byte %00011000
6981	>b967		30				                .byte %00110000

6983							                ; CHR$45 - -
6984	>b968		00				                .byte %00000000
6985	>b969		00				                .byte %00000000
6986	>b96a		00				                .byte %00000000
6987	>b96b		7e				                .byte %01111110
6988	>b96c		00				                .byte %00000000
6989	>b96d		00				                .byte %00000000
6990	>b96e		00				                .byte %00000000
6991	>b96f		00				                .byte %00000000

6993							                ; CHR$46 - .
6994	>b970		00				                .byte %00000000
6995	>b971		00				                .byte %00000000
6996	>b972		00				                .byte %00000000
6997	>b973		00				                .byte %00000000
6998	>b974		00				                .byte %00000000
6999	>b975		18				                .byte %00011000
7000	>b976		18				                .byte %00011000
7001	>b977		00				                .byte %00000000

7003							                ; CHR$47 - /
7004	>b978		00				                .byte %00000000
7005	>b979		06				                .byte %00000110
7006	>b97a		0c				                .byte %00001100
7007	>b97b		18				                .byte %00011000
7008	>b97c		30				                .byte %00110000
7009	>b97d		60				                .byte %01100000
7010	>b97e		00				                .byte %00000000
7011	>b97f		00				                .byte %00000000

7013							                ; CHR$48 - 0
7014	>b980		3c				                .byte %00111100
7015	>b981		66				                .byte %01100110
7016	>b982		6e				                .byte %01101110
7017	>b983		7e				                .byte %01111110
7018	>b984		76				                .byte %01110110
7019	>b985		66				                .byte %01100110
7020	>b986		3c				                .byte %00111100
7021	>b987		00				                .byte %00000000

7023							                ; CHR$49 - 1
7024	>b988		18				                .byte %00011000
7025	>b989		38				                .byte %00111000
7026	>b98a		18				                .byte %00011000
7027	>b98b		18				                .byte %00011000
7028	>b98c		18				                .byte %00011000
7029	>b98d		18				                .byte %00011000
7030	>b98e		7e				                .byte %01111110
7031	>b98f		00				                .byte %00000000

7033							                ; CHR$50 - 2
7034	>b990		3c				                .byte %00111100
7035	>b991		66				                .byte %01100110
7036	>b992		06				                .byte %00000110
7037	>b993		0c				                .byte %00001100
7038	>b994		18				                .byte %00011000
7039	>b995		30				                .byte %00110000
7040	>b996		7e				                .byte %01111110
7041	>b997		00				                .byte %00000000

7043							                ; CHR$51 - 3
7044	>b998		3c				                .byte %00111100
7045	>b999		66				                .byte %01100110
7046	>b99a		06				                .byte %00000110
7047	>b99b		1c				                .byte %00011100
7048	>b99c		06				                .byte %00000110
7049	>b99d		66				                .byte %01100110
7050	>b99e		3c				                .byte %00111100
7051	>b99f		00				                .byte %00000000

7053							                ; CHR$52 - 4
7054	>b9a0		0c				                .byte %00001100
7055	>b9a1		1c				                .byte %00011100
7056	>b9a2		3c				                .byte %00111100
7057	>b9a3		6c				                .byte %01101100
7058	>b9a4		7e				                .byte %01111110
7059	>b9a5		0c				                .byte %00001100
7060	>b9a6		0c				                .byte %00001100
7061	>b9a7		00				                .byte %00000000

7063							                ; CHR$53 - 5
7064	>b9a8		7e				                .byte %01111110
7065	>b9a9		60				                .byte %01100000
7066	>b9aa		7c				                .byte %01111100
7067	>b9ab		06				                .byte %00000110
7068	>b9ac		06				                .byte %00000110
7069	>b9ad		66				                .byte %01100110
7070	>b9ae		3c				                .byte %00111100
7071	>b9af		00				                .byte %00000000

7073							                ; CHR$54 - 6
7074	>b9b0		1c				                .byte %00011100
7075	>b9b1		30				                .byte %00110000
7076	>b9b2		60				                .byte %01100000
7077	>b9b3		7c				                .byte %01111100
7078	>b9b4		66				                .byte %01100110
7079	>b9b5		66				                .byte %01100110
7080	>b9b6		3c				                .byte %00111100
7081	>b9b7		00				                .byte %00000000

7083							                ; CHR$55 - 7
7084	>b9b8		7e				                .byte %01111110
7085	>b9b9		06				                .byte %00000110
7086	>b9ba		0c				                .byte %00001100
7087	>b9bb		18				                .byte %00011000
7088	>b9bc		30				                .byte %00110000
7089	>b9bd		30				                .byte %00110000
7090	>b9be		30				                .byte %00110000
7091	>b9bf		00				                .byte %00000000

7093							                ; CHR$56 - 8
7094	>b9c0		3c				                .byte %00111100
7095	>b9c1		66				                .byte %01100110
7096	>b9c2		66				                .byte %01100110
7097	>b9c3		3c				                .byte %00111100
7098	>b9c4		66				                .byte %01100110
7099	>b9c5		66				                .byte %01100110
7100	>b9c6		3c				                .byte %00111100
7101	>b9c7		00				                .byte %00000000

7103							                ; CHR$57 - 9
7104	>b9c8		3c				                .byte %00111100
7105	>b9c9		66				                .byte %01100110
7106	>b9ca		66				                .byte %01100110
7107	>b9cb		3e				                .byte %00111110
7108	>b9cc		06				                .byte %00000110
7109	>b9cd		0c				                .byte %00001100
7110	>b9ce		38				                .byte %00111000
7111	>b9cf		00				                .byte %00000000

7113							                ; CHR$58 - :
7114	>b9d0		00				                .byte %00000000
7115	>b9d1		00				                .byte %00000000
7116	>b9d2		18				                .byte %00011000
7117	>b9d3		18				                .byte %00011000
7118	>b9d4		00				                .byte %00000000
7119	>b9d5		18				                .byte %00011000
7120	>b9d6		18				                .byte %00011000
7121	>b9d7		00				                .byte %00000000

7123							                ; CHR$59 - ;
7124	>b9d8		00				                .byte %00000000
7125	>b9d9		00				                .byte %00000000
7126	>b9da		18				                .byte %00011000
7127	>b9db		18				                .byte %00011000
7128	>b9dc		00				                .byte %00000000
7129	>b9dd		18				                .byte %00011000
7130	>b9de		18				                .byte %00011000
7131	>b9df		30				                .byte %00110000

7133							                ; CHR$60 - <
7134	>b9e0		0c				                .byte %00001100
7135	>b9e1		18				                .byte %00011000
7136	>b9e2		30				                .byte %00110000
7137	>b9e3		60				                .byte %01100000
7138	>b9e4		30				                .byte %00110000
7139	>b9e5		18				                .byte %00011000
7140	>b9e6		0c				                .byte %00001100
7141	>b9e7		00				                .byte %00000000

7143							                ; CHR$61 - =
7144	>b9e8		00				                .byte %00000000
7145	>b9e9		00				                .byte %00000000
7146	>b9ea		7e				                .byte %01111110
7147	>b9eb		00				                .byte %00000000
7148	>b9ec		7e				                .byte %01111110
7149	>b9ed		00				                .byte %00000000
7150	>b9ee		00				                .byte %00000000
7151	>b9ef		00				                .byte %00000000

7153							                ; CHR$62 - >
7154	>b9f0		30				                .byte %00110000
7155	>b9f1		18				                .byte %00011000
7156	>b9f2		0c				                .byte %00001100
7157	>b9f3		06				                .byte %00000110
7158	>b9f4		0c				                .byte %00001100
7159	>b9f5		18				                .byte %00011000
7160	>b9f6		30				                .byte %00110000
7161	>b9f7		00				                .byte %00000000

7163							                ; CHR$63 - ?
7164	>b9f8		3c				                .byte %00111100
7165	>b9f9		66				                .byte %01100110
7166	>b9fa		0c				                .byte %00001100
7167	>b9fb		18				                .byte %00011000
7168	>b9fc		18				                .byte %00011000
7169	>b9fd		00				                .byte %00000000
7170	>b9fe		18				                .byte %00011000
7171	>b9ff		00				                .byte %00000000

7173							                ; CHR$64 - @
7174	>ba00		3c				                .byte %00111100
7175	>ba01		66				                .byte %01100110
7176	>ba02		6e				                .byte %01101110
7177	>ba03		6a				                .byte %01101010
7178	>ba04		6e				                .byte %01101110
7179	>ba05		60				                .byte %01100000
7180	>ba06		3c				                .byte %00111100
7181	>ba07		00				                .byte %00000000

7183							                ; CHR$65 - A
7184	>ba08		3c				                .byte %00111100
7185	>ba09		66				                .byte %01100110
7186	>ba0a		66				                .byte %01100110
7187	>ba0b		7e				                .byte %01111110
7188	>ba0c		66				                .byte %01100110
7189	>ba0d		66				                .byte %01100110
7190	>ba0e		66				                .byte %01100110
7191	>ba0f		00				                .byte %00000000

7193							                ; CHR$66 - B
7194	>ba10		7c				                .byte %01111100
7195	>ba11		66				                .byte %01100110
7196	>ba12		66				                .byte %01100110
7197	>ba13		7c				                .byte %01111100
7198	>ba14		66				                .byte %01100110
7199	>ba15		66				                .byte %01100110
7200	>ba16		7c				                .byte %01111100
7201	>ba17		00				                .byte %00000000

7203							                ; CHR$67 - C
7204	>ba18		3c				                .byte %00111100
7205	>ba19		66				                .byte %01100110
7206	>ba1a		60				                .byte %01100000
7207	>ba1b		60				                .byte %01100000
7208	>ba1c		60				                .byte %01100000
7209	>ba1d		66				                .byte %01100110
7210	>ba1e		3c				                .byte %00111100
7211	>ba1f		00				                .byte %00000000

7213							                ; CHR$68 - D
7214	>ba20		78				                .byte %01111000
7215	>ba21		6c				                .byte %01101100
7216	>ba22		66				                .byte %01100110
7217	>ba23		66				                .byte %01100110
7218	>ba24		66				                .byte %01100110
7219	>ba25		6c				                .byte %01101100
7220	>ba26		78				                .byte %01111000
7221	>ba27		00				                .byte %00000000

7223							                ; CHR$69 - E
7224	>ba28		7e				                .byte %01111110
7225	>ba29		60				                .byte %01100000
7226	>ba2a		60				                .byte %01100000
7227	>ba2b		7c				                .byte %01111100
7228	>ba2c		60				                .byte %01100000
7229	>ba2d		60				                .byte %01100000
7230	>ba2e		7e				                .byte %01111110
7231	>ba2f		00				                .byte %00000000

7233							                ; CHR$70 - F
7234	>ba30		7e				                .byte %01111110
7235	>ba31		60				                .byte %01100000
7236	>ba32		60				                .byte %01100000
7237	>ba33		7c				                .byte %01111100
7238	>ba34		60				                .byte %01100000
7239	>ba35		60				                .byte %01100000
7240	>ba36		60				                .byte %01100000
7241	>ba37		00				                .byte %00000000

7243							                ; CHR$71 - G
7244	>ba38		3c				                .byte %00111100
7245	>ba39		66				                .byte %01100110
7246	>ba3a		60				                .byte %01100000
7247	>ba3b		6e				                .byte %01101110
7248	>ba3c		66				                .byte %01100110
7249	>ba3d		66				                .byte %01100110
7250	>ba3e		3c				                .byte %00111100
7251	>ba3f		00				                .byte %00000000

7253							                ; CHR$72 - H
7254	>ba40		66				                .byte %01100110
7255	>ba41		66				                .byte %01100110
7256	>ba42		66				                .byte %01100110
7257	>ba43		7e				                .byte %01111110
7258	>ba44		66				                .byte %01100110
7259	>ba45		66				                .byte %01100110
7260	>ba46		66				                .byte %01100110
7261	>ba47		00				                .byte %00000000

7263							                ; CHR$73 - I
7264	>ba48		7e				                .byte %01111110
7265	>ba49		18				                .byte %00011000
7266	>ba4a		18				                .byte %00011000
7267	>ba4b		18				                .byte %00011000
7268	>ba4c		18				                .byte %00011000
7269	>ba4d		18				                .byte %00011000
7270	>ba4e		7e				                .byte %01111110
7271	>ba4f		00				                .byte %00000000

7273							                ; CHR$74 - J
7274	>ba50		3e				                .byte %00111110
7275	>ba51		0c				                .byte %00001100
7276	>ba52		0c				                .byte %00001100
7277	>ba53		0c				                .byte %00001100
7278	>ba54		0c				                .byte %00001100
7279	>ba55		6c				                .byte %01101100
7280	>ba56		38				                .byte %00111000
7281	>ba57		00				                .byte %00000000

7283							                ; CHR$75 - K
7284	>ba58		66				                .byte %01100110
7285	>ba59		6c				                .byte %01101100
7286	>ba5a		78				                .byte %01111000
7287	>ba5b		70				                .byte %01110000
7288	>ba5c		78				                .byte %01111000
7289	>ba5d		6c				                .byte %01101100
7290	>ba5e		66				                .byte %01100110
7291	>ba5f		00				                .byte %00000000

7293							                ; CHR$76 - L
7294	>ba60		60				                .byte %01100000
7295	>ba61		60				                .byte %01100000
7296	>ba62		60				                .byte %01100000
7297	>ba63		60				                .byte %01100000
7298	>ba64		60				                .byte %01100000
7299	>ba65		60				                .byte %01100000
7300	>ba66		7e				                .byte %01111110
7301	>ba67		00				                .byte %00000000

7303							                ; CHR$77 - M
7304	>ba68		63				                .byte %01100011
7305	>ba69		77				                .byte %01110111
7306	>ba6a		7f				                .byte %01111111
7307	>ba6b		6b				                .byte %01101011
7308	>ba6c		6b				                .byte %01101011
7309	>ba6d		63				                .byte %01100011
7310	>ba6e		63				                .byte %01100011
7311	>ba6f		00				                .byte %00000000

7313							                ; CHR$78 - N
7314	>ba70		66				                .byte %01100110
7315	>ba71		66				                .byte %01100110
7316	>ba72		76				                .byte %01110110
7317	>ba73		7e				                .byte %01111110
7318	>ba74		6e				                .byte %01101110
7319	>ba75		66				                .byte %01100110
7320	>ba76		66				                .byte %01100110
7321	>ba77		00				                .byte %00000000

7323							                ; CHR$79 - O
7324	>ba78		3c				                .byte %00111100
7325	>ba79		66				                .byte %01100110
7326	>ba7a		66				                .byte %01100110
7327	>ba7b		66				                .byte %01100110
7328	>ba7c		66				                .byte %01100110
7329	>ba7d		66				                .byte %01100110
7330	>ba7e		3c				                .byte %00111100
7331	>ba7f		00				                .byte %00000000

7333							                ; CHR$80 - P
7334	>ba80		7c				                .byte %01111100
7335	>ba81		66				                .byte %01100110
7336	>ba82		66				                .byte %01100110
7337	>ba83		7c				                .byte %01111100
7338	>ba84		60				                .byte %01100000
7339	>ba85		60				                .byte %01100000
7340	>ba86		60				                .byte %01100000
7341	>ba87		00				                .byte %00000000

7343							                ; CHR$81 - Q
7344	>ba88		3c				                .byte %00111100
7345	>ba89		66				                .byte %01100110
7346	>ba8a		66				                .byte %01100110
7347	>ba8b		66				                .byte %01100110
7348	>ba8c		6a				                .byte %01101010
7349	>ba8d		6c				                .byte %01101100
7350	>ba8e		36				                .byte %00110110
7351	>ba8f		00				                .byte %00000000

7353							                ; CHR$82 - R
7354	>ba90		7c				                .byte %01111100
7355	>ba91		66				                .byte %01100110
7356	>ba92		66				                .byte %01100110
7357	>ba93		7c				                .byte %01111100
7358	>ba94		6c				                .byte %01101100
7359	>ba95		66				                .byte %01100110
7360	>ba96		66				                .byte %01100110
7361	>ba97		00				                .byte %00000000

7363							                ; CHR$83 - S
7364	>ba98		3c				                .byte %00111100
7365	>ba99		66				                .byte %01100110
7366	>ba9a		60				                .byte %01100000
7367	>ba9b		3c				                .byte %00111100
7368	>ba9c		06				                .byte %00000110
7369	>ba9d		66				                .byte %01100110
7370	>ba9e		3c				                .byte %00111100
7371	>ba9f		00				                .byte %00000000

7373							                ; CHR$84 - T
7374	>baa0		7e				                .byte %01111110
7375	>baa1		18				                .byte %00011000
7376	>baa2		18				                .byte %00011000
7377	>baa3		18				                .byte %00011000
7378	>baa4		18				                .byte %00011000
7379	>baa5		18				                .byte %00011000
7380	>baa6		18				                .byte %00011000
7381	>baa7		00				                .byte %00000000

7383							                ; CHR$85 - U
7384	>baa8		66				                .byte %01100110
7385	>baa9		66				                .byte %01100110
7386	>baaa		66				                .byte %01100110
7387	>baab		66				                .byte %01100110
7388	>baac		66				                .byte %01100110
7389	>baad		66				                .byte %01100110
7390	>baae		3c				                .byte %00111100
7391	>baaf		00				                .byte %00000000

7393							                ; CHR$86 - V
7394	>bab0		66				                .byte %01100110
7395	>bab1		66				                .byte %01100110
7396	>bab2		66				                .byte %01100110
7397	>bab3		66				                .byte %01100110
7398	>bab4		66				                .byte %01100110
7399	>bab5		3c				                .byte %00111100
7400	>bab6		18				                .byte %00011000
7401	>bab7		00				                .byte %00000000

7403							                ; CHR$87 - W
7404	>bab8		63				                .byte %01100011
7405	>bab9		63				                .byte %01100011
7406	>baba		6b				                .byte %01101011
7407	>babb		6b				                .byte %01101011
7408	>babc		7f				                .byte %01111111
7409	>babd		77				                .byte %01110111
7410	>babe		63				                .byte %01100011
7411	>babf		00				                .byte %00000000

7413							                ; CHR$88 - X
7414	>bac0		66				                .byte %01100110
7415	>bac1		66				                .byte %01100110
7416	>bac2		3c				                .byte %00111100
7417	>bac3		18				                .byte %00011000
7418	>bac4		3c				                .byte %00111100
7419	>bac5		66				                .byte %01100110
7420	>bac6		66				                .byte %01100110
7421	>bac7		00				                .byte %00000000

7423							                ; CHR$89 - Y
7424	>bac8		66				                .byte %01100110
7425	>bac9		66				                .byte %01100110
7426	>baca		66				                .byte %01100110
7427	>bacb		3c				                .byte %00111100
7428	>bacc		18				                .byte %00011000
7429	>bacd		18				                .byte %00011000
7430	>bace		18				                .byte %00011000
7431	>bacf		00				                .byte %00000000

7433							                ; CHR$90 - Z
7434	>bad0		7e				                .byte %01111110
7435	>bad1		06				                .byte %00000110
7436	>bad2		0c				                .byte %00001100
7437	>bad3		18				                .byte %00011000
7438	>bad4		30				                .byte %00110000
7439	>bad5		60				                .byte %01100000
7440	>bad6		7e				                .byte %01111110
7441	>bad7		00				                .byte %00000000

7443							                ; CHR$91 - [
7444	>bad8		7c				                .byte %01111100
7445	>bad9		60				                .byte %01100000
7446	>bada		60				                .byte %01100000
7447	>badb		60				                .byte %01100000
7448	>badc		60				                .byte %01100000
7449	>badd		60				                .byte %01100000
7450	>bade		7c				                .byte %01111100
7451	>badf		00				                .byte %00000000

7453							                ; CHR$92 - \
7454	>bae0		00				                .byte %00000000
7455	>bae1		60				                .byte %01100000
7456	>bae2		30				                .byte %00110000
7457	>bae3		18				                .byte %00011000
7458	>bae4		0c				                .byte %00001100
7459	>bae5		06				                .byte %00000110
7460	>bae6		00				                .byte %00000000
7461	>bae7		00				                .byte %00000000

7463							                ; CHR$93 - ]
7464	>bae8		3e				                .byte %00111110
7465	>bae9		06				                .byte %00000110
7466	>baea		06				                .byte %00000110
7467	>baeb		06				                .byte %00000110
7468	>baec		06				                .byte %00000110
7469	>baed		06				                .byte %00000110
7470	>baee		3e				                .byte %00111110
7471	>baef		00				                .byte %00000000

7473							                ; CHR$94 - ^
7474	>baf0		18				                .byte %00011000
7475	>baf1		3c				                .byte %00111100
7476	>baf2		66				                .byte %01100110
7477	>baf3		42				                .byte %01000010
7478	>baf4		00				                .byte %00000000
7479	>baf5		00				                .byte %00000000
7480	>baf6		00				                .byte %00000000
7481	>baf7		00				                .byte %00000000

7483							                ; CHR$95 - _
7484	>baf8		00				                .byte %00000000
7485	>baf9		00				                .byte %00000000
7486	>bafa		00				                .byte %00000000
7487	>bafb		00				                .byte %00000000
7488	>bafc		00				                .byte %00000000
7489	>bafd		00				                .byte %00000000
7490	>bafe		00				                .byte %00000000
7491	>baff		ff				                .byte %11111111

7493							                ; CHR$96
7494	>bb00		1c				                .byte %00011100
7495	>bb01		36				                .byte %00110110
7496	>bb02		30				                .byte %00110000
7497	>bb03		7c				                .byte %01111100
7498	>bb04		30				                .byte %00110000
7499	>bb05		30				                .byte %00110000
7500	>bb06		7e				                .byte %01111110
7501	>bb07		00				                .byte %00000000

7503							                ; CHR$97 - a
7504	>bb08		00				                .byte %00000000
7505	>bb09		00				                .byte %00000000
7506	>bb0a		3c				                .byte %00111100
7507	>bb0b		06				                .byte %00000110
7508	>bb0c		3e				                .byte %00111110
7509	>bb0d		66				                .byte %01100110
7510	>bb0e		3e				                .byte %00111110
7511	>bb0f		00				                .byte %00000000

7513							                ; CHR$98 - b
7514	>bb10		60				                .byte %01100000
7515	>bb11		60				                .byte %01100000
7516	>bb12		7c				                .byte %01111100
7517	>bb13		66				                .byte %01100110
7518	>bb14		66				                .byte %01100110
7519	>bb15		66				                .byte %01100110
7520	>bb16		7c				                .byte %01111100
7521	>bb17		00				                .byte %00000000

7523							                ; CHR$99 - c
7524	>bb18		00				                .byte %00000000
7525	>bb19		00				                .byte %00000000
7526	>bb1a		3c				                .byte %00111100
7527	>bb1b		66				                .byte %01100110
7528	>bb1c		60				                .byte %01100000
7529	>bb1d		66				                .byte %01100110
7530	>bb1e		3c				                .byte %00111100
7531	>bb1f		00				                .byte %00000000

7533							                ; CHR$100 - d
7534	>bb20		06				                .byte %00000110
7535	>bb21		06				                .byte %00000110
7536	>bb22		3e				                .byte %00111110
7537	>bb23		66				                .byte %01100110
7538	>bb24		66				                .byte %01100110
7539	>bb25		66				                .byte %01100110
7540	>bb26		3e				                .byte %00111110
7541	>bb27		00				                .byte %00000000

7543							                ; CHR$101 - e
7544	>bb28		00				                .byte %00000000
7545	>bb29		00				                .byte %00000000
7546	>bb2a		3c				                .byte %00111100
7547	>bb2b		66				                .byte %01100110
7548	>bb2c		7e				                .byte %01111110
7549	>bb2d		60				                .byte %01100000
7550	>bb2e		3c				                .byte %00111100
7551	>bb2f		00				                .byte %00000000

7553							                ; CHR$102 - f
7554	>bb30		1c				                .byte %00011100
7555	>bb31		30				                .byte %00110000
7556	>bb32		30				                .byte %00110000
7557	>bb33		7c				                .byte %01111100
7558	>bb34		30				                .byte %00110000
7559	>bb35		30				                .byte %00110000
7560	>bb36		30				                .byte %00110000
7561	>bb37		00				                .byte %00000000

7563							                ; CHR$103 - g
7564	>bb38		00				                .byte %00000000
7565	>bb39		00				                .byte %00000000
7566	>bb3a		3e				                .byte %00111110
7567	>bb3b		66				                .byte %01100110
7568	>bb3c		66				                .byte %01100110
7569	>bb3d		3e				                .byte %00111110
7570	>bb3e		06				                .byte %00000110
7571	>bb3f		3c				                .byte %00111100

7573							                ; CHR$104 - h
7574	>bb40		60				                .byte %01100000
7575	>bb41		60				                .byte %01100000
7576	>bb42		7c				                .byte %01111100
7577	>bb43		66				                .byte %01100110
7578	>bb44		66				                .byte %01100110
7579	>bb45		66				                .byte %01100110
7580	>bb46		66				                .byte %01100110
7581	>bb47		00				                .byte %00000000

7583							                ; CHR$105 - i
7584	>bb48		18				                .byte %00011000
7585	>bb49		00				                .byte %00000000
7586	>bb4a		38				                .byte %00111000
7587	>bb4b		18				                .byte %00011000
7588	>bb4c		18				                .byte %00011000
7589	>bb4d		18				                .byte %00011000
7590	>bb4e		3c				                .byte %00111100
7591	>bb4f		00				                .byte %00000000

7593							                ; CHR$106 - j
7594	>bb50		18				                .byte %00011000
7595	>bb51		00				                .byte %00000000
7596	>bb52		38				                .byte %00111000
7597	>bb53		18				                .byte %00011000
7598	>bb54		18				                .byte %00011000
7599	>bb55		18				                .byte %00011000
7600	>bb56		18				                .byte %00011000
7601	>bb57		70				                .byte %01110000

7603							                ; CHR$107 - k
7604	>bb58		60				                .byte %01100000
7605	>bb59		60				                .byte %01100000
7606	>bb5a		66				                .byte %01100110
7607	>bb5b		6c				                .byte %01101100
7608	>bb5c		78				                .byte %01111000
7609	>bb5d		6c				                .byte %01101100
7610	>bb5e		66				                .byte %01100110
7611	>bb5f		00				                .byte %00000000

7613							                ; CHR$108 - l
7614	>bb60		38				                .byte %00111000
7615	>bb61		18				                .byte %00011000
7616	>bb62		18				                .byte %00011000
7617	>bb63		18				                .byte %00011000
7618	>bb64		18				                .byte %00011000
7619	>bb65		18				                .byte %00011000
7620	>bb66		3c				                .byte %00111100
7621	>bb67		00				                .byte %00000000

7623							                ; CHR$109 - m
7624	>bb68		00				                .byte %00000000
7625	>bb69		00				                .byte %00000000
7626	>bb6a		36				                .byte %00110110
7627	>bb6b		7f				                .byte %01111111
7628	>bb6c		6b				                .byte %01101011
7629	>bb6d		6b				                .byte %01101011
7630	>bb6e		63				                .byte %01100011
7631	>bb6f		00				                .byte %00000000

7633							                ; CHR$110 - n
7634	>bb70		00				                .byte %00000000
7635	>bb71		00				                .byte %00000000
7636	>bb72		7c				                .byte %01111100
7637	>bb73		66				                .byte %01100110
7638	>bb74		66				                .byte %01100110
7639	>bb75		66				                .byte %01100110
7640	>bb76		66				                .byte %01100110
7641	>bb77		00				                .byte %00000000

7643							                ; CHR$111 - o
7644	>bb78		00				                .byte %00000000
7645	>bb79		00				                .byte %00000000
7646	>bb7a		3c				                .byte %00111100
7647	>bb7b		66				                .byte %01100110
7648	>bb7c		66				                .byte %01100110
7649	>bb7d		66				                .byte %01100110
7650	>bb7e		3c				                .byte %00111100
7651	>bb7f		00				                .byte %00000000

7653							                ; CHR$112 - p
7654	>bb80		00				                .byte %00000000
7655	>bb81		00				                .byte %00000000
7656	>bb82		7c				                .byte %01111100
7657	>bb83		66				                .byte %01100110
7658	>bb84		66				                .byte %01100110
7659	>bb85		7c				                .byte %01111100
7660	>bb86		60				                .byte %01100000
7661	>bb87		60				                .byte %01100000

7663							                ; CHR$113 - q
7664	>bb88		00				                .byte %00000000
7665	>bb89		00				                .byte %00000000
7666	>bb8a		3e				                .byte %00111110
7667	>bb8b		66				                .byte %01100110
7668	>bb8c		66				                .byte %01100110
7669	>bb8d		3e				                .byte %00111110
7670	>bb8e		06				                .byte %00000110
7671	>bb8f		07				                .byte %00000111

7673							                ; CHR$114 - r
7674	>bb90		00				                .byte %00000000
7675	>bb91		00				                .byte %00000000
7676	>bb92		6c				                .byte %01101100
7677	>bb93		76				                .byte %01110110
7678	>bb94		60				                .byte %01100000
7679	>bb95		60				                .byte %01100000
7680	>bb96		60				                .byte %01100000
7681	>bb97		00				                .byte %00000000

7683							                ; CHR$115 - s
7684	>bb98		00				                .byte %00000000
7685	>bb99		00				                .byte %00000000
7686	>bb9a		3e				                .byte %00111110
7687	>bb9b		60				                .byte %01100000
7688	>bb9c		3c				                .byte %00111100
7689	>bb9d		06				                .byte %00000110
7690	>bb9e		7c				                .byte %01111100
7691	>bb9f		00				                .byte %00000000

7693							                ; CHR$116 - t
7694	>bba0		30				                .byte %00110000
7695	>bba1		30				                .byte %00110000
7696	>bba2		7c				                .byte %01111100
7697	>bba3		30				                .byte %00110000
7698	>bba4		30				                .byte %00110000
7699	>bba5		30				                .byte %00110000
7700	>bba6		1c				                .byte %00011100
7701	>bba7		00				                .byte %00000000

7703							                ; CHR$117 - u
7704	>bba8		00				                .byte %00000000
7705	>bba9		00				                .byte %00000000
7706	>bbaa		66				                .byte %01100110
7707	>bbab		66				                .byte %01100110
7708	>bbac		66				                .byte %01100110
7709	>bbad		66				                .byte %01100110
7710	>bbae		3e				                .byte %00111110
7711	>bbaf		00				                .byte %00000000

7713							                ; CHR$118 - v
7714	>bbb0		00				                .byte %00000000
7715	>bbb1		00				                .byte %00000000
7716	>bbb2		66				                .byte %01100110
7717	>bbb3		66				                .byte %01100110
7718	>bbb4		66				                .byte %01100110
7719	>bbb5		3c				                .byte %00111100
7720	>bbb6		18				                .byte %00011000
7721	>bbb7		00				                .byte %00000000

7723							                ; CHR$119 - w
7724	>bbb8		00				                .byte %00000000
7725	>bbb9		00				                .byte %00000000
7726	>bbba		63				                .byte %01100011
7727	>bbbb		6b				                .byte %01101011
7728	>bbbc		6b				                .byte %01101011
7729	>bbbd		7f				                .byte %01111111
7730	>bbbe		36				                .byte %00110110
7731	>bbbf		00				                .byte %00000000

7733							                ; CHR$120 - x
7734	>bbc0		00				                .byte %00000000
7735	>bbc1		00				                .byte %00000000
7736	>bbc2		66				                .byte %01100110
7737	>bbc3		3c				                .byte %00111100
7738	>bbc4		18				                .byte %00011000
7739	>bbc5		3c				                .byte %00111100
7740	>bbc6		66				                .byte %01100110
7741	>bbc7		00				                .byte %00000000

7743							                ; CHR$121 - y
7744	>bbc8		00				                .byte %00000000
7745	>bbc9		00				                .byte %00000000
7746	>bbca		66				                .byte %01100110
7747	>bbcb		66				                .byte %01100110
7748	>bbcc		66				                .byte %01100110
7749	>bbcd		3e				                .byte %00111110
7750	>bbce		06				                .byte %00000110
7751	>bbcf		3c				                .byte %00111100

7753							                ; CHR$122 - z
7754	>bbd0		00				                .byte %00000000
7755	>bbd1		00				                .byte %00000000
7756	>bbd2		7e				                .byte %01111110
7757	>bbd3		0c				                .byte %00001100
7758	>bbd4		18				                .byte %00011000
7759	>bbd5		30				                .byte %00110000
7760	>bbd6		7e				                .byte %01111110
7761	>bbd7		00				                .byte %00000000

7763							                ; CHR$123 - {
7764	>bbd8		0c				                .byte %00001100
7765	>bbd9		18				                .byte %00011000
7766	>bbda		18				                .byte %00011000
7767	>bbdb		70				                .byte %01110000
7768	>bbdc		18				                .byte %00011000
7769	>bbdd		18				                .byte %00011000
7770	>bbde		0c				                .byte %00001100
7771	>bbdf		00				                .byte %00000000

7773							                ; CHR$124 - |
7774	>bbe0		18				                .byte %00011000
7775	>bbe1		18				                .byte %00011000
7776	>bbe2		18				                .byte %00011000
7777	>bbe3		00				                .byte %00000000
7778	>bbe4		18				                .byte %00011000
7779	>bbe5		18				                .byte %00011000
7780	>bbe6		18				                .byte %00011000
7781	>bbe7		00				                .byte %00000000

7783							                ; CHR$125 - }
7784	>bbe8		30				                .byte %00110000
7785	>bbe9		18				                .byte %00011000
7786	>bbea		18				                .byte %00011000
7787	>bbeb		0e				                .byte %00001110
7788	>bbec		18				                .byte %00011000
7789	>bbed		18				                .byte %00011000
7790	>bbee		30				                .byte %00110000
7791	>bbef		00				                .byte %00000000

7793							                ; CHR$126 - ~
7794	>bbf0		31				                .byte %00110001
7795	>bbf1		6b				                .byte %01101011
7796	>bbf2		46				                .byte %01000110
7797	>bbf3		00				                .byte %00000000
7798	>bbf4		00				                .byte %00000000
7799	>bbf5		00				                .byte %00000000
7800	>bbf6		00				                .byte %00000000
7801	>bbf7		00				                .byte %00000000

7803							                ; CHR$127
7804	.bbf8						chr127:
7805	>bbf8		ff				                .byte %11111111
7806	>bbf9		ff				                .byte %11111111
7807	>bbfa		ff				                .byte %11111111
7808	>bbfb		ff				                .byte %11111111
7809	>bbfc		ff				                .byte %11111111
7810	>bbfd		ff				                .byte %11111111
7811	>bbfe		ff				                .byte %11111111
7812	>bbff		ff				                .byte %11111111

7814							                ; CHR$128
7815							                .if version==350
7824							                .else
7825	>bc00		66				                .byte %01100110
7826	>bc01		00				                .byte %00000000
7827	>bc02		3c				                .byte %00111100
7828	>bc03		66				                .byte %01100110
7829	>bc04		7e				                .byte %01111110
7830	>bc05		66				                .byte %01100110
7831	>bc06		66				                .byte %01100110
7832	>bc07		00				                .byte %00000000
7833							                .endif

7835							                ; CHR$129
7836							                .if version==350
7845							                .else
7846	>bc08		3c				                .byte %00111100
7847	>bc09		66				                .byte %01100110
7848	>bc0a		3c				                .byte %00111100
7849	>bc0b		66				                .byte %01100110
7850	>bc0c		7e				                .byte %01111110
7851	>bc0d		66				                .byte %01100110
7852	>bc0e		66				                .byte %01100110
7853	>bc0f		00				                .byte %00000000
7854							                .endif

7856							                ; CHR$130
7857	>bc10		3f				                .byte %00111111
7858	>bc11		66				                .byte %01100110
7859	>bc12		66				                .byte %01100110
7860	>bc13		7f				                .byte %01111111
7861	>bc14		66				                .byte %01100110
7862	>bc15		66				                .byte %01100110
7863	>bc16		67				                .byte %01100111
7864	>bc17		00				                .byte %00000000

7866							                ; CHR$131
7867							                .if version==350
7876							                .else
7877	>bc18		3c				                .byte %00111100
7878	>bc19		66				                .byte %01100110
7879	>bc1a		60				                .byte %01100000
7880	>bc1b		60				                .byte %01100000
7881	>bc1c		60				                .byte %01100000
7882	>bc1d		66				                .byte %01100110
7883	>bc1e		3c				                .byte %00111100
7884	>bc1f		60				                .byte %01100000
7885							                .endif

7887							                ; CHR$132
7888	>bc20		0c				                .byte %00001100
7889	>bc21		18				                .byte %00011000
7890	>bc22		7e				                .byte %01111110
7891	>bc23		60				                .byte %01100000
7892	>bc24		7c				                .byte %01111100
7893	>bc25		60				                .byte %01100000
7894	>bc26		7e				                .byte %01111110
7895	>bc27		00				                .byte %00000000

7897							                ; CHR$133
7898							                .if version==350
7907							                .else
7908	>bc28		66				                .byte %01100110
7909	>bc29		3c				                .byte %00111100
7910	>bc2a		66				                .byte %01100110
7911	>bc2b		66				                .byte %01100110
7912	>bc2c		66				                .byte %01100110
7913	>bc2d		66				                .byte %01100110
7914	>bc2e		3c				                .byte %00111100
7915	>bc2f		00				                .byte %00000000
7916							                .endif

7918							                ; CHR$134
7919	>bc30		66				                .byte %01100110
7920	>bc31		00				                .byte %00000000
7921	>bc32		66				                .byte %01100110
7922	>bc33		66				                .byte %01100110
7923	>bc34		66				                .byte %01100110
7924	>bc35		66				                .byte %01100110
7925	>bc36		3c				                .byte %00111100
7926	>bc37		00				                .byte %00000000

7928							                ; CHR$135
7929							                .if version==350
7938							                .else
7939	>bc38		7e				                .byte %01111110
7940	>bc39		c3				                .byte %11000011
7941	>bc3a		9d				                .byte %10011101
7942	>bc3b		b1				                .byte %10110001
7943	>bc3c		9d				                .byte %10011101
7944	>bc3d		c3				                .byte %11000011
7945	>bc3e		7e				                .byte %01111110
7946	>bc3f		00				                .byte %00000000
7947							                .endif

7949							                ; CHR$136
7950	>bc40		00				                .byte %00000000
7951	>bc41		18				                .byte %00011000
7952	>bc42		38				                .byte %00111000
7953	>bc43		7f				                .byte %01111111
7954	>bc44		38				                .byte %00111000
7955	>bc45		18				                .byte %00011000
7956	>bc46		00				                .byte %00000000
7957	>bc47		00				                .byte %00000000

7959							                ; CHR$137
7960	>bc48		00				                .byte %00000000
7961	>bc49		18				                .byte %00011000
7962	>bc4a		1c				                .byte %00011100
7963	>bc4b		fe				                .byte %11111110
7964	>bc4c		1c				                .byte %00011100
7965	>bc4d		18				                .byte %00011000
7966	>bc4e		00				                .byte %00000000
7967	>bc4f		00				                .byte %00000000

7969							                ; CHR$138
7970	>bc50		18				                .byte %00011000
7971	>bc51		18				                .byte %00011000
7972	>bc52		18				                .byte %00011000
7973	>bc53		18				                .byte %00011000
7974	>bc54		7e				                .byte %01111110
7975	>bc55		3c				                .byte %00111100
7976	>bc56		18				                .byte %00011000
7977	>bc57		00				                .byte %00000000

7979							                ; CHR$139
7980	>bc58		00				                .byte %00000000
7981	>bc59		18				                .byte %00011000
7982	>bc5a		3c				                .byte %00111100
7983	>bc5b		7e				                .byte %01111110
7984	>bc5c		18				                .byte %00011000
7985	>bc5d		18				                .byte %00011000
7986	>bc5e		18				                .byte %00011000
7987	>bc5f		18				                .byte %00011000

7989							                ; CHR$140
7990	>bc60		30				                .byte %00110000
7991	>bc61		18				                .byte %00011000
7992	>bc62		3c				                .byte %00111100
7993	>bc63		06				                .byte %00000110
7994	>bc64		3e				                .byte %00111110
7995	>bc65		66				                .byte %01100110
7996	>bc66		3e				                .byte %00111110
7997	>bc67		00				                .byte %00000000

7999							                ; CHR$141
8000	>bc68		30				                .byte %00110000
8001	>bc69		18				                .byte %00011000
8002	>bc6a		3c				                .byte %00111100
8003	>bc6b		66				                .byte %01100110
8004	>bc6c		7e				                .byte %01111110
8005	>bc6d		60				                .byte %01100000
8006	>bc6e		3c				                .byte %00111100
8007	>bc6f		00				                .byte %00000000

8009							                ; CHR$142
8010	>bc70		66				                .byte %01100110
8011	>bc71		00				                .byte %00000000
8012	>bc72		3c				                .byte %00111100
8013	>bc73		66				                .byte %01100110
8014	>bc74		7e				                .byte %01111110
8015	>bc75		60				                .byte %01100000
8016	>bc76		3c				                .byte %00111100
8017	>bc77		00				                .byte %00000000

8019							                ; CHR$143
8020	>bc78		3c				                .byte %00111100
8021	>bc79		66				                .byte %01100110
8022	>bc7a		3c				                .byte %00111100
8023	>bc7b		66				                .byte %01100110
8024	>bc7c		7e				                .byte %01111110
8025	>bc7d		60				                .byte %01100000
8026	>bc7e		3c				                .byte %00111100
8027	>bc7f		00				                .byte %00000000

8029							                ; CHR$144
8030	>bc80		66				                .byte %01100110
8031	>bc81		00				                .byte %00000000
8032	>bc82		3c				                .byte %00111100
8033	>bc83		06				                .byte %00000110
8034	>bc84		3e				                .byte %00111110
8035	>bc85		66				                .byte %01100110
8036	>bc86		3e				                .byte %00111110
8037	>bc87		00				                .byte %00000000

8039							                ; CHR$145
8040	>bc88		3c				                .byte %00111100
8041	>bc89		66				                .byte %01100110
8042	>bc8a		3c				                .byte %00111100
8043	>bc8b		06				                .byte %00000110
8044	>bc8c		3e				                .byte %00111110
8045	>bc8d		66				                .byte %01100110
8046	>bc8e		3e				                .byte %00111110
8047	>bc8f		00				                .byte %00000000

8049							                ; CHR$146
8050	>bc90		00				                .byte %00000000
8051	>bc91		00				                .byte %00000000
8052	>bc92		3f				                .byte %00111111
8053	>bc93		0d				                .byte %00001101
8054	>bc94		3f				                .byte %00111111
8055	>bc95		6c				                .byte %01101100
8056	>bc96		3f				                .byte %00111111
8057	>bc97		00				                .byte %00000000

8059							                ; CHR$147
8060	>bc98		00				                .byte %00000000
8061	>bc99		00				                .byte %00000000
8062	>bc9a		3c				                .byte %00111100
8063	>bc9b		66				                .byte %01100110
8064	>bc9c		60				                .byte %01100000
8065	>bc9d		66				                .byte %01100110
8066	>bc9e		3c				                .byte %00111100
8067	>bc9f		60				                .byte %01100000

8069							                ; CHR$148
8070	>bca0		0c				                .byte %00001100
8071	>bca1		18				                .byte %00011000
8072	>bca2		3c				                .byte %00111100
8073	>bca3		66				                .byte %01100110
8074	>bca4		7e				                .byte %01111110
8075	>bca5		60				                .byte %01100000
8076	>bca6		3c				                .byte %00111100
8077	>bca7		00				                .byte %00000000

8079							                ; CHR$149
8080							                .if version==350
8089							                .else
8090	>bca8		66				                .byte %01100110
8091	>bca9		00				                .byte %00000000
8092	>bcaa		3c				                .byte %00111100
8093	>bcab		66				                .byte %01100110
8094	>bcac		66				                .byte %01100110
8095	>bcad		66				                .byte %01100110
8096	>bcae		3c				                .byte %00111100
8097	>bcaf		00				                .byte %00000000
8098							                .endif

8100							                ; CHR$150
8101							                .if version==350
8110							                .else
8111	>bcb0		66				                .byte %01100110
8112	>bcb1		00				                .byte %00000000
8113	>bcb2		66				                .byte %01100110
8114	>bcb3		66				                .byte %01100110
8115	>bcb4		66				                .byte %01100110
8116	>bcb5		66				                .byte %01100110
8117	>bcb6		3e				                .byte %00111110
8118	>bcb7		00				                .byte %00000000
8119							                .endif

8121							                ; CHR$151
8122	>bcb8		30				                .byte %00110000
8123	>bcb9		18				                .byte %00011000
8124	>bcba		00				                .byte %00000000
8125	>bcbb		38				                .byte %00111000
8126	>bcbc		18				                .byte %00011000
8127	>bcbd		18				                .byte %00011000
8128	>bcbe		3c				                .byte %00111100
8129	>bcbf		00				                .byte %00000000

8131							                ; CHR$152
8132	>bcc0		3c				                .byte %00111100
8133	>bcc1		66				                .byte %01100110
8134	>bcc2		00				                .byte %00000000
8135	>bcc3		38				                .byte %00111000
8136	>bcc4		18				                .byte %00011000
8137	>bcc5		18				                .byte %00011000
8138	>bcc6		3c				                .byte %00111100
8139	>bcc7		00				                .byte %00000000

8141							                ; CHR$153
8142	>bcc8		30				                .byte %00110000
8143	>bcc9		18				                .byte %00011000
8144	>bcca		00				                .byte %00000000
8145	>bccb		3c				                .byte %00111100
8146	>bccc		66				                .byte %01100110
8147	>bccd		66				                .byte %01100110
8148	>bcce		3c				                .byte %00111100
8149	>bccf		00				                .byte %00000000

8151							                ; CHR$154
8152	>bcd0		3c				                .byte %00111100
8153	>bcd1		66				                .byte %01100110
8154	>bcd2		00				                .byte %00000000
8155	>bcd3		3c				                .byte %00111100
8156	>bcd4		66				                .byte %01100110
8157	>bcd5		66				                .byte %01100110
8158	>bcd6		3c				                .byte %00111100
8159	>bcd7		00				                .byte %00000000

8161							                ; CHR$155
8162	>bcd8		30				                .byte %00110000
8163	>bcd9		18				                .byte %00011000
8164	>bcda		00				                .byte %00000000
8165	>bcdb		66				                .byte %01100110
8166	>bcdc		66				                .byte %01100110
8167	>bcdd		66				                .byte %01100110
8168	>bcde		3e				                .byte %00111110
8169	>bcdf		00				                .byte %00000000

8171							                ; CHR$156
8172	>bce0		3c				                .byte %00111100
8173	>bce1		66				                .byte %01100110
8174	>bce2		00				                .byte %00000000
8175	>bce3		66				                .byte %01100110
8176	>bce4		66				                .byte %01100110
8177	>bce5		66				                .byte %01100110
8178	>bce6		3e				                .byte %00111110
8179	>bce7		00				                .byte %00000000

8181							                ; CHR$157
8182	>bce8		66				                .byte %01100110
8183	>bce9		00				                .byte %00000000
8184	>bcea		66				                .byte %01100110
8185	>bceb		66				                .byte %01100110
8186	>bcec		66				                .byte %01100110
8187	>bced		3e				                .byte %00111110
8188	>bcee		06				                .byte %00000110
8189	>bcef		3c				                .byte %00111100

8191							                ; CHR$158
8192	>bcf0		00				                .byte %00000000
8193	>bcf1		66				                .byte %01100110
8194	>bcf2		3c				                .byte %00111100
8195	>bcf3		66				                .byte %01100110
8196	>bcf4		66				                .byte %01100110
8197	>bcf5		3c				                .byte %00111100
8198	>bcf6		66				                .byte %01100110
8199	>bcf7		00				                .byte %00000000

8201							                ; CHR$159
8202	>bcf8		3c				                .byte %00111100
8203	>bcf9		60				                .byte %01100000
8204	>bcfa		3c				                .byte %00111100
8205	>bcfb		66				                .byte %01100110
8206	>bcfc		3c				                .byte %00111100
8207	>bcfd		06				                .byte %00000110
8208	>bcfe		3c				                .byte %00111100
8209	>bcff		00				                .byte %00000000

8211							                ; CHR$160
8212	>bd00		3c				                .byte %00111100
8213	>bd01		66				                .byte %01100110
8214	>bd02		3c				                .byte %00111100
8215	>bd03		00				                .byte %00000000
8216	>bd04		00				                .byte %00000000
8217	>bd05		00				                .byte %00000000
8218	>bd06		00				                .byte %00000000
8219	>bd07		00				                .byte %00000000

8221							                ; CHR$161
8222	>bd08		00				                .byte %00000000
8223	>bd09		00				                .byte %00000000
8224	>bd0a		00				                .byte %00000000
8225	>bd0b		18				                .byte %00011000
8226	>bd0c		18				                .byte %00011000
8227	>bd0d		18				                .byte %00011000
8228	>bd0e		18				                .byte %00011000
8229	>bd0f		18				                .byte %00011000

8231							                ; CHR$162
8232	>bd10		00				                .byte %00000000
8233	>bd11		00				                .byte %00000000
8234	>bd12		00				                .byte %00000000
8235	>bd13		1f				                .byte %00011111
8236	>bd14		00				                .byte %00000000
8237	>bd15		00				                .byte %00000000
8238	>bd16		00				                .byte %00000000
8239	>bd17		00				                .byte %00000000

8241							                ; CHR$163
8242	>bd18		00				                .byte %00000000
8243	>bd19		00				                .byte %00000000
8244	>bd1a		00				                .byte %00000000
8245	>bd1b		1f				                .byte %00011111
8246	>bd1c		18				                .byte %00011000
8247	>bd1d		18				                .byte %00011000
8248	>bd1e		18				                .byte %00011000
8249	>bd1f		18				                .byte %00011000

8251							                ; CHR$164
8252	>bd20		00				                .byte %00000000
8253	>bd21		00				                .byte %00000000
8254	>bd22		00				                .byte %00000000
8255	>bd23		f8				                .byte %11111000
8256	>bd24		00				                .byte %00000000
8257	>bd25		00				                .byte %00000000
8258	>bd26		00				                .byte %00000000
8259	>bd27		00				                .byte %00000000

8261							                ; CHR$165
8262	>bd28		00				                .byte %00000000
8263	>bd29		00				                .byte %00000000
8264	>bd2a		00				                .byte %00000000
8265	>bd2b		f8				                .byte %11111000
8266	>bd2c		18				                .byte %00011000
8267	>bd2d		18				                .byte %00011000
8268	>bd2e		18				                .byte %00011000
8269	>bd2f		18				                .byte %00011000

8271							                ; CHR$166
8272	>bd30		00				                .byte %00000000
8273	>bd31		00				                .byte %00000000
8274	>bd32		00				                .byte %00000000
8275	>bd33		ff				                .byte %11111111
8276	>bd34		00				                .byte %00000000
8277	>bd35		00				                .byte %00000000
8278	>bd36		00				                .byte %00000000
8279	>bd37		00				                .byte %00000000

8281							                ; CHR$167
8282	>bd38		00				                .byte %00000000
8283	>bd39		00				                .byte %00000000
8284	>bd3a		00				                .byte %00000000
8285	>bd3b		ff				                .byte %11111111
8286	>bd3c		18				                .byte %00011000
8287	>bd3d		18				                .byte %00011000
8288	>bd3e		18				                .byte %00011000
8289	>bd3f		18				                .byte %00011000

8291							                ; CHR$168
8292	>bd40		18				                .byte %00011000
8293	>bd41		18				                .byte %00011000
8294	>bd42		18				                .byte %00011000
8295	>bd43		18				                .byte %00011000
8296	>bd44		00				                .byte %00000000
8297	>bd45		00				                .byte %00000000
8298	>bd46		00				                .byte %00000000
8299	>bd47		00				                .byte %00000000

8301							                ; CHR$169
8302	>bd48		18				                .byte %00011000
8303	>bd49		18				                .byte %00011000
8304	>bd4a		18				                .byte %00011000
8305	>bd4b		18				                .byte %00011000
8306	>bd4c		18				                .byte %00011000
8307	>bd4d		18				                .byte %00011000
8308	>bd4e		18				                .byte %00011000
8309	>bd4f		18				                .byte %00011000

8311							                ; CHR$170
8312	>bd50		18				                .byte %00011000
8313	>bd51		18				                .byte %00011000
8314	>bd52		18				                .byte %00011000
8315	>bd53		1f				                .byte %00011111
8316	>bd54		00				                .byte %00000000
8317	>bd55		00				                .byte %00000000
8318	>bd56		00				                .byte %00000000
8319	>bd57		00				                .byte %00000000

8321							                ; CHR$171
8322	>bd58		18				                .byte %00011000
8323	>bd59		18				                .byte %00011000
8324	>bd5a		18				                .byte %00011000
8325	>bd5b		1f				                .byte %00011111
8326	>bd5c		18				                .byte %00011000
8327	>bd5d		18				                .byte %00011000
8328	>bd5e		18				                .byte %00011000
8329	>bd5f		18				                .byte %00011000

8331							                ; CHR$172
8332	>bd60		18				                .byte %00011000
8333	>bd61		18				                .byte %00011000
8334	>bd62		18				                .byte %00011000
8335	>bd63		f8				                .byte %11111000
8336	>bd64		00				                .byte %00000000
8337	>bd65		00				                .byte %00000000
8338	>bd66		00				                .byte %00000000
8339	>bd67		00				                .byte %00000000

8341							                ; CHR$173
8342	>bd68		18				                .byte %00011000
8343	>bd69		18				                .byte %00011000
8344	>bd6a		18				                .byte %00011000
8345	>bd6b		f8				                .byte %11111000
8346	>bd6c		18				                .byte %00011000
8347	>bd6d		18				                .byte %00011000
8348	>bd6e		18				                .byte %00011000
8349	>bd6f		18				                .byte %00011000

8351							                ; CHR$174
8352	>bd70		18				                .byte %00011000
8353	>bd71		18				                .byte %00011000
8354	>bd72		18				                .byte %00011000
8355	>bd73		ff				                .byte %11111111
8356	>bd74		00				                .byte %00000000
8357	>bd75		00				                .byte %00000000
8358	>bd76		00				                .byte %00000000
8359	>bd77		00				                .byte %00000000

8361							                ; CHR$175
8362	>bd78		18				                .byte %00011000
8363	>bd79		18				                .byte %00011000
8364	>bd7a		18				                .byte %00011000
8365	>bd7b		ff				                .byte %11111111
8366	>bd7c		18				                .byte %00011000
8367	>bd7d		18				                .byte %00011000
8368	>bd7e		18				                .byte %00011000
8369	>bd7f		18				                .byte %00011000

8371							                ; CHR$176
8372	>bd80		00				                .byte %00000000
8373	>bd81		00				                .byte %00000000
8374	>bd82		00				                .byte %00000000
8375	>bd83		07				                .byte %00000111
8376	>bd84		0c				                .byte %00001100
8377	>bd85		18				                .byte %00011000
8378	>bd86		18				                .byte %00011000
8379	>bd87		18				                .byte %00011000

8381							                ; CHR$177
8382	>bd88		00				                .byte %00000000
8383	>bd89		00				                .byte %00000000
8384	>bd8a		00				                .byte %00000000
8385	>bd8b		e0				                .byte %11100000
8386	>bd8c		30				                .byte %00110000
8387	>bd8d		18				                .byte %00011000
8388	>bd8e		18				                .byte %00011000
8389	>bd8f		18				                .byte %00011000

8391							                ; CHR$178
8392	>bd90		18				                .byte %00011000
8393	>bd91		18				                .byte %00011000
8394	>bd92		0c				                .byte %00001100
8395	>bd93		07				                .byte %00000111
8396	>bd94		00				                .byte %00000000
8397	>bd95		00				                .byte %00000000
8398	>bd96		00				                .byte %00000000
8399	>bd97		00				                .byte %00000000

8401							                ; CHR$179
8402	>bd98		18				                .byte %00011000
8403	>bd99		18				                .byte %00011000
8404	>bd9a		30				                .byte %00110000
8405	>bd9b		e0				                .byte %11100000
8406	>bd9c		00				                .byte %00000000
8407	>bd9d		00				                .byte %00000000
8408	>bd9e		00				                .byte %00000000
8409	>bd9f		00				                .byte %00000000

8411							                ; CHR$180
8412	>bda0		18				                .byte %00011000
8413	>bda1		00				                .byte %00000000
8414	>bda2		18				                .byte %00011000
8415	>bda3		18				                .byte %00011000
8416	>bda4		30				                .byte %00110000
8417	>bda5		66				                .byte %01100110
8418	>bda6		3c				                .byte %00111100
8419	>bda7		00				                .byte %00000000

8421							                ; CHR$181
8422	>bda8		18				                .byte %00011000
8423	>bda9		00				                .byte %00000000
8424	>bdaa		18				                .byte %00011000
8425	>bdab		18				                .byte %00011000
8426	>bdac		18				                .byte %00011000
8427	>bdad		18				                .byte %00011000
8428	>bdae		18				                .byte %00011000
8429	>bdaf		00				                .byte %00000000

8431							                ; CHR$182
8432	>bdb0		36				                .byte %00110110
8433	>bdb1		6c				                .byte %01101100
8434	>bdb2		00				                .byte %00000000
8435	>bdb3		66				                .byte %01100110
8436	>bdb4		76				                .byte %01110110
8437	>bdb5		6e				                .byte %01101110
8438	>bdb6		66				                .byte %01100110
8439	>bdb7		00				                .byte %00000000

8441							                ; CHR$183
8442	>bdb8		36				                .byte %00110110
8443	>bdb9		6c				                .byte %01101100
8444	>bdba		00				                .byte %00000000
8445	>bdbb		7c				                .byte %01111100
8446	>bdbc		66				                .byte %01100110
8447	>bdbd		66				                .byte %01100110
8448	>bdbe		66				                .byte %01100110
8449	>bdbf		00				                .byte %00000000

8451							                ; CHR$184
8452	>bdc0		18				                .byte %00011000
8453	>bdc1		7e				                .byte %01111110
8454	>bdc2		18				                .byte %00011000
8455	>bdc3		18				                .byte %00011000
8456	>bdc4		18				                .byte %00011000
8457	>bdc5		18				                .byte %00011000
8458	>bdc6		18				                .byte %00011000
8459	>bdc7		00				                .byte %00000000

8461							                ; CHR$185
8462	>bdc8		18				                .byte %00011000
8463	>bdc9		7e				                .byte %01111110
8464	>bdca		18				                .byte %00011000
8465	>bdcb		18				                .byte %00011000
8466	>bdcc		18				                .byte %00011000
8467	>bdcd		7e				                .byte %01111110
8468	>bdce		18				                .byte %00011000
8469	>bdcf		00				                .byte %00000000

8471							                ; CHR$186
8472							                .if version==350
8481							                .else
8482	>bdd0		18				                .byte %00011000
8483	>bdd1		18				                .byte %00011000
8484	>bdd2		18				                .byte %00011000
8485	>bdd3		00				                .byte %00000000
8486	>bdd4		00				                .byte %00000000
8487	>bdd5		00				                .byte %00000000
8488	>bdd6		00				                .byte %00000000
8489	>bdd7		00				                .byte %00000000
8490							                .endif

8492							                ; CHR$187
8493							                .if version==350
8502							                .else
8503	>bdd8		30				                .byte %00110000
8504	>bdd9		18				                .byte %00011000
8505	>bdda		0c				                .byte %00001100
8506	>bddb		00				                .byte %00000000
8507	>bddc		00				                .byte %00000000
8508	>bddd		00				                .byte %00000000
8509	>bdde		00				                .byte %00000000
8510	>bddf		00				                .byte %00000000
8511							                .endif

8513							                ; CHR$188
8514							                .if version==350
8523							                .else
8524	>bde0		3f				                .byte %00111111
8525	>bde1		7b				                .byte %01111011
8526	>bde2		7b				                .byte %01111011
8527	>bde3		3b				                .byte %00111011
8528	>bde4		1b				                .byte %00011011
8529	>bde5		1b				                .byte %00011011
8530	>bde6		1f				                .byte %00011111
8531	>bde7		00				                .byte %00000000
8532							                .endif

8534							                ; CHR$189
8535	>bde8		00				                .byte %00000000
8536	>bde9		00				                .byte %00000000
8537	>bdea		00				                .byte %00000000
8538	>bdeb		18				                .byte %00011000
8539	>bdec		18				                .byte %00011000
8540	>bded		00				                .byte %00000000
8541	>bdee		00				                .byte %00000000
8542	>bdef		00				                .byte %00000000

8544							                ; CHR$190
8545	>bdf0		03				                .byte %00000011
8546	>bdf1		03				                .byte %00000011
8547	>bdf2		06				                .byte %00000110
8548	>bdf3		06				                .byte %00000110
8549	>bdf4		76				                .byte %01110110
8550	>bdf5		1c				                .byte %00011100
8551	>bdf6		0c				                .byte %00001100
8552	>bdf7		00				                .byte %00000000

8554							                ; CHR$191
8555	>bdf8		aa				                .byte %10101010
8556	>bdf9		55				                .byte %01010101
8557	>bdfa		aa				                .byte %10101010
8558	>bdfb		55				                .byte %01010101
8559	>bdfc		aa				                .byte %10101010
8560	>bdfd		55				                .byte %01010101
8561	>bdfe		aa				                .byte %10101010
8562	>bdff		55				                .byte %01010101

8564							                ; CHR$192
8565	>be00		3e				                .byte %00111110
8566	>be01		63				                .byte %01100011
8567	>be02		67				                .byte %01100111
8568	>be03		6b				                .byte %01101011
8569	>be04		73				                .byte %01110011
8570	>be05		63				                .byte %01100011
8571	>be06		3e				                .byte %00111110
8572	>be07		00				                .byte %00000000

8574							                ; CHR$193
8575	>be08		1c				                .byte %00011100
8576	>be09		36				                .byte %00110110
8577	>be0a		63				                .byte %01100011
8578	>be0b		63				                .byte %01100011
8579	>be0c		7f				                .byte %01111111
8580	>be0d		63				                .byte %01100011
8581	>be0e		63				                .byte %01100011
8582	>be0f		00				                .byte %00000000

8584							                ; CHR$194
8585	>be10		7e				                .byte %01111110
8586	>be11		33				                .byte %00110011
8587	>be12		33				                .byte %00110011
8588	>be13		3e				                .byte %00111110
8589	>be14		33				                .byte %00110011
8590	>be15		33				                .byte %00110011
8591	>be16		7e				                .byte %01111110
8592	>be17		00				                .byte %00000000

8594							                ; CHR$195
8595	>be18		7f				                .byte %01111111
8596	>be19		63				                .byte %01100011
8597	>be1a		60				                .byte %01100000
8598	>be1b		60				                .byte %01100000
8599	>be1c		60				                .byte %01100000
8600	>be1d		60				                .byte %01100000
8601	>be1e		60				                .byte %01100000
8602	>be1f		00				                .byte %00000000

8604							                ; CHR$196
8605	>be20		1c				                .byte %00011100
8606	>be21		1c				                .byte %00011100
8607	>be22		36				                .byte %00110110
8608	>be23		36				                .byte %00110110
8609	>be24		63				                .byte %01100011
8610	>be25		63				                .byte %01100011
8611	>be26		7f				                .byte %01111111
8612	>be27		00				                .byte %00000000

8614							                ; CHR$197
8615	>be28		7f				                .byte %01111111
8616	>be29		33				                .byte %00110011
8617	>be2a		30				                .byte %00110000
8618	>be2b		3e				                .byte %00111110
8619	>be2c		30				                .byte %00110000
8620	>be2d		33				                .byte %00110011
8621	>be2e		7f				                .byte %01111111
8622	>be2f		00				                .byte %00000000

8624							                ; CHR$198
8625	>be30		7e				                .byte %01111110
8626	>be31		66				                .byte %01100110
8627	>be32		0c				                .byte %00001100
8628	>be33		18				                .byte %00011000
8629	>be34		30				                .byte %00110000
8630	>be35		66				                .byte %01100110
8631	>be36		7e				                .byte %01111110
8632	>be37		00				                .byte %00000000

8634							                ; CHR$199
8635	>be38		77				                .byte %01110111
8636	>be39		33				                .byte %00110011
8637	>be3a		33				                .byte %00110011
8638	>be3b		3f				                .byte %00111111
8639	>be3c		33				                .byte %00110011
8640	>be3d		33				                .byte %00110011
8641	>be3e		77				                .byte %01110111
8642	>be3f		00				                .byte %00000000

8644							                ; CHR$200
8645	>be40		3e				                .byte %00111110
8646	>be41		63				                .byte %01100011
8647	>be42		63				                .byte %01100011
8648	>be43		7f				                .byte %01111111
8649	>be44		63				                .byte %01100011
8650	>be45		63				                .byte %01100011
8651	>be46		3e				                .byte %00111110
8652	>be47		00				                .byte %00000000

8654							                ; CHR$201
8655	>be48		3c				                .byte %00111100
8656	>be49		18				                .byte %00011000
8657	>be4a		18				                .byte %00011000
8658	>be4b		18				                .byte %00011000
8659	>be4c		18				                .byte %00011000
8660	>be4d		18				                .byte %00011000
8661	>be4e		3c				                .byte %00111100
8662	>be4f		00				                .byte %00000000

8664							                ; CHR$202
8665	>be50		63				                .byte %01100011
8666	>be51		66				                .byte %01100110
8667	>be52		6c				                .byte %01101100
8668	>be53		78				                .byte %01111000
8669	>be54		6c				                .byte %01101100
8670	>be55		66				                .byte %01100110
8671	>be56		63				                .byte %01100011
8672	>be57		00				                .byte %00000000

8674							                ; CHR$203
8675	>be58		1c				                .byte %00011100
8676	>be59		1c				                .byte %00011100
8677	>be5a		36				                .byte %00110110
8678	>be5b		36				                .byte %00110110
8679	>be5c		63				                .byte %01100011
8680	>be5d		63				                .byte %01100011
8681	>be5e		63				                .byte %01100011
8682	>be5f		00				                .byte %00000000

8684							                ; CHR$204
8685	>be60		63				                .byte %01100011
8686	>be61		77				                .byte %01110111
8687	>be62		7f				                .byte %01111111
8688	>be63		6b				                .byte %01101011
8689	>be64		63				                .byte %01100011
8690	>be65		63				                .byte %01100011
8691	>be66		63				                .byte %01100011
8692	>be67		00				                .byte %00000000

8694							                ; CHR$205
8695	>be68		63				                .byte %01100011
8696	>be69		73				                .byte %01110011
8697	>be6a		7b				                .byte %01111011
8698	>be6b		6f				                .byte %01101111
8699	>be6c		67				                .byte %01100111
8700	>be6d		63				                .byte %01100011
8701	>be6e		63				                .byte %01100011
8702	>be6f		00				                .byte %00000000

8704							                ; CHR$206
8705	>be70		7e				                .byte %01111110
8706	>be71		00				                .byte %00000000
8707	>be72		00				                .byte %00000000
8708	>be73		3c				                .byte %00111100
8709	>be74		00				                .byte %00000000
8710	>be75		00				                .byte %00000000
8711	>be76		7e				                .byte %01111110
8712	>be77		00				                .byte %00000000

8714							                ; CHR$207
8715	>be78		3e				                .byte %00111110
8716	>be79		63				                .byte %01100011
8717	>be7a		63				                .byte %01100011
8718	>be7b		63				                .byte %01100011
8719	>be7c		63				                .byte %01100011
8720	>be7d		63				                .byte %01100011
8721	>be7e		3e				                .byte %00111110
8722	>be7f		00				                .byte %00000000

8724							                ; CHR$208
8725	>be80		7f				                .byte %01111111
8726	>be81		36				                .byte %00110110
8727	>be82		36				                .byte %00110110
8728	>be83		36				                .byte %00110110
8729	>be84		36				                .byte %00110110
8730	>be85		36				                .byte %00110110
8731	>be86		36				                .byte %00110110
8732	>be87		00				                .byte %00000000

8734							                ; CHR$209
8735	>be88		7e				                .byte %01111110
8736	>be89		33				                .byte %00110011
8737	>be8a		33				                .byte %00110011
8738	>be8b		3e				                .byte %00111110
8739	>be8c		30				                .byte %00110000
8740	>be8d		30				                .byte %00110000
8741	>be8e		78				                .byte %01111000
8742	>be8f		00				                .byte %00000000

8744							                ; CHR$210
8745	>be90		7f				                .byte %01111111
8746	>be91		63				                .byte %01100011
8747	>be92		30				                .byte %00110000
8748	>be93		18				                .byte %00011000
8749	>be94		30				                .byte %00110000
8750	>be95		63				                .byte %01100011
8751	>be96		7f				                .byte %01111111
8752	>be97		00				                .byte %00000000

8754							                ; CHR$211
8755	>be98		7e				                .byte %01111110
8756	>be99		5a				                .byte %01011010
8757	>be9a		18				                .byte %00011000
8758	>be9b		18				                .byte %00011000
8759	>be9c		18				                .byte %00011000
8760	>be9d		18				                .byte %00011000
8761	>be9e		18				                .byte %00011000
8762	>be9f		00				                .byte %00000000

8764							                ; CHR$212
8765	>bea0		66				                .byte %01100110
8766	>bea1		66				                .byte %01100110
8767	>bea2		66				                .byte %01100110
8768	>bea3		3c				                .byte %00111100
8769	>bea4		18				                .byte %00011000
8770	>bea5		18				                .byte %00011000
8771	>bea6		3c				                .byte %00111100
8772	>bea7		00				                .byte %00000000

8774							                ; CHR$213
8775	>bea8		3e				                .byte %00111110
8776	>bea9		08				                .byte %00001000
8777	>beaa		3e				                .byte %00111110
8778	>beab		6b				                .byte %01101011
8779	>beac		3e				                .byte %00111110
8780	>bead		08				                .byte %00001000
8781	>beae		3e				                .byte %00111110
8782	>beaf		00				                .byte %00000000

8784							                ; CHR$214
8785	>beb0		63				                .byte %01100011
8786	>beb1		63				                .byte %01100011
8787	>beb2		36				                .byte %00110110
8788	>beb3		1c				                .byte %00011100
8789	>beb4		36				                .byte %00110110
8790	>beb5		63				                .byte %01100011
8791	>beb6		63				                .byte %01100011
8792	>beb7		00				                .byte %00000000

8794							                ; CHR$215
8795	>beb8		3e				                .byte %00111110
8796	>beb9		08				                .byte %00001000
8797	>beba		6b				                .byte %01101011
8798	>bebb		6b				                .byte %01101011
8799	>bebc		3e				                .byte %00111110
8800	>bebd		08				                .byte %00001000
8801	>bebe		3e				                .byte %00111110
8802	>bebf		00				                .byte %00000000

8804							                ; CHR$216
8805	>bec0		3e				                .byte %00111110
8806	>bec1		63				                .byte %01100011
8807	>bec2		63				                .byte %01100011
8808	>bec3		63				                .byte %01100011
8809	>bec4		36				                .byte %00110110
8810	>bec5		36				                .byte %00110110
8811	>bec6		63				                .byte %01100011
8812	>bec7		00				                .byte %00000000

8814							                ; CHR$217
8815	>bec8		7f				                .byte %01111111
8816	>bec9		63				                .byte %01100011
8817	>beca		63				                .byte %01100011
8818	>becb		36				                .byte %00110110
8819	>becc		36				                .byte %00110110
8820	>becd		1c				                .byte %00011100
8821	>bece		1c				                .byte %00011100
8822	>becf		00				                .byte %00000000

8824							                ; CHR$218
8825	>bed0		18				                .byte %00011000
8826	>bed1		18				                .byte %00011000
8827	>bed2		7e				                .byte %01111110
8828	>bed3		18				                .byte %00011000
8829	>bed4		18				                .byte %00011000
8830	>bed5		00				                .byte %00000000
8831	>bed6		7e				                .byte %01111110
8832	>bed7		00				                .byte %00000000

8834							                ; CHR$219
8835	>bed8		00				                .byte %00000000
8836	>bed9		7e				                .byte %01111110
8837	>beda		00				                .byte %00000000
8838	>bedb		18				                .byte %00011000
8839	>bedc		18				                .byte %00011000
8840	>bedd		7e				                .byte %01111110
8841	>bede		18				                .byte %00011000
8842	>bedf		18				                .byte %00011000

8844							                ; CHR$220
8845	>bee0		18				                .byte %00011000
8846	>bee1		18				                .byte %00011000
8847	>bee2		18				                .byte %00011000
8848	>bee3		18				                .byte %00011000
8849	>bee4		18				                .byte %00011000
8850	>bee5		18				                .byte %00011000
8851	>bee6		18				                .byte %00011000
8852	>bee7		00				                .byte %00000000

8854							                ; CHR$221
8855	>bee8		36				                .byte %00110110
8856	>bee9		36				                .byte %00110110
8857	>beea		36				                .byte %00110110
8858	>beeb		36				                .byte %00110110
8859	>beec		36				                .byte %00110110
8860	>beed		36				                .byte %00110110
8861	>beee		36				                .byte %00110110
8862	>beef		00				                .byte %00000000

8864							                ; CHR$222
8865	>bef0		00				                .byte %00000000
8866	>bef1		66				                .byte %01100110
8867	>bef2		66				                .byte %01100110
8868	>bef3		66				                .byte %01100110
8869	>bef4		66				                .byte %01100110
8870	>bef5		66				                .byte %01100110
8871	>bef6		3c				                .byte %00111100
8872	>bef7		00				                .byte %00000000

8874							                ; CHR$223
8875	>bef8		00				                .byte %00000000
8876	>bef9		3c				                .byte %00111100
8877	>befa		66				                .byte %01100110
8878	>befb		66				                .byte %01100110
8879	>befc		66				                .byte %01100110
8880	>befd		66				                .byte %01100110
8881	>befe		66				                .byte %01100110
8882	>beff		00				                .byte %00000000

8884							                ; CHR$224
8885							                .if version==350
8894							                .else
8895	>bf00		00				                .byte %00000000
8896	>bf01		03				                .byte %00000011
8897	>bf02		3e				                .byte %00111110
8898	>bf03		67				                .byte %01100111
8899	>bf04		6b				                .byte %01101011
8900	>bf05		73				                .byte %01110011
8901	>bf06		3e				                .byte %00111110
8902	>bf07		60				                .byte %01100000
8903							                .endif

8905							                ; CHR$225
8906	>bf08		00				                .byte %00000000
8907	>bf09		00				                .byte %00000000
8908	>bf0a		3b				                .byte %00111011
8909	>bf0b		6e				                .byte %01101110
8910	>bf0c		66				                .byte %01100110
8911	>bf0d		6e				                .byte %01101110
8912	>bf0e		3b				                .byte %00111011
8913	>bf0f		00				                .byte %00000000

8915							                ; CHR$226
8916	>bf10		1e				                .byte %00011110
8917	>bf11		33				                .byte %00110011
8918	>bf12		33				                .byte %00110011
8919	>bf13		3e				                .byte %00111110
8920	>bf14		33				                .byte %00110011
8921	>bf15		33				                .byte %00110011
8922	>bf16		3e				                .byte %00111110
8923	>bf17		60				                .byte %01100000

8925							                ; CHR$227
8926	>bf18		00				                .byte %00000000
8927	>bf19		00				                .byte %00000000
8928	>bf1a		66				                .byte %01100110
8929	>bf1b		36				                .byte %00110110
8930	>bf1c		1c				                .byte %00011100
8931	>bf1d		18				                .byte %00011000
8932	>bf1e		30				                .byte %00110000
8933	>bf1f		30				                .byte %00110000

8935							                ; CHR$228
8936	>bf20		3c				                .byte %00111100
8937	>bf21		60				                .byte %01100000
8938	>bf22		30				                .byte %00110000
8939	>bf23		3c				                .byte %00111100
8940	>bf24		66				                .byte %01100110
8941	>bf25		66				                .byte %01100110
8942	>bf26		3c				                .byte %00111100
8943	>bf27		00				                .byte %00000000

8945							                ; CHR$229
8946	>bf28		00				                .byte %00000000
8947	>bf29		00				                .byte %00000000
8948	>bf2a		1e				                .byte %00011110
8949	>bf2b		30				                .byte %00110000
8950	>bf2c		1c				                .byte %00011100
8951	>bf2d		30				                .byte %00110000
8952	>bf2e		1e				                .byte %00011110
8953	>bf2f		00				                .byte %00000000

8955							                ; CHR$230
8956	>bf30		3e				                .byte %00111110
8957	>bf31		0c				                .byte %00001100
8958	>bf32		18				                .byte %00011000
8959	>bf33		30				                .byte %00110000
8960	>bf34		60				                .byte %01100000
8961	>bf35		60				                .byte %01100000
8962	>bf36		3e				                .byte %00111110
8963	>bf37		06				                .byte %00000110

8965							                ; CHR$231
8966	>bf38		00				                .byte %00000000
8967	>bf39		00				                .byte %00000000
8968	>bf3a		7c				                .byte %01111100
8969	>bf3b		66				                .byte %01100110
8970	>bf3c		66				                .byte %01100110
8971	>bf3d		66				                .byte %01100110
8972	>bf3e		06				                .byte %00000110
8973	>bf3f		06				                .byte %00000110

8975							                ; CHR$232
8976	>bf40		3c				                .byte %00111100
8977	>bf41		66				                .byte %01100110
8978	>bf42		66				                .byte %01100110
8979	>bf43		7e				                .byte %01111110
8980	>bf44		66				                .byte %01100110
8981	>bf45		66				                .byte %01100110
8982	>bf46		3c				                .byte %00111100
8983	>bf47		00				                .byte %00000000

8985							                ; CHR$233
8986	>bf48		00				                .byte %00000000
8987	>bf49		00				                .byte %00000000
8988	>bf4a		18				                .byte %00011000
8989	>bf4b		18				                .byte %00011000
8990	>bf4c		18				                .byte %00011000
8991	>bf4d		18				                .byte %00011000
8992	>bf4e		0c				                .byte %00001100
8993	>bf4f		00				                .byte %00000000

8995							                ; CHR$234
8996	>bf50		00				                .byte %00000000
8997	>bf51		00				                .byte %00000000
8998	>bf52		66				                .byte %01100110
8999	>bf53		6c				                .byte %01101100
9000	>bf54		78				                .byte %01111000
9001	>bf55		6c				                .byte %01101100
9002	>bf56		66				                .byte %01100110
9003	>bf57		00				                .byte %00000000

9005							                ; CHR$235
9006	>bf58		60				                .byte %01100000
9007	>bf59		30				                .byte %00110000
9008	>bf5a		18				                .byte %00011000
9009	>bf5b		1c				                .byte %00011100
9010	>bf5c		36				                .byte %00110110
9011	>bf5d		63				                .byte %01100011
9012	>bf5e		63				                .byte %01100011
9013	>bf5f		00				                .byte %00000000

9015							                ; CHR$236
9016	>bf60		00				                .byte %00000000
9017	>bf61		00				                .byte %00000000
9018	>bf62		33				                .byte %00110011
9019	>bf63		33				                .byte %00110011
9020	>bf64		33				                .byte %00110011
9021	>bf65		33				                .byte %00110011
9022	>bf66		3e				                .byte %00111110
9023	>bf67		60				                .byte %01100000

9025							                ; CHR$237
9026	>bf68		00				                .byte %00000000
9027	>bf69		00				                .byte %00000000
9028	>bf6a		63				                .byte %01100011
9029	>bf6b		33				                .byte %00110011
9030	>bf6c		1b				                .byte %00011011
9031	>bf6d		1e				                .byte %00011110
9032	>bf6e		1c				                .byte %00011100
9033	>bf6f		00				                .byte %00000000

9035							                ; CHR$238
9036							                .if version==350
9045							                .else
9046	>bf70		3c				                .byte %00111100
9047	>bf71		60				                .byte %01100000
9048	>bf72		60				                .byte %01100000
9049	>bf73		3c				                .byte %00111100
9050	>bf74		60				                .byte %01100000
9051	>bf75		60				                .byte %01100000
9052	>bf76		3e				                .byte %00111110
9053	>bf77		06				                .byte %00000110
9054							                .endif

9056							                ; CHR$239
9057	>bf78		00				                .byte %00000000
9058	>bf79		00				                .byte %00000000
9059	>bf7a		3e				                .byte %00111110
9060	>bf7b		63				                .byte %01100011
9061	>bf7c		63				                .byte %01100011
9062	>bf7d		63				                .byte %01100011
9063	>bf7e		3e				                .byte %00111110
9064	>bf7f		00				                .byte %00000000

9066							                ; CHR$240
9067	>bf80		00				                .byte %00000000
9068	>bf81		00				                .byte %00000000
9069	>bf82		7f				                .byte %01111111
9070	>bf83		36				                .byte %00110110
9071	>bf84		36				                .byte %00110110
9072	>bf85		36				                .byte %00110110
9073	>bf86		36				                .byte %00110110
9074	>bf87		00				                .byte %00000000

9076							                ; CHR$241
9077	>bf88		00				                .byte %00000000
9078	>bf89		00				                .byte %00000000
9079	>bf8a		3c				                .byte %00111100
9080	>bf8b		66				                .byte %01100110
9081	>bf8c		66				                .byte %01100110
9082	>bf8d		7c				                .byte %01111100
9083	>bf8e		60				                .byte %01100000
9084	>bf8f		60				                .byte %01100000

9086							                ; CHR$242
9087	>bf90		00				                .byte %00000000
9088	>bf91		00				                .byte %00000000
9089	>bf92		3f				                .byte %00111111
9090	>bf93		66				                .byte %01100110
9091	>bf94		66				                .byte %01100110
9092	>bf95		66				                .byte %01100110
9093	>bf96		3c				                .byte %00111100
9094	>bf97		00				                .byte %00000000

9096							                ; CHR$243
9097	>bf98		00				                .byte %00000000
9098	>bf99		00				                .byte %00000000
9099	>bf9a		7e				                .byte %01111110
9100	>bf9b		18				                .byte %00011000
9101	>bf9c		18				                .byte %00011000
9102	>bf9d		18				                .byte %00011000
9103	>bf9e		0c				                .byte %00001100
9104	>bf9f		00				                .byte %00000000

9106							                ; CHR$244
9107	>bfa0		00				                .byte %00000000
9108	>bfa1		00				                .byte %00000000
9109	>bfa2		73				                .byte %01110011
9110	>bfa3		33				                .byte %00110011
9111	>bfa4		33				                .byte %00110011
9112	>bfa5		33				                .byte %00110011
9113	>bfa6		1e				                .byte %00011110
9114	>bfa7		00				                .byte %00000000

9116							                ; CHR$245
9117	>bfa8		00				                .byte %00000000
9118	>bfa9		00				                .byte %00000000
9119	>bfaa		3e				                .byte %00111110
9120	>bfab		6b				                .byte %01101011
9121	>bfac		6b				                .byte %01101011
9122	>bfad		3e				                .byte %00111110
9123	>bfae		18				                .byte %00011000
9124	>bfaf		18				                .byte %00011000

9126							                ; CHR$246
9127	>bfb0		00				                .byte %00000000
9128	>bfb1		00				                .byte %00000000
9129	>bfb2		66				                .byte %01100110
9130	>bfb3		36				                .byte %00110110
9131	>bfb4		1c				                .byte %00011100
9132	>bfb5		1c				                .byte %00011100
9133	>bfb6		36				                .byte %00110110
9134	>bfb7		33				                .byte %00110011

9136							                ; CHR$247
9137	>bfb8		00				                .byte %00000000
9138	>bfb9		00				                .byte %00000000
9139	>bfba		63				                .byte %01100011
9140	>bfbb		6b				                .byte %01101011
9141	>bfbc		6b				                .byte %01101011
9142	>bfbd		3e				                .byte %00111110
9143	>bfbe		18				                .byte %00011000
9144	>bfbf		18				                .byte %00011000

9146							                ; CHR$248
9147							                .if version==350
9156							                .else
9157	>bfc0		00				                .byte %00000000
9158	>bfc1		00				                .byte %00000000
9159	>bfc2		36				                .byte %00110110
9160	>bfc3		63				                .byte %01100011
9161	>bfc4		6b				                .byte %01101011
9162	>bfc5		7f				                .byte %01111111
9163	>bfc6		36				                .byte %00110110
9164	>bfc7		00				                .byte %00000000
9165							                .endif

9167							                ; CHR$249
9168	>bfc8		38				                .byte %00111000
9169	>bfc9		0c				                .byte %00001100
9170	>bfca		06				                .byte %00000110
9171	>bfcb		3e				                .byte %00111110
9172	>bfcc		66				                .byte %01100110
9173	>bfcd		66				                .byte %01100110
9174	>bfce		3c				                .byte %00111100
9175	>bfcf		00				                .byte %00000000

9177							                ; CHR$250
9178	>bfd0		00				                .byte %00000000
9179	>bfd1		31				                .byte %00110001
9180	>bfd2		6b				                .byte %01101011
9181	>bfd3		46				                .byte %01000110
9182	>bfd4		00				                .byte %00000000
9183	>bfd5		7f				                .byte %01111111
9184	>bfd6		00				                .byte %00000000
9185	>bfd7		00				                .byte %00000000

9187							                ; CHR$251
9188	>bfd8		00				                .byte %00000000
9189	>bfd9		7e				                .byte %01111110
9190	>bfda		00				                .byte %00000000
9191	>bfdb		7e				                .byte %01111110
9192	>bfdc		00				                .byte %00000000
9193	>bfdd		7e				                .byte %01111110
9194	>bfde		00				                .byte %00000000
9195	>bfdf		00				                .byte %00000000

9197							                ; CHR$252
9198	>bfe0		07				                .byte %00000111
9199	>bfe1		1c				                .byte %00011100
9200	>bfe2		70				                .byte %01110000
9201	>bfe3		1c				                .byte %00011100
9202	>bfe4		07				                .byte %00000111
9203	>bfe5		00				                .byte %00000000
9204	>bfe6		7f				                .byte %01111111
9205	>bfe7		00				                .byte %00000000

9207							                ; CHR$253
9208	>bfe8		06				                .byte %00000110
9209	>bfe9		0c				                .byte %00001100
9210	>bfea		7e				                .byte %01111110
9211	>bfeb		18				                .byte %00011000
9212	>bfec		7e				                .byte %01111110
9213	>bfed		30				                .byte %00110000
9214	>bfee		60				                .byte %01100000
9215	>bfef		00				                .byte %00000000

9217							                ; CHR$254
9218	>bff0		70				                .byte %01110000
9219	>bff1		1c				                .byte %00011100
9220	>bff2		07				                .byte %00000111
9221	>bff3		1c				                .byte %00011100
9222	>bff4		70				                .byte %01110000
9223	>bff5		00				                .byte %00000000
9224	>bff6		7f				                .byte %01111111
9225	>bff7		00				                .byte %00000000

9227							                ; CHR$255
9228	>bff8		ff				                .byte %11111111
9229	>bff9		ff				                .byte %11111111
9230	>bffa		ff				                .byte %11111111
9231	>bffb		ff				                .byte %11111111
9232	>bffc		ff				                .byte %11111111
9233	>bffd		ff				                .byte %11111111
9234	>bffe		ff				                .byte %11111111
9235	>bfff		ff				                .byte %11111111

9237							                .endblock



:1	;******  Return to file: mos320multios.s65

36							                .endsection

38							                .section mos
39							                .include "src/mos.s65"

:13	;******  Processing file: src/mos.s65

1							; -*- comment-column:45; -*-

3	.c000						mos: .block

5							; VDU driver entry block
6							; ======================
7	.c000						LC000:                                       ; Read from VDU memory
8	.c000		b1 d6		lda ($d6),y	                lda (ZMEMG),y
9	.c002		60		rts		                rts
10	.c003						LC003:                                       ; Write to VDU memory
11	.c003		91 d6		sta ($d6),y	                sta (ZMEMG),y
12	.c005		60		rts		                rts

14							; MasRef E.4-6
15							;
16							; JSR PLBYTE plots the mask held in ZMASK into the byte pointed to by
17							; (ZMEMG),y, using ZGORA and ZGEOR as colour masks. See GADDR below
18							; for an example of its use.
19							;
20							; PLBYTE uses ZTEMP as workspace and preserves X, Y, V and C.
21	.c006						PLBYTE:
22	.c006		4c 51 db	jmp $db51	                jmp plbyteEntryPoint

24							; MasRef E.4-6
25							;
26							; JSR HPLOT plots a fast horizontal line in the current graphics
27							; colour or ECF and the current graphics mode (all as set by VDU 18)
28							; between two specified points. It is the low level primitive used by
29							; all the MOS area fill commands.
30							;
31							; On entry, two 4 byte areas at &300+X and &300+Y contain the
32							; coordinates of the two endpoints, in the standard
33							; lowX,highX,lowY,highY order. Should the Y coordinates differ, the Y
34							; coordinate of the line plotted is taken from the leftmost of the two
35							; points specified.
36							;
37							; Only portions of the line inside the graphics window are plotted.
38							; Subject to this, both endpoints of the line are plotted.
39							;
40							; HPLOT uses ZGORA, ZGEOR, ZMASK, ZMEMG, ZTEMP (but not ZTEMP+1),
41							; ZTEMPB, ZTEMPB+1, ZTEMPC and ZTEMPC+1 as workspace. No registers or
42							; flags are preserved.
43	.c009						HPLOT:
44	.c009		4c e8 da	jmp $dae8	                jmp LDAE8

46							; MasRef E.4-6
47							;
48							; JSR EIGABS converts the 4 byte pair of external coordinates at
49							; &300+X where X>=2 (in standard lowX,highX,lowY,highY order) into the
50							; corresponding pair of pixel coordinates by offsetting by the
51							; graphics origin, then dividing by an appropriate power of 2.
52							;
53							; EIGABS uses ZTEMP as workspace, and corrupts all registers and
54							; flags.
55	.c00c						EIGABS:
56	.c00c		4c de d1	jmp $d1de	                jmp eigabsEntryPoint

58							; MasRef E.4-7
59							;
60							; JSR WIND windows the 4 byte pair of pixel coordinates (in standard
61							; lowX,highX,lowY,highY order) at &300+X, and returns a result in A
62							; according to its position with respect to the window:

64							; 9 | 8 | 10
65							; --+---+---
66							; 1 | 0 | 2
67							; --+---+---
68							; 5 | 4 | 6

70							; WIND uses ZTEMP as workspace, preserves X and sets N and Z according
71							; to A.
72	.c00f						WIND:
73	.c00f		4c a8 d1	jmp $d1a8	                jmp windEntryPoint

75							; MasRef E.4-7
76							;
77							; JSR GADDR addresses the pixel whose 4 byte pair of pixel coordinates
78							; (in standard lowX,highX,lowY,highY order) is at &300+X. GADDR should
79							; not be called without first ensuring (typically by means of WIND)
80							; that the point concerned does lie within the screen.
81							;
82							; GADDR initialises the following variables:
83							;
84							; . ZMEMG to the start of the page of memory containing the pixel.
85							;
86							; . Y and VDU variable &1A (i.e. location &31A) to contain the offset
87							; of the byte containing the pixel within this page â<80><93> i.e. (ZMEMG),y
88							; points to the byte containing the pixel.
89							;
90							; . ZMASK to a mask indicating which bits of this byte constitute the
91							; pixel.
92							;
93							; . ZGORA and ZGEOR to the correct colour masks for the current
94							; graphics plot mode (found in VDU variable &5A) and colour/ECF
95							;
96							; . X to Y MOD 7, i.e. the scan line within a character row of the
97							; pixel.
98							;
99							; Additionally, GADDR uses ZTEMP as workspace and returns A=0, Z=1.
100							;
101							; An example of the use of PLBYTE, WIND and GADDR is the following
102							; code, which effectively re-implements the VDU 25 64â<80><93>71 (plot a
103							; point) calls. It assumes that the routine addresses have been
104							; previously defined and that the graphics plot mode, etc. were set up
105							; by the VDU 25 code before the unknown PLOT codes vector was entered:

107							; .POINT
108							;  LDX #&20   ;Addresses new point within VDU queue, as
109							;             ;left on entry to the unknown PLOT codes
110							;             ;vector.
111							;  JSR WIND   ;Is the point inside the window?
112							;  BNE END    ;Return if not.
113							;  JSR GADDR  ;Address the point now we know it's on
114							;             ;screen.
115							;  JSR PLBYTE ;And plot the point.
116							; .END
117							;  RTS
118	.c012						GADDR:
119	.c012		4c c8 de	jmp $dec8	                jmp gaddrEntryPoint

121							; MasRef E.4-8
122							;
123							; JSR IEG takes the internal pixel coordinates of the graphics cursor
124							; (in VDU variables &24â<80><93>&27), converts it back to external coordinates
125							; and stores the result in VDU variables &10â<80><93>&13.
126							;
127							; It should be called whenever the graphics code generates a new
128							; graphics cursor position (e.g. in the VDU drivers, it is called
129							; after a character is printed in VDU 5 mode). Its purpose is to make
130							; the two versions of the graphics cursor agree again, and thus
131							; prevent errors occurring with relative plots.
132							;
133							; IEG uses no page zero locations and corrupts all registers and
134							; flags.
135	.c015						IEG:
136	.c015		4c df c4	jmp $c4df	                jmp LC4DF

138							;-------------------------------------------------------------------------

140	.c018						LC018:                                       ; Fetch byte from ROM Y
141	.c018		a6 f4		ldx $f4		                ldx $F4                      ; Get current ROM
142	.c01a		84 f4		sty $f4		                sty $F4                      ; Select ROM in Y
143	.c01c		8c 30 fe	sty $fe30	                sty ROMSEL
144	.c01f		b2 f6		lda ($f6)	                lda ($F6)                    ; Get byte with ROM Y paged in
145	.c021		4c 81 e5	jmp $e581	                jmp selectROMX                    ; Page in ROM X and return

147	.c024						LC024:
148	.c024		6c 5d 03	jmp ($035d)	                jmp ($035D)

150							;-------------------------------------------------------------------------
151							;
152							; VDU driver entry point
153							;
154							; Output to VDU.
155							;
156	.c027						outputToVDU:
157	.c027		ae 6a 02	ldx $026a	                ldx vduQueueNegativeLength  ;get VDU queue length
158	.c02a		f0 2d		beq $c059	                beq outputCharToVDU         ;taken if empty
159	.c02c		9d 24 02	sta $0224,x	                sta vduv.queueEnd-1-255,x   ;add to queue
160	.c02f		ee 6a 02	inc $026a	                inc vduQueueNegativeLength  ;one more in the queue...
161	.c032		f0 02		beq $c036	                beq outputQueueToVDU        ;taken if queue now filled
162	.c034						clc_rts_c034:
163	.c034		18		clc		                clc

165							;-------------------------------------------------------------------------
166							;
167							; VDU 0 (&00) Null [MasRef E.3-1]
168							; VDU 6 (&06) Enable VDU driver [MasRef E.3-3]
169							; VDU 27 (&1B) Null [MasRef E.3-34]
170							;
171	.c035						vdu0EntryPoint:
172	.c035						vdu6EntryPoint:
173	.c035						vdu27EntryPoint:
174	.c035						rtsC035:
175	.c035		60		rts		                rts

177							;-------------------------------------------------------------------------

179	.c036						outputQueueToVDU:
180	.c036		24 d0		bit $d0		                bit STATE
181	.c038		10 19		bpl $c053	                bpl LC053              ;branch taken if not VDU21 mode

183							                ; ????
184	.c03a		ac 5e 03	ldy $035e	                ldy vduv.jumpVector+1
185	.c03d		c0 c0		cpy #$c0	                cpy #>vdu1EntryPoint
186	.c03f		d0 f3		bne $c034	                bne clc_rts_c034
187	.c041		ac 5d 03	ldy $035d	                ldy vduv.jumpVector+0
188	.c044		c0 e2		cpy #$e2	                cpy #<vdu1EntryPoint
189	.c046		d0 ec		bne $c034	                bne clc_rts_c034

191	.c048						outputCharToPrinter:
192	.c048		aa		tax		                tax                          ;save char to print
193	.c049		a5 d0		lda $d0		                lda STATE
194	.c04b		4a		lsr a		                lsr a                       ;C set if isPrinterEnabled
195	.c04c		90 e7		bcc $c035	                bcc rtsC035 ;taken if printer disabled - VDU 1 then a no-op
196	.c04e		8a		txa		                txa                          ;restore char to print
197	.c04f		18		clc		                clc
198							                .if version<350
199	.c050		4c b9 e8	jmp $e8b9	                jmp LE8B9
202							                .endif

204	.c053						LC053:
205	.c053		20 fa c0	jsr $c0fa	                jsr stopCursorEditing
206	.c056		18		clc		                clc
207	.c057		80 67		bra $c0c0	                bra LC0C0

209	.c059						outputCharToVDU:
210	.c059		20 fa c0	jsr $c0fa	                jsr stopCursorEditing
211	.c05c		50 0f		bvc $c06d	                bvc LC06D             ;taken if not previously editing
212	.c05e		30 0d		bmi $c06d	                bmi LC06D             ;taken if VDU 21
213	.c060		c9 0d		cmp #$0d	                cmp #$0D
214	.c062		d0 09		bne $c06d	                bne LC06D                  ;taken if not printing a CR
215	.c064		48		pha		                pha                        ;save char to print
216	.c065		a9 42		lda #$42	                lda #STATE.isCursorEditing|STATE.isScrollingDisabled
217	.c067		14 d0		trb $d0		                trb STATE
218	.c069		20 50 cf	jsr $cf50	                jsr showCursor
219	.c06c		68		pla		                pla                          ;restore char to print
220	.c06d						LC06D:
221	.c06d		c9 20		cmp #$20	                cmp #$20
222	.c06f		90 06		bcc $c077	                bcc handleControlChar
223	.c071		c9 7f		cmp #$7f	                cmp #$7F
224	.c073		d0 21		bne $c096	                bne LC096                    ;taken if not backspace
225	.c075		a9 20		lda #$20	                lda #$20 ;backspace is entry 32 in the VDU routines table
226	.c077						handleControlChar:
227	.c077		a8		tay		                tay                          ;Y=index in table
228	.c078		b9 27 e0	lda $e027,y	                lda vduRoutinesLSBTable,y
229	.c07b		8d 5d 03	sta $035d	                sta vduv.jumpVector+0 ; Store jump address LSB (see MasRef E.4-3)
230	.c07e		b9 48 e0	lda $e048,y	                lda vduRoutinesMSBTable,y
231	.c081		30 30		bmi $c0b3	                bmi LC0B3           ;branch taken if MSB directly
232	.c083		aa		tax		                tax                          ; Save original MSB value
233	.c084		09 f0		ora #$f0	                ora #$F0
234	.c086		8d 6a 02	sta $026a	                sta vduQueueNegativeLength ;initialise initial VDU queue length
235	.c089		8a		txa		                txa                          ; Restore original MSB value
236							                .if version==350
238							                .else
239	.c08a		4a		lsr a		                lsr a                        ;
240	.c08b		4a		lsr a		                lsr a                        ;
241	.c08c		4a		lsr a		                lsr a                        ;
242	.c08d		4a		lsr a		                lsr a                        ; Extract value in top 4 bits
243							                .endif
244	.c08e		18		clc		                clc                          ;
245	.c08f		69 c0		adc #$c0	                adc #vduRoutinesPage         ; form MSB
246	.c091		8d 5e 03	sta $035e	                sta vduv.jumpVector+1
247	.c094		80 34		bra $c0ca	                bra reinstateCursorEditing                    ; Continue

249	.c096						LC096:
250	.c096		24 d0		bit $d0		                bit STATE
251	.c098		30 2d		bmi $c0c7	                bmi LC0C7                    ;taken if VDU21
252	.c09a		20 0c ce	jsr $ce0c	                jsr LCE0C
253	.c09d		a9 20		lda #$20	                lda #$20
254	.c09f		2c 66 03	bit $0366	                bit $0366
255	.c0a2		d0 23		bne $c0c7	                bne LC0C7
256	.c0a4		20 76 c2	jsr $c276	                jsr LC276
257	.c0a7		80 1e		bra $c0c7	                bra LC0C7

259	.c0a9						LC0A9:
260	.c0a9		49 06		eor #$06	                eor #$06
261	.c0ab		d0 18		bne $c0c5	                bne LC0C5
262	.c0ad		a9 80		lda #$80	                lda #STATE.isVDU21
263	.c0af		14 d0		trb $d0		                trb STATE
264	.c0b1		80 17		bra $c0ca	                bra reinstateCursorEditing

266	.c0b3						LC0B3:
267	.c0b3		8d 5e 03	sta $035e	                sta vduv.jumpVector+1
268	.c0b6		98		tya		                tya
269	.c0b7		49 f7		eor #$f7	                eor #$F7
270	.c0b9		c9 fa		cmp #$fa	                cmp #$FA
271	.c0bb		98		tya		                tya
272	.c0bc		24 d0		bit $d0		                bit STATE
273	.c0be		30 e9		bmi $c0a9	                bmi LC0A9             ;branch taken if VDU21 in effect
274	.c0c0						LC0C0:
275	.c0c0		08		php		                php
276	.c0c1		20 24 c0	jsr $c024	                jsr LC024
277	.c0c4		28		plp		                plp
278	.c0c5						LC0C5:
279	.c0c5		90 03		bcc $c0ca	                bcc reinstateCursorEditing
280	.c0c7						LC0C7:
281	.c0c7		a5 d0		lda $d0		                lda STATE
282	.c0c9		4a		lsr a		                lsr a                          ;C=1 if printer enabled
283	.c0ca						reinstateCursorEditing:
284	.c0ca		24 d0		bit $d0		                bit STATE
285	.c0cc		50 13		bvc $c0e1	                bvc rtsC0E1               ;taken if not cursor editing
286	.c0ce		20 05 c1	jsr $c105	                jsr activateEditCursor
287	.c0d1						exchangeCursors:
288	.c0d1		08		php		                php
289	.c0d2		48		pha		                pha
290	.c0d3		a5 d0		lda $d0		                lda STATE
291	.c0d5		49 02		eor #$02	                eor #STATE.isScrollingDisabled
292	.c0d7		85 d0		sta $d0		                sta STATE
293	.c0d9		20 ae e2	jsr $e2ae	                jsr exchangeEditCursorPositionAndTextCursorPosition
294	.c0dc		20 d8 c6	jsr $c6d8	                jsr updateCRTCTextCursor
295	.c0df		68		pla		                pla
296	.c0e0		28		plp		                plp
297	.c0e1						rtsC0E1:
298	.c0e1		60		rts		                rts

300							;-------------------------------------------------------------------------
301							;
302							; VDU 1 (&01) Send next character to printer only [MasRef E.3-2]
303							;
304	.c0e2						vdu1EntryPoint:
305	.c0e2		20 ca c0	jsr $c0ca	                jsr reinstateCursorEditing
306	.c0e5		20 48 c0	jsr $c048	                jsr outputCharToPrinter
307	.c0e8		80 10		bra $c0fa	                bra stopCursorEditing

309							;-------------------------------------------------------------------------
310							;
311							; VDU 2 (&02) Enable printer [MasRef E.3-2]
312							; VDU 3 (&03) Disable printer [MasRef E.3-3]
313							;
314	.c0ea						vdu2EntryPoint:
315	.c0ea						vdu3EntryPoint:
316	.c0ea		48		pha		                pha                          ;
317	.c0eb		20 ca c0	jsr $c0ca	                jsr reinstateCursorEditing
318							                .if version<350
319	.c0ee		20 3a e9	jsr $e93a	                jsr callPrinterDriverWithPrinterBuffer
322							                .endif
323	.c0f1		a9 01		lda #$01	                lda #STATE.isPrinterEnabled  ;
324	.c0f3		04 d0		tsb $d0		                tsb STATE
325	.c0f5		68		pla		                pla
326	.c0f6		29 01		and #$01	                and #STATE.isPrinterEnabled
327	.c0f8		14 d0		trb $d0		                trb STATE

329							;-------------------------------------------------------------------------
330							;
331							; Stop cursor editing, if it's on.
332							;
333							; exit:
334							;
335							; V=1 if cursor editing previous on
336							; N=1 if VDU 21 on
337							;
338	.c0fa						stopCursorEditing:
339	.c0fa		24 d0		bit $d0		                bit STATE
340	.c0fc		50 e3		bvc $c0e1	                bvc rtsC0E1                    ;taken if not cursor editing
341	.c0fe		20 d1 c0	jsr $c0d1	                jsr exchangeCursors
342	.c101		08		php		                php
343	.c102						deactivateEditCursor:
344	.c102		38		sec		                sec
345	.c103		80 02		bra $c107	                bra updateEditCursorState

347							;-------------------------------------------------------------------------

349	.c105						activateEditCursor:
350	.c105		08		php		                php
351	.c106		18		clc		                clc

353							;-------------------------------------------------------------------------
354							;
355							; Handle cursor editing on/off.
356							;
357							; entry:
358							;
359							; C=0 - cursor editing on; add fake cursor
360							;
361							; C=1 = cursor editing off; remove fake cursor and restore screen
362							;
363	.c107						updateEditCursorState: .proc
364	.c107		48		pha		                pha
365	.c108		a5 d8		lda $d8		                lda ZMEMT+0
366	.c10a		85 e0		sta $e0		                sta ZTEMPD+0
367	.c10c		a5 d9		lda $d9		                lda ZMEMT+1
368	.c10e		85 e1		sta $e1		                sta ZTEMPD+1
369	.c110		ac 4f 03	ldy $034f	                ldy vduv.bytesPerCharacter
370	.c113		88		dey		                dey
371	.c114		d0 0e		bne $c124	                bne bitmap

373	.c116						teletext:
374	.c116		ad 38 03	lda $0338	                lda vduv.workspace._38 ;get old byte under fake cursor (may be bogus)
375	.c119		b0 17		bcs $c132	                bcs storeToScreen      ;taken if switching off
376	.c11b		b2 d8		lda ($d8)	                lda (ZMEMT)            ;get screen byte
377	.c11d		8d 38 03	sta $0338	                sta vduv.workspace._38 ;store old byte
378	.c120		a9 7f		lda #$7f	                lda #$7F               ;store solid block to screen
379	.c122		80 0e		bra $c132	                bra storeToScreen

381	.c124						bitmap:
382	.c124		a9 ff		lda #$ff	                lda #%11111111          ;invert all bits
383	.c126		c0 1f		cpy #$1f	                cpy #$1F      ;check for 32 chars/byte - i.e., MODE 2
384	.c128		d0 02		bne $c12c	                bne +         ;taken if not MODE 2
385	.c12a		a9 3f		lda #$3f	                lda #%00111111       ;avoid flashing colours in MODE 2
386	.c12c						+
387	.c12c		85 da		sta $da		                sta ZTEMP
388	.c12e						loop:
389	.c12e		b2 e0		lda ($e0)	                lda (ZTEMPD)
390	.c130		45 da		eor $da		                eor ZTEMP
391	.c132						storeToScreen:
392	.c132		92 e0		sta ($e0)	                sta (ZTEMPD)
393	.c134		e6 e0		inc $e0		                inc ZTEMPD+0
394	.c136		d0 09		bne $c141	                bne +                    ;taken if no carry out of LSB
395	.c138		e6 e1		inc $e1		                inc ZTEMPD+1
396	.c13a		10 05		bpl $c141	                bpl +                 ;taken if no screen address wrap
397	.c13c		ad 4e 03	lda $034e	                lda vduv.startScreenAddressHighByte
398	.c13f		85 e1		sta $e1		                sta ZTEMPD+1
399	.c141						+
400	.c141		88		dey		                dey               ;Y=$ff after 1 iteration in teletext
401	.c142		10 ea		bpl $c12e	                bpl loop
402	.c144		68		pla		                pla
403	.c145		28		plp		                plp
404	.c146		60		rts		                rts
405							                .endproc

407							;-------------------------------------------------------------------------

409	.c147						LC147:
410	>c147		be c1				                .word LC1BE
411	>c149		b1 c1				                .word LC1B1
412	>c14b		be c1				                .word LC1BE
413	>c14d		b1 c1				                .word LC1B1
414	>c14f		95 c1				                .word LC195
415	>c151		95 c1				                .word LC195
416	>c153		a2 c1				                .word LC1A2
417	>c155		a2 c1				                .word LC1A2

419							;-------------------------------------------------------------------------

421	.c157						LC157:
422	>c157		01 c2				                .word LC201
423	>c159		ee c1				                .word LC1EE
424	>c15b		01 c2				                .word LC201
425	>c15d		ee c1				                .word LC1EE
426	>c15f		21 c2				                .word LC221
427	>c161		21 c2				                .word LC221
428	>c163		10 c2				                .word LC210
429	>c165		10 c2				                .word LC210

431							;-------------------------------------------------------------------------
432							;
433							; Indexed by the swapAxes, invertVertical and invertHorizontal cursor
434							; flags bits.
435							;
436	.c167						setTextCursorXPositionRoutinesTable:
437	>c167		d3 c2				                .word setTextCursorXPosition           ;0
438	>c169		cb c2				                .word setTextCursorXPositionInvertHorizontal ;invertHorizontal
439	>c16b		d3 c2				                .word setTextCursorXPosition ;invertVertical
440	>c16d		cb c2				                .word setTextCursorXPositionInvertHorizontal ;invertVertical|invertHorizontal
441	>c16f		e2 c2				                .word setTextCursorXPositionSwapAxes         ;swapAxes
442	>c171		e2 c2				                .word setTextCursorXPositionSwapAxes ;swapAxes|invertHorizontal
443	>c173		da c2				                .word setTextCursorXPositionSwapAxesInvertVertical ;swapAxes|invertVertical
444	>c175		da c2				                .word setTextCursorXPositionSwapAxesInvertVertical ;swapAxes|invertVertical|invertHorizontal

446							;-------------------------------------------------------------------------

448	.c177						LC177:
449	>c177		10 c3				                .word LC310
450	>c179		f2 c2				                .word LC2F2
451	>c17b		10 c3				                .word LC310
452	>c17d		f2 c2				                .word LC2F2
453	>c17f		5a c3				                .word LC35A
454	>c181		5a c3				                .word LC35A
455	>c183		38 c3				                .word LC338
456	>c185		38 c3				                .word LC338

458							;-------------------------------------------------------------------------

460	.c187						LC187:
461	.c187		4d 66 03	eor $0366	                eor $0366
462	.c18a		29 0e		and #$0e	                and #$0E
463	.c18c		48		pha		                pha
464	.c18d		20 a6 d1	jsr $d1a6	                jsr LD1A6
465	.c190		fa		plx		                plx
466	.c191		38		sec		                sec
467	.c192		7c 47 c1	jmp ($c147,x)	                jmp (LC147,x)

469	.c195						LC195:
470	.c195		ad 26 03	lda $0326	                lda $0326
471	.c198		e9 08		sbc #$08	                sbc #$08
472	.c19a		8d 26 03	sta $0326	                sta $0326
473	.c19d		ce 27 03	dec $0327	                dec $0327
474	.c1a0		80 08		bra $c1aa	                bra LC1AA

476	.c1a2						LC1A2:
477	.c1a2		ad 26 03	lda $0326	                lda $0326
478	.c1a5		69 07		adc #$07	                adc #$07
479	.c1a7		8d 26 03	sta $0326	                sta $0326
480	.c1aa						LC1AA:
481	.c1aa		90 1f		bcc $c1cb	                bcc LC1CB
482	.c1ac		ee 27 03	inc $0327	                inc $0327
483	.c1af		80 1a		bra $c1cb	                bra LC1CB

485	.c1b1						LC1B1:
486	.c1b1		ad 24 03	lda $0324	                lda $0324
487	.c1b4		e9 08		sbc #$08	                sbc #$08
488	.c1b6		8d 24 03	sta $0324	                sta $0324
489	.c1b9		ce 25 03	dec $0325	                dec $0325
490	.c1bc		80 08		bra $c1c6	                bra LC1C6

492	.c1be						LC1BE:
493	.c1be		ad 24 03	lda $0324	                lda $0324
494	.c1c1		69 07		adc #$07	                adc #$07
495	.c1c3		8d 24 03	sta $0324	                sta $0324
496	.c1c6						LC1C6:
497	.c1c6		90 03		bcc $c1cb	                bcc LC1CB
498	.c1c8		ee 25 03	inc $0325	                inc $0325
499	.c1cb						LC1CB:
500	.c1cb		a5 da		lda $da		                lda $DA
501	.c1cd		d0 0c		bne $c1db	                bne LC1DB
502	.c1cf		2c 66 03	bit $0366	                bit $0366
503	.c1d2		70 07		bvs $c1db	                bvs LC1DB
504	.c1d4		da		phx		                phx
505	.c1d5		20 a6 d1	jsr $d1a6	                jsr LD1A6
506	.c1d8		fa		plx		                plx
507	.c1d9		a8		tay		                tay
508	.c1da		60		rts		                rts

510	.c1db						LC1DB:
511	.c1db		a9 00		lda #$00	                lda #$00
512	.c1dd		60		rts		                rts

514	.c1de						LC1DE:
515	.c1de		a9 00		lda #$00	                lda #$00
516	.c1e0						LC1E0:
517	.c1e0		64 da		stz $da		                stz $DA
518	.c1e2		0a		asl a		                asl a
519	.c1e3		26 da		rol $da		                rol $DA
520	.c1e5		0a		asl a		                asl a
521	.c1e6		26 da		rol $da		                rol $DA
522	.c1e8		0a		asl a		                asl a
523	.c1e9		26 da		rol $da		                rol $DA
524	.c1eb		7c 57 c1	jmp ($c157,x)	                jmp (LC157,x)

526	.c1ee						LC1EE:
527	.c1ee		49 f9		eor #$f9	                eor #$F9
528	.c1f0		6d 04 03	adc $0304	                adc $0304
529	.c1f3		8d 24 03	sta $0324	                sta $0324
530	.c1f6		a5 da		lda $da		                lda $DA
531	.c1f8		49 ff		eor #$ff	                eor #$FF
532	.c1fa		6d 05 03	adc $0305	                adc $0305
533	.c1fd		8d 25 03	sta $0325	                sta $0325
534	.c200		60		rts		                rts

536	.c201						LC201:
537	.c201		6d 00 03	adc $0300	                adc $0300
538	.c204		8d 24 03	sta $0324	                sta $0324
539	.c207		a5 da		lda $da		                lda $DA
540	.c209		6d 01 03	adc $0301	                adc $0301
541	.c20c		8d 25 03	sta $0325	                sta $0325
542	.c20f		60		rts		                rts

544	.c210						LC210:
545	.c210		49 07		eor #$07	                eor #$07
546	.c212		6d 02 03	adc $0302	                adc $0302
547	.c215		8d 26 03	sta $0326	                sta $0326
548	.c218		a5 da		lda $da		                lda $DA
549	.c21a		6d 03 03	adc $0303	                adc $0303
550	.c21d		8d 27 03	sta $0327	                sta $0327
551	.c220		60		rts		                rts

553	.c221						LC221:
554	.c221		38		sec		                sec
555	.c222		49 ff		eor #$ff	                eor #$FF
556	.c224		6d 06 03	adc $0306	                adc $0306
557	.c227		8d 26 03	sta $0326	                sta $0326
558	.c22a		a5 da		lda $da		                lda $DA
559	.c22c		49 ff		eor #$ff	                eor #$FF
560	.c22e		6d 07 03	adc $0307	                adc $0307
561	.c231		8d 27 03	sta $0327	                sta $0327
562	.c234		60		rts		                rts

564	.c235						LC235:
565	.c235		a9 00		lda #$00	                lda #$00
566	.c237		20 87 c1	jsr $c187	                jsr LC187
567	.c23a		f0 0d		beq $c249	                beq LC249
568	.c23c		20 de c1	jsr $c1de	                jsr LC1DE
569	.c23f						LC23F:
570	.c23f		a9 08		lda #$08	                lda #$08
571	.c241						LC241:
572	.c241		20 87 c1	jsr $c187	                jsr LC187
573	.c244		f0 03		beq $c249	                beq LC249
574	.c246		20 de c1	jsr $c1de	                jsr LC1DE
575	.c249						LC249:
576	.c249		4c df c4	jmp $c4df	                jmp LC4DF

578	.c24c						vdu9EntryPoint:
579	.c24c		20 2d d1	jsr $d12d	                jsr handleColumn81
580	.c24f		b0 e4		bcs $c235	                bcs LC235
581	.c251		a9 00		lda #$00	                lda #$00
582	.c253		20 e9 c2	jsr $c2e9	                jsr LC2E9
583	.c256		90 1b		bcc $c273	                bcc LC273
584	.c258						LC258:
585	.c258		20 8f c3	jsr $c38f	                jsr LC38F
586	.c25b						vdu10EntryPoint:
587	.c25b		20 d2 e2	jsr $e2d2	                jsr testVDU5State
588	.c25e		d0 df		bne $c23f	                bne LC23F
589	.c260		18		clc		                clc
590	.c261		20 8e c8	jsr $c88e	                jsr LC88E
591	.c264		a9 08		lda #$08	                lda #$08
592	.c266		20 e9 c2	jsr $c2e9	                jsr LC2E9
593	.c269						LC269:
594	.c269		90 08		bcc $c273	                bcc LC273
595	.c26b		20 7b c3	jsr $c37b	                jsr LC37B
596	.c26e		90 03		bcc $c273	                bcc LC273
597	.c270		4c 51 d0	jmp $d051	                jmp LD051

599	.c273						LC273:
600	.c273		4c ed c6	jmp $c6ed	                jmp updateCRTCCursorAddress

602	.c276						LC276:
603	.c276		20 d2 e2	jsr $e2d2	                jsr testVDU5State
604	.c279		d0 ba		bne $c235	                bne LC235
605	.c27b		20 e9 c2	jsr $c2e9	                jsr LC2E9
606	.c27e		90 f3		bcc $c273	                bcc LC273
607	.c280		a9 01		lda #$01	                lda #$01
608	.c282		2c 66 03	bit $0366	                bit $0366
609	.c285		f0 d1		beq $c258	                beq LC258
610	.c287		38		sec		                sec
611	.c288		6e 6c 03	ror $036c	                ror $036C
612	.c28b						LC28B:
613	.c28b		60		rts		                rts

615	.c28c						LC28C:
616	.c28c		a9 06		lda #$06	                lda #$06
617	.c28e		20 87 c1	jsr $c187	                jsr LC187
618	.c291		f0 b6		beq $c249	                beq LC249
619	.c293		20 de c1	jsr $c1de	                jsr LC1DE
620	.c296						LC296:
621	.c296		a9 0e		lda #$0e	                lda #$0E
622	.c298		80 a7		bra $c241	                bra LC241

624	.c29a						vdu8EntryPoint:
625	.c29a		20 d2 e2	jsr $e2d2	                jsr testVDU5State
626	.c29d		d0 ed		bne $c28c	                bne LC28C
627	.c29f		4e 6c 03	lsr $036c	                lsr $036C
628	.c2a2		2c 6c 03	bit $036c	                bit $036C
629	.c2a5		70 e4		bvs $c28b	                bvs LC28B
630	.c2a7		a9 06		lda #$06	                lda #$06
631	.c2a9		20 e9 c2	jsr $c2e9	                jsr LC2E9
632	.c2ac		90 c5		bcc $c273	                bcc LC273
633	.c2ae		20 8f c3	jsr $c38f	                jsr LC38F
634	.c2b1						vdu11EntryPoint:
635	.c2b1		20 d2 e2	jsr $e2d2	                jsr testVDU5State
636	.c2b4		d0 e0		bne $c296	                bne LC296
637	.c2b6		ce 69 02	dec $0269	                dec pagedModeCounter
638	.c2b9		10 03		bpl $c2be	                bpl LC2BE
639	.c2bb		ee 69 02	inc $0269	                inc pagedModeCounter
640	.c2be						LC2BE:
641	.c2be		a9 0e		lda #$0e	                lda #$0E
642	.c2c0		20 e9 c2	jsr $c2e9	                jsr LC2E9
643	.c2c3		80 a4		bra $c269	                bra LC269

645							;-------------------------------------------------------------------------
646							;
647							; Set/reset cursor position, taking cursor flags into account.
648							;
649							; entry:
650							;
651							; (set only) A = cursor position
652							;
653							; X = cursorFlags bits: swapAxes, invertVertical, invertHorizontal
654							;
655	.c2c5						resetTextCursorXPositionWithCursorFlags:
656	.c2c5		a9 00		lda #$00	                lda #$00
657	.c2c7						setTextCursorXPositionWithCursorFlags:
658	.c2c7		18		clc		                clc
659	.c2c8		7c 67 c1	jmp ($c167,x)	                jmp (setTextCursorXPositionRoutinesTable,x)

661							;-------------------------------------------------------------------------

663	.c2cb						setTextCursorXPositionInvertHorizontal:
664	.c2cb		38		sec		                sec                          ;+1
665	.c2cc		49 ff		eor #$ff	                eor #$FF          ;^$ff+1 (i.e., adc will add the -ve)
666	.c2ce		6d 0a 03	adc $030a	                adc vduv.textWindowRight
667	.c2d1		80 03		bra $c2d6	                bra staTextCursorXPosition

669							;-------------------------------------------------------------------------

671	.c2d3						setTextCursorXPosition:
672	.c2d3		6d 08 03	adc $0308	                adc vduv.textWindowLeft
673	.c2d6						staTextCursorXPosition:
674	.c2d6		8d 18 03	sta $0318	                sta vduv.textCursorXPosition
675	.c2d9		60		rts		                rts

677							;-------------------------------------------------------------------------

679	.c2da						setTextCursorXPositionSwapAxesInvertVertical:
680	.c2da		38		sec		                sec
681	.c2db		49 ff		eor #$ff	                eor #$FF
682	.c2dd		6d 09 03	adc $0309	                adc vduv.textWindowBottom
683	.c2e0		80 03		bra $c2e5	                bra staTextCursorYPosition

685	.c2e2						setTextCursorXPositionSwapAxes:
686	.c2e2		6d 0b 03	adc $030b	                adc vduv.textWindowTop
687	.c2e5						staTextCursorYPosition:
688	.c2e5		8d 19 03	sta $0319	                sta vduv.textCursorYPosition
689	.c2e8		60		rts		                rts

691							;-------------------------------------------------------------------------

693	.c2e9						LC2E9:
694	.c2e9		4d 66 03	eor $0366	                eor $0366
695	.c2ec		29 0e		and #$0e	                and #$0E
696	.c2ee		aa		tax		                tax
697	.c2ef						LC2EF:
698	.c2ef		7c 77 c1	jmp ($c177,x)	                jmp (LC177,x)

700	.c2f2						LC2F2:
701	.c2f2		ad 08 03	lda $0308	                lda $0308
702	.c2f5		cd 18 03	cmp $0318	                cmp $0318
703	.c2f8		b0 3d		bcs $c337	                bcs LC337
704	.c2fa		ce 18 03	dec $0318	                dec $0318
705	.c2fd		38		sec		                sec
706	.c2fe		ad 4a 03	lda $034a	                lda $034A
707	.c301		ed 4f 03	sbc $034f	                sbc $034F
708	.c304		8d 4a 03	sta $034a	                sta $034A
709	.c307		85 d8		sta $d8		                sta ZMEMT+0
710	.c309		b0 2b		bcs $c336	                bcs LC336
711	.c30b		ce 4b 03	dec $034b	                dec $034B
712	.c30e		80 1b		bra $c32b	                bra LC32B

714	.c310						LC310:
715	.c310		ad 18 03	lda $0318	                lda $0318
716	.c313		cd 0a 03	cmp $030a	                cmp $030A
717	.c316		b0 1f		bcs $c337	                bcs LC337
718	.c318		ee 18 03	inc $0318	                inc $0318
719	.c31b		ad 4a 03	lda $034a	                lda $034A
720	.c31e		6d 4f 03	adc $034f	                adc $034F
721	.c321		8d 4a 03	sta $034a	                sta $034A
722	.c324		85 d8		sta $d8		                sta ZMEMT+0
723	.c326		90 0f		bcc $c337	                bcc LC337
724	.c328		ee 4b 03	inc $034b	                inc $034B
725	.c32b						LC32B:
726	.c32b		ad 4b 03	lda $034b	                lda $034B
727	.c32e						LC32E:
728	.c32e		10 04		bpl $c334	                bpl LC334
729	.c330		38		sec		                sec
730	.c331		ed 54 03	sbc $0354	                sbc $0354
731	.c334						LC334:
732	.c334		85 d9		sta $d9		                sta ZMEMT+1
733	.c336						LC336:
734	.c336		18		clc		                clc
735	.c337						LC337:
736	.c337		60		rts		                rts

738	.c338						LC338:
739	.c338		ad 0b 03	lda $030b	                lda $030B
740	.c33b		cd 19 03	cmp $0319	                cmp $0319
741	.c33e		b0 f7		bcs $c337	                bcs LC337
742	.c340		ce 19 03	dec $0319	                dec $0319
743	.c343		38		sec		                sec
744	.c344		ad 4a 03	lda $034a	                lda $034A
745	.c347		ed 52 03	sbc $0352	                sbc $0352
746	.c34a		8d 4a 03	sta $034a	                sta $034A
747	.c34d		85 d8		sta $d8		                sta ZMEMT+0
748	.c34f		ad 4b 03	lda $034b	                lda $034B
749	.c352		ed 53 03	sbc $0353	                sbc $0353
750	.c355		8d 4b 03	sta $034b	                sta $034B
751	.c358		80 d4		bra $c32e	                bra LC32E

753	.c35a						LC35A:
754	.c35a		ad 19 03	lda $0319	                lda $0319
755	.c35d		cd 09 03	cmp $0309	                cmp $0309
756	.c360		b0 d5		bcs $c337	                bcs LC337
757	.c362		ee 19 03	inc $0319	                inc $0319
758	.c365		ad 4a 03	lda $034a	                lda $034A
759	.c368		6d 52 03	adc $0352	                adc $0352
760	.c36b		8d 4a 03	sta $034a	                sta $034A
761	.c36e		85 d8		sta $d8		                sta ZMEMT+0
762	.c370		ad 4b 03	lda $034b	                lda $034B
763	.c373		6d 53 03	adc $0353	                adc $0353
764	.c376		8d 4b 03	sta $034b	                sta $034B
765	.c379		80 b3		bra $c32e	                bra LC32E

767	.c37b						LC37B:
768	.c37b		a9 10		lda #$10	                lda #$10
769	.c37d		2c 66 03	bit $0366	                bit $0366
770	.c380		d0 0d		bne $c38f	                bne LC38F
771	.c382		8a		txa		                txa
772	.c383		49 06		eor #$06	                eor #$06
773	.c385		48		pha		                pha
774	.c386		a9 42		lda #$42	                lda #$42
775	.c388		24 d0		bit $d0		                bit STATE
776	.c38a		f0 16		beq $c3a2	                beq LC3A2
777	.c38c		70 09		bvs $c397	                bvs LC397
778	.c38e		68		pla		                pla
779	.c38f						LC38F:
780	.c38f		20 c5 c2	jsr $c2c5	                jsr resetTextCursorXPositionWithCursorFlags
781	.c392		20 fa cc	jsr $ccfa	                jsr updateZMEMTWithTextCursorPosition
782	.c395		18		clc		                clc
783	.c396		60		rts		                rts

785	.c397						LC397:
786	.c397		20 ae e2	jsr $e2ae	                jsr exchangeEditCursorPositionAndTextCursorPosition
787	.c39a		fa		plx		                plx
788	.c39b		da		phx		                phx
789	.c39c		20 ef c2	jsr $c2ef	                jsr LC2EF
790	.c39f		20 ae e2	jsr $e2ae	                jsr exchangeEditCursorPositionAndTextCursorPosition
791	.c3a2						LC3A2:
792	.c3a2		fa		plx		                plx
793	.c3a3		38		sec		                sec
794	.c3a4						LC3A4:
795	.c3a4		60		rts		                rts

797	.c3a5						vdu28EntryPoint:
798	.c3a5		ae 55 03	ldx $0355	                ldx $0355
799	.c3a8		ad 21 03	lda $0321	                lda $0321
800	.c3ab		cd 23 03	cmp $0323	                cmp $0323
801	.c3ae		90 f4		bcc $c3a4	                bcc LC3A4
802	.c3b0		dd 01 e1	cmp $e101,x	                cmp modeMaxRow,x
803	.c3b3		f0 02		beq $c3b7	                beq LC3B7
804	.c3b5		b0 ed		bcs $c3a4	                bcs LC3A4
805	.c3b7						LC3B7:
806	.c3b7		ad 22 03	lda $0322	                lda $0322
807	.c3ba		dd 09 e1	cmp $e109,x	                cmp modeMaxColumn,x
808	.c3bd		f0 03		beq $c3c2	                beq LC3C2
809	.c3bf		b0 e3		bcs $c3a4	                bcs LC3A4
810	.c3c1		38		sec		                sec
811	.c3c2						LC3C2:
812	.c3c2		ed 20 03	sbc $0320	                sbc $0320
813	.c3c5		90 dd		bcc $c3a4	                bcc LC3A4
814	.c3c7		20 80 c7	jsr $c780	                jsr setTextWindowWidthInBytes
815	.c3ca		a9 08		lda #$08	                lda #$08
816	.c3cc		04 d0		tsb $d0		                tsb STATE
817	.c3ce		a2 20		ldx #$20	                ldx #VDUVariables.queueEnd-4
818	.c3d0		a0 08		ldy #$08	                ldy #VDUVariables.textWindowLeft
819	.c3d2		20 1e c9	jsr $c91e	                jsr copyFourBytesWithinVDUVariables
820	.c3d5		20 ae e2	jsr $e2ae	                jsr exchangeEditCursorPositionAndTextCursorPosition
821	.c3d8		20 da cc	jsr $ccda	                jsr LCCDA
822	.c3db		90 03		bcc $c3e0	                bcc LC3E0
823	.c3dd		20 e8 c3	jsr $c3e8	                jsr LC3E8
824	.c3e0						LC3E0:
825	.c3e0		20 ae e2	jsr $e2ae	                jsr exchangeEditCursorPositionAndTextCursorPosition
826	.c3e3		20 da cc	jsr $ccda	                jsr LCCDA
827	.c3e6		90 1f		bcc $c407	                bcc LC407
828	.c3e8						LC3E8:
829	.c3e8		a5 d0		lda $d0		                lda STATE
830	.c3ea		48		pha		                pha
831	.c3eb		29 df		and #$df	                and #$DF
832	.c3ed		85 d0		sta $d0		                sta STATE
833	.c3ef		20 7c c4	jsr $c47c	                jsr vdu30EntryPoint
834	.c3f2		68		pla		                pla
835	.c3f3		85 d0		sta $d0		                sta STATE
836	.c3f5		60		rts		                rts

838	.c3f6						vdu13EntryPoint:
839	.c3f6		ad 66 03	lda $0366	                lda $0366
840	.c3f9		29 0e		and #$0e	                and #$0E
841	.c3fb		aa		tax		                tax
842	.c3fc		20 d2 e2	jsr $e2d2	                jsr testVDU5State
843	.c3ff		d0 09		bne $c40a	                bne LC40A
844	.c401		4e 6c 03	lsr $036c	                lsr $036C
845	.c404		20 8f c3	jsr $c38f	                jsr LC38F
846	.c407						LC407:
847	.c407		4c ed c6	jmp $c6ed	                jmp updateCRTCCursorAddress

849	.c40a						LC40A:
850	.c40a		20 de c1	jsr $c1de	                jsr LC1DE
851	.c40d		4c df c4	jmp $c4df	                jmp LC4DF

853	.c410						LC410:
854	.c410		20 7c c4	jsr $c47c	                jsr vdu30EntryPoint

856							;-------------------------------------------------------------------------
857							;
858							; VDU 16 (&10) Clear graphics window [MasRef E.3-7]
859							;
860	.c413						vdu16EntryPoint:
861	.c413		ad 61 03	lda $0361	                lda vduv.pixelsPerByteMinusOne
862	.c416		f0 8c		beq $c3a4	                beq LC3A4                    ;taken if MODE 7
863	.c418		a2 00		ldx #$00	                ldx #VDUVariables.graphicsWindowPixelsLeft
864	.c41a		20 02 c9	jsr $c902	                jsr copyEightBytesToWorkspace28
865	.c41d		20 51 c9	jsr $c951	                jsr prepareForPlotBackground
866	.c420						LC420:
867	.c420		a2 2a		ldx #$2a	                ldx #$2A
868	.c422		a0 2e		ldy #$2e	                ldy #$2E
869	.c424		20 b2 e2	jsr $e2b2	                jsr exchangeTwoVDUBytes
870	.c427						LC427:
871	.c427		a2 28		ldx #$28	                ldx #$28
872	.c429		a0 2c		ldy #$2c	                ldy #$2C
873	.c42b		20 e8 da	jsr $dae8	                jsr LDAE8
874	.c42e		ad 2a 03	lda $032a	                lda $032A
875	.c431		d0 03		bne $c436	                bne LC436
876	.c433		ce 2b 03	dec $032b	                dec $032B
877	.c436						LC436:
878	.c436		ce 2a 03	dec $032a	                dec $032A
879	.c439		ad 2a 03	lda $032a	                lda $032A
880	.c43c		cd 2e 03	cmp $032e	                cmp $032E
881	.c43f		ad 2b 03	lda $032b	                lda $032B
882	.c442		ed 2f 03	sbc $032f	                sbc $032F
883	.c445		10 e0		bpl $c427	                bpl LC427
884	.c447		60		rts		                rts

886	.c448						LC448:
887	.c448		a2 20		ldx #$20	                ldx #VDUVariables.queueEnd-4
888	.c44a		20 e6 c8	jsr $c8e6	                jsr prepareAABB
889	.c44d		80 d1		bra $c420	                bra LC420

891							;-------------------------------------------------------------------------
892							;
893							; VDU 12 (&0C) Clear text window [MasRef E.3-5]
894							;
895	.c44f						vdu12EntryPoint:
896	.c44f		a9 20		lda #$20	                lda #STATE.isVDU5
897	.c451		24 d0		bit $d0		                bit STATE
898	.c453		d0 bb		bne $c410	                bne LC410                    ;taken if VDU 5 mode
899	.c455		a9 08		lda #$08	                lda #STATE.isTextWindow
900	.c457		24 d0		bit $d0		                bit STATE
901	.c459		d0 03		bne $c45e	                bne clearTextWindow                    ;taken if text window
902	.c45b		4c 66 c8	jmp $c866	                jmp clsFastPath

904							                ; Clear screen within text window
905							                ; -------------------------------
906	.c45e						clearTextWindow:
907	.c45e		20 08 c9	jsr $c908	                jsr copyTextWindowWidthInBytesToWorkspace28
908	.c461		ae 08 03	ldx $0308	                ldx vduv.textWindowLeft
909	.c464		8e 18 03	stx $0318	                stx vduv.textCursorXPosition
910	.c467		ae 0b 03	ldx $030b	                ldx vduv.textWindowTop
911	.c46a						clearTextWindowRowsLoop:
912	.c46a		8e 19 03	stx $0319	                stx vduv.textCursorYPosition
913	.c46d		20 fa cc	jsr $ccfa	                jsr updateZMEMTWithTextCursorPosition
914	.c470		20 e8 ca	jsr $cae8	                jsr LCAE8
915	.c473		ae 19 03	ldx $0319	                ldx vduv.textCursorYPosition
916	.c476		ec 09 03	cpx $0309	                cpx vduv.textWindowBottom
917	.c479		e8		inx		                inx
918	.c47a		90 ee		bcc $c46a	                bcc clearTextWindowRowsLoop

920							;-------------------------------------------------------------------------
921							;
922							; VDU 30 (&1E) Home cursor [MasRef E.3-36]
923							;
924	.c47c						vdu30EntryPoint:
925							                ; pretend it's VDU 31,0,0
926	.c47c		9c 23 03	stz $0323	                stz vduv.queueEnd-1
927	.c47f		9c 22 03	stz $0322	                stz vduv.queueEnd-2

929							;-------------------------------------------------------------------------
930							;
931							; VDU 31 (&1F) Tab cursor [MasRef E.3-36]
932							;
933	.c482						vdu31EntryPoint:
934	.c482		ad 66 03	lda $0366	                lda vduv.cursorFlags
935	.c485		29 0e		and #$0e	                and #vduv.cursorFlags.swapAxes|vduv.cursorFlags.invertVertical|vduv.cursorFlags.invertHorizontal
936	.c487		aa		tax		                tax
937	.c488						LC488:
938	.c488		20 d2 e2	jsr $e2d2	                jsr testVDU5State
939	.c48b		d0 42		bne $c4cf	                bne LC4CF                    ;taken if VDU 5
940	.c48d		ad 18 03	lda $0318	                lda vduv.textCursorXPosition
941	.c490		48		pha		                pha                          ;save old X pos
942	.c491		ad 19 03	lda $0319	                lda vduv.textCursorYPosition
943	.c494		48		pha		                pha                          ;save old Y pos
944	.c495		ad 22 03	lda $0322	                lda vduv.queueEnd-2          ;X coordinate
945	.c498		20 c7 c2	jsr $c2c7	                jsr setTextCursorXPositionWithCursorFlags
946	.c49b		da		phx		                phx                          ;save true cursorFlags bits
947	.c49c		8a		txa		                txa
948	.c49d		49 08		eor #$08	                eor #vduv.cursorFlags.swapAxes ;cheekily do the other axis by just changing the cursor flags
949	.c49f		aa		tax		                tax
950	.c4a0		ad 23 03	lda $0323	                lda vduv.queueEnd-1          ;Y coordinate
951	.c4a3		20 d7 cc	jsr $ccd7	                jsr LCCD7
952	.c4a6		fa		plx		                plx                    ;restore true cursorFlags bits
953	.c4a7		90 11		bcc $c4ba	                bcc LC4BA              ;taken if no scrolling required
954	.c4a9		a9 01		lda #$01	                lda #vduv.cursorFlags.scrollProtect
955	.c4ab		2c 66 03	bit $0366	                bit $0366
956	.c4ae		f0 11		beq $c4c1	                beq LC4C1                 ;taken if scroll protect off

958							                ; Wrap text cursor X.
959	.c4b0		ad 22 03	lda $0322	                lda vduv.queueEnd-2       ;X coordinate
960	.c4b3		3a		dec a		                dec a
961	.c4b4		20 d7 cc	jsr $ccd7	                jsr LCCD7
962	.c4b7		b0 08		bcs $c4c1	                bcs LC4C1
963	.c4b9		38		sec		                sec
964	.c4ba						LC4BA:
965	.c4ba		6e 6c 03	ror $036c	                ror vduv.column81
966	.c4bd		68		pla		                pla                          ;discard old Y pos
967	.c4be		68		pla		                pla                          ;discard old X pos
968	.c4bf		80 0b		bra $c4cc	                bra LC4CC

970	.c4c1						LC4C1:
971	.c4c1		68		pla		                pla
972	.c4c2		8d 19 03	sta $0319	                sta vduv.textCursorYPosition ;restore old Y pos
973	.c4c5		68		pla		                pla
974	.c4c6		8d 18 03	sta $0318	                sta vduv.textCursorXPosition ;restore old X pos
975	.c4c9		20 fa cc	jsr $ccfa	                jsr updateZMEMTWithTextCursorPosition
976	.c4cc						LC4CC:
977	.c4cc		4c ed c6	jmp $c6ed	                jmp updateCRTCCursorAddress

979	.c4cf						LC4CF:
980	.c4cf		ad 22 03	lda $0322	                lda $0322
981	.c4d2		20 e0 c1	jsr $c1e0	                jsr LC1E0
982	.c4d5		8a		txa		                txa
983	.c4d6		49 08		eor #$08	                eor #$08
984	.c4d8		aa		tax		                tax
985	.c4d9		ad 23 03	lda $0323	                lda $0323
986	.c4dc		20 e0 c1	jsr $c1e0	                jsr LC1E0
987	.c4df						LC4DF:
988	.c4df		a0 10		ldy #$10	                ldy #$10
989	.c4e1		20 1c c9	jsr $c91c	                jsr copyGraphicsCursorPixels
990	.c4e4		a2 02		ldx #$02	                ldx #$02
991	.c4e6		a0 02		ldy #$02	                ldy #$02
992	.c4e8		20 fc c4	jsr $c4fc	                jsr LC4FC
993	.c4eb		a2 00		ldx #$00	                ldx #$00
994	.c4ed		a0 04		ldy #$04	                ldy #$04
995	.c4ef		ad 61 03	lda $0361	                lda $0361
996	.c4f2						LC4F2:
997	.c4f2		88		dey		                dey
998	.c4f3		4a		lsr a		                lsr a
999	.c4f4		d0 fc		bne $c4f2	                bne LC4F2
1000	.c4f6		ad 56 03	lda $0356	                lda $0356
1001	.c4f9		f0 01		beq $c4fc	                beq LC4FC
1002	.c4fb		c8		iny		                iny
1003	.c4fc						LC4FC:
1004	.c4fc		1e 10 03	asl $0310,x	                asl $0310,x
1005	.c4ff		3e 11 03	rol $0311,x	                rol $0311,x
1006	.c502		88		dey		                dey
1007	.c503		d0 f7		bne $c4fc	                bne LC4FC
1008	.c505		38		sec		                sec
1009	.c506		20 0a c5	jsr $c50a	                jsr LC50A
1010	.c509		e8		inx		                inx
1011	.c50a						LC50A:
1012	.c50a		bd 10 03	lda $0310,x	                lda $0310,x
1013	.c50d		fd 0c 03	sbc $030c,x	                sbc $030C,x
1014	.c510		9d 10 03	sta $0310,x	                sta $0310,x
1015	.c513		60		rts		                rts

1017							;-------------------------------------------------------------------------
1018							;
1019							; VDU 14 (&0E) Page mode on [MasRef E.3-6]
1020							;
1021	.c514						vdu14EntryPoint:
1022	.c514		9c 69 02	stz $0269	                stz pagedModeCounter
1023	.c517		a9 91		lda #$91	                lda #$91

1025							;-------------------------------------------------------------------------
1026							;
1027							; VDU 21 (&15) Disable VDU driver [MasRef E.3-11]
1028							;
1029	.c519						vdu21EntryPoint:
1030	.c519		49 95		eor #$95	                eor #$95
1031	.c51b						LC51B:
1032	.c51b		04 d0		tsb $d0		                tsb STATE
1033	.c51d		60		rts		                rts

1035							;-------------------------------------------------------------------------
1036							;
1037							; VDU 4 (&04) Print at text cursor [MasRef E.3-2]
1038							;
1039	.c51e						vdu4EntryPoint:
1040	.c51e		ad 61 03	lda $0361	                lda $0361
1041	.c521		f0 09		beq $c52c	                beq LC52C
1042	.c523		20 50 cf	jsr $cf50	                jsr showCursor
1043	.c526		a9 2b		lda #$2b	                lda #$2B

1045							                ; fall through to vdu15EntryPoint

1047							;-------------------------------------------------------------------------
1048							;
1049							; VDU 15 (&0F) Page mode off [MasRef E.3-6]
1050							;
1051	.c528						vdu15EntryPoint:
1052	.c528		49 0b		eor #$0b	                eor #$0B
1053	.c52a		14 d0		trb $d0		                trb STATE
1054	.c52c						LC52C:
1055	.c52c		60		rts		                rts

1057							;-------------------------------------------------------------------------
1058							;
1059							; VDU 5 (&05) Print text at graphics cursor [MasRef E.3-3]
1060							;
1061	.c52d						vdu5EntryPoint:
1062	.c52d		ad 61 03	lda $0361	                lda $0361
1063	.c530		f0 fa		beq $c52c	                beq LC52C
1064	.c532		a9 20		lda #$20	                lda #$20
1065	.c534		20 53 cf	jsr $cf53	                jsr setCRTCRegister10
1066	.c537		80 e2		bra $c51b	                bra LC51B

1068							;-------------------------------------------------------------------------
1069							;
1070							; VDU 17 (&11) Define text colour [MasRef E.3-7]
1071							;
1072	.c539						vdu17EntryPoint:
1073	.c539		a0 00		ldy #$00	                ldy #$00
1074	.c53b		ad 23 03	lda $0323	                lda $0323
1075	.c53e		10 01		bpl $c541	                bpl LC541
1076	.c540		c8		iny		                iny
1077	.c541						LC541:
1078	.c541		2d 60 03	and $0360	                and $0360
1079	.c544		85 da		sta $da		                sta $DA
1080	.c546		ad 60 03	lda $0360	                lda $0360
1081	.c549		f0 18		beq $c563	                beq LC563
1082	.c54b		29 07		and #$07	                and #$07
1083	.c54d		18		clc		                clc
1084	.c54e		65 da		adc $da		                adc $DA
1085	.c550		aa		tax		                tax
1086	.c551		bd 4b e1	lda $e14b,x	                lda solidColoursTable-1,x
1087	.c554		99 57 03	sta $0357,y	                sta $0357,y
1088	.c557		ad 57 03	lda $0357	                lda $0357
1089	.c55a		49 ff		eor #$ff	                eor #$FF
1090	.c55c		85 d3		sta $d3		                sta ZEOR
1091	.c55e		4d 58 03	eor $0358	                eor $0358
1092	.c561		85 d2		sta $d2		                sta ZORA
1093	.c563						LC563:
1094	.c563		60		rts		                rts

1096							;-------------------------------------------------------------------------
1097							;
1098							; VDU 18 (&12) Define graphics colour [MasRef E.3-7]
1099							;
1100	.c564						vdu18EntryPoint:
1101	.c564		a0 00		ldy #$00	                ldy #$00                    ;assume setting foreground
1102	.c566		ad 23 03	lda $0323	                lda vduv.queueEnd-1         ;get colour
1103	.c569		10 01		bpl $c56c	                bpl +                     ;taken if setting foreground
1104	.c56b		c8		iny		                iny                       ;setting background
1105	.c56c						+
1106	.c56c		2d 60 03	and $0360	                and vduv.numberOfLogicalColoursMinusOne
1107	.c56f		99 6d 03	sta $036d,y	                sta vduv.foregroundGraphicsColour,y
1108	.c572		ad 22 03	lda $0322	                lda vduv.queueEnd-2          ;get GCOL mode
1109	.c575		99 5b 03	sta $035b,y	                sta vduv.foregroundGCOLMode,y
1110	.c578		29 f0		and #$f0	                and #$F0                     ;non-zero if ECF
1111	.c57a		99 6a 03	sta $036a,y	                sta vduv.isForegroundECF,y
1112	.c57d						initializeCurrentECFPatterns:
1113	.c57d		ad 5b 03	lda $035b	                lda vduv.foregroundGCOLMode
1114	.c580		ae 6d 03	ldx $036d	                ldx vduv.foregroundGraphicsColour
1115	.c583		a0 00		ldy #$00	                ldy #andy.fgECFPattern-andy.currentECFPatterns
1116	.c585		20 90 c5	jsr $c590	                jsr initializeCurrentECFPattern
1117	.c588		ad 5c 03	lda $035c	                lda vduv.backgroundGCOLMode
1118	.c58b		ae 6e 03	ldx $036e	                ldx vduv.backgroundGraphicsColour
1119	.c58e		a0 08		ldy #$08	                ldy #andy.bgECFPattern-andy.currentECFPatterns
1120	.c590						initializeCurrentECFPattern:
1121	.c590		29 f0		and #$f0	                and #$F0                     ;GCOL mode ECF bits
1122	.c592		d0 18		bne $c5ac	                bne initializeECFPatternFromPattern

1124	.c594						initializeECFPatternFromColour:
1125	.c594		86 da		stx $da		                stx ZTEMP+0                  ;colour low bits
1126	.c596		ad 60 03	lda $0360	                lda vduv.numberOfLogicalColoursMinusOne
1127	.c599		29 07		and #$07	                and #$07
1128	.c59b		18		clc		                clc
1129	.c59c		65 da		adc $da		                adc ZTEMP+0
1130	.c59e		aa		tax		                tax
1131							                ; use solid colour as ECF "pattern".
1132	.c59f		bd 4b e1	lda $e14b,x	                lda solidColoursTable-1,x
1133	.c5a2		a2 07		ldx #$07	                ldx #$07
1134	.c5a4						-
1135	.c5a4		99 20 88	sta $8820,y	                sta andy.fgECFPattern,y
1136	.c5a7		c8		iny		                iny
1137	.c5a8		ca		dex		                dex
1138	.c5a9		10 f9		bpl $c5a4	                bpl -
1139	.c5ab		60		rts		                rts

1141	.c5ac						initializeECFPatternFromPattern:
1142	.c5ac		4a		lsr a		                lsr a                        ;(index+1)*8
1143	.c5ad		aa		tax		                tax
1144	.c5ae		a9 07		lda #$07	                lda #$07
1145	.c5b0		85 da		sta $da		                sta ZTEMP+0
1146	.c5b2						-
1147	.c5b2		bd f8 87	lda $87f8,x	                lda andy.ecfPatterns-8,x     ;-8 due to index+1 above
1148	.c5b5		99 20 88	sta $8820,y	                sta andy.fgECFPattern,y
1149	.c5b8		e8		inx		                inx
1150	.c5b9		c8		iny		                iny
1151	.c5ba		c6 da		dec $da		                dec ZTEMP+0
1152	.c5bc		10 f4		bpl $c5b2	                bpl -
1153	.c5be		60		rts		                rts

1155							;-------------------------------------------------------------------------
1156							;
1157							; VDU 20 (&14) Restore default logical colours [MasRef E.3-10]
1158							;
1159	.c5bf						setBackgroundTextColourForTeletext:
1160	.c5bf		a9 20		lda #$20	                lda #' '
1161	.c5c1		8d 58 03	sta $0358	                sta vduv.backgroundTextColour
1162	.c5c4		60		rts		                rts

1164	.c5c5						vdu20EntryPoint:
1165	.c5c5		a2 05		ldx #$05	                ldx #$05
1166	.c5c7						-
1167	.c5c7		9e 57 03	stz $0357,x	                stz vduv.foregroundTextColour,x
1168	.c5ca		ca		dex		                dex
1169	.c5cb		10 fa		bpl $c5c7	                bpl -
1170	.c5cd		9c 6e 03	stz $036e	                stz vduv.backgroundGraphicsColour
1171	.c5d0		9c 6b 03	stz $036b	                stz vduv.isBackgroundECF
1172	.c5d3		a9 ff		lda #$ff	                lda #%11111111
1173	.c5d5		ae 60 03	ldx $0360	                ldx vduv.numberOfLogicalColoursMinusOne
1174	.c5d8		f0 e5		beq $c5bf	                beq setBackgroundTextColourForTeletext
1175	.c5da		e0 0f		cpx #$0f	                cpx #$0F
1176	.c5dc		d0 02		bne $c5e0	                bne +                        ;taken unless MODE 2
1177	.c5de		a9 3f		lda #$3f	                lda #%00111111               ;MODE 2 default foreground colour is 7
1178	.c5e0						+
1179	.c5e0		8d 57 03	sta $0357	                sta vduv.foregroundTextColour
1180	.c5e3		49 ff		eor #$ff	                eor #$FF
1181	.c5e5		85 d2		sta $d2		                sta ZORA
1182	.c5e7		85 d3		sta $d3		                sta ZEOR
1183	.c5e9		8a		txa		                txa
1184	.c5ea		29 07		and #$07	                and #$07
1185	.c5ec		8d 6d 03	sta $036d	                sta vduv.foregroundGraphicsColour
1186	.c5ef		9c 6a 03	stz $036a	                stz vduv.isForegroundECF
1187	.c5f2		da		phx		                phx                          ;save numberOfLogicalColoursMinusOne
1188	.c5f3		20 7d c5	jsr $c57d	                jsr initializeCurrentECFPatterns
1189	.c5f6		fa		plx		                plx                          ;restore numberOfLogicalColoursMinusOne
1190	.c5f7		8e 1f 03	stx $031f	                stx vduv.queueEnd-5          ;Prepare VDU19,<max logical colour>
1191	.c5fa		e0 03		cpx #$03	                cpx #$03
1192	.c5fc		f0 11		beq $c60f	                beq reset4Colours            ;taken if MODE 1/5
1193	.c5fe		90 20		bcc $c620	                bcc reset2Colours            ;taken if MODE 0/3/4/6
1194	.c600						reset16Colours:
1195	.c600		8e 20 03	stx $0320	                stx vduv.queueEnd-4          ;start with VDU19,15,15,_,_,_
1196	.c603						-
1197	.c603		20 2d c6	jsr $c62d	                jsr vdu19EntryPoint
1198	.c606		ce 20 03	dec $0320	                dec vduv.queueEnd-4
1199	.c609		ce 1f 03	dec $031f	                dec vduv.queueEnd-5
1200	.c60c		10 f5		bpl $c603	                bpl -
1201	.c60e		60		rts		                rts

1203	.c60f						reset4Colours:
1204	.c60f		a2 07		ldx #$07	                ldx #$07
1205	.c611		8e 20 03	stx $0320	                stx vduv.queueEnd-4          ;start with VDU19,3,7,_,_,_
1206	.c614						-
1207	.c614		20 2d c6	jsr $c62d	                jsr vdu19EntryPoint          ;2,3, then 1,1, then 0,0
1208	.c617		4e 20 03	lsr $0320	                lsr vduv.queueEnd-4
1209	.c61a		ce 1f 03	dec $031f	                dec vduv.queueEnd-5
1210	.c61d		10 f5		bpl $c614	                bpl -
1211	.c61f		60		rts		                rts

1213	.c620						reset2Colours:
1214	.c620		a2 07		ldx #$07	                ldx #$07
1215	.c622		20 2a c6	jsr $c62a	                jsr +                        ;VDU19,1,7,_,_,_
1216	.c625		a2 00		ldx #$00	                ldx #$00
1217	.c627		9c 1f 03	stz $031f	                stz vduv.queueEnd-5          ;VDU19,0,0,_,_,_
1218	.c62a						+
1219	.c62a		8e 20 03	stx $0320	                stx vduv.queueEnd-4          ;VDU19,N,X,_,_,_

1221							                ; fall through to VDU19

1223							;-------------------------------------------------------------------------
1224							;
1225							; VDU 19 (&13) Define logical colour [MasRef E.3-9]
1226							;
1227	.c62d						vdu19EntryPoint:
1228	.c62d		08		php		                php
1229	.c62e		78		sei		                sei
1230	.c62f		ad 1f 03	lda $031f	                lda vduv.queueEnd-5          ;get logical colour
1231	.c632		2d 60 03	and $0360	                and vduv.numberOfLogicalColoursMinusOne ;apply logical colour limit
1232	.c635		aa		tax		                tax                        ;X = clamped logical colour
1233	.c636		ad 20 03	lda $0320	                lda vduv.queueEnd-4        ;get physical colour
1234	.c639						LC639:
1235	.c639		29 0f		and #$0f	                and #$0F                     ;apply physical colour limit
1236	.c63b		9d 6f 03	sta $036f,x	                sta vduv.currentPalette,x    ;update palette
1237	.c63e		a8		tay		                tay                          ;Y = physical colour
1238	.c63f		ad 60 03	lda $0360	                lda vduv.numberOfLogicalColoursMinusOne
1239	.c642		85 fa		sta $fa		                sta SEIWKA
1240	.c644		c9 03		cmp #$03	                cmp #$03 ;Z=1 C=1 if 4 colour; Z=0 C=1 if 16 colour; Z=0 C=0 if 2 colour
1241	.c646		08		php		                php      ;save flags
1242	.c647		8a		txa		                txa                          ;A = logical colour

1244							                ;put the logical colour value in the top 1, 2 or 4
1245							                ;bits of SEIWKA, depending on the colour depth.
1246							                ;
1247							                ; 2 colours: turn %0000000a into %a0000000
1248							                ; 4 colours: turn %000000ab into %ab000000
1249							                ;16 colours: turn %0000abcd into %abcd0000
1250	.c648						-
1251	.c648		4a		lsr a		                lsr a
1252	.c649		66 fa		ror $fa		                ror SEIWKA
1253	.c64b		b0 fb		bcs $c648	                bcs -
1254	.c64d		06 fa		asl $fa		                asl SEIWKA

1256	.c64f		98		tya		                tya                          ;A = physical colour
1257	.c650		05 fa		ora $fa		                ora SEIWKA                   ;mix in logical colour
1258	.c652		aa		tax		                tax                          ;X = VPALETTE value
1259	.c653		a0 f0		ldy #$f0	                ldy #$F0 ;counts up to zero - counter for setting
1260							                         ;multiple logical colours [AUG p380]
1261	.c655						LC655:
1262	.c655		28		plp		                plp                          ;restore flags
1263	.c656		08		php		                php                          ;save flags
1264	.c657		d0 03		bne $c65c	                bne +                     ;taken if 2 colour/16 colour
1265	.c659		20 6f c6	jsr $c66f	                jsr fixUpVPALETTEFor4Colours
1266	.c65c						+
1267	.c65c		20 61 f2	jsr $f261	                jsr writeVPALETTE
1268	.c65f		18		clc		                clc
1269	.c660		98		tya		                tya
1270	.c661		6d 60 03	adc $0360	                adc vduv.numberOfLogicalColoursMinusOne
1271	.c664		a8		tay		                tay
1272	.c665		8a		txa		                txa
1273	.c666		69 10		adc #$10	                adc #$10                     ;next logical colour
1274	.c668		aa		tax		                tax
1275	.c669		c8		iny		                iny                          ;Y+=numberOfLogicalColours
1276	.c66a		d0 e9		bne $c655	                bne LC655                    ;all logical colours set once zero
1277	.c66c		28		plp		                plp
1278	.c66d		28		plp		                plp
1279	.c66e		60		rts		                rts

1281	.c66f						fixUpVPALETTEFor4Colours:
1282	.c66f		2a		rol a		                rol a                        ;A BCDabcd1
1283	.c670		85 da		sta $da		                sta ZTEMP+0                  ;  BCDabcd1
1284	.c672		2a		rol a		                rol a                        ;B CDabcd1A
1285	.c673		2a		rol a		                rol a                        ;C Dabcd1AB
1286	.c674		08		php		                php                          ;C
1287	.c675		26 da		rol $da		                rol ZTEMP+0                  ;B CDabcd1C
1288	.c677		6a		ror a		                ror a                        ;B BDabcd1A
1289	.c678		28		plp		                plp                          ;C BDabcd1A
1290	.c679		6a		ror a		                ror a                        ;A CBDabcd1
1291	.c67a		6a		ror a		                ror a                        ;1 ACBDabcd
1292	.c67b		60		rts		                rts                          ;

1294							;-------------------------------------------------------------------------
1295							;
1296							; VDU 23 (&17) Various functions [MasRef E.3-12]
1297							;
1298	.c67c						vdu23EntryPoint:
1299	.c67c		ad 1b 03	lda $031b	                lda vduv.queueEnd-9           ;get VDU 23 code
1300	.c67f		c9 20		cmp #$20	                cmp #$20
1301	.c681		90 0e		bcc $c691	                bcc LC691         ;branch taken if <32 - i.e., special

1303							                ; copy the 8 bytes of character definition to the
1304							                ; appropriate place.
1305	.c683		20 2c e2	jsr $e22c	                jsr getSoftCharacterDefinitionAddress
1306	.c686		a0 07		ldy #$07	                ldy #$07
1307	.c688						LC688:
1308	.c688		b9 1c 03	lda $031c,y	                lda vduv.queueEnd-8,y
1309	.c68b		91 de		sta ($de),y	                sta ($DE),y
1310	.c68d		88		dey		                dey
1311	.c68e		10 f8		bpl $c688	                bpl LC688
1312	.c690		60		rts		                rts

1314	.c691						LC691:
1315	.c691		0a		asl a		                asl a
1316	.c692		aa		tax		                tax
1317	.c693		4a		lsr a		                lsr a
1318	.c694		c9 11		cmp #$11	                cmp #$11
1319	.c696		b0 0f		bcs $c6a7	                bcs callVDUV    ;call with C=1 - invalid code [MasRef
1320							                                ;E.3-19]
1321	.c698		7c 69 e0	jmp ($e069,x)	                jmp (vdu23EntryPointTable,x)

1323							;-------------------------------------------------------------------------
1324							;
1325							; VDU 25 (&19) PLOT commands [MasRef E.3-21]
1326							;
1327	.c69b						vdu25EntryPoint:
1328	.c69b		ae 61 03	ldx $0361	                ldx vduv.pixelsPerByteMinusOne
1329	.c69e		f0 03		beq $c6a3	                beq callVDUVForPLOT          ;non-graphics PLOT
1330	.c6a0		4c 46 d1	jmp $d146	                jmp handlePLOT

1332							;-------------------------------------------------------------------------
1333							;
1334							; Call VDUV for a PLOT call, either to handle non-graphics PLOT
1335							; [MasRef E.3-21] or PLOT 240-255 [MasRef E.3-34].
1336							;
1337	.c6a3						callVDUVForPLOT:
1338	.c6a3		ad 1f 03	lda $031f	                lda vduv.queueEnd-5          ;get PLOT code
1339	.c6a6		18		clc		                clc ;call with C=0 - non-graphics PLOT [MasRef E.3-21]

1341							;-------------------------------------------------------------------------
1342							;
1343							; Call VDUV.
1344							;
1345	.c6a7						callVDUV:
1346							                .if version<350
1347	.c6a7		6c 26 02	jmp ($0226)	                jmp (VDUV)
1350							                .endif

1352							;-------------------------------------------------------------------------
1353							;
1354							; VDU 26 (&1A) Restore default windows [MasRef E.3-34]
1355							;
1356	.c6aa						vdu26EntryPoint:
1357	.c6aa		a2 2c		ldx #$2c	                ldx #VDUVariables.workspace._2C
1358	.c6ac						-
1359	.c6ac		9e 00 03	stz $0300,x	                stz vduv,x                    ;reset workspace
1360	.c6af		ca		dex		                dex
1361	.c6b0		10 fa		bpl $c6ac	                bpl -

1363	.c6b2		20 a2 e2	jsr $e2a2	                jsr getDefaultBoundsForCurrentScreenMODE
1364	.c6b5		8e 0a 03	stx $030a	                stx vduv.textWindowRight
1365	.c6b8		8c 09 03	sty $0309	                sty vduv.textWindowBottom

1367	.c6bb		8a		txa		                txa
1368	.c6bc		20 80 c7	jsr $c780	                jsr setTextWindowWidthInBytes

1370							                ; Set up the VDU queue as if VDU 24,0;0;1279;1023;,
1371							                ; then call the VDU 24 entry point.

1373							                ; 1c - ll - $00
1374							                ; 1d - lh - $00
1375							                ; 1e - tl - $00
1376							                ; 1f - th - $00
1377							                ; 20 - rl - $ff
1378							                ; 21 - rh - $04
1379							                ; 22 - tl - $ff
1380							                ; 23 - th - $03

1382	.c6bf		a0 03		ldy #$03	                ldy #$03
1383	.c6c1		8c 23 03	sty $0323	                sty $0323
1384	.c6c4		c8		iny		                iny
1385	.c6c5		8c 21 03	sty $0321	                sty $0321
1386	.c6c8		ce 22 03	dec $0322	                dec $0322
1387	.c6cb		ce 20 03	dec $0320	                dec $0320
1388	.c6ce		20 1f c7	jsr $c71f	                jsr vdu24EntryPoint

1390	.c6d1		a9 08		lda #$08	                lda #STATE.isTextWindow
1391	.c6d3		14 d0		trb $d0		                trb STATE                    ;reset isTextWindow

1393	.c6d5		4c 7c c4	jmp $c47c	                jmp vdu30EntryPoint          ;reset text cursor

1395							;-------------------------------------------------------------------------
1396							;
1397							; Update CRTC cursor address to reflect text cursor position.
1398							;
1399	.c6d8						updateCRTCTextCursor:
1400	.c6d8		20 fa cc	jsr $ccfa	                jsr updateZMEMTWithTextCursorPosition
1401	.c6db		80 10		bra $c6ed	                bra updateCRTCCursorAddress

1403							;-------------------------------------------------------------------------

1405	.c6dd						setCRTCCursorAddress:
1406	.c6dd		8e 4a 03	stx $034a	                stx vduv.textCursorCRTCAddress+0
1407	.c6e0		8d 4b 03	sta $034b	                sta vduv.textCursorCRTCAddress+1
1408	.c6e3		10 04		bpl $c6e9	                bpl +
1409	.c6e5		38		sec		                sec
1410	.c6e6		ed 54 03	sbc $0354	                sbc vduv.screenSizeHighByte
1411	.c6e9						+
1412	.c6e9		86 d8		stx $d8		                stx ZMEMT+0
1413	.c6eb		85 d9		sta $d9		                sta ZMEMT+1

1415							;-------------------------------------------------------------------------
1416							;
1417							;
1418	.c6ed						updateCRTCCursorAddress:
1419	.c6ed		ae 4a 03	ldx $034a	                ldx vduv.textCursorCRTCAddress+0
1420	.c6f0		ad 4b 03	lda $034b	                lda vduv.textCursorCRTCAddress+1
1421	.c6f3		a0 0e		ldy #$0e	                ldy #$0E

1423							;-------------------------------------------------------------------------
1424							;
1425							; Set CRTC address - cursor, or screen start.
1426							;
1427							; entry:
1428							;
1429							; A (msb), X (msb) = 6502 address to set
1430							;
1431							; Y = first CRTC register to set
1432							;
1433	.c6f5						setCRTCAddress:
1434	.c6f5		48		pha		                pha                          ;save screen address MSB
1435	.c6f6		ad 55 03	lda $0355	                lda vduv.currentScreenMODE
1436	.c6f9		c9 07		cmp #$07	                cmp #$07
1437	.c6fb		68		pla		                pla                        ;restore screen address MSB
1438	.c6fc		b0 0f		bcs $c70d	                bcs adjustAddressForMODE7
1439	.c6fe		86 da		stx $da		                stx ZTEMP+0
1440	.c700		4a		lsr a		                lsr a
1441	.c701		66 da		ror $da		                ror ZTEMP+0                  ;/2
1442	.c703		4a		lsr a		                lsr a
1443	.c704		66 da		ror $da		                ror ZTEMP+0                  ;/4
1444	.c706		4a		lsr a		                lsr a
1445	.c707		66 da		ror $da		                ror ZTEMP+0                  ;/8
1446	.c709		a6 da		ldx $da		                ldx ZTEMP+0
1447	.c70b		80 04		bra $c711	                bra setCRTCAddressRegisters

1449	.c70d						adjustAddressForMODE7:
1450							                ; C=1
1451	.c70d		e9 74		sbc #$74	                sbc #$74                 ;adjust for Mode 7 addressing
1452	.c70f		49 20		eor #$20	                eor #$20                 ;adjust for Mode 7 addressing
1453	.c711						setCRTCAddressRegisters:
1454	.c711		8c 00 fe	sty $fe00	                sty CRTC+0
1455	.c714		8d 01 fe	sta $fe01	                sta CRTC+1
1456	.c717		c8		iny		                iny
1457	.c718		8c 00 fe	sty $fe00	                sty CRTC+0
1458	.c71b		8e 01 fe	stx $fe01	                stx CRTC+1
1459	.c71e		60		rts		                rts

1461							;-------------------------------------------------------------------------
1462							;
1463							; VDU 24 (&18) Define graphics window [MasRef E.3-21]
1464							;
1465							; VDU queue:
1466							;
1467							; -8 = <left
1468							; -7 = >left
1469							; -6 = <bottom
1470							; -5 = >bottom
1471							; -4 = <right
1472							; -3 = >right
1473							; -2 = <top
1474							; -1 = >top
1475							;
1476	.c71f						vdu24EntryPoint:
1477	.c71f		20 79 c7	jsr $c779	                jsr LC779

1479	.c722		a2 02		ldx #$02	                ldx #2
1480	.c724						-
1481	.c724		38		sec		                sec

1483							                ; <height when X=2, then <width when X=0
1484	.c725		bd 20 03	lda $0320,x	                lda vduv.queueEnd-4+0,x
1485	.c728		fd 1c 03	sbc $031c,x	                sbc vduv.queueEnd-8+0,x
1486	.c72b		9d 2c 03	sta $032c,x	                sta vduv.workspace._2C+0,x

1488							                ; >height when X=2, then >width when X=0
1489	.c72e		bd 21 03	lda $0321,x	                lda vduv.queueEnd-4+1,x
1490	.c731		fd 1d 03	sbc $031d,x	                sbc vduv.queueEnd-8+1,x
1491	.c734		9d 2d 03	sta $032d,x	                sta vduv.workspace._2C+1,x

1493	.c737		ca		dex		                dex
1494	.c738		ca		dex		                dex
1495	.c739		10 e9		bpl $c724	                bpl -

1497	.c73b		0d 2f 03	ora $032f	                ora vduv.workspace._2C+3     ;A=>width|>height
1498	.c73e		30 39		bmi $c779	                bmi LC779 ;taken if either dimension negative - window invalid
1499	.c740		a2 20		ldx #$20	                ldx #VDUVariables.queueEnd-4 ;left bottom
1500	.c742		20 de d1	jsr $d1de	                jsr eigabsEntryPoint         ;convert to pixels
1501	.c745		a2 1c		ldx #$1c	                ldx #VDUVariables.queueEnd-8 ;right top
1502	.c747		20 de d1	jsr $d1de	                jsr eigabsEntryPoint         ;convert to pixels
1503	.c74a		ad 1f 03	lda $031f	                lda vduv.queueEnd-5          ;>bottom
1504	.c74d		0d 1d 03	ora $031d	                ora vduv.queueEnd-7          ;>left
1505	.c750		30 27		bmi $c779	                bmi LC779 ;taken if either bottom or left negative - window invalid
1506	.c752		ad 23 03	lda $0323	                lda vduv.queueEnd-1          ;>top
1507	.c755		d0 22		bne $c779	                bne LC779          ;taken if top>=256 - window invalid
1508	.c757		ae 55 03	ldx $0355	                ldx vduv.currentScreenMODE
1509	.c75a		ad 21 03	lda $0321	                lda vduv.queueEnd-3          ;>right
1510	.c75d		85 da		sta $da		                sta ZTEMP+0
1511	.c75f		ad 20 03	lda $0320	                lda vduv.queueEnd-4          ;<right
1512	.c762		46 da		lsr $da		                lsr ZTEMP+0                  ;>(right/2)
1513	.c764		6a		ror a		                ror a                        ;<(right/2)
1514	.c765		46 da		lsr $da		                lsr ZTEMP+0                  ;>(right/4)

1516							                ; 639>>2=159 - so any valid pixel X in any mode will
1517							                ; have an MSB of 0 after being shifted right 2.
1518	.c767		d0 10		bne $c779	                bne LC779 ;taken if right edge definitely off screen - window invalid
1519	.c769		6a		ror a		                ror a     ;<(right/4)
1520	.c76a		4a		lsr a		                lsr a     ;<(right/8)
1521	.c76b		dd 09 e1	cmp $e109,x	                cmp modeMaxColumn,x
1522	.c76e		f0 02		beq $c772	                beq LC772                    ;taken if right edge just on screen
1523	.c770		10 07		bpl $c779	                bpl LC779 ;taken if right edge off screen - window definitely invalid
1524	.c772						LC772:
1525	.c772		a0 00		ldy #$00	                ldy #VDUVariables.graphicsWindowPixelsLeft
1526	.c774		a2 1c		ldx #$1c	                ldx #VDUVariables.queueEnd-8
1527	.c776		20 04 c9	jsr $c904	                jsr copyEightBytesWithinVDUVariables
1528	.c779						LC779:
1529	.c779		a2 10		ldx #$10	                ldx #VDUVariables.graphicsCursorPositionX
1530	.c77b		a0 28		ldy #$28	                ldy #VDUVariables.workspace._28
1531	.c77d		4c ba e2	jmp $e2ba	                jmp exchangeFourVDUBytes

1533							;-------------------------------------------------------------------------
1534							;
1535							; Call getBytesPerInclusiveTextRow, and store the result in the
1536							; textWindowWidthInBytes VDU variable.
1537							;
1538	.c780						setTextWindowWidthInBytes:
1539	.c780		20 3b c9	jsr $c93b	                jsr getBytesPerInclusiveTextRow
1540	.c783		8d 4c 03	sta $034c	                sta vduv.textWindowWidthInBytes+0
1541	.c786		8e 4d 03	stx $034d	                stx vduv.textWindowWidthInBytes+1
1542	.c789		60		rts		                rts

1544							;-------------------------------------------------------------------------
1545							;
1546							; VDU 29 (&1D) Define graphics origin [MasRef E.3-35]
1547							;
1548	.c78a						vdu29EntryPoint:
1549	.c78a		a2 20		ldx #$20	                ldx #VDUVariables.queueEnd-4
1550	.c78c		a0 0c		ldy #$0c	                ldy #VDUVariables.graphicsWindowOriginX
1551	.c78e		20 1e c9	jsr $c91e	                jsr copyFourBytesWithinVDUVariables
1552	.c791		4c df c4	jmp $c4df	                jmp LC4DF

1554							;-------------------------------------------------------------------------
1555							;
1556							; VDU 22 (&16) Select screen mode [MasRef E.3-11]
1557							;
1558	.c794						vdu22EntryPoint:
1559	.c794		ad 23 03	lda $0323	                lda vduv.queueEnd-1          ;get MODE number
1560	.c797		80 23		bra $c7bc	                bra setMODE

1562							;-------------------------------------------------------------------------
1563							;
1564	.c799						setStartupMODE:
1565							                .if version==350
1567							                .endif
1568	.c799		85 da		sta $da		                sta ZTEMP+0                  ;save MODE
1569	.c79b		a5 f4		lda $f4		                lda $F4
1570	.c79d		48		pha		                pha
1571	.c79e		09 80		ora #$80	                ora #$80                     ;page in ANDY
1572	.c7a0		20 92 e5	jsr $e592	                jsr selectROMA
1573	.c7a3		20 aa c7	jsr $c7aa	                jsr +
1574	.c7a6		68		pla		                pla
1575	.c7a7		4c 92 e5	jmp $e592	                jmp selectROMA               ;restore old ROM

1577	.c7aa						+
1578							                ; TODO but what of the reserved byte here?
1579	.c7aa		a2 7f		ldx #$7f	                ldx #size(VDUVariables)-1
1580	.c7ac		64 d0		stz $d0		                stz STATE
1581	.c7ae		ad 66 03	lda $0366	                lda vduv.cursorFlags
1582	.c7b1						-
1583	.c7b1		9e ff 02	stz $02ff,x	                stz vduv-1,x
1584	.c7b4		ca		dex		                dex
1585	.c7b5		d0 fa		bne $c7b1	                bne -
1586	.c7b7		8d 66 03	sta $0366	                sta vduv.cursorFlags
1587	.c7ba		a5 da		lda $da		                lda ZTEMP                    ;restore MODE

1589							                ; fall through to setMODE

1591							;-------------------------------------------------------------------------
1592							;
1593							;
1594							;
1595	.c7bc						setMODE:
1596	.c7bc		9c 8a 02	stz $028a	                stz vduDriverMemory
1597	.c7bf		9c 8b 02	stz $028b	                stz displayMemory
1598	.c7c2		a8		tay		                tay                          ;Y=mode
1599	.c7c3		30 10		bmi $c7d5	                bmi setShadowMODE
1600	.c7c5		ae 7f 02	ldx $027f	                ldx shadowRAMState
1601	.c7c8		f0 0b		beq $c7d5	                beq setShadowMODE
1602	.c7ca		a9 10		lda #$10	                lda #STATE.isShadowMode
1603	.c7cc		14 d0		trb $d0		                trb STATE
1604	.c7ce		a9 03		lda #$03	                lda #ACCCON.D|ACCCON.E
1605	.c7d0		1c 34 fe	trb $fe34	                trb ACCCON ;display main RAM, VDU code accesses main RAM
1606	.c7d3		80 09		bra $c7de	                bra +

1608	.c7d5						setShadowMODE:
1609	.c7d5		a9 10		lda #$10	                lda #STATE.isShadowMode
1610	.c7d7		04 d0		tsb $d0		                tsb STATE
1611	.c7d9		a9 03		lda #$03	                lda #ACCCON.D|ACCCON.E
1612	.c7db		0c 34 fe	tsb $fe34	                tsb ACCCON ;display shadow RAM, VDU code accesses shadow RAM
1613	.c7de						+
1614	.c7de		98		tya		                tya                          ;A=mode
1615	.c7df		29 07		and #$07	                and #$07                     ;get MODE 0-7
1616	.c7e1		aa		tax		                tax                          ;X=MODE 0-7
1617	.c7e2		8e 55 03	stx $0355	                stx vduv.currentScreenMODE
1618	.c7e5		bd 3c e1	lda $e13c,x	                lda numberOfLogicalColoursMinusOneForMODE,x
1619	.c7e8		8d 60 03	sta $0360	                sta vduv.numberOfLogicalColoursMinusOne
1620	.c7eb		bd 19 e1	lda $e119,x	                lda bytesPerCharacterForMODE,x
1621	.c7ee		8d 4f 03	sta $034f	                sta vduv.bytesPerCharacter
1622	.c7f1		bd 62 e1	lda $e162,x	                lda pixelsPerByteMinusOneForMODE,x
1623	.c7f4		8d 61 03	sta $0361	                sta vduv.pixelsPerByteMinusOne
1624	.c7f7		d0 02		bne $c7fb	                bne +                        ;taken if graphics mode
1625	.c7f9		a9 07		lda #$07	                lda #$07                     ;assume 8 px/byte for non-graphics modes
1626	.c7fb						+
1627	.c7fb		0a		asl a		                asl a            ;convert to pixelMasks index for rightmost pixel
1628	.c7fc		a8		tay		                tay
1629	.c7fd		b9 2e e1	lda $e12e,y	                lda pixelMasks-1,y
1630	.c800		8d 63 03	sta $0363	                sta vduv.colourMaskRight
1631	.c803						-
1632	.c803		0a		asl a		                asl a
1633	.c804		10 fd		bpl $c803	                bpl -   ;keep shifting until leftmost pixel mask found
1634	.c806		8d 62 03	sta $0362	                sta vduv.colourMaskLeft
1635	.c809		bc 68 e1	ldy $e168,x	                ldy screenMODEGroupForMODE,x
1636	.c80c		8c 56 03	sty $0356	                sty vduv.currentScreenMODEGroup
1637	.c80f		b9 74 e1	lda $e174,y	                lda latchBit4ForScreenMODEGroup,y
1638	.c812		08		php		                php
1639	.c813		78		sei		                sei
1640	.c814		8d 40 fe	sta $fe40	                sta systemVIA.orb
1641	.c817		b9 70 e1	lda $e170,y	                lda latchBit5ForScreenMODEGroup,y
1642	.c81a		8d 40 fe	sta $fe40	                sta systemVIA.orb
1643	.c81d		28		plp		                plp
1644	.c81e		b9 79 e1	lda $e179,y	                lda screenSizeHighByteForScreenMODEGroup,y
1645	.c821		8d 54 03	sta $0354	                sta vduv.screenSizeHighByte
1646	.c824		b9 7e e1	lda $e17e,y	                lda startScreenAddressHighByteForScreenMODEGroup,y
1647	.c827		8d 4e 03	sta $034e	                sta vduv.startScreenAddressHighByte
1648	.c82a		a9 ee		lda #$ee	                lda #STATE.isVDU21|STATE.isCursorEditing|STATE.isVDU5|STATE.isTextWindow|STATE.isPagedScrolling|STATE.isScrollingDisabled
1649	.c82c		14 d0		trb $d0		                trb STATE
1650	.c82e		ae 55 03	ldx $0355	                ldx vduv.currentScreenMODE
1651	.c831		bd 11 e1	lda $e111,x	                lda vcontrolForScreenMODE,x
1652	.c834		20 50 f2	jsr $f250	                jsr setVCONTROL
1653	.c837		08		php		                php
1654	.c838		78		sei		                sei
1655	.c839		be 83 e1	ldx $e183,y	                ldx crtcRegisterLastIndexForScreenMODEGroup,y
1656	.c83c		a0 0b		ldy #$0b	                ldy #$0B
1657	.c83e						-
1658	.c83e		bd 88 e1	lda $e188,x	                lda crtcRegisterValues,x
1659	.c841		20 01 cf	jsr $cf01	                jsr setCRTCRegister
1660	.c844		ca		dex		                dex
1661	.c845		88		dey		                dey
1662	.c846		10 f6		bpl $c83e	                bpl -
1663	.c848		28		plp		                plp
1664	.c849		20 c5 c5	jsr $c5c5	                jsr vdu20EntryPoint
1665	.c84c		20 6d cf	jsr $cf6d	                jsr vdu23_11_EntryPoint
1666	.c84f		a9 aa		lda #$aa	                lda #%10101010
1667	.c851		8d 67 03	sta $0367	                sta vduv.dotPattern
1668	.c854		8d 68 03	sta $0368	                sta vduv.dotPatternState
1669	.c857		20 aa c6	jsr $c6aa	                jsr vdu26EntryPoint
1670	.c85a		ad 4c 03	lda $034c	                lda vduv.textWindowWidthInBytes+0
1671	.c85d		ae 4d 03	ldx $034d	                ldx vduv.textWindowWidthInBytes+1
1672	.c860		8d 52 03	sta $0352	                sta vduv.bytesPerCharacterRow+0
1673	.c863		8e 53 03	stx $0353	                stx vduv.bytesPerCharacterRow+1

1675							                ; Do a fast hardware CLS of the whole screen
1676							                ; ------------------------------------------
1677	.c866						clsFastPath:
1678	.c866		a2 00		ldx #$00	                ldx #$00
1679	.c868		ad 4e 03	lda $034e	                lda vduv.startScreenAddressHighByte
1680	.c86b		9c 50 03	stz $0350	                stz vduv.screenTopLeftAddress+0
1681	.c86e		8d 51 03	sta $0351	                sta vduv.screenTopLeftAddress+1
1682	.c871		20 dd c6	jsr $c6dd	                jsr setCRTCCursorAddress
1683	.c874		a0 0c		ldy #$0c	                ldy #$0C
1684	.c876		20 11 c7	jsr $c711	                jsr setCRTCAddressRegisters
1685	.c879		9c 69 02	stz $0269	                stz pagedModeCounter
1686	.c87c		38		sec		                sec
1687	.c87d		a9 80		lda #$80	                lda #$80
1688	.c87f		ed 4e 03	sbc $034e	                sbc vduv.startScreenAddressHighByte
1689	.c882		aa		tax		                tax
1690	.c883		a0 00		ldy #$00	                ldy #$00
1691	.c885		20 84 cb	jsr $cb84	                jsr clearTextMemory
1692	.c888		4c 7c c4	jmp $c47c	                jmp vdu30EntryPoint

1694	.c88b						LC88B:
1695	.c88b		20 cf c8	jsr $c8cf	                jsr LC8CF                    ; Clear paged mode counter
1696	.c88e						LC88E:
1697	.c88e		20 30 f2	jsr $f230	                jsr osbyte76    ; Call KEYV to test Shift & Ctrl keys
1698	.c891		90 02		bcc $c895	                bcc LC895                    ; Ctrl not pressed, exit loop
1699	.c893		30 f6		bmi $c88b	                bmi LC88B                    ; Shift pressed, loop back
1700	.c895						LC895:
1701	.c895		a5 d0		lda $d0		                lda STATE
1702	.c897		49 04		eor #$04	                eor #STATE.isPagedScrolling
1703	.c899		29 46		and #$46	                and #STATE.isCursorEditing|STATE.isPagedScrolling|STATE.isScrollingDisabled;
1704	.c89b		d0 39		bne $c8d6	                bne LC8D6
1705	.c89d		20 d7 c8	jsr $c8d7	                jsr LC8D7
1706	.c8a0		b9 18 03	lda $0318,y	                lda vduv.textCursorXPosition,y
1707	.c8a3		dd 08 03	cmp $0308,x	                cmp vduv.textWindowLeft,x
1708	.c8a6		d0 2b		bne $c8d3	                bne LC8D3
1709							                .if version==400||version==350
1711							                .else
1712	.c8a8		38		sec		                sec
1713	.c8a9		c8		iny		                iny
1714	.c8aa		88		dey		                dey
1715							                .endif
1716	.c8ab		d0 08		bne $c8b5	                bne LC8B5
1717	.c8ad		ad 0a 03	lda $030a	                lda vduv.textWindowRight
1718	.c8b0		ed 08 03	sbc $0308	                sbc vduv.textWindowLeft
1719	.c8b3		80 06		bra $c8bb	                bra LC8BB

1721	.c8b5						LC8B5:
1722	.c8b5		ad 09 03	lda $0309	                lda vduv.textWindowBottom
1723	.c8b8		ed 0b 03	sbc $030b	                sbc vduv.textWindowTop
1724	.c8bb						LC8BB:
1725	.c8bb		48		pha		                pha
1726	.c8bc		4a		lsr a		                lsr a
1727	.c8bd		4a		lsr a		                lsr a
1728	.c8be		85 da		sta $da		                sta ZTEMP+0
1729	.c8c0		38		sec		                sec
1730	.c8c1		68		pla		                pla
1731	.c8c2		e5 da		sbc $da		                sbc ZTEMP+0
1732	.c8c4		cd 69 02	cmp $0269	                cmp pagedModeCounter
1733	.c8c7		b0 0a		bcs $c8d3	                bcs LC8D3
1734	.c8c9						LC8C9:
1735	.c8c9		20 30 f2	jsr $f230	                jsr osbyte76
1736	.c8cc		38		sec		                sec
1737	.c8cd		10 fa		bpl $c8c9	                bpl LC8C9

1739	.c8cf						LC8CF:
1740	.c8cf		9c 69 02	stz $0269	                stz pagedModeCounter        ; Clear paged mode counter
1741							                .if version!=400&&version!=350
1742	.c8d2		ea		nop		                nop
1743							                .endif
1744	.c8d3						LC8D3:
1745	.c8d3		ee 69 02	inc $0269	                inc pagedModeCounter
1746	.c8d6						LC8D6:
1747	.c8d6		60		rts		                rts

1749	.c8d7						LC8D7:
1750	.c8d7		ad 66 03	lda $0366	                lda vduv.cursorFlags
1751	.c8da		29 0e		and #$0e	                and #vduv.cursorFlags.swapAxes|vduv.cursorFlags.invertVertical|vduv.cursorFlags.invertHorizontal
1752	.c8dc		4a		lsr a		                lsr a                        ;xvh
1753	.c8dd		aa		tax		                tax
1754	.c8de		bd 04 e2	lda $e204,x	                lda LE204,x
1755	.c8e1		aa		tax		                tax
1756	.c8e2		29 01		and #$01	                and #$01
1757	.c8e4		a8		tay		                tay
1758	.c8e5		60		rts		                rts

1760							;-------------------------------------------------------------------------
1761							;
1762							; Prepare AABB based on the current graphics cursor and some other
1763							; coordinate.
1764							;
1765							; entry:
1766							;
1767							; X = VDU variable offset of other coordinate (4 bytes: X;Y;)
1768							;
1769							; exit:
1770							;
1771							; vduv.workspace._28 = minimum
1772							;
1773							; vduv.workspace._2c = maximum
1774							;
1775	.c8e6						prepareAABB:
1776	.c8e6		a0 24		ldy #$24	                ldy #VDUVariables.graphicsCursorPixels
1777	.c8e8		20 b7 d5	jsr $d5b7	                jsr sortVDUVariableCoordinates
1778	.c8eb		5a		phy		                phy                          ;save greater Y
1779	.c8ec		da		phx		                phx                          ;save lesser Y
1780	.c8ed		20 cc d5	jsr $d5cc	                jsr sortVDUVariableWords     ;X=lesser X, Y=greater X
1781	.c8f0		68		pla		                pla                          ;A=lesser Y
1782	.c8f1		5a		phy		                phy                          ;save greater X
1783	.c8f2		a0 28		ldy #$28	                ldy #VDUVariables.workspace._28
1784	.c8f4		20 f9 c8	jsr $c8f9	                jsr +
1785	.c8f7		fa		plx		                plx                          ;X=greater X
1786	.c8f8		68		pla		                pla                          ;A=greater Y
1787	.c8f9						+
1788							                ; Copy VDU variable word +X to VDU variable word+Y.
1789							                ; Then cropy VDU variable word +A+2 to VDU variable
1790							                ; word+Y+2. Return with updated Y.
1791	.c8f9		48		pha		                pha
1792	.c8fa		20 0c c9	jsr $c90c	                jsr copyTwoBytesWithinVDUVariables
1793	.c8fd		fa		plx		                plx
1794	.c8fe		e8		inx		                inx
1795	.c8ff		e8		inx		                inx
1796	.c900		80 0a		bra $c90c	                bra copyTwoBytesWithinVDUVariables

1798							;-------------------------------------------------------------------------
1799							;
1800							; Copy 8 bytes to workspace 28 in the VDU variables.
1801							;
1802							; entry:
1803							;
1804							; X = source offset
1805							;
1806	.c902						copyEightBytesToWorkspace28:
1807	.c902		a0 28		ldy #$28	                ldy #VDUVariables.workspace._28

1809							;-------------------------------------------------------------------------
1810							;
1811							; Copy 8 bytes in the VDU variables.
1812							;
1813							; entry:
1814							;
1815							; X = source offset
1816							;
1817							; Y = dest offset
1818							;
1819	.c904						copyEightBytesWithinVDUVariables:
1820	.c904		a9 08		lda #$08	                lda #$08
1821	.c906		80 18		bra $c920	                bra copyABytesWithinVDUVariables

1823							;-------------------------------------------------------------------------
1824							;
1825							; copyTextWindowWidthInBytesToWorkspace28
1826	.c908						copyTextWindowWidthInBytesToWorkspace28:
1827	.c908		a2 4c		ldx #$4c	                ldx #VDUVariables.textWindowWidthInBytes
1828	.c90a		a0 28		ldy #$28	                ldy #VDUVariables.workspace._28

1830							;-------------------------------------------------------------------------
1831							;
1832							;
1833	.c90c						copyTwoBytesWithinVDUVariables:
1834	.c90c		a9 02		lda #$02	                lda #$02
1835	.c90e		80 10		bra $c920	                bra copyABytesWithinVDUVariables

1837							;-------------------------------------------------------------------------
1838							;
1839							; Copy text window info to workspace2C.
1840							;
1841	.c910						copyTextWindowToWorkspace2C:
1842	.c910		a2 08		ldx #$08	                ldx #VDUVariables.textWindowLeft
1843	.c912		a0 2c		ldy #$2c	                ldy #VDUVariables.workspace._2C
1844	.c914		80 08		bra $c91e	                bra copyFourBytesWithinVDUVariables

1846							;-------------------------------------------------------------------------
1847							;
1848							; Copy last 4 bytes of VDU queue somewhere.
1849							;
1850	.c916						copyLastFourVDUQueueBytes:
1851	.c916		a2 20		ldx #$20	                ldx #VDUVariables.queueEnd-4
1852	.c918		80 04		bra $c91e	                bra copyFourBytesWithinVDUVariables

1854							;-------------------------------------------------------------------------
1855							;
1856							; Copy old graphics cursor position to current graphics cursor position.
1857							;
1858	.c91a						copyGraphicsCursorPixelsToOldGraphicsCursorPixels:
1859	.c91a		a0 14		ldy #$14	                ldy #VDUVariables.oldGraphicsCursorPixelsX

1861							;-------------------------------------------------------------------------
1862							;
1863							; Copy the graphics cursor position somewhere.
1864							;
1865	.c91c						copyGraphicsCursorPixels:
1866	.c91c		a2 24		ldx #$24	                ldx #VDUVariables.graphicsCursorPixelsX

1868							;-------------------------------------------------------------------------
1869							;
1870							; Copy 4 bytes in the VDU variables.
1871							;
1872							; entry:
1873							;
1874							; X = source offset
1875							;
1876							; Y = dest offset
1877							;
1878	.c91e						copyFourBytesWithinVDUVariables:
1879	.c91e		a9 04		lda #$04	                lda #$04

1881							                ; fall through to copyABytesWithinVDUVariables

1883							;-------------------------------------------------------------------------
1884							;
1885							; Copy some bytes in the VDU variables.
1886							;
1887							; entry:
1888							;
1889							; A = number of bytes
1890							;
1891							; X = source offset
1892							;
1893							; Y = dest offset
1894							;
1895							; exit:
1896							;
1897							; X = updated source offset
1898							;
1899							; Y = updated dest offset
1900							;
1901	.c920						copyABytesWithinVDUVariables:
1902	.c920		48		pha		                pha
1903	.c921		bd 00 03	lda $0300,x	                lda vduv,x
1904	.c924		99 00 03	sta $0300,y	                sta vduv,y
1905	.c927		e8		inx		                inx
1906	.c928		c8		iny		                iny
1907	.c929		68		pla		                pla
1908	.c92a		3a		dec a		                dec a
1909	.c92b		d0 f3		bne $c920	                bne copyABytesWithinVDUVariables
1910	.c92d		60		rts		                rts

1912							;-------------------------------------------------------------------------
1913							;
1914							; Negate a 16-bit value stored in Y/A
1915							;
1916							; entry:
1917							;
1918							; Y (LSB), A (MSB) = value
1919							;
1920							; exit:
1921							;
1922							; Y (LSB), A (MSB) = -value
1923							;
1924	.c92e						negateAY:
1925	.c92e		48		pha		                pha
1926	.c92f		98		tya		                tya
1927	.c930		49 ff		eor #$ff	                eor #$FF
1928	.c932		a8		tay		                tay
1929	.c933		68		pla		                pla
1930	.c934		49 ff		eor #$ff	                eor #$FF
1931	.c936		c8		iny		                iny
1932	.c937		d0 01		bne $c93a	                bne +
1933	.c939		1a		inc a		                inc a
1934	.c93a						+
1935	.c93a		60		rts		                rts

1937							;-------------------------------------------------------------------------
1938							;
1939							; Multiply a text window width by the number of bytes per char. There
1940							; are inclusive and exclusive versions, depending on how the width was
1941							; calculated.
1942							;
1943							; entry:
1944							;
1945							; A = value-1 to multiply (inclusive), value to multiply (exclusive)
1946							;
1947							; exit:
1948							;
1949							; A (lsb), X (msb) = value*vduv.bytesPerCharacter
1950							;
1951	.c93b						getBytesPerInclusiveTextRow:
1952	.c93b		1a		inc a		                inc a
1953	.c93c						getBytesPerExclusiveTextRow:
1954	.c93c		85 da		sta $da		                sta $DA
1955	.c93e		64 db		stz $db		                stz $DB
1956	.c940		ad 4f 03	lda $034f	                lda vduv.bytesPerCharacter    ;A=1/8/16/32
1957	.c943						-
1958	.c943		4a		lsr a		                lsr a
1959	.c944		b0 06		bcs $c94c	                bcs +                     ;taken when multiply is done
1960	.c946		06 da		asl $da		                asl $DA              ;shift size LSB
1961	.c948		26 db		rol $db		                rol $DB              ;carry into size MSB
1962	.c94a		80 f7		bra $c943	                bra -

1964	.c94c						+
1965	.c94c		a5 da		lda $da		                lda $DA
1966	.c94e		a6 db		ldx $db		                ldx $DB
1967	.c950		60		rts		                rts

1969							;-------------------------------------------------------------------------
1970							;
1971							;
1972	.c951						prepareForPlotBackground:
1973	.c951		a2 08		ldx #$08	                ldx #$08                     ;plot background
1974	.c953		8e 59 03	stx $0359	                stx vduv.graphicsPlotState
1975	.c956		ad 5c 03	lda $035c	                lda vduv.backgroundGCOLMode
1976	.c959		29 0f		and #$0f	                and #$0F
1977	.c95b		8d 5a 03	sta $035a	                sta vduv.graphicsPlotMode
1978	.c95e		60		rts		                rts

1980							;-------------------------------------------------------------------------

1982	.c95f						LC95F:
1983	.c95f		a9 00		lda #$00	                lda #$00
1984	.c961		48		pha		                pha
1985	.c962		48		pha		                pha
1986	.c963		ae 2a 03	ldx $032a	                ldx $032A
1987	.c966		20 7d cc	jsr $cc7d	                jsr LCC7D
1988	.c969		80 14		bra $c97f	                bra LC97F

1990	.c96b						LC96B:
1991	.c96b		38		sec		                sec
1992	.c96c		ad 4f 03	lda $034f	                lda $034F
1993	.c96f		ed 2a 03	sbc $032a	                sbc $032A
1994	.c972		48		pha		                pha
1995	.c973		20 a2 e2	jsr $e2a2	                jsr getDefaultBoundsForCurrentScreenMODE
1996	.c976		da		phx		                phx
1997	.c977		a9 00		lda #$00	                lda #$00
1998	.c979		ae 2a 03	ldx $032a	                ldx $032A
1999	.c97c		20 5d cc	jsr $cc5d	                jsr LCC5D
2000	.c97f						LC97F:
2001							                ; scroll left/right
2002	.c97f		8e 50 03	stx $0350	                stx vduv.screenTopLeftAddress+0
2003	.c982		8d 51 03	sta $0351	                sta vduv.screenTopLeftAddress+1
2004	.c985		fa		plx		                plx
2005	.c986		a0 00		ldy #$00	                ldy #$00
2006	.c988		20 b0 cc	jsr $ccb0	                jsr getAddressForTextPosition
2007	.c98b		fa		plx		                plx
2008	.c98c		a9 00		lda #$00	                lda #$00
2009	.c98e		20 5d cc	jsr $cc5d	                jsr LCC5D
2010	.c991		86 d8		stx $d8		                stx ZMEMT+0
2011	.c993		85 d9		sta $d9		                sta ZMEMT+1
2012	.c995		20 a2 e2	jsr $e2a2	                jsr getDefaultBoundsForCurrentScreenMODE
2013	.c998		20 ae ca	jsr $caae	                jsr LCAAE
2014	.c99b		80 1b		bra $c9b8	                bra LC9B8

2016	.c99d						LC99D:
2017	.c99d		a0 00		ldy #$00	                ldy #$00
2018	.c99f		20 77 cc	jsr $cc77	                jsr LCC77
2019	.c9a2		80 06		bra $c9aa	                bra LC9AA

2021	.c9a4						LC9A4:
2022	.c9a4		20 a2 e2	jsr $e2a2	                jsr getDefaultBoundsForCurrentScreenMODE
2023	.c9a7		20 57 cc	jsr $cc57	                jsr LCC57
2024	.c9aa						LC9AA:
2025	.c9aa		8e 50 03	stx $0350	                stx vduv.screenTopLeftAddress+0
2026	.c9ad		8d 51 03	sta $0351	                sta vduv.screenTopLeftAddress+1
2027	.c9b0		a2 00		ldx #$00	                ldx #$00
2028	.c9b2		20 b0 cc	jsr $ccb0	                jsr getAddressForTextPosition
2029	.c9b5		20 e8 ca	jsr $cae8	                jsr LCAE8
2030	.c9b8						LC9B8:
2031	.c9b8		a0 0c		ldy #$0c	                ldy #$0C
2032	.c9ba		ad 51 03	lda $0351	                lda vduv.screenTopLeftAddress+1
2033	.c9bd		ae 50 03	ldx $0350	                ldx vduv.screenTopLeftAddress+0
2034	.c9c0		4c f5 c6	jmp $c6f5	                jmp setCRTCAddress

2036	.c9c3						LC9C3:
2037	.c9c3		20 a0 cc	jsr $cca0	                jsr LCCA0
2038	.c9c6						LC9C6:
2039	.c9c6		85 dd		sta $dd		                sta $DD
2040	.c9c8		86 dc		stx $dc		                stx $DC
2041	.c9ca		20 2c cc	jsr $cc2c	                jsr LCC2C
2042	.c9cd		ad 29 03	lda $0329	                lda $0329
2043	.c9d0		ae 28 03	ldx $0328	                ldx $0328
2044	.c9d3		20 5d cc	jsr $cc5d	                jsr LCC5D
2045	.c9d6		20 88 cc	jsr $cc88	                jsr LCC88
2046	.c9d9		86 d8		stx $d8		                stx ZMEMT+0
2047	.c9db		85 d9		sta $d9		                sta ZMEMT+1
2048	.c9dd		a9 00		lda #$00	                lda #$00
2049	.c9df		ae 2a 03	ldx $032a	                ldx $032A
2050	.c9e2		20 7d cc	jsr $cc7d	                jsr LCC7D
2051	.c9e5		20 88 cc	jsr $cc88	                jsr LCC88
2052	.c9e8		86 da		stx $da		                stx $DA
2053	.c9ea		85 db		sta $db		                sta $DB
2054	.c9ec		ac 28 03	ldy $0328	                ldy $0328
2055	.c9ef		ae 29 03	ldx $0329	                ldx $0329
2056	.c9f2		50 23		bvc $ca17	                bvc LCA17
2057	.c9f4		a4 e0		ldy $e0		                ldy $E0
2058	.c9f6		a6 e1		ldx $e1		                ldx $E1
2059	.c9f8		20 e7 cb	jsr $cbe7	                jsr LCBE7
2060	.c9fb		a4 e0		ldy $e0		                ldy $E0
2061	.c9fd		90 09		bcc $ca08	                bcc LCA08
2062	.c9ff		a2 80		ldx #$80	                ldx #$80
2063	.ca01		86 db		stx $db		                stx $DB
2064	.ca03		64 da		stz $da		                stz $DA
2065	.ca05		ac 2a 03	ldy $032a	                ldy $032A
2066	.ca08						LCA08:
2067	.ca08		a2 00		ldx #$00	                ldx #$00
2068	.ca0a		20 f3 cb	jsr $cbf3	                jsr LCBF3
2069	.ca0d		a2 80		ldx #$80	                ldx #$80
2070	.ca0f		86 d9		stx $d9		                stx ZMEMT+1
2071	.ca11		64 d8		stz $d8		                stz ZMEMT+0
2072	.ca13		a4 de		ldy $de		                ldy $DE
2073	.ca15		a6 df		ldx $df		                ldx $DF
2074	.ca17						LCA17:
2075	.ca17		20 e7 cb	jsr $cbe7	                jsr LCBE7
2076	.ca1a		20 97 cc	jsr $cc97	                jsr LCC97
2077	.ca1d		20 94 cc	jsr $cc94	                jsr LCC94
2078	.ca20		20 57 cc	jsr $cc57	                jsr LCC57
2079	.ca23		86 d8		stx $d8		                stx ZMEMT+0
2080	.ca25		85 d9		sta $d9		                sta ZMEMT+1
2081	.ca27		ce 2b 03	dec $032b	                dec $032B
2082	.ca2a		10 9a		bpl $c9c6	                bpl LC9C6
2083	.ca2c		60		rts		                rts

2085	.ca2d						LCA2D:
2086	.ca2d		20 a0 cc	jsr $cca0	                jsr LCCA0
2087	.ca30						LCA30:
2088	.ca30		20 2c cc	jsr $cc2c	                jsr LCC2C
2089	.ca33		a9 00		lda #$00	                lda #$00
2090	.ca35		ae 2a 03	ldx $032a	                ldx $032A
2091	.ca38		20 5d cc	jsr $cc5d	                jsr LCC5D
2092	.ca3b		86 da		stx $da		                stx $DA
2093	.ca3d		85 db		sta $db		                sta $DB
2094	.ca3f		20 57 cc	jsr $cc57	                jsr LCC57
2095	.ca42		86 dc		stx $dc		                stx $DC
2096	.ca44		85 dd		sta $dd		                sta $DD
2097	.ca46		ac 28 03	ldy $0328	                ldy $0328
2098	.ca49		ae 29 03	ldx $0329	                ldx $0329
2099	.ca4c		50 25		bvc $ca73	                bvc LCA73
2100	.ca4e		a4 de		ldy $de		                ldy $DE
2101	.ca50		a6 df		ldx $df		                ldx $DF
2102	.ca52		20 a8 cb	jsr $cba8	                jsr LCBA8
2103	.ca55		a4 de		ldy $de		                ldy $DE
2104	.ca57		90 0a		bcc $ca63	                bcc LCA63
2105	.ca59		ae 4e 03	ldx $034e	                ldx $034E
2106	.ca5c		86 db		stx $db		                stx $DB
2107	.ca5e		64 da		stz $da		                stz $DA
2108	.ca60		ac 2a 03	ldy $032a	                ldy $032A
2109	.ca63						LCA63:
2110	.ca63		a2 00		ldx #$00	                ldx #$00
2111	.ca65		20 b4 cb	jsr $cbb4	                jsr LCBB4
2112	.ca68		ae 4e 03	ldx $034e	                ldx $034E
2113	.ca6b		86 d9		stx $d9		                stx ZMEMT+1
2114	.ca6d		64 d8		stz $d8		                stz ZMEMT+0
2115	.ca6f		a4 e0		ldy $e0		                ldy $E0
2116	.ca71		a6 e1		ldx $e1		                ldx $E1
2117	.ca73						LCA73:
2118	.ca73		20 a8 cb	jsr $cba8	                jsr LCBA8
2119	.ca76		20 94 cc	jsr $cc94	                jsr LCC94
2120	.ca79		ce 2b 03	dec $032b	                dec $032B
2121	.ca7c		10 b2		bpl $ca30	                bpl LCA30
2122	.ca7e						LCA7E:
2123	.ca7e		60		rts		                rts

2125	.ca7f						LCA7F:
2126	.ca7f		86 dc		stx $dc		                stx $DC
2127	.ca81		aa		tax		                tax
2128	.ca82		38		sec		                sec
2129	.ca83		e5 dc		sbc $dc		                sbc $DC
2130	.ca85		f0 f7		beq $ca7e	                beq LCA7E
2131	.ca87		85 dd		sta $dd		                sta $DD
2132	.ca89		da		phx		                phx
2133	.ca8a		20 3c c9	jsr $c93c	                jsr getBytesPerExclusiveTextRow
2134	.ca8d		fa		plx		                plx
2135	.ca8e		ad 66 03	lda $0366	                lda $0366
2136	.ca91		89 08		bit #$08	                bit #$08
2137	.ca93		d0 0b		bne $caa0	                bne LCAA0
2138	.ca95		89 02		bit #$02	                bit #$02
2139	.ca97		20 ca cc	jsr $ccca	                jsr LCCCA
2140	.ca9a		a4 da		ldy $da		                ldy $DA
2141	.ca9c		a6 db		ldx $db		                ldx $DB
2142	.ca9e		80 2e		bra $cace	                bra LCACE

2144	.caa0						LCAA0:
2145	.caa0		89 04		bit #$04	                bit #$04
2146	.caa2		20 ca cc	jsr $ccca	                jsr LCCCA
2147	.caa5		ad 4f 03	lda $034f	                lda $034F
2148	.caa8		8d 2a 03	sta $032a	                sta $032A
2149	.caab		a4 dd		ldy $dd		                ldy $DD
2150	.caad		88		dey		                dey
2151	.caae						LCAAE:
2152	.caae		98		tya		                tya
2153	.caaf		f0 18		beq $cac9	                beq LCAC9
2154	.cab1		84 dc		sty $dc		                sty $DC
2155	.cab3						LCAB3:
2156	.cab3		20 57 cc	jsr $cc57	                jsr LCC57
2157	.cab6		86 da		stx $da		                stx $DA
2158	.cab8		85 db		sta $db		                sta $DB
2159	.caba		20 c9 ca	jsr $cac9	                jsr LCAC9
2160	.cabd		a6 da		ldx $da		                ldx $DA
2161	.cabf		86 d8		stx $d8		                stx ZMEMT+0
2162	.cac1		a5 db		lda $db		                lda $DB
2163	.cac3		85 d9		sta $d9		                sta ZMEMT+1
2164	.cac5		c6 dc		dec $dc		                dec $DC
2165	.cac7		d0 ea		bne $cab3	                bne LCAB3
2166	.cac9						LCAC9:
2167	.cac9		a2 00		ldx #$00	                ldx #$00
2168	.cacb		ac 2a 03	ldy $032a	                ldy $032A
2169	.cace						LCACE:
2170	.cace		ad 28 03	lda $0328	                lda $0328
2171	.cad1		48		pha		                pha
2172	.cad2		ad 29 03	lda $0329	                lda $0329
2173	.cad5		48		pha		                pha
2174	.cad6		8c 28 03	sty $0328	                sty $0328
2175	.cad9		8e 29 03	stx $0329	                stx $0329
2176	.cadc		20 e8 ca	jsr $cae8	                jsr LCAE8
2177	.cadf		68		pla		                pla
2178	.cae0		8d 29 03	sta $0329	                sta $0329
2179	.cae3		68		pla		                pla
2180	.cae4		8d 28 03	sta $0328	                sta $0328
2181	.cae7		60		rts		                rts

2183							;-------------------------------------------------------------------------

2185	.cae8						LCAE8:
2186	.cae8		a6 d8		ldx $d8		                ldx ZMEMT+0
2187	.caea		a5 d9		lda $d9		                lda ZMEMT+1
2188	.caec		20 2c cc	jsr $cc2c	                jsr LCC2C
2189	.caef		80 79		bra $cb6a	                bra LCB6A

2191							;-------------------------------------------------------------------------

2193	.caf1						LCAF1:
2194	.caf1		a2 77		ldx #$77	                ldx #<LCC77
2195	.caf3		a9 cc		lda #$cc	                lda #>LCC77
2196	.caf5		ac 2d 03	ldy $032d	                ldy $032D
2197	.caf8		80 07		bra $cb01	                bra LCB01

2199	.cafa						LCAFA:
2200	.cafa		a2 57		ldx #$57	                ldx #<LCC57
2201	.cafc		a9 cc		lda #$cc	                lda #>LCC57
2202	.cafe		ac 2f 03	ldy $032f	                ldy $032F
2203	.cb01						LCB01:
2204	.cb01		8e 5d 03	stx $035d	                stx $035D
2205	.cb04		8d 5e 03	sta $035e	                sta $035E
2206	.cb07		38		sec		                sec
2207	.cb08		ad 2d 03	lda $032d	                lda $032D
2208	.cb0b		ed 2f 03	sbc $032f	                sbc $032F
2209	.cb0e		8d 2b 03	sta $032b	                sta $032B
2210	.cb11		ae 2c 03	ldx $032c	                ldx $032C
2211	.cb14		20 b0 cc	jsr $ccb0	                jsr getAddressForTextPosition
2212	.cb17		85 dd		sta $dd		                sta $DD
2213	.cb19		86 dc		stx $dc		                stx $DC
2214	.cb1b		20 2c cc	jsr $cc2c	                jsr LCC2C
2215	.cb1e		ad 2b 03	lda $032b	                lda $032B
2216	.cb21		f0 47		beq $cb6a	                beq LCB6A
2217	.cb23						LCB23:
2218	.cb23		08		php		                php
2219	.cb24		20 24 c0	jsr $c024	                jsr LC024
2220	.cb27		86 da		stx $da		                stx $DA
2221	.cb29		85 db		sta $db		                sta $DB
2222	.cb2b		86 dc		stx $dc		                stx $DC
2223	.cb2d		85 dd		sta $dd		                sta $DD
2224	.cb2f		28		plp		                plp
2225	.cb30		50 1d		bvc $cb4f	                bvc LCB4F
2226	.cb32		b8		clv		                clv
2227	.cb33						LCB33:
2228	.cb33		a6 df		ldx $df		                ldx $DF
2229	.cb35		a4 de		ldy $de		                ldy $DE
2230	.cb37		20 b4 cb	jsr $cbb4	                jsr LCBB4
2231	.cb3a		ad 4e 03	lda $034e	                lda $034E
2232	.cb3d		70 06		bvs $cb45	                bvs LCB45
2233	.cb3f		85 d9		sta $d9		                sta ZMEMT+1
2234	.cb41		64 d8		stz $d8		                stz ZMEMT+0
2235	.cb43		80 04		bra $cb49	                bra LCB49

2237	.cb45						LCB45:
2238	.cb45		85 db		sta $db		                sta $DB
2239	.cb47		64 da		stz $da		                stz $DA
2240	.cb49						LCB49:
2241	.cb49		a6 e1		ldx $e1		                ldx $E1
2242	.cb4b		a4 e0		ldy $e0		                ldy $E0
2243	.cb4d		80 0b		bra $cb5a	                bra LCB5A

2245	.cb4f						LCB4F:
2246	.cb4f		20 2c cc	jsr $cc2c	                jsr LCC2C
2247	.cb52		70 df		bvs $cb33	                bvs LCB33
2248	.cb54		ae 29 03	ldx $0329	                ldx $0329
2249	.cb57		ac 28 03	ldy $0328	                ldy $0328
2250	.cb5a						LCB5A:
2251	.cb5a		20 b4 cb	jsr $cbb4	                jsr LCBB4
2252	.cb5d		a6 dc		ldx $dc		                ldx $DC
2253	.cb5f		86 d8		stx $d8		                stx ZMEMT+0
2254	.cb61		a5 dd		lda $dd		                lda $DD
2255	.cb63		85 d9		sta $d9		                sta ZMEMT+1
2256	.cb65		ce 2b 03	dec $032b	                dec $032B
2257	.cb68		d0 b9		bne $cb23	                bne LCB23
2258	.cb6a						LCB6A:
2259	.cb6a		ae 29 03	ldx $0329	                ldx $0329
2260	.cb6d		ac 28 03	ldy $0328	                ldy $0328
2261	.cb70		50 12		bvc $cb84	                bvc clearTextMemory
2262	.cb72		a6 df		ldx $df		                ldx $DF
2263	.cb74		a4 de		ldy $de		                ldy $DE
2264	.cb76		20 84 cb	jsr $cb84	                jsr clearTextMemory
2265	.cb79		ad 4e 03	lda $034e	                lda $034E
2266	.cb7c		85 d9		sta $d9		                sta ZMEMT+1
2267	.cb7e		64 d8		stz $d8		                stz ZMEMT+0
2268	.cb80		a6 e1		ldx $e1		                ldx $E1
2269	.cb82		a4 e0		ldy $e0		                ldy $E0

2271							;-------------------------------------------------------------------------
2272							;
2273							; Clear a block of text screen memory.
2274							;
2275							; entry:
2276							;
2277							; (ZMEMT),y - first byte to clear
2278							;
2279							; X = number of pages (including first, possibly partial page) to clear
2280							;
2281	.cb84						clearTextMemory:
2282							                ; align memory so that Y=0 on each page boundary
2283							                ; crossing.
2284							                ;
2285							                ; e.g., on entry ZMEMT=$30f8, Y=$08 - then after,
2286							                ; ZMEMT=$3000, Y=$F7; or, ZMEMT=$30f0, Y=$08 -> ZMEMT=$2ff8, Y=$F7.
2287	.cb84		98		tya		                tya                          ;A=initial offset
2288	.cb85		18		clc		                clc
2289	.cb86		65 d8		adc $d8		                adc ZMEMT+0                  ;add to dest address
2290	.cb88		85 d8		sta $d8		                sta ZMEMT+0
2291	.cb8a		b0 02		bcs $cb8e	                bcs +
2292	.cb8c		c6 d9		dec $d9		                dec ZMEMT+1
2293	.cb8e						+
2294	.cb8e		98		tya		                tya
2295	.cb8f		49 ff		eor #$ff	                eor #$FF
2296	.cb91		a8		tay		                tay
2297	.cb92		4a		lsr a		                lsr a                        ;C set if odd
2298	.cb93		ad 58 03	lda $0358	                lda vduv.backgroundTextColour
2299	.cb96		b0 07		bcs $cb9f	                bcs nextByte                    ;taken if odd - slightly different loop
2300	.cb98		80 02		bra $cb9c	                bra clearTextMemoryByte

2302	.cb9a						clearTextMemoryLoop:
2303	.cb9a		91 d8		sta ($d8),y	                sta (ZMEMT),y
2304	.cb9c						clearTextMemoryByte:
2305	.cb9c		c8		iny		                iny
2306	.cb9d		91 d8		sta ($d8),y	                sta (ZMEMT),y
2307	.cb9f						nextByte:
2308	.cb9f		c8		iny		                iny
2309	.cba0		d0 f8		bne $cb9a	                bne clearTextMemoryLoop
2310	.cba2		e6 d9		inc $d9		                inc ZMEMT+1
2311	.cba4		ca		dex		                dex
2312	.cba5		10 f3		bpl $cb9a	                bpl clearTextMemoryLoop
2313	.cba7		60		rts		                rts

2315							;-------------------------------------------------------------------------

2317	.cba8						LCBA8:
2318	.cba8		38		sec		                sec
2319	.cba9		98		tya		                tya
2320	.cbaa		ed 2a 03	sbc $032a	                sbc $032A
2321	.cbad		a8		tay		                tay
2322	.cbae		b0 04		bcs $cbb4	                bcs LCBB4
2323	.cbb0		ca		dex		                dex
2324	.cbb1		30 33		bmi $cbe6	                bmi LCBE6
2325	.cbb3		38		sec		                sec
2326	.cbb4						LCBB4:
2327	.cbb4		08		php		                php
2328	.cbb5		98		tya		                tya
2329	.cbb6		18		clc		                clc
2330	.cbb7		65 da		adc $da		                adc ZTEMP+0
2331	.cbb9		85 da		sta $da		                sta ZTEMP+0
2332	.cbbb		b0 02		bcs $cbbf	                bcs LCBBF
2333	.cbbd		c6 db		dec $db		                dec ZTEMP+1
2334	.cbbf						LCBBF:
2335	.cbbf		98		tya		                tya
2336	.cbc0		18		clc		                clc
2337	.cbc1		65 d8		adc $d8		                adc ZMEMT+0
2338	.cbc3		85 d8		sta $d8		                sta ZMEMT+0
2339	.cbc5		b0 02		bcs $cbc9	                bcs LCBC9
2340	.cbc7		c6 d9		dec $d9		                dec ZMEMT+1
2341	.cbc9						LCBC9:
2342	.cbc9		98		tya		                tya
2343	.cbca		49 ff		eor #$ff	                eor #$FF
2344	.cbcc		a8		tay		                tay
2345	.cbcd		4a		lsr a		                lsr a
2346	.cbce		b0 0b		bcs $cbdb	                bcs LCBDB
2347	.cbd0		80 04		bra $cbd6	                bra LCBD6

2349	.cbd2						LCBD2:
2350	.cbd2		b1 da		lda ($da),y	                lda ($DA),y
2351	.cbd4		91 d8		sta ($d8),y	                sta (ZMEMT),y
2352	.cbd6						LCBD6:
2353	.cbd6		c8		iny		                iny
2354	.cbd7		b1 da		lda ($da),y	                lda ($DA),y
2355	.cbd9		91 d8		sta ($d8),y	                sta (ZMEMT),y
2356	.cbdb						LCBDB:
2357	.cbdb		c8		iny		                iny
2358	.cbdc		d0 f4		bne $cbd2	                bne LCBD2
2359	.cbde		e6 db		inc $db		                inc $DB
2360	.cbe0		e6 d9		inc $d9		                inc ZMEMT+1
2361	.cbe2		ca		dex		                dex
2362	.cbe3		10 ed		bpl $cbd2	                bpl LCBD2
2363	.cbe5						LCBE5:
2364	.cbe5		28		plp		                plp
2365	.cbe6						LCBE6:
2366	.cbe6		60		rts		                rts

2368	.cbe7						LCBE7:
2369	.cbe7		38		sec		                sec
2370	.cbe8		98		tya		                tya
2371	.cbe9		ed 2a 03	sbc $032a	                sbc $032A
2372	.cbec		a8		tay		                tay
2373	.cbed		b0 04		bcs $cbf3	                bcs LCBF3
2374	.cbef		ca		dex		                dex
2375	.cbf0		30 f4		bmi $cbe6	                bmi LCBE6
2376	.cbf2		38		sec		                sec
2377	.cbf3						LCBF3:
2378	.cbf3		08		php		                php
2379	.cbf4		98		tya		                tya
2380	.cbf5		49 ff		eor #$ff	                eor #$FF
2381	.cbf7		48		pha		                pha
2382	.cbf8		38		sec		                sec
2383	.cbf9		65 da		adc $da		                adc $DA
2384	.cbfb		85 da		sta $da		                sta $DA
2385	.cbfd		b0 02		bcs $cc01	                bcs LCC01
2386	.cbff		c6 db		dec $db		                dec $DB
2387	.cc01						LCC01:
2388	.cc01		68		pla		                pla
2389	.cc02		38		sec		                sec
2390	.cc03		65 d8		adc $d8		                adc ZMEMT+0
2391	.cc05		85 d8		sta $d8		                sta ZMEMT+0
2392	.cc07		b0 02		bcs $cc0b	                bcs LCC0B
2393	.cc09		c6 d9		dec $d9		                dec ZMEMT+1
2394	.cc0b						LCC0B:
2395	.cc0b		98		tya		                tya
2396	.cc0c		4a		lsr a		                lsr a
2397	.cc0d		b0 14		bcs $cc23	                bcs LCC23
2398	.cc0f		d0 0d		bne $cc1e	                bne LCC1E
2399	.cc11						LCC11:
2400	.cc11		ca		dex		                dex
2401	.cc12		30 d1		bmi $cbe5	                bmi LCBE5
2402	.cc14		c6 db		dec $db		                dec $DB
2403	.cc16		c6 d9		dec $d9		                dec ZMEMT+1
2404	.cc18		80 04		bra $cc1e	                bra LCC1E

2406	.cc1a						LCC1A:
2407	.cc1a		b1 da		lda ($da),y	                lda ($DA),y
2408	.cc1c		91 d8		sta ($d8),y	                sta (ZMEMT),y
2409	.cc1e						LCC1E:
2410	.cc1e		88		dey		                dey
2411	.cc1f		b1 da		lda ($da),y	                lda ($DA),y
2412	.cc21		91 d8		sta ($d8),y	                sta (ZMEMT),y
2413	.cc23						LCC23:
2414	.cc23		88		dey		                dey
2415	.cc24		d0 f4		bne $cc1a	                bne LCC1A
2416	.cc26		b2 da		lda ($da)	                lda ($DA)
2417	.cc28		92 d8		sta ($d8)	                sta (ZMEMT)
2418	.cc2a		80 e5		bra $cc11	                bra LCC11

2420							;-------------------------------------------------------------------------
2421							;
2422							; Get pointers for a text window row.
2423							;
2424							; entry:
2425							;
2426							; vduv.workspace._28; = text window stride, in bytes
2427							;
2428							; >A, <X = address
2429							;
2430							; exit:
2431							;
2432							; V=0: >A, <X = new address
2433							;
2434							; V=1: (ZTEMPC) =

2436	.cc2c						LCC2C:
2437	.cc2c		48		pha		                pha                          ;save >address
2438	.cc2d		8a		txa		                txa                          ;A=<address
2439	.cc2e		18		clc		                clc
2440	.cc2f		6d 28 03	adc $0328	                adc vduv.workspace._28       ;A=<(new address)
2441	.cc32		aa		tax		                tax                          ;X=<(new address)
2442	.cc33		68		pla		                pla                          ;restore >addcess
2443	.cc34		6d 29 03	adc $0329	                adc vduv.workspace._29       ;A=>(new address)
2444	.cc37		50 1d		bvc $cc56	                bvc rtsCC56                  ;taken if no address wrap
2445	.cc39		86 e0		stx $e0		                stx ZTEMPD+0
2446	.cc3b		29 7f		and #$7f	                and #$7F                     ;
2447	.cc3d		85 e1		sta $e1		                sta ZTEMPD+1
2448	.cc3f		05 e0		ora $e0		                ora ZTEMPD+0
2449	.cc41		f0 12		beq $cc55	                beq clv_rts
2450	.cc43		08		php		                php
2451	.cc44		38		sec		                sec
2452	.cc45		ad 28 03	lda $0328	                lda vduv.workspace._28
2453	.cc48		e5 e0		sbc $e0		                sbc ZTEMPD+0
2454	.cc4a		85 de		sta $de		                sta ZTEMPC+0
2455	.cc4c		ad 29 03	lda $0329	                lda vduv.workspace._29
2456	.cc4f		e5 e1		sbc $e1		                sbc ZTEMPD+1
2457	.cc51		85 df		sta $df		                sta ZTEMPC+1
2458	.cc53		28		plp		                plp
2459	.cc54		60		rts		                rts

2461							;-------------------------------------------------------------------------

2463	.cc55						clv_rts:
2464	.cc55		b8		clv		                clv
2465	.cc56						rtsCC56:
2466	.cc56		60		rts		                rts

2468	.cc57						LCC57:
2469	.cc57		ad 53 03	lda $0353	                lda vduv.bytesPerCharacterRow+1
2470	.cc5a		ae 52 03	ldx $0352	                ldx vduv.bytesPerCharacterRow+0
2471	.cc5d						LCC5D:
2472	.cc5d		18		clc		                clc
2473	.cc5e						LCC5E:
2474	.cc5e		08		php		                php
2475	.cc5f		48		pha		                pha
2476	.cc60		8a		txa		                txa
2477	.cc61		65 d8		adc $d8		                adc ZMEMT+0
2478	.cc63		aa		tax		                tax
2479	.cc64		68		pla		                pla
2480	.cc65		65 d9		adc $d9		                adc ZMEMT+1
2481	.cc67		10 04		bpl $cc6d	                bpl +
2482	.cc69		38		sec		                sec
2483	.cc6a		ed 54 03	sbc $0354	                sbc vduv.screenSizeHighByte ;handle wraparound at end
2484	.cc6d						+
2485	.cc6d		cd 4e 03	cmp $034e	                cmp vduv.startScreenAddressHighByte
2486	.cc70		b0 03		bcs $cc75	                bcs +
2487	.cc72		6d 54 03	adc $0354	                adc vduv.screenSizeHighByte ;handle wraparound at start
2488	.cc75						+
2489	.cc75		28		plp		                plp
2490	.cc76		60		rts		                rts

2492	.cc77						LCC77:
2493	.cc77		ad 53 03	lda $0353	                lda $0353
2494	.cc7a		ae 52 03	ldx $0352	                ldx $0352
2495	.cc7d						LCC7D:
2496	.cc7d		48		pha		                pha
2497	.cc7e		8a		txa		                txa
2498	.cc7f		49 ff		eor #$ff	                eor #$FF
2499	.cc81		aa		tax		                tax
2500	.cc82		68		pla		                pla
2501	.cc83		49 ff		eor #$ff	                eor #$FF
2502	.cc85		38		sec		                sec
2503	.cc86		80 d6		bra $cc5e	                bra LCC5E

2505	.cc88						LCC88:
2506	.cc88		cd 4e 03	cmp $034e	                cmp $034E
2507	.cc8b		d0 06		bne $cc93	                bne LCC93
2508	.cc8d		e0 00		cpx #$00	                cpx #$00
2509	.cc8f		d0 02		bne $cc93	                bne LCC93
2510	.cc91		a9 80		lda #$80	                lda #$80
2511	.cc93						LCC93:
2512	.cc93		60		rts		                rts

2514	.cc94						LCC94:
2515	.cc94		20 c9 ca	jsr $cac9	                jsr LCAC9
2516	.cc97						LCC97:
2517	.cc97		a6 dc		ldx $dc		                ldx $DC
2518	.cc99		86 d8		stx $d8		                stx ZMEMT+0
2519	.cc9b		a5 dd		lda $dd		                lda $DD
2520	.cc9d		85 d9		sta $d9		                sta ZMEMT+1
2521	.cc9f		60		rts		                rts

2523	.cca0						LCCA0:
2524	.cca0		38		sec		                sec
2525	.cca1		ad 2d 03	lda $032d	                lda $032D
2526	.cca4		ed 2f 03	sbc $032f	                sbc $032F
2527	.cca7		8d 2b 03	sta $032b	                sta $032B
2528	.ccaa		ae 2c 03	ldx $032c	                ldx $032C
2529	.ccad		ac 2f 03	ldy $032f	                ldy $032F

2531							;-------------------------------------------------------------------------
2532							;
2533							; Get display address for a text position.
2534							;
2535	.ccb0						getAddressForTextPosition:
2536	.ccb0		ad 18 03	lda $0318	                lda vduv.textCursorXPosition
2537	.ccb3		48		pha		                pha
2538	.ccb4		ad 19 03	lda $0319	                lda vduv.textCursorYPosition
2539	.ccb7		48		pha		                pha
2540	.ccb8		8e 18 03	stx $0318	                stx vduv.textCursorXPosition
2541	.ccbb		8c 19 03	sty $0319	                sty vduv.textCursorYPosition
2542	.ccbe		20 fa cc	jsr $ccfa	                jsr updateZMEMTWithTextCursorPosition
2543	.ccc1		7a		ply		                ply
2544	.ccc2		8c 19 03	sty $0319	                sty vduv.textCursorYPosition
2545	.ccc5		7a		ply		                ply
2546	.ccc6		8c 18 03	sty $0318	                sty vduv.textCursorXPosition
2547	.ccc9		60		rts		                rts

2549							;-------------------------------------------------------------------------

2551	.ccca						LCCCA:
2552	.ccca		f0 03		beq $cccf	                beq LCCCF
2553	.cccc		ca		dex		                dex
2554	.cccd		86 dc		stx $dc		                stx ZTEMPB+0
2555	.cccf						LCCCF:
2556	.cccf		ad 66 03	lda $0366	                lda vduv.cursorFlags
2557	.ccd2		29 0e		and #$0e	                and #vduv.cursorFlags.swapAxes|vduv.cursorFlags.invertVertical|vduv.cursorFlags.invertHorizontal
2558	.ccd4		aa		tax		                tax
2559	.ccd5		a5 dc		lda $dc		                lda ZTEMPB+0
2560	.ccd7						LCCD7:
2561	.ccd7		20 c7 c2	jsr $c2c7	                jsr setTextCursorXPositionWithCursorFlags
2562	.ccda						LCCDA:
2563	.ccda		ae 18 03	ldx $0318	                ldx vduv.textCursorXPosition
2564	.ccdd		ec 08 03	cpx $0308	                cpx vduv.textWindowLeft
2565	.cce0		30 16		bmi $ccf8	                bmi LCCF8            ;taken if off left edge of window
2566	.cce2		ec 0a 03	cpx $030a	                cpx vduv.textWindowRight
2567	.cce5		f0 02		beq $cce9	                beq LCCE9            ;taken if at right edge of window
2568	.cce7		10 0f		bpl $ccf8	                bpl LCCF8            ;taken if off right edge of window
2569	.cce9						LCCE9:
2570	.cce9		ae 19 03	ldx $0319	                ldx vduv.textCursorYPosition
2571	.ccec		ec 0b 03	cpx $030b	                cpx vduv.textWindowTop
2572	.ccef		30 07		bmi $ccf8	                bmi LCCF8
2573	.ccf1		ec 09 03	cpx $0309	                cpx vduv.textWindowBottom
2574	.ccf4		30 04		bmi $ccfa	                bmi updateZMEMTWithTextCursorPosition
2575	.ccf6		f0 02		beq $ccfa	                beq updateZMEMTWithTextCursorPosition
2576	.ccf8						LCCF8:
2577	.ccf8		38		sec		                sec
2578	.ccf9		60		rts		                rts

2580							;-------------------------------------------------------------------------
2581							;
2582							; Get display address for current text cursor position.
2583							;
2584							; Set up display address without using BBC lookup table at &E0/1
2585							;
2586	.ccfa						updateZMEMTWithTextCursorPosition:
2587	.ccfa		ad 56 03	lda $0356	                lda vduv.currentScreenMODEGroup
2588	.ccfd		29 fe		and #$fe	                and #$fe                     ; Reduce to 0,0,2,2,4
2589	.ccff		aa		tax		                tax                          ; Index into jump table
2590	.cd00		ac 19 03	ldy $0319	                ldy vduv.textCursorYPosition  ; Get current line
2591	.cd03		7c 06 cd	jmp ($cd06,x)	                jmp (multiplyRoutinesTable,x) ; Jump to calculation setup

2593	.cd06						multiplyRoutinesTable:
2594	>cd06		21 cd				                .word multiplyBy640     ; Memory map 0,1  MODE 0,1,2,3
2595	>cd08		15 cd				                .word multiplyBy320       ; Memory map 2,3  MODE 4,5,6
2596	>cd0a		0c cd				                .word multiplyBy40        ; Memory map 4    MODE 7

2598	.cd0c						multiplyBy40:
2599	.cd0c		be af e0	ldx $e0af,y	                ldx multiplyBy40TableHigh,y ; Get offset high byte for start of this line
2600	.cd0f		b9 c8 e0	lda $e0c8,y	                lda multiplyBy40TableLow,y ; Get offset low byte for start of this line
2601	.cd12		18		clc		                clc
2602	.cd13		80 14		bra $cd29	                bra LCD29

2604	.cd15						multiplyBy320:
2605	.cd15		b9 e1 e0	lda $e0e1,y	                lda multiplyBy640TableHigh,y
2606	.cd18		4a		lsr a		                lsr a
2607	.cd19		aa		tax		                tax
2608	.cd1a		98		tya		                tya
2609	.cd1b		29 03		and #$03	                and #$03
2610	.cd1d		4a		lsr a		                lsr a
2611	.cd1e		6a		ror a		                ror a
2612	.cd1f		80 07		bra $cd28	                bra LCD28

2614	.cd21						multiplyBy640:
2615	.cd21		be e1 e0	ldx $e0e1,y	                ldx multiplyBy640TableHigh,y
2616	.cd24		98		tya		                tya
2617	.cd25		29 01		and #$01	                and #$01
2618	.cd27		4a		lsr a		                lsr a
2619	.cd28						LCD28:
2620	.cd28		6a		ror a		                ror a                        ; A=A/2 +(128*carry)

2622	.cd29						LCD29:
2623	.cd29		6d 50 03	adc $0350	                adc vduv.screenTopLeftAddress+0
2624	.cd2c		85 d8		sta $d8		                sta ZMEMT+0                      ; store it
2625	.cd2e		8a		txa		                txa
2626	.cd2f		6d 51 03	adc $0351	                adc vduv.screenTopLeftAddress+1 ; window start address hi
2627	.cd32		a8		tay		                tay
2628	.cd33		ad 18 03	lda $0318	                lda vduv.textCursorXPosition  ; text column
2629	.cd36		ae 4f 03	ldx $034f	                ldx vduv.bytesPerCharacter    ; bytes per character
2630	.cd39		ca		dex		                dex
2631	.cd3a		f0 12		beq $cd4e	                beq LCD4E                    ; 1 colour, MODE 7
2632	.cd3c		e0 0f		cpx #$0f	                cpx #$0F
2633	.cd3e		f0 03		beq $cd43	                beq LCD43                    ; 4 colours, MODE 1 or MODE 5
2634	.cd40		90 02		bcc $cd44	                bcc LCD44                    ; 2 colours, MODE 0,3,4,6
2635	.cd42		0a		asl a		                asl a                        ; 16 colours, MODE 2
2636	.cd43						LCD43:
2637	.cd43		0a		asl a		                asl a
2638	.cd44						LCD44:
2639	.cd44		0a		asl a		                asl a
2640	.cd45		0a		asl a		                asl a
2641	.cd46		90 02		bcc $cd4a	                bcc LCD4A
2642	.cd48		c8		iny		                iny
2643	.cd49		c8		iny		                iny
2644	.cd4a						LCD4A:
2645	.cd4a		0a		asl a		                asl a
2646	.cd4b		90 02		bcc $cd4f	                bcc LCD4F
2647	.cd4d		c8		iny		                iny
2648	.cd4e						LCD4E:
2649	.cd4e		18		clc		                clc
2650	.cd4f						LCD4F:
2651	.cd4f		65 d8		adc $d8		                adc ZMEMT+0
2652	.cd51		85 d8		sta $d8		                sta ZMEMT+0
2653	.cd53		8d 4a 03	sta $034a	                sta vduv.textCursorCRTCAddress+0
2654	.cd56		aa		tax		                tax
2655	.cd57		98		tya		                tya
2656	.cd58		69 00		adc #$00	                adc #$00
2657	.cd5a		8d 4b 03	sta $034b	                sta vduv.textCursorCRTCAddress+1
2658	.cd5d		10 04		bpl $cd63	                bpl LCD63
2659	.cd5f		38		sec		                sec
2660	.cd60		ed 54 03	sbc $0354	                sbc vduv.screenSizeHighByte
2661	.cd63						LCD63:
2662	.cd63		85 d9		sta $d9		                sta ZMEMT+1
2663	.cd65		18		clc		                clc
2664	.cd66		60		rts		                rts

2666							;-------------------------------------------------------------------------

2668	.cd67						nextMaskedCharColumn
2669	.cd67		ee 24 03	inc $0324	                inc vduv.graphicsCursorPixelsX+0
2670	.cd6a		d0 03		bne $cd6f	                bne +
2671	.cd6c		ee 25 03	inc $0325	                inc vduv.graphicsCursorPixelsX+1
2672	.cd6f						+
2673	.cd6f		0a		asl a		                asl a
2674	.cd70						plotMaskedCharRow:
2675							                ; find next pixel to plot, updating graphics cursor X
2676							                ; as it goes. A is non-zero, so this loop will finish
2677							                ; eventually.
2678	.cd70		10 f5		bpl $cd67	                bpl nextMaskedCharColumn
2679	.cd72		5a		phy		                phy
2680	.cd73		85 dd		sta $dd		                sta ZTEMPB+1                 ;
2681	.cd75		a2 24		ldx #$24	                ldx #VDUVariables.graphicsCursorPixels
2682	.cd77		20 c8 de	jsr $dec8	                jsr gaddrEntryPoint
2683	.cd7a		80 02		bra $cd7e	                bra plotMaskedCharPixel

2685	.cd7c						plotMaskedCharPixelsLoop:
2686	.cd7c		10 03		bpl $cd81	                bpl nextMaskedCharPixel
2687	.cd7e						plotMaskedCharPixel:
2688	.cd7e		20 51 db	jsr $db51	                jsr plbyteEntryPoint
2689	.cd81						nextMaskedCharPixel
2690	.cd81		46 d1		lsr $d1		                lsr ZMASK
2691	.cd83		90 03		bcc $cd88	                bcc +
2692	.cd85		20 67 da	jsr $da67	                jsr nextColumnAndResetMask
2693	.cd88						+
2694	.cd88		06 dd		asl $dd		                asl ZTEMPB+1
2695	.cd8a		d0 f0		bne $cd7c	                bne plotMaskedCharPixelsLoop
2696	.cd8c		a2 28		ldx #$28	                ldx #VDUVariables.workspace._28
2697	.cd8e		a0 24		ldy #$24	                ldy #VDUVariables.graphicsCursorPixelsX
2698	.cd90		20 0c c9	jsr $c90c	                jsr copyTwoBytesWithinVDUVariables
2699	.cd93		7a		ply		                ply
2700	.cd94		80 50		bra $cde6	                bra nextMaskedCharY

2702	.cd96						plotCharAtGraphicsCursor:
2703	.cd96		20 2c e2	jsr $e22c	                jsr getSoftCharacterDefinitionAddress
2704	.cd99		9c 59 03	stz $0359	                stz vduv.graphicsPlotState   ;plot in foreground colour
2705	.cd9c		ad 5b 03	lda $035b	                lda vduv.foregroundGCOLMode
2706	.cd9f		29 0f		and #$0f	                and #$0F
2707	.cda1						plotFontDataAtGraphicsCursorWithPlotMode:
2708	.cda1		8d 5a 03	sta $035a	                sta vduv.graphicsPlotMode
2709	.cda4		a0 28		ldy #$28	                ldy #VDUVariables.workspace._28
2710	.cda6		20 1c c9	jsr $c91c	                jsr copyGraphicsCursorPixels
2711	.cda9		a0 24		ldy #$24	                ldy #VDUVariables.graphicsCursorPixelsX
2712	.cdab		a2 00		ldx #$00	                ldx #VDUVariables.graphicsWindowPixelsLeft
2713	.cdad		20 b4 ce	jsr $ceb4	                jsr getDistanceMask
2714	.cdb0		85 dc		sta $dc		                sta ZTEMPB+0
2715	.cdb2		a2 04		ldx #$04	                ldx #VDUVariables.graphicsWindowPixelsRight
2716	.cdb4		20 b4 ce	jsr $ceb4	                jsr getDistanceMask
2717	.cdb7		6a		ror a		                ror a
2718	.cdb8		14 dc		trb $dc		                trb ZTEMPB+0
2719	.cdba		a2 26		ldx #$26	                ldx #VDUVariables.graphicsCursorPixelsY
2720	.cdbc		a0 06		ldy #$06	                ldy #VDUVariables.graphicsWindowPixelsTop
2721	.cdbe		20 b4 ce	jsr $ceb4	                jsr getDistanceMask
2722	.cdc1		85 dd		sta $dd		                sta ZTEMPB+1
2723	.cdc3		a2 26		ldx #$26	                ldx #VDUVariables.graphicsCursorPixelsY
2724	.cdc5		a0 02		ldy #$02	                ldy #VDUVariables.graphicsWindowPixelsBottom
2725	.cdc7		20 b4 ce	jsr $ceb4	                jsr getDistanceMask
2726	.cdca		6a		ror a		                ror a
2727	.cdcb		14 dd		trb $dd		                trb ZTEMPB+1
2728	.cdcd		a0 07		ldy #$07	                ldy #$07
2729	.cdcf						copyMaskedCharLoop:
2730	.cdcf		b1 de		lda ($de),y	                lda (ZTEMPC),y               ;get font byte
2731	.cdd1		25 dc		and $dc		                and ZTEMPB+0                 ;mask out columns
2732	.cdd3		46 dd		lsr $dd		                lsr ZTEMPB+1                 ;test row
2733	.cdd5		b0 02		bcs $cdd9	                bcs +
2734	.cdd7		a9 00		lda #$00	                lda #$00                     ;mask out this row
2735	.cdd9						+
2736	.cdd9		99 2c 03	sta $032c,y	                sta vduv.workspace._2C,y
2737	.cddc		88		dey		                dey
2738	.cddd		10 f0		bpl $cdcf	                bpl copyMaskedCharLoop
2739	.cddf		a0 f8		ldy #$f8	                ldy #$F8
2740	.cde1						plotMaskedCharLoop:
2741	.cde1		b9 34 02	lda $0234,y	                lda vduv.workspace._2C-$f8,y ;get masked byte
2742	.cde4		d0 8a		bne $cd70	                bne plotMaskedCharRow        ;taken if data to write
2743	.cde6						nextMaskedCharY:
2744	.cde6		ae 26 03	ldx $0326	                ldx vduv.graphicsCursorPixelsY+0
2745	.cde9		d0 03		bne $cdee	                bne +
2746	.cdeb		ce 27 03	dec $0327	                dec vduv.graphicsCursorPixelsY+1
2747	.cdee						+
2748	.cdee		ce 26 03	dec $0326	                dec vduv.graphicsCursorPixelsY+0
2749	.cdf1		c8		iny		                iny
2750	.cdf2		d0 ed		bne $cde1	                bne plotMaskedCharLoop
2751	.cdf4		a2 2a		ldx #$2a	                ldx #VDUVariables.workspace._2A
2752	.cdf6		a0 26		ldy #$26	                ldy #VDUVariables.graphicsCursorPixelsY
2753	.cdf8		4c 0c c9	jmp $c90c	                jmp copyTwoBytesWithinVDUVariables

2755	.cdfb						vdu127AtGraphicsCursor:
2756							                ; CHR$127 is a solid block, not a backspace.
2757	.cdfb		a9 f8		lda #$f8	                lda #<terminal.chr127
2758	.cdfd		85 de		sta $de		                sta ZTEMPC+0
2759	.cdff		a9 bb		lda #$bb	                lda #>terminal.chr127
2760	.ce01		85 df		sta $df		                sta ZTEMPC+1
2761	.ce03		a2 08		ldx #$08	                ldx #$08
2762	.ce05		8e 59 03	stx $0359	                stx vduv.graphicsPlotState   ;plot in background colour
2763	.ce08		a9 00		lda #$00	                lda #$00
2764	.ce0a		80 95		bra $cda1	                bra plotFontDataAtGraphicsCursorWithPlotMode

2766	.ce0c						LCE0C:
2767	.ce0c		20 2d d1	jsr $d12d	                jsr handleColumn81
2768	.ce0f		b0 85		bcs $cd96	                bcs plotCharAtGraphicsCursor          ;taken if VDU5
2769	.ce11		ae 60 03	ldx $0360	                ldx vduv.numberOfLogicalColoursMinusOne
2770	.ce14		f0 37		beq $ce4d	                beq writeTeletextChar
2771	.ce16		20 2c e2	jsr $e22c	                jsr getSoftCharacterDefinitionAddress
2772	.ce19						writeBitmapChar:
2773	.ce19		a0 07		ldy #$07	                ldy #$07
2774	.ce1b		e0 03		cpx #$03	                cpx #$03
2775	.ce1d		f0 34		beq $ce53	                beq write2bppChar            ;taken if MODE 1/5
2776	.ce1f		b0 5b		bcs $ce7c	                bcs write4bppChar                    ;taken if MODE 2
2777	.ce21						write1bppChar:
2778	.ce21		b1 de		lda ($de),y	                lda (ZTEMPC),y
2779	.ce23		05 d2		ora $d2		                ora ZORA
2780	.ce25		45 d3		eor $d3		                eor ZEOR
2781	.ce27		91 d8		sta ($d8),y	                sta (ZMEMT),y
2782	.ce29		88		dey		                dey
2783	.ce2a		10 f5		bpl $ce21	                bpl write1bppChar
2784	.ce2c		60		rts		                rts

2786	.ce2d						vdu127EntryPoint:
2787	.ce2d		a9 20		lda #$20	                lda #$20
2788	.ce2f		2c 66 03	bit $0366	                bit $0366
2789	.ce32		d0 03		bne $ce37	                bne LCE37
2790	.ce34		20 9a c2	jsr $c29a	                jsr vdu8EntryPoint
2791	.ce37						LCE37:
2792	.ce37		20 d2 e2	jsr $e2d2	                jsr testVDU5State
2793	.ce3a		d0 bf		bne $cdfb	                bne vdu127AtGraphicsCursor
2794	.ce3c		ae 60 03	ldx $0360	                ldx vduv.numberOfLogicalColoursMinusOne
2795	.ce3f		f0 0a		beq $ce4b	                beq writeTeletextSpaceChar   ;taken if teletext mode

2797							                ; Address of space char is known.
2798	.ce41		a9 00		lda #$00	                lda #<terminal.LB900
2799	.ce43		85 de		sta $de		                sta ZTEMPC+0
2800	.ce45		a9 b9		lda #$b9	                lda #>terminal.LB900
2801	.ce47		85 df		sta $df		                sta ZTEMPC+1
2802	.ce49		80 ce		bra $ce19	                bra writeBitmapChar

2804	.ce4b						writeTeletextSpaceChar:
2805	.ce4b		a9 20		lda #$20	                lda #$20
2806	.ce4d						writeTeletextChar:
2807	.ce4d		20 e5 dd	jsr $dde5	                jsr getSAA5050FromASCII
2808	.ce50		92 d8		sta ($d8)	                sta (ZMEMT)
2809	.ce52		60		rts		                rts

2811	.ce53						write2bppChar:
2812	.ce53		a5 d9		lda $d9		                lda ZMEMT+1
2813	.ce55		a6 d8		ldx $d8		                ldx ZMEMT+0
2814	.ce57		20 e7 ce	jsr $cee7	                jsr getNextColumnAddress
2815	.ce5a						-
2816	.ce5a		b1 de		lda ($de),y	                lda (ZTEMPC),y               ;get font byte
2817	.ce5c		29 0f		and #$0f	                and #$0F                     ;get data for right 4 pixels
2818	.ce5e		aa		tax		                tax
2819	.ce5f		bd 13 e0	lda $e013,x	                lda LE013,x                  ;form byte
2820	.ce62		05 d2		ora $d2		                ora ZORA
2821	.ce64		45 d3		eor $d3		                eor ZEOR
2822	.ce66		91 e0		sta ($e0),y	                sta (ZTEMPD),y               ;write to right column
2823	.ce68		b1 de		lda ($de),y	                lda (ZTEMPC),y               ;get font byte
2824							                .if version==350
2826							                .else
2827	.ce6a		4a		lsr a		                lsr a                        ;
2828	.ce6b		4a		lsr a		                lsr a                        ;
2829	.ce6c		4a		lsr a		                lsr a                        ;
2830	.ce6d		4a		lsr a		                lsr a                        ;get data for left 4 pixels
2831							                .endif
2832	.ce6e		aa		tax		                tax                          ;
2833	.ce6f		bd 13 e0	lda $e013,x	                lda LE013,x                  ;form byte
2834	.ce72		05 d2		ora $d2		                ora ZORA
2835	.ce74		45 d3		eor $d3		                eor ZEOR
2836	.ce76		91 d8		sta ($d8),y	                sta (ZMEMT),y                ;write to left column
2837	.ce78		88		dey		                dey
2838	.ce79		10 df		bpl $ce5a	                bpl -
2839	.ce7b		60		rts		                rts

2841	.ce7c						write4bppChar:
2842	.ce7c		a5 d9		lda $d9		                lda ZMEMT+1
2843	.ce7e		a6 d8		ldx $d8		                ldx ZMEMT+0
2844	.ce80		20 d9 ce	jsr $ced9	                jsr getNext3ColumnAddresses
2845	.ce83						-
2846	.ce83		b1 de		lda ($de),y	                lda (ZTEMPC),y               ;get font byte - %abcdefgh
2847	.ce85		20 a9 ce	jsr $cea9	                jsr get4bppScreenByteFor2Pixels ;pixels g and h
2848	.ce88		91 e0		sta ($e0),y	                sta ($E0),y
2849	.ce8a		b1 de		lda ($de),y	                lda (ZTEMPC),y               ;get font byte - %abcdefgh
2850	.ce8c		4a		lsr a		                lsr a                        ;%0abcdefg
2851	.ce8d		4a		lsr a		                lsr a                        ;%00abcdef
2852	.ce8e		48		pha		                pha                          ;save %00abcdef
2853	.ce8f		20 a9 ce	jsr $cea9	                jsr get4bppScreenByteFor2Pixels ;pixels e and f
2854	.ce92		91 dc		sta ($dc),y	                sta (ZTEMPB),y
2855	.ce94		68		pla		                pla                          ;restore %00abcdef
2856	.ce95		4a		lsr a		                lsr a                        ;%000abcde
2857	.ce96		4a		lsr a		                lsr a                        ;%0000abcd
2858	.ce97		48		pha		                pha                          ;save %0000abcd
2859	.ce98		20 a9 ce	jsr $cea9	                jsr get4bppScreenByteFor2Pixels ;pixels c and d
2860	.ce9b		91 da		sta ($da),y	                sta (ZTEMP),y
2861	.ce9d		68		pla		                pla                          ;restore %0000abcd
2862	.ce9e		4a		lsr a		                lsr a                        ;%00000abc
2863	.ce9f		4a		lsr a		                lsr a                        ;%000000ab
2864	.cea0		20 a9 ce	jsr $cea9	                jsr get4bppScreenByteFor2Pixels ;pixels a and b
2865	.cea3		91 d8		sta ($d8),y	                sta (ZMEMT),y
2866	.cea5		88		dey		                dey
2867	.cea6		10 db		bpl $ce83	                bpl -
2868	.cea8		60		rts		                rts

2870	.cea9						get4bppScreenByteFor2Pixels:
2871	.cea9		29 03		and #$03	                and #$03                     ;mask out 2 pixels
2872	.ceab		aa		tax		                tax
2873	.ceac		bd 23 e0	lda $e023,x	                lda LE023,x                  ;form byte
2874	.ceaf		05 d2		ora $d2		                ora ZORA
2875	.ceb1		45 d3		eor $d3		                eor ZEOR
2876	.ceb3		60		rts		                rts

2878							;-------------------------------------------------------------------------
2879							;
2880							; Get mask indicating the distance between two 16-bit VDU variable
2881							; values - >=8, or some amount less than that.
2882							;
2883							; (These can be used for masking pixels, or counting loops, or
2884							; whatever.)
2885							;
2886							; entry:
2887							;
2888							; X = offset of value A in VDU variables
2889							;
2890							; Y = offset of value B in VDU variables
2891							;
2892							; exit:
2893							;
2894							; if distance<=0, A=255, C=1
2895							;
2896							; if distance>=8, A=0, C=0
2897							;
2898							; otherwise, A=255>>distance, C=0
2899							;
2900	.ceb4						getDistanceMask:
2901	.ceb4		38		sec		                sec
2902	.ceb5		bd 00 03	lda $0300,x	                lda vduv+0,x
2903	.ceb8		f9 00 03	sbc $0300,y	                sbc vduv+0,y
2904	.cebb		85 da		sta $da		                sta ZTEMP                    ;get result LSB
2905	.cebd		bd 01 03	lda $0301,x	                lda vduv+1,x
2906	.cec0		f9 01 03	sbc $0301,y	                sbc vduv+1,y
2907	.cec3		30 0c		bmi $ced1	                bmi distanceMask255                  ;taken if result -ve
2908	.cec5		d0 0e		bne $ced5	                bne distanceMask0                  ;taken if result >=256
2909	.cec7		a6 da		ldx $da		                ldx ZTEMP
2910	.cec9		e0 08		cpx #$08	                cpx #$08
2911	.cecb		b0 08		bcs $ced5	                bcs distanceMask0                    ;taken if result>=8
2912	.cecd		bd 27 e1	lda $e127,x	                lda distanceMasksTable,x             ;get mask for <8 items
2913	.ced0		60		rts		                rts

2915	.ced1						distanceMask255:
2916	.ced1		a9 ff		lda #$ff	                lda #%11111111
2917	.ced3		38		sec		                sec
2918	.ced4		60		rts		                rts

2920	.ced5						distanceMask0:
2921	.ced5		a9 00		lda #$00	                lda #$00
2922	.ced7		18		clc		                clc
2923	.ced8		60		rts		                rts

2925							;-------------------------------------------------------------------------
2926							;
2927							; Get addresses of next 3 columns on screen.
2928							;
2929							; entry:
2930							;
2931							; A (MSB)/X (LSB) = address
2932							;
2933							; exit:
2934							;
2935							; (ZTEMP) = column N+1
2936							; (ZTEMPB) = column N+2
2937							; (ZTEMPC) = column N+3
2938							;
2939	.ced9						getNext3ColumnAddresses:
2940	.ced9		20 e7 ce	jsr $cee7	                jsr getNextColumnAddress
2941	.cedc		86 da		stx $da		                stx ZTEMP+0
2942	.cede		85 db		sta $db		                sta ZTEMP+1
2943	.cee0		20 e7 ce	jsr $cee7	                jsr getNextColumnAddress
2944	.cee3		86 dc		stx $dc		                stx ZTEMPB+0
2945	.cee5		85 dd		sta $dd		                sta ZTEMPB+1

2947							;-------------------------------------------------------------------------
2948							;
2949							; Get address of next column on screen.
2950							;
2951							; entry:
2952							;
2953							; A (MSB)/X (LSB) = address
2954							;
2955							; exit:
2956							;
2957							; A (MSB)/X (LSB) = address of next column
2958							; (ZTEMPD) = address of next column
2959							;
2960	.cee7						getNextColumnAddress:
2961	.cee7		48		pha		                pha
2962	.cee8		8a		txa		                txa
2963	.cee9		18		clc		                clc
2964	.ceea		69 08		adc #$08	                adc #$08                     ;next column...
2965	.ceec		aa		tax		                tax
2966	.ceed		68		pla		                pla
2967	.ceee		90 06		bcc $cef6	                bcc +                        ;taken if no carry
2968	.cef0		1a		inc a		                inc a
2969	.cef1		10 03		bpl $cef6	                bpl +           ;taken if no screen address wraparound
2970	.cef3		ad 4e 03	lda $034e	                lda vduv.startScreenAddressHighByte
2971	.cef6						+
2972	.cef6		86 e0		stx $e0		                stx ZTEMPD+0
2973	.cef8		85 e1		sta $e1		                sta ZTEMPD+1
2974	.cefa		60		rts		                rts

2976							;-------------------------------------------------------------------------
2977							;
2978							; VDU 23 0 Control 6845 CRTC directly [MasRef E.3-12]
2979							;
2980	.cefb						vdu23_0_EntryPoint:
2981	.cefb		ad 1d 03	lda $031d	                lda vduv.queueEnd-7           ;get value
2982	.cefe		ac 1c 03	ldy $031c	                ldy vduv.queueEnd-8           ;get register

2984							                ; fall through to setCRTCRegister

2986							;-------------------------------------------------------------------------
2987							;
2988							; Set a CRTC register, adjusting and/or noting values if appropriate.
2989							;
2990							; entry:
2991							;
2992							; Y = register to set
2993							;
2994							; A = value

2996	.cf01						setCRTCRegister:
2997	.cf01		c0 07		cpy #$07	                cpy #$07
2998	.cf03		90 1f		bcc $cf24	                bcc setCRTCRegisterRaw
2999	.cf05		d0 03		bne $cf0a	                bne +        ;taken if not setting R7

3001							                ; Setting R7 (vsync position), so apply the *TV offset.
3002	.cf07		6d 90 02	adc $0290	                adc tvOffset
3003	.cf0a						+
3004	.cf0a		c0 08		cpy #$08	                cpy #$08
3005	.cf0c		d0 07		bne $cf15	                bne +                    ;taken if not setting R8

3007							                ; Setting R8 (interlace/delay register), so apply the
3008							                ; *TV interlace setting.
3009	.cf0e		09 00		ora #$00	                ora #$00
3010	.cf10		30 03		bmi $cf15	                bmi +       ;branch taken if bit 7 set - this is taken
3011							                            ;to imply the mode being set is Mode 7
3012	.cf12		4d 91 02	eor $0291	                eor tvInterlace ;apply *TV interlace setting
3013	.cf15						+
3014	.cf15		c0 0a		cpy #$0a	                cpy #$0A
3015	.cf17		d0 0b		bne $cf24	                bne setCRTCRegisterRaw

3017							                ; Setting R10 (cursor start register). Note the new
3018							                ; setting in the VDU variable. If in VDU5 mode, reuse
3019							                ; the result of testVDU5State - i.e., 32 - as the
3020							                ; setting, hiding the cursor.
3021	.cf19		8d 5f 03	sta $035f	                sta vduv.lastCursorStartRegisterValue
3022	.cf1c		20 d2 e2	jsr $e2d2	                jsr testVDU5State
3023	.cf1f		d0 09		bne $cf2a	                bne rtsCF2A
3024	.cf21		ad 5f 03	lda $035f	                lda vduv.lastCursorStartRegisterValue

3026							                ; fall through to setCRTCRegisterRaw

3028							;-------------------------------------------------------------------------
3029							;
3030							; Set a CRTC register.
3031							;
3032	.cf24						setCRTCRegisterRaw:
3033	.cf24		8c 00 fe	sty $fe00	                sty CRTC+0
3034	.cf27		8d 01 fe	sta $fe01	                sta CRTC+1
3035	.cf2a						rtsCF2A:
3036	.cf2a		60		rts		                rts

3038							;-------------------------------------------------------------------------
3039							;
3040							; VDU 23 1 Turn cursor on/off [MasRef E.3-12]
3041							;
3042	.cf2b						vdu23_1_EntryPoint:
3043	.cf2b		20 d2 e2	jsr $e2d2	                jsr testVDU5State
3044	.cf2e		d0 fa		bne $cf2a	                bne rtsCF2A                  ;taken if VDU5
3045	.cf30		ad 1c 03	lda $031c	                lda vduv.queueEnd-8           ;get new cursor state
3046	.cf33		29 03		and #$03	                and #$03                     ;mask off bits of interest
3047	.cf35		0a		asl a		                asl a
3048	.cf36		aa		tax		                tax
3049	.cf37		a9 20		lda #$20	                lda #$20 ;R10 value for hiding the cursor - save a few
3050							                         ;bytes by loading this here
3051	.cf39		7c 3c cf	jmp ($cf3c,x)	                jmp (LCF3C,x)

3053	.cf3c						LCF3C:
3054	>cf3c		53 cf				                .word setCRTCRegister10            ; 23,1,0... - hide
3055	>cf3e		50 cf				                .word showCursor            ; 23,1,1... - show
3056	>cf40		44 cf				                .word steadyCursor          ; 23,1,2... - steady
3057	>cf42		4b cf				                .word slowFlashCursor       ; 23,1,3... - flash slowly

3059	.cf44						steadyCursor:
3060	.cf44		a9 60		lda #$60	                lda #%01100000
3061	.cf46		1c 5f 03	trb $035f	                trb vduv.lastCursorStartRegisterValue ;steady cursor
3062	.cf49		80 05		bra $cf50	                bra showCursor

3064	.cf4b						slowFlashCursor:
3065	.cf4b		a9 60		lda #$60	                lda #%01100000
3066	.cf4d		0c 5f 03	tsb $035f	                tsb vduv.lastCursorStartRegisterValue ;slow blink cursor
3067	.cf50						showCursor:
3068	.cf50		ad 5f 03	lda $035f	                lda vduv.lastCursorStartRegisterValue
3069	.cf53						setCRTCRegister10:
3070	.cf53		a0 0a		ldy #$0a	                ldy #$0A
3071	.cf55		80 cd		bra $cf24	                bra setCRTCRegisterRaw

3073							;-------------------------------------------------------------------------
3074							;
3075							; VDU 23 2â<80><93>5 Set ECF patterns [MasRef E.3-13]
3076							;
3077	.cf57						vdu23_2_EntryPoint:
3078	.cf57						vdu23_3_EntryPoint:
3079	.cf57						vdu23_4_EntryPoint:
3080	.cf57						vdu23_5_EntryPoint:
3081	.cf57		e9 01		sbc #$01	                sbc #$01  ;subtract 2 (C=0 on entry...) to get pattern
3082							                          ;index
3083	.cf59		0a		asl a		                asl a
3084	.cf5a		0a		asl a		                asl a
3085	.cf5b		0a		asl a		                asl a                        ;index*8
3086	.cf5c		69 07		adc #$07	                adc #$07                     ;index*8+7
3087	.cf5e		a8		tay		                tay
3088	.cf5f		a2 07		ldx #$07	                ldx #$07
3089	.cf61						-
3090	.cf61		bd 1c 03	lda $031c,x	                lda vduv.queueEnd-8,x
3091	.cf64		99 00 88	sta $8800,y	                sta andy.ecfPatterns,y
3092	.cf67		88		dey		                dey
3093	.cf68		ca		dex		                dex
3094	.cf69		10 f6		bpl $cf61	                bpl -
3095	.cf6b		80 26		bra $cf93	                bra LCF93

3097							;-------------------------------------------------------------------------

3099	.cf6d						vdu23_11_EntryPoint:
3100	.cf6d		ad 55 03	lda $0355	                lda vduv.currentScreenMODE
3101	.cf70		d0 01		bne $cf73	                bne +
3102							                ; Use a different table for MODE 0 - see MasRef E.3-16.
3103	.cf72		3a		dec a		                dec a                        ;
3104	.cf73						+
3105	.cf73		29 03		and #$03	                and #$03 ;index=0 (mode 4); 1 (mode 1/5); 2 (mode 2);
3106							                         ;3 (mode 0)
3107	.cf75		1a		inc a		                inc a
3108	.cf76		0a		asl a		                asl a
3109	.cf77		0a		asl a		                asl a
3110	.cf78		0a		asl a		                asl a
3111	.cf79		0a		asl a		                asl a                        ;(index+1)*16
3112	.cf7a		aa		tax		                tax
3113	.cf7b		a0 1c		ldy #$1c	                ldy #32-4
3114	.cf7d						setDefaultECFPatterns:
3115	.cf7d		bd c3 e1	lda $e1c3,x	                lda defaultECFPatterns-1,x
3116	.cf80		99 ff 87	sta $87ff,y	                sta andy.ecfPatterns-1,y     ;copy first repeat
3117	.cf83		99 03 88	sta $8803,y	                sta andy.ecfPatterns+4-1,y   ;copy second repeat
3118	.cf86		ca		dex		                dex                          ;next byte in defaults table
3119	.cf87		88		dey		                dey
3120	.cf88		98		tya		                tya
3121	.cf89		89 07		bit #$07	                bit #$07
3122	.cf8b		d0 f0		bne $cf7d	                bne setDefaultECFPatterns ;taken if pattern not filled
3123							                ; skip to start of previous pattern
3124	.cf8d		88		dey		                dey
3125	.cf8e		88		dey		                dey
3126	.cf8f		88		dey		                dey
3127	.cf90		88		dey		                dey
3128	.cf91		10 ea		bpl $cf7d	                bpl setDefaultECFPatterns
3129	.cf93						LCF93:
3130	.cf93		4c 7d c5	jmp $c57d	                jmp initializeCurrentECFPatterns

3132							;-------------------------------------------------------------------------
3133							;
3134							; VDU 23 12â<80><93>15 Set simple ECF pattern [MasRef E.3-17]
3135							;
3136	.cf96						vdu23_12_EntryPoint:
3137	.cf96						vdu23_13_EntryPoint:
3138	.cf96						vdu23_14_EntryPoint:
3139	.cf96						vdu23_15_EntryPoint:
3140	.cf96		e9 0b		sbc #$0b	                sbc #$0B                     ;-12 to get pattern index
3141	.cf98		0a		asl a		                asl a                        ;index*2
3142	.cf99		0a		asl a		                asl a                        ;index*4
3143	.cf9a		0a		asl a		                asl a                        ;index*8, C=0
3144	.cf9b		69 03		adc #$03	                adc #$03                     ;index*8+3, C=0
3145	.cf9d		48		pha		                pha                          ;save offset
3146	.cf9e		a2 07		ldx #$07	                ldx #$07                     ;
3147	.cfa0						LCFA0:
3148	.cfa0		bd 1c 03	lda $031c,x	                lda vduv.queueEnd-8,x        ;get simple pattern byte
3149	.cfa3		2d 60 03	and $0360	                and vduv.numberOfLogicalColoursMinusOne ;apply logical colour limit
3150	.cfa6		85 da		sta $da		                sta ZTEMP+0
3151	.cfa8		ad 60 03	lda $0360	                lda vduv.numberOfLogicalColoursMinusOne
3152	.cfab		29 07		and #$07	                and #$07                     ;1/3/7
3153	.cfad		65 da		adc $da		                adc ZTEMP+0                  ;select 2/4/16 colour table
3154	.cfaf		a8		tay		                tay
3155	.cfb0		b9 4b e1	lda $e14b,y	                lda solidColoursTable-1,y
3156	.cfb3		9d 1c 03	sta $031c,x	                sta vduv.queueEnd-8,x
3157	.cfb6		ca		dex		                dex
3158	.cfb7		10 e7		bpl $cfa0	                bpl LCFA0
3159	.cfb9		a9 55		lda #$55	                lda #%01010101
3160	.cfbb		ae 55 03	ldx $0355	                ldx vduv.currentScreenMODE
3161	.cfbe		d0 02		bne $cfc2	                bne +                 ;taken if not MODE 0
3162	.cfc0		a9 33		lda #$33	                lda #%00110011        ;double-width pattern for MODE 0
3163	.cfc2						+
3164	.cfc2		85 da		sta $da		                sta ZTEMP+0
3165	.cfc4		7a		ply		                ply
3166	.cfc5		a2 07		ldx #$07	                ldx #$07
3167	.cfc7						LCFC7:
3168	.cfc7		bd 1c 03	lda $031c,x	                lda vduv.queueEnd-8,x
3169	.cfca		ca		dex		                dex
3170	.cfcb		5d 1c 03	eor $031c,x	                eor vduv.queueEnd-8,x
3171	.cfce		25 da		and $da		                and ZTEMP+0
3172	.cfd0		5d 1c 03	eor $031c,x	                eor vduv.queueEnd-8,x
3173	.cfd3		99 00 88	sta $8800,y	                sta andy.ecfPatterns+0,y
3174	.cfd6		99 04 88	sta $8804,y	                sta andy.ecfPatterns+4,y
3175	.cfd9		88		dey		                dey
3176	.cfda		ca		dex		                dex
3177	.cfdb		10 ea		bpl $cfc7	                bpl LCFC7
3178	.cfdd		80 b4		bra $cf93	                bra LCF93

3180							;-------------------------------------------------------------------------
3181							;
3182							; VDU 23 6 Set dotted lines pattern [MasRef E.3-13]
3183							;
3184	.cfdf						vdu23_6_EntryPoint:
3185	.cfdf		ad 1c 03	lda $031c	                lda vduv.queueEnd-8
3186	.cfe2		8d 67 03	sta $0367	                sta vduv.dotPattern
3187	.cfe5		60		rts		                rts

3189							;-------------------------------------------------------------------------
3190							;
3191							; VDU 23 7 Scroll window directly [MasRef E.3-14]
3192							;
3193	.cfe6						vdu23_7_EntryPoint:
3194	.cfe6		ad 1c 03	lda $031c	                lda vduv.queueEnd-8           ;get <m>
3195	.cfe9		d0 0a		bne $cff5	                bne scrollEntireScreen
3196	.cfeb		20 10 c9	jsr $c910	                jsr copyTextWindowToWorkspace2C
3197	.cfee		a5 d0		lda $d0		                lda STATE
3198	.cff0		29 08		and #$08	                and #STATE.isTextWindow
3199	.cff2		0a		asl a		                asl a ;A=$10 (text window active) or $00 (no text window)
3200	.cff3		80 11		bra $d006	                bra +

3202	.cff5						scrollEntireScreen:
3203	.cff5		a9 00		lda #$00	                lda #$00
3204	.cff7		8d 2c 03	sta $032c	                sta vduv.workspace._2C          ;left
3205	.cffa		8d 2f 03	sta $032f	                sta vduv.workspace._2F          ;top
3206	.cffd		20 a2 e2	jsr $e2a2	                jsr getDefaultBoundsForCurrentScreenMODE
3207	.d000		8e 2e 03	stx $032e	                stx vduv.workspace._2E          ;right
3208	.d003		8c 2d 03	sty $032d	                sty vduv.workspace._2D          ;bottom
3209	.d006						+
3210	.d006		85 dc		sta $dc		                sta ZTEMPB+0
3211	.d008		38		sec		                sec
3212	.d009		ad 2e 03	lda $032e	                lda vduv.workspace._2E          ;right
3213	.d00c		ed 2c 03	sbc $032c	                sbc vduv.workspace._2C          ;right-left
3214	.d00f		20 3b c9	jsr $c93b	                jsr getBytesPerInclusiveTextRow
3215	.d012		8d 28 03	sta $0328	                sta vduv.workspace._28+0        ;bytes per row LSB
3216	.d015		8e 29 03	stx $0329	                stx vduv.workspace._28+1        ;bytes per row MSB
3217	.d018		ae 4f 03	ldx $034f	                ldx vduv.bytesPerCharacter
3218	.d01b		e0 01		cpx #$01	                cpx #$01
3219	.d01d		f0 07		beq $d026	                beq +  ;when 1 byte/char, no cell/byte distinction
3220	.d01f		ad 1e 03	lda $031e	                lda vduv.queueEnd-6       ;get <z>
3221	.d022		f0 02		beq $d026	                beq +                ;taken if scrolling by 1 cell
3222	.d024		a2 08		ldx #$08	                ldx #$08                 ;scroll by 1 horizontal byte
3223	.d026						+
3224	.d026		8e 2a 03	stx $032a	                stx vduv.workspace._2A

3226							; <d> is a bitmask - %00000AVN.
3227							;
3228							; A is set if scrolling by axis (controlled by the VDU cursor flags)
3229							; rather than by direction.
3230							;
3231							; V is set to scroll vertically/in Y rather than horizontally/in X.
3232							;
3233							; N is set to scroll in the negative direction.

3235	.d029		ad 1d 03	lda $031d	                lda vduv.queueEnd-7           ;00000avn C=?
3236	.d02c		4a		lsr a		                lsr a                        ;000000av C=n
3237	.d02d		08		php		                php
3238	.d02e		2a		rol a		                rol a                        ;00000avn C=0
3239	.d02f		28		plp		                plp                          ;00000avn C=n
3240	.d030		2a		rol a		                rol a                        ;0000avnn C=0
3241	.d031		0a		asl a		                asl a                        ;000avnn0 C=0
3242	.d032		c9 10		cmp #$10	                cmp #$10                     ;$10 = 000a0000
3243	.d034		90 03		bcc $d039	                bcc LD039                 ;taken if scrolling by direction
3244	.d036		4d 66 03	eor $0366	                eor vduv.cursorFlags       ;adjust axes
3245	.d039						LD039:
3246	.d039		29 0e		and #$0e	                and #vduv.cursorFlags.swapAxes|vduv.cursorFlags.invertVertical|vduv.cursorFlags.invertHorizontal
3247	.d03b		05 dc		ora $dc		                ora ZTEMPB+0
3248	.d03d						LD03D:
3249	.d03d		aa		tax		                tax
3250	.d03e		ad 50 03	lda $0350	                lda vduv.screenTopLeftAddress+0
3251	.d041		85 d8		sta $d8		                sta ZMEMT+0
3252	.d043		ad 51 03	lda $0351	                lda vduv.screenTopLeftAddress+1
3253	.d046		85 d9		sta $d9		                sta ZMEMT+1
3254	.d048		20 4e d0	jsr $d04e	                jsr callScrollRoutine
3255	.d04b		4c d8 c6	jmp $c6d8	                jmp updateCRTCTextCursor

3257	.d04e						callScrollRoutine:
3258	.d04e		7c 0c e2	jmp ($e20c,x)	                jmp (scrollRoutinesTable,x)

3260	.d051						LD051:
3261	.d051		da		phx		                phx
3262	.d052		20 10 c9	jsr $c910	                jsr copyTextWindowToWorkspace2C
3263	.d055		20 08 c9	jsr $c908	                jsr copyTextWindowWidthInBytesToWorkspace28
3264	.d058		ae 4f 03	ldx $034f	                ldx $034F
3265	.d05b		8e 2a 03	stx $032a	                stx $032A
3266	.d05e		68		pla		                pla
3267	.d05f		4a		lsr a		                lsr a
3268	.d060		45 d0		eor $d0		                eor STATE
3269	.d062		29 f7		and #$f7	                and #(~STATE.isTextWindow)&$ff
3270	.d064		45 d0		eor $d0		                eor STATE
3271	.d066		0a		asl a		                asl a
3272	.d067		80 d4		bra $d03d	                bra LD03D

3274							;-------------------------------------------------------------------------
3275							;
3276							; VDU 23 8 Clear block [MasRef E.3-15]
3277							;
3278	.d069						vdu23_8_EntryPoint:
3279	.d069		9c 34 03	stz $0334	                stz $0334
3280	.d06c		9c 35 03	stz $0335	                stz $0335
3281	.d06f		20 52 e2	jsr $e252	                jsr getTextCursorPositionWithColumn81
3282	.d072		8e 36 03	stx $0336	                stx $0336
3283	.d075		8c 37 03	sty $0337	                sty $0337
3284	.d078		20 5c e2	jsr $e25c	                jsr LE25C
3285	.d07b		e8		inx		                inx
3286	.d07c		8e 38 03	stx $0338	                stx $0338
3287	.d07f		8c 39 03	sty $0339	                sty $0339
3288	.d082		a0 00		ldy #$00	                ldy #$00
3289	.d084		ad 1c 03	lda $031c	                lda $031C
3290	.d087		20 e5 d0	jsr $d0e5	                jsr LD0E5
3291	.d08a		ad 1d 03	lda $031d	                lda $031D
3292	.d08d		20 e5 d0	jsr $d0e5	                jsr LD0E5
3293	.d090		ad 33 03	lda $0333	                lda $0333
3294	.d093		cd 31 03	cmp $0331	                cmp $0331
3295	.d096		90 76		bcc $d10e	                bcc LD10E
3296	.d098		d0 08		bne $d0a2	                bne LD0A2
3297	.d09a		ad 30 03	lda $0330	                lda $0330
3298	.d09d		cd 32 03	cmp $0332	                cmp $0332
3299	.d0a0		b0 6c		bcs $d10e	                bcs LD10E
3300	.d0a2						LD0A2:
3301	.d0a2		ad 18 03	lda $0318	                lda $0318
3302	.d0a5		48		pha		                pha
3303	.d0a6		ad 19 03	lda $0319	                lda $0319
3304	.d0a9		48		pha		                pha
3305	.d0aa		ac 31 03	ldy $0331	                ldy $0331
3306	.d0ad						LD0AD:
3307	.d0ad		5a		phy		                phy
3308	.d0ae		ad 66 03	lda $0366	                lda $0366
3309	.d0b1		49 08		eor #$08	                eor #$08
3310	.d0b3		29 0e		and #$0e	                and #$0E
3311	.d0b5		aa		tax		                tax
3312	.d0b6		98		tya		                tya
3313	.d0b7		20 c7 c2	jsr $c2c7	                jsr setTextCursorXPositionWithCursorFlags
3314	.d0ba		a2 00		ldx #$00	                ldx #$00
3315	.d0bc		ad 38 03	lda $0338	                lda $0338
3316	.d0bf		cc 31 03	cpy $0331	                cpy $0331
3317	.d0c2		d0 03		bne $d0c7	                bne LD0C7
3318	.d0c4		ae 30 03	ldx $0330	                ldx $0330
3319	.d0c7						LD0C7:
3320	.d0c7		cc 33 03	cpy $0333	                cpy $0333
3321	.d0ca		f0 07		beq $d0d3	                beq LD0D3
3322	.d0cc		20 7f ca	jsr $ca7f	                jsr LCA7F
3323	.d0cf		7a		ply		                ply
3324	.d0d0		c8		iny		                iny
3325	.d0d1		80 da		bra $d0ad	                bra LD0AD

3327	.d0d3						LD0D3:
3328	.d0d3		ad 32 03	lda $0332	                lda $0332
3329	.d0d6		20 7f ca	jsr $ca7f	                jsr LCA7F
3330	.d0d9		7a		ply		                ply
3331	.d0da		68		pla		                pla
3332	.d0db		8d 19 03	sta $0319	                sta $0319
3333	.d0de		68		pla		                pla
3334	.d0df		8d 18 03	sta $0318	                sta $0318
3335	.d0e2		4c fa cc	jmp $ccfa	                jmp updateZMEMTWithTextCursorPosition

3337	.d0e5						LD0E5:
3338	.d0e5		48		pha		                pha
3339	.d0e6		29 03		and #$03	                and #$03
3340	.d0e8		0a		asl a		                asl a
3341	.d0e9		20 f0 d0	jsr $d0f0	                jsr LD0F0
3342	.d0ec		68		pla		                pla
3343	.d0ed		4a		lsr a		                lsr a
3344	.d0ee		09 01		ora #$01	                ora #$01
3345	.d0f0						LD0F0:
3346	.d0f0		aa		tax		                tax
3347	.d0f1		29 01		and #$01	                and #$01
3348	.d0f3		48		pha		                pha
3349	.d0f4		bd 34 03	lda $0334,x	                lda $0334,x
3350	.d0f7		fa		plx		                plx
3351	.d0f8		18		clc		                clc
3352	.d0f9		c8		iny		                iny
3353	.d0fa		79 1d 03	adc $031d,y	                adc $031D,y
3354	.d0fd		30 0a		bmi $d109	                bmi LD109
3355	.d0ff		dd 38 03	cmp $0338,x	                cmp $0338,x
3356	.d102		90 07		bcc $d10b	                bcc LD10B
3357	.d104		bd 38 03	lda $0338,x	                lda $0338,x
3358	.d107		80 02		bra $d10b	                bra LD10B

3360	.d109						LD109:
3361	.d109		a9 00		lda #$00	                lda #$00
3362	.d10b						LD10B:
3363	.d10b		99 2f 03	sta $032f,y	                sta $032F,y
3364	.d10e						LD10E:
3365	.d10e		60		rts		                rts

3367							;-------------------------------------------------------------------------
3368							;
3369							; VDU 23 9 Set 1st flash time [MasRef E.3-16]
3370							;
3371	.d10f						vdu23_9_EntryPoint:
3372	.d10f		38		sec		                sec

3374							;-------------------------------------------------------------------------
3375							;
3376							; VDU 23 10 Set 2nd flash time [MasRef E.3-16]
3377							;
3378	.d110						vdu23_10_EntryPoint:
3379	.d110		ae 1c 03	ldx $031c	                ldx vduv.queueEnd-8          ;get flash value
3380	.d113		a0 00		ldy #$00	                ldy #$00                     ;Y=0 for OSBYTE call
3381	.d115		90 03		bcc $d11a	                bcc doOSBYTE0A               ;taken if VDU23,10
3382	.d117		4c 92 ec	jmp $ec92	                jmp osbyte09
3383	.d11a						doOSBYTE0A:
3384	.d11a		38		sec		                sec
3385	.d11b		4c 94 ec	jmp $ec94	                jmp osbyte0A

3387							;-------------------------------------------------------------------------
3388							;
3389							; VDU 23 16 Cursor movement control [MasRef E.3-17]
3390							;
3391	.d11e						vdu23_16_EntryPoint:
3392	.d11e		ad 66 03	lda $0366	                lda vduv.cursorFlags
3393	.d121		2d 1d 03	and $031d	                and vduv.queueEnd-7          ;value AND <y>
3394	.d124		4d 1c 03	eor $031c	                eor vduv.queueEnd-8          ;(value AND <y>) EOR <x>
3395	.d127		8d 66 03	sta $0366	                sta vduv.cursorFlags
3396	.d12a		4a		lsr a		                lsr a
3397	.d12b		b0 18		bcs $d145	                bcs rtsD145            ;taken if scrollProtect flag on
3398							                ; scroll protect flag is off, so handle column 81 if
3399							                ; necessary.

3401							;-------------------------------------------------------------------------
3402							;
3403							; Handle column 81, if necessary.
3404							;
3405							; TODO - probably misnamed due to the return value
3406							;
3407							; exit:
3408							;
3409							; C=0 if not VDU 5
3410							;
3411							; C=1 if VDU 5
3412							;
3413	.d12d						handleColumn81:
3414	.d12d		48		pha		                pha
3415	.d12e		da		phx		                phx
3416	.d12f		20 d2 e2	jsr $e2d2	                jsr testVDU5State
3417	.d132		38		sec		                sec
3418	.d133		d0 0e		bne $d143	                bne plx_pla_rts        ;taken if VDU5
3419	.d135		18		clc		                clc
3420	.d136		2c 6c 03	bit $036c	                bit vduv.column81
3421	.d139		10 08		bpl $d143	                bpl plx_pla_rts        ;taken if not column 81
3422	.d13b		08		php		                php
3423	.d13c		20 f6 c3	jsr $c3f6	                jsr vdu13EntryPoint          ;CR
3424	.d13f		20 5b c2	jsr $c25b	                jsr vdu10EntryPoint          ;LF
3425	.d142		28		plp		                plp
3426	.d143						plx_pla_rts:
3427	.d143		fa		plx		                plx
3428	.d144		68		pla		                pla
3429	.d145						rtsD145:
3430	.d145		60		rts		                rts

3432							;-------------------------------------------------------------------------
3433							;
3434							; Handle PLOT. [MasRef E.3-21]
3435							;
3436							; PLOT numbers are of the form %pppppamm, where %ppppp is the PLOT
3437							; type, %a the absolute flag and %mm the PLOT mode.
3438							;
3439							; Absolute flag and mode are clear enough from [MasRef E.3-22]. The
3440							; %ppppp part isn't documented as such, so here's a list:
3441							;
3442							; %00000 =  0 = 0-7 = Plot solid line (both endpoints included) [MasRef E.3-23]
3443							; %00001 =  1 = 8-15 = Plot solid line (final point omitted) [MasRef E.3-23]
3444							; %00010 =  2 = 16-23 = Plot solid line (final point omitted) [MasRef E.3-23]
3445							; %00011 =  3 = 24-31 = Plot dotted line (final point omitted) [MasRef E.3-23]
3446							; %00100 =  4 = 32-39 = Plot solid line (initial point omitted) [MasRef E.3-24]
3447							; %00101 =  5 = 40-47 = Plot solid line (both endpoints omitted) [MasRef E.3-24]
3448							; %00110 =  6 = 48-55 = Plot dotted line (initial point omitted) [MasRef E.3-24]
3449							; %00111 =  7 = 56â<80><93>63 = Plot dotted line (both endpoints omitted) [MasRef E.3-24]
3450							; %01000 =  8 = 64â<80><93>71 = Plot point [MasRef E.3-24]
3451							; %01001 =  9 = 72â<80><93>79 = Horizontal line fill (left and right to non-background) [MasRef E.3-24]
3452							; %01010 = 10 = 80â<80><93>87 = Plot triangle [MasRef E.3-25]
3453							; %01011 = 11 = 88â<80><93>95 = Horizontal line fill (right to background) [MasRef E.3-25]
3454							; %01100 = 12 = 96â<80><93>103 = Plot rectangle [MasRef E.3-26]
3455							; %01101 = 13 = 104â<80><93>111 = Horizontal line fill (left and right to foreground) [MasRef E.3-26]
3456							; %01110 = 14 = 112â<80><93>119 = Plot parallelogram [MasRef E.3-27]
3457							; %01111 = 15 = 120â<80><93>127 = Horizontal line fill (right to non-foreground) [MasRef E.3-27]
3458							; %10000 = 16 = 128â<80><93>135 = Flood fill to non-background [MasRef E.3-28]
3459							; %10001 = 17 = 136â<80><93>143 = Flood fill to foreground [MasRef E.3-28]
3460							; %10010 = 18 = 144â<80><93>151 = Plot circle outline [MasRef E.3-28]
3461							; %10011 = 19 = 152â<80><93>159 = Plot filled circle [MasRef E.3-29]
3462							; %10100 = 20 = 160â<80><93>167 = Plot circular arc [MasRef E.3-29]
3463							; %10101 = 21 = 168â<80><93>175 = Plot filled chord segment [MasRef E.3-30]
3464							; %10110 = 22 = 176â<80><93>183 = Plot filled sector [MasRef E.3-30]
3465							; %10111 = 23 = 184â<80><93>191 = Move/copy rectangle [MasRef E.3-31]
3466							; %11000 = 24 = 192â<80><93>199 = Plot ellipse outline [MasRef E.3-32]
3467							; %11001 = 25 = 200â<80><93>207 = Plot solid ellipse [MasRef E.3-32]
3468							; %11010 = 26 = 208-215 = Reserved [MasRef E.3-34]
3469							; %11011 = 27 = 215-223 = Reserved [MasRef E.3-34]
3470							; %11100 = 28 = 224-231 = Reserved [MasRef E.3-34]
3471							; %11101 = 29 = 232-239 = Reserved for Acornsoft sprites [MasRef E.3-34]
3472							; %11110 = 30 = 240-247 = User program calls [MasRef E.3-34]
3473							; %11111 = 31 = 248-255 = User program calls [MasRef E.3-34]
3474							;
3475							; entry:
3476							;
3477							; vduQueueEnd-5 = PLOT number
3478							;
3479							; vduQueueEnd-3 = X coordinate
3480							;
3481							; vduQueueEnd-1 = Y coordinate
3482							;;

3484	.d146						handlePLOT:
3485	.d146		a2 20		ldx #$20	                ldx #VDUVariables.queueEnd-4
3486	.d148		20 e2 d1	jsr $d1e2	                jsr eigabsForPLOT
3487	.d14b		ad 1f 03	lda $031f	                lda vduv.queueEnd-5          ;get PLOT number
3488	.d14e		a0 05		ldy #$05	                ldy #gcolModeLeave                     ;
3489	.d150		29 03		and #$03	                and #$03                     ;mask out colour/plot mode [MasRef E.3-22]
3490	.d152		f0 0c		beq $d160	                beq LD160 ;taken if <p> MOD 4=0 - early out
3491	.d154		4a		lsr a		                lsr a                        ;C=1 if using VDU18 settings
3492	.d155		88		dey		                dey                          ;Y=gcolModeInvert
3493	.d156		90 08		bcc $d160	                bcc LD160                    ;taken if invert mode
3494	.d158		aa		tax		                tax              ;X=0 if fg settings, 1 if bg settings
3495	.d159		bc 5b 03	ldy $035b,x	                ldy vduv.foregroundGCOLMode,x
3496	.d15c		0a		asl a		                asl a
3497	.d15d		0a		asl a		                asl a
3498	.d15e		0a		asl a		                asl a
3499	.d15f		aa		tax		                tax              ;X=0 if fg settings, 8 if bg settings
3500	.d160						LD160:
3501	.d160		8e 59 03	stx $0359	                stx vduv.graphicsPlotState
3502	.d163		98		tya		                tya
3503	.d164		29 0f		and #$0f	                and #$0F
3504	.d166		8d 5a 03	sta $035a	                sta vduv.graphicsPlotMode
3505	.d169		ad 1f 03	lda $031f	                lda vduv.queueEnd-5          ;get PLOT number pppppmmm
3506	.d16c		4a		lsr a		                lsr a                        ;0pppppmm
3507	.d16d		4a		lsr a		                lsr a                        ;00pppppm
3508	.d16e		29 fe		and #$fe	                and #$fe                     ;00ppppp0
3509	.d170		aa		tax		                tax
3510	.d171		c9 34		cmp #$34	                cmp #208/4
3511	.d173		b0 1b		bcs $d190	                bcs LD190                    ;taken if reserved PLOT
3512	.d175		29 f3		and #$f3	                and #$F3                     ;00pp00p0
3513	.d177		c9 12		cmp #$12	                cmp #$12                     ;
3514	.d179		08		php		                php                          ;
3515	.d17a		f0 08		beq $d184	                beq LD184                ;taken if horizonal line fill
3516	.d17c		e0 2e		cpx #$2e	                cpx #184/4
3517	.d17e		f0 04		beq $d184	                beq LD184                ;taken if move/copy rectangle
3518	.d180		c0 05		cpy #$05	                cpy #gcolModeLeave
3519	.d182		f0 19		beq $d19d	                beq LD19D
3520	.d184						LD184:
3521	.d184		ad 1f 03	lda $031f	                lda vduv.queueEnd-5          ;get PLOT number
3522	.d187		20 93 d1	jsr $d193	                jsr LD193
3523	.d18a		28		plp		                plp
3524	.d18b		d0 11		bne $d19e	                bne LD19E
3525	.d18d		4c df c4	jmp $c4df	                jmp LC4DF

3527	.d190						LD190:
3528	.d190		4c a3 c6	jmp $c6a3	                jmp callVDUVForPLOT

3530	.d193						LD193:
3531	.d193		e0 10		cpx #$10	                cpx #64/4
3532	.d195		b0 03		bcs $d19a	                bcs LD19A                     ;taken if PLOT >=64
3533	.d197		4c a9 d8	jmp $d8a9	                jmp LD8A9                    ;handle line PLOTs

3535	.d19a						LD19A:
3536	.d19a		7c 7b e0	jmp ($e07b,x)	                jmp (plotEntryPointTable-8*2,x)

3538	.d19d						LD19D:
3539	.d19d		68		pla		                pla
3540	.d19e						LD19E:
3541	.d19e		20 1a c9	jsr $c91a	                jsr copyGraphicsCursorPixelsToOldGraphicsCursorPixels
3542	.d1a1		a0 24		ldy #$24	                ldy #$24
3543	.d1a3		4c 16 c9	jmp $c916	                jmp copyLastFourVDUQueueBytes

3545	.d1a6						LD1A6:
3546	.d1a6		a2 24		ldx #$24	                ldx #VDUVariables.graphicsCursorPixelsX

3548							;-------------------------------------------------------------------------
3549							;
3550							; WIND [MasRef E.4-7]. The result is a bit field, %vvhh, where %vv is
3551							; the outcode for the vertical axis and %hh the outcode for the
3552							; horizontal axis. Each outcode is %xn, where x is set if point above
3553							; maximum and n set if point below minimum. (Of course, %11 is then
3554							; not possible.)
3555							;
3556							; See https://en.wikipedia.org/wiki/Cohen%E2%80%93Sutherland_algorithm
3557							;
3558							; So the possible results, in binary, are:
3559							;
3560							; %1001 | %1000 | %1010
3561							; ------+-------+------
3562							; %0001 | %0000 | %0010
3563							; ------+-------+------
3564							; %0101 | %0100 | %0110
3565							;
3566	.d1a8						windEntryPoint:
3567	.d1a8		e8		inx		                inx
3568	.d1a9		e8		inx		                inx                          ;point to Y coordinate
3569	.d1aa		20 b5 d1	jsr $d1b5	                jsr getOutcodeForYAxis                    ;process Y coordinate
3570	.d1ad		ca		dex		                dex
3571	.d1ae		ca		dex		                dex                          ;point to X coordinate
3572	.d1af		0a		asl a		                asl a
3573	.d1b0		0a		asl a		                asl a                        ;shift Y outcode into bits 2/3
3574	.d1b1		a0 00		ldy #$00	                ldy #$00                     ;doing Y axis
3575	.d1b3		80 04		bra $d1b9	                bra updateOutcodeForAxis

3577							;-------------------------------------------------------------------------
3578							;
3579	.d1b5						getOutcodeForYAxis:
3580	.d1b5		a0 02		ldy #$02	                ldy #$02                     ;Y=2 for Y coordinate
3581							;-------------------------------------------------------------------------
3582							;
3583							; Get outcode for X or Y axis.
3584							;
3585							; entry:
3586							;
3587							; X = offset in VDU variables of coordinate
3588							;
3589							; Y = 0 if X axis, 2 if Y axis
3590							;
3591							; exit:
3592							;
3593							; ZTEMP?0 = outcode - 0, 1 or 2
3594							;
3595							; A = outcode
3596							;
3597							; N/Z set as per outcode
3598							;
3599	.d1b7						getOutcodeForAxis:
3600	.d1b7		a9 00		lda #$00	                lda #$00                     ;initialize result

3602							;-------------------------------------------------------------------------
3603							;
3604							; Update outcode for X or Y axis
3605							;
3606							; entry: as per getOutcodeForAxis
3607							;
3608							; exit:
3609							;
3610							; ZTEMP?0 = updated; outcode is added to its existing value
3611							;
3612	.d1b9						updateOutcodeForAxis:
3613	.d1b9		85 da		sta $da		                sta ZTEMP+0                  ;save current result
3614							                ; set flags for coordinate-minimum
3615	.d1bb		bd 00 03	lda $0300,x	                lda vduv+0,x
3616	.d1be		d9 00 03	cmp $0300,y	                cmp vduv.graphicsWindowPixelsLeft+0,y
3617	.d1c1		bd 01 03	lda $0301,x	                lda vduv+1,x
3618	.d1c4		f9 01 03	sbc $0301,y	                sbc vduv.graphicsWindowPixelsLeft+1,y
3619	.d1c7		30 10		bmi $d1d9	                bmi add1ToOutcode ;taken if point below minimum - outcode is 1

3621							                ; set flags for maximum-coordinate
3622	.d1c9		b9 04 03	lda $0304,y	                lda vduv.graphicsWindowPixelsRight+0,y
3623	.d1cc		dd 00 03	cmp $0300,x	                cmp vduv+0,x
3624	.d1cf		b9 05 03	lda $0305,y	                lda vduv.graphicsWindowPixelsRight+1,y
3625	.d1d2		fd 01 03	sbc $0301,x	                sbc vduv+1,x
3626	.d1d5		10 04		bpl $d1db	                bpl gotOutcode ;taken if point below maximum - axis outcode is 0
3627							                ; point is above maximum - axis outcode is 2
3628	.d1d7						add2ToOutcode:
3629	.d1d7		e6 da		inc $da		                inc ZTEMP+0
3630	.d1d9						add1ToOutcode:
3631	.d1d9		e6 da		inc $da		                inc ZTEMP+0
3632	.d1db						gotOutcode:
3633	.d1db		a5 da		lda $da		                lda ZTEMP+0
3634	.d1dd		60		rts		                rts

3636							;-------------------------------------------------------------------------
3637							;
3638							; EIGABS entry point.
3639							;
3640	.d1de						eigabsEntryPoint:
3641	.d1de		a9 ff		lda #$ff	                lda #$FF ;pretend it's PLOT 255 (as that would be absolute coordinates)
3642	.d1e0		80 03		bra $d1e5	                bra eigabsCommon

3644							;-------------------------------------------------------------------------
3645							;
3646							; EIGABS, but for a VDU 25. Handles relative/absolute addressing,
3647							; based on the PLOT number in the VDU queue.
3648							;
3649	.d1e2						eigabsForPLOT:
3650	.d1e2		ad 1f 03	lda $031f	                lda vduv.queueEnd-5          ;get PLOT number

3652							;-------------------------------------------------------------------------
3653							;
3654							; EIGABS shared code.
3655							;
3656	.d1e5						eigabsCommon:
3657	.d1e5		85 da		sta $da		                sta ZTEMP+0                  ;save PLOT number
3658	.d1e7		a0 02		ldy #$02	                ldy #$02                     ;process Y
3659	.d1e9		20 0b d2	jsr $d20b	                jsr handleExternalCoordinate
3660	.d1ec		20 42 d2	jsr $d242	                jsr divideCoordinatesBy2     ;divide Y by 4 - convert 0-1023 to 0-255
3661	.d1ef		a0 00		ldy #$00	                ldy #$00                     ;process X
3662	.d1f1		ca		dex		                dex                          ;...
3663	.d1f2		ca		dex		                dex                          ;...
3664	.d1f3		20 0b d2	jsr $d20b	                jsr handleExternalCoordinate
3665	.d1f6		ac 61 03	ldy $0361	                ldy vduv.pixelsPerByteMinusOne
3666	.d1f9		c0 03		cpy #$03	                cpy #$03  ;
3667	.d1fb		f0 05		beq $d202	                beq +     ;branch taken if mode 1/5 - divide by 4 or 8
3668	.d1fd		b0 06		bcs $d205	                bcs ++    ;branch taken if mode 0/4 - divide by 2 or 4
3669	.d1ff		20 42 d2	jsr $d242	                jsr divideCoordinatesBy2     ;mode 2 - divide by 8
3670	.d202						+
3671	.d202		20 42 d2	jsr $d242	                jsr divideCoordinatesBy2
3672	.d205						+
3673	.d205		ad 56 03	lda $0356	                lda vduv.currentScreenMODEGroup
3674	.d208		d0 38		bne $d242	                bne divideCoordinatesBy2     ;branch taken if MODE 4/5
3675	.d20a		60		rts		                rts

3677							;-------------------------------------------------------------------------
3678							;
3679							; Handle external coordinate.
3680							;
3681							; 1. Deal with absolute or relative PLOTting
3682							;
3683							; 2. Update graphics cursor position
3684							;
3685							; 3. Handle window origin
3686							;
3687							; 4. Update input coordinate
3688							;
3689							; 5. Divide result by 2 (as this always needs doing at least once)
3690							;
3691							; entry:
3692							;
3693							; ZTEMP?0 = PLOT number
3694							;
3695							; X = offset-2 of external coordinates
3696							;
3697							; Y = 0 to process X coordinate, 2 to process Y coordinate
3698							;
3699	.d20b						handleExternalCoordinate:
3700	.d20b		18		clc		                clc
3701	.d20c		a5 da		lda $da		                lda ZTEMP+0                  ;get PLOT number
3702	.d20e		29 04		and #$04	                and #$04                     ;get absolute/relative flag
3703	.d210		f0 09		beq $d21b	                beq relativePLOT             ;branch taken if relative
3704	.d212						absolutePLOT:
3705	.d212		bd 02 03	lda $0302,x	                lda vduv+2,x                 ;get coordinate LSB
3706	.d215		48		pha		                pha                          ;save coordinate LSB
3707	.d216		bd 03 03	lda $0303,x	                lda vduv+3,x                 ;get coordinate MSB
3708	.d219		80 0e		bra $d229	                bra LD229                    ;

3710	.d21b						relativePLOT:
3711	.d21b		bd 02 03	lda $0302,x	                lda vduv+2,x                 ;get coordinate LSB
3712	.d21e		79 10 03	adc $0310,y	                adc vduv.graphicsCursorPositionX+0,y ;add current position LSB
3713	.d221		48		pha		                pha                                  ;save coordinate LSB
3714	.d222		bd 03 03	lda $0303,x	                lda vduv+3,x                 ;get coordinate MSB
3715	.d225		79 11 03	adc $0311,y	                adc vduv.graphicsCursorPositionX+1,y ;add current position MSB
3716	.d228		18		clc		                clc
3717	.d229						LD229:
3718	.d229		99 11 03	sta $0311,y	                sta vduv.graphicsCursorPositionX+1,y ;update current position MSB
3719	.d22c		79 0d 03	adc $030d,y	                adc vduv.graphicsWindowOriginX+1,y   ;add window origin MSB
3720	.d22f		9d 03 03	sta $0303,x	                sta vduv+3,x                  ;update coordinate MSB
3721	.d232		68		pla		                pla                          ;restore coordinate LSB
3722	.d233		99 10 03	sta $0310,y	                sta vduv.graphicsCursorPositionX+0,y ;update current position LSB
3723	.d236		18		clc		                clc
3724	.d237		79 0c 03	adc $030c,y	                adc vduv.graphicsWindowOriginX+0,y ;add window origin LSB
3725	.d23a		9d 02 03	sta $0302,x	                sta vduv+2,x                       ;update coordinate LSB
3726	.d23d		90 03		bcc $d242	                bcc +
3727	.d23f		fe 03 03	inc $0303,x	                inc vduv+3,x       ;handle carry, ignored earlier
3728	.d242						+

3730	.d242						divideCoordinatesBy2:
3731	.d242		bd 03 03	lda $0303,x	                lda vduv+3,x
3732	.d245		0a		asl a		                asl a                        ;C=bit 7
3733	.d246		7e 03 03	ror $0303,x	                ror vduv+3,x                  ;signed divide by 2
3734	.d249		7e 02 03	ror $0302,x	                ror vduv+2,x                  ;signed divide by 2
3735	.d24c		60		rts		                rts

3737							;-------------------------------------------------------------------------

3739	.d24d						LD24D:
3740	.d24d		da		phx		                phx
3741	.d24e		5a		phy		                phy
3742	.d24f		5a		phy		                phy
3743	.d250		da		phx		                phx
3744	.d251		5a		phy		                phy
3745	.d252		20 80 d2	jsr $d280	                jsr LD280
3746	.d255		fa		plx		                plx
3747	.d256		20 80 d2	jsr $d280	                jsr LD280
3748	.d259		fa		plx		                plx
3749	.d25a		7a		ply		                ply
3750	.d25b		20 e8 da	jsr $dae8	                jsr LDAE8
3751	.d25e		fa		plx		                plx
3752	.d25f		20 68 d2	jsr $d268	                jsr LD268
3753	.d262		fa		plx		                plx
3754	.d263		80 03		bra $d268	                bra LD268

3756	.d265						LD265:
3757	.d265		20 09 9b	jsr $9b09	                jsr terminal.L9B09
3758	.d268						LD268:
3759	.d268		a0 00		ldy #$00	                ldy #$00
3760	.d26a		20 70 d2	jsr $d270	                jsr LD270
3761	.d26d		e8		inx		                inx
3762	.d26e		a0 02		ldy #$02	                ldy #$02
3763	.d270						LD270:
3764	.d270		38		sec		                sec
3765	.d271		20 76 d2	jsr $d276	                jsr LD276
3766	.d274		e8		inx		                inx
3767	.d275		c8		iny		                iny
3768	.d276						LD276:
3769	.d276		bd 00 03	lda $0300,x	                lda $0300,x
3770	.d279		f9 14 03	sbc $0314,y	                sbc $0314,y
3771	.d27c		9d 00 03	sta $0300,x	                sta $0300,x
3772	.d27f						LD27F:
3773	.d27f		60		rts		                rts

3775	.d280						LD280:
3776	.d280		a0 00		ldy #$00	                ldy #$00
3777	.d282		20 88 d2	jsr $d288	                jsr LD288
3778	.d285		e8		inx		                inx
3779	.d286		a0 02		ldy #$02	                ldy #$02
3780	.d288						LD288:
3781	.d288		18		clc		                clc
3782	.d289		20 8e d2	jsr $d28e	                jsr LD28E
3783	.d28c		e8		inx		                inx
3784	.d28d		c8		iny		                iny
3785	.d28e						LD28E:
3786	.d28e		bd 00 03	lda $0300,x	                lda $0300,x
3787	.d291		79 14 03	adc $0314,y	                adc $0314,y
3788	.d294		9d 00 03	sta $0300,x	                sta $0300,x
3789	.d297		60		rts		                rts

3791	.d298						LD298:
3792	.d298		85 e1		sta $e1		                sta $E1
3793	.d29a		20 25 d4	jsr $d425	                jsr LD425
3794	.d29d		f0 e0		beq $d27f	                beq LD27F
3795	.d29f		a0 14		ldy #$14	                ldy #$14
3796	.d2a1		a9 20		lda #$20	                lda #$20
3797	.d2a3		a2 2c		ldx #$2c	                ldx #$2C
3798	.d2a5		20 65 d2	jsr $d265	                jsr LD265
3799	.d2a8		20 aa d3	jsr $d3aa	                jsr LD3AA
3800	.d2ab		a9 01		lda #$01	                lda #$01
3801	.d2ad						LD2AD:
3802	.d2ad		84 e0		sty $e0		                sty $E0
3803	.d2af		04 e0		tsb $e0		                tsb $E0
3804	.d2b1		a2 2c		ldx #$2c	                ldx #VDUVariables.workspace._2C
3805	.d2b3		a0 28		ldy #$28	                ldy #VDUVariables.workspace._28
3806	.d2b5		20 1e c9	jsr $c91e	                jsr copyFourBytesWithinVDUVariables
3807	.d2b8		2c 35 03	bit $0335	                bit $0335
3808	.d2bb		08		php		                php
3809	.d2bc		a2 2c		ldx #$2c	                ldx #$2C
3810	.d2be		20 26 d7	jsr $d726	                jsr LD726
3811	.d2c1		28		plp		                plp
3812	.d2c2		10 03		bpl $d2c7	                bpl LD2C7
3813	.d2c4		20 aa d3	jsr $d3aa	                jsr LD3AA
3814	.d2c7						LD2C7:
3815	.d2c7		ac 2c 03	ldy $032c	                ldy $032C
3816	.d2ca		ad 2d 03	lda $032d	                lda $032D
3817	.d2cd		30 03		bmi $d2d2	                bmi LD2D2
3818	.d2cf		20 2e c9	jsr $c92e	                jsr negateAY
3819	.d2d2						LD2D2:
3820	.d2d2		48		pha		                pha
3821	.d2d3		18		clc		                clc
3822	.d2d4		98		tya		                tya
3823	.d2d5		6d 30 88	adc $8830	                adc L8830
3824	.d2d8		a8		tay		                tay
3825	.d2d9		68		pla		                pla
3826	.d2da		6d 31 88	adc $8831	                adc L8831
3827	.d2dd		10 ce		bpl $d2ad	                bpl LD2AD
3828	.d2df		1a		inc a		                inc a
3829	.d2e0		d0 23		bne $d305	                bne LD305
3830	.d2e2		c8		iny		                iny
3831	.d2e3		d0 20		bne $d305	                bne LD305
3832	.d2e5		a5 e0		lda $e0		                lda $E0
3833	.d2e7		f0 1c		beq $d305	                beq LD305
3834	.d2e9		ad 2c 03	lda $032c	                lda $032C
3835	.d2ec		cd 28 03	cmp $0328	                cmp $0328
3836	.d2ef		f0 14		beq $d305	                beq LD305
3837	.d2f1		a2 2c		ldx #$2c	                ldx #$2C
3838	.d2f3		a0 28		ldy #$28	                ldy #$28
3839	.d2f5		ad 36 03	lda $0336	                lda $0336
3840	.d2f8		0a		asl a		                asl a
3841	.d2f9		4d 36 03	eor $0336	                eor $0336
3842	.d2fc		10 04		bpl $d302	                bpl LD302
3843	.d2fe		e8		inx		                inx
3844	.d2ff		e8		inx		                inx
3845	.d300		c8		iny		                iny
3846	.d301		c8		iny		                iny
3847	.d302						LD302:
3848	.d302		20 0c c9	jsr $c90c	                jsr copyTwoBytesWithinVDUVariables
3849	.d305						LD305:
3850	.d305		20 25 d4	jsr $d425	                jsr LD425
3851	.d308		ad 29 03	lda $0329	                lda $0329
3852	.d30b		aa		tax		                tax
3853	.d30c		4d 1c 03	eor $031c	                eor $031C
3854	.d30f		30 18		bmi $d329	                bmi LD329
3855	.d311		a0 02		ldy #$02	                ldy #$02
3856	.d313		20 6f d4	jsr $d46f	                jsr LD46F
3857	.d316		d0 0c		bne $d324	                bne LD324
3858	.d318		ae 2b 03	ldx $032b	                ldx $032B
3859	.d31b		a0 00		ldy #$00	                ldy #$00
3860	.d31d		20 6f d4	jsr $d46f	                jsr LD46F
3861	.d320		f0 11		beq $d333	                beq LD333
3862	.d322		49 80		eor #$80	                eor #$80
3863	.d324						LD324:
3864	.d324		86 da		stx $da		                stx $DA
3865	.d326		45 da		eor $da		                eor $DA
3866	.d328		aa		tax		                tax
3867	.d329						LD329:
3868	.d329		8a		txa		                txa
3869	.d32a		29 80		and #$80	                and #$80
3870	.d32c		f0 02		beq $d330	                beq LD330
3871	.d32e		a9 c0		lda #$c0	                lda #$C0
3872	.d330						LD330:
3873	.d330		04 e1		tsb $e1		                tsb $E1
3874	.d332		18		clc		                clc
3875	.d333						LD333:
3876	.d333		60		rts		                rts

3878	.d334						LD334:
3879	.d334		a5 e1		lda $e1		                lda $E1
3880	.d336		8d 48 88	sta $8848	                sta L8848
3881	.d339		89 03		bit #$03	                bit #$03
3882	.d33b		f0 f6		beq $d333	                beq LD333
3883	.d33d		a9 10		lda #$10	                lda #$10
3884	.d33f		85 dc		sta $dc		                sta $DC
3885	.d341		0a		asl a		                asl a
3886	.d342		85 dd		sta $dd		                sta $DD
3887	.d344		a2 1b		ldx #$1b	                ldx #$1B
3888	.d346		20 4f d3	jsr $d34f	                jsr LD34F
3889	.d349		06 dc		asl $dc		                asl $DC
3890	.d34b		46 dd		lsr $dd		                lsr $DD
3891	.d34d		a2 28		ldx #$28	                ldx #$28
3892	.d34f						LD34F:
3893	.d34f		a9 80		lda #$80	                lda #$80
3894	.d351		85 da		sta $da		                sta $DA
3895	.d353		bd 02 03	lda $0302,x	                lda $0302,x
3896	.d356		cd 32 88	cmp $8832	                cmp L8832
3897	.d359		d0 d8		bne $d333	                bne LD333
3898	.d35b		bd 03 03	lda $0303,x	                lda $0303,x
3899	.d35e		cd 33 88	cmp $8833	                cmp L8833
3900	.d361		d0 d0		bne $d333	                bne LD333
3901	.d363		bc 00 03	ldy $0300,x	                ldy $0300,x
3902	.d366		bd 01 03	lda $0301,x	                lda $0301,x
3903	.d369		10 05		bpl $d370	                bpl LD370
3904	.d36b		46 da		lsr $da		                lsr $DA
3905	.d36d		20 2e c9	jsr $c92e	                jsr negateAY
3906	.d370						LD370:
3907	.d370		cc 30 88	cpy $8830	                cpy L8830
3908	.d373		d0 be		bne $d333	                bne LD333
3909	.d375		cd 31 88	cmp $8831	                cmp L8831
3910	.d378		d0 b9		bne $d333	                bne LD333
3911	.d37a		a5 e1		lda $e1		                lda $E1
3912	.d37c		89 02		bit #$02	                bit #$02
3913	.d37e		f0 19		beq $d399	                beq LD399
3914	.d380		a0 30		ldy #$30	                ldy #$30
3915	.d382		89 01		bit #$01	                bit #$01
3916	.d384		f0 02		beq $d388	                beq LD388
3917	.d386		a4 dc		ldy $dc		                ldy $DC
3918	.d388						LD388:
3919	.d388		98		tya		                tya
3920	.d389		4a		lsr a		                lsr a
3921	.d38a		4a		lsr a		                lsr a
3922	.d38b		24 e1		bit $e1		                bit $E1
3923	.d38d		d0 06		bne $d395	                bne LD395
3924	.d38f		05 dc		ora $dc		                ora $DC
3925	.d391		04 e1		tsb $e1		                tsb $E1
3926	.d393		80 04		bra $d399	                bra LD399

3928	.d395						LD395:
3929	.d395		05 dd		ora $dd		                ora $DD
3930	.d397		14 e1		trb $e1		                trb $E1
3931	.d399						LD399:
3932	.d399		a5 da		lda $da		                lda $DA
3933	.d39b		24 e1		bit $e1		                bit $E1
3934	.d39d		f0 91		beq $d330	                beq LD330
3935	.d39f		14 e1		trb $e1		                trb $E1
3936	.d3a1		a5 e1		lda $e1		                lda $E1
3937	.d3a3		8d 48 88	sta $8848	                sta L8848
3938	.d3a6		8d 49 88	sta $8849	                sta L8849
3939	.d3a9		60		rts		                rts

3941	.d3aa						LD3AA:
3942	.d3aa		ad 2e 03	lda $032e	                lda $032E
3943	.d3ad		8d 32 88	sta $8832	                sta L8832
3944	.d3b0		ad 2f 03	lda $032f	                lda $032F
3945	.d3b3		8d 33 88	sta $8833	                sta L8833
3946	.d3b6		20 fc d3	jsr $d3fc	                jsr LD3FC
3947	.d3b9		20 13 d5	jsr $d513	                jsr LD513
3948	.d3bc		8c 30 88	sty $8830	                sty L8830
3949	.d3bf		ad 46 88	lda $8846	                lda L8846
3950	.d3c2		4a		lsr a		                lsr a
3951	.d3c3		ad 3d 88	lda $883d	                lda L883D
3952	.d3c6		90 06		bcc $d3ce	                bcc LD3CE
3953	.d3c8		c9 80		cmp #$80	                cmp #$80
3954	.d3ca		6a		ror a		                ror a
3955	.d3cb		6e 30 88	ror $8830	                ror L8830
3956	.d3ce						LD3CE:
3957	.d3ce		8d 31 88	sta $8831	                sta L8831
3958	.d3d1		60		rts		                rts

3960	.d3d2						LD3D2:
3961	.d3d2		9c 47 88	stz $8847	                stz L8847
3962	.d3d5		9c 30 88	stz $8830	                stz L8830
3963	.d3d8		9c 31 88	stz $8831	                stz L8831
3964	.d3db		9c 34 88	stz $8834	                stz L8834
3965	.d3de		9c 35 88	stz $8835	                stz L8835
3966	.d3e1		ad 32 88	lda $8832	                lda L8832
3967	.d3e4		0a		asl a		                asl a
3968	.d3e5		8d 36 88	sta $8836	                sta L8836
3969	.d3e8		ad 33 88	lda $8833	                lda L8833
3970	.d3eb		2a		rol a		                rol a
3971	.d3ec		8d 37 88	sta $8837	                sta L8837
3972	.d3ef		ad 46 88	lda $8846	                lda L8846
3973	.d3f2		89 02		bit #$02	                bit #$02
3974	.d3f4		f0 06		beq $d3fc	                beq LD3FC
3975	.d3f6		0e 36 88	asl $8836	                asl L8836
3976	.d3f9		2e 37 88	rol $8837	                rol L8837
3977	.d3fc						LD3FC:
3978	.d3fc		ad 46 88	lda $8846	                lda L8846
3979	.d3ff		4a		lsr a		                lsr a
3980	.d400		4a		lsr a		                lsr a
3981	.d401		ac 32 88	ldy $8832	                ldy L8832
3982	.d404		ad 33 88	lda $8833	                lda L8833
3983	.d407		20 c5 d4	jsr $d4c5	                jsr LD4C5
3984	.d40a		38		sec		                sec
3985	.d40b		a2 fc		ldx #$fc	                ldx #$FC
3986	.d40d						LD40D:
3987	.d40d		bd 3c 87	lda $873c,x	                lda L873C,x
3988	.d410		fd 44 87	sbc $8744,x	                sbc L8744,x
3989	.d413		9d 44 87	sta $8744,x	                sta L8744,x
3990	.d416		e8		inx		                inx
3991	.d417		d0 f4		bne $d40d	                bne LD40D
3992	.d419		60		rts		                rts

3994	.d41a						LD41A:
3995	.d41a		20 1a c9	jsr $c91a	                jsr copyGraphicsCursorPixelsToOldGraphicsCursorPixels
3996	.d41d		64 e1		stz $e1		                stz $E1
3997	.d41f		a2 20		ldx #$20	                ldx #$20
3998	.d421		20 27 d4	jsr $d427	                jsr LD427
3999	.d424		60		rts		                rts

4001	.d425						LD425:
4002	.d425		a2 24		ldx #$24	                ldx #VDUVariables.graphicsCursorPixelsX
4003	.d427						LD427:
4004	.d427		a0 1b		ldy #$1b	                ldy #VDUVariables.queueEnd-9
4005	.d429		20 1e c9	jsr $c91e	                jsr copyFourBytesWithinVDUVariables
4006	.d42c		a2 1b		ldx #$1b	                ldx #$1B
4007	.d42e		20 68 d2	jsr $d268	                jsr LD268
4008	.d431		20 86 d4	jsr $d486	                jsr LD486
4009	.d434		20 13 d5	jsr $d513	                jsr LD513
4010	.d437		a0 0c		ldy #$0c	                ldy #$0C
4011	.d439		20 ab d4	jsr $d4ab	                jsr LD4AB
4012	.d43c		20 13 d5	jsr $d513	                jsr LD513
4013	.d43f		c9 20		cmp #$20	                cmp #$20
4014	.d441		90 05		bcc $d448	                bcc LD448
4015	.d443		68		pla		                pla
4016	.d444		68		pla		                pla
4017	.d445		68		pla		                pla
4018	.d446		68		pla		                pla
4019	.d447		60		rts		                rts

4021	.d448						LD448:
4022	.d448		8c 44 88	sty $8844	                sty L8844
4023	.d44b		8d 45 88	sta $8845	                sta L8845
4024	.d44e		ad 46 88	lda $8846	                lda L8846
4025	.d451		89 02		bit #$02	                bit #$02
4026	.d453		f0 06		beq $d45b	                beq LD45B
4027	.d455		4e 45 88	lsr $8845	                lsr L8845
4028	.d458		6e 44 88	ror $8844	                ror L8844
4029	.d45b						LD45B:
4030	.d45b		ac 44 88	ldy $8844	                ldy L8844
4031	.d45e		ad 45 88	lda $8845	                lda L8845
4032	.d461		20 2e c9	jsr $c92e	                jsr negateAY
4033	.d464		8c 32 88	sty $8832	                sty L8832
4034	.d467		8d 33 88	sta $8833	                sta L8833
4035	.d46a		0d 32 88	ora $8832	                ora L8832
4036	.d46d		38		sec		                sec
4037	.d46e		60		rts		                rts

4039	.d46f						LD46F:
4040	.d46f		64 da		stz $da		                stz $DA
4041	.d471		b9 1b 03	lda $031b,y	                lda $031B,y
4042	.d474		d9 28 03	cmp $0328,y	                cmp $0328,y
4043	.d477		f0 02		beq $d47b	                beq LD47B
4044	.d479		e6 da		inc $da		                inc $DA
4045	.d47b						LD47B:
4046	.d47b		b9 1c 03	lda $031c,y	                lda $031C,y
4047	.d47e		f9 29 03	sbc $0329,y	                sbc $0329,y
4048	.d481		d0 02		bne $d485	                bne LD485
4049	.d483		a5 da		lda $da		                lda $DA
4050	.d485						LD485:
4051	.d485		60		rts		                rts

4053	.d486						LD486:
4054	.d486		ae 55 03	ldx $0355	                ldx $0355
4055	.d489		bd bf d4	lda $d4bf,x	                lda LD4BF,x
4056	.d48c		8d 46 88	sta $8846	                sta L8846
4057	.d48f		4a		lsr a		                lsr a
4058	.d490		48		pha		                pha
4059	.d491		a2 04		ldx #$04	                ldx #$04
4060	.d493						LD493:
4061	.d493		9e 37 88	stz $8837,x	                stz L8837,x
4062	.d496		ca		dex		                dex
4063	.d497		d0 fa		bne $d493	                bne LD493
4064	.d499		20 a0 d4	jsr $d4a0	                jsr LD4A0
4065	.d49c		68		pla		                pla
4066	.d49d		4a		lsr a		                lsr a
4067	.d49e		a2 02		ldx #$02	                ldx #$02
4068	.d4a0						LD4A0:
4069	.d4a0		bc 1b 03	ldy $031b,x	                ldy $031B,x
4070	.d4a3		bd 1c 03	lda $031c,x	                lda $031C,x
4071	.d4a6		20 c5 d4	jsr $d4c5	                jsr LD4C5
4072	.d4a9		a0 10		ldy #$10	                ldy #$10
4073	.d4ab						LD4AB:
4074	.d4ab		18		clc		                clc
4075	.d4ac		a2 fc		ldx #$fc	                ldx #$FC
4076	.d4ae						LD4AE:
4077	.d4ae		bd 3c 87	lda $873c,x	                lda L873C,x
4078	.d4b1		79 30 88	adc $8830,y	                adc L8830,y
4079	.d4b4		9d 3c 87	sta $873c,x	                sta L873C,x
4080	.d4b7		9d 44 87	sta $8744,x	                sta L8744,x
4081	.d4ba		c8		iny		                iny
4082	.d4bb		e8		inx		                inx
4083	.d4bc		d0 f0		bne $d4ae	                bne LD4AE
4084	.d4be		60		rts		                rts

4086	.d4bf						LD4BF:
4087	>d4bf		02				                .byte $02
4088	.d4c0		00		brk #		                brk
4089	.d4c1		01 ff		ora ($ff,x)	                ora ($FF,x)
4090	.d4c3		00		brk #		                brk
4091							;ORA (&8C,x)      :\ D4C4= 01       ..
4092	>d4c4		01				                .byte $01
4093	.d4c5						LD4C5:
4094	.d4c5		8c 3c 88	sty $883c	                sty L883C
4095	.d4c8		90 04		bcc $d4ce	                bcc LD4CE
4096	.d4ca		0e 3c 88	asl $883c	                asl L883C
4097	.d4cd		2a		rol a		                rol a
4098	.d4ce						LD4CE:
4099	.d4ce		8d 3d 88	sta $883d	                sta L883D
4100	.d4d1		ac 3c 88	ldy $883c	                ldy L883C
4101	.d4d4		aa		tax		                tax
4102	.d4d5		10 03		bpl $d4da	                bpl LD4DA
4103	.d4d7		20 2e c9	jsr $c92e	                jsr negateAY
4104	.d4da						LD4DA:
4105	.d4da		8c 3c 88	sty $883c	                sty L883C
4106	.d4dd		8d 3d 88	sta $883d	                sta L883D
4107	.d4e0		8c 40 88	sty $8840	                sty L8840
4108	.d4e3		9c 42 88	stz $8842	                stz L8842
4109	.d4e6		9c 43 88	stz $8843	                stz L8843
4110	.d4e9		a0 0f		ldy #$0f	                ldy #$0F
4111	.d4eb		4a		lsr a		                lsr a
4112	.d4ec		8d 41 88	sta $8841	                sta L8841
4113	.d4ef		6e 40 88	ror $8840	                ror L8840
4114	.d4f2						LD4F2:
4115	.d4f2		90 13		bcc $d507	                bcc LD507
4116	.d4f4		18		clc		                clc
4117	.d4f5		ad 3c 88	lda $883c	                lda L883C
4118	.d4f8		6d 42 88	adc $8842	                adc L8842
4119	.d4fb		8d 42 88	sta $8842	                sta L8842
4120	.d4fe		ad 3d 88	lda $883d	                lda L883D
4121	.d501		6d 43 88	adc $8843	                adc L8843
4122	.d504		8d 43 88	sta $8843	                sta L8843
4123	.d507						LD507:
4124	.d507		a2 03		ldx #$03	                ldx #$03
4125	.d509						LD509:
4126	.d509		7e 40 88	ror $8840,x	                ror L8840,x
4127	.d50c		ca		dex		                dex
4128	.d50d		10 fa		bpl $d509	                bpl LD509
4129	.d50f		88		dey		                dey
4130	.d510		10 e0		bpl $d4f2	                bpl LD4F2
4131	.d512		60		rts		                rts

4133	.d513						LD513:
4134	.d513		a2 02		ldx #$02	                ldx #$02
4135	.d515						LD515:
4136	.d515		9e 3c 88	stz $883c,x	                stz L883C,x
4137	.d518		74 db		stz $db,x	                stz $DB,x
4138	.d51a		ca		dex		                dex
4139	.d51b		10 f8		bpl $d515	                bpl LD515
4140	.d51d		a0 03		ldy #$03	                ldy #$03
4141	.d51f						LD51F:
4142	.d51f		b9 40 88	lda $8840,y	                lda L8840,y
4143	.d522		85 da		sta $da		                sta $DA
4144	.d524		5a		phy		                phy
4145	.d525		a0 03		ldy #$03	                ldy #$03
4146	.d527						LD527:
4147	.d527		5a		phy		                phy
4148	.d528		38		sec		                sec
4149	.d529		2e 3c 88	rol $883c	                rol L883C
4150	.d52c		2e 3d 88	rol $883d	                rol L883D
4151	.d52f		2e 3e 88	rol $883e	                rol L883E
4152	.d532		a2 01		ldx #$01	                ldx #$01
4153	.d534		a5 db		lda $db		                lda $DB
4154	.d536						LD536:
4155	.d536		06 da		asl $da		                asl $DA
4156	.d538		2a		rol a		                rol a
4157	.d539		26 dc		rol $dc		                rol $DC
4158	.d53b		26 dd		rol $dd		                rol $DD
4159	.d53d		ca		dex		                dex
4160	.d53e		10 f6		bpl $d536	                bpl LD536
4161	.d540		85 db		sta $db		                sta $DB
4162	.d542		38		sec		                sec
4163	.d543		ed 3c 88	sbc $883c	                sbc L883C
4164	.d546		aa		tax		                tax
4165	.d547		a5 dc		lda $dc		                lda $DC
4166	.d549		ed 3d 88	sbc $883d	                sbc L883D
4167	.d54c		a8		tay		                tay
4168	.d54d		a5 dd		lda $dd		                lda $DD
4169	.d54f		ed 3e 88	sbc $883e	                sbc L883E
4170	.d552		90 0b		bcc $d55f	                bcc LD55F
4171	.d554		85 dd		sta $dd		                sta $DD
4172	.d556		84 dc		sty $dc		                sty $DC
4173	.d558		86 db		stx $db		                stx $DB
4174	.d55a		ee 3c 88	inc $883c	                inc L883C
4175	.d55d		80 03		bra $d562	                bra LD562

4177	.d55f						LD55F:
4178	.d55f		ce 3c 88	dec $883c	                dec L883C
4179	.d562						LD562:
4180	.d562		7a		ply		                ply
4181	.d563		88		dey		                dey
4182	.d564		10 c1		bpl $d527	                bpl LD527
4183	.d566		7a		ply		                ply
4184	.d567		88		dey		                dey
4185	.d568		10 b5		bpl $d51f	                bpl LD51F
4186	.d56a		4e 3e 88	lsr $883e	                lsr L883E
4187	.d56d		6e 3d 88	ror $883d	                ror L883D
4188	.d570		6e 3c 88	ror $883c	                ror L883C
4189	.d573		9c 3e 88	stz $883e	                stz L883E
4190	.d576		9c 3f 88	stz $883f	                stz L883F
4191	.d579		ac 3c 88	ldy $883c	                ldy L883C
4192	.d57c		ad 3d 88	lda $883d	                lda L883D
4193	.d57f		60		rts		                rts

4195							;-------------------------------------------------------------------------
4196							;
4197							; Add dimension of region to a coordinate.
4198							;
4199							; entry:
4200							;
4201							; X = VDU variable offset of coordinate
4202							;
4203							; A = VDU variable offset of minimum coordinate of region
4204							;
4205							; Y = VDU variable offset of maximum coordinate of region
4206							;
4207							; ZTEMP?0 = VDU variable offset for result
4208							;
4209							; exit:
4210							;
4211							; result variable = coordinate+(min-max)
4212							;
4213	.d580						addRegionDimensionsToVDUVariableCoordinates:
4214	.d580		20 8d d5	jsr $d58d	                jsr addRegionDimensionToVDUVariableCoordinate ;do X

4216							                ; bump offsets to do Y.
4217	.d583		c8		iny		                iny
4218	.d584		c8		iny		                iny
4219	.d585		e8		inx		                inx
4220	.d586		e8		inx		                inx
4221	.d587		1a		inc a		                inc a
4222	.d588		1a		inc a		                inc a
4223	.d589		e6 da		inc $da		                inc ZTEMP+0
4224	.d58b		e6 da		inc $da		                inc ZTEMP+0

4226							                ; TODO - not a great name. Could probably just be
4227							                ; addDifference, or something.
4228	.d58d						addRegionDimensionToVDUVariableCoordinate:
4229	.d58d		da		phx		                phx                          ;save VX
4230	.d58e		5a		phy		                phy                          ;save VY
4231	.d58f		48		pha		                pha                          ;save VA
4232	.d590		18		clc		                clc
4233	.d591		bd 00 03	lda $0300,x	                lda vduv+0,x                 ;<VX
4234	.d594		79 00 03	adc $0300,y	                adc vduv+0,y                 ;<(VX+VY)
4235	.d597		85 de		sta $de		                sta ZTEMPC+0                 ;ZTEMPC?0=<(VX+VY)
4236	.d599		bd 01 03	lda $0301,x	                lda vduv+1,x                 ;>VX
4237	.d59c		79 01 03	adc $0301,y	                adc vduv+1,y                 ;>(VX+VY)
4238	.d59f		fa		plx		                plx                          ;X=VA
4239	.d5a0		48		pha		                pha                          ;save >(VX+VY)
4240	.d5a1		a4 da		ldy $da		                ldy ZTEMP+0                  ;Y=VT
4241	.d5a3		38		sec		                sec
4242	.d5a4		a5 de		lda $de		                lda ZTEMPC+0                 ;<(VX+VY)
4243	.d5a6		fd 00 03	sbc $0300,x	                sbc vduv+0,x                 ;<(VX+VY-VA)
4244	.d5a9		99 00 03	sta $0300,y	                sta vduv+0,y                 ;<VT=<(VX+VY-VA)
4245	.d5ac		68		pla		                pla                          ;>(VX+VY)
4246	.d5ad		fd 01 03	sbc $0301,x	                sbc vduv+1,x                 ;>(VX+VY-VA)
4247	.d5b0		99 01 03	sta $0301,y	                sta vduv+1,y                 ;>VT=<(VX+VY-VA)
4248	.d5b3		8a		txa		                txa                          ;restore old A
4249	.d5b4		7a		ply		                ply                          ;restore old Y
4250	.d5b5		fa		plx		                plx                          ;restore old X
4251	.d5b6		60		rts		                rts

4253							;-------------------------------------------------------------------------
4254							;
4255							; Sort points by Y coordinate, then X.
4256							;
4257							; entry:
4258							;
4259							; X = VDU variable offset of point A (4 bytes: X;Y;)
4260							;
4261							; Y = VDU variable offset of point B (4 bytes: X;Y;)
4262							;
4263							; exit:
4264							;
4265							; X = offset of point with lesser Y (or lesser X, if same Y)
4266							;
4267							; Y = offset of point with greater Y (or greater X, if same Y)
4268							;
4269	.d5b7						sortVDUVariableCoordinates:
4270	.d5b7		38		sec		                sec
4271	.d5b8		b9 02 03	lda $0302,y	                lda vduv+2,y
4272	.d5bb		fd 02 03	sbc $0302,x	                sbc vduv+2,x
4273	.d5be		85 de		sta $de		                sta ZTEMPC
4274	.d5c0		b9 03 03	lda $0303,y	                lda vduv+3,y
4275	.d5c3		fd 03 03	sbc $0303,x	                sbc vduv+3,x
4276	.d5c6		30 09		bmi $d5d1	                bmi exchangeXAndY           ;taken if PX.y>PY.y
4277	.d5c8		05 de		ora $de		                ora ZTEMPC
4278	.d5ca		d0 09		bne $d5d5	                bne rtsD5D5                  ;taken if PX.y<PY.y

4280							;-------------------------------------------------------------------------
4281							;
4282							; Sort words by value.
4283							;
4284							; entry:
4285							;
4286							; X = VDU variable offset of word A
4287							;
4288							; Y = VDU variable offset of word B
4289							;
4290							; exit:
4291							;
4292							; X = offset of lesser value
4293							;
4294							; Y = offset of greater value
4295							;
4296	.d5cc						sortVDUVariableWords:
4297	.d5cc		20 d6 d5	jsr $d5d6	                jsr compareVDUVariableWords
4298	.d5cf		10 04		bpl $d5d5	                bpl rtsD5D5
4299	.d5d1						exchangeXAndY:
4300	.d5d1		8a		txa		                txa
4301	.d5d2		5a		phy		                phy
4302	.d5d3		fa		plx		                plx
4303	.d5d4		a8		tay		                tay
4304	.d5d5						rtsD5D5:
4305	.d5d5		60		rts		                rts

4307							;-------------------------------------------------------------------------
4308							;
4309							; Compare 2 16-bit VDU variable values.
4310							;
4311							; entry:
4312							;
4313							; X = offset of one variable
4314							;
4315							; Y = offset of the other variable
4316							;
4317							; exit:
4318							;
4319							; N=1 if X>Y
4320							;
4321	.d5d6						compareVDUVariableWords:
4322	.d5d6		b9 00 03	lda $0300,y	                lda vduv+0,y
4323	.d5d9		dd 00 03	cmp $0300,x	                cmp vduv+0,x
4324	.d5dc		b9 01 03	lda $0301,y	                lda vduv+1,y
4325	.d5df		fd 01 03	sbc $0301,x	                sbc vduv+1,x
4326	.d5e2		60		rts		                rts

4328							;-------------------------------------------------------------------------

4330	.d5e3						LD5E3:
4331	.d5e3		ee 47 88	inc $8847	                inc L8847
4332	.d5e6						LD5E6:
4333	.d5e6		ad 47 88	lda $8847	                lda L8847
4334	.d5e9		d0 0f		bne $d5fa	                bne LD5FA
4335	.d5eb		ad 32 88	lda $8832	                lda L8832
4336	.d5ee		0d 33 88	ora $8833	                ora L8833
4337	.d5f1		f0 f0		beq $d5e3	                beq LD5E3
4338	.d5f3		a2 00		ldx #$00	                ldx #$00
4339	.d5f5		20 44 d6	jsr $d644	                jsr LD644
4340	.d5f8		10 49		bpl $d643	                bpl LD643
4341	.d5fa						LD5FA:
4342	.d5fa		a2 02		ldx #$02	                ldx #$02
4343	.d5fc		20 44 d6	jsr $d644	                jsr LD644
4344	.d5ff		10 42		bpl $d643	                bpl LD643
4345	.d601		a2 00		ldx #$00	                ldx #$00
4346	.d603		20 0a d6	jsr $d60a	                jsr LD60A
4347	.d606		10 3b		bpl $d643	                bpl LD643
4348	.d608		a2 02		ldx #$02	                ldx #$02
4349	.d60a						LD60A:
4350	.d60a		bd 30 88	lda $8830,x	                lda L8830,x
4351	.d60d		d0 03		bne $d612	                bne LD612
4352	.d60f		de 31 88	dec $8831,x	                dec L8831,x
4353	.d612						LD612:
4354	.d612		de 30 88	dec $8830,x	                dec L8830,x
4355	.d615		8a		txa		                txa
4356	.d616		4a		lsr a		                lsr a
4357	.d617		1a		inc a		                inc a
4358	.d618		2c 46 88	bit $8846	                bit L8846
4359	.d61b		f0 03		beq $d620	                beq LD620
4360	.d61d		20 20 d6	jsr $d620	                jsr LD620
4361	.d620						LD620:
4362	.d620		20 36 d6	jsr $d636	                jsr LD636
4363	.d623		18		clc		                clc
4364	.d624		ad 40 88	lda $8840	                lda L8840
4365	.d627		7d 34 88	adc $8834,x	                adc L8834,x
4366	.d62a		8d 40 88	sta $8840	                sta L8840
4367	.d62d		ad 41 88	lda $8841	                lda L8841
4368	.d630		7d 35 88	adc $8835,x	                adc L8835,x
4369	.d633		8d 41 88	sta $8841	                sta L8841
4370	.d636						LD636:
4371	.d636		08		php		                php
4372	.d637		bd 34 88	lda $8834,x	                lda L8834,x
4373	.d63a		d0 03		bne $d63f	                bne LD63F
4374	.d63c		de 35 88	dec $8835,x	                dec L8835,x
4375	.d63f						LD63F:
4376	.d63f		de 34 88	dec $8834,x	                dec L8834,x
4377	.d642		28		plp		                plp
4378	.d643						LD643:
4379	.d643		60		rts		                rts

4381	.d644						LD644:
4382	.d644		fe 30 88	inc $8830,x	                inc L8830,x
4383	.d647		d0 03		bne $d64c	                bne LD64C
4384	.d649		fe 31 88	inc $8831,x	                inc L8831,x
4385	.d64c						LD64C:
4386	.d64c		8a		txa		                txa
4387	.d64d		4a		lsr a		                lsr a
4388	.d64e		1a		inc a		                inc a
4389	.d64f		2c 46 88	bit $8846	                bit L8846
4390	.d652		f0 03		beq $d657	                beq LD657
4391	.d654		20 57 d6	jsr $d657	                jsr LD657
4392	.d657						LD657:
4393	.d657		20 6d d6	jsr $d66d	                jsr LD66D
4394	.d65a		38		sec		                sec
4395	.d65b		ad 40 88	lda $8840	                lda L8840
4396	.d65e		fd 34 88	sbc $8834,x	                sbc L8834,x
4397	.d661		8d 40 88	sta $8840	                sta L8840
4398	.d664		ad 41 88	lda $8841	                lda L8841
4399	.d667		fd 35 88	sbc $8835,x	                sbc L8835,x
4400	.d66a		8d 41 88	sta $8841	                sta L8841
4401	.d66d						LD66D:
4402	.d66d		08		php		                php
4403	.d66e		fe 34 88	inc $8834,x	                inc L8834,x
4404	.d671		d0 03		bne $d676	                bne LD676
4405	.d673		fe 35 88	inc $8835,x	                inc L8835,x
4406	.d676						LD676:
4407	.d676		28		plp		                plp
4408	.d677		60		rts		                rts

4410	.d678						LD678:
4411	.d678		48		pha		                pha
4412	.d679		38		sec		                sec
4413	.d67a		b9 00 03	lda $0300,y	                lda $0300,y
4414	.d67d		fd 00 03	sbc $0300,x	                sbc $0300,x
4415	.d680		48		pha		                pha
4416	.d681		b9 01 03	lda $0301,y	                lda $0301,y
4417	.d684		fd 01 03	sbc $0301,x	                sbc $0301,x
4418	.d687		7a		ply		                ply
4419	.d688		c9 80		cmp #$80	                cmp #$80
4420	.d68a		90 03		bcc $d68f	                bcc LD68F
4421	.d68c		20 2e c9	jsr $c92e	                jsr negateAY
4422	.d68f						LD68F:
4423	.d68f		fa		plx		                plx
4424	.d690		9d 01 03	sta $0301,x	                sta $0301,x
4425	.d693		98		tya		                tya
4426	.d694		9d 00 03	sta $0300,x	                sta $0300,x
4427	.d697		60		rts		                rts

4429	.d698						LD698:
4430	.d698		a2 37		ldx #$37	                ldx #$37
4431	.d69a		20 23 d7	jsr $d723	                jsr LD723
4432	.d69d						LD69D:
4433	.d69d		3c 0a 03	bit $030a,x	                bit $030A,x
4434	.d6a0		70 10		bvs $d6b2	                bvs LD6B2
4435	.d6a2		60		rts		                rts

4437	.d6a3						LD6A3:
4438	.d6a3		a2 2c		ldx #$2c	                ldx #$2C
4439	.d6a5		20 23 d7	jsr $d723	                jsr LD723
4440	.d6a8						LD6A8:
4441	.d6a8		3c 0a 03	bit $030a,x	                bit $030A,x
4442	.d6ab		50 05		bvc $d6b2	                bvc LD6B2
4443	.d6ad		60		rts		                rts

4445	.d6ae						LD6AE:
4446	.d6ae		fa		plx		                plx
4447	.d6af		20 26 d7	jsr $d726	                jsr LD726
4448	.d6b2						LD6B2:
4449	.d6b2		bd 09 03	lda $0309,x	                lda $0309,x
4450	.d6b5		30 10		bmi $d6c7	                bmi LD6C7
4451	.d6b7		a0 03		ldy #$03	                ldy #$03
4452	.d6b9		da		phx		                phx
4453	.d6ba						LD6BA:
4454	.d6ba		bd 00 03	lda $0300,x	                lda $0300,x
4455	.d6bd		dd 1e 88	cmp $881e,x	                cmp L881E,x
4456	.d6c0		d0 ec		bne $d6ae	                bne LD6AE
4457	.d6c2		e8		inx		                inx
4458	.d6c3		88		dey		                dey
4459	.d6c4		10 f4		bpl $d6ba	                bpl LD6BA
4460	.d6c6		fa		plx		                plx
4461	.d6c7						LD6C7:
4462	.d6c7		60		rts		                rts

4464	.d6c8						LD6C8:
4465	.d6c8		20 fd d6	jsr $d6fd	                jsr LD6FD
4466	.d6cb		bd 0a 03	lda $030a,x	                lda $030A,x
4467	.d6ce		0a		asl a		                asl a
4468	.d6cf		0a		asl a		                asl a
4469	.d6d0		bd 0a 03	lda $030a,x	                lda $030A,x
4470	.d6d3		6a		ror a		                ror a
4471	.d6d4		85 da		sta $da		                sta $DA
4472	.d6d6		18		clc		                clc
4473	.d6d7		10 0f		bpl $d6e8	                bpl LD6E8
4474	.d6d9		bd 02 03	lda $0302,x	                lda $0302,x
4475	.d6dc		ed 04 03	sbc $0304	                sbc $0304
4476	.d6df		a8		tay		                tay
4477	.d6e0		bd 03 03	lda $0303,x	                lda $0303,x
4478	.d6e3		ed 05 03	sbc $0305	                sbc $0305
4479	.d6e6		80 0d		bra $d6f5	                bra LD6F5

4481	.d6e8						LD6E8:
4482	.d6e8		ad 00 03	lda $0300	                lda $0300
4483	.d6eb		fd 02 03	sbc $0302,x	                sbc $0302,x
4484	.d6ee		a8		tay		                tay
4485	.d6ef		ad 01 03	lda $0301	                lda $0301
4486	.d6f2		fd 03 03	sbc $0303,x	                sbc $0303,x
4487	.d6f5						LD6F5:
4488	.d6f5		20 a4 d7	jsr $d7a4	                jsr LD7A4
4489	.d6f8		20 fd d6	jsr $d6fd	                jsr LD6FD
4490	.d6fb		80 58		bra $d755	                bra LD755

4492	.d6fd						LD6FD:
4493	.d6fd		8a		txa		                txa
4494	.d6fe		1a		inc a		                inc a
4495	.d6ff		48		pha		                pha
4496	.d700		1a		inc a		                inc a
4497	.d701		a8		tay		                tay
4498	.d702		20 b2 e2	jsr $e2b2	                jsr exchangeTwoVDUBytes
4499	.d705		e8		inx		                inx
4500	.d706		e8		inx		                inx
4501	.d707		c8		iny		                iny
4502	.d708		c8		iny		                iny
4503	.d709		20 b2 e2	jsr $e2b2	                jsr exchangeTwoVDUBytes
4504	.d70c		fa		plx		                plx
4505	.d70d		20 11 d7	jsr $d711	                jsr LD711
4506	.d710		ca		dex		                dex
4507	.d711						LD711:
4508	.d711		bd 08 03	lda $0308,x	                lda $0308,x
4509	.d714		49 ff		eor #$ff	                eor #$FF
4510	.d716		9d 08 03	sta $0308,x	                sta $0308,x
4511	.d719		60		rts		                rts

4513	.d71a						LD71A:
4514	.d71a		20 26 d7	jsr $d726	                jsr LD726
4515	.d71d						LD71D:
4516	.d71d		bd 09 03	lda $0309,x	                lda $0309,x
4517	.d720		10 f8		bpl $d71a	                bpl LD71A
4518	.d722		60		rts		                rts

4520	.d723						LD723:
4521	.d723		20 1d d7	jsr $d71d	                jsr LD71D
4522	.d726						LD726:
4523	.d726		bd 09 03	lda $0309,x	                lda $0309,x
4524	.d729		10 2a		bpl $d755	                bpl LD755
4525	.d72b						LD72B:
4526	.d72b		18		clc		                clc
4527	.d72c		bd 08 03	lda $0308,x	                lda $0308,x
4528	.d72f		7d 04 03	adc $0304,x	                adc $0304,x
4529	.d732		9d 08 03	sta $0308,x	                sta $0308,x
4530	.d735		bd 09 03	lda $0309,x	                lda $0309,x
4531	.d738		7d 05 03	adc $0305,x	                adc $0305,x
4532	.d73b		9d 09 03	sta $0309,x	                sta $0309,x
4533	.d73e		30 03		bmi $d743	                bmi LD743
4534	.d740		20 55 d7	jsr $d755	                jsr LD755
4535	.d743						LD743:
4536	.d743		da		phx		                phx
4537	.d744		e8		inx		                inx
4538	.d745		e8		inx		                inx
4539	.d746		3c 08 03	bit $0308,x	                bit $0308,x
4540	.d749		30 23		bmi $d76e	                bmi LD76E
4541	.d74b						LD74B:
4542	.d74b		fe 00 03	inc $0300,x	                inc $0300,x
4543	.d74e		d0 03		bne $d753	                bne LD753
4544	.d750		fe 01 03	inc $0301,x	                inc $0301,x
4545	.d753						LD753:
4546	.d753		fa		plx		                plx
4547	.d754		60		rts		                rts

4549	.d755						LD755:
4550	.d755		38		sec		                sec
4551	.d756		bd 08 03	lda $0308,x	                lda $0308,x
4552	.d759		fd 06 03	sbc $0306,x	                sbc $0306,x
4553	.d75c		9d 08 03	sta $0308,x	                sta $0308,x
4554	.d75f		bd 09 03	lda $0309,x	                lda $0309,x
4555	.d762		fd 07 03	sbc $0307,x	                sbc $0307,x
4556	.d765		9d 09 03	sta $0309,x	                sta $0309,x
4557	.d768		da		phx		                phx
4558	.d769		3c 0a 03	bit $030a,x	                bit $030A,x
4559	.d76c		50 dd		bvc $d74b	                bvc LD74B
4560	.d76e						LD76E:
4561	.d76e		bd 00 03	lda $0300,x	                lda $0300,x
4562	.d771		d0 03		bne $d776	                bne LD776
4563	.d773		de 01 03	dec $0301,x	                dec $0301,x
4564	.d776						LD776:
4565	.d776		de 00 03	dec $0300,x	                dec $0300,x
4566	.d779		fa		plx		                plx
4567	.d77a		60		rts		                rts

4569	.d77b						LD77B:
4570	.d77b		18		clc		                clc
4571	.d77c		bd 0a 03	lda $030a,x	                lda $030A,x
4572	.d77f		85 da		sta $da		                sta $DA
4573	.d781		10 0f		bpl $d792	                bpl LD792
4574	.d783		bd 02 03	lda $0302,x	                lda $0302,x
4575	.d786		ed 06 03	sbc $0306	                sbc $0306
4576	.d789		a8		tay		                tay
4577	.d78a		bd 03 03	lda $0303,x	                lda $0303,x
4578	.d78d		ed 07 03	sbc $0307	                sbc $0307
4579	.d790		80 0d		bra $d79f	                bra LD79F

4581	.d792						LD792:
4582	.d792		ad 02 03	lda $0302	                lda $0302
4583	.d795		fd 02 03	sbc $0302,x	                sbc $0302,x
4584	.d798		a8		tay		                tay
4585	.d799		ad 03 03	lda $0303	                lda $0303
4586	.d79c		fd 03 03	sbc $0303,x	                sbc $0303,x
4587	.d79f						LD79F:
4588	.d79f		20 a4 d7	jsr $d7a4	                jsr LD7A4
4589	.d7a2		80 87		bra $d72b	                bra LD72B

4591	.d7a4						LD7A4:
4592	.d7a4		84 de		sty $de		                sty $DE
4593	.d7a6		85 df		sta $df		                sta $DF
4594	.d7a8		bd 02 03	lda $0302,x	                lda $0302,x
4595	.d7ab		bc 03 03	ldy $0303,x	                ldy $0303,x
4596	.d7ae		06 da		asl $da		                asl $DA
4597	.d7b0		b0 0a		bcs $d7bc	                bcs LD7BC
4598	.d7b2		65 de		adc $de		                adc $DE
4599	.d7b4		9d 02 03	sta $0302,x	                sta $0302,x
4600	.d7b7		98		tya		                tya
4601	.d7b8		65 df		adc $df		                adc $DF
4602	.d7ba		80 08		bra $d7c4	                bra LD7C4

4604	.d7bc						LD7BC:
4605	.d7bc		e5 de		sbc $de		                sbc $DE
4606	.d7be		9d 02 03	sta $0302,x	                sta $0302,x
4607	.d7c1		98		tya		                tya
4608	.d7c2		e5 df		sbc $df		                sbc $DF
4609	.d7c4						LD7C4:
4610	.d7c4		9d 03 03	sta $0303,x	                sta $0303,x
4611	.d7c7		a9 00		lda #$00	                lda #$00
4612	.d7c9		3c 09 03	bit $0309,x	                bit $0309,x
4613	.d7cc		10 01		bpl $d7cf	                bpl LD7CF
4614	.d7ce		3a		dec a		                dec a
4615	.d7cf						LD7CF:
4616	.d7cf		85 dc		sta $dc		                sta $DC
4617	.d7d1		4a		lsr a		                lsr a
4618	.d7d2		85 dd		sta $dd		                sta $DD
4619	.d7d4		a0 10		ldy #$10	                ldy #$10
4620	.d7d6						LD7D6:
4621	.d7d6		a5 dd		lda $dd		                lda $DD
4622	.d7d8		0a		asl a		                asl a
4623	.d7d9		3e 08 03	rol $0308,x	                rol $0308,x
4624	.d7dc		3e 09 03	rol $0309,x	                rol $0309,x
4625	.d7df		26 dc		rol $dc		                rol $DC
4626	.d7e1		26 dd		rol $dd		                rol $DD
4627	.d7e3		06 de		asl $de		                asl $DE
4628	.d7e5		26 df		rol $df		                rol $DF
4629	.d7e7		90 19		bcc $d802	                bcc LD802
4630	.d7e9		18		clc		                clc
4631	.d7ea		a5 dc		lda $dc		                lda $DC
4632	.d7ec		7d 04 03	adc $0304,x	                adc $0304,x
4633	.d7ef		85 dc		sta $dc		                sta $DC
4634	.d7f1		a5 dd		lda $dd		                lda $DD
4635	.d7f3		7d 05 03	adc $0305,x	                adc $0305,x
4636	.d7f6		85 dd		sta $dd		                sta $DD
4637	.d7f8		90 08		bcc $d802	                bcc LD802
4638	.d7fa		fe 08 03	inc $0308,x	                inc $0308,x
4639	.d7fd		d0 03		bne $d802	                bne LD802
4640	.d7ff		fe 09 03	inc $0309,x	                inc $0309,x
4641	.d802						LD802:
4642	.d802		88		dey		                dey
4643	.d803		d0 d1		bne $d7d6	                bne LD7D6
4644	.d805		3c 09 03	bit $0309,x	                bit $0309,x
4645	.d808		50 0b		bvc $d815	                bvc LD815
4646	.d80a		a5 dc		lda $dc		                lda $DC
4647	.d80c		9d 08 03	sta $0308,x	                sta $0308,x
4648	.d80f		a5 dd		lda $dd		                lda $DD
4649	.d811		9d 09 03	sta $0309,x	                sta $0309,x
4650	.d814		60		rts		                rts

4652	.d815						LD815:
4653	.d815		a0 10		ldy #$10	                ldy #$10
4654	.d817						LD817:
4655	.d817		26 dc		rol $dc		                rol $DC
4656	.d819		26 dd		rol $dd		                rol $DD
4657	.d81b		3e 08 03	rol $0308,x	                rol $0308,x
4658	.d81e		3e 09 03	rol $0309,x	                rol $0309,x
4659	.d821		38		sec		                sec
4660	.d822		bd 08 03	lda $0308,x	                lda $0308,x
4661	.d825		fd 06 03	sbc $0306,x	                sbc $0306,x
4662	.d828		85 de		sta $de		                sta $DE
4663	.d82a		bd 09 03	lda $0309,x	                lda $0309,x
4664	.d82d		fd 07 03	sbc $0307,x	                sbc $0307,x
4665	.d830		90 08		bcc $d83a	                bcc LD83A
4666	.d832		9d 09 03	sta $0309,x	                sta $0309,x
4667	.d835		a5 de		lda $de		                lda $DE
4668	.d837		9d 08 03	sta $0308,x	                sta $0308,x
4669	.d83a						LD83A:
4670	.d83a		88		dey		                dey
4671	.d83b		d0 da		bne $d817	                bne LD817
4672	.d83d		26 dc		rol $dc		                rol $DC
4673	.d83f		26 dd		rol $dd		                rol $DD
4674	.d841		38		sec		                sec
4675	.d842		bd 08 03	lda $0308,x	                lda $0308,x
4676	.d845		fd 06 03	sbc $0306,x	                sbc $0306,x
4677	.d848		9d 08 03	sta $0308,x	                sta $0308,x
4678	.d84b		bd 09 03	lda $0309,x	                lda $0309,x
4679	.d84e		fd 07 03	sbc $0307,x	                sbc $0307,x
4680	.d851		9d 09 03	sta $0309,x	                sta $0309,x
4681	.d854		bd 00 03	lda $0300,x	                lda $0300,x
4682	.d857		bc 01 03	ldy $0301,x	                ldy $0301,x
4683	.d85a		06 da		asl $da		                asl $DA
4684	.d85c		b0 0b		bcs $d869	                bcs LD869
4685	.d85e		38		sec		                sec
4686	.d85f		65 dc		adc $dc		                adc $DC
4687	.d861		9d 00 03	sta $0300,x	                sta $0300,x
4688	.d864		98		tya		                tya
4689	.d865		65 dd		adc $dd		                adc $DD
4690	.d867		80 09		bra $d872	                bra LD872

4692	.d869						LD869:
4693	.d869		18		clc		                clc
4694	.d86a		e5 dc		sbc $dc		                sbc $DC
4695	.d86c		9d 00 03	sta $0300,x	                sta $0300,x
4696	.d86f		98		tya		                tya
4697	.d870		e5 dd		sbc $dd		                sbc $DD
4698	.d872						LD872:
4699	.d872		9d 01 03	sta $0301,x	                sta $0301,x
4700	.d875						LD875:
4701	.d875		60		rts		                rts

4703	.d876						LD876:
4704	.d876		0e 32 03	asl $0332	                asl $0332
4705	.d879		a0 2c		ldy #$2c	                ldy #$2C
4706	.d87b		20 16 c9	jsr $c916	                jsr copyLastFourVDUQueueBytes
4707	.d87e		06 db		asl $db		                asl $DB
4708	.d880		90 0d		bcc $d88f	                bcc LD88F
4709	.d882		20 26 da	jsr $da26	                jsr LDA26
4710	.d885		f0 ee		beq $d875	                beq LD875
4711	.d887		a2 00		ldx #$00	                ldx #$00
4712	.d889		ad 32 03	lda $0332	                lda $0332
4713	.d88c		20 0f da	jsr $da0f	                jsr LDA0F
4714	.d88f						LD88F:
4715	.d88f		24 db		bit $db		                bit $DB
4716	.d891		50 0f		bvc $d8a2	                bvc LD8A2
4717	.d893		20 26 da	jsr $da26	                jsr LDA26
4718	.d896		f0 dd		beq $d875	                beq LD875
4719	.d898		a2 04		ldx #$04	                ldx #$04
4720	.d89a		ad 32 03	lda $0332	                lda $0332
4721	.d89d		49 80		eor #$80	                eor #$80
4722	.d89f		20 0f da	jsr $da0f	                jsr LDA0F
4723	.d8a2						LD8A2:
4724	.d8a2		a2 28		ldx #$28	                ldx #$28
4725	.d8a4		a0 2c		ldy #$2c	                ldy #$2C
4726	.d8a6		4c e8 da	jmp $dae8	                jmp LDAE8

4728	.d8a9						LD8A9:
4729	.d8a9		0a		asl a		                asl a
4730	.d8aa		0a		asl a		                asl a
4731	.d8ab		85 db		sta $db		                sta $DB
4732	.d8ad		29 c0		and #$c0	                and #$C0
4733	.d8af		49 40		eor #$40	                eor #$40
4734	.d8b1		d0 06		bne $d8b9	                bne LD8B9
4735	.d8b3		ad 67 03	lda $0367	                lda $0367
4736	.d8b6		8d 68 03	sta $0368	                sta $0368
4737	.d8b9						LD8B9:
4738	.d8b9		20 a6 d1	jsr $d1a6	                jsr LD1A6
4739	.d8bc		85 dc		sta $dc		                sta $DC
4740	.d8be		f0 04		beq $d8c4	                beq LD8C4
4741	.d8c0		a9 80		lda #$80	                lda #$80
4742	.d8c2		14 db		trb $db		                trb $DB
4743	.d8c4						LD8C4:
4744	.d8c4		a2 20		ldx #$20	                ldx #$20
4745	.d8c6		20 a8 d1	jsr $d1a8	                jsr windEntryPoint
4746	.d8c9		85 e0		sta $e0		                sta $E0
4747	.d8cb		f0 0a		beq $d8d7	                beq LD8D7
4748	.d8cd		aa		tax		                tax
4749	.d8ce		a9 20		lda #$20	                lda #$20
4750	.d8d0		14 db		trb $db		                trb $DB
4751	.d8d2		8a		txa		                txa
4752	.d8d3		24 dc		bit $dc		                bit $DC
4753	.d8d5						LD8D5:
4754	.d8d5		d0 9e		bne $d875	                bne LD875
4755	.d8d7						LD8D7:
4756	.d8d7		a0 24		ldy #$24	                ldy #$24
4757	.d8d9		a9 20		lda #$20	                lda #$20
4758	.d8db		a2 28		ldx #$28	                ldx #$28
4759	.d8dd		20 09 9b	jsr $9b09	                jsr terminal.L9B09
4760	.d8e0		24 db		bit $db		                bit $DB
4761	.d8e2		70 08		bvs $d8ec	                bvs LD8EC
4762	.d8e4		ad 2e 03	lda $032e	                lda $032E
4763	.d8e7		0d 2f 03	ora $032f	                ora $032F
4764	.d8ea		f0 8a		beq $d876	                beq LD876
4765	.d8ec						LD8EC:
4766	.d8ec		a5 dc		lda $dc		                lda $DC
4767	.d8ee		89 0c		bit #$0c	                bit #$0C
4768	.d8f0		f0 0e		beq $d900	                beq LD900
4769	.d8f2		a2 28		ldx #$28	                ldx #$28
4770	.d8f4		20 7b d7	jsr $d77b	                jsr LD77B
4771	.d8f7		a2 28		ldx #$28	                ldx #$28
4772	.d8f9		20 a8 d1	jsr $d1a8	                jsr windEntryPoint
4773	.d8fc		24 e0		bit $e0		                bit $E0
4774	.d8fe		d0 d5		bne $d8d5	                bne LD8D5
4775	.d900						LD900:
4776	.d900		89 03		bit #$03	                bit #$03
4777	.d902		f0 0a		beq $d90e	                beq LD90E
4778	.d904		a2 28		ldx #$28	                ldx #$28
4779	.d906		20 c8 d6	jsr $d6c8	                jsr LD6C8
4780	.d909		a2 28		ldx #$28	                ldx #$28
4781	.d90b		20 a8 d1	jsr $d1a8	                jsr windEntryPoint
4782	.d90e						LD90E:
4783	.d90e		a8		tay		                tay
4784	.d90f		d0 c4		bne $d8d5	                bne LD8D5
4785	.d911		a0 20		ldy #$20	                ldy #$20
4786	.d913		a2 22		ldx #$22	                ldx #$22
4787	.d915		a5 e0		lda $e0		                lda $E0
4788	.d917		f0 0f		beq $d928	                beq LD928
4789	.d919		a0 04		ldy #$04	                ldy #$04
4790	.d91b		a2 06		ldx #$06	                ldx #$06
4791	.d91d		2c 32 03	bit $0332	                bit $0332
4792	.d920		10 02		bpl $d924	                bpl LD924
4793	.d922		a2 02		ldx #$02	                ldx #$02
4794	.d924						LD924:
4795	.d924		50 02		bvc $d928	                bvc LD928
4796	.d926		a0 00		ldy #$00	                ldy #$00
4797	.d928						LD928:
4798	.d928		18		clc		                clc
4799	.d929		bd 00 03	lda $0300,x	                lda $0300,x
4800	.d92c		ed 2a 03	sbc $032a	                sbc $032A
4801	.d92f		90 03		bcc $d934	                bcc LD934
4802	.d931		1a		inc a		                inc a
4803	.d932		49 ff		eor #$ff	                eor #$FF
4804	.d934						LD934:
4805	.d934		85 dc		sta $dc		                sta $DC
4806	.d936		18		clc		                clc
4807	.d937		b9 00 03	lda $0300,y	                lda $0300,y
4808	.d93a		ed 28 03	sbc $0328	                sbc $0328
4809	.d93d		aa		tax		                tax
4810	.d93e		b9 01 03	lda $0301,y	                lda $0301,y
4811	.d941		ed 29 03	sbc $0329	                sbc $0329
4812	.d944		30 0c		bmi $d952	                bmi LD952
4813	.d946		e8		inx		                inx
4814	.d947		d0 01		bne $d94a	                bne LD94A
4815	.d949		1a		inc a		                inc a
4816	.d94a						LD94A:
4817	.d94a		49 ff		eor #$ff	                eor #$FF
4818	.d94c		a8		tay		                tay
4819	.d94d		8a		txa		                txa
4820	.d94e		49 ff		eor #$ff	                eor #$FF
4821	.d950		aa		tax		                tax
4822	.d951		98		tya		                tya
4823	.d952						LD952:
4824	.d952		85 dd		sta $dd		                sta $DD
4825	.d954		86 e0		stx $e0		                stx $E0
4826	.d956		a2 28		ldx #$28	                ldx #$28
4827	.d958		20 41 df	jsr $df41	                jsr LDF41
4828	.d95b		06 db		asl $db		                asl $DB
4829	.d95d		b0 2a		bcs $d989	                bcs LD989
4830	.d95f						LD95F:
4831	.d95f		24 db		bit $db		                bit $DB
4832	.d961		50 0b		bvc $d96e	                bvc LD96E
4833	.d963		a5 e0		lda $e0		                lda $E0
4834	.d965		25 dc		and $dc		                and $DC
4835	.d967		25 dd		and $dd		                and $DD
4836	.d969		1a		inc a		                inc a
4837	.d96a		f0 34		beq $d9a0	                beq LD9A0
4838	.d96c		24 db		bit $db		                bit $DB
4839	.d96e						LD96E:
4840	.d96e		10 09		bpl $d979	                bpl LD979
4841	.d970		ad 68 03	lda $0368	                lda $0368
4842	.d973		0a		asl a		                asl a
4843	.d974		2e 68 03	rol $0368	                rol $0368
4844	.d977		90 10		bcc $d989	                bcc LD989
4845	.d979						LD979:
4846	.d979		a5 d1		lda $d1		                lda ZMASK
4847	.d97b		25 d4		and $d4		                and ZGORA
4848	.d97d		11 d6		ora ($d6),y	                ora (ZMEMG),y
4849	.d97f		85 da		sta $da		                sta $DA
4850	.d981		a5 d1		lda $d1		                lda ZMASK
4851	.d983		25 d5		and $d5		                and ZGEOR
4852	.d985		45 da		eor $da		                eor $DA
4853	.d987		91 d6		sta ($d6),y	                sta (ZMEMG),y
4854	.d989						LD989:
4855	.d989		ad 31 03	lda $0331	                lda $0331
4856	.d98c		10 4e		bpl $d9dc	                bpl LD9DC
4857	.d98e		e6 dc		inc $dc		                inc $DC
4858	.d990		f0 0e		beq $d9a0	                beq LD9A0
4859	.d992		2c 32 03	bit $0332	                bit $0332
4860	.d995		30 0a		bmi $d9a1	                bmi LD9A1
4861	.d997		88		dey		                dey
4862	.d998		ca		dex		                dex
4863	.d999		10 24		bpl $d9bf	                bpl LD9BF
4864	.d99b		20 4c da	jsr $da4c	                jsr LDA4C
4865	.d99e		80 1f		bra $d9bf	                bra LD9BF

4867	.d9a0						LD9A0:
4868	.d9a0		60		rts		                rts

4870	.d9a1						LD9A1:
4871	.d9a1		c8		iny		                iny
4872	.d9a2		e8		inx		                inx
4873	.d9a3		e0 08		cpx #$08	                cpx #$08
4874	.d9a5		d0 18		bne $d9bf	                bne LD9BF
4875	.d9a7		38		sec		                sec
4876	.d9a8		98		tya		                tya
4877	.d9a9		e9 08		sbc #$08	                sbc #$08
4878	.d9ab		18		clc		                clc
4879	.d9ac		6d 52 03	adc $0352	                adc $0352
4880	.d9af		a8		tay		                tay
4881	.d9b0		a5 d7		lda $d7		                lda ZMEMG+1
4882	.d9b2		6d 53 03	adc $0353	                adc $0353
4883	.d9b5		10 04		bpl $d9bb	                bpl LD9BB
4884	.d9b7		38		sec		                sec
4885	.d9b8		ed 54 03	sbc $0354	                sbc $0354
4886	.d9bb						LD9BB:
4887	.d9bb		85 d7		sta $d7		                sta ZMEMG+1
4888	.d9bd		a2 00		ldx #$00	                ldx #$00
4889	.d9bf						LD9BF:
4890	.d9bf		ad 69 03	lda $0369	                lda $0369
4891	.d9c2		f0 03		beq $d9c7	                beq LD9C7
4892	.d9c4		20 7c da	jsr $da7c	                jsr setupColourMasks
4893	.d9c7						LD9C7:
4894	.d9c7		18		clc		                clc
4895	.d9c8		ad 30 03	lda $0330	                lda $0330
4896	.d9cb		6d 2c 03	adc $032c	                adc $032C
4897	.d9ce		8d 30 03	sta $0330	                sta $0330
4898	.d9d1		ad 31 03	lda $0331	                lda $0331
4899	.d9d4		6d 2d 03	adc $032d	                adc $032D
4900	.d9d7		8d 31 03	sta $0331	                sta $0331
4901	.d9da		30 83		bmi $d95f	                bmi LD95F
4902	.d9dc						LD9DC:
4903	.d9dc		e6 e0		inc $e0		                inc $E0
4904	.d9de		d0 04		bne $d9e4	                bne LD9E4
4905	.d9e0		e6 dd		inc $dd		                inc $DD
4906	.d9e2		f0 bc		beq $d9a0	                beq LD9A0
4907	.d9e4						LD9E4:
4908	.d9e4		2c 32 03	bit $0332	                bit $0332
4909	.d9e7		70 09		bvs $d9f2	                bvs LD9F2
4910	.d9e9		46 d1		lsr $d1		                lsr ZMASK
4911	.d9eb		90 0c		bcc $d9f9	                bcc LD9F9
4912	.d9ed		20 67 da	jsr $da67	                jsr nextColumnAndResetMask
4913	.d9f0		80 07		bra $d9f9	                bra LD9F9

4915	.d9f2						LD9F2:
4916	.d9f2		06 d1		asl $d1		                asl ZMASK
4917	.d9f4		90 03		bcc $d9f9	                bcc LD9F9
4918	.d9f6		20 34 da	jsr $da34	                jsr previousColumnAndResetMask
4919	.d9f9						LD9F9:
4920	.d9f9		38		sec		                sec
4921	.d9fa		ad 30 03	lda $0330	                lda $0330
4922	.d9fd		ed 2e 03	sbc $032e	                sbc $032E
4923	.da00		8d 30 03	sta $0330	                sta $0330
4924	.da03		ad 31 03	lda $0331	                lda $0331
4925	.da06		ed 2f 03	sbc $032f	                sbc $032F
4926	.da09		8d 31 03	sta $0331	                sta $0331
4927	.da0c		4c 5f d9	jmp $d95f	                jmp LD95F

4929	.da0f						LDA0F:
4930	.da0f		30 09		bmi $da1a	                bmi LDA1A
4931	.da11		fe 28 03	inc $0328,x	                inc $0328,x
4932	.da14		d0 0f		bne $da25	                bne LDA25
4933	.da16		fe 29 03	inc $0329,x	                inc $0329,x
4934	.da19		60		rts		                rts

4936	.da1a						LDA1A:
4937	.da1a		bd 28 03	lda $0328,x	                lda $0328,x
4938	.da1d		d0 03		bne $da22	                bne LDA22
4939	.da1f		de 29 03	dec $0329,x	                dec $0329,x
4940	.da22						LDA22:
4941	.da22		de 28 03	dec $0328,x	                dec $0328,x
4942	.da25						LDA25:
4943	.da25		60		rts		                rts

4945	.da26						LDA26:
4946	.da26		a0 04		ldy #$04	                ldy #$04
4947	.da28						LDA28:
4948	.da28		b9 27 03	lda $0327,y	                lda $0327,y
4949	.da2b		d9 2b 03	cmp $032b,y	                cmp $032B,y
4950	.da2e		d0 03		bne $da33	                bne LDA33
4951	.da30		88		dey		                dey
4952	.da31		d0 f5		bne $da28	                bne LDA28
4953	.da33						LDA33:
4954	.da33		60		rts		                rts

4956							;-------------------------------------------------------------------------

4958	.da34						previousColumnAndResetMask:
4959	.da34		ad 63 03	lda $0363	                lda vduv.colourMaskRight
4960	.da37		85 d1		sta $d1		                sta ZMASK
4961	.da39		98		tya		                tya
4962	.da3a		e9 08		sbc #$08	                sbc #$08
4963	.da3c		a8		tay		                tay
4964	.da3d		b0 0c		bcs $da4b	                bcs rtsDA4B
4965	.da3f		a5 d7		lda $d7		                lda ZMEMG+1
4966	.da41		3a		dec a		                dec a
4967	.da42		cd 4e 03	cmp $034e	                cmp vduv.startScreenAddressHighByte
4968	.da45		b0 02		bcs $da49	                bcs +
4969	.da47		a9 7f		lda #$7f	                lda #$7F
4970	.da49						+
4971	.da49		85 d7		sta $d7		                sta ZMEMG+1
4972	.da4b						rtsDA4B:
4973	.da4b		60		rts		                rts

4975							;-------------------------------------------------------------------------

4977	.da4c						LDA4C:
4978	.da4c		18		clc		                clc
4979	.da4d		98		tya		                tya
4980	.da4e		69 08		adc #$08	                adc #$08
4981	.da50		38		sec		                sec
4982	.da51		ed 52 03	sbc $0352	                sbc $0352
4983	.da54		a8		tay		                tay
4984	.da55		a5 d7		lda $d7		                lda ZMEMG+1
4985	.da57		ed 53 03	sbc $0353	                sbc $0353
4986	.da5a		cd 4e 03	cmp $034e	                cmp $034E
4987	.da5d		b0 03		bcs $da62	                bcs LDA62
4988	.da5f		6d 54 03	adc $0354	                adc $0354
4989	.da62						LDA62:
4990	.da62		85 d7		sta $d7		                sta ZMEMG+1
4991	.da64		a2 07		ldx #$07	                ldx #$07
4992	.da66		60		rts		                rts

4994							;-------------------------------------------------------------------------
4995							;
4996	.da67						nextColumnAndResetMask:
4997	.da67		ad 62 03	lda $0362	                lda vduv.colourMaskLeft
4998	.da6a		85 d1		sta $d1		                sta ZMASK

5000							;-------------------------------------------------------------------------
5001							;
5002							; Add 8 to (ZMEMG),Y, taking into account screen wrap.
5003							;
5004							; entry:
5005							;
5006							; C=1
5007							;
5008							; (ZMEMG),Y = screen address
5009							;
5010							; exit:
5011							;
5012							; (ZMEMG),Y = new screen address
5013							;
5014	.da6c						nextColumn:
5015	.da6c		98		tya		                tya
5016	.da6d		69 07		adc #$07	                adc #$07
5017	.da6f		a8		tay		                tay
5018	.da70		90 09		bcc $da7b	                bcc +
5019	.da72		e6 d7		inc $d7		                inc ZMEMG+1
5020	.da74		10 05		bpl $da7b	                bpl +
5021	.da76		ad 4e 03	lda $034e	                lda vduv.startScreenAddressHighByte
5022	.da79		85 d7		sta $d7		                sta ZMEMG+1
5023	.da7b						+
5024	.da7b		60		rts		                rts

5026							;-------------------------------------------------------------------------
5027							;
5028							; Set up colour masks, taking into account ECF pattern.
5029							;
5030							; entry:
5031							;
5032							; X = scanline in row, 0-7
5033							;
5034	.da7c						setupColourMasks:
5035	.da7c		da		phx		                phx                          ;save scanline
5036	.da7d		8a		txa		                txa                          ;A=scanline
5037	.da7e		0d 59 03	ora $0359	                ora vduv.graphicsPlotState   ;0-7 if fg, 8-15 if bg
5038	.da81		aa		tax		                tax
5039	.da82		bd 20 88	lda $8820,x	                lda andy.fgECFPattern,x      ;get appropriate ECF byte
5040	.da85		ae 5a 03	ldx $035a	                ldx vduv.graphicsPlotMode
5041	.da88		48		pha		                pha
5042	.da89		1d 44 e1	ora $e144,x	                ora zgoraORTable,x
5043	.da8c		5d 45 e1	eor $e145,x	                eor zgoraEORTable,x
5044	.da8f		85 d4		sta $d4		                sta ZGORA
5045	.da91		68		pla		                pla
5046	.da92		1d 43 e1	ora $e143,x	                ora zgeorORTable,x
5047	.da95		5d 48 e1	eor $e148,x	                eor zgeorEORTable,x
5048	.da98		85 d5		sta $d5		                sta ZGEOR
5049	.da9a		fa		plx		                plx
5050	.da9b		60		rts		                rts

5052							;-------------------------------------------------------------------------

5054	.da9c						LDA9C:
5055	.da9c		b9 01 03	lda $0301,y	                lda $0301,y
5056	.da9f		48		pha		                pha
5057	.daa0		b9 00 03	lda $0300,y	                lda $0300,y
5058	.daa3		48		pha		                pha
5059	.daa4		2d 61 03	and $0361	                and $0361
5060	.daa7		18		clc		                clc
5061	.daa8		6d 61 03	adc $0361	                adc $0361
5062	.daab		a8		tay		                tay
5063	.daac		b9 2e e1	lda $e12e,y	                lda pixelMasks-1,y
5064	.daaf		59 20 e1	eor $e120,y	                eor LE120,y
5065	.dab2		85 dc		sta $dc		                sta $DC
5066	.dab4		bd 00 03	lda $0300,x	                lda $0300,x
5067	.dab7		2d 61 03	and $0361	                and $0361
5068	.daba		6d 61 03	adc $0361	                adc $0361
5069	.dabd		a8		tay		                tay
5070	.dabe		b9 20 e1	lda $e120,y	                lda LE120,y
5071	.dac1		85 d1		sta $d1		                sta ZMASK
5072	.dac3		38		sec		                sec
5073	.dac4		68		pla		                pla
5074	.dac5		0d 61 03	ora $0361	                ora $0361
5075	.dac8		fd 00 03	sbc $0300,x	                sbc $0300,x
5076	.dacb		a8		tay		                tay
5077	.dacc		68		pla		                pla
5078	.dacd		fd 01 03	sbc $0301,x	                sbc $0301,x
5079	.dad0		85 dd		sta $dd		                sta $DD
5080	.dad2		98		tya		                tya
5081	.dad3		ac 61 03	ldy $0361	                ldy $0361
5082	.dad6		c0 03		cpy #$03	                cpy #$03
5083	.dad8		f0 05		beq $dadf	                beq LDADF
5084	.dada		90 06		bcc $dae2	                bcc LDAE2
5085	.dadc		46 dd		lsr $dd		                lsr $DD
5086	.dade		6a		ror a		                ror a
5087	.dadf						LDADF:
5088	.dadf		46 dd		lsr $dd		                lsr $DD
5089	.dae1		6a		ror a		                ror a
5090	.dae2						LDAE2:
5091	.dae2		4a		lsr a		                lsr a
5092	.dae3						LDAE3:
5093	.dae3		60		rts		                rts

5095	.dae4						LDAE4:
5096	.dae4		a2 42		ldx #$42	                ldx #$42
5097	.dae6		a0 46		ldy #$46	                ldy #$46
5098	.dae8						LDAE8:
5099	.dae8		20 cc d5	jsr $d5cc	                jsr sortVDUVariableWords
5100	.daeb		86 de		stx $de		                stx $DE
5101	.daed		84 df		sty $df		                sty $DF
5102	.daef		a6 df		ldx $df		                ldx $DF
5103	.daf1		a0 00		ldy #$00	                ldy #$00
5104	.daf3		20 b7 d1	jsr $d1b7	                jsr getOutcodeForAxis
5105	.daf6		f0 07		beq $daff	                beq LDAFF
5106	.daf8		4a		lsr a		                lsr a
5107	.daf9		f0 e8		beq $dae3	                beq LDAE3
5108	.dafb		a2 04		ldx #$04	                ldx #$04
5109	.dafd		86 df		stx $df		                stx $DF
5110	.daff						LDAFF:
5111	.daff		a6 de		ldx $de		                ldx $DE
5112	.db01		20 a8 d1	jsr $d1a8	                jsr windEntryPoint
5113	.db04		4a		lsr a		                lsr a
5114	.db05		d0 dc		bne $dae3	                bne LDAE3
5115	.db07		bd 02 03	lda $0302,x	                lda $0302,x
5116	.db0a		90 04		bcc $db10	                bcc LDB10
5117	.db0c		a2 00		ldx #$00	                ldx #$00
5118	.db0e		86 de		stx $de		                stx $DE
5119	.db10						LDB10:
5120	.db10		20 cb de	jsr $decb	                jsr LDECB
5121	.db13		a6 de		ldx $de		                ldx $DE
5122	.db15		a4 df		ldy $df		                ldy $DF
5123	.db17		20 9c da	jsr $da9c	                jsr LDA9C
5124	.db1a		aa		tax		                tax
5125	.db1b		ac 1a 03	ldy $031a	                ldy $031A
5126	.db1e		8a		txa		                txa
5127	.db1f		f0 23		beq $db44	                beq LDB44
5128	.db21		20 51 db	jsr $db51	                jsr plbyteEntryPoint
5129	.db24		80 08		bra $db2e	                bra LDB2E

5131	.db26						LDB26:
5132	.db26		b1 d6		lda ($d6),y	                lda (ZMEMG),y
5133	.db28		05 d4		ora $d4		                ora ZGORA
5134	.db2a		45 d5		eor $d5		                eor ZGEOR
5135	.db2c		91 d6		sta ($d6),y	                sta (ZMEMG),y
5136	.db2e						LDB2E:
5137	.db2e		98		tya		                tya
5138	.db2f		18		clc		                clc
5139	.db30		69 08		adc #$08	                adc #$08
5140	.db32		a8		tay		                tay
5141	.db33		90 09		bcc $db3e	                bcc LDB3E
5142	.db35		e6 d7		inc $d7		                inc ZMEMG+1
5143	.db37		10 05		bpl $db3e	                bpl LDB3E
5144	.db39		ad 4e 03	lda $034e	                lda $034E
5145	.db3c		85 d7		sta $d7		                sta ZMEMG+1
5146	.db3e						LDB3E:
5147	.db3e		ca		dex		                dex
5148	.db3f		d0 e5		bne $db26	                bne LDB26
5149	.db41		ca		dex		                dex
5150	.db42		86 d1		stx $d1		                stx ZMASK
5151	.db44						LDB44:
5152	.db44		a5 dc		lda $dc		                lda $DC
5153	.db46		14 d1		trb $d1		                trb ZMASK
5154	.db48		80 07		bra $db51	                bra plbyteEntryPoint

5156							;-------------------------------------------------------------------------
5157							;
5158							; mem mask ora eor | result
5159							; --- ---- --- --- | ------
5160							;  0    0   0   0  |   0
5161							;  0    0   0   1  |   0
5162							;  0    0   1   0  |   0
5163							;  0    0   1   1  |   0
5164							;  0    1   0   0  |   0
5165							;  0    1   0   1  |   1
5166							;  0    1   1   0  |   1
5167							;  0    1   1   1  |   0
5168							;  1    0   0   0  |   1
5169							;  1    0   0   1  |   1
5170							;  1    0   1   0  |   1
5171							;  1    0   1   1  |   1
5172							;  1    1   0   0  |   1
5173							;  1    1   0   1  |   0
5174							;  1    1   1   0  |   1
5175							;  1    1   1   1  |   0
5176							;
5177	.db4a						plotPoint:
5178	.db4a		a2 20		ldx #$20	                ldx #VDUVariables.queueEnd-4
5179	.db4c						LDB4C:
5180	.db4c		20 c3 de	jsr $dec3	                jsr windGADDR
5181	.db4f		d0 10		bne $db61	                bne rtsDB61                  ;taken if point outside window
5182	.db51						plbyteEntryPoint:
5183	.db51		a5 d1		lda $d1		                lda ZMASK
5184	.db53		25 d4		and $d4		                and ZGORA
5185	.db55		11 d6		ora ($d6),y	                ora (ZMEMG),y
5186	.db57		85 da		sta $da		                sta ZTEMP+0
5187	.db59		a5 d5		lda $d5		                lda ZGEOR
5188	.db5b		25 d1		and $d1		                and ZMASK
5189	.db5d		45 da		eor $da		                eor ZTEMP+0
5190	.db5f						oswrscCode:
5191	.db5f		91 d6		sta ($d6),y	                sta (ZMEMG),y
5192	.db61						rtsDB61:
5193	.db61		60		rts		                rts

5195							;-------------------------------------------------------------------------

5197	.db62						LDB62:
5198	.db62		a2 2a		ldx #$2a	                ldx #VDUVariables.workspace._2A
5199	.db64		a0 32		ldy #$32	                ldy #VDUVariables.workspace._32
5200	.db66		20 0c c9	jsr $c90c	                jsr copyTwoBytesWithinVDUVariables
5201	.db69		a2 36		ldx #$36	                ldx #VDUVariables.workspace._36
5202	.db6b		a0 3e		ldy #$3e	                ldy #VDUVariables.workspace._3E
5203	.db6d		20 0c c9	jsr $c90c	                jsr copyTwoBytesWithinVDUVariables
5204	.db70		a2 2a		ldx #$2a	                ldx #$2A
5205	.db72		20 b5 d1	jsr $d1b5	                jsr getOutcodeForYAxis
5206	.db75		48		pha		                pha
5207	.db76		a2 36		ldx #$36	                ldx #$36
5208	.db78		20 b5 d1	jsr $d1b5	                jsr getOutcodeForYAxis
5209	.db7b		f0 0f		beq $db8c	                beq LDB8C
5210	.db7d		68		pla		                pla
5211	.db7e		d0 05		bne $db85	                bne LDB85
5212	.db80		ad 45 03	lda $0345	                lda $0345
5213	.db83		f0 01		beq $db86	                beq LDB86
5214	.db85						LDB85:
5215	.db85		60		rts		                rts

5217	.db86						LDB86:
5218	.db86		a2 28		ldx #$28	                ldx #$28
5219	.db88		a0 2c		ldy #$2c	                ldy #$2C
5220	.db8a		80 07		bra $db93	                bra LDB93

5222	.db8c						LDB8C:
5223	.db8c		68		pla		                pla
5224	.db8d		f0 07		beq $db96	                beq LDB96
5225	.db8f		a2 34		ldx #$34	                ldx #$34
5226	.db91		a0 38		ldy #$38	                ldy #$38
5227	.db93						LDB93:
5228	.db93		4c e8 da	jmp $dae8	                jmp LDAE8

5230	.db96						LDB96:
5231	.db96		a2 30		ldx #$30	                ldx #$30
5232	.db98		20 c8 de	jsr $dec8	                jsr gaddrEntryPoint
5233	.db9b		2c 47 03	bit $0347	                bit $0347
5234	.db9e		30 09		bmi $dba9	                bmi LDBA9
5235	.dba0		98		tya		                tya
5236	.dba1		38		sec		                sec
5237	.dba2		e9 08		sbc #$08	                sbc #$08
5238	.dba4		a8		tay		                tay
5239	.dba5		b0 02		bcs $dba9	                bcs LDBA9
5240	.dba7		c6 d7		dec $d7		                dec ZMEMG+1
5241	.dba9						LDBA9:
5242	.dba9		ad 44 03	lda $0344	                lda $0344
5243	.dbac		85 dd		sta $dd		                sta $DD
5244	.dbae						LDBAE:
5245	.dbae		b1 d6		lda ($d6),y	                lda (ZMEMG),y
5246	.dbb0		ae 42 03	ldx $0342	                ldx $0342
5247	.dbb3		f0 04		beq $dbb9	                beq LDBB9
5248	.dbb5						LDBB5:
5249	.dbb5		0a		asl a		                asl a
5250	.dbb6		ca		dex		                dex
5251	.dbb7		d0 fc		bne $dbb5	                bne LDBB5
5252	.dbb9						LDBB9:
5253	.dbb9		85 da		sta $da		                sta $DA
5254	.dbbb		38		sec		                sec
5255	.dbbc		20 6c da	jsr $da6c	                jsr nextColumn
5256	.dbbf		b1 d6		lda ($d6),y	                lda (ZMEMG),y
5257	.dbc1		ae 43 03	ldx $0343	                ldx $0343
5258	.dbc4		f0 04		beq $dbca	                beq LDBCA
5259	.dbc6						LDBC6:
5260	.dbc6		4a		lsr a		                lsr a
5261	.dbc7		ca		dex		                dex
5262	.dbc8		d0 fc		bne $dbc6	                bne LDBC6
5263	.dbca						LDBCA:
5264	.dbca		45 da		eor $da		                eor $DA
5265	.dbcc		25 e1		and $e1		                and $E1
5266	.dbce		45 da		eor $da		                eor $DA
5267	.dbd0		a6 dd		ldx $dd		                ldx $DD
5268	.dbd2		9d 30 88	sta $8830,x	                sta L8830,x
5269	.dbd5		c6 dd		dec $dd		                dec $DD
5270	.dbd7		10 d5		bpl $dbae	                bpl LDBAE
5271	.dbd9		a2 34		ldx #$34	                ldx #$34
5272	.dbdb		a0 38		ldy #$38	                ldy #$38
5273	.dbdd		20 e8 da	jsr $dae8	                jsr LDAE8
5274	.dbe0		ad 45 03	lda $0345	                lda $0345
5275	.dbe3		d0 03		bne $dbe8	                bne LDBE8
5276	.dbe5		20 86 db	jsr $db86	                jsr LDB86
5277	.dbe8						LDBE8:
5278	.dbe8		a2 3c		ldx #$3c	                ldx #$3C
5279	.dbea		20 c8 de	jsr $dec8	                jsr gaddrEntryPoint
5280	.dbed		ad 46 03	lda $0346	                lda $0346
5281	.dbf0		85 da		sta $da		                sta $DA
5282	.dbf2		ae 44 03	ldx $0344	                ldx $0344
5283	.dbf5		f0 15		beq $dc0c	                beq LDC0C
5284	.dbf7		20 10 dc	jsr $dc10	                jsr LDC10
5285	.dbfa		a9 ff		lda #$ff	                lda #$FF
5286	.dbfc		85 da		sta $da		                sta $DA
5287	.dbfe		80 05		bra $dc05	                bra LDC05

5289	.dc00						LDC00_code:
5290	.dc00		bd 30 88	lda $8830,x	                lda L8830,x
5291	.dc03		91 d6		sta ($d6),y	                sta (ZMEMG),y
5292	.dc05						LDC05:
5293	.dc05		38		sec		                sec
5294	.dc06		20 6c da	jsr $da6c	                jsr nextColumn
5295	.dc09		ca		dex		                dex
5296	.dc0a		d0 f4		bne $dc00	                bne LDC00_code
5297	.dc0c						LDC0C:
5298	.dc0c		a5 e0		lda $e0		                lda $E0
5299	.dc0e		14 da		trb $da		                trb $DA
5300	.dc10						LDC10:
5301	.dc10		bd 30 88	lda $8830,x	                lda L8830,x
5302	.dc13		51 d6		eor ($d6),y	                eor (ZMEMG),y
5303	.dc15		25 da		and $da		                and $DA
5304	.dc17		51 d6		eor ($d6),y	                eor (ZMEMG),y
5305	.dc19		91 d6		sta ($d6),y	                sta (ZMEMG),y
5306	.dc1b		60		rts		                rts

5308	.dc1c						LDC1C:
5309	.dc1c		ad 37 03	lda $0337	                lda $0337
5310	.dc1f		1a		inc a		                inc a
5311	.dc20		cd 36 03	cmp $0336	                cmp $0336
5312	.dc23		f0 22		beq $dc47	                beq LDC47
5313	.dc25		8d 37 03	sta $0337	                sta $0337
5314	.dc28		aa		tax		                tax
5315	.dc29		ad 2e 03	lda $032e	                lda $032E
5316	.dc2c		9d 00 84	sta $8400,x	                sta L8400,x
5317	.dc2f		ad 32 03	lda $0332	                lda $0332
5318	.dc32		9d 00 85	sta $8500,x	                sta L8500,x
5319	.dc35		ad 2f 03	lda $032f	                lda $032F
5320	.dc38		0a		asl a		                asl a
5321	.dc39		0a		asl a		                asl a
5322	.dc3a		0d 33 03	ora $0333	                ora $0333
5323	.dc3d		9d 00 86	sta $8600,x	                sta L8600,x
5324	.dc40		ad 30 03	lda $0330	                lda $0330
5325	.dc43		9d 00 87	sta $8700,x	                sta L8700,x
5326	.dc46						LDC46:
5327	.dc46		18		clc		                clc
5328	.dc47						LDC47:
5329	.dc47		60		rts		                rts

5331	.dc48						LDC48:
5332	.dc48		8d 2a 03	sta $032a	                sta $032A
5333	.dc4b		a2 28		ldx #$28	                ldx #$28
5334	.dc4d		20 b0 dc	jsr $dcb0	                jsr LDCB0
5335	.dc50		d0 0a		bne $dc5c	                bne LDC5C
5336	.dc52						LDC52:
5337	.dc52		20 1c dc	jsr $dc1c	                jsr LDC1C
5338	.dc55		b0 f0		bcs $dc47	                bcs LDC47
5339	.dc57		20 57 9d	jsr $9d57	                jsr terminal.L9D57
5340	.dc5a		b0 ea		bcs $dc46	                bcs LDC46
5341	.dc5c						LDC5C:
5342	.dc5c		20 c1 dc	jsr $dcc1	                jsr LDCC1
5343	.dc5f		20 57 9d	jsr $9d57	                jsr terminal.L9D57
5344	.dc62		b0 e2		bcs $dc46	                bcs LDC46
5345	.dc64		20 d7 dc	jsr $dcd7	                jsr LDCD7
5346	.dc67		20 b8 dc	jsr $dcb8	                jsr LDCB8
5347	.dc6a		80 e6		bra $dc52	                bra LDC52

5349							;-------------------------------------------------------------------------
5350							;
5351							; 72â<80><93>79 = Horizontal line fill (left and right to non-background) [MasRef E.3-24]
5352							; 88â<80><93>95 = Horizontal line fill (right to background) [MasRef E.3-25]
5353							; 104â<80><93>111 = Horizontal line fill (left and right to foreground) [MasRef E.3-26]
5354							; 120â<80><93>127 = Horizontal line fill (right to non-foreground) [MasRef E.3-27]
5355							;
5356	.dc6c						plotHorizontalLineFill:
5357	.dc6c		20 9f dd	jsr $dd9f	                jsr copyECFPatternForLineFill
5358	.dc6f		20 b0 dc	jsr $dcb0	                jsr LDCB0
5359	.dc72		18		clc		                clc
5360	.dc73		80 0e		bra $dc83	                bra LDC83

5362	.dc75						plotHorizontalLineFillRight:
5363	.dc75		20 9f dd	jsr $dd9f	                jsr copyECFPatternForLineFill
5364	.dc78		20 c9 dc	jsr $dcc9	                jsr LDCC9
5365	.dc7b		20 d2 dc	jsr $dcd2	                jsr LDCD2
5366	.dc7e		d0 03		bne $dc83	                bne LDC83
5367	.dc80		20 b8 dc	jsr $dcb8	                jsr LDCB8
5368	.dc83						LDC83:
5369	.dc83		08		php		                php
5370	.dc84		a2 2e		ldx #$2e	                ldx #VDUVariables.hlfw.pixelsX
5371	.dc86		a0 14		ldy #$14	                ldy #VDUVariables.oldGraphicsCursorPixelsX
5372	.dc88		20 1e c9	jsr $c91e	                jsr copyFourBytesWithinVDUVariables
5373	.dc8b		28		plp		                plp
5374	.dc8c		08		php		                php
5375	.dc8d		f0 02		beq $dc91	                beq LDC91
5376	.dc8f		a2 2e		ldx #$2e	                ldx #VDUVariables.hlfw.pixelsX
5377	.dc91						LDC91:
5378	.dc91		a0 24		ldy #$24	                ldy #VDUVariables.graphicsCursorPixelsX
5379	.dc93		20 0c c9	jsr $c90c	                jsr copyTwoBytesWithinVDUVariables
5380	.dc96		a2 30		ldx #$30	                ldx #VDUVariables.hlfw.pixelsY
5381	.dc98		20 0c c9	jsr $c90c	                jsr copyTwoBytesWithinVDUVariables
5382	.dc9b		28		plp		                plp
5383	.dc9c		f0 05		beq $dca3	                beq LDCA3
5384	.dc9e		b0 04		bcs $dca4	                bcs LDCA4
5385	.dca0		ee 16 03	inc $0316	                inc $0316
5386	.dca3						LDCA3:
5387	.dca3		60		rts		                rts

5389	.dca4						LDCA4:
5390	.dca4		ad 24 03	lda $0324	                lda $0324
5391	.dca7		d0 03		bne $dcac	                bne LDCAC
5392	.dca9		ce 25 03	dec $0325	                dec $0325
5393	.dcac						LDCAC:
5394	.dcac		ce 24 03	dec $0324	                dec $0324
5395	.dcaf		60		rts		                rts

5397							;-------------------------------------------------------------------------

5399	.dcb0						LDCB0:
5400	.dcb0		20 d2 dc	jsr $dcd2	                jsr LDCD2
5401	.dcb3		d0 55		bne $dd0a	                bne rtsDD0A
5402	.dcb5		20 0b dd	jsr $dd0b	                jsr LDD0B
5403	.dcb8						LDCB8:
5404	.dcb8		a2 2e		ldx #$2e	                ldx #$2E
5405	.dcba		a0 32		ldy #$32	                ldy #$32
5406	.dcbc		20 e8 da	jsr $dae8	                jsr LDAE8
5407	.dcbf		80 46		bra $dd07	                bra LDD07

5409	.dcc1						LDCC1:
5410	.dcc1		20 c9 dc	jsr $dcc9	                jsr LDCC9
5411	.dcc4		a2 2c		ldx #$2c	                ldx #$2C
5412	.dcc6		20 d9 dc	jsr $dcd9	                jsr LDCD9
5413	.dcc9						LDCC9:
5414	.dcc9		08		php		                php
5415	.dcca		a5 e1		lda $e1		                lda $E1
5416	.dccc		49 08		eor #$08	                eor #$08
5417	.dcce		85 e1		sta $e1		                sta $E1
5418	.dcd0		28		plp		                plp
5419	.dcd1		60		rts		                rts

5421							;-------------------------------------------------------------------------

5423	.dcd2						LDCD2:
5424	.dcd2		a0 2e		ldy #$2e	                ldy #VDUVariables.hlfw.pixelsX
5425	.dcd4		20 1e c9	jsr $c91e	                jsr copyFourBytesWithinVDUVariables
5426	.dcd7						LDCD7:
5427	.dcd7		a2 04		ldx #$04	                ldx #VDUVariables.graphicsWindowPixelsRight
5428	.dcd9						LDCD9:
5429	.dcd9		a0 34		ldy #$34	                ldy #VDUVariables.hlfw.pixelsLimitX
5430	.dcdb		20 0c c9	jsr $c90c	                jsr copyTwoBytesWithinVDUVariables
5431	.dcde		a2 34		ldx #$34	                ldx #VDUVariables.hlfw.pixelsLimitX
5432	.dce0		20 35 dd	jsr $dd35	                jsr shouldFillPixel
5433	.dce3		d0 25		bne $dd0a	                bne rtsDD0A  ;taken if pixel not to be filled, so done
5434	.dce5						LDCE5:
5435	.dce5		46 d1		lsr $d1		                lsr ZMASK                    ;next pixel
5436	.dce7		90 08		bcc $dcf1	                bcc LDCF1                    ;taken if still in same byte
5437	.dce9						LDCE9:
5438	.dce9		20 67 da	jsr $da67	                jsr nextColumnAndResetMask
5439	.dcec		20 65 dd	jsr $dd65	                jsr shouldFillByte
5440	.dcef		b0 f8		bcs $dce9	                bcs LDCE9
5441	.dcf1						LDCF1:
5442	.dcf1		20 85 dd	jsr $dd85	                jsr LDD85
5443	.dcf4		b0 ef		bcs $dce5	                bcs LDCE5
5444	.dcf6		38		sec		                sec
5445	.dcf7		ad 34 03	lda $0334	                lda vduv.hlfw.pixelsLimitX+0
5446	.dcfa		e5 de		sbc $de		                sbc zhlfw.pixelsX+0
5447	.dcfc		8d 32 03	sta $0332	                sta vduv.hlfw.pixelsRightEndX+0
5448	.dcff		ad 35 03	lda $0335	                lda vduv.hlfw.pixelsLimitX+1
5449	.dd02		e5 df		sbc $df		                sbc zhlfw.pixelsX+1
5450	.dd04		8d 33 03	sta $0333	                sta vduv.hlfw.pixelsRightEndX+1
5451	.dd07						LDD07:
5452	.dd07		a9 00		lda #$00	                lda #$00
5453	.dd09		38		sec		                sec
5454	.dd0a						rtsDD0A:
5455	.dd0a		60		rts		                rts

5457	.dd0b						LDD0B:
5458	.dd0b		a2 00		ldx #$00	                ldx #VDUVariables.graphicsWindowPixelsLeft
5459	.dd0d		20 35 dd	jsr $dd35	                jsr shouldFillPixel
5460	.dd10		d0 f8		bne $dd0a	                bne rtsDD0A                    ;taken if pixel not to be filled, so done
5461	.dd12						LDD12:
5462	.dd12		06 d1		asl $d1		                asl ZMASK                      ;next pixel
5463	.dd14		90 08		bcc $dd1e	                bcc LDD1E                    ;taken if still in same byte
5464	.dd16						LDD16:
5465	.dd16		20 34 da	jsr $da34	                jsr previousColumnAndResetMask
5466	.dd19		20 65 dd	jsr $dd65	                jsr shouldFillByte
5467	.dd1c		b0 f8		bcs $dd16	                bcs LDD16
5468	.dd1e						LDD1E:
5469	.dd1e		20 85 dd	jsr $dd85	                jsr LDD85
5470	.dd21		b0 ef		bcs $dd12	                bcs LDD12
5471	.dd23		ad 00 03	lda $0300	                lda vduv.graphicsWindowPixelsLeft+0
5472	.dd26		65 de		adc $de		                adc zhlfw.pixelsX+0
5473	.dd28		8d 2e 03	sta $032e	                sta vduv.hlfw.pixelsX+0
5474	.dd2b		ad 01 03	lda $0301	                lda vduv.graphicsWindowPixelsLeft+1
5475	.dd2e		65 df		adc $df		                adc zhlfw.pixelsX+1
5476	.dd30		8d 2f 03	sta $032f	                sta vduv.hlfw.pixelsX+1
5477	.dd33		80 d2		bra $dd07	                bra LDD07

5479							;-------------------------------------------------------------------------
5480							;
5481							; Check whether line fill should fill a pixel.
5482							;
5483							; entry:
5484							;
5485							; X = VDU variable offset of edge of window
5486							;
5487							; vduv.workspace._2E - pixel X, Y coordinates
5488							;
5489							; exit:
5490							;
5491							; Z=1 if pixel should be filled
5492							;
5493							; ZTEMPC = ???
5494							;
5495	.dd35						shouldFillPixel:
5496	.dd35		38		sec		                sec
5497	.dd36		ad 2e 03	lda $032e	                lda vduv.workspace._2E+0
5498	.dd39		fd 00 03	sbc $0300,x	                sbc vduv+0,x
5499	.dd3c		a8		tay		                tay
5500	.dd3d		ad 2f 03	lda $032f	                lda vduv.workspace._2E+1
5501	.dd40		fd 01 03	sbc $0301,x	                sbc vduv+1,x
5502	.dd43		10 03		bpl $dd48	                bpl +
5503	.dd45		20 2e c9	jsr $c92e	                jsr negateAY
5504	.dd48						+
5505	.dd48		84 de		sty $de		                sty zhlfw.pixelsX+0
5506	.dd4a		85 df		sta $df		                sta zhlfw.pixelsX+1
5507	.dd4c		a2 2e		ldx #$2e	                ldx #VDUVariables.workspace._2E
5508	.dd4e		20 c3 de	jsr $dec3	                jsr windGADDR
5509	.dd51		18		clc		                clc
5510	.dd52		d0 10		bne $dd64	                bne rtsDD64                    ;taken if point outside window
5511	.dd54		b1 d6		lda ($d6),y	                lda (ZMEMG),y                  ;get screen byte
5512	.dd56		5d 30 88	eor $8830,x	                eor andy.hlfw.ecfPattern,x     ;EOR with appropriate pattern
5513	.dd59		85 da		sta $da		                sta zhlfw.notByteMatch ;0 if whole byte matches
5514	.dd5b		25 d1		and $d1		                and ZMASK                      ;0 if masked byte matches
5515	.dd5d		f0 02		beq $dd61	                beq +              ;taken if masked byte matches - A=0
5516	.dd5f		a9 08		lda #$08	                lda #$08              ;masked byte doesn't match - A=8
5517	.dd61						+
5518	.dd61		45 e1		eor $e1		                eor zhlfw.resultEOR ;maybe invert result
5519	.dd63		38		sec		                sec
5520	.dd64						rtsDD64:
5521	.dd64		60		rts		                rts

5523							;-------------------------------------------------------------------------

5525	.dd65						shouldFillByte:
5526	.dd65		b1 d6		lda ($d6),y	                lda (ZMEMG),y
5527	.dd67		5d 30 88	eor $8830,x	                eor andy.hlfw.ecfPattern,x
5528	.dd6a		85 da		sta $da		                sta zhlfw.notByteMatch
5529	.dd6c		05 e1		ora $e1		                ora zhlfw.resultEOR
5530	.dd6e		18		clc		                clc
5531	.dd6f		d0 13		bne $dd84	                bne rtsDD84
5532	.dd71		a5 de		lda $de		                lda zhlfw.pixelsX+0
5533	.dd73		ed 61 03	sbc $0361	                sbc vduv.pixelsPerByteMinusOne
5534	.dd76		48		pha		                pha
5535	.dd77		a5 df		lda $df		                lda zhlfw.pixelsX+1
5536	.dd79		e9 00		sbc #$00	                sbc #$00
5537	.dd7b		90 06		bcc $dd83	                bcc pla_rts_DD83             ;taken if past X=0
5538	.dd7d		85 df		sta $df		                sta zhlfw.pixelsX+1
5539	.dd7f		68		pla		                pla
5540	.dd80		85 de		sta $de		                sta zhlfw.pixelsX+0
5541	.dd82		60		rts		                rts

5543	.dd83						pla_rts_DD83:
5544	.dd83		68		pla		                pla
5545	.dd84						rtsDD84:
5546	.dd84		60		rts		                rts

5548							;-------------------------------------------------------------------------

5550	.dd85						LDD85:
5551	.dd85		a5 da		lda $da		                lda zhlfw.notByteMatch
5552	.dd87		25 d1		and $d1		                and ZMASK
5553	.dd89		f0 02		beq $dd8d	                beq +
5554	.dd8b		a9 08		lda #$08	                lda #$08
5555	.dd8d						+
5556	.dd8d		45 e1		eor $e1		                eor zhlfw.resultEOR
5557	.dd8f		d0 0d		bne $dd9e	                bne rtsDD9E

5559							                ; pixelsX -= 1
5560	.dd91		a5 de		lda $de		                lda zhlfw.pixelsX+0
5561	.dd93		d0 06		bne $dd9b	                bne +
5562	.dd95		a5 df		lda $df		                lda zhlfw.pixelsX+1
5563	.dd97		f0 05		beq $dd9e	                beq rtsDD9E
5564	.dd99		c6 df		dec $df		                dec zhlfw.pixelsX+1
5565	.dd9b						+
5566	.dd9b		c6 de		dec $de		                dec zhlfw.pixelsX+0
5567	.dd9d		38		sec		                sec
5568	.dd9e						rtsDD9E:
5569	.dd9e		60		rts		                rts

5571							;-------------------------------------------------------------------------
5572							;
5573							; Copy appropriate ECF pattern for line fill.
5574							;
5575							; entry:
5576							;
5577							; A = horizontal line fill PLOT code
5578							;
5579							; exit:
5580							;
5581							; andy.hlfw.ecfPattern = holds bg/fg ECF pattern as required
5582							;
5583							; ZTEMPD?1 = 0 for fill to matching, 8 to fill to non-matching
5584							;
5585	.dd9f						copyECFPatternForLineFill:
5586	.dd9f		4a		lsr a		                lsr a                        ;36-39; 44-47; 52-55; 60-63
5587	.dda0		4a		lsr a		                lsr a                        ;18-19; 42-43; 26-27; 30-31
5588	.dda1						LDDA1:
5589	.dda1		29 08		and #$08	                and #$08                     ;8 if PLOT >= 104
5590	.dda3		85 e1		sta $e1		                sta zhlfw.resultEOR
5591	.dda5		49 0f		eor #$0f	                eor #$0F                     ;
5592	.dda7		aa		tax		                tax
5593	.dda8		a0 07		ldy #$07	                ldy #$07
5594	.ddaa						-
5595	.ddaa		bd 20 88	lda $8820,x	                lda andy.currentECFPatterns,x
5596	.ddad		99 30 88	sta $8830,y	                sta andy.hlfw.ecfPattern,y
5597	.ddb0		ca		dex		                dex
5598	.ddb1		88		dey		                dey
5599	.ddb2		10 f6		bpl $ddaa	                bpl -
5600	.ddb4		a2 20		ldx #$20	                ldx #VDUVariables.queueEnd-4
5601	.ddb6		60		rts		                rts

5603							;-------------------------------------------------------------------------
5604							;
5605							;
5606							; entry:
5607							;
5608							; A = offset into VDU variables of coordinates
5609							;
5610							; exit:
5611							;
5612							; A = colour, or $ff if off screen/teletext (as per OSWORD $09)
5613							;
5614	.ddb7						readPixelColour: .proc
5615	.ddb7		20 fa c0	jsr $c0fa	                jsr stopCursorEditing
5616	.ddba		ae 61 03	ldx $0361	                ldx vduv.pixelsPerByteMinusOne
5617	.ddbd		f0 21		beq $dde0	                beq invalid             ;taken if teletext
5618	.ddbf		48		pha		                pha
5619	.ddc0		aa		tax		                tax
5620	.ddc1		20 de d1	jsr $d1de	                jsr eigabsEntryPoint
5621	.ddc4		fa		plx		                plx
5622	.ddc5		20 c3 de	jsr $dec3	                jsr windGADDR
5623	.ddc8		d0 16		bne $dde0	                bne invalid             ;taken if off screen
5624	.ddca		b1 d6		lda ($d6),y	                lda (ZMEMG),y
5625	.ddcc		64 da		stz $da		                stz ZTEMP+0
5626	.ddce		80 01		bra $ddd1	                bra shiftMask

5628							                ; Keep shifting the byte and the mask. When a 1 bit is
5629							                ; shifted out of the mask, shift the corresponding
5630							                ; byte bit bit into ZTEMP+0, building up the pixel
5631							                ; colour a bit at a time.
5632							                ;
5633							                ; When the mask becomes 0, done.
5634	.ddd0						shiftByteAndMask:
5635	.ddd0		0a		asl a		                asl a
5636	.ddd1						shiftMask:
5637	.ddd1		06 d1		asl $d1		                asl ZMASK
5638	.ddd3		90 fb		bcc $ddd0	                bcc shiftByteAndMask
5639	.ddd5		0a		asl a		                asl a
5640	.ddd6		26 da		rol $da		                rol ZTEMP+0
5641	.ddd8		a6 d1		ldx $d1		                ldx ZMASK
5642	.ddda		d0 f5		bne $ddd1	                bne shiftMask
5643	.dddc		a5 da		lda $da		                lda ZTEMP+0
5644	.ddde		80 02		bra $dde2	                bra done

5646	.dde0						invalid:
5647	.dde0		a9 ff		lda #$ff	                lda #$FF
5648	.dde2						done:
5649	.dde2		4c ca c0	jmp $c0ca	                jmp reinstateCursorEditing
5650							                .endproc

5652							;-------------------------------------------------------------------------
5653							;
5654							; Translate ASCII char to the SAA5050 character set.
5655							;
5656							; # ($23) becomes $5f
5657							; _ ($5f) becomes $60
5658							; GBP ($60) becomes $23
5659							;
5660							; Because the mapping is a kind of cycle, you can call this routine
5661							; twice to translate from SAA5050 to ASCII.
5662							;
5663							; entry:
5664							;
5665							; A = ASCII char
5666							;
5667							; exit:
5668							;
5669							; A = SAA550 char
5670							;
5671	.dde5						getSAA5050FromASCII:
5672	.dde5		c9 23		cmp #$23	                cmp #$23
5673	.dde7		f0 0a		beq $ddf3	                beq translateHash
5674	.dde9		c9 5f		cmp #$5f	                cmp #$5F
5675	.ddeb		f0 08		beq $ddf5	                beq translateUnderscore
5676	.dded		c9 60		cmp #$60	                cmp #$60
5677	.ddef		d0 06		bne $ddf7	                bne rtsDDF7
5678	.ddf1						translateGBP:
5679	.ddf1		49 3f		eor #$3f	                eor #$3F                     ;0x60->0x5f
5680	.ddf3						translateHash:
5681	.ddf3		49 43		eor #$43	                eor #$43                     ;0x23->0x5f or 0x5f->0x1c
5682	.ddf5						translateUnderscore:
5683	.ddf5		49 3f		eor #$3f	                eor #$3F                     ;0x5f->0x60 or 0x1c->0x23
5684	.ddf7						rtsDDF7:
5685	.ddf7		60		rts		                rts

5687							;-------------------------------------------------------------------------

5689	.ddf8						readCharacterAtTextCursor: .proc
5690	.ddf8		58		cli		                cli
5691	.ddf9		24 d0		bit $d0		                bit STATE
5692	.ddfb		50 06		bvc $de03	                bvc +                      ;taken if not cursor editing
5693	.ddfd		20 fa c0	jsr $c0fa	                jsr stopCursorEditing
5694	.de00		20 d1 c0	jsr $c0d1	                jsr exchangeCursors
5695	.de03						+
5696	.de03		ac 60 03	ldy $0360	                ldy vduv.numberOfLogicalColoursMinusOne
5697	.de06		d0 17		bne $de1f	                bne bitmapMode
5698	.de08						readTeletextChar:
5699	.de08		b2 d8		lda ($d8)	                lda (ZMEMT)                  ;read character from screen
5700	.de0a		20 e5 dd	jsr $dde5	                jsr getSAA5050FromASCII      ;call 2x to convert to ASCII
5701	.de0d		20 e5 dd	jsr $dde5	                jsr getSAA5050FromASCII      ;call 2x to convert to ASCII
5702	.de10						done:
5703	.de10		24 d0		bit $d0		                bit STATE
5704	.de12		50 06		bvc $de1a	                bvc +                     ;taken if not cursor editing
5705	.de14		20 d1 c0	jsr $c0d1	                jsr exchangeCursors
5706	.de17		20 ca c0	jsr $c0ca	                jsr reinstateCursorEditing
5707	.de1a						+
5708	.de1a		ac 55 03	ldy $0355	                ldy vduv.currentScreenMODE
5709	.de1d		aa		tax		                tax
5710	.de1e		60		rts		                rts

5712	.de1f						bitmapMode:
5713	.de1f		20 56 de	jsr $de56	                jsr LDE56
5714	.de22		a5 f4		lda $f4		                lda $F4
5715	.de24		48		pha		                pha
5716	.de25		20 7f e5	jsr $e57f	                jsr selectTerminalROMAndANDY
5717	.de28		a9 20		lda #$20	                lda #$20
5718	.de2a		aa		tax		                tax                          ;X = ASCII code for char
5719	.de2b		20 2c e2	jsr $e22c	                jsr getSoftCharacterDefinitionAddress
5720	.de2e						compare:
5721	.de2e		a0 07		ldy #$07	                ldy #$07
5722	.de30						-
5723	.de30		b9 28 03	lda $0328,y	                lda vduv.workspace._28,y
5724	.de33		51 de		eor ($de),y	                eor (ZTEMPC),y
5725	.de35		d0 0a		bne $de41	                bne nextFontChar ;taken if no match - can't be this char
5726	.de37		88		dey		                dey
5727	.de38		10 f6		bpl $de30	                bpl -

5729	.de3a		8a		txa		                txa                          ;A = char found
5730							                .if version==350
5733							                .endif
5734	.de3b						bitmapModeDone:
5735	.de3b		fa		plx		                plx
5736	.de3c		20 81 e5	jsr $e581	                jsr selectROMX
5737	.de3f		80 cf		bra $de10	                bra done

5739	.de41						nextFontChar:
5740	.de41		e8		inx		                inx                          ;next ASCII code
5741							                .if version==350
5747							                .else
5748	.de42		18		clc		                clc
5749	.de43		a5 de		lda $de		                lda ZTEMPC+0
5750	.de45		69 08		adc #$08	                adc #$08                     ;8 bytes/font char
5751	.de47		85 de		sta $de		                sta ZTEMPC+0
5752	.de49		90 02		bcc $de4d	                bcc gotCharAddress
5753	.de4b		e6 df		inc $df		                inc ZTEMPC+1
5754							                .endif
5755	.de4d						gotCharAddress:
5756	.de4d		e0 7f		cpx #$7f	                cpx #$7F
5757	.de4f		f0 f0		beq $de41	                beq nextFontChar                 ;skip CHR$127
5758	.de51		8a		txa		                txa
5759	.de52		d0 da		bne $de2e	                bne compare           ;taken if more chars to consider
5760	.de54		80 e5		bra $de3b	                bra bitmapModeDone ;finish with A=0 - i.e., no match found
5761							                .endproc

5763							;-------------------------------------------------------------------------
5764							;
5765							; Copy character out of screen memory, and store as a 1 bpp bitmap in
5766							; VDU variables workspace.
5767							;
5768	.de56						LDE56: .proc
5769	.de56		a6 d8		ldx $d8		                ldx ZMEMT+0
5770	.de58		a5 d9		lda $d9		                lda ZMEMT+1
5771	.de5a		20 d9 ce	jsr $ced9	                jsr getNext3ColumnAddresses
5772	.de5d		a0 07		ldy #$07	                ldy #$07
5773	.de5f						loop:
5774	.de5f		ae 60 03	ldx $0360	                ldx vduv.numberOfLogicalColoursMinusOne
5775	.de62		e0 03		cpx #$03	                cpx #$03
5776	.de64		f0 09		beq $de6f	                beq read2bppChar
5777	.de66		b0 13		bcs $de7b	                bcs read4bppChar
5778	.de68						read1bppChar:
5779	.de68		b1 d8		lda ($d8),y	                lda (ZMEMT),y
5780	.de6a		4d 58 03	eor $0358	                eor vduv.backgroundTextColour
5781	.de6d		80 22		bra $de91	                bra next

5783	.de6f						read2bppChar:
5784	.de6f		b1 d8		lda ($d8),y	                lda (ZMEMT),y                ;get pixels 0-3
5785	.de71		20 a2 de	jsr $dea2	                jsr get4Pixels
5786	.de74		b1 da		lda ($da),y	                lda (ZTEMP),y                  ;get pixels 4-7
5787	.de76		20 a2 de	jsr $dea2	                jsr get4Pixels
5788	.de79		80 14		bra $de8f	                bra LDE8F

5790	.de7b						read4bppChar:
5791	.de7b		b1 d8		lda ($d8),y	                lda (ZMEMT),y                ;get pixels 0/1
5792	.de7d		20 98 de	jsr $de98	                jsr get2Pixels
5793	.de80		b1 da		lda ($da),y	                lda (ZTEMP),y                ;get pixels 2/3
5794	.de82		20 98 de	jsr $de98	                jsr get2Pixels
5795	.de85		b1 dc		lda ($dc),y	                lda (ZTEMPB),y               ;get pixels 4/5
5796	.de87		20 98 de	jsr $de98	                jsr get2Pixels
5797	.de8a		b1 e0		lda ($e0),y	                lda (ZTEMPD),y               ;get pixels 6/7
5798	.de8c		20 98 de	jsr $de98	                jsr get2Pixels
5799	.de8f						LDE8F:
5800	.de8f		a5 df		lda $df		                lda ZTEMPC+1
5801	.de91						next:
5802	.de91		99 28 03	sta $0328,y	                sta vduv.workspace._28,y
5803	.de94		88		dey		                dey
5804	.de95		10 c8		bpl $de5f	                bpl loop
5805	.de97		60		rts		                rts

5807	.de98						get2Pixels:
5808	.de98		4d 58 03	eor $0358	                eor vduv.backgroundTextColour ;reset background pixel bits
5809	.de9b		20 b5 de	jsr $deb5	                jsr or2Pixels
5810	.de9e		29 03		and #$03	                and #%00000011               ;2 pixels/byte
5811	.dea0		80 0c		bra $deae	                bra shiftIn2

5813	.dea2						get4Pixels:
5814	.dea2		4d 58 03	eor $0358	                eor vduv.backgroundTextColour ;
5815	.dea5		20 ba de	jsr $deba	                jsr or4Pixels
5816	.dea8		29 0f		and #$0f	                and #%00001111               ;4 pixels/byte

5818							                ; Build up the 1bpp char row in ZTEMPC?1, 2 or 4 bits
5819							                ; at a time.
5820	.deaa		06 df		asl $df		                asl ZTEMPC+1
5821	.deac		06 df		asl $df		                asl ZTEMPC+1
5822	.deae						shiftIn2:
5823	.deae		06 df		asl $df		                asl ZTEMPC+1
5824	.deb0		06 df		asl $df		                asl ZTEMPC+1
5825	.deb2		04 df		tsb $df		                tsb ZTEMPC+1
5826	.deb4		60		rts		                rts

5828							                ; OR together all the N bits for each pixel, making a
5829							                ; byte in which the bottom N bits have a bit set for
5830							                ; each non-0 pixel in the byte.
5831	.deb5						or2Pixels:
5832	.deb5		85 de		sta $de		                sta ZTEMPC+0
5833	.deb7		20 be de	jsr $debe	                jsr shiftOut2
5834	.deba						or4Pixels:
5835	.deba		85 de		sta $de		                sta ZTEMPC+0                 ;%abcdABCD
5836	.debc		4a		lsr a		                lsr a                        ;%0abcdABC
5837	.debd		4a		lsr a		                lsr a                        ;%00abcdAB
5838	.debe						shiftOut2:
5839	.debe		4a		lsr a		                lsr a                        ;%000abcdA
5840	.debf		4a		lsr a		                lsr a                        ;%0000abcd
5841	.dec0		05 de		ora $de		                ora ZTEMPC+0                 ;%0000abcd|%abcdABCD
5842							                .endproc
5843	.dec2						rtsDEC2:
5844	.dec2		60		rts		                rts

5846							;-------------------------------------------------------------------------
5847							;
5848							; Do WIND. If point not in window, return with Z=0. Otherwise, call
5849							; GADDR and return with Z=1.
5850							;
5851	.dec3						windGADDR:
5852	.dec3		20 a8 d1	jsr $d1a8	                jsr windEntryPoint
5853	.dec6		d0 fa		bne $dec2	                bne rtsDEC2                  ;taken if point outside window
5854	.dec8						gaddrEntryPoint:
5855	.dec8		bd 02 03	lda $0302,x	                lda vduv+2,x                 ;get Y coordinate
5856	.decb						LDECB:
5857	.decb		49 ff		eor #$ff	                eor #$FF                     ;invert Y coordinate
5858	.decd		a8		tay		                tay                          ;Y=Y coordinate
5859	.dece		29 07		and #$07	                and #$07                ;get scanline in character row
5860	.ded0		85 da		sta $da		                sta ZTEMP+0             ;save scanline
5861	.ded2		98		tya		                tya                          ;A=Y coordinate
5862	.ded3		29 f8		and #$f8	                and #$F8                     ;row*8
5863	.ded5		4a		lsr a		                lsr a                        ;row*4
5864	.ded6		85 d7		sta $d7		                sta ZMEMG+1                  ;>(row*1024)
5865	.ded8		4a		lsr a		                lsr a                        ;>(row*512)
5866	.ded9		4a		lsr a		                lsr a                        ;>(row*256)
5867	.deda		65 d7		adc $d7		                adc ZMEMG+1                  ;>(row*1280)
5868	.dedc		4a		lsr a		                lsr a                        ;>(row*640)
5869	.dedd		85 d7		sta $d7		                sta ZMEMG+1                  ;
5870	.dedf		a9 00		lda #$00	                lda #$00                     ;
5871	.dee1		6a		ror a		                ror a                        ;<(row*640) - $00/$80
5872	.dee2		ac 56 03	ldy $0356	                ldy vduv.currentScreenMODEGroup
5873	.dee5		f0 03		beq $deea	                beq +                      ;taken if 640 bytes per row
5874	.dee7		46 d7		lsr $d7		                lsr ZMEMG+1                ;>(row*320)
5875	.dee9		6a		ror a		                ror a                    ;<(row*320) - $00/$40/$80/$c0
5876	.deea						+
5877	.deea		05 da		ora $da		                ora ZTEMP+0               ;include the scanline offset
5878	.deec		6d 50 03	adc $0350	                adc vduv.screenTopLeftAddress+0 ;include LSB of screen base
5879	.deef		8d 1a 03	sta $031a	                sta vduv.graphicsAddressOffset

5881							                ; add MSB of screen base to ZMEMG+1
5882	.def2		a5 d7		lda $d7		                lda ZMEMG+1
5883	.def4		6d 51 03	adc $0351	                adc vduv.screenTopLeftAddress+1
5884	.def7		85 d7		sta $d7		                sta ZMEMG+1

5886	.def9		bd 01 03	lda $0301,x	                lda vduv+1,x                 ;get >X
5887	.defc		85 d6		sta $d6		                sta ZMEMG+0                  ;save >X
5888	.defe		bd 00 03	lda $0300,x	                lda vduv+0,x                 ;get <X
5889	.df01		2d 61 03	and $0361	                and vduv.pixelsPerByteMinusOne ;index for pixel
5890	.df04		6d 61 03	adc $0361	                adc vduv.pixelsPerByteMinusOne ;offset into pixel mask table
5891	.df07		a8		tay		                tay
5892	.df08		b9 2e e1	lda $e12e,y	                lda pixelMasks-1,y
5893	.df0b		85 d1		sta $d1		                sta ZMASK

5895							                ; Form 16-bit column address offset (LSB in A, MSB in
5896							                ; ZMEMG+0), assuming 8 bits/pixel. No adjustment
5897							                ; needed if MODE 0/4, but scale up by 2 if MODE 1/5 or
5898							                ; 4 if MODE 2.

5900	.df0d		bd 00 03	lda $0300,x	                lda vduv+0,x                 ;A = <X
5901	.df10		ac 61 03	ldy $0361	                ldy vduv.pixelsPerByteMinusOne
5902	.df13		c0 03		cpy #$03	                cpy #$03
5903	.df15		f0 05		beq $df1c	                beq LDF1C         ;taken if 4 px/byte - i.e., MODE 1/5
5904	.df17		b0 06		bcs $df1f	                bcs LDF1F        ;taken if >4 px/byte - i.e., MODE 0/4
5905	.df19		0a		asl a		                asl a
5906	.df1a		26 d6		rol $d6		                rol ZMEMG+0
5907	.df1c						LDF1C:
5908	.df1c		0a		asl a		                asl a
5909	.df1d		26 d6		rol $d6		                rol ZMEMG+0
5910	.df1f						LDF1F:
5911	.df1f		29 f8		and #$f8	                and #$F8                     ;<column offset
5912	.df21		18		clc		                clc
5913	.df22		6d 1a 03	adc $031a	                adc vduv.graphicsAddressOffset
5914	.df25		8d 1a 03	sta $031a	                sta vduv.graphicsAddressOffset
5915	.df28		a5 d6		lda $d6		                lda ZMEMG+0                  ;>column offset
5916	.df2a		65 d7		adc $d7		                adc ZMEMG+1                  ;add to address MSB
5917	.df2c		10 04		bpl $df32	                bpl +                        ;taken if no wrap
5918	.df2e		38		sec		                sec
5919	.df2f		ed 54 03	sbc $0354	                sbc vduv.screenSizeHighByte ;handle wrap at end of screen
5920	.df32						+
5921	.df32		85 d7		sta $d7		                sta ZMEMG+1                  ;got MSB
5922	.df34		64 d6		stz $d6		                stz ZMEMG+0 ;LSB always 0 - the offset takes care of this
5923	.df36		a6 da		ldx $da		                ldx ZTEMP+0 ;get scanline in row
5924	.df38		20 7c da	jsr $da7c	                jsr setupColourMasks
5925	.df3b		ac 1a 03	ldy $031a	                ldy vduv.graphicsAddressOffset
5926	.df3e						ldaim00_rts_DF3E:
5927	.df3e		a9 00		lda #$00	                lda #$00                     ;return with Z=1, as per WIND
5928	.df40		60		rts		                rts

5930							;-------------------------------------------------------------------------

5932	.df41						LDF41:
5933	.df41		20 c8 de	jsr $dec8	                jsr gaddrEntryPoint
5934	.df44		da		phx		                phx
5935	.df45		a2 00		ldx #$00	                ldx #$00
5936	.df47		ad 5a 03	lda $035a	                lda $035A
5937	.df4a		c9 04		cmp #$04	                cmp #$04
5938	.df4c		b0 0b		bcs $df59	                bcs LDF59
5939	.df4e		ae 6a 03	ldx $036a	                ldx $036A
5940	.df51		ad 59 03	lda $0359	                lda $0359
5941	.df54		f0 03		beq $df59	                beq LDF59
5942	.df56		ae 6b 03	ldx $036b	                ldx $036B
5943	.df59						LDF59:
5944	.df59		8e 69 03	stx $0369	                stx $0369
5945	.df5c		fa		plx		                plx
5946	.df5d		60		rts		                rts

5948							;-------------------------------------------------------------------------

5950	.df5e						handleCopyKey:
5951	.df5e		a9 20		lda #$20	                lda #STATE.isVDU5
5952	.df60		24 d0		bit $d0		                bit STATE
5953	.df62		50 da		bvc $df3e	                bvc ldaim00_rts_DF3E      ;taken if not cursor editing
5954	.df64		d0 d8		bne $df3e	                bne ldaim00_rts_DF3E      ;taken if VDU5
5955							                .if version==350&&!finmos329
5957							                .elsif (version<511||autocue)&&!finmos329
5958	.df66		20 f8 dd	jsr $ddf8	                jsr readCharacterAtTextCursor
5963							                .endif
5964	.df69		f0 0c		beq $df77	                beq rtsDF77              ;taken if char not recognised
5965	.df6b		48		pha		                pha                      ;save char recognised
5966	.df6c		20 d5 df	jsr $dfd5	                jsr isCursorEditingPossible
5967	.df6f		d0 05		bne $df76	                bne pla_rts_DF76
5968	.df71		a9 09		lda #$09	                lda #$09
5969	.df73		20 bc df	jsr $dfbc	                jsr moveEditCursor
5970	.df76						pla_rts_DF76:
5971	.df76		68		pla		                pla
5972	.df77						rtsDF77:
5973	.df77		60		rts		                rts

5975							;-------------------------------------------------------------------------
5976							;
5977							; Handle cursor key press.
5978							;
5979							; Entry: A = one of the cursor key codes:
5980							;            $88 = left
5981							;            $89 = right
5982							;            $8a = down
5983							;            $8b = up

5985	.df78						handleCursorKey:
5986	.df78		48		pha		                pha                          ;save cursor key code
5987	.df79		20 d5 df	jsr $dfd5	                jsr isCursorEditingPossible
5988	.df7c		d0 f8		bne $df76	                bne pla_rts_DF76             ;bail if editing not possible
5989	.df7e		70 16		bvs $df96	                bvs editing                  ;taken if already editing
5990	.df80						beginEditing:
5991	.df80		ad 5f 03	lda $035f	                lda vduv.lastCursorStartRegisterValue
5992	.df83		29 df		and #$df	                and #%11011111
5993	.df85		20 53 cf	jsr $cf53	                jsr setCRTCRegister10        ;hide cursor
5994	.df88		a2 18		ldx #$18	                ldx #VDUVariables.textCursorXPosition
5995	.df8a		a0 64		ldy #$64	                ldy #VDUVariables.editCursorXPosition
5996	.df8c		20 0c c9	jsr $c90c	                jsr copyTwoBytesWithinVDUVariables ;edit cursor pos =
5997							                                                   ;text cursor pos
5998	.df8f		20 05 c1	jsr $c105	                jsr activateEditCursor
5999	.df92		a9 02		lda #$02	                lda #STATE.isScrollingDisabled
6000	.df94		04 d0		tsb $d0		                tsb STATE
6001	.df96						editing:
6002	.df96		68		pla		                pla                          ;restore cursor key code

6004							                ; Form appropriate VDU command (8/9/10/11) for the
6005							                ; key, assuming no VDU axis rearrangement.
6006	.df97		29 7f		and #$7f	                and #$7F
6007	.df99		85 da		sta $da		                sta ZTEMP                    ;save VDU command

6009							                ; Adjust VDU command based on axis swap/inversion.
6010	.df9b		c9 0a		cmp #$0a	                cmp #$0A
6011	.df9d		b0 0e		bcs $dfad	                bcs handleCursorUpOrDown     ;taken if up/down
6012	.df9f						handleCursorLeftOrRightOrCopy:
6013	.df9f		ad 66 03	lda $0366	                lda vduv.cursorFlags
6014	.dfa2		4a		lsr a		                lsr a
6015	.dfa3		29 05		and #$05	                and #(vduv.cursorFlags.swapAxes|vduv.cursorFlags.invertHorizontal)>>1
6016	.dfa5		89 04		bit #$04	                bit #vduv.cursorFlags.swapAxes>>1
6017	.dfa7		f0 11		beq $dfba	                beq gotActualMoveCommand

6019	.dfa9		49 07		eor #$07	                eor #(vduv.cursorFlags.swapAxes|vduv.cursorFlags.invertVertical|vduv.cursorFlags.invertHorizontal)>>1
6020	.dfab		80 0d		bra $dfba	                bra gotActualMoveCommand

6022	.dfad						handleCursorUpOrDown:
6023	.dfad		ad 66 03	lda $0366	                lda vduv.cursorFlags
6024	.dfb0		4a		lsr a		                lsr a
6025	.dfb1		4a		lsr a		                lsr a
6026	.dfb2		29 03		and #$03	                and #(vduv.cursorFlags.swapAxes|vduv.cursorFlags.invertVertical)>>2 ;000000SV
6027	.dfb4		89 02		bit #$02	                bit #vduv.cursorFlags.swapAxes>>2
6028	.dfb6		f0 02		beq $dfba	                beq gotActualMoveCommand

6030	.dfb8		49 01		eor #$01	                eor #vduv.cursorFlags.invertVertical>>2
6031	.dfba						gotActualMoveCommand:
6032	.dfba		45 da		eor $da		                eor ZTEMP
6033	.dfbc						moveEditCursor:
6034	.dfbc		a8		tay		                tay                          ;save command
6035	.dfbd		a9 40		lda #$40	                lda #STATE.isCursorEditing
6036	.dfbf		14 d0		trb $d0		                trb STATE            ;temporarily disable edit mode
6037	.dfc1		98		tya		                tya                  ;restore command
6038	.dfc2		ae 6c 03	ldx $036c	                ldx vduv.column81
6039	.dfc5		da		phx		                phx                  ;save old column 81 flag
6040	.dfc6		4e 6c 03	lsr $036c	                lsr vduv.column81    ;temporarily reset column 81 flag
6041	.dfc9		20 27 c0	jsr $c027	                jsr outputToVDU      ;print the cursor movement command
6042	.dfcc		68		pla		                pla
6043	.dfcd		8d 6c 03	sta $036c	                sta vduv.column81            ;restore column 81 flag
6044	.dfd0		a9 40		lda #$40	                lda #STATE.isCursorEditing
6045	.dfd2		04 d0		tsb $d0		                tsb STATE                    ;reinstate edit mode
6046	.dfd4		60		rts		                rts

6048							; Check if cursor editing is possible.
6049							;
6050							; Exit: Z=1 - editing is possible
6051							;             V reflects current STATE.isCursorEditing bit
6052							;       Z=0 - editing not possible
6053	.dfd5						isCursorEditingPossible:
6054	.dfd5		ae 6a 02	ldx $026a	                ldx vduQueueNegativeLength
6055	.dfd8		d0 04		bne $dfde	                bne +                        ;return with Z=0 if VDU
6056							                                             ;queue not empty
6057	.dfda		a9 a0		lda #$a0	                lda #STATE.isVDU21|STATE.isVDU5
6058	.dfdc		24 d0		bit $d0		                bit STATE   ;return with Z=0 if neither VDU21 nor VDU5
6059	.dfde						+
6060	.dfde		60		rts		                rts

6062							;-------------------------------------------------------------------------
6063							;
6064							; 184â<80><93>191 = Move/copy rectangle [MasRef E.3-31]
6065							;
6066							                .if version!=400
6067	.dfdf						plotMoveOrCopyRectangle:
6068	.dfdf		a2 8e		ldx #$8e	                ldx #$80|extROM   ; select VIEW+ANDY
6069	.dfe1		20 81 e5	jsr $e581	                jsr selectROMX
6070	.dfe4		20 be be	jsr $bebe	                jsr ext.plotMoveOrCopyRectangle
6071	.dfe7		80 08		bra $dff1	                bra LDFF1
6072							                .endif

6074							;-------------------------------------------------------------------------
6075							;
6076							; 192â<80><93>199 = Plot ellipse outline [MasRef E.3-32]
6077							;
6078							                .if version!=400
6079	.dfe9						plotEllipseOutline:
6080	.dfe9		a2 8e		ldx #$8e	                ldx #$80|extROM
6081	.dfeb		20 81 e5	jsr $e581	                jsr selectROMX
6082	.dfee		20 00 ba	jsr $ba00	                jsr ext.plotEllipseOutline
6083	.dff1						LDFF1:
6084	.dff1		4c 7f e5	jmp $e57f	                jmp selectTerminalROMAndANDY
6085							                .endif

6087							;-------------------------------------------------------------------------
6088							;
6089							; 200â<80><93>207 = Plot solid ellipse [MasRef E.3-32]
6090							;
6091							                .if version!=400
6092	.dff4						plotSolidEllipse:
6093	.dff4		a2 8e		ldx #$8e	                ldx #$80|extROM
6094	.dff6		20 81 e5	jsr $e581	                jsr selectROMX
6095	.dff9		20 67 ba	jsr $ba67	                jsr ext.plotSolidEllipse
6096	.dffc		80 f3		bra $dff1	                bra LDFF1
6097							                .endif

6099							                .if version==400
6101							                .endif

6103							;-------------------------------------------------------------------------

6105							; Pretty sure I have the logic for this all wrong...

6107							                .if !finmos329
6108	>dffe						                .align 16
6109							                .endif
6110	.e000						startupMessages: .block
6111							                .if version==500||version==510||autocue
6113							                .endif

6115							                .if version>=511&&!autocue
6117							                .endif
6118	.e000						acornMOS:
6119	>e000		0d				                .text 13
6120							                .if olivetti
6130							                .else
6131	>e001		41 63 6f 72 6e 20 4d 4f		                .text "Acorn MOS"
	>e009		53
6132							                .endif
6133							                .if version==400||version==350
6135							                .endif
6136	>e00a		00				                .byte 0
6137	.e00b						beep:
6138	>e00b		07				                .byte 7
6139	>e00c		00				                .byte 0
6140							                .if version!=400&&version!=350
6141	>e00d		00 00 00			                .byte 0,0,0   ;space for "xxK"
6142							                .endif

6144	.e010						twoNewlines:
6145	>e010		08				                .byte 8
6146	>e011		0d				                .byte $0D
6147	>e012		0d				                .byte $0D
6148							                ; terminating 0 comes from following table!
6149							                .cerror *!=LE013,"startupMessages needs a terminating 0"
6150							                .endblock
6151	.e013						LE013:
6152	>e013		00				                .byte %00000000;$00
6153	>e014		11				                .byte %00010001;$11
6154	>e015		22				                .byte %00100010;$22
6155	>e016		33				                .byte %00110011;$33
6156	>e017		44				                .byte %01000100;$44
6157	>e018		55				                .byte %01010101;$55
6158	>e019		66				                .byte %01100110;$66
6159	>e01a		77				                .byte %01110111;$77
6160	>e01b		88				                .byte %10001000;$88
6161	>e01c		99				                .byte %10011001;$99
6162	>e01d		aa				                .byte %10101010;$AA
6163	>e01e		bb				                .byte %10111011;$BB
6164	>e01f		cc				                .byte %11001100;$CC
6165	>e020		dd				                .byte %11011101;$DD
6166	>e021		ee				                .byte %11101110;$EE
6167	>e022		ff				                .byte %11111111;$FF
6168	.e023						LE023:
6169	>e023		00				                .byte %00000000;$00
6170	>e024		55				                .byte %01010101;$55
6171	>e025		aa				                .byte %10101010;$AA
6172	>e026		ff				                .byte %11111111;$FF

6174							; VDU control code dispatch tables
6175							; ================================
6176							;
6177							; entry:
6178							;
6179							;

6181							; each routine is (address, number of additional VDU bytes)
6182	=[($c035,0)]					_:=[(vdu0EntryPoint,0)] ; VDU0
6183	=[($c035,0),($c0e2,1)]				_..=[(vdu1EntryPoint,1)] ; VDU1
6184	=[($c035,0),($c0e2,1),($c0ea,0)]		_..=[(vdu2EntryPoint,0)] ; VDU2
6185	=[($c035,0),($c0e2,1),($c0ea,0),($c0ea,0)]	_..=[(vdu3EntryPoint,0)] ; VDU3
6186	=[($c035,0),($c0e2,1),($c0ea,0),($c0ea,0),($c51e,0)]
							_..=[(vdu4EntryPoint,0)] ; VDU4
6187	=[($c035,0),($c0e2,1),($c0ea,0),($c0ea,0),($c51e,0),($c52d,0)]
							_..=[(vdu5EntryPoint,0)] ; VDU5
6188	=[($c035,0),($c0e2,1),($c0ea,0),($c0ea,0),($c51e,0),($c52d,0),($c035,0)]
							_..=[(vdu6EntryPoint,0)] ; VDU6
6189	=[($c035,0),($c0e2,1),($c0ea,0),($c0ea,0),($c51e,0),($c52d,0),($c035,0),($efb6,0)]
							_..=[(vdu7EntryPoint,0)] ; VDU7
6190	=[($c035,0),($c0e2,1),($c0ea,0),($c0ea,0),($c51e,0),($c52d,0),($c035,0),($efb6,0),($c29a,0)]
							_..=[(vdu8EntryPoint,0)] ; VDU8
6191	=[($c035,0),($c0e2,1),($c0ea,0),($c0ea,0),($c51e,0),($c52d,0),($c035,0),($efb6,0),($c29a,0),($c24c,0)]
							_..=[(vdu9EntryPoint,0)] ; VDU9
6192	=[($c035,0),($c0e2,1),($c0ea,0),($c0ea,0),($c51e,0),($c52d,0),($c035,0),($efb6,0),($c29a,0),($c24c,0),($c25b,0)]
							_..=[(vdu10EntryPoint,0)] ; VDU10
6193	=[($c035,0),($c0e2,1),($c0ea,0),($c0ea,0),($c51e,0),($c52d,0),($c035,0),($efb6,0),($c29a,0),($c24c,0),($c25b,0),($c2b1,0)]
							_..=[(vdu11EntryPoint,0)] ; VDU11
6194	=[($c035,0),($c0e2,1),($c0ea,0),($c0ea,0),($c51e,0),($c52d,0),($c035,0),($efb6,0),($c29a,0),($c24c,0),($c25b,0),($c2b1,0),($c44f,0)]
							_..=[(vdu12EntryPoint,0)] ; VDU12
6195	=[($c035,0),($c0e2,1),($c0ea,0),($c0ea,0),($c51e,0),($c52d,0),($c035,0),($efb6,0),($c29a,0),($c24c,0),($c25b,0),($c2b1,0),($c44f,0),($c3f6,0)]
							_..=[(vdu13EntryPoint,0)] ; VDU13
6196	=[($c035,0),($c0e2,1),($c0ea,0),($c0ea,0),($c51e,0),($c52d,0),($c035,0),($efb6,0),($c29a,0),($c24c,0),($c25b,0),($c2b1,0),($c44f,0),($c3f6,0),($c514,0)]
							_..=[(vdu14EntryPoint,0)] ; VDU14
6197	=[($c035,0),($c0e2,1),($c0ea,0),($c0ea,0),($c51e,0),($c52d,0),($c035,0),($efb6,0),($c29a,0),($c24c,0),($c25b,0),($c2b1,0),($c44f,0),($c3f6,0),($c514,0),($c528,0)]
							_..=[(vdu15EntryPoint,0)] ; VDU15
6198	=[($c035,0),($c0e2,1),($c0ea,0),($c0ea,0),($c51e,0),($c52d,0),($c035,0),($efb6,0),($c29a,0),($c24c,0),($c25b,0),($c2b1,0),($c44f,0),($c3f6,0),($c514,0),($c528,0),($c413,0)]
							_..=[(vdu16EntryPoint,0)] ; VDU16
6199	=[($c035,0),($c0e2,1),($c0ea,0),($c0ea,0),($c51e,0),($c52d,0),($c035,0),($efb6,0),($c29a,0),($c24c,0),($c25b,0),($c2b1,0),($c44f,0),($c3f6,0),($c514,0),($c528,0),($c413,0),($c539,1)]
							_..=[(vdu17EntryPoint,1)] ; VDU17
6200	=[($c035,0),($c0e2,1),($c0ea,0),($c0ea,0),($c51e,0),($c52d,0),($c035,0),($efb6,0),($c29a,0),($c24c,0),($c25b,0),($c2b1,0),($c44f,0),($c3f6,0),($c514,0),($c528,0),($c413,0),($c539,1),($c564,2)]
							_..=[(vdu18EntryPoint,2)] ; VDU18
6201	=[($c035,0),($c0e2,1),($c0ea,0),($c0ea,0),($c51e,0),($c52d,0),($c035,0),($efb6,0),($c29a,0),($c24c,0),($c25b,0),($c2b1,0),($c44f,0),($c3f6,0),($c514,0),($c528,0),($c413,0),($c539,1),($c564,2),($c62d,5)]
							_..=[(vdu19EntryPoint,5)] ; VDU19
6202	=[($c035,0),($c0e2,1),($c0ea,0),($c0ea,0),($c51e,0),($c52d,0),($c035,0),($efb6,0),($c29a,0),($c24c,0),($c25b,0),($c2b1,0),($c44f,0),($c3f6,0),($c514,0),($c528,0),($c413,0),($c539,1),($c564,2),($c62d,5),($c5c5,0)]
							_..=[(vdu20EntryPoint,0)] ; VDU20
6203	=[($c035,0),($c0e2,1),($c0ea,0),($c0ea,0),($c51e,0),($c52d,0),($c035,0),($efb6,0),($c29a,0),($c24c,0),($c25b,0),($c2b1,0),($c44f,0),($c3f6,0),($c514,0),($c528,0),($c413,0),($c539,1),($c564,2),($c62d,5),($c5c5,0),($c519,0)]
							_..=[(vdu21EntryPoint,0)] ; VDU21
6204	=[($c035,0),($c0e2,1),($c0ea,0),($c0ea,0),($c51e,0),($c52d,0),($c035,0),($efb6,0),($c29a,0),($c24c,0),($c25b,0),($c2b1,0),($c44f,0),($c3f6,0),($c514,0),($c528,0),($c413,0),($c539,1),($c564,2),($c62d,5),($c5c5,0),($c519,0),($c794,1)]
							_..=[(vdu22EntryPoint,1)] ; VDU22
6205	=[($c035,0),($c0e2,1),($c0ea,0),($c0ea,0),($c51e,0),($c52d,0),($c035,0),($efb6,0),($c29a,0),($c24c,0),($c25b,0),($c2b1,0),($c44f,0),($c3f6,0),($c514,0),($c528,0),($c413,0),($c539,1),($c564,2),($c62d,5),($c5c5,0),($c519,0),($c794,1),($c67c,9)]
							_..=[(vdu23EntryPoint,9)] ; VDU23
6206	=[($c035,0),($c0e2,1),($c0ea,0),($c0ea,0),($c51e,0),($c52d,0),($c035,0),($efb6,0),($c29a,0),($c24c,0),($c25b,0),($c2b1,0),($c44f,0),($c3f6,0),($c514,0),($c528,0),($c413,0),($c539,1),($c564,2),($c62d,5),($c5c5,0),($c519,0),($c794,1),($c67c,9),($c71f,8)]
							_..=[(vdu24EntryPoint,8)] ; VDU24
6207	=[($c035,0),($c0e2,1),($c0ea,0),($c0ea,0),($c51e,0),($c52d,0),($c035,0),($efb6,0),($c29a,0),($c24c,0),($c25b,0),($c2b1,0),($c44f,0),($c3f6,0),($c514,0),($c528,0),($c413,0),($c539,1),($c564,2),($c62d,5),($c5c5,0),($c519,0),($c794,1),($c67c,9),($c71f,8),($c69b,5)]
							_..=[(vdu25EntryPoint,5)] ; VDU25
6208	=[($c035,0),($c0e2,1),($c0ea,0),($c0ea,0),($c51e,0),($c52d,0),($c035,0),($efb6,0),($c29a,0),($c24c,0),($c25b,0),($c2b1,0),($c44f,0),($c3f6,0),($c514,0),($c528,0),($c413,0),($c539,1),($c564,2),($c62d,5),($c5c5,0),($c519,0),($c794,1),($c67c,9),($c71f,8),($c69b,5),($c6aa,0)]
							_..=[(vdu26EntryPoint,0)] ; VDU26
6209	=[($c035,0),($c0e2,1),($c0ea,0),($c0ea,0),($c51e,0),($c52d,0),($c035,0),($efb6,0),($c29a,0),($c24c,0),($c25b,0),($c2b1,0),($c44f,0),($c3f6,0),($c514,0),($c528,0),($c413,0),($c539,1),($c564,2),($c62d,5),($c5c5,0),($c519,0),($c794,1),($c67c,9),($c71f,8),($c69b,5),($c6aa,0),($c035,0)]
							_..=[(vdu27EntryPoint,0)] ; VDU27
6210	=[($c035,0),($c0e2,1),($c0ea,0),($c0ea,0),($c51e,0),($c52d,0),($c035,0),($efb6,0),($c29a,0),($c24c,0),($c25b,0),($c2b1,0),($c44f,0),($c3f6,0),($c514,0),($c528,0),($c413,0),($c539,1),($c564,2),($c62d,5),($c5c5,0),($c519,0),($c794,1),($c67c,9),($c71f,8),($c69b,5),($c6aa,0),($c035,0),($c3a5,4)]
							_..=[(vdu28EntryPoint,4)] ; VDU28
6211	=[($c035,0),($c0e2,1),($c0ea,0),($c0ea,0),($c51e,0),($c52d,0),($c035,0),($efb6,0),($c29a,0),($c24c,0),($c25b,0),($c2b1,0),($c44f,0),($c3f6,0),($c514,0),($c528,0),($c413,0),($c539,1),($c564,2),($c62d,5),($c5c5,0),($c519,0),($c794,1),($c67c,9),($c71f,8),($c69b,5),($c6aa,0),($c035,0),($c3a5,4),($c78a,4)]
							_..=[(vdu29EntryPoint,4)] ; VDU29
6212	=[($c035,0),($c0e2,1),($c0ea,0),($c0ea,0),($c51e,0),($c52d,0),($c035,0),($efb6,0),($c29a,0),($c24c,0),($c25b,0),($c2b1,0),($c44f,0),($c3f6,0),($c514,0),($c528,0),($c413,0),($c539,1),($c564,2),($c62d,5),($c5c5,0),($c519,0),($c794,1),($c67c,9),($c71f,8),($c69b,5),($c6aa,0),($c035,0),($c3a5,4),($c78a,4),($c47c,0)]
							_..=[(vdu30EntryPoint,0)] ; VDU30
6213	=[($c035,0),($c0e2,1),($c0ea,0),($c0ea,0),($c51e,0),($c52d,0),($c035,0),($efb6,0),($c29a,0),($c24c,0),($c25b,0),($c2b1,0),($c44f,0),($c3f6,0),($c514,0),($c528,0),($c413,0),($c539,1),($c564,2),($c62d,5),($c5c5,0),($c519,0),($c794,1),($c67c,9),($c71f,8),($c69b,5),($c6aa,0),($c035,0),($c3a5,4),($c78a,4),($c47c,0),($c482,2)]
							_..=[(vdu31EntryPoint,2)] ; VDU31
6214	=[($c035,0),($c0e2,1),($c0ea,0),($c0ea,0),($c51e,0),($c52d,0),($c035,0),($efb6,0),($c29a,0),($c24c,0),($c25b,0),($c2b1,0),($c44f,0),($c3f6,0),($c514,0),($c528,0),($c413,0),($c539,1),($c564,2),($c62d,5),($c5c5,0),($c519,0),($c794,1),($c67c,9),($c71f,8),($c69b,5),($c6aa,0),($c035,0),($c3a5,4),($c78a,4),($c47c,0),($c482,2),($ce2d,0)]
							_..=[(vdu127EntryPoint,0)] ; VDU127
6215	=[($c035,0),($c0e2,1),($c0ea,0),($c0ea,0),($c51e,0),($c52d,0),($c035,0),($efb6,0),($c29a,0),($c24c,0),($c25b,0),($c2b1,0),($c44f,0),($c3f6,0),($c514,0),($c528,0),($c413,0),($c539,1),($c564,2),($c62d,5),($c5c5,0),($c519,0),($c794,1),($c67c,9),($c71f,8),($c69b,5),($c6aa,0),($c035,0),($c3a5,4),($c78a,4),($c47c,0),($c482,2),($ce2d,0)]
							vdu_routines=_

6217							; LSB of routine address
6218	.e027						vduRoutinesLSBTable:
6219							                .for i=0,i<len(vdu_routines),i+=1
6220	>e027		35				                .byte <vdu_routines[i][0]
6220	>e028		e2				                .byte <vdu_routines[i][0]
6220	>e029		ea				                .byte <vdu_routines[i][0]
6220	>e02a		ea				                .byte <vdu_routines[i][0]
6220	>e02b		1e				                .byte <vdu_routines[i][0]
6220	>e02c		2d				                .byte <vdu_routines[i][0]
6220	>e02d		35				                .byte <vdu_routines[i][0]
6220	>e02e		b6				                .byte <vdu_routines[i][0]
6220	>e02f		9a				                .byte <vdu_routines[i][0]
6220	>e030		4c				                .byte <vdu_routines[i][0]
6220	>e031		5b				                .byte <vdu_routines[i][0]
6220	>e032		b1				                .byte <vdu_routines[i][0]
6220	>e033		4f				                .byte <vdu_routines[i][0]
6220	>e034		f6				                .byte <vdu_routines[i][0]
6220	>e035		14				                .byte <vdu_routines[i][0]
6220	>e036		28				                .byte <vdu_routines[i][0]
6220	>e037		13				                .byte <vdu_routines[i][0]
6220	>e038		39				                .byte <vdu_routines[i][0]
6220	>e039		64				                .byte <vdu_routines[i][0]
6220	>e03a		2d				                .byte <vdu_routines[i][0]
6220	>e03b		c5				                .byte <vdu_routines[i][0]
6220	>e03c		19				                .byte <vdu_routines[i][0]
6220	>e03d		94				                .byte <vdu_routines[i][0]
6220	>e03e		7c				                .byte <vdu_routines[i][0]
6220	>e03f		1f				                .byte <vdu_routines[i][0]
6220	>e040		9b				                .byte <vdu_routines[i][0]
6220	>e041		aa				                .byte <vdu_routines[i][0]
6220	>e042		35				                .byte <vdu_routines[i][0]
6220	>e043		a5				                .byte <vdu_routines[i][0]
6220	>e044		8a				                .byte <vdu_routines[i][0]
6220	>e045		7c				                .byte <vdu_routines[i][0]
6220	>e046		82				                .byte <vdu_routines[i][0]
6220	>e047		2d				                .byte <vdu_routines[i][0]
6221							                .next

6223							; If bit 7 set: MSB of routine address
6224							;
6225							; If bit 7 clear:
6226							;
6227							; Top 4 bits are bits 8-11 of routine address (bits 12-15 are %1010,
6228							; so address is $C0xx to $C7xx)
6229							;
6230							; Bottom 4 bits are ORed with $f0 and stored in $26a - -ve bytes left
6231							; in VDU queue.
6232	.e048						vduRoutinesMSBTable:
6233							                .for i=0,i<len(vdu_routines),i+=1
6234							                .if vdu_routines[i][1]==0
6235	>e048		c0				                .byte >vdu_routines[i][0]
6240							                .endif
6234							                .if vdu_routines[i][1]==0
6236							                .else
6237							                .cerror vdu_routines[i][0]<(vduRoutinesPage<<8) || vdu_routines[i][0]>(vduRoutinesPage<<8)+$7ff,format("illegal VDU routine address for VDU %d: $%04x",i,vdu_routines[i][0])
6238							                .cerror vdu_routines[i][1]<0 || vdu_routines[i][1]>15,format("illegal VDU parameter count for VDU %d: %d",i,vdu_routines[i][1])
6239	>e049		0f				                .byte (16-vdu_routines[i][1])|(((>vdu_routines[i][0])&$0f)<<4)
6240							                .endif
6234							                .if vdu_routines[i][1]==0
6235	>e04a		c0				                .byte >vdu_routines[i][0]
6240							                .endif
6234							                .if vdu_routines[i][1]==0
6235	>e04b		c0				                .byte >vdu_routines[i][0]
6240							                .endif
6234							                .if vdu_routines[i][1]==0
6235	>e04c		c5				                .byte >vdu_routines[i][0]
6240							                .endif
6234							                .if vdu_routines[i][1]==0
6235	>e04d		c5				                .byte >vdu_routines[i][0]
6240							                .endif
6234							                .if vdu_routines[i][1]==0
6235	>e04e		c0				                .byte >vdu_routines[i][0]
6240							                .endif
6234							                .if vdu_routines[i][1]==0
6235	>e04f		ef				                .byte >vdu_routines[i][0]
6240							                .endif
6234							                .if vdu_routines[i][1]==0
6235	>e050		c2				                .byte >vdu_routines[i][0]
6240							                .endif
6234							                .if vdu_routines[i][1]==0
6235	>e051		c2				                .byte >vdu_routines[i][0]
6240							                .endif
6234							                .if vdu_routines[i][1]==0
6235	>e052		c2				                .byte >vdu_routines[i][0]
6240							                .endif
6234							                .if vdu_routines[i][1]==0
6235	>e053		c2				                .byte >vdu_routines[i][0]
6240							                .endif
6234							                .if vdu_routines[i][1]==0
6235	>e054		c4				                .byte >vdu_routines[i][0]
6240							                .endif
6234							                .if vdu_routines[i][1]==0
6235	>e055		c3				                .byte >vdu_routines[i][0]
6240							                .endif
6234							                .if vdu_routines[i][1]==0
6235	>e056		c5				                .byte >vdu_routines[i][0]
6240							                .endif
6234							                .if vdu_routines[i][1]==0
6235	>e057		c5				                .byte >vdu_routines[i][0]
6240							                .endif
6234							                .if vdu_routines[i][1]==0
6235	>e058		c4				                .byte >vdu_routines[i][0]
6240							                .endif
6234							                .if vdu_routines[i][1]==0
6236							                .else
6237							                .cerror vdu_routines[i][0]<(vduRoutinesPage<<8) || vdu_routines[i][0]>(vduRoutinesPage<<8)+$7ff,format("illegal VDU routine address for VDU %d: $%04x",i,vdu_routines[i][0])
6238							                .cerror vdu_routines[i][1]<0 || vdu_routines[i][1]>15,format("illegal VDU parameter count for VDU %d: %d",i,vdu_routines[i][1])
6239	>e059		5f				                .byte (16-vdu_routines[i][1])|(((>vdu_routines[i][0])&$0f)<<4)
6240							                .endif
6234							                .if vdu_routines[i][1]==0
6236							                .else
6237							                .cerror vdu_routines[i][0]<(vduRoutinesPage<<8) || vdu_routines[i][0]>(vduRoutinesPage<<8)+$7ff,format("illegal VDU routine address for VDU %d: $%04x",i,vdu_routines[i][0])
6238							                .cerror vdu_routines[i][1]<0 || vdu_routines[i][1]>15,format("illegal VDU parameter count for VDU %d: %d",i,vdu_routines[i][1])
6239	>e05a		5e				                .byte (16-vdu_routines[i][1])|(((>vdu_routines[i][0])&$0f)<<4)
6240							                .endif
6234							                .if vdu_routines[i][1]==0
6236							                .else
6237							                .cerror vdu_routines[i][0]<(vduRoutinesPage<<8) || vdu_routines[i][0]>(vduRoutinesPage<<8)+$7ff,format("illegal VDU routine address for VDU %d: $%04x",i,vdu_routines[i][0])
6238							                .cerror vdu_routines[i][1]<0 || vdu_routines[i][1]>15,format("illegal VDU parameter count for VDU %d: %d",i,vdu_routines[i][1])
6239	>e05b		6b				                .byte (16-vdu_routines[i][1])|(((>vdu_routines[i][0])&$0f)<<4)
6240							                .endif
6234							                .if vdu_routines[i][1]==0
6235	>e05c		c5				                .byte >vdu_routines[i][0]
6240							                .endif
6234							                .if vdu_routines[i][1]==0
6235	>e05d		c5				                .byte >vdu_routines[i][0]
6240							                .endif
6234							                .if vdu_routines[i][1]==0
6236							                .else
6237							                .cerror vdu_routines[i][0]<(vduRoutinesPage<<8) || vdu_routines[i][0]>(vduRoutinesPage<<8)+$7ff,format("illegal VDU routine address for VDU %d: $%04x",i,vdu_routines[i][0])
6238							                .cerror vdu_routines[i][1]<0 || vdu_routines[i][1]>15,format("illegal VDU parameter count for VDU %d: %d",i,vdu_routines[i][1])
6239	>e05e		7f				                .byte (16-vdu_routines[i][1])|(((>vdu_routines[i][0])&$0f)<<4)
6240							                .endif
6234							                .if vdu_routines[i][1]==0
6236							                .else
6237							                .cerror vdu_routines[i][0]<(vduRoutinesPage<<8) || vdu_routines[i][0]>(vduRoutinesPage<<8)+$7ff,format("illegal VDU routine address for VDU %d: $%04x",i,vdu_routines[i][0])
6238							                .cerror vdu_routines[i][1]<0 || vdu_routines[i][1]>15,format("illegal VDU parameter count for VDU %d: %d",i,vdu_routines[i][1])
6239	>e05f		67				                .byte (16-vdu_routines[i][1])|(((>vdu_routines[i][0])&$0f)<<4)
6240							                .endif
6234							                .if vdu_routines[i][1]==0
6236							                .else
6237							                .cerror vdu_routines[i][0]<(vduRoutinesPage<<8) || vdu_routines[i][0]>(vduRoutinesPage<<8)+$7ff,format("illegal VDU routine address for VDU %d: $%04x",i,vdu_routines[i][0])
6238							                .cerror vdu_routines[i][1]<0 || vdu_routines[i][1]>15,format("illegal VDU parameter count for VDU %d: %d",i,vdu_routines[i][1])
6239	>e060		78				                .byte (16-vdu_routines[i][1])|(((>vdu_routines[i][0])&$0f)<<4)
6240							                .endif
6234							                .if vdu_routines[i][1]==0
6236							                .else
6237							                .cerror vdu_routines[i][0]<(vduRoutinesPage<<8) || vdu_routines[i][0]>(vduRoutinesPage<<8)+$7ff,format("illegal VDU routine address for VDU %d: $%04x",i,vdu_routines[i][0])
6238							                .cerror vdu_routines[i][1]<0 || vdu_routines[i][1]>15,format("illegal VDU parameter count for VDU %d: %d",i,vdu_routines[i][1])
6239	>e061		6b				                .byte (16-vdu_routines[i][1])|(((>vdu_routines[i][0])&$0f)<<4)
6240							                .endif
6234							                .if vdu_routines[i][1]==0
6235	>e062		c6				                .byte >vdu_routines[i][0]
6240							                .endif
6234							                .if vdu_routines[i][1]==0
6235	>e063		c0				                .byte >vdu_routines[i][0]
6240							                .endif
6234							                .if vdu_routines[i][1]==0
6236							                .else
6237							                .cerror vdu_routines[i][0]<(vduRoutinesPage<<8) || vdu_routines[i][0]>(vduRoutinesPage<<8)+$7ff,format("illegal VDU routine address for VDU %d: $%04x",i,vdu_routines[i][0])
6238							                .cerror vdu_routines[i][1]<0 || vdu_routines[i][1]>15,format("illegal VDU parameter count for VDU %d: %d",i,vdu_routines[i][1])
6239	>e064		3c				                .byte (16-vdu_routines[i][1])|(((>vdu_routines[i][0])&$0f)<<4)
6240							                .endif
6234							                .if vdu_routines[i][1]==0
6236							                .else
6237							                .cerror vdu_routines[i][0]<(vduRoutinesPage<<8) || vdu_routines[i][0]>(vduRoutinesPage<<8)+$7ff,format("illegal VDU routine address for VDU %d: $%04x",i,vdu_routines[i][0])
6238							                .cerror vdu_routines[i][1]<0 || vdu_routines[i][1]>15,format("illegal VDU parameter count for VDU %d: %d",i,vdu_routines[i][1])
6239	>e065		7c				                .byte (16-vdu_routines[i][1])|(((>vdu_routines[i][0])&$0f)<<4)
6240							                .endif
6234							                .if vdu_routines[i][1]==0
6235	>e066		c4				                .byte >vdu_routines[i][0]
6240							                .endif
6234							                .if vdu_routines[i][1]==0
6236							                .else
6237							                .cerror vdu_routines[i][0]<(vduRoutinesPage<<8) || vdu_routines[i][0]>(vduRoutinesPage<<8)+$7ff,format("illegal VDU routine address for VDU %d: $%04x",i,vdu_routines[i][0])
6238							                .cerror vdu_routines[i][1]<0 || vdu_routines[i][1]>15,format("illegal VDU parameter count for VDU %d: %d",i,vdu_routines[i][1])
6239	>e067		4e				                .byte (16-vdu_routines[i][1])|(((>vdu_routines[i][0])&$0f)<<4)
6240							                .endif
6234							                .if vdu_routines[i][1]==0
6235	>e068		ce				                .byte >vdu_routines[i][0]
6240							                .endif
6241							                .next

6243							;-------------------------------------------------------------------------
6244							;
6245							; entry:
6246							;
6247							; C=0
6248							;
6249							; A = vdu 23 code
6250							;
6251							; VDU queue = the full 9 bytes of the VDU 23
6252							;
6253	.e069						vdu23EntryPointTable:
6254	>e069		fb ce				                .word vdu23_0_EntryPoint
6255	>e06b		2b cf				                .word vdu23_1_EntryPoint
6256	>e06d		57 cf				                .word vdu23_2_EntryPoint
6257	>e06f		57 cf				                .word vdu23_3_EntryPoint
6258	>e071		57 cf				                .word vdu23_4_EntryPoint
6259	>e073		57 cf				                .word vdu23_5_EntryPoint
6260	>e075		df cf				                .word vdu23_6_EntryPoint
6261	>e077		e6 cf				                .word vdu23_7_EntryPoint
6262	>e079		69 d0				                .word vdu23_8_EntryPoint
6263	>e07b		0f d1				                .word vdu23_9_EntryPoint
6264	>e07d		10 d1				                .word vdu23_10_EntryPoint
6265	>e07f		6d cf				                .word vdu23_11_EntryPoint
6266	>e081		96 cf				                .word vdu23_12_EntryPoint
6267	>e083		96 cf				                .word vdu23_13_EntryPoint
6268	>e085		96 cf				                .word vdu23_14_EntryPoint
6269	>e087		96 cf				                .word vdu23_15_EntryPoint
6270	>e089		1e d1				                .word vdu23_16_EntryPoint

6272							;-------------------------------------------------------------------------
6273							;
6274							; entry:
6275							;
6276							; A = plot number
6277							;
6278	.e08b						plotEntryPointTable:
6279	>e08b		4a db				                .word plotPoint    ;64â<80><93>71 = Plot point [MasRef E.3-24]
6280	>e08d		6c dc				                .word plotHorizontalLineFill ;72â<80><93>79 = Horizontal line fill (left and right to non-background) [MasRef E.3-24]
6281	>e08f		f7 9b				                .word terminal.L9BF7 ;80â<80><93>87 = Plot triangle [MasRef E.3-25]
6282	>e091		75 dc				                .word plotHorizontalLineFillRight ;88â<80><93>95 = Horizontal line fill (right to background) [MasRef E.3-25]
6283	>e093		48 c4				                .word LC448 ;96â<80><93>103 = Plot rectangle [MasRef E.3-26]
6284	>e095		6c dc				                .word plotHorizontalLineFill ;104â<80><93>111 = Horizontal line fill (left and right to foreground) [MasRef E.3-26]
6285	>e097		a3 9b				                .word terminal.plotParallelogram ;112â<80><93>119 = Plot parallelogram [MasRef E.3-27]
6286	>e099		75 dc				                .word plotHorizontalLineFillRight ;120â<80><93>127 = Horizontal line fill (right to non-foreground) [MasRef E.3-27]
6287	>e09b		f9 9c				                .word terminal.L9CF9 ;128â<80><93>135 = Flood fill to non-background [MasRef E.3-28]
6288	>e09d		f9 9c				                .word terminal.L9CF9 ;136â<80><93>143 = Flood fill to foreground [MasRef E.3-28]
6289	>e09f		a4 99				                .word terminal.L99A4 ;144â<80><93>151 = Plot circle outline [MasRef E.3-28]
6290	>e0a1		44 99				                .word terminal.L9944 ;152â<80><93>159 = Plot filled circle [MasRef E.3-29]
6291	>e0a3		99 99				                .word terminal.L9999 ;160â<80><93>167 = Plot circular arc [MasRef E.3-29]
6292	>e0a5		35 99				                .word terminal.L9935 ;168â<80><93>175 = Plot filled chord segment [MasRef E.3-30]
6293	>e0a7		23 99				                .word terminal.L9923 ;176â<80><93>183 = Plot filled sector [MasRef E.3-30]
6294	>e0a9		df df				                .word plotMoveOrCopyRectangle ;184â<80><93>191 = Move/copy rectangle [MasRef E.3-31]
6295	>e0ab		e9 df				                .word plotEllipseOutline ;192â<80><93>199 = Plot ellipse outline [MasRef E.3-32]
6296	>e0ad		f4 df				                .word plotSolidEllipse ;200â<80><93>207 = Plot solid ellipse [MasRef E.3-32]

6298							; Times 40 lookup table, high bytes
6299	.e0af						multiplyBy40TableHigh:
6300							                .for i=0,i<25,i+=1
6301	>e0af		00				                .byte >i*40
6301	>e0b0		00				                .byte >i*40
6301	>e0b1		00				                .byte >i*40
6301	>e0b2		00				                .byte >i*40
6301	>e0b3		00				                .byte >i*40
6301	>e0b4		00				                .byte >i*40
6301	>e0b5		00				                .byte >i*40
6301	>e0b6		01				                .byte >i*40
6301	>e0b7		01				                .byte >i*40
6301	>e0b8		01				                .byte >i*40
6301	>e0b9		01				                .byte >i*40
6301	>e0ba		01				                .byte >i*40
6301	>e0bb		01				                .byte >i*40
6301	>e0bc		02				                .byte >i*40
6301	>e0bd		02				                .byte >i*40
6301	>e0be		02				                .byte >i*40
6301	>e0bf		02				                .byte >i*40
6301	>e0c0		02				                .byte >i*40
6301	>e0c1		02				                .byte >i*40
6301	>e0c2		02				                .byte >i*40
6301	>e0c3		03				                .byte >i*40
6301	>e0c4		03				                .byte >i*40
6301	>e0c5		03				                .byte >i*40
6301	>e0c6		03				                .byte >i*40
6301	>e0c7		03				                .byte >i*40
6302							                .next

6304							; Times 40 lookup table, low bytes
6305	.e0c8						multiplyBy40TableLow:
6306							                .for i=0,i<25,i+=1
6307	>e0c8		00				                .byte <i*40
6307	>e0c9		28				                .byte <i*40
6307	>e0ca		50				                .byte <i*40
6307	>e0cb		78				                .byte <i*40
6307	>e0cc		a0				                .byte <i*40
6307	>e0cd		c8				                .byte <i*40
6307	>e0ce		f0				                .byte <i*40
6307	>e0cf		18				                .byte <i*40
6307	>e0d0		40				                .byte <i*40
6307	>e0d1		68				                .byte <i*40
6307	>e0d2		90				                .byte <i*40
6307	>e0d3		b8				                .byte <i*40
6307	>e0d4		e0				                .byte <i*40
6307	>e0d5		08				                .byte <i*40
6307	>e0d6		30				                .byte <i*40
6307	>e0d7		58				                .byte <i*40
6307	>e0d8		80				                .byte <i*40
6307	>e0d9		a8				                .byte <i*40
6307	>e0da		d0				                .byte <i*40
6307	>e0db		f8				                .byte <i*40
6307	>e0dc		20				                .byte <i*40
6307	>e0dd		48				                .byte <i*40
6307	>e0de		70				                .byte <i*40
6307	>e0df		98				                .byte <i*40
6307	>e0e0		c0				                .byte <i*40
6308							                .next

6310							; Times 640 lookup table, high bytes
6311	.e0e1						multiplyBy640TableHigh:
6312							                .for i=0,i<32,i+=1
6313	>e0e1		00				                .byte >i*640
6313	>e0e2		02				                .byte >i*640
6313	>e0e3		05				                .byte >i*640
6313	>e0e4		07				                .byte >i*640
6313	>e0e5		0a				                .byte >i*640
6313	>e0e6		0c				                .byte >i*640
6313	>e0e7		0f				                .byte >i*640
6313	>e0e8		11				                .byte >i*640
6313	>e0e9		14				                .byte >i*640
6313	>e0ea		16				                .byte >i*640
6313	>e0eb		19				                .byte >i*640
6313	>e0ec		1b				                .byte >i*640
6313	>e0ed		1e				                .byte >i*640
6313	>e0ee		20				                .byte >i*640
6313	>e0ef		23				                .byte >i*640
6313	>e0f0		25				                .byte >i*640
6313	>e0f1		28				                .byte >i*640
6313	>e0f2		2a				                .byte >i*640
6313	>e0f3		2d				                .byte >i*640
6313	>e0f4		2f				                .byte >i*640
6313	>e0f5		32				                .byte >i*640
6313	>e0f6		34				                .byte >i*640
6313	>e0f7		37				                .byte >i*640
6313	>e0f8		39				                .byte >i*640
6313	>e0f9		3c				                .byte >i*640
6313	>e0fa		3e				                .byte >i*640
6313	>e0fb		41				                .byte >i*640
6313	>e0fc		43				                .byte >i*640
6313	>e0fd		46				                .byte >i*640
6313	>e0fe		48				                .byte >i*640
6313	>e0ff		4b				                .byte >i*640
6313	>e100		4d				                .byte >i*640
6314							                .next

6316							;-------------------------------------------------------------------------

6318	.e101						modeMaxRow:
6319	>e101		1f				                .byte 31                     ;MODE 0 = 32 rows
6320	>e102		1f				                .byte 31                     ;MODE 1 = 32 rows
6321	>e103		1f				                .byte 31                     ;MODE 2 = 32 rows
6322	>e104		18				                .byte 24                     ;MODE 3 = 25 rows
6323	>e105		1f				                .byte 31                     ;MODE 4 = 32 rows
6324	>e106		1f				                .byte 31                     ;MODE 5 = 32 rows
6325	>e107		18				                .byte 24                     ;MODE 6 = 25 rows
6326	>e108		18				                .byte 24                     ;MODE 7 = 25 rows

6328							;-------------------------------------------------------------------------

6330	.e109						modeMaxColumn:
6331	>e109		4f				                .byte 79                     ;MODE 0 = 80 columns
6332	>e10a		27				                .byte 39                     ;MODE 1 = 40 columns
6333	>e10b		13				                .byte 19                     ;MODE 2 = 20 columns
6334	>e10c		4f				                .byte 79                     ;MODE 3 = 80 columns
6335	>e10d		27				                .byte 39                     ;MODE 4 = 40 columns
6336	>e10e		13				                .byte 19                     ;MODE 5 = 20 columns
6337	>e10f		27				                .byte 39                     ;MODE 6 = 40 columns
6338	>e110		27				                .byte 39                     ;MODE 7 = 40 columns

6340							;-------------------------------------------------------------------------

6342	.e111						vcontrolForScreenMODE:
6343	>e111		9c				                .byte VCONTROL.cursorX___|VCONTROL.crtc2MHz|VCONTROL.shift16MHz ; $9C - MODE 0
6344	>e112		d8				                .byte VCONTROL.cursorXX__|VCONTROL.crtc2MHz|VCONTROL.shift8MHz ; $d8 - MODE 1
6345	>e113		f4				                .byte VCONTROL.cursorXXXX|VCONTROL.crtc2MHz|VCONTROL.shift4MHz ; $F4 - MODE 2
6346	>e114		9c				                .byte VCONTROL.cursorX___|VCONTROL.crtc2MHz|VCONTROL.shift16MHz ; $9C - MODE 3
6347	>e115		88				                .byte VCONTROL.cursorX___|VCONTROL.crtc1MHz|VCONTROL.shift8MHz ; $88 - MODE 4
6348	>e116		c4				                .byte VCONTROL.cursorXX__|VCONTROL.crtc1MHz|VCONTROL.shift4MHz ; $C4 - MODE 5
6349	>e117		88				                .byte VCONTROL.cursorX___|VCONTROL.crtc1MHz|VCONTROL.shift8MHz ; $88 - MODE 6
6350	>e118		4b				                .byte VCONTROL.cursor_X__|VCONTROL.crtc1MHz|VCONTROL.shift8MHz|VCONTROL.isTeletext|VCONTROL.flash ; $4B - MODE 7

6352							;-------------------------------------------------------------------------

6354	.e119						bytesPerCharacterForMODE:
6355	>e119		08				                .byte 8                      ;MODE 0
6356	>e11a		10				                .byte 16                     ;MODE 1
6357	>e11b		20				                .byte 32                     ;MODE 2
6358	>e11c		08				                .byte 8                      ;MODE 3
6359	>e11d		08				                .byte 8                      ;MODE 4
6360	>e11e		10				                .byte 16                     ;MODE 5
6361	>e11f		08				                .byte 8                      ;MODE 6
6362	.e120						LE120:
6363	>e120		01				                .byte %00000001              ;MODE 7
6364	>e121		ff				                .byte %11111111
6365	>e122		55				                .byte %01010101
6366	>e123		ff				                .byte %11111111
6367	>e124		77				                .byte %01110111
6368	>e125		33				                .byte %00110011
6369	>e126		11				                .byte %00010001

6371							;-------------------------------------------------------------------------

6373	.e127						distanceMasksTable:
6374	>e127		ff				                .byte %11111111
6375	>e128		7f				                .byte %01111111
6376	>e129		3f				                .byte %00111111
6377	>e12a		1f				                .byte %00011111
6378	>e12b		0f				                .byte %00001111
6379	>e12c		07				                .byte %00000111
6380	>e12d		03				                .byte %00000011
6381	>e12e		01				                .byte %00000001

6383							;-------------------------------------------------------------------------
6384							;
6385							; These graphics tables often overlap. I haven't always bothered
6386							; commenting the MODEs for the MODE-indexed tables, as even those
6387							; sometimes overlap.
6388							;
6389							;------------------------------------------------------------------------

6391							;-------------------------------------------------------------------------
6392							;
6393							; This is 3 tables in one. Use the numberOfLogicalColoursMinusOne VDU
6394							; variable to access it:
6395							; pixelMasks[(numberOfLogicalColoursMinusOne&7)-1+colour&numberOfLogicalColoursMinusOne=
6396							;
6397	.e12f						pixelMasks:
6398	>e12f		aa				                .byte %10101010
6399	>e130		55				                .byte %01010101

6401	>e131		88				                .byte %10001000
6402	>e132		44				                .byte %01000100
6403	>e133		22				                .byte %00100010
6404	>e134		11				                .byte %00010001

6406	>e135		80				                .byte %10000000
6407	>e136		40				                .byte %01000000
6408	>e137		20				                .byte %00100000
6409	>e138		10				                .byte %00010000
6410	>e139		08				                .byte %00001000
6411	>e13a		04				                .byte %00000100
6412	>e13b		02				                .byte %00000010
6413	.e13c						numberOfLogicalColoursMinusOneForMODE:
6414	>e13c		01				                .byte %00000001              ;MODE 0 (also part of pixelMasks)
6415	>e13d		03				                .byte 3                      ;MODE 1
6416	>e13e		0f				                .byte 15                     ;MODE 2
6417	>e13f		01				                .byte 1                      ;MODE 3
6418	>e140		01				                .byte 1                      ;MODE 4
6419	>e141		03				                .byte 3                      ;MODE 5
6420	>e142		01				                .byte 1                      ;MODE 6
6421							                ; MODE 7 value (0) is in next table

6423							;-------------------------------------------------------------------------
6424							;
6425							; Overwrite: ZGORA=$ff, ZGEOR=$ff
6426							; OR: ZGORA=value, ZGEOR=$00
6427							; AND: ZGORA=~value, ZGEOR=$00
6428							; EOR: ZGORA=$00, ZGEOR=value
6429							; Invert: ZGORA=$00, ZGEOR=$ff
6430							; Leave: ZGORA=$00, ZGEOR=$ff
6431							;
6432	.e143						zgeorORTable:
6433	>e143		00				                .byte $00
6434	.e144						zgoraORTable:
6435	>e144		ff				                .byte $FF
6436	.e145						zgoraEORTable:
6437	>e145		00				                .byte $00
6438	>e146		00				                .byte $00
6439	>e147		ff				                .byte $FF
6440	.e148						zgeorEORTable:
6441	>e148		ff				                .byte $FF
6442	>e149		ff				                .byte $FF
6443	>e14a		ff				                .byte $FF
6444	>e14b		00				                .byte $00

6446							;-------------------------------------------------------------------------
6447							;
6448							; Index using logical colour value to get a byte with that colour
6449							; value in every pixel.
6450							;
6451							; This is 3 tables in one. Use the numberOfLogicalColoursMinusOne VDU
6452							; variable to access it:
6453							; solidColoursTable[(numberOfLogicalColoursMinusOne&7)-1+colour&numberOfLogicalColoursMinusOne=
6454							;
6455	.e14c						solidColoursTable:

6457							                ; 1 bpp
6458	>e14c		00				                .byte %00000000
6459	>e14d		ff				                .byte %11111111

6461							                ; 2 bpp
6462	>e14e		00				                .byte %00000000
6463	>e14f		0f				                .byte %00001111
6464	>e150		f0				                .byte %11110000
6465	>e151		ff				                .byte %11111111

6467							                ; 4 bpp
6468	>e152		00				                .byte %00000000
6469	>e153		03				                .byte %00000011
6470	>e154		0c				                .byte %00001100
6471	>e155		0f				                .byte %00001111
6472	>e156		30				                .byte %00110000
6473	>e157		33				                .byte %00110011
6474	>e158		3c				                .byte %00111100
6475	>e159		3f				                .byte %00111111
6476	>e15a		c0				                .byte %11000000
6477	>e15b		c3				                .byte %11000011
6478	>e15c		cc				                .byte %11001100
6479	>e15d		cf				                .byte %11001111
6480	>e15e		f0				                .byte %11110000
6481	>e15f		f3				                .byte %11110011
6482	>e160		fc				                .byte %11111100
6483	>e161		ff				                .byte %11111111

6485	.e162						pixelsPerByteMinusOneForMODE:
6486	>e162		07				                .byte 7
6487	>e163		03				                .byte 3
6488	>e164		01				                .byte 1
6489	.e165						LE165:
6490	>e165		00				                .byte 0
6491	>e166		07				                .byte 7
6492	>e167		03				                .byte 3
6493	.e168						screenMODEGroupForMODE:
6494	>e168		00				                .byte 0
6495	>e169		00				                .byte 0
6496	.e16a		00		brk #		                brk
6497	.e16b		01 02		ora ($02,x)	                ora ($02,x)
6498	>e16d		02				                .byte $02
6499	>e16e		03				                .byte $03
6500							;TSB &0D          :\ E16F= 04 0D       ..
6501	>e16f		04				                .byte $04

6503							;-------------------------------------------------------------------------
6504							;
6505							; Hardware scrolling wraparound size settings for screen mode group.
6506							;
6507							; The values for group 4 (1 KB) are bogus - the Mode 7 addressing
6508							; wraparound is handled differently.
6509							;
6510	.e170						latchBit5ForScreenMODEGroup:
6511	>e170		0d				                .byte 5|8                    ;20 KB
6512	>e171		05				                .byte 5|0                    ;16 KB
6513	>e172		0d				                .byte 5|8                    ;10 KB
6514	>e173		05				                .byte 5|0                    ; 8 KB
6515	.e174						latchBit4ForScreenMODEGroup:
6516	>e174		04				                .byte 4|0                    ;20 KB (also benign value for 1 KB)
6517	>e175		04				                .byte 4|0                    ;16 KB
6518	>e176		0c				                .byte 4|8                    ;10 KB
6519	>e177		0c				                .byte 4|8                    ; 8 KB
6520	>e178		04				                .byte 4|0                    ;(benign value for 1 KB)

6522							;-------------------------------------------------------------------------

6524	.e179						screenSizeHighByteForScreenMODEGroup:
6525	>e179		50				                .byte $50
6526	>e17a		40				                .byte $40
6527	>e17b		28				                .byte $28
6528	>e17c		20				                .byte $20
6529	>e17d		04				                .byte $04
6530	.e17e						startScreenAddressHighByteForScreenMODEGroup:
6531	>e17e		30				                .byte $30
6532	>e17f		40				                .byte $40
6533	>e180		58				                .byte $58
6534	>e181		60				                .byte $60
6535	>e182		7c				                .byte $7c
6536	.e183						crtcRegisterLastIndexForScreenMODEGroup:
6537	>e183		0b				                .byte (crtcRegisterValues20KB-crtcRegisterValues)+$0B
6538	>e184		17				                .byte (crtcRegisterValues16KB-crtcRegisterValues)+$0B
6539	>e185		23				                .byte (crtcRegisterValues10KB-crtcRegisterValues)+$0B
6540	>e186		2f				                .byte (crtcRegisterValues8KB-crtcRegisterValues)+$0B
6541	>e187		3b				                .byte (crtcRegisterValues1KB-crtcRegisterValues)+$0B
6542	.e188						crtcRegisterValues:
6543	.e188						crtcRegisterValues20KB:                   ;MODEs 0/1/2
6544	>e188		7f				                .byte $7F            ;R0 - Horizontal Total
6545	>e189		50				                .byte $50            ;R1 - Horizontal Displayed
6546	>e18a		62				                .byte $62            ;R2 - Horizontal Sync
6547	>e18b		28				                .byte $28            ;R3 - Sync Width (%vvvvhhhh)
6548	>e18c		26				                .byte $26            ;R4 - Vertical Total
6549	>e18d		00				                .byte $00            ;R5 - Vertical Total Adjust
6550	>e18e		20				                .byte $20            ;R6 - Vertical Displayed
6551	>e18f		22				                .byte $22            ;R7 - Vertical Sync Position
6552	>e190		01				                .byte CRTC.R8.cursorDelay0|CRTC.R8.displayDelay0|CRTC.R8.interlaceSync ;R8 - Interlace/Delay
6553	>e191		07				                .byte $07               ;R9 - Scan lines per character
6554	>e192		67				                .byte CRTC.R10.blink|CRTC.R10.slowBlink|7 ;R10 - Cursor blink/start
6555	>e193		08				                .byte 8                    ;R11 - Cursor End
6556	.e194						crtcRegisterValues16KB:                    ;MODE 3
6557	>e194		7f				                .byte $7F                 ;R0 - Horizontal Total
6558	>e195		50				                .byte $50                 ;R1 - Horizontal Displayed
6559	>e196		62				                .byte $62                 ;R2 - Horizontal Sync
6560	>e197		28				                .byte $28                 ;R3 - Sync Width (%vvvvhhhh)
6561	>e198		1e				                .byte $1e                 ;R4 - Vertical Total
6562	>e199		02				                .byte $02                 ;R5 - Vertical Total Adjust
6563	>e19a		19				                .byte $19                 ;R6 - Vertical Displayed
6564	>e19b		1b				                .byte $1B                 ;R7 - Vertical Sync Position
6565	>e19c		01				                .byte CRTC.R8.cursorDelay0|CRTC.R8.displayDelay0|CRTC.R8.interlaceSync ;R8 - Interlace/Delay
6566	>e19d		09				                .byte $09               ;R9 - Scan lines per character
6567	>e19e		67				                .byte CRTC.R10.blink|CRTC.R10.slowBlink|7 ;R10 - Cursor blink/start
6568	>e19f		09				                .byte 9                      ;R11 - Cursor End
6569	.e1a0						crtcRegisterValues10KB:                      ;MODEs 4/5
6570	>e1a0		3f				                .byte $3f                 ;R0 - Horizontal Total
6571	>e1a1		28				                .byte $28                 ;R1 - Horizontal Displayed
6572	>e1a2		31				                .byte $31                 ;R2 - Horizontal Sync
6573	>e1a3		24				                .byte $24                 ;R3 - Sync Width (%vvvvhhhh)
6574	>e1a4		26				                .byte $26                 ;R4 - Vertical Total
6575	>e1a5		00				                .byte $00                 ;R5 - Vertical Total Adjust
6576	>e1a6		20				                .byte $20                 ;R6 - Vertical Displayed
6577	>e1a7		22				                .byte $22                 ;R7 - Vertical Sync Position
6578	>e1a8		01				                .byte CRTC.R8.cursorDelay0|CRTC.R8.displayDelay0|CRTC.R8.interlaceSync ;R8 - Interlace/Delay
6579	>e1a9		07				                .byte $07               ;R9 - Scan lines per character
6580	>e1aa		67				                .byte CRTC.R10.blink|CRTC.R10.slowBlink|7 ;R10 - Cursor blink/start
6581	>e1ab		08				                .byte 8                      ;R11 - Cursor End
6582	.e1ac						crtcRegisterValues8KB:                       ;MODE 6
6583	>e1ac		3f				                .byte $3F                 ;R0 - Horizontal Total
6584	>e1ad		28				                .byte $28                 ;R1 - Horizontal Displayed
6585	>e1ae		31				                .byte $31                 ;R2 - Horizontal Sync
6586	>e1af		24				                .byte $24                 ;R3 - Sync Width (%vvvvhhhh)
6587	>e1b0		1e				                .byte $1e                 ;R4 - Vertical Total
6588	>e1b1		02				                .byte $02                 ;R5 - Vertical Total Adjust
6589	>e1b2		19				                .byte $19                 ;R6 - Vertical Displayed
6590	>e1b3		1b				                .byte $1B                 ;R7 - Vertical Sync Position
6591	>e1b4		01				                .byte CRTC.R8.cursorDelay0|CRTC.R8.displayDelay0|CRTC.R8.interlaceSync ;R8 - Interlace/Delay
6592	>e1b5		09				                .byte $09               ;R9 - Scan lines per character
6593	>e1b6		67				                .byte CRTC.R10.blink|CRTC.R10.slowBlink|7 ;R10 - Cursor blink/start
6594	>e1b7		09				                .byte 9                      ;R11 - Cursor End
6595	.e1b8						crtcRegisterValues1KB:                       ;MODE 7
6596	>e1b8		3f				                .byte $3f                 ;R0 - Horizontal Total
6597	>e1b9		28				                .byte $28                 ;R1 - Horizontal Displayed
6598	>e1ba		33				                .byte $33                 ;R2 - Horizontal Sync
6599	>e1bb		24				                .byte $24                 ;R3 - Sync Width (%vvvvhhhh)
6600	>e1bc		1e				                .byte $1e                 ;R4 - Vertical Total
6601	>e1bd		02				                .byte $02                 ;R5 - Vertical Total Adjust
6602	>e1be		19				                .byte $19                 ;R6 - Vertical Displayed
6603	>e1bf		1b				                .byte $1b                 ;R7 - Vertical Sync Position
6604	>e1c0		93				                .byte CRTC.R8.cursorDelay2|CRTC.R8.displayDelay1|CRTC.R8.interlaceSyncAndVideo ;R8 - Interlace/Delay
6605	>e1c1		12				                .byte $12               ;R9 - Scan lines per character
6606	>e1c2		72				                .byte CRTC.R10.blink|CRTC.R10.slowBlink|18 ;R10 - Cursor blink/start
6607	>e1c3		13				                .byte 19                     ;R11 - Cursor End

6609							;-------------------------------------------------------------------------
6610							;
6611							; Default ECF patterns [MasRef E.3-16]
6612							;
6613							; Only half the pattern is stored. Each pattern repeats every 4
6614							; scanlines.
6615							;
6616	.e1c4						defaultECFPatterns:
6617							                ; MODE 4
6618	>e1c4		aa 00 aa 00			                .byte $aa,$00,$aa,$00        ;1 - Dark grey
6619	>e1c8		aa 55 aa 55			                .byte $aa,$55,$aa,$55        ;2 - Grey
6620	>e1cc		ff 55 ff 55			                .byte $ff,$55,$ff,$55        ;3 - Light grey
6621	>e1d0		11 22 44 88			                .byte $11,$22,$44,$88        ;4 - Hatching

6623							                ; MODE 1/5
6624	>e1d4		a5 0f a5 0f			                .byte $a5,$0f,$a5,$0f        ;1 - Red-orange
6625	>e1d8		a5 5a a5 5a			                .byte $a5,$5a,$a5,$5a        ;2 - Orange
6626	>e1dc		f0 5a f0 5a			                .byte $f0,$5a,$f0,$5a        ;3 - Yellow-orange
6627	>e1e0		f5 fa f5 fa			                .byte $f5,$fa,$f5,$fa        ;4 - Cream

6629							                ; MODE 2
6630	>e1e4		0b 07 0b 07			                .byte $0b,$07,$0b,$07        ;1 - Orange
6631	>e1e8		23 13 23 13			                .byte $23,$13,$23,$13        ;2 - Pink
6632	>e1ec		0e 0d 0e 0d			                .byte $0e,$0d,$0e,$0d        ;3 - Yellow-green
6633	>e1f0		1f 2f 1f 2f			                .byte $1f,$2f,$1f,$2f        ;4 - Cream

6635							                ; MODE 0
6636	>e1f4		cc 00 cc 00			                .byte $cc,$00,$cc,$00        ;0 - Dark grey
6637	>e1f8		cc 33 cc 33			                .byte $cc,$33,$cc,$33        ;1 - Grey
6638	>e1fc		ff 33 ff 33			                .byte $ff,$33,$ff,$33        ;2 - Light grey
6639	>e200		03 0c 30 c0			                .byte $03,$0c,$30,$c0        ;4 - Hatching

6641	.e204						LE204:
6642	>e204		01				                .byte $01                    ;---
6643	>e205		01				                .byte $01                    ;--h
6644	>e206		03				                .byte $03                    ;-v-
6645	>e207		03				                .byte $03                    ;-vh
6646	>e208		02				                .byte $02                    ;x--
6647	>e209		00				                .byte $00                    ;x-h
6648	>e20a		02				                .byte $02                    ;xv-
6649	>e20b		00				                .byte $00                    ;xvh

6651	.e20c						scrollRoutinesTable:
6652	>e20c		5f c9				                .word LC95F
6653	>e20e		6b c9				                .word LC96B
6654	>e210		5f c9				                .word LC95F
6655	>e212		6b c9				                .word LC96B
6656	>e214		9d c9				                .word LC99D
6657	>e216		9d c9				                .word LC99D
6658	>e218		a4 c9				                .word LC9A4
6659	>e21a		a4 c9				                .word LC9A4
6660	>e21c		c3 c9				                .word LC9C3
6661	>e21e		2d ca				                .word LCA2D
6662	>e220		c3 c9				                .word LC9C3
6663	>e222		2d ca				                .word LCA2D
6664	>e224		f1 ca				                .word LCAF1
6665	>e226		f1 ca				                .word LCAF1
6666	>e228		fa ca				                .word LCAFA
6667	>e22a		fa ca				                .word LCAFA

6669							;-------------------------------------------------------------------------
6670							;
6671							; Get address of soft character definition.
6672							;
6673							; entry:
6674							;
6675							; A = character (32-255)
6676							;
6677							; exit:
6678							;
6679							; (ZTEMPC) = address
6680							;
6681	.e22c						getSoftCharacterDefinitionAddress:
6682	.e22c		0a		asl a		                asl a                        ;a bcdefgh0
6683	.e22d		2a		rol a		                rol a                        ;b cdefgh0a
6684	.e22e		2a		rol a		                rol a                        ;c defgh0ab
6685	.e22f		a8		tay		                tay
6686	.e230		29 03		and #$03	                and #$03                     ;c 000000ab
6687	.e232		2a		rol a		                rol a                        ;0 00000abc
6688	.e233		69 88		adc #$88	                adc #(>andy.softCharacterDefinitions)-1
6689	.e235		85 df		sta $df		                sta ZTEMPC+1
6690	.e237		98		tya		                tya                          ;0 defgh0ab
6691	.e238		29 f8		and #$f8	                and #$F8                     ;0 defgh000
6692	.e23a		85 de		sta $de		                sta ZTEMPC+0
6693	.e23c		60		rts		                rts                          ;

6695							;-------------------------------------------------------------------------
6696							;
6697							; OSBYTE 165 (&A5) Read output cursor position [MasRef D.2-50]
6698							;
6699	.e23d						osbyteA5:
6700	.e23d		20 ab f3	jsr $f3ab	                jsr withMOSROM
6701	.e240		24 d0		bit $d0		                bit STATE
6702	.e242		50 0e		bvc $e252	                bvc getTextCursorPositionWithColumn81                    ;taken if cursor editing
6703	.e244		20 ae e2	jsr $e2ae	                jsr exchangeEditCursorPositionAndTextCursorPosition
6704	.e247		20 52 e2	jsr $e252	                jsr getTextCursorPositionWithColumn81
6705	.e24a		da		phx		                phx
6706	.e24b		5a		phy		                phy
6707	.e24c		20 ae e2	jsr $e2ae	                jsr exchangeEditCursorPositionAndTextCursorPosition
6708	.e24f		7a		ply		                ply
6709	.e250		fa		plx		                plx
6710	.e251		60		rts		                rts

6712							;-------------------------------------------------------------------------
6713							;
6714							; Get text cursor position, taking the column 81 flag into account and
6715							; reporting the X coordinate as N+1 in that case.
6716							;
6717	.e252						getTextCursorPositionWithColumn81:
6718	.e252		20 6d e2	jsr $e26d	                jsr getTextCursorPosition
6719	.e255		2c 6c 03	bit $036c	                bit vduv.column81
6720	.e258		10 01		bpl $e25b	                bpl +                       ;taken if not at column 81
6721	.e25a		e8		inx		                inx                         ;X=81
6722	.e25b						+
6723	.e25b		60		rts		                rts

6725							;-------------------------------------------------------------------------

6727	.e25c						LE25C:
6728	.e25c		38		sec		                sec
6729	.e25d		ad 0a 03	lda $030a	                lda vduv.textWindowRight
6730	.e260		ed 08 03	sbc $0308	                sbc vduv.textWindowLeft
6731	.e263		48		pha		                pha
6732	.e264		a9 00		lda #$00	                lda #$00
6733	.e266		a8		tay		                tay
6734	.e267		80 10		bra $e279	                bra LE279

6736							;-------------------------------------------------------------------------
6737							;
6738							; OSBYTE 134 (&86) Read text cursor position [MasRef D.2-41]
6739							;
6740	.e269						osbyte86:
6741	.e269		24 d0		bit $d0		                bit STATE
6742	.e26b		50 d0		bvc $e23d	                bvc osbyteA5       ;taken if not cursor editing
6743	.e26d						getTextCursorPosition:
6744	.e26d		a9 02		lda #$02	                lda #VDUVariables.cursorFlags.invertHorizontal
6745	.e26f		a0 10		ldy #$10	                ldy #VDUVariables.textCursorXPosition-VDUVariables.textWindow
6746	.e271		a2 00		ldx #$00	                ldx #VDUVariables.textWindowLeft-VDUVariables.textWindow
6747	.e273		20 8a e2	jsr $e28a	                jsr getTextWindowRelativePosition
6748	.e276		48		pha		                pha                          ;save X position
6749	.e277		a9 04		lda #$04	                lda #VDUVariables.cursorFlags.invertVertical
6750	.e279						LE279:
6751	.e279		c8		iny		                iny               ;i.e., offset of textCursorYPosition
6752	.e27a		a2 03		ldx #$03	                ldx #VDUVariables.textWindowTop-VDUVariables.textWindow
6753	.e27c		20 8a e2	jsr $e28a	                jsr getTextWindowRelativePosition
6754	.e27f		aa		tax		                tax                          ;X = Y position
6755	.e280		a8		tay		                tay                          ;Y = Y position
6756	.e281		a9 08		lda #$08	                lda #vduv.cursorFlags.swapAxes
6757	.e283		2c 66 03	bit $0366	                bit vduv.cursorFlags
6758	.e286		f0 24		beq $e2ac	                beq plx_rts ;taken if axes unswapped - so X = X position, Y = Y position
6759	.e288		7a		ply		                ply                          ;Y = Y position, X = X position
6760	.e289		60		rts		                rts

6762							;-------------------------------------------------------------------------
6763							;
6764							; Get text window-relative cursor position, taking into account cursor
6765							; flags.
6766							;
6767							; entry:
6768							;
6769							; A = cursorFlags bit for axis of interest - invertHorizontal or invertVertical
6770							;
6771							; X = offset in VDU variables of text window minimum for axis of interest
6772							;
6773							; Y = offset in VDU variables of cursor position for axis of interest
6774							;
6775							; exit:
6776							;
6777							; A = text window-relative coordinate
6778							;
6779	.e28a						getTextWindowRelativePosition:
6780	.e28a		38		sec		                sec                     ;C=1 ready for the subtraction
6781	.e28b		2c 66 03	bit $0366	                bit vduv.cursorFlags ;test cursor flags inversion bit of interest
6782	.e28e		f0 0b		beq $e29b	                beq axisNotInverted
6783	.e290						axisInverted:
6784	.e290		8a		txa		                txa
6785	.e291		49 02		eor #$02	                eor #$02                     ;swap min and max
6786	.e293		aa		tax		                tax
6787	.e294		bd 08 03	lda $0308,x	                lda vduv.textWindow,x
6788	.e297		f9 08 03	sbc $0308,y	                sbc vduv.textWindow,y
6789	.e29a		60		rts		                rts

6791	.e29b						axisNotInverted:
6792	.e29b		b9 08 03	lda $0308,y	                lda vduv.textWindow,y
6793	.e29e		fd 08 03	sbc $0308,x	                sbc vduv.textWindow,x
6794	.e2a1		60		rts		                rts

6796							;-------------------------------------------------------------------------
6797							;
6798							; Get default bounds for current mode.
6799							;
6800							; exit:
6801							;
6802							; X = max column (19, 39 or 79)
6803							;
6804							; Y = max row (24 or 31)
6805							;
6806							; preserves: A, C
6807							;
6808	.e2a2						getDefaultBoundsForCurrentScreenMODE:
6809	.e2a2		ae 55 03	ldx $0355	                ldx vduv.currentScreenMODE
6810	.e2a5		bc 09 e1	ldy $e109,x	                ldy modeMaxColumn,x          ;Y = max column
6811	.e2a8		5a		phy		                phy                          ;save max column
6812	.e2a9		bc 01 e1	ldy $e101,x	                ldy modeMaxRow,x             ;Y = max row
6813	.e2ac						plx_rts:
6814	.e2ac		fa		plx		                plx                          ;X = max column
6815	.e2ad		60		rts		                rts

6817							;-------------------------------------------------------------------------
6818							;
6819							; Swap edit cursor position and text cursor position.
6820							;
6821	.e2ae						exchangeEditCursorPositionAndTextCursorPosition:
6822	.e2ae		a2 18		ldx #$18	                ldx #VDUVariables.textCursorXPosition
6823	.e2b0		a0 64		ldy #$64	                ldy #VDUVariables.editCursorXPosition

6825							;-------------------------------------------------------------------------
6826							;
6827							; Swap 2 bytes in the VDU variables.
6828							;
6829							; entry:
6830							;
6831							; X = offset of one set of 2 bytes
6832							;
6833							; Y = offset of the other set of 2 bytes
6834							;
6835	.e2b2						exchangeTwoVDUBytes:
6836	.e2b2		a9 02		lda #$02	                lda #$02
6837	.e2b4		80 06		bra $e2bc	                bra exchangeVDUVariables

6839							;-------------------------------------------------------------------------
6840							;
6841							; Swap graphics cursor and old graphics cursor.
6842							;
6843	.e2b6						LE2B6:
6844	.e2b6		a2 24		ldx #$24	                ldx #VDUVariables.graphicsCursorPixelsX
6845	.e2b8						LE2B8:
6846	.e2b8		a0 14		ldy #$14	                ldy #VDUVariables.oldGraphicsCursorPixelsX

6848							;-------------------------------------------------------------------------
6849							;
6850							; Swap 4 bytes in the VDU variables.
6851							;
6852							; entry:
6853							;
6854							; X = offset of one set of 4 bytes
6855							;
6856							; Y = offset of the other set of 4 bytes
6857							;
6858	.e2ba						exchangeFourVDUBytes:
6859	.e2ba		a9 04		lda #$04	                lda #$04

6861							;-------------------------------------------------------------------------
6862							;
6863							; Swap bytes in the VDU variables.
6864							;
6865							; entry:
6866							;
6867							; A = number of bytes to swap
6868							;
6869							; X = offset of one set of bytes
6870							;
6871							; Y = offset of the other set of bytes
6872							;
6873	.e2bc						exchangeVDUVariables:
6874	.e2bc		48		pha		                pha                          ;save count remaining
6875	.e2bd		bd 00 03	lda $0300,x	                lda vduv,x
6876	.e2c0		48		pha		                pha
6877	.e2c1		b9 00 03	lda $0300,y	                lda vduv,y
6878	.e2c4		9d 00 03	sta $0300,x	                sta vduv,x
6879	.e2c7		68		pla		                pla
6880	.e2c8		99 00 03	sta $0300,y	                sta vduv,y
6881	.e2cb		e8		inx		                inx
6882	.e2cc		c8		iny		                iny
6883	.e2cd		68		pla		                pla
6884	.e2ce		3a		dec a		                dec a
6885	.e2cf		d0 eb		bne $e2bc	                bne exchangeVDUVariables
6886	.e2d1		60		rts		                rts

6888							;-------------------------------------------------------------------------
6889							;
6890							; Test current VDU4/VDU5 status.
6891							;
6892							; exit:
6893							;
6894							; Z=0 if VDU5 mode
6895	.e2d2						testVDU5State:
6896	.e2d2		a5 d0		lda $d0		                lda STATE
6897	.e2d4		29 20		and #$20	                and #STATE.isVDU5
6898	.e2d6		60		rts		                rts

6900							;-------------------------------------------------------------------------

6902							                .if version>=350
6906							                .endif

6908							;-------------------------------------------------------------------------

6910							                .if version>=350
6914							                .endif

6916							;-------------------------------------------------------------------------

6918							                .if version>=350
6922							                .endif

6924							;-------------------------------------------------------------------------

6926							; Default vector table
6927							; ====================
6928	.e2d7						defaultVectorTable: .block
6929	>e2d7		ed fb				                .word badCommandError        ; USERV=$200
6930	>e2d9		65 e5				                .word defaultBRKHandler      ; BRKV=$202
6931	>e2db		ff e5				                .word irq1EntryPoint         ; IRQ1V=$204
6932	>e2dd		0c e6				                .word irq2EntryPoint         ; IRQ2V=$206
6933	>e2df		02 e8				                .word oscliEntryPoint        ; CLIV=$208
6934	>e2e1		b1 ee				                .word osbyteEntryPoint       ; BYTEV=$20a
6935	>e2e3		39 ef				                .word oswordEntryPoint       ; WORDV=$20c
6936	>e2e5		22 e8				                .word oswrchEntryPoint       ; WRCHV=$20e
6937	>e2e7		bc e7				                .word osrdchEntryPoint       ; RDCHV=$210
6938	.e2e9						fsVectors: .block
6939	>e2e9		1b ff				                .word E_FILEV                ; FILEV=$212
6940	>e2eb		1e ff				                .word E_ARGSV                ; ARGSV=$214
6941	>e2ed		21 ff				                .word E_BGETV                ; BGETV=$216
6942	>e2ef		24 ff				                .word E_BPUTV                ; BPUTV=$218
6943	>e2f1		27 ff				                .word E_GBPBV                ; GBPBV=$21a
6944	>e2f3		2a ff				                .word E_FINDV                ; FINDV=$21c
6945	>e2f5		2d ff				                .word E_FSCV                 ; FSCV=$21e
6946	.e2f7						end:
6947							                .bend
6948	>e2f7		aa ff				                .word rtsFFAA                ; EVENTV=$220
6949	>e2f9		aa ff				                .word rtsFFAA                ; UPTV=$222
6950	>e2fb		aa ff				                .word rtsFFAA                ; NETV=$224
6951	>e2fd		aa ff				                .word rtsFFAA                ; VDUV=$226
6952	>e2ff		4c f7				                .word keyEntryPoint          ; KEYV=$228
6953	>e301		43 ea				                .word insEntryPoint          ; INSV=$22a
6954	>e303		f8 e9				                .word remEntryPoint          ; REMV=$22c
6955	>e305		7b e9				                .word cnpEntryPoint          ; CNPV=$22e
6956	>e307		aa ff				                .word rtsFFAA                ; IND1V=$230
6957	>e309		aa ff				                .word rtsFFAA                ; IND2V=$232
6958	>e30b		aa ff				                .word rtsFFAA                ; IND3V=$234
6959	.e30d						end:
6960							                .bend

6962							                ; valueFF is a (presumably arbitrary) byte with the
6963							                ; value 255, that's BIT'd in a few places to set the V
6964							                ; flag.
6965	.e30d						defaultMOSVariables:
6966	>e30d		90 01				                .word mosVariables-166       ;mosVariablesAddress
6967	>e30f		9f 0d				                .word extendedVectorSpace    ;extendedVectorSpaceAddress
6968	>e311		a1 02				                .word romInformationTable  ;romInformationTableAddress
6969	>e313		82 f8				                .word keyTranslationTable-16 ;keyboardTranslationTableAddress
6970	>e315		00 03				                .word vduv                   ;vduVariablesAddress
6971	>e317		00				                .byte $00                    ;cfsTimeoutCounter
6972	>e318		00				                .byte $00                    ;inputSource
6973	>e319		ff				                .byte $FF                    ;keyboardSemaphore
6974	>e31a		00				                .byte $00                    ;romPollingSemaphore
6975	>e31b		00				                .byte $00                    ;oshwm
6976	>e31c		01				                .byte $01                    ;rs423InputInterpretationStatus
6977	>e31d		00				                .byte $00                    ;noignoreState
6978	>e31e		00				                .byte $00                    ;cfsRFSFSSwitch
6979	>e31f		00				                .byte $00                    ;vcontrolRegister
6980	>e320		00				                .byte $00                    ;vpaletteRegister
6981	>e321		00				                .byte $00                    ;romActiveAtLastBRK
6982	>e322		ff				                .byte $FF                    ;basicROMNumber
6983							                .if version<500
6984	>e323		04				                .byte $04                    ;currentADCChannel
6985	>e324		04				                .byte $04                    ;maximumADCChannel
6989							                .endif
6990	>e325		00				                .byte $00                    ;adcConversionType
6991	>e326		ff				                .byte $FF                    ;rs423Busy
6992							                .if version==400
6994							                .else
6995	>e327		42				                .byte $42                    ;aciaControlRegister
6996							                .endif
6997	>e328		19				                .byte $19                    ;flashCounter
6998	>e329		19				                .byte $19                    ;firstFlashColourDuration
6999	>e32a		19				                .byte $19                    ;secondFlashColourDuration
7000	>e32b		32				                .byte $32                    ;keyboardAutoRepeatDelay
7001	>e32c		08				                .byte $08                    ;keyboardAutoRepeatRate
7002	>e32d		00				                .byte $00                    ;execFileHandle
7003	>e32e		00				                .byte $00                    ;spoolFileHandle
7004	>e32f		00				                .byte $00                    ;breakAndESCAPEEffect
7005	>e330		00				                .byte $00                    ;keyboardStatus
7006	>e331		20				                .byte $20                    ;keyboardStatusByte
7007	>e332		09				                .byte $09                    ;rs423InputBufferMinimumSpace
7008	>e333		00				                .byte $00                    ;rs423Ignore
7009	>e334		00				                .byte $00                    ;rs423Destination
7010	>e335		00				                .byte $00                    ;econetInterceptionStatus
7011	>e336		00				                .byte $00                    ;econetInputInterpretationStatus
7012	>e337		00				                .byte $00                    ;econetOutputInterpretationStatus
7013	>e338		00				                .byte $00                    ;speechSystemByte1
7014	>e339		00				                .byte $00                    ;soundSuppressionStatus
7015	>e33a		03				                .byte $03                    ;bellChannel
7016	>e33b		90				                .byte $90                    ;bellSound
7017	>e33c		64				                .byte $64                    ;bellFrequency
7018	>e33d		06				                .byte $06                    ;bellDuration
7019	>e33e		81				                .byte $81                    ;startupMessageSuppressionStatus
7020	>e33f		00				                .byte $00                    ;softKeyStringLength
7021	>e340		00				                .byte $00                    ;pagedModeCounter
7022	>e341		00				                .byte $00                    ;vduQueueNegativeLength
7023	>e342		09				                .byte $09                    ;tabKeyCode
7024	>e343		1b				                .byte $1B                    ;escapeCharacter
7025	>e344		01				                .byte $01                    ;input192To207Interpretation
7026	>e345		d0				                .byte $D0                    ;input208To223Interpretation
7027	>e346		e0				                .byte $E0                    ;input224To239Interpretation
7028	>e347		f0				                .byte $F0                    ;input240To255Interpretation
7029	>e348		01				                .byte $01                    ;softKeyInterpretation
7030	>e349		80				                .byte $80                    ;shiftSoftKeyInterpretation
7031	>e34a		90				                .byte $90                    ;ctrlSoftKeyInterpretation
7032	>e34b		00				                .byte $00                    ;shiftCtrlSoftKeyInterpretation
7033	>e34c		00				                .byte $00                    ;escapeKeyStatus
7034	>e34d		00				                .byte $00                    ;escapeEffects
7035	>e34e		ff				valueFF:        .byte $FF                    ;userVIAInterruptMask
7036	>e34f		ff				                .byte $FF                    ;rs423InterruptMask
7037	>e350		ff				                .byte $FF                    ;systemVIAInterruptMask
7038	>e351		00				                .byte $00                    ;tubePresence
7039	>e352		00				                .byte $00                    ;speechSystemByte2
7040	>e353		00				                .byte $00                    ;characterDestinationStatus
7041	>e354		00				                .byte editKeysMode.editKeys  ;editKeysMode
7042	>e355		30				                .byte $30                    ;numericKeypadInterpretation
7043	>e356		01				                .byte $01                    ;shadowRAMState
7044	>e357		00				                .byte $00                    ;countryFlag
7045	>e358		00				                .byte $00                    ;userFlag
7046							                .if version==400
7048							                .else
7049	>e359		64				                .byte $64                    ;serialULARegister
7050							                .endif
7051	>e35a		05				                .byte initialTimerSwitchState ;timerSwitchState
7052	>e35b		ff				                .byte $FF                    ;softKeyConsistencyFlag
7053							                .if version==400
7055							                .else
7056	>e35c		01				                .byte $01                    ;printerDriverType
7057							                .endif
7058	>e35d		0a				                .byte $0a                    ;printerIgnoreChar
7059	>e35e		00				                .byte $00                    ;breakVectorByte0
7060	>e35f		00				                .byte $00                    ;breakVectorByte1
7061	>e360		00				                .byte $00                    ;breakVectorByte2
7062	>e361		00				                .byte $00                    ;vduDriverMemory
7063	>e362		00				                .byte $00                    ;displayMemory
7064	>e363		ff				                .byte $FF                    ;currentLanguageROM

7066							;-------------------------------------------------------------------------
7067							;
7068							; STARTUP
7069							; =======
7070							;
7071	.e364						resetEntryPoint:                ;e364
7072	.e364		a9 40		lda #$40	                lda #$40        ; $40 = RTI
7073	.e366		8d 00 0d	sta $0d00	                sta nmiEntryPoint ; make NMI routine a no-op
7074	.e369		78		sei		                sei
7075	.e36a		a9 53		lda #$53	                lda #$53                 ; ???
7076	.e36c		8d 8e fe	sta $fe8e	                sta LFE8E                ; ???
7077							                .if version==350
7083							                .endif
7084							                .if version==350
7087							                .else
7088	.e36f		20 90 e5	jsr $e590	                jsr selectTerminalROM ; Page in ROM 15 and continue
7089	.e372		4c 20 80	jmp $8020	                jmp terminal.reset
7090							                .endif

7092							;-------------------------------------------------------------------------

7094							                .if version==350
7101							                .endif

7103							;-------------------------------------------------------------------------
7104							;
7105							; Check if a coprocessor is attached to the Tube
7106							;
7107							; exit:
7108							;
7109							; C=0 = no Tube
7110							;
7111							; C=1 = Tube
7112							;
7113							                .if version!=350
7114	.e375						LE375:
7115	.e375		a2 01		ldx #$01	                ldx #$01
7116	.e377		8e e0 fe	stx $fee0	                stx tube.status1
7117	.e37a		ad e0 fe	lda $fee0	                lda tube.status1
7118	.e37d		49 01		eor #$01	                eor #$01
7119	.e37f		a2 81		ldx #$81	                ldx #$81
7120	.e381		8e e0 fe	stx $fee0	                stx tube.status1
7121	.e384		2d e0 fe	and $fee0	                and tube.status1       ; Cy=0 if no Tube, Cy=1 if Tube
7122	.e387		6a		ror a		                ror a
7123	.e388		60		rts		                rts
7124							                .endif

7126							;-------------------------------------------------------------------------
7127							;
7128							;
7129							;
7130							                .if version==350
7133							                .endif

7135	.e389						LE389:
7136	.e389		5a		phy		                phy
7137	.e38a		da		phx		                phx
7138							                .if version==350
7141							                .elsif version<500
7142	.e38b		20 bb e9	jsr $e9bb	                jsr getROMInsertedFlagRTCAddressAndMask
7143	.e38e		85 fc		sta $fc		                sta $FC                      ;save mask
7144	.e390		20 90 e5	jsr $e590	                jsr selectTerminalROM
7145	.e393		20 b7 98	jsr $98b7	                jsr terminal.readRTCByte     ;read inserted flag
7146	.e396		98		tya		                tya                          ;A = byte read
7147	.e397		25 fc		and $fc		                and $FC                      ;do mask
7151							                .endif
7152	.e399		c9 01		cmp #$01	                cmp #$01                     ;C set if ROM is inserted
7153	.e39b		fa		plx		                plx
7154	.e39c		7a		ply		                ply
7155	.e39d		4c 81 e5	jmp $e581	                jmp selectROMX

7157							;-------------------------------------------------------------------------
7158							;
7159							; Scan ROMs and fill in the rom information table.
7160							;
7161							; entry:
7162							;
7163							; X = first ROM to scan
7164							;
7165							                .if version!=350
7166	.e3a0						scanROMs: .proc
7167							                .include "scan_roms.s65"

:14	;******  Processing file: src/scan_roms.s65

1	.e3a0		8a		txa		                txa               ;A = ROM of interest
2	.e3a1		a8		tay		                tay               ;Y = ROM of interest
3							                .if version<500&&version!=350
4	.e3a2		20 89 e3	jsr $e389	                jsr LE389         ;select ROM and check insertion flag
5	.e3a5		90 34		bcc $e3db	                bcc currentROMInvalid ;taken if ROM not actually inserted
6							                .endif
7	.e3a7		20 f7 e3	jsr $e3f7	                jsr isROMValid
8	.e3aa		90 2f		bcc $e3db	                bcc currentROMInvalid        ;taken if ROM invalid
9	.e3ac		a6 f4		ldx $f4		                ldx $F4                      ;start from current ROM
10	.e3ae		a4 f4		ldy $f4		                ldy $F4                      ;start from current ROM
11	.e3b0						nextOtherROM:
12	.e3b0		c8		iny		                iny                          ;next other ROM
13	.e3b1		c0 10		cpy #$10	                cpy #$10                     ;out of other ROMs?
14	.e3b3		b0 2a		bcs $e3df	                bcs currentROMValid       ;taken if no more other ROMs
15							                .if version<500&&version!=350
16	.e3b5		20 89 e3	jsr $e389	                jsr LE389   ;select other ROM and check insertion flag
17	.e3b8		90 f6		bcc $e3b0	                bcc nextOtherROM ;taken if other ROM not actually inserted
18							                .endif
19							                .if version==350
23							                .else
24							                ; Start address is $8000-Y, so that there's no need to
25							                ; save Y.
26	.e3ba		98		tya		                tya
27	.e3bb		49 ff		eor #$ff	                eor #$FF
28	.e3bd		85 fa		sta $fa		                sta SEIWKA+0
29	.e3bf		a9 7f		lda #$7f	                lda #$7F
30	.e3c1		85 fb		sta $fb		                sta SEIWKA+1
31							                .endif
32	.e3c3						compareLoop:
33	.e3c3		8c 30 fe	sty $fe30	                sty ROMSEL                   ;select other ROM
34							                .if version==350
36							                .else
37	.e3c6		b1 fa		lda ($fa),y	                lda (SEIWKA),y               ;get byte from other ROM
38							                .endif
39	.e3c8		8e 30 fe	stx $fe30	                stx ROMSEL                   ;select ROM
40							                .if version==350
42							                .else
43	.e3cb		d1 fa		cmp ($fa),y	                cmp (SEIWKA),y               ;same as other ROM?
44							                .endif
45	.e3cd		d0 e1		bne $e3b0	                bne nextOtherROM             ;taken if other ROM is good
46	.e3cf		e6 fa		inc $fa		                inc SEIWKA+0
47	.e3d1		d0 f0		bne $e3c3	                bne compareLoop
48	.e3d3		e6 fb		inc $fb		                inc SEIWKA+1
49	.e3d5		a5 fb		lda $fb		                lda SEIWKA+1
50							                .if version>=500
55							                .endif
56	.e3d7		c9 84		cmp #$84	                cmp #$84                  ;compare only the first 1 KB
57	.e3d9		90 e8		bcc $e3c3	                bcc compareLoop
58							                ; The first 1 KB of the current ROM matches the first
59							                ; 1 KB of some higher-priority ROM, so the current ROM
60							                ; is invalid.
61							                .if version>=500||version==350
64							                .endif

66	.e3db						currentROMInvalid:
67	.e3db		a6 f4		ldx $f4		                ldx $F4
68	.e3dd		80 0d		bra $e3ec	                bra nextROM

70	.e3df						currentROMValid:
71							                .if version>=500||version==350
80							                .endif
81	.e3df		ad 06 80	lda $8006	                lda $8006
82	.e3e2		9d a1 02	sta $02a1,x	                sta romInformationTable,x
83	.e3e5		29 8f		and #$8f	                and #$8F
84	.e3e7		d0 03		bne $e3ec	                bne nextROM       ;taken if any mandatory bits are set

86							                ; A bogus ROM type means this ROM is the BASIC ROM.
87							                .if version>=500&&version!=350
90							                .endif

92	.e3e9		8e 4b 02	stx $024b	                stx basicROMNumber

94	.e3ec						nextROM:
95	.e3ec		e8		inx		                inx
96	.e3ed		e0 10		cpx #$10	                cpx #$10
97	.e3ef		90 af		bcc $e3a0	                bcc scanROMs
98	.e3f1		20 90 e5	jsr $e590	                jsr selectTerminalROM


:13	;******  Return to file: src/mos.s65

7168	.e3f4		4c 24 82	jmp $8224	                jmp terminal.romsScanned     ;not sure why not RTS.
7169							                .endproc
7170							                .endif

7172							;-------------------------------------------------------------------------
7173							;
7174							; Checks a ROM is valid - i.e., has a valid-looking copyright string.
7175							;
7176							; Entry:
7177							;
7178							; X = ROM to check
7179							;
7180							; Exit:
7181							;
7182							; C=0 if ROM invalid; C=1 if ROM valid
7183							;
7184							; ROM of interest is selected
7185							;
7186	.e3f7						isROMValid: .proc ;e3f7
7187	.e3f7		20 81 e5	jsr $e581	                jsr selectROMX
7188	.e3fa		a2 03		ldx #$03	                ldx #$03
7189	.e3fc		ac 07 80	ldy $8007	                ldy $8007       ; fetch ROM copyright offset pointer
7190	.e3ff		18		clc		                clc             ; assume no match
7191	.e400						-
7192	.e400		b9 00 80	lda $8000,y	                lda $8000,y     ; fetch possible ROM copyright char
7193	.e403		5d 13 e5	eor $e513,x	                eor sidewaysROMCopyrightPrefix,x     ; Z=1 if it matches "\x0(C)"
7194	.e406		d0 05		bne $e40d	                bne +           ; branch taken if no match
7195	.e408		c8		iny		                iny             ; next copyright byte
7196	.e409		ca		dex		                dex             ; count 4 chars
7197	.e40a		10 f4		bpl $e400	                bpl -
7198	.e40c		38		sec		                sec             ; C=1 means a match
7199	.e40d						+
7200	.e40d		60		rts		                rts
7201							                .pend

7203							;-------------------------------------------------------------------------

7205							; End of STARTUP code
7206							; ===================
7207	.e40e						LE40E:
7208	.e40e		38		sec		                sec                      ; Call Break Intercept Vector
7209							                .if version==350
7211							                .else
7212	.e40f		20 49 f3	jsr $f349	                jsr osbyte247EntryPoint
7213							                .endif
7214	.e412		a2 27		ldx #$27	                ldx #romServiceCallInformReset
7215	.e414		20 72 ee	jsr $ee72	                jsr makeROMServiceCall
7216	.e417		ac 56 02	ldy $0256	                ldy execFileHandle ; Get Exec handle, skip past if closed
7217	.e41a		f0 08		beq $e424	                beq LE424
7218	.e41c		9c 56 02	stz $0256	                stz execFileHandle           ; Clear Exec handle
7219	.e41f		a9 00		lda #$00	                lda #$00                     ; Close Exec channel
7220	.e421		20 ce ff	jsr $ffce	                jsr OSFIND
7221	.e424						LE424:
7222	.e424		38		sec		                sec                          ;
7223	.e425		6e 00 df	ror $df00	                ror hazel.currentFS
7224	.e428		ad 8d 02	lda $028d	                lda lastBREAKType            ; Soft Break
7225	.e42b		f0 04		beq $e431	                beq LE431
7226	.e42d		38		sec		                sec                          ;
7227	.e42e		6e 02 df	ror $df02	                ror hazel.libFS
7228	.e431						LE431:
7229	.e431		20 64 ee	jsr $ee64	                jsr LEE64                    ; Set default ROMFS/TAPEFS settings
7230	.e434		20 30 f2	jsr $f230	                jsr osbyte76                    ; Test Shift and Ctrl keys
7231							                .if version==350
7233							                .else
7234	.e437		4a		lsr a		                lsr a                        ; Move SHIFT status from b7 to b3
7235	.e438		4a		lsr a		                lsr a
7236	.e439		4a		lsr a		                lsr a
7237	.e43a		4a		lsr a		                lsr a
7238							                .endif
7239	.e43b		4d 8f 02	eor $028f	                eor startupOptions ; Toggle with OSBYTE 255 boot status
7240	.e43e		29 08		and #$08	                and #$08
7241	.e440		a8		tay		                tay
7242	.e441		ae 03 df	ldx $df03	                ldx hazel.currentFSROM
7243	.e444		ad 8d 02	lda $028d	                lda lastBREAKType ; Soft Break, use current filing system
7244	.e447		f0 0b		beq $e454	                beq LE454
7245	.e449		20 90 e5	jsr $e590	                jsr selectTerminalROM
7246							                .if version<500&&version!=350
7247	.e44c		5a		phy		                phy
7248	.e44d		20 a4 8e	jsr $8ea4	                jsr terminal.readDefaultROMs
7249	.e450		29 0f		and #$0f	                and #$0F                     ;get default FS ROM
7250	.e452		7a		ply		                ply
7254							                .endif

7256	.e453		aa		tax		                tax
7257	.e454						LE454:
7258	.e454		3c a1 02	bit $02a1,x	                bit romInformationTable,x
7259	.e457		10 1f		bpl $e478	                bpl LE478
7260	.e459		20 81 e5	jsr $e581	                jsr selectROMX
7261	.e45c		e0 0f		cpx #$0f	                cpx #terminalROM
7262	.e45e		d0 0c		bne $e46c	                bne LE46C
7263	.e460		20 10 f9	jsr $f910	                jsr osbyte7A
7264	.e463		e8		inx		                inx
7265	.e464		f0 19		beq $e47f	                beq LE47F
7266	.e466		e0 63		cpx #$63	                cpx #$63
7267	.e468		f0 15		beq $e47f	                beq LE47F
7268	.e46a		80 0c		bra $e478	                bra LE478

7270	.e46c						LE46C:
7271	.e46c		a9 03		lda #$03	                lda #romServiceCallAutoBoot  ; Filing System selection
7272	.e46e		20 03 80	jsr $8003	                jsr $8003
7273	.e471		aa		tax		                tax
7274	.e472		20 90 e5	jsr $e590	                jsr selectTerminalROM
7275	.e475		8a		txa		                txa
7276	.e476		f0 2b		beq $e4a3	                beq LE4A3
7277	.e478						LE478:
7278	.e478		a2 03		ldx #$03	                ldx #romServiceCallAutoBoot
7279	.e47a		20 72 ee	jsr $ee72	                jsr makeROMServiceCall
7280	.e47d		f0 24		beq $e4a3	                beq LE4A3
7281	.e47f						LE47F:
7282	.e47f		98		tya		                tya
7283	.e480		d0 17		bne $e499	                bne LE499
7284	.e482		a9 8d		lda #$8d	                lda #$8D
7285	.e484		20 9a ed	jsr $ed9a	                jsr osbyte8C8D
7286	.e487		a2 08		ldx #$08	                ldx #<starRunBOOT
7287	.e489		a0 f4		ldy #$f4	                ldy #>starRunBOOT
7288	.e48b		ce 67 02	dec $0267	                dec startupMessageSuppressionStatus
7289	.e48e		20 f7 ff	jsr $fff7	                jsr OSCLI
7290	.e491		ee 67 02	inc $0267	                inc startupMessageSuppressionStatus
7291	.e494		80 0d		bra $e4a3	                bra LE4A3

7293							;-------------------------------------------------------------------------

7295	.e496						LE496:
7296	.e496		ee 67 02	inc $0267	                inc startupMessageSuppressionStatus ;set bit 0
7297	.e499						LE499:
7298	.e499		38		sec		                sec
7299	.e49a		6e 00 df	ror $df00	                ror hazel.currentFS
7300							                .if version<400
7301	.e49d		a9 00		lda #$00	                lda #$00
7302	.e49f		aa		tax		                tax
7303	.e4a0		20 c2 ed	jsr $edc2	                jsr selectROMOrTAPE
7309							                .endif
7310	.e4a3						LE4A3:
7311	.e4a3		a9 05		lda #$05	                lda #$05                     ;
7312	.e4a5		ae 85 02	ldx $0285	                ldx printerDriverType        ; *FX5,<current printer>
7313	.e4a8		20 b1 ee	jsr $eeb1	                jsr osbyteEntryPoint
7314	.e4ab		ad 8d 02	lda $028d	                lda lastBREAKType ; If not Soft Break, select default language
7315	.e4ae		d0 0b		bne $e4bb	                bne LE4BB
7316	.e4b0		ae 8c 02	ldx $028c	                ldx currentLanguageROM      ; Get current language ROM
7317							                .if version==350&&!finmos329
7321							                .else
7322	.e4b3		e0 10		cpx #$10	                cpx #$10                     ; <16, normal ROM number, use it
7323							                .endif
7324	.e4b5		90 0b		bcc $e4c2	                bcc LE4C2
7325							                .if version==350&&!finmos329
7327							                .else
7328	.e4b7		e0 1f		cpx #$1f	                cpx #$1F                     ; 16+UTILS ROM, re-enter Supervisor or Tube CLI
7329							                .endif
7330	.e4b9		f0 4e		beq $e509	                beq LE509
7331	.e4bb						LE4BB:
7332	.e4bb		20 90 e5	jsr $e590	                jsr selectTerminalROM     ; Page in ROM 15 - UTILS ROM
7333							                .if version<500&&version!=350
7334	.e4be		20 9c 8e	jsr $8e9c	                jsr terminal.readDefaultLanguageROM        ; Read configured LANG
7338							                .endif
7339	.e4c1		aa		tax		                tax
7340	.e4c2						LE4C2:
7341	.e4c2		18		clc		                clc

7343							;-------------------------------------------------------------------------
7344							;
7345							; OSBYTE 142 (&8E) Enter language ROM [MasRef D.2-44]
7346							;
7347	.e4c3						osbyte8E:
7348							                .if version==350
7353							                .endif
7354	.e4c3		3c a1 02	bit $02a1,x	                bit romInformationTable,x ; b6=0, error Not a language
7355							                .if version==350
7357							                .endif
7358	.e4c6		50 4e		bvc $e516	                bvc thisIsNotALanguageError
7359	.e4c8		08		php		                php
7360	.e4c9		90 16		bcc $e4e1	                bcc LE4E1 ;taken if not OSBYTE 142 - so skip ROM check
7361	.e4cb		20 81 e5	jsr $e581	                jsr selectROMX
7362	.e4ce		ad 06 80	lda $8006	                lda sidewaysROMType
7363	.e4d1		29 0d		and #$0d	                and #%00001101
7364	.e4d3		f0 05		beq $e4da	                beq is6502ROM ;taken if low nybble is 0 (6502 BASIC) or 2 (other 6502 ROM)
7365	.e4d5		2c 7a 02	bit $027a	                bit tubePresence
7366	.e4d8		10 54		bpl $e52e	                bpl iCannotRunThisCodeError  ;taken if no Tube - assume impossible to run
7367	.e4da						is6502ROM:
7368	.e4da		da		phx		                phx                          ;save ROM slot
7369	.e4db		a2 2a		ldx #$2a	                ldx #romServiceCallLanguageChange
7370	.e4dd		20 72 ee	jsr $ee72	                jsr makeROMServiceCall
7371	.e4e0		fa		plx		                plx                          ;restore ROM slot
7372	.e4e1						LE4E1:
7373	.e4e1		8e 8c 02	stx $028c	                stx currentLanguageROM
7374	.e4e4		20 81 e5	jsr $e581	                jsr selectROMX
7375	.e4e7		a9 80		lda #$80	                lda #>sidewaysROMName
7376	.e4e9		a0 08		ldy #$08	                ldy #(<sidewaysROMName)-1
7377	.e4eb		20 a3 e7	jsr $e7a3	                jsr print0TerminatedString
7378	.e4ee		84 fd		sty $fd		                sty errPtr+0
7379	.e4f0		20 e7 ff	jsr $ffe7	                jsr OSNEWL
7380	.e4f3		20 e7 ff	jsr $ffe7	                jsr OSNEWL
7381	.e4f6		28		plp		                plp
7382							                .if version<500
7383	.e4f7		a9 01		lda #$01	                lda #$01
7384	.e4f9		2c 7a 02	bit $027a	                bit tubePresence
7385	.e4fc		30 12		bmi $e510	                bmi copyLanguageOverTube     ;taken if Tube is present
7386							                .endif
7387	.e4fe		ad 06 80	lda $8006	                lda sidewaysROMType
7388	.e501		29 0d		and #$0d	                and #%00001101
7389	.e503		d0 29		bne $e52e	                bne iCannotRunThisCodeError ;taken if low nybble isn't 0 (6502 BASIC) or 2 (other 6502 ROM)
7390	.e505		1a		inc a		                inc a                       ;
7391	.e506		4c 00 80	jmp $8000	                jmp sidewaysROMLanguageEntry

7393	.e509						LE509:
7394	.e509		a9 00		lda #$00	                lda #$00
7395							                .if version<500
7396	.e50b		2c 7a 02	bit $027a	                bit tubePresence
7397	.e50e		10 69		bpl $e579	                bpl startCommandLineUI
7398	.e510						copyLanguageOverTube:
7399	.e510		4c 00 04	jmp $0400	                jmp terminal.tubeHost.copyLanguage
7402							                .endif

7404							;-------------------------------------------------------------------------

7406	.e513						sidewaysROMCopyrightPrefix: .block
7407	>e513		29 43 28			                .text ")C("
7408	.e516						end:
7409							                .endblock

7411							;-------------------------------------------------------------------------

7413	.e516						thisIsNotALanguageError:
7414	.e516		00		brk #		                brk
7415	>e517		00 54 68 69 73 20 69 73		                .text 0,"This is not a language"
	>e51f		20 6e 6f 74 20 61 20 6c 61 6e 67 75 61 67 65

7417							;-------------------------------------------------------------------------

7419	.e52e						iCannotRunThisCodeError:
7420	.e52e		00		brk #		                brk
7421	>e52f		00 49 20 63 61 6e 6e 6f		                .text 0,"I cannot run this code",0
	>e537		74 20 72 75 6e 20 74 68 69 73 20 63 6f 64 65 00

7423							;-------------------------------------------------------------------------
7424							;
7425							; OSBYTE 164 (&A4) Check processor type [MasRef D.2-50]
7426							;
7427	.e547						osbyteA4:
7428	.e547		a2 03		ldx #$03	                ldx #sidewaysROMCopyrightPrefix.end-sidewaysROMCopyrightPrefix
7429	.e549		a0 07		ldy #$07	                ldy #<sidewaysROMCopyrightOffset
7430	.e54b		b1 f0		lda ($f0),y	                lda (originalX),y
7431	.e54d		a8		tay		                tay
7432	.e54e						-
7433	.e54e		b1 f0		lda ($f0),y	                lda (originalX),y
7434	.e550		dd 13 e5	cmp $e513,x	                cmp sidewaysROMCopyrightPrefix,x
7435	.e553		d0 0f		bne $e564	                bne rtsE564 ;taken if (C) not found - must be OK, if it's not a ROM?
7436	.e555		c8		iny		                iny
7437	.e556		ca		dex		                dex
7438	.e557		10 f5		bpl $e54e	                bpl -
7439	.e559		a0 06		ldy #$06	                ldy #<sidewaysROMType
7440	.e55b		b1 f0		lda ($f0),y	                lda (originalX),y
7441	.e55d		0a		asl a		                asl a
7442	.e55e		10 b6		bpl $e516	                bpl thisIsNotALanguageError ;taken if no language entry point
7443	.e560		29 1a		and #$1a	                and #%00001101<<1
7444	.e562		d0 ca		bne $e52e	                bne iCannotRunThisCodeError ;taken if low nybble wasn't 0 (6502 BASIC) or 2 (other 6502 ROM)
7445	.e564						rtsE564:
7446	.e564		60		rts		                rts

7448							;-------------------------------------------------------------------------

7450							                .if version==350
7457							                .endif

7459							;-------------------------------------------------------------------------

7461							                .if version==350
7467							                .endif

7469							;-------------------------------------------------------------------------

7471	.e565						defaultBRKHandler:
7472	.e565		a0 00		ldy #$00	                ldy #$00
7473	.e567		20 a7 e7	jsr $e7a7	                jsr printBRKMessage
7474	.e56a		20 e7 ff	jsr $ffe7	                jsr OSNEWL
7475	.e56d		ad 67 02	lda $0267	                lda startupMessageSuppressionStatus
7476	.e570		6a		ror a		                ror a
7477	.e571		b0 06		bcs $e579	                bcs startCommandLineUI                   ;taken if bit 0 was set
7478	.e573		20 e7 ff	jsr $ffe7	                jsr OSNEWL
7479	.e576		4c 96 e4	jmp $e496	                jmp LE496

7481							;-------------------------------------------------------------------------

7483	.e579						startCommandLineUI:
7484	.e579		20 90 e5	jsr $e590	                jsr selectTerminalROM
7485	.e57c		4c 61 86	jmp $8661	                jmp terminal.commandLineUI

7487							;-------------------------------------------------------------------------
7488							;
7489							; Select paged ROM bank 15 - TERMINAL - with ANDY paged in,
7490							;
7491							; Preserves A/Y
7492	.e57f						selectTerminalROMAndANDY:   ;e57f
7493	.e57f		a2 8f		ldx #$8f	                ldx #$80|terminalROM
7494							                ; fall through into selectROMX

7496							;-------------------------------------------------------------------------
7497							;-------------------------------------------------------------------------
7498							;
7499							; Select paged ROM bank.
7500							;
7501							; Entry:
7502							;
7503							; X = bank to select.
7504							;
7505							; Preserves A/X/Y/P
7506	.e581						selectROMX:   ;e581
7507	.e581		86 f4		stx $f4		                stx $F4
7508	.e583		8e 30 fe	stx $fe30	                stx ROMSEL
7509	.e586		60		rts		                rts

7511							;-------------------------------------------------------------------------
7512							;
7513	.e587						isROMValidThenSelectTerminalROM:
7514	.e587		5a		phy		                phy
7515	.e588		20 f7 e3	jsr $e3f7	                jsr isROMValid
7516	.e58b		20 90 e5	jsr $e590	                jsr selectTerminalROM
7517	.e58e		7a		ply		                ply
7518	.e58f		60		rts		                rts

7520							;-------------------------------------------------------------------------
7521							;
7522							; Select paged ROM bank 15 - TERMINAL.
7523							;
7524							; Preserves X/Y
7525	.e590						selectTerminalROM:            ;e590
7526	.e590		a9 0f		lda #$0f	                lda #terminalROM
7527							                ; fall through into selectROMA

7529							;-------------------------------------------------------------------------
7530							;
7531							; Select paged ROM bank.
7532							;
7533							; A = bank to select.
7534							;
7535							; Preserves A/X/Y/P
7536	.e592						selectROMA:                   ;e592
7537	.e592		85 f4		sta $f4		                sta $F4         ;update ROMSEL copy
7538	.e594		8d 30 fe	sta $fe30	                sta ROMSEL
7539	.e597		60		rts		                rts

7541							;-------------------------------------------------------------------------
7542							;
7543							; Select paged ROM bank 15 - TERMINAL - with ANDY paged in,
7544							;
7545							; Preserves A/X/Y

7547	.e598						selectTerminalROMAndANDY2:
7548	.e598		da		phx		                phx
7549	.e599		20 7f e5	jsr $e57f	                jsr selectTerminalROMAndANDY
7550	.e59c		fa		plx		                plx
7551	.e59d		60		rts		                rts

7553							;-------------------------------------------------------------------------

7555	.e59e						irqEntryPoint:
7556	.e59e		85 fc		sta $fc		                sta irqTempA
7557	.e5a0		68		pla		                pla                          ;restore P
7558	.e5a1		48		pha		                pha                          ;save P
7559	.e5a2		29 10		and #$10	                and #$10
7560	.e5a4		d0 03		bne $e5a9	                bne brkEntryPoint
7561	.e5a6		6c 04 02	jmp ($0204)	                jmp (IRQ1V)

7563	.e5a9						brkEntryPoint:
7564	.e5a9		da		phx		                phx
7565	.e5aa		ba		tsx		                tsx
7566	.e5ab		bd 03 01	lda $0103,x	                lda $0103,x                  ;get BRK address+1 LSB
7567	.e5ae		d8		cld		                cld                          ;
7568	.e5af		38		sec		                sec                          ;
7569	.e5b0		e9 01		sbc #$01	                sbc #$01                     ;get BRK address LSB
7570	.e5b2		85 fd		sta $fd		                sta errPtr+0
7571	.e5b4		bd 04 01	lda $0104,x	                lda $0104,x                  ;get BRK address+1 MSB
7572	.e5b7		e9 00		sbc #$00	                sbc #$00                     ;get BRK address MSB
7573	.e5b9		85 fe		sta $fe		                sta errPtr+1
7574	.e5bb		a5 f4		lda $f4		                lda $F4
7575	.e5bd		8d 4a 02	sta $024a	                sta romActiveAtLastBRK
7576	.e5c0		86 f0		stx $f0		                stx originalX
7577	.e5c2		a2 06		ldx #$06	                ldx #romServiceCallBreakInstruction
7578	.e5c4		20 72 ee	jsr $ee72	                jsr makeROMServiceCall
7579	.e5c7		ae 8c 02	ldx $028c	                ldx currentLanguageROM
7580	.e5ca		20 81 e5	jsr $e581	                jsr selectROMX
7581	.e5cd		fa		plx		                plx
7582	.e5ce		a5 fc		lda $fc		                lda irqTempA
7583	.e5d0		58		cli		                cli
7584	.e5d1		6c 02 02	jmp ($0202)	                jmp (BRKV)

7586							;-------------------------------------------------------------------------

7588							                .if version!=400
7589	.e5d4						LE5D4:
7590	.e5d4		38		sec		                sec
7591	.e5d5		6e 4f 02	ror $024f	                ror rs423Busy
7592	.e5d8		2c 50 02	bit $0250	                bit aciaControlRegister
7593	.e5db		10 07		bpl $e5e4	                bpl LE5E4
7594	.e5dd		20 27 ed	jsr $ed27	                jsr getRS423InputBufferFreeBytes
7595	.e5e0		a2 00		ldx #$00	                ldx #$00
7596	.e5e2		b0 02		bcs $e5e6	                bcs LE5E6
7597	.e5e4						LE5E4:
7598	.e5e4		a2 40		ldx #$40	                ldx #$40
7599	.e5e6						LE5E6:
7600	.e5e6		4c 12 e9	jmp $e912	                jmp resetACIA

7602	.e5e9						LE5E9:
7603	.e5e9		ac 09 fe	ldy $fe09	                ldy ACIA+1
7604	.e5ec		29 3a		and #$3a	                and #$3A
7605	.e5ee		d0 38		bne $e628	                bne LE628
7606	.e5f0		ae 5c 02	ldx $025c	                ldx rs423Ignore
7607	.e5f3		d0 09		bne $e5fe	                bne LE5FE
7608	.e5f5		e8		inx		                inx
7609	.e5f6		20 80 ea	jsr $ea80	                jsr osbyte99
7610	.e5f9		20 27 ed	jsr $ed27	                jsr getRS423InputBufferFreeBytes
7611	.e5fc		90 e6		bcc $e5e4	                bcc LE5E4
7612	.e5fe						LE5FE:
7613	.e5fe		60		rts		                rts
7614							                .endif

7616							;-------------------------------------------------------------------------

7618	.e5ff						irq1EntryPoint:
7619	.e5ff		a5 fc		lda $fc		                lda irqTempA
7620	.e601		48		pha		                pha
7621	.e602		da		phx		                phx
7622	.e603		5a		phy		                phy
7623							                .if version!=400
7624	.e604		b8		clv		                clv
7625							                .endif
7626	.e605		20 0f e6	jsr $e60f	                jsr irq1Handler
7627	.e608		7a		ply		                ply
7628	.e609		fa		plx		                plx
7629	.e60a		68		pla		                pla
7630	.e60b		40		rti		                rti

7632							;-------------------------------------------------------------------------

7634	.e60c						irq2EntryPoint:
7635	.e60c		a5 fc		lda $fc		                lda irqTempA
7636	.e60e		40		rti		                rti

7638							;-------------------------------------------------------------------------

7640							                .if version==400
7643							                .else
7644	.e60f						irq1Handler:
7645	.e60f		ad 08 fe	lda $fe08	                lda ACIA+0
7646							                .if version>=500
7648							                .endif
7649	.e612		70 02		bvs $e616	                bvs LE616
7650	.e614		10 5c		bpl $e672	                bpl checkForSystemVIAInterrupt
7651	.e616						LE616:
7652	.e616		a6 ea		ldx $ea		                ldx $EA
7653	.e618		ca		dex		                dex
7654	.e619		30 33		bmi $e64e	                bmi LE64E
7655	.e61b		70 30		bvs $e64d	                bvs rtsE64D
7656	.e61d		20 84 f3	jsr $f384	                jsr withTerminalROM
7657	.e620		4c 5d a4	jmp $a45d	                jmp terminal.LA45D

7659	.e623						LE623:
7660	.e623		ac 09 fe	ldy $fe09	                ldy ACIA+1
7661	.e626		2a		rol a		                rol a
7662	.e627		0a		asl a		                asl a
7663	.e628						LE628:
7664	.e628		aa		tax		                tax
7665	.e629		98		tya		                tya
7666	.e62a		a0 07		ldy #$07	                ldy #$07
7667	.e62c		4c 28 ea	jmp $ea28	                jmp eventEntryPoint

7669	.e62f						LE62F:
7670	.e62f		a2 02		ldx #$02	                ldx #$02
7671	.e631		20 f4 e9	jsr $e9f4	                jsr osbyte91
7672	.e634		90 10		bcc $e646	                bcc LE646
7673	.e636		ad 85 02	lda $0285	                lda printerDriverType
7674	.e639		c9 02		cmp #$02	                cmp #$02
7675	.e63b		d0 97		bne $e5d4	                bne LE5D4
7676	.e63d		e8		inx		                inx
7677	.e63e		20 f4 e9	jsr $e9f4	                jsr osbyte91
7678	.e641		6e d1 02	ror $02d1	                ror bufferEmptyFlags+bufferPrinter
7679	.e644		30 8e		bmi $e5d4	                bmi LE5D4
7680	.e646						LE646:
7681	.e646		8d 09 fe	sta $fe09	                sta ACIA+1
7682	.e649		a9 e7		lda #$e7	                lda #$E7
7683	.e64b		85 ea		sta $ea		                sta $EA
7684	.e64d						rtsE64D:
7685	.e64d		60		rts		                rts

7687	.e64e						LE64E:
7688							                .if version<500
7689	.e64e		2d 78 02	and $0278	                and rs423InterruptMask
7690							                .endif
7691	.e651		4a		lsr a		                lsr a
7692	.e652		90 07		bcc $e65b	                bcc LE65B
7693	.e654		70 05		bvs $e65b	                bvs LE65B
7694	.e656		ac 50 02	ldy $0250	                ldy aciaControlRegister
7695	.e659		30 8e		bmi $e5e9	                bmi LE5E9
7696	.e65b						LE65B:
7697	.e65b		4a		lsr a		                lsr a
7698	.e65c		6a		ror a		                ror a
7699	.e65d		b0 c4		bcs $e623	                bcs LE623
7700	.e65f		30 ce		bmi $e62f	                bmi LE62F
7701	.e661		70 ea		bvs $e64d	                bvs rtsE64D
7702							                .endif

7704							;-------------------------------------------------------------------------

7706	.e663						handleUnrecogisedInterrupt:
7707	.e663		a2 05		ldx #$05	                ldx #romServiceCallUnrecognisedInterrupt
7708	.e665		20 72 ee	jsr $ee72	                jsr makeROMServiceCall
7709	.e668		f0 e3		beq $e64d	                beq rtsE64D                  ;taken if handled

7711							                ; Pass unrecognised, unhandled interrupts to IRQ2V.
7712	.e66a		68		pla		                pla
7713	.e66b		68		pla		                pla
7714	.e66c		7a		ply		                ply
7715	.e66d		fa		plx		                plx
7716	.e66e		68		pla		                pla
7717							                .if version==350
7719							                .endif
7720	.e66f		6c 06 02	jmp ($0206)	                jmp (IRQ2V)

7722							;-------------------------------------------------------------------------

7724							                .if version==400
7726							                .else
7727	.e672						checkForSystemVIAInterrupt:
7728							                .endif
7729	.e672		ad 4d fe	lda $fe4d	                lda systemVIA.ifr
7730							                .if version==400
7732							                .else
7733	.e675		10 3c		bpl $e6b3	                bpl checkForUserVIAInterrupt
7734							                .endif
7735	.e677		2d 79 02	and $0279	                and systemVIAInterruptMask
7736	.e67a		2d 4e fe	and $fe4e	                and systemVIA.ier
7737	.e67d		89 02		bit #$02	                bit #VIA.irq.ca1
7738	.e67f		f0 54		beq $e6d5	                beq checkForSystemVIAT1Interrupt

7740							                ; Handle CA1 interrupt - CRTC vsync.

7742	.e681		ce 40 02	dec $0240	                dec cfsTimeoutCounter
7743							                .if version!=400
7744	.e684		a5 ea		lda $ea		                lda $EA
7745	.e686		10 02		bpl $e68a	                bpl +
7746	.e688		e6 ea		inc $ea		                inc $EA
7747	.e68a						+
7748							                .endif
7749	.e68a		ad 51 02	lda $0251	                lda flashCounter
7750	.e68d		f0 1a		beq $e6a9	                beq flashDone                    ;taken if no flash
7751	.e68f		ce 51 02	dec $0251	                dec flashCounter             ;count down
7752	.e692		d0 15		bne $e6a9	                bne flashDone
7753	.e694		ae 52 02	ldx $0252	                ldx firstFlashColourDuration ;assume first flash colour is next
7754	.e697		ad 48 02	lda $0248	                lda vcontrolRegister
7755	.e69a		4a		lsr a		                lsr a                        ;C=flash bit
7756	.e69b		90 03		bcc $e6a0	                bcc +                        ;taken if first flash colour is next
7757	.e69d		ae 53 02	ldx $0253	                ldx secondFlashColourDuration ;actually, second flash colour is next
7758	.e6a0						+
7759	.e6a0		2a		rol a		                rol a                        ;reinstate old register value
7760	.e6a1		49 01		eor #$01	                eor #VCONTROL.flash          ;toggle flash bit
7761	.e6a3		20 50 f2	jsr $f250	                jsr setVCONTROL
7762	.e6a6		8e 51 02	stx $0251	                stx flashCounter
7763	.e6a9						flashDone:
7764	.e6a9		a0 04		ldy #$04	                ldy #eventStartOfVerticalSync
7765	.e6ab		20 28 ea	jsr $ea28	                jsr eventEntryPoint
7766	.e6ae		a9 02		lda #$02	                lda #VIA.irq.ca1
7767							                .if version==400
7769							                .else
7770	.e6b0		4c 8a e7	jmp $e78a	                jmp staSystemVIAIFR          ;acknowledge CA1
7771							                .endif

7773							                .if version!=400
7774	.e6b3						checkForUserVIAInterrupt:
7775	.e6b3		ad 6d fe	lda $fe6d	                lda userVIA.ifr
7776	.e6b6		10 ab		bpl $e663	                bpl handleUnrecogisedInterrupt
7777	.e6b8		2d 77 02	and $0277	                and userVIAInterruptMask
7778	.e6bb		2d 6e fe	and $fe6e	                and userVIA.ier
7779	.e6be		6a		ror a		                ror a                        ;C=CA2
7780	.e6bf		6a		ror a		                ror a                        ;C=CA1
7781	.e6c0		90 a1		bcc $e663	                bcc handleUnrecogisedInterrupt
7782	.e6c2		ac 85 02	ldy $0285	                ldy printerDriverType
7783	.e6c5		88		dey		                dey
7784	.e6c6		d0 9b		bne $e663	                bne handleUnrecogisedInterrupt ;taken if printerDriverType not 1
7785	.e6c8		a9 02		lda #$02	                lda #VIA.irq.ca1
7786	.e6ca		8d 6d fe	sta $fe6d	                sta userVIA.ifr              ;acknowledge CA1
7787	.e6cd		8d 6e fe	sta $fe6e	                sta userVIA.ier              ;inhibit CA1
7788	.e6d0		a2 03		ldx #$03	                ldx #bufferPrinter
7789	.e6d2		4c d5 e8	jmp $e8d5	                jmp LE8D5
7790							                .endif

7792	.e6d5						checkForSystemVIAT1Interrupt:
7793	.e6d5		89 40		bit #$40	                bit #VIA.irq.t1
7794							                .if version<400
7795	.e6d7		f0 75		beq $e74e	                beq checkForSystemVIACB1Interrupt
7798							                .endif

7800							                ; Handle T1 interrupt - 100 Hz timer.

7802	.e6d9		a9 40		lda #$40	                lda #VIA.irq.t1
7803	.e6db		8d 4d fe	sta $fe4d	                sta systemVIA.ifr            ;acknowledge T1 interrupt
7804	.e6de		ad 83 02	lda $0283	                lda timerSwitchState
7805	.e6e1		aa		tax		                tax                          ;X=old timerSwitchState
7806	.e6e2		49 0f		eor #$0f	                eor #$0F
7807	.e6e4		48		pha		                pha                          ;save new timerSwitchState
7808	.e6e5		a8		tay		                tay                          ;Y=new timerSwitchState
7809	.e6e6		38		sec		                sec                          ;C=1 - increment
7810	.e6e7						updateTIMELoop:
7811	.e6e7		bd 91 02	lda $0291,x	                lda timer0-1,x
7812	.e6ea		69 00		adc #$00	                adc #$00
7813	.e6ec		99 91 02	sta $0291,y	                sta timer0-1,y

7815							                ; one of X or Y will get to 0 to indicate the end of
7816							                ; the loop.
7817	.e6ef		ca		dex		                dex
7818	.e6f0		f0 03		beq $e6f5	                beq updateTIMEDone
7819	.e6f2		88		dey		                dey
7820	.e6f3		d0 f2		bne $e6e7	                bne updateTIMELoop
7821	.e6f5						updateTIMEDone:
7822	.e6f5		68		pla		                pla                          ;restore new timerSwitchState
7823	.e6f6		8d 83 02	sta $0283	                sta timerSwitchState
7824	.e6f9		a2 05		ldx #$05	                ldx #$05
7825	.e6fb						incrementIntervalTimer:
7826	.e6fb		fe 9b 02	inc $029b,x	                inc intervalTimer-1,x
7827	.e6fe		d0 08		bne $e708	                bne intervalTimerDone
7828	.e700		ca		dex		                dex
7829	.e701		d0 f8		bne $e6fb	                bne incrementIntervalTimer
7830	.e703		a0 05		ldy #$05	                ldy #eventIntervalTimerCrossingZero
7831	.e705		20 28 ea	jsr $ea28	                jsr eventEntryPoint
7832	.e708						intervalTimerDone:
7833	.e708		ad b1 02	lda $02b1	                lda inkeyTimeoutCounter+0
7834	.e70b		d0 08		bne $e715	                bne LE715
7835	.e70d		ad b2 02	lda $02b2	                lda inkeyTimeoutCounter+1
7836	.e710		f0 06		beq $e718	                beq LE718
7837	.e712		ce b2 02	dec $02b2	                dec inkeyTimeoutCounter+1
7838	.e715						LE715:
7839	.e715		ce b1 02	dec $02b1	                dec inkeyTimeoutCounter+0
7840	.e718						LE718:
7841	.e718		2c cd 02	bit $02cd	                bit previousKeyPressedWhenReadingOSBYTE
7842	.e71b		10 0b		bpl $e728	                bpl LE728
7843	.e71d		ee cd 02	inc $02cd	                inc previousKeyPressedWhenReadingOSBYTE
7844	.e720		58		cli		                cli
7845							                .if version==350
7847							                .else
7848	.e721		20 16 f4	jsr $f416	                jsr LF416                    ;update sound???
7849							                .endif
7850	.e724		78		sei		                sei
7851	.e725		ce cd 02	dec $02cd	                dec previousKeyPressedWhenReadingOSBYTE
7852	.e728						LE728:
7853	.e728		2c 4e e3	bit $e34e	                bit valueFF                  ;V=1
7854							                .if version!=400
7855	.e72b		20 0f e6	jsr $e60f	                jsr irq1Handler
7856							                .endif
7857	.e72e		a5 ec		lda $ec		                lda lastKeyPressedInternal
7858	.e730		05 ed		ora $ed		                ora firstKeyPressedInternal
7859	.e732		2d 42 02	and $0242	                and keyboardSemaphore
7860	.e735		f0 04		beq $e73b	                beq +
7861	.e737		38		sec		                sec
7862	.e738		20 ff f8	jsr $f8ff	                jsr LF8FF
7863	.e73b						+
7864							                .if version>=500
7866							                .endif
7867	.e73b		20 33 e9	jsr $e933	                jsr pollPrinterDriver
7868	.e73e		ac 43 02	ldy $0243	                ldy romPollingSemaphore
7869							                .if version==400
7871							                .else
7872	.e741		f0 05		beq $e748	                beq LE748
7873							                .endif
7874	.e743		a2 15		ldx #$15	                ldx #romServiceCallPollingInterrupt
7875							                .if version==400
7877							                .else
7878	.e745		20 72 ee	jsr $ee72	                jsr makeROMServiceCall
7879	.e748						LE748:
7880							                .if version<500
7881	.e748		2c 18 fe	bit $fe18	                bit HADC+0
7882	.e74b		70 05		bvs $e752	                bvs LE752
7883							                .endif
7884	.e74d		60		rts		                rts
7885							                .endif

7887							                .if version!=400
7888	.e74e						checkForSystemVIACB1Interrupt:
7889							                .if version<500
7890	.e74e		89 10		bit #$10	                bit #VIA.irq.cb1
7891	.e750		f0 3c		beq $e78e	                beq checkForSystemVIACA2Interrupt

7893							                ; Handle CB1 interrupt - ADC conversion complete.
7894	.e752						LE752:
7895	.e752		ae 4c 02	ldx $024c	                ldx currentADCChannel
7896	.e755		f0 31		beq $e788	                beq acknowledgeSystemVIACB1Interrupt
7897	.e757		ad 1a fe	lda $fe1a	                lda HADC+2
7898	.e75a		9d b5 02	sta $02b5,x	                sta adcResultLSBs-1,x
7899	.e75d		ad 19 fe	lda $fe19	                lda HADC+1
7900	.e760		9d b9 02	sta $02b9,x	                sta adcResultMSBs-1,x
7901	.e763		8e be 02	stx $02be	                stx adcLastConvertedChannel
7902	.e766		a0 03		ldy #$03	                ldy #eventADCConversionComplete
7903	.e768		20 28 ea	jsr $ea28	                jsr eventEntryPoint
7904	.e76b		ca		dex		                dex                          ;next ADC channel
7905	.e76c		d0 03		bne $e771	                bne initiateADCConversion
7906	.e76e		ae 4d 02	ldx $024d	                ldx maximumADCChannel
7907	.e771						initiateADCConversion:
7908	.e771		e0 05		cpx #$05	                cpx #$05
7909	.e773		90 02		bcc $e777	                bcc +
7910	.e775		a2 04		ldx #$04	                ldx #$04                     ;clamp ADC channel
7911	.e777						+
7912	.e777		8e 4c 02	stx $024c	                stx currentADCChannel
7913	.e77a		ad 4e 02	lda $024e	                lda adcConversionType
7914	.e77d		3a		dec a		                dec a            ;$FF=default, $07=8 bits, $0b=12 bits
7915	.e77e		29 08		and #$08	                and #$08         ;8=12 bits, 0=8 bits
7916	.e780		18		clc		                clc
7917	.e781		6d 4c 02	adc $024c	                adc currentADCChannel        ;mix in ADC channel, 1-4
7918	.e784		3a		dec a		                dec a ;convert to hardware ADC channel, 0-3 (no risk of borrow)
7919	.e785		8d 18 fe	sta $fe18	                sta HADC+0                   ;initiate conversion
7920	.e788						acknowledgeSystemVIACB1Interrupt:
7921	.e788		a9 10		lda #$10	                lda #$10
7922	.e78a						staSystemVIAIFR:
7923	.e78a		8d 4d fe	sta $fe4d	                sta systemVIA.ifr
7924	.e78d		60		rts		                rts
7928							                .endif
7929							                .endif

7931	.e78e						checkForSystemVIACA2Interrupt:
7932	.e78e		4a		lsr a		                lsr a                        ;C = CA2
7933	.e78f		90 08		bcc $e799	                bcc handleUnrecognisedInterruptE799

7935							                ; Handle CA2 interrupt - keyboard.

7937	.e791		18		clc		                clc
7938	.e792		20 ff f8	jsr $f8ff	                jsr LF8FF
7939	.e795		a9 01		lda #$01	                lda #VIA.irq.ca2
7940							                .if version<400
7941	.e797		80 f1		bra $e78a	                bra staSystemVIAIFR
7947							                .endif

7949	.e799						handleUnrecognisedInterruptE799:
7950	.e799		4c 63 e6	jmp $e663	                jmp handleUnrecogisedInterrupt

7952							;-------------------------------------------------------------------------
7953							;
7954							; OSBYTE 17 (&11) Write next ADC channel to be sampled [MasRef D.2-25]
7955							;
7956	.e79c						osbyte11:
7957							                .if version!=400
7958							                .if version<500
7959	.e79c		8c be 02	sty $02be	                sty adcLastConvertedChannel
7962							                .endif
7963	.e79f		80 d0		bra $e771	                bra initiateADCConversion
7964							                .endif

7966							;-------------------------------------------------------------------------
7967							;
7968							; Print a 0-terminated string at some offset from startupMessages.
7969							;
7970							; entry:
7971							;
7972							; Y = offset-1 of message
7973							;
7974	.e7a1						printStartupMessage:
7975	.e7a1		a9 e0		lda #$e0	                lda #>startupMessages
7976							                ; .cerror (<startupMessages)!=0,"startupMessages must be page-aligned" ;it's more flexible than this, but this'll do for now

7978							;-------------------------------------------------------------------------
7979							;
7980							; Print a 0-terminated string.
7981							;
7982							; entry:
7983							;
7984							; A = address MSB
7985							;
7986							; Y = (address LSB)-1
7987							;
7988	.e7a3						print0TerminatedString:
7989	.e7a3		85 fe		sta $fe		                sta errPtr+1
7990	.e7a5		64 fd		stz $fd		                stz errPtr+0

7992							;-------------------------------------------------------------------------
7993							;
7994							; Print the BRK message.
7995							;
7996							; entry:
7997							;
7998							; (errPtr) = pointer to the error number (as will be the case after a
7999							; BRK)
8000							;
8001							; Y=0
8002							;
8003	.e7a7						printBRKMessage:
8004	.e7a7		c8		iny		                iny
8005	.e7a8		b1 fd		lda ($fd),y	                lda (errPtr),y
8006	.e7aa		20 e3 ff	jsr $ffe3	                jsr OSASCI
8007	.e7ad		aa		tax		                tax
8008	.e7ae		d0 f7		bne $e7a7	                bne printBRKMessage
8009	.e7b0						rtsE7B0:
8010	.e7b0		60		rts		                rts

8012							;-------------------------------------------------------------------------

8014							                .if version>=500
8254							                .endif

8256							;-------------------------------------------------------------------------

8258	.e7b1						osbyte81Timed:
8259	.e7b1		8e b1 02	stx $02b1	                stx inkeyTimeoutCounter+0
8260	.e7b4		8c b2 02	sty $02b2	                sty inkeyTimeoutCounter+1
8261	.e7b7		66 e6		ror $e6		                ror readCharacterTimedFlag   ;set the timed flag
8262	.e7b9		58		cli		                cli
8263	.e7ba		80 02		bra $e7be	                bra osrdchWithTimeout

8265							;-------------------------------------------------------------------------

8267	.e7bc						osrdchEntryPoint:
8268	.e7bc		64 e6		stz $e6		                stz readCharacterTimedFlag   ;clear the timed flag
8269	.e7be						osrdchWithTimeout:
8270	.e7be		da		phx		                phx
8271	.e7bf		5a		phy		                phy
8272	.e7c0		ac 56 02	ldy $0256	                ldy execFileHandle
8273	.e7c3		f0 12		beq $e7d7	                beq osrdchLoop               ;taken if not *EXEC'ing
8274	.e7c5		38		sec		                sec
8275	.e7c6		66 eb		ror $eb		                ror tapeCritical
8276	.e7c8		20 d7 ff	jsr $ffd7	                jsr OSBGET             ;get 1 byte from the *EXEC file
8277	.e7cb		64 eb		stz $eb		                stz tapeCritical
8278	.e7cd		90 24		bcc $e7f3	                bcc osrdchDone                    ;taken if byte valid
8279	.e7cf		a9 00		lda #$00	                lda #$00                     ;OSFIND close file
8280	.e7d1		9c 56 02	stz $0256	                stz execFileHandle           ;reset *EXEC handle
8281	.e7d4		20 ce ff	jsr $ffce	                jsr OSFIND                   ;close *EXEC file
8282	.e7d7						osrdchLoop:
8283	.e7d7		a5 ff		lda $ff		                lda escapeFlag               ;b7 set if ESCAPE pressed
8284	.e7d9		0a		asl a		                asl a                        ;C=1 if ESCAPE pressed
8285	.e7da		a9 1b		lda #$1b	                lda #27                      ;ASCII for ESCAPE
8286	.e7dc		b0 15		bcs $e7f3	                bcs osrdchDone               ;exit with C=1 if ESCAPE
8287							                                             ;pressed
8288							                .if version!=400
8289	.e7de		ae 41 02	ldx $0241	                ldx inputSource
8290							                .endif
8291	.e7e1		20 fd ea	jsr $eafd	                jsr readFromEconetOrSoftKeyOrInputBufferA ;handle Econet/soft key stuff???
8292	.e7e4		90 0d		bcc $e7f3	                bcc osrdchDone
8293	.e7e6		24 e6		bit $e6		                bit readCharacterTimedFlag
8294	.e7e8		10 ed		bpl $e7d7	                bpl osrdchLoop     ;taken if no timeout - keep looping
8295	.e7ea		ad b2 02	lda $02b2	                lda inkeyTimeoutCounter+1
8296	.e7ed		0d b1 02	ora $02b1	                ora inkeyTimeoutCounter+0
8297	.e7f0		d0 e5		bne $e7d7	                bne osrdchLoop     ;taken if timeout not timed out yet
8298	.e7f2		3a		dec a		                dec a              ;timed out: A=$ff, C=1
8299	.e7f3						osrdchDone:
8300	.e7f3		7a		ply		                ply
8301	.e7f4		fa		plx		                plx
8302	.e7f5		60		rts		                rts

8304							;-------------------------------------------------------------------------

8306	.e7f6						starLIBFS:
8307	.e7f6		ad 01 df	lda $df01	                lda hazel.activeFS
8308	.e7f9		8d 02 df	sta $df02	                sta hazel.libFS
8309	.e7fc		60		rts		                rts

8311							;-------------------------------------------------------------------------

8313							                .if version<500
8314	.e7fd						starX:
8315	.e7fd		8d e8 fe	sta $fee8	                sta TUBE+8
8316	.e800						LE800:
8317	.e800		80 fe		bra $e800	                bra LE800
8318							                .endif

8320							;-------------------------------------------------------------------------
8321							;
8322							; OSCLI
8323							;
8324							; MasRef D.4-1
8325							;

8327	.e802						oscliEntryPoint: .block
8328	.e802		20 ba ed	jsr $edba	                jsr selectHAZEL
8329	.e805		86 f2		stx $f2		                stx stringInputBufferAddress+0
8330	.e807		84 f3		sty $f3		                sty stringInputBufferAddress+1
8331	.e809		a0 00		ldy #$00	                ldy #$00
8332	.e80b						-
8333	.e80b		b1 f2		lda ($f2),y	                lda (stringInputBufferAddress),y
8334	.e80d		99 00 dc	sta $dc00,y	                sta hazel.commandLine,y
8335	=$e811						emptyCommandLine=*+1                         ;arbitrary place that's
8336							                                             ;just a 13 byte...
8337	.e810		c9 0d		cmp #$0d	                cmp #$0D
8338	.e812		f0 04		beq $e818	                beq +     ;branch taken if end of command line reached
8339	.e814		c8		iny		                iny
8340	.e815		d0 f4		bne $e80b	                bne -

8342							                ; OSCLI is a no-op if the command line is too long.
8343	.e817		60		rts		                rts

8345	.e818						+
8346	.e818		a0 dc		ldy #$dc	                ldy #>hazel.commandLine
8347	.e81a		a2 00		ldx #$00	                ldx #<hazel.commandLine
8348	.e81c		20 84 f3	jsr $f384	                jsr withTerminalROM
8349	.e81f		4c ff 84	jmp $84ff	                jmp terminal.oscli
8350							                .endblock

8352	=$e811						emptyCommandLine=oscliEntryPoint.emptyCommandLine

8354							                ; OSWRCH
8355							                ; ======
8356	.e822						oswrchEntryPoint:
8357	.e822		48		pha		                pha                          ;S=[ch]
8358	.e823		da		phx		                phx                          ;S=[x; ch]
8359	.e824		5a		phy		                phy                          ;S=[y; x; ch]
8360	.e825		48		pha		                pha                          ;S=[ch; y; x; ch]
8361	.e826		2c 60 02	bit $0260	                bit econetOutputInterpretationStatus
8362	.e829		10 08		bpl $e833	                bpl LE833
8363	.e82b		a8		tay		                tay
8364	.e82c		a9 04		lda #$04	                lda #netWriteCharacterAttempted
8365	.e82e		20 04 eb	jsr $eb04	                jsr callNETV
8366	.e831		b0 72		bcs $e8a5	                bcs LE8A5
8367	.e833						LE833:
8368	.e833		a9 02		lda #$02	                lda #$02
8369	.e835		2c 7c 02	bit $027c	                bit characterDestinationStatus
8370	.e838		d0 28		bne $e862	                bne LE862
8371	.e83a		68		pla		                pla                          ;restore char to print
8372	.e83b		48		pha		                pha                          ;save it again
8373	.e83c		aa		tax		                tax                          ;X=char to print
8374	.e83d		ad 34 fe	lda $fe34	                lda ACCCON                   ;
8375	.e840		48		pha		                pha                          ;S=[old ACCCON; ch; y; x; ch]
8376							                .if version==350
8378							                .else
8379	.e841		a9 08		lda #$08	                lda #ACCCON.Y
8380	.e843		1c 34 fe	trb $fe34	                trb ACCCON                   ;MOS ROM at $c000
8381							                .endif
8382	.e846		a5 f4		lda $f4		                lda $F4
8383	.e848		48		pha		                pha          ;S=[old ROMSEL; old ACCCON; ch; y; x; ch]
8384	.e849		a9 8f		lda #$8f	                lda #$80|terminalROM
8385	.e84b		85 f4		sta $f4		                sta $F4
8386	.e84d		8d 30 fe	sta $fe30	                sta ROMSEL                   ;page in ANDY+Terminal
8387	.e850		8a		txa		                txa                          ;A=char to print
8388	.e851		20 27 c0	jsr $c027	                jsr outputToVDU
8389	.e854		68		pla		                pla
8390	.e855		85 f4		sta $f4		                sta $F4
8391	.e857		8d 30 fe	sta $fe30	                sta ROMSEL
8392	.e85a		68		pla		                pla
8393	.e85b		29 08		and #$08	                and #ACCCON.Y
8394	.e85d		0c 34 fe	tsb $fe34	                tsb ACCCON
8395	.e860		b0 07		bcs $e869	                bcs LE869
8396	.e862						LE862:
8397	.e862		a9 08		lda #$08	                lda #$08
8398	.e864		2c 7c 02	bit $027c	                bit characterDestinationStatus
8399	.e867		f0 05		beq $e86e	                beq LE86E
8400	.e869						LE869:
8401	.e869		68		pla		                pla
8402	.e86a		48		pha		                pha
8403	.e86b		20 aa e8	jsr $e8aa	                jsr LE8AA
8404	.e86e						LE86E:
8405							                .if version!=400
8406	.e86e		ad 7c 02	lda $027c	                lda characterDestinationStatus
8407	.e871		6a		ror a		                ror a
8408	.e872		90 1b		bcc $e88f	                bcc LE88F
8409	.e874		a4 ea		ldy $ea		                ldy $EA
8410	.e876		88		dey		                dey
8411	.e877		10 16		bpl $e88f	                bpl LE88F
8412	.e879		68		pla		                pla
8413	.e87a		48		pha		                pha
8414	.e87b		08		php		                php
8415	.e87c		78		sei		                sei
8416	.e87d		a2 02		ldx #$02	                ldx #$02
8417	.e87f		48		pha		                pha
8418	.e880		20 ef e9	jsr $e9ef	                jsr osbyte98
8419	.e883		90 03		bcc $e888	                bcc LE888
8420	.e885		20 08 e9	jsr $e908	                jsr clearRS423BusyAndSetRS423Active
8421	.e888						LE888:
8422	.e888		68		pla		                pla
8423	.e889		a2 02		ldx #$02	                ldx #$02
8424	.e88b		20 a3 e9	jsr $e9a3	                jsr LE9A3
8425	.e88e		28		plp		                plp
8426	.e88f						LE88F:
8427							                .endif

8429	.e88f		a9 10		lda #$10	                lda #$10
8430	.e891		2c 7c 02	bit $027c	                bit characterDestinationStatus
8431	.e894		d0 0f		bne $e8a5	                bne LE8A5
8432	.e896		ac 57 02	ldy $0257	                ldy spoolFileHandle
8433	.e899		f0 0a		beq $e8a5	                beq LE8A5
8434	.e89b		68		pla		                pla
8435	.e89c		48		pha		                pha
8436	.e89d		38		sec		                sec
8437	.e89e		66 eb		ror $eb		                ror $EB
8438	.e8a0		20 d4 ff	jsr $ffd4	                jsr OSBPUT
8439	.e8a3		46 eb		lsr $eb		                lsr $EB
8440	.e8a5						LE8A5:
8441	.e8a5		68		pla		                pla
8442	.e8a6		7a		ply		                ply
8443	.e8a7		fa		plx		                plx
8444	.e8a8		68		pla		                pla
8445	.e8a9		60		rts		                rts

8447	.e8aa						LE8AA:
8448	.e8aa		2c 7c 02	bit $027c	                bit characterDestinationStatus
8449	.e8ad		70 25		bvs $e8d4	                bvs LE8D4
8450	.e8af		cd 86 02	cmp $0286	                cmp printerIgnoreChar
8451	.e8b2		d0 05		bne $e8b9	                bne LE8B9
8452	.e8b4		2c 46 02	bit $0246	                bit noignoreState
8453	.e8b7		10 1b		bpl $e8d4	                bpl LE8D4
8454	.e8b9						LE8B9:
8455	.e8b9		08		php		                php
8456	.e8ba		78		sei		                sei
8457	.e8bb		aa		tax		                tax
8458	.e8bc		a9 04		lda #$04	                lda #$04
8459	.e8be		2c 7c 02	bit $027c	                bit characterDestinationStatus
8460	.e8c1		d0 10		bne $e8d3	                bne LE8D3
8461	.e8c3		8a		txa		                txa
8462	.e8c4		a2 03		ldx #$03	                ldx #$03
8463	.e8c6		20 a3 e9	jsr $e9a3	                jsr LE9A3
8464	.e8c9		b0 08		bcs $e8d3	                bcs LE8D3
8465	.e8cb		2c d1 02	bit $02d1	                bit bufferEmptyFlags+bufferPrinter
8466	.e8ce		10 03		bpl $e8d3	                bpl LE8D3
8467	.e8d0		20 d5 e8	jsr $e8d5	                jsr LE8D5
8468	.e8d3						LE8D3:
8469	.e8d3		28		plp		                plp
8470	.e8d4						LE8D4:
8471	.e8d4		60		rts		                rts

8473	.e8d5						LE8D5:                                       ;E7CA in MOS 4.00
8474	.e8d5		ad 85 02	lda $0285	                lda printerDriverType
8475							                .if version!=400
8476	.e8d8		f0 7f		beq $e959	                beq LE959
8477	.e8da		3a		dec a		                dec a
8478	.e8db		d0 20		bne $e8fd	                bne LE8FD
8479	.e8dd		20 f4 e9	jsr $e9f4	                jsr osbyte91
8480	.e8e0		6e d1 02	ror $02d1	                ror bufferEmptyFlags+bufferPrinter
8481	.e8e3		30 43		bmi $e928	                bmi rtsE928
8482	.e8e5		a0 82		ldy #$82	                ldy #$82
8483	.e8e7		8c 6e fe	sty $fe6e	                sty userVIA.ier
8484	.e8ea		8d 61 fe	sta $fe61	                sta userVIA.ora
8485	.e8ed		ad 6c fe	lda $fe6c	                lda userVIA.pcr
8486	.e8f0		29 f1		and #$f1	                and #$F1
8487	.e8f2		09 0c		ora #$0c	                ora #$0C
8488	.e8f4		8d 6c fe	sta $fe6c	                sta userVIA.pcr
8489	.e8f7		09 0e		ora #$0e	                ora #$0E
8490	.e8f9		8d 6c fe	sta $fe6c	                sta userVIA.pcr
8491	.e8fc		60		rts		                rts

8493	.e8fd						LE8FD:
8494	.e8fd		3a		dec a		                dec a
8495	.e8fe		d0 29		bne $e929	                bne activatePrinterDriver
8496	.e900		a4 ea		ldy $ea		                ldy $EA
8497	.e902		88		dey		                dey
8498	.e903		10 54		bpl $e959	                bpl LE959
8499	.e905		4e d1 02	lsr $02d1	                lsr bufferEmptyFlags+bufferPrinter
8500	.e908						clearRS423BusyAndSetRS423Active:
8501	.e908		4e 4f 02	lsr $024f	                lsr rs423Busy
8502	.e90b						setRS423Active:
8503	.e90b		20 27 ed	jsr $ed27	                jsr getRS423InputBufferFreeBytes
8504	.e90e		90 18		bcc $e928	                bcc rtsE928
8505	.e910		a2 20		ldx #$20	                ldx #ACIA.control.rtsLowTXInterruptEnabled
8506	.e912						resetACIA:
8507	.e912		a0 9f		ldy #$9f	                ldy #ACIA.control.rtsRTSInterruptEnabled|ACIA.control.word8DataOddParity1Stop|ACIA.control.reset

8509							;-------------------------------------------------------------------------
8510							;
8511							; OSBYTE 156 (&9C) Read/write serial ACIA control [MasRef D.2-47]
8512							;
8513	.e914						osbyte9C:
8514	.e914		08		php		                php
8515	.e915		78		sei		                sei
8516	.e916		98		tya		                tya
8517	.e917		86 fa		stx $fa		                stx SEIWKA
8518	.e919		2d 50 02	and $0250	                and aciaControlRegister
8519	.e91c		45 fa		eor $fa		                eor SEIWKA
8520	.e91e		ae 50 02	ldx $0250	                ldx aciaControlRegister
8521	.e921						writeACIAControlRegister:
8522	.e921		8d 50 02	sta $0250	                sta aciaControlRegister
8523	.e924		8d 08 fe	sta $fe08	                sta ACIA.control
8524	.e927		28		plp		                plp
8525	.e928						rtsE928:
8526	.e928		60		rts		                rts

8537							                .endif

8539							;-------------------------------------------------------------------------

8541	.e929						activatePrinterDriver:
8542	.e929		18		clc		                clc
8543	.e92a		a9 01		lda #$01	                lda #printerDriverActivate
8544	.e92c		20 3a e9	jsr $e93a	                jsr callPrinterDriverWithPrinterBuffer

8546							                ; printer driver will set C=0 if active, C=1 if
8547							                ; inactive.

8549							;-------------------------------------------------------------------------
8550							;
8551							; OSBYTE 123 (&7B) Inform MOS of printer driver going dormant [MasRef
8552							; D.2-36]
8553							;
8554	.e92f						osbyte7B:
8555	.e92f		6e d1 02	ror $02d1	                ror bufferEmptyFlags+bufferPrinter   ;C=1 on entry, so set bit 7
8556	.e932						rtsE932:
8557	.e932		60		rts		                rts

8559							;-------------------------------------------------------------------------

8561	.e933						pollPrinterDriver:
8562	.e933		2c d1 02	bit $02d1	                bit bufferEmptyFlags+bufferPrinter
8563	.e936		30 fa		bmi $e932	                bmi rtsE932           ;taken if printer driver dormant
8564	.e938		a9 00		lda #$00	                lda #printerDriverPoll
8565	.e93a						callPrinterDriverWithPrinterBuffer:
8566	.e93a		a2 03		ldx #$03	                ldx #bufferPrinter
8567	.e93c						callPrinterDriver:
8568	.e93c		ac 85 02	ldy $0285	                ldy printerDriverType
8569	.e93f		20 04 eb	jsr $eb04	                jsr callNETV
8570	.e942		6c 22 02	jmp ($0222)	                jmp (UPTV)

8572							;-------------------------------------------------------------------------
8573							;
8574							; OSBYTE 15 (&0F) Flush buffer
8575							;
8576	.e945						osbyte0F:
8577	.e945		d0 0f		bne $e956	                bne LE956
8578	.e947						LE947:
8579	.e947		a2 08		ldx #$08	                ldx #$08
8580	.e949						LE949:
8581	.e949		58		cli		                cli
8582	.e94a		78		sei		                sei
8583	.e94b		20 51 e9	jsr $e951	                jsr osbyte15
8584	.e94e		ca		dex		                dex
8585	.e94f		10 f8		bpl $e949	                bpl LE949

8587							;-------------------------------------------------------------------------
8588							;
8589							; OSBYTE 21 (&15) Flush selected buffer
8590							;
8591	.e951						osbyte15:                                    ;e951
8592	.e951		e0 09		cpx #$09	                cpx #bufferMax+1
8593	.e953		90 04		bcc $e959	                bcc LE959
8594	.e955		60		rts		                rts

8596	.e956						LE956:
8597	.e956		ae 41 02	ldx $0241	                ldx inputSource
8598	.e959						LE959:
8599	.e959		18		clc		                clc
8600	.e95a						LE95A:
8601	.e95a		48		pha		                pha
8602	.e95b		08		php		                php
8603	.e95c		78		sei		                sei
8604	.e95d		b0 08		bcs $e967	                bcs LE967
8605	.e95f		8a		txa		                txa
8606	.e960		29 04		and #$04	                and #$04                     ;buffer 4-7?
8607	.e962		f0 03		beq $e967	                beq LE967                    ;taken if not sound buffer
8608	.e964		20 5d f5	jsr $f55d	                jsr clearSoundChannelBuffer
8609	.e967						LE967:
8610	.e967		38		sec		                sec
8611	.e968		7e ce 02	ror $02ce,x	                ror bufferEmptyFlags,x
8612	.e96b		e0 02		cpx #$02	                cpx #bufferFirstOutput
8613	.e96d		b0 06		bcs $e975	                bcs LE975                    ;taken if output buffer
8614	.e96f		9c 68 02	stz $0268	                stz softKeyStringLength
8615	.e972		9c 6a 02	stz $026a	                stz vduQueueNegativeLength
8616	.e975						LE975:
8617	.e975		20 21 ed	jsr $ed21	                jsr purgeBufferViaCNPV
8618	.e978		28		plp		                plp
8619	.e979		68		pla		                pla
8620	.e97a		60		rts		                rts

8622							;-------------------------------------------------------------------------
8623							;
8624							; Count/purge entry point [AUG p264]
8625							;
8626	.e97b						cnpEntryPoint:
8627	.e97b		50 07		bvc $e984	                bvc countBuffer
8628	.e97d						purgeBuffer:
8629	.e97d		bd d7 02	lda $02d7,x	                lda bufferStartIndices,x
8630	.e980		9d e0 02	sta $02e0,x	                sta bufferEndIndices,x
8631	.e983		60		rts		                rts

8633	.e984						countBuffer:
8634	.e984		08		php		                php
8635	.e985		78		sei		                sei
8636	.e986		08		php		                php
8637	.e987		38		sec		                sec
8638	.e988		bd e0 02	lda $02e0,x	                lda bufferEndIndices,x
8639	.e98b		fd d7 02	sbc $02d7,x	                sbc bufferStartIndices,x
8640	.e98e		b0 04		bcs $e994	                bcs LE994
8641	.e990		38		sec		                sec
8642	.e991		fd db e9	sbc $e9db,x	                sbc bufferIndex0Offsets,x
8643	.e994						LE994:
8644	.e994		28		plp		                plp
8645	.e995		90 06		bcc $e99d	                bcc LE99D
8646	.e997		18		clc		                clc
8647	.e998		7d db e9	adc $e9db,x	                adc bufferIndex0Offsets,x
8648	.e99b		49 ff		eor #$ff	                eor #$FF
8649	.e99d						LE99D:
8650	.e99d		a0 00		ldy #$00	                ldy #$00
8651	.e99f		aa		tax		                tax
8652	.e9a0		28		plp		                plp
8653	.e9a1						rtsE9A1:
8654	.e9a1		60		rts		                rts

8656							;-------------------------------------------------------------------------

8658	.e9a2						LE9A2:
8659	.e9a2		58		cli		                cli
8660	.e9a3						LE9A3:
8661	.e9a3		78		sei		                sei
8662	.e9a4						LE9A4:
8663	.e9a4		20 40 ea	jsr $ea40	                jsr callINSV
8664	.e9a7		90 f8		bcc $e9a1	                bcc rtsE9A1
8665	.e9a9		20 41 f2	jsr $f241	                jsr LF241
8666	.e9ac		48		pha		                pha
8667	.e9ad		20 35 f7	jsr $f735	                jsr updateKeyboardLEDs
8668	.e9b0		0a		asl a		                asl a
8669	.e9b1		68		pla		                pla
8670	.e9b2		90 ee		bcc $e9a2	                bcc LE9A2
8671	.e9b4		60		rts		                rts

8673							;-------------------------------------------------------------------------
8674							;
8675							; OSBYTE $77
8676							;
8677							; D.2-33
8678							;
8679							                .if version!=350
8680	.e9b5						osbyte77:                       ;e9b5
8681	.e9b5		20 84 f3	jsr $f384	                jsr withTerminalROM
8682	.e9b8		4c 23 94	jmp $9423	                jmp terminal.L9423
8683							                .endif

8685							;-------------------------------------------------------------------------
8686							;
8687							; Get *IGNORE CMOS byte offset and mask for a given ROM.
8688							;
8689							; entry:
8690							;
8691							; Y = ROM number
8692							;
8693							; exit:
8694							;
8695							; A = mask
8696							;
8697							; X = RTC address of byte
8698							;
8699	.e9bb						getROMInsertedFlagRTCAddressAndMask:
8700	.e9bb		a9 00		lda #$00	                lda #$00
8701	.e9bd		38		sec		                sec
8702	.e9be		a2 14		ldx #$14	                ldx #CMOSBytes.insertedROMs+0+cmosBytesOffset
8703	.e9c0						-
8704	.e9c0		2a		rol a		                rol a
8705	.e9c1		d0 02		bne $e9c5	                bne +
8706	.e9c3		e8		inx		                inx
8707	.e9c4		2a		rol a		                rol a
8708	.e9c5						+
8709	.e9c5		88		dey		                dey
8710	.e9c6		10 f8		bpl $e9c0	                bpl -
8711	.e9c8		60		rts		                rts

8713							;-------------------------------------------------------------------------

8715	=[]						_:=[]
8716	=[($03e0,32)]					_..=[(bufferKeyboardAddress,bufferKeyboardSize)]
8717	=[($03e0,32),($0a00,256)]			_..=[(bufferRS423InputAddress,bufferRS423InputSize)]
8718	=[($03e0,32),($0a00,256),($0900,192)]		_..=[(bufferRS423OutputAddress,bufferRS423OutputSize)]
8719	=[($03e0,32),($0a00,256),($0900,192),($0880,64)]
							_..=[(bufferPrinterAddress,bufferPrinterSize)]
8720	=[($03e0,32),($0a00,256),($0900,192),($0880,64),($0840,16)]
							_..=[(bufferSoundChannel0Address,bufferSoundChannel0Size)]
8721	=[($03e0,32),($0a00,256),($0900,192),($0880,64),($0840,16),($0850,16)]
							_..=[(bufferSoundChannel1Address,bufferSoundChannel1Size)]
8722	=[($03e0,32),($0a00,256),($0900,192),($0880,64),($0840,16),($0850,16),($0860,16)]
							_..=[(bufferSoundChannel2Address,bufferSoundChannel2Size)]
8723	=[($03e0,32),($0a00,256),($0900,192),($0880,64),($0840,16),($0850,16),($0860,16),($0870,16)]
							_..=[(bufferSoundChannel3Address,bufferSoundChannel3Size)]
8724	=[($03e0,32),($0a00,256),($0900,192),($0880,64),($0840,16),($0850,16),($0860,16),($0870,16),($09c0,64)]
							_..=[(buffer8Address,buffer8Size)]
8725	=[($03e0,32),($0a00,256),($0900,192),($0880,64),($0840,16),($0850,16),($0860,16),($0870,16),($09c0,64)]
							buffers=_

8727							BufferTableIndex0Offset: .function buffer
8728							                .endfunction 256-buffer[1]

8730							BufferTableBase: .function buffer
8731							                .endfunction buffer[0]-BufferTableIndex0Offset(buffer)

8733							;-------------------------------------------------------------------------
8734							;
8735							; Buffer base addresses - each buffer's address, offset by the offset
8736							; for index 0 (see bufferIndex0Offsets).
8737							;
8738	.e9c9						bufferBaseAddressMSBs:
8739							                .for i=0,i<len(buffers),i+=1
8740	>e9c9		03				                .byte >BufferTableBase(buffers[i])
8740	>e9ca		0a				                .byte >BufferTableBase(buffers[i])
8740	>e9cb		08				                .byte >BufferTableBase(buffers[i])
8740	>e9cc		07				                .byte >BufferTableBase(buffers[i])
8740	>e9cd		07				                .byte >BufferTableBase(buffers[i])
8740	>e9ce		07				                .byte >BufferTableBase(buffers[i])
8740	>e9cf		07				                .byte >BufferTableBase(buffers[i])
8740	>e9d0		07				                .byte >BufferTableBase(buffers[i])
8740	>e9d1		09				                .byte >BufferTableBase(buffers[i])
8741							                .endfor

8743	.e9d2						bufferBaseAddressLSBs:
8744							                .for i=0,i<len(buffers),i+=1
8745	>e9d2		00				                .byte <BufferTableBase(buffers[i])
8745	>e9d3		00				                .byte <BufferTableBase(buffers[i])
8745	>e9d4		c0				                .byte <BufferTableBase(buffers[i])
8745	>e9d5		c0				                .byte <BufferTableBase(buffers[i])
8745	>e9d6		50				                .byte <BufferTableBase(buffers[i])
8745	>e9d7		60				                .byte <BufferTableBase(buffers[i])
8745	>e9d8		70				                .byte <BufferTableBase(buffers[i])
8745	>e9d9		80				                .byte <BufferTableBase(buffers[i])
8745	>e9da		00				                .byte <BufferTableBase(buffers[i])
8746							                .endfor

8748							;-------------------------------------------------------------------------

8750							; Offset of buffer index 0 for each buffer. Index 0 is (-buffer size)
8751							; - buffer indexes count up, and wrap once they reach 0.

8753	.e9db						bufferIndex0Offsets:
8754							                .for i=0,i<len(buffers),i+=1
8755	>e9db		e0				                .byte BufferTableIndex0Offset(buffers[i])
8755	>e9dc		00				                .byte BufferTableIndex0Offset(buffers[i])
8755	>e9dd		40				                .byte BufferTableIndex0Offset(buffers[i])
8755	>e9de		c0				                .byte BufferTableIndex0Offset(buffers[i])
8755	>e9df		f0				                .byte BufferTableIndex0Offset(buffers[i])
8755	>e9e0		f0				                .byte BufferTableIndex0Offset(buffers[i])
8755	>e9e1		f0				                .byte BufferTableIndex0Offset(buffers[i])
8755	>e9e2		f0				                .byte BufferTableIndex0Offset(buffers[i])
8755	>e9e3		c0				                .byte BufferTableIndex0Offset(buffers[i])
8756							                .endfor

8758							;-------------------------------------------------------------------------
8759							;
8760							; Get base address for a buffer.
8761							;
8762							; entry:
8763							;
8764							; X = buffer number
8765							;
8766							; exit:
8767							;
8768							; (SEIWKA) = buffer base address
8769							;
8770	.e9e4						getBufferBaseAddress:
8771	.e9e4		bd d2 e9	lda $e9d2,x	                lda bufferBaseAddressLSBs,x
8772	.e9e7		85 fa		sta $fa		                sta SEIWKA
8773	.e9e9		bd c9 e9	lda $e9c9,x	                lda bufferBaseAddressMSBs,x
8774	.e9ec		85 fb		sta $fb		                sta SEIWKB
8775	.e9ee		60		rts		                rts

8777							;-------------------------------------------------------------------------
8778							;
8779							; OSBYTE 152 (&98) Examine buffer status [MasRef D.2-45]
8780							;
8781	.e9ef						osbyte98:
8782	.e9ef		2c 4e e3	bit $e34e	                bit valueFF                  ;V=1
8783	.e9f2		80 01		bra $e9f5	                bra callREMV

8785							;-------------------------------------------------------------------------
8786							;
8787							; OSBYTE 145 (&91) Get character from buffer [MasRef D.2-45]
8788							;
8789							; X = buffer number
8790	.e9f4						osbyte91:
8791	.e9f4		b8		clv		                clv                          ;remove
8792	.e9f5						callREMV:
8793	.e9f5		6c 2c 02	jmp ($022c)	                jmp (REMV)

8795							;-------------------------------------------------------------------------
8796							;
8797							; Buffer remove entry point. [AUG p263]
8798							;
8799							; Even in remove mode, A is the character removed on exit. Some of the
8800							; other MOS routines rely on this.
8801							;
8802	.e9f8						remEntryPoint:
8803	.e9f8		08		php		                php
8804	.e9f9		78		sei		                sei
8805	.e9fa		bd d7 02	lda $02d7,x	                lda bufferStartIndices,x
8806	.e9fd		dd e0 02	cmp $02e0,x	                cmp bufferEndIndices,x
8807	.ea00		f0 6c		beq $ea6e	                beq plp_sec_rts  ;taken if buffer empty
8808	.ea02		a8		tay		                tay                          ;Y=start index
8809	.ea03		20 e4 e9	jsr $e9e4	                jsr getBufferBaseAddress
8810	.ea06		b1 fa		lda ($fa),y	                lda (SEIWKA),y               ;get byte from buffer
8811	.ea08		70 1a		bvs $ea24	                bvs tay_plp_clc_rts                  ;taken if only looking
8812	.ea0a		48		pha		                pha                          ;save buffered byte
8813	.ea0b		c8		iny		                iny                          ;next char in buffer
8814	.ea0c		98		tya		                tya                          ;set Z if wrap
8815	.ea0d		d0 03		bne $ea12	                bne +                        ;branch taken if no wrap
8816	.ea0f		bd db e9	lda $e9db,x	                lda bufferIndex0Offsets,x    ;reset index on wrap
8817	.ea12						+
8818	.ea12		9d d7 02	sta $02d7,x	                sta bufferStartIndices,x

8820							                ; Issue output buffer empty event when appropriate.
8821	.ea15		e0 02		cpx #$02	                cpx #bufferFirstOutput
8822	.ea17		90 0a		bcc $ea23	                bcc pla_tay_plp_clc_rts ;taken if keyboard or RS423
8823							                                        ;input - i.e., buffer is input
8824	.ea19		dd e0 02	cmp $02e0,x	                cmp bufferEndIndices,x       ;buffer now empty?
8825	.ea1c		d0 05		bne $ea23	                bne pla_tay_plp_clc_rts           ;taken if not empty
8826	.ea1e		a0 00		ldy #$00	                ldy #eventOutputBufferEmpty
8827	.ea20		20 28 ea	jsr $ea28	                jsr eventEntryPoint
8828	.ea23						pla_tay_plp_clc_rts:
8829	.ea23		68		pla		                pla                          ;restore buffered byte
8830	.ea24						tay_plp_clc_rts:
8831	.ea24		a8		tay		                tay                          ;Y=buffered byte
8832	.ea25						plp_clc_rts:
8833	.ea25		28		plp		                plp
8834	.ea26		18		clc		                clc
8835	.ea27		60		rts		                rts

8837							;-------------------------------------------------------------------------
8838							;
8839							; [MasRef D.9-1]
8840							;
8841	.ea28						eventEntryPoint:
8842	.ea28		08		php		                php
8843	.ea29		78		sei		                sei
8844	.ea2a		48		pha		                pha
8845	.ea2b		b9 bf 02	lda $02bf,y	                lda eventEnabledFlags,y      ;is the event enabled?
8846	.ea2e		f0 3d		beq $ea6d	                beq pla_plp_sec_rts                    ;
8847	.ea30		98		tya		                tya
8848	.ea31		7a		ply		                ply
8849	.ea32		5a		phy		                phy
8850	.ea33		20 bf f8	jsr $f8bf	                jsr LF8BF
8851	.ea36		80 eb		bra $ea23	                bra pla_tay_plp_clc_rts

8853							;-------------------------------------------------------------------------
8854							;
8855							; Insert character into buffer and issue an event for it.
8856							;
8857							; entry:
8858							;
8859							; Y = buffer number
8860							;
8861	.ea38						insertCharacterIntoBuffer:
8862	.ea38		98		tya		                tya
8863	.ea39		a0 02		ldy #$02	                ldy #eventCharacterEnteringBuffer
8864	.ea3b		20 28 ea	jsr $ea28	                jsr eventEntryPoint
8865	.ea3e		a8		tay		                tay

8867							;-------------------------------------------------------------------------
8868							;
8869							; OSBYTE 138 (&8A) Insert character code into buffer [MasRef D.2-43]
8870							;
8871	.ea3f						osbyte8A:
8872	.ea3f		98		tya		                tya
8873	.ea40						callINSV:
8874	.ea40		6c 2a 02	jmp ($022a)	                jmp (INSV)

8876							;-------------------------------------------------------------------------
8877							;
8878							; Default INSV entry point [AUG p263]
8879							;
8880	.ea43						insEntryPoint:
8881	.ea43		08		php		                php
8882	.ea44		78		sei		                sei
8883	.ea45		48		pha		                pha                          ;save value to insert
8884	.ea46		bd e0 02	lda $02e0,x	                lda bufferEndIndices,x       ;get buffer index
8885	.ea49		1a		inc a		                inc a                        ;bump index
8886	.ea4a		d0 03		bne $ea4f	                bne +          ;taken if index hasn't wrapped around
8887	.ea4c		bd db e9	lda $e9db,x	                lda bufferIndex0Offsets,x        ;reset index due to wrap
8888	.ea4f						+
8889	.ea4f		dd d7 02	cmp $02d7,x	                cmp bufferStartIndices,x     ;are we at the start index?
8890	.ea52		f0 0e		beq $ea62	                beq bufferFull       ;taken if yes - i.e., buffer full
8891	.ea54		bc e0 02	ldy $02e0,x	                ldy bufferEndIndices,x       ;note old buffer end
8892	.ea57		9d e0 02	sta $02e0,x	                sta bufferEndIndices,x       ;update buffer end
8893	.ea5a		20 e4 e9	jsr $e9e4	                jsr getBufferBaseAddress
8894	.ea5d		68		pla		                pla                          ;restore value to insert
8895	.ea5e		91 fa		sta ($fa),y	                sta (SEIWKA),y               ;store byte in buffer
8896	.ea60		80 c3		bra $ea25	                bra plp_clc_rts              ;done

8898	.ea62						bufferFull
8899							                ; Issue input buffer full event when appropriate.
8900	.ea62		68		pla		                pla
8901	.ea63		e0 02		cpx #$02	                cpx #bufferFirstOutput
8902	.ea65		b0 07		bcs $ea6e	                bcs plp_sec_rts  ;taken if output buffer
8903	.ea67		a0 01		ldy #$01	                ldy #eventInputBufferFull
8904	.ea69		20 28 ea	jsr $ea28	                jsr eventEntryPoint
8905	.ea6c		48		pha		                pha
8906	.ea6d						pla_plp_sec_rts:
8907	.ea6d		68		pla		                pla
8908	.ea6e						plp_sec_rts:
8909	.ea6e		28		plp		                plp
8910	.ea6f		38		sec		                sec
8911	.ea70		60		rts		                rts

8913							;-------------------------------------------------------------------------
8914							;
8915							; Check if character is a letter - A-Z or a-z.
8916							;
8917							; Entry:
8918							;
8919							; A = character to test
8920							;
8921							; Exit:
8922							;
8923							; C=0 if character is letter, C=1 otherwise
8924							;
8925							; Preserves: A/X/Y
8926	.ea71						isLetter: .proc                 ;EA71
8927	.ea71		48		pha		                pha
8928	.ea72		29 df		and #$df	                and #$DF        ;convert to upper case
8929	.ea74		c9 5b		cmp #$5b	                cmp #'Z'+1
8930	.ea76		b0 04		bcs $ea7c	                bcs +           ;branch taken with C=1 if past Z
8931	.ea78		49 ff		eor #$ff	                eor #$FF
8932	.ea7a		c9 bf		cmp #$bf	                cmp #-'A'       ;C=1 if past A
8933	.ea7c						+
8934	.ea7c		68		pla		                pla
8935	.ea7d		60		rts		                rts
8936							                .pend

8938							;-------------------------------------------------------------------------
8939							;
8940							; OSBYTE 153 (&99) Insert character code into buffer, checking for
8941							; ESCAPE [MasRef D.2-46]
8942							;
8943	.ea7e						insertCharacterIntoKeyboardBuffer:
8944							                .if version==350
8947							                .endif
8948	.ea7e		a2 00		ldx #$00	                ldx #$00
8949	.ea80						osbyte99:
8950							                .if version!=400
8951	.ea80		8a		txa		                txa                          ;X=1 if RS423, 0 if keyboard
8952	.ea81		2d 45 02	and $0245	                and rs423InputInterpretationStatus ;A=0 if RS423 simulates keyboard, 1=default
8953	.ea84		d0 b9		bne $ea3f	                bne osbyte8A ;taken if default - don't treat RS423 as keyboard
8954							                .endif
8955	.ea86		98		tya		                tya          ;A=char
8956	.ea87		4d 6c 02	eor $026c	                eor escapeCharacter
8957	.ea8a		0d 75 02	ora $0275	                ora escapeKeyStatus
8958	.ea8d		d0 a9		bne $ea38	                bne insertCharacterIntoBuffer
8959	.ea8f		ad 58 02	lda $0258	                lda breakAndESCAPEEffect
8960	.ea92		6a		ror a		                ror a                        ;C=0 if normal ESCAPE action
8961	.ea93		98		tya		                tya                          ;A=char
8962	.ea94		b0 0a		bcs $eaa0	                bcs osbyte99Done             ;taken if ESCAPE inhibited
8963	.ea96		a0 06		ldy #$06	                ldy #eventESCAPEPressed
8964	.ea98		20 28 ea	jsr $ea28	                jsr eventEntryPoint
8965	.ea9b		90 03		bcc $eaa0	                bcc osbyte99Done             ;taken if event handled
8966	.ea9d		20 57 ec	jsr $ec57	                jsr osbyte7D
8967	.eaa0						osbyte99Done:
8968	.eaa0		18		clc		                clc
8969	.eaa1		60		rts		                rts

8971							;-------------------------------------------------------------------------

8973							; A = 0 (edit keys)/1 (ascii keys)/2 (F keys)
8974	.eaa2						handleCursorKeysAndCopy:
8975							                .if version<500
8976	.eaa2		6a		ror a		                ror a                        ;test edit keys mode bit 0
8977	.eaa3		68		pla		                pla                          ;restore translated value
8978	.eaa4		b0 17		bcs $eabd	                bcs clc_rts_EABD       ;taken if value was asciiKeys
8983							                .endif

8985	.eaa6						handleFunctionKey:
8986	.eaa6		98		tya		                tya
8987							                .if version<500&&version!=350
8988	.eaa7		29 0f		and #$0f	                and #$0F
8989							                .endif
8990							                .if version==350
8993							                .else
8994	.eaa9		48		pha		                pha
8995	.eaaa		98		tya		                tya
8996	.eaab		4a		lsr a		                lsr a
8997	.eaac		4a		lsr a		                lsr a
8998	.eaad		4a		lsr a		                lsr a
8999	.eaae		4a		lsr a		                lsr a
9000							                .endif
9001	.eaaf		49 04		eor #$04	                eor #$04
9002	.eab1		a8		tay		                tay
9003	.eab2		b9 65 02	lda $0265,y	                lda input192To207Interpretation-8,y
9004	.eab5		4a		lsr a		                lsr a
9005							                .if version<500&&version!=350
9006	.eab6		f0 7a		beq $eb32	                beq LEB32
9007	.eab8		68		pla		                pla
9008	.eab9		18		clc		                clc
9009	.eaba		79 65 02	adc $0265,y	                adc input192To207Interpretation-8,y
9030							                .endif

9032	.eabd						clc_rts_EABD:
9033	.eabd		18		clc		                clc
9034	.eabe		60		rts		                rts

9036							;-------------------------------------------------------------------------

9038	.eabf						copyCharNotRecognised:
9039	.eabf		20 b6 ef	jsr $efb6	                jsr vdu7EntryPoint           ;beep
9040	.eac2		fa		plx		                plx
9041	.eac3						readFromInputBufferX:
9042	.eac3		20 f4 e9	jsr $e9f4	                jsr osbyte91          ;extract character from buffer X
9043							                .if version<500&&version!=350
9044	.eac6		b0 60		bcs $eb28	                bcs rtsEB28           ;taken if buffer empty
9074							                .endif

9076							                .if version>=511||version==350
9079							                .endif

9081							                .if version!=400
9082	.eac8						LEAC8:
9083	.eac8		48		pha		                pha                   ;save character extracted
9084	.eac9		e0 01		cpx #$01	                cpx #bufferRS423Input ;was it RS423 input buffer?
9085	.eacb		d0 06		bne $ead3	                bne LEAD3             ;taken if not RS423 input buffer
9086	.eacd		20 0b e9	jsr $e90b	                jsr setRS423Active
9087	.ead0		38		sec		                sec
9088	.ead1		a2 01		ldx #$01	                ldx #bufferRS423Input

9090	.ead3						LEAD3:
9091	.ead3		68		pla		                pla                          ;restore char extracted
9092	.ead4		90 05		bcc $eadb	                bcc LEADB                    ;taken if keyboard buffer
9093	.ead6		ac 45 02	ldy $0245	                ldy rs423InputInterpretationStatus ;D.2-54
9094	.ead9		d0 4c		bne $eb27	                bne clc_rts_EB27             ;taken if default mode
9095							                .endif

9097	.eadb						LEADB:
9098	.eadb		a8		tay		                tay                          ;Y = char
9099	.eadc		10 49		bpl $eb27	                bpl clc_rts_EB27             ;if normal char, all good
9100	.eade		29 0f		and #$0f	                and #$0F
9101	.eae0		c9 0b		cmp #$0b	                cmp #$0B
9102	.eae2		90 c2		bcc $eaa6	                bcc handleFunctionKey        ;taken if F key
9103	.eae4		69 7b		adc #$7b	                adc #$7B    ;C=1, so +$7c - convert $0b-0$f to $87-$8B
9104	.eae6		48		pha		                pha         ;save translated value
9105	.eae7		ad 7d 02	lda $027d	                lda editKeysMode
9106	.eaea		d0 b6		bne $eaa2	                bne handleCursorKeysAndCopy  ;taken if not editKeys
9107	.eaec		ad 7c 02	lda $027c	                lda characterDestinationStatus
9108	.eaef		6a		ror a		                ror a                        ;C=rs423_enable
9109	.eaf0		6a		ror a		                ror a                        ;C=vdu_disable
9110	.eaf1		68		pla		                pla                          ;restore translated value
9111	.eaf2		b0 cf		bcs $eac3	                bcs readFromInputBufferX     ;taken if VDU output disabled
9112	.eaf4		c9 87		cmp #$87	                cmp #$87                     ;COPY?
9113	.eaf6		f0 31		beq $eb29	                beq readCopyChar
9114	.eaf8		da		phx		                phx                          ;save buffer number
9115	.eaf9		20 5d eb	jsr $eb5d	                jsr handleCursorKeyThunk     ;handle cursor key
9116	.eafc		fa		plx		                plx
9117	.eafd						readFromEconetOrSoftKeyOrInputBufferA:
9118							                .if version==400
9120							                .endif
9121	.eafd		2c 5f 02	bit $025f	                bit econetInputInterpretationStatus
9122	.eb00		10 05		bpl $eb07	                bpl readFromSoftKeyOrInputBufferA
9123	.eb02		a9 06		lda #$06	                lda #netReadCharacterAttempted
9124	.eb04						callNETV:
9125	.eb04		6c 24 02	jmp ($0224)	                jmp (NETV)

9127	.eb07						readFromSoftKeyOrInputBufferA:
9128	.eb07		ad 68 02	lda $0268	                lda softKeyStringLength
9129	.eb0a		f0 b7		beq $eac3	                beq readFromInputBufferX
9130							                .if version>=500||version==350
9137							                .endif
9138							                .if version!=400
9139	.eb0c		8a		txa		                txa
9140	.eb0d		2d 45 02	and $0245	                and rs423InputInterpretationStatus
9141	.eb10		d0 b1		bne $eac3	                bne readFromInputBufferX
9142							                .endif
9143	.eb12		a5 f4		lda $f4		                lda $F4
9144	.eb14		48		pha		                pha
9145	.eb15		20 98 e5	jsr $e598	                jsr selectTerminalROMAndANDY2
9146	.eb18		b2 f8		lda ($f8)	                lda (softKeyExpansionPtr)
9147	.eb1a		fa		plx		                plx
9148	.eb1b		20 81 e5	jsr $e581	                jsr selectROMX
9149	.eb1e		ce 68 02	dec $0268	                dec softKeyStringLength
9150	.eb21		e6 f8		inc $f8		                inc softKeyExpansionPtr+0
9151	.eb23		d0 02		bne $eb27	                bne clc_rts_EB27
9152	.eb25		e6 f9		inc $f9		                inc softKeyExpansionPtr+1
9153	.eb27						clc_rts_EB27:
9154	.eb27		18		clc		                clc
9155	.eb28						rtsEB28:
9156	.eb28		60		rts		                rts

9158	.eb29						readCopyChar:
9159	.eb29		da		phx		                phx
9160	.eb2a		20 63 eb	jsr $eb63	                jsr handleCopyKeyThunk
9161							                .if version<500&&version!=350
9162	.eb2d		f0 90		beq $eabf	                beq copyCharNotRecognised
9167							                .endif
9168	.eb2f		fa		plx		                plx
9169	.eb30		18		clc		                clc
9170	.eb31						rtsEB31:
9171	.eb31		60		rts		                rts

9173							                .if version>=500||version==350
9184							                .elsif version<500

9186	.eb32						LEB32:
9187	.eb32		7a		ply		                ply
9188	.eb33		90 8e		bcc $eac3	                bcc readFromInputBufferX
9189	.eb35		98		tya		                tya
9190	.eb36		8d c9 02	sta $02c9	                sta currentSoftKey

9192							                .endif

9194	.eb39		a5 f4		lda $f4		                lda $F4
9195	.eb3b		48		pha		                pha                           ;save old ROMSEL
9196	.eb3c		20 98 e5	jsr $e598	                jsr selectTerminalROMAndANDY2
9197	.eb3f		20 55 eb	jsr $eb55	                jsr getSoftKeyStringLength
9198	.eb42		8d 68 02	sta $0268	                sta softKeyStringLength
9199	.eb45		b9 00 80	lda $8000,y	                lda andy.softKeys.stringLSBs,y
9200	.eb48		85 f8		sta $f8		                sta softKeyExpansionPtr+0
9201	.eb4a		b9 11 80	lda $8011,y	                lda andy.softKeys.stringMSBs,y
9202	.eb4d		85 f9		sta $f9		                sta softKeyExpansionPtr+1
9203	.eb4f		68		pla		                pla
9204	.eb50		20 92 e5	jsr $e592	                jsr selectROMA               ;restore old ROMSEL
9205	.eb53		80 a8		bra $eafd	                bra readFromEconetOrSoftKeyOrInputBufferA

9207							;-------------------------------------------------------------------------

9209	.eb55						getSoftKeyStringLength:
9210	.eb55		b9 01 80	lda $8001,y	                lda andy.softKeys.stringLSBs+1,y
9211	.eb58		38		sec		                sec
9212	.eb59		f9 00 80	sbc $8000,y	                sbc andy.softKeys.stringLSBs+0,y
9213	.eb5c		60		rts		                rts

9215							;-------------------------------------------------------------------------
9216							;
9217							; Page HAZEL out, page MOS in, call handleCursorKey.
9218							;
9219	.eb5d						handleCursorKeyThunk:
9220	.eb5d		20 ab f3	jsr $f3ab	                jsr withMOSROM
9221	.eb60		4c 78 df	jmp $df78	                jmp handleCursorKey

9223							;-------------------------------------------------------------------------
9224							;
9225							; Page HAZEL out, page MOS in, call handleCopyKey.
9226							;
9227	.eb63						handleCopyKeyThunk:
9228	.eb63		20 ab f3	jsr $f3ab	                jsr withMOSROM
9229	.eb66		4c 5e df	jmp $df5e	                jmp handleCopyKey

9231							;-------------------------------------------------------------------------

9233							                .if version==350&&!finmos329
9241							                .endif

9243							;-------------------------------------------------------------------------

9245							                .if version<500&&version!=350
9246							                .include "osbyte_osword_table.s65"

:15	;******  Processing file: src/osbyte_osword_table.s65

1							; OSBYTE Dispatch Table
2							; =====================

4							; TODO structure probably the same as
5							; https://tobylobster.github.io/mos/mos/S-s15.html#SP1...

7							; entry:
8							;
9							; A = OSBYTE A
10							;
11							; X = OSBYTE X
12							;
13							; Y = OSBYTE Y
14							;
15							; ?originalA, ?originalX, ?originalY = OSBYTE arguments
16							;
17							; C=1
18							;
19							; N/Z set as per X
20							;

22	.eb69						osbyteAndOSWORDRoutineTable:
23							                ;Display MOS version D.2-18
24	>eb69		6f ef				                .word mos.osbyte00

26							                ;Write user flag D.2-18
27	>eb6b		ce f0				                .word mos.osbyte01

29							                ;Specify input stream D.2-18
30							                .if version==400
32							                .else
33	>eb6d		b4 ec				                .word mos.osbyte02
34							                .endif

36							                ;Specify output stream D.2-19
37	>eb6f		a3 f0				                .word mos.osbyte03

39							                ;Enable/disable cursor editing
40	>eb71		d6 f0				                .word mos.osbyte04

42							                ;Write printer driver type D.2-20
43	>eb73		bc f0				                .word mos.osbyte05

45							                ;Write printer ignore character D.2-21
46	>eb75		b3 f0				                .word mos.osbyte06

48							                ;Write RS423 receive rate D.2-21
49							                .if version==400
51							                .else
52	>eb77		6d ec				                .word mos.osbyte07
53							                .endif

55							                ;Write RS423 transmit rate D.2-22
56							                .if version==400
58							                .else
59	>eb79		6b ec				                .word mos.osbyte08
60							                .endif

62							                ;Write duration of first colour D.2-22
63	>eb7b		92 ec				                .word mos.osbyte09

65							                ;Write duration of second colour D.2-22
66	>eb7d		94 ec				                .word mos.osbyte0A

68							                ;Write keyboard auto-repeat delay D.2-22
69	>eb7f		d4 f0				                .word mos.osbyte0B

71							                ;Write keyboard auto-repeat rate D.2-23
72	>eb81		d2 f0				                .word mos.osbyte0C

74							                ;Disable event D.2-23
75	>eb83		da ec				                .word mos.osbyte0D

77							                ;Enable event D.2-24
78	>eb85		db ec				                .word mos.osbyte0E

80							                ;Flush buffer D.2-24
81	>eb87		45 e9				                .word mos.osbyte0F

83							                ;Write number of ADC channels D.2-25
84							                .if version==400
86							                .else
87	>eb89		e7 ec				                .word mos.osbyte10
88							                .endif

90							                ;Write next ADC channel to be sampled D.2-25
91							                .if version==400
93							                .else
94	>eb8b		9c e7				                .word mos.osbyte11
95							                .endif

97							                ;Reset soft keys D.2-26
98	>eb8d		1a f1				                .word mos.osbyte12

100							                ;Wait for vertical sync D.2-26
101	>eb8f		f5 f0				                .word mos.osbyte13

103							                ;Restore default font definitions D.2-26
104	>eb91		1c f2				                .word osbyte14

106							                ;Flush selected buffer D.2-27
107	>eb93		51 e9				                .word mos.osbyte15

109							                ;Increment ROM polling semaphore D.2-27
110	>eb95		28 f2				                .word mos.osbyte16

112							                ;Decrement ROM polling semaphore D.2-27
113	>eb97		2c f2				                .word mos.osbyte17

115							                ; Reserved
116	>eb99		84 ed				                .word mos.osbyteUnused

118							                ;Restore a group of font definitions D.2-28
119	>eb9b		22 f2				                .word mos.osbyte19

121							                ; Not sure...
122							                .if version==350
126							                .endif

128							                ; Not sure...
129							                .if version==350
133							                .endif

135							                ;Write 1MHz bus selection status D.2-29
136	>eb9d		9e ee				                .word mos.osbyte6B

138							                ;Write usage of main/shadow memory D.2-30
139	>eb9f		a2 ee				                .word mos.osbyte6C

141							                ;Make temporary Filing System permanent D.2-30
142	>eba1		0f f2				                .word mos.osbyte6D

144							                ;Unused
145	>eba3		84 ed				                .word mos.osbyteUnused

147							                ;Unused
148	>eba5		84 ed				                .word mos.osbyteUnused

150							                ;Select main/shadow memory for VDU access D.2-31
151	>eba7		58 ed				                .word mos.osbyte70

153							                ;Select main/shadow memory for display D.2-31
154	>eba9		68 ed				                .word mos.osbyte71

156							                ;Write usage of shadow memory D.2-31
157	>ebab		b8 f0				                .word mos.osbyte72

159							                ;Unused
160	>ebad		aa ff				                .word mos.rtsFFAA

162							                ;Unused
163	>ebaf		aa ff				                .word mos.rtsFFAA

165							                ;Read VDU status D.2-32
166	>ebb1		b3 ef				                .word mos.osbyte75

168							                ;Reflect keyboard status in keyboard LEDs D.2-33
169	>ebb3		30 f2				                .word mos.osbyte76

171							                ;Close all *SPOOL/*SPOOLON or *EXEC files D.2-33
172							                .if version==350
174							                .else
175	>ebb5		b5 e9				                .word mos.osbyte77
176							                .endif

178							                ;Write keys pressed information D.2-33
179	>ebb7		0b f9				                .word mos.osbyte78

181							                ;Keyboard scan D.2-33
182	>ebb9		02 f9				                .word mos.callKEYV

184							                ;Keyboard scan from 16 decimal
185	>ebbb		10 f9				                .word mos.osbyte7A

187							                ;Inform MOS of printer driver going dormant
188	>ebbd		2f e9				                .word mos.osbyte7B

190							                ;Clear escape condition
191	>ebbf		56 ec				                .word mos.osbyte7C

193							                ;Set escape condition
194	>ebc1		57 ec				                .word mos.osbyte7D

196							                ;Acknowledge escape condition
197	>ebc3		3c ec				                .word mos.osbyte7E

199							                ;Check for end of file on an opened file
200	>ebc5		e3 f1				                .word mos.osbyte7F

202							                ;Read ADC channel or get buffer status
203							                .if version==400
205							                .else
206	>ebc7		35 ed				                .word mos.osbyte80
207							                .endif

209							                ;Read key with time limit
210	>ebc9		f4 ec				                .word mos.osbyte81

212							                ;Read machine high order address
213	>ebcb		0b ed				                .word mos.osbyte82

215							                ;Read Operating System High Water Mark (OSHWM)
216	>ebcd		05 f9				                .word mos.osbyte83

218							                ;Read top of user RAM
219	>ebcf		ba f1				                .word mos.osbyte84

221							                ;Read top of user RAM for given mode
222	>ebd1		d0 f1				                .word mos.osbyte85

224							                ;Read text cursor position
225	>ebd3		69 e2				                .word mos.osbyte86

227							                ;Read screen mode and character at text cursor position
228	>ebd5		dc f1				                .word mos.osbyte87

230							                ;Execute user code
231	>ebd7		37 ec				                .word mos.osbyte88

233							                .if version<400
234	>ebd9		61 ec				                .word mos.osbyte89 ;Switch cassette motor relay
239							                .endif

241							                ;Insert character code into buffer
242	>ebdb		3f ea				                .word mos.osbyte8A

244							                ;Write Filing System options
245	>ebdd		e2 f1				                .word mos.osbyte8B

247							                .if version<400
248	>ebdf		9a ed				                .word mos.osbyte8C8D ;Select Cassette Filing System
251							                .endif


254							                ;Select ROM Filing System
255	>ebe1		9a ed				                .word mos.osbyte8C8D

257							                ;Enter language ROM
258	>ebe3		c3 e4				                .word mos.osbyte8E

260							                ;Issue paged ROM service request
261	>ebe5		03 ee				                .word mos.osbyte8F

263							                ;Set vertical screen shift and interlace option
264	>ebe7		53 f3				                .word mos.osbyte90

266							                ;Get character from buffer
267	>ebe9		f4 e9				                .word mos.osbyte91

269							                ;Read from FRED (&FC00 â<80><93> &FCFF)
270	>ebeb		9e f8				                .word mos.osbyte92

272							                ;Write to FRED (&FC00 â<80><93> &FCFF)
273	>ebed		6e f3				                .word mos.osbyte93

275							                ;Read from JIM (&FD00 - &FDFF)
276	>ebef		ae f8				                .word mos.osbyte94

278							                ;Write to JIM (&FD00 - &FDFF)
279	>ebf1		64 f3				                .word mos.osbyte95

281							                ;Read from SHEILA (&FE00 - &FEFF)
282	>ebf3		ab ff				                .word mos.osbyte96

284							                ;Write to SHEILA (&FE00 - &FEFF)
285	>ebf5		69 f3				                .word mos.osbyte97

287							                ;Examine buffer status
288	>ebf7		ef e9				                .word mos.osbyte98

290							                ;Insert character code into buffer checking for escape
291							                .if version==400
293							                .else
294	>ebf9		80 ea				                .word mos.osbyte99
295							                .endif

297							                ;Write video ULA control register
298	>ebfb		4f f2				                .word mos.osbyte9A

300							                ;Write to video ULA palette register and copy
301	>ebfd		60 f2				                .word mos.osbyte9B

303							                ;Read/write serial ACIA control register and copy
304							                .if version==400
306							                .else
307	>ebff		14 e9				                .word mos.osbyte9C
308							                .endif

310							                ;Write byte across Tube
311	>ec01		af ff				                .word mos.osbyte9D

313							                ;reserved for the speech system
314	>ec03		84 ed				                .word mos.osbyteUnused

316							                ;reserved for the speech system
317	>ec05		84 ed				                .word mos.osbyteUnused

319							                ;Read VDU variable value
320	>ec07		ff f0				                .word mos.osbyteA0

322							                ;Read CMOS RAM
323							                .if version==350
325							                .else
326	>ec09		8e ed				                .word mos.osbyteA1
327							                .endif

329							                ;Write CMOS RAM
330							                .if version==350
332							                .else
333	>ec0b		94 ed				                .word mos.osbyteA2
334							                .endif

336							                ;reserved for applications software
337	>ec0d		84 ed				                .word mos.osbyteUnused

339							                ;Check processor type
340	>ec0f		47 e5				                .word mos.osbyteA4

342							                ;Read output cursor position
343	>ec11		3d e2				                .word mos.osbyteA5

345							                ;handle osbyte A6-FF
346	>ec13		db f0				                .word mos.osbyteA6

348							                ;*LINE - not part of the above table???
349	>ec15		39 ec				                .word mos.callUSERV

351							;-------------------------------------------------------------------------
352							;
353							; OSWORD dispatch table. Must follow on from the OSBYTE table.
354							;
355							; entry:
356							;
357							; A = 0th byte of parameter block
358							;
359							; X = OSWORD X
360							;
361							; Y = 0
362							;
363							; ?originalA, ?originalX, ?originalY = OSWORD arguments
364							;
365							; C=1
366							;
367							; N/Z set as per X
368							;
369	.ec17						oswordRoutineTable:

371							;Read line from input stream to memory
372	>ec17		2f f0				                .word mos.osword00

374							                ;Read system clock
375	>ec19		02 f0				                .word mos.osword01

377							                ;Write system clock
378	>ec1b		15 f0				                .word mos.osword02

380							                ;Read interval timer
381	>ec1d		fe ef				                .word mos.osword03

383							                ;Write interval timer
384	>ec1f		11 f0				                .word mos.osword04

386							                ;Read byte from I/O processor memory
387	>ec21		51 ef				                .word mos.osword05

389							                ;Write byte to I/O processor memory
390	>ec23		59 ef				                .word mos.osword06

392							                ;Generate a sound
393	>ec25		7b ef				                .word mos.osword07

395							                ;Define a sound envelope
396	>ec27		dc ef				                .word mos.osword08

398							                ;Read pixel logical colour
399	>ec29		50 f1				                .word mos.osword09

401							                ;Read a character definition
402	>ec2b		75 f1				                .word mos.osword0A

404							                ;Read the palette
405	>ec2d		3f f1				                .word mos.osword0B

407							                ;Write the palette
408	>ec2f		8d f1				                .word mos.osword0C

410							                ;Read current and previous graphics cursor positions
411	>ec31		9b f1				                .word mos.osword0D

413							                ;Read CMOS clock
414	>ec33		2f ef				                .word mos.osword0E

416							                ;Write CMOS clock
417							                .if version==350
419							                .else
420	>ec35		e8 f1				                .word mos.osword0F
421							                .endif

423							                .if version==350
427							                .endif

429							                .if version==350
433							                .endif


:13	;******  Return to file: src/mos.s65

9247							                .endif

9249							;-------------------------------------------------------------------------

9251	.ec37						osbyte88: ;LEC37:
9252	.ec37		a9 00		lda #$00	                lda #$00

9254	.ec39						callUSERV:
9255	.ec39		6c 00 02	jmp ($0200)	                jmp (USERV)

9257	.ec3c						osbyte7E:                       ;ec3c
9258	.ec3c		a2 00		ldx #$00	                ldx #$00
9259	.ec3e		24 ff		bit $ff		                bit $FF
9260	.ec40		10 14		bpl $ec56	                bpl osbyte7C
9261	.ec42		ad 76 02	lda $0276	                lda escapeEffects
9262	.ec45		d0 0d		bne $ec54	                bne LEC54
9263	.ec47		58		cli		                cli
9264	.ec48		9c 69 02	stz $0269	                stz pagedModeCounter
9265	.ec4b		20 84 f3	jsr $f384	                jsr withTerminalROM
9266	.ec4e		20 91 a5	jsr $a591	                jsr terminal.starEXEC
9267	.ec51		20 47 e9	jsr $e947	                jsr LE947
9268	.ec54						LEC54:
9269	.ec54		a2 ff		ldx #$ff	                ldx #$FF
9270	.ec56						osbyte7C: ;EC56
9271	.ec56		18		clc		                clc
9272	.ec57						osbyte7D: ;EC57
9273							                .if version<500
9274							                .if version==350
9278							                .endif
9279	.ec57		66 ff		ror $ff		                ror $FF
9280	.ec59		2c 7a 02	bit $027a	                bit tubePresence
9281	.ec5c		10 7b		bpl $ecd9	                bpl LECD9
9282	.ec5e		4c 03 04	jmp $0403	                jmp terminal.tubeHost.copyEscapeStatus
9292							                .endif

9294							;-------------------------------------------------------------------------

9296							                .if version<400
9297	.ec61						osbyte89:
9298	.ec61		ad 82 02	lda $0282	                lda serialULARegister
9299	.ec64		a8		tay		                tay
9300	.ec65		2a		rol a		                rol a
9301	.ec66		e0 01		cpx #$01	                cpx #$01
9302	.ec68		6a		ror a		                ror a
9303	.ec69		80 1e		bra $ec89	                bra LEC89
9304							                .endif

9306							;-------------------------------------------------------------------------
9307							;
9308							; ;OSBYTE 8 (&08) Write RS423 transmit rate
9309							;
9310							; This call sets the RS423 baud rate for transmitting data. The actual format of
9311							; the data is set using OSBYTE 156/&9C (see below).
9312							;
9313							; Entry parameters :
9314							; X=0 selects 9600 baud
9315							; X=1 selects 75 baud
9316							; X=2 selects 150 baud
9317							; X=3 selects 300 baud
9318							; X=4 selects 1200 baud
9319							; X=5 selects 2400 baud
9320							; X=6 selects 4800 baud
9321							; X=7 selects 9600 baud
9322							; X=8 selects 19200 baud
9323							; Y=0
9324							;
9325							; On exit : X=Y=<old serial ACIA control register contents>

9327							                .if version!=400
9328	.ec6b						osbyte08:
9329	.ec6b		a9 38		lda #$38	                lda #$38
9330							                ; fall through to OSBYTE &07
9331							                .endif

9333							;-------------------------------------------------------------------------
9334							;
9335							; OSBYTE 7 (&07) Write RS423 receive rate
9336							;
9337							; This call sets the RS423 baud rate for receiving data. The actual
9338							; format of the data is set using OSBYTE 156/&9C (see below).
9339							;
9340							; Entry parameters :
9341							; X=0 selects 9600 baud
9342							; X=1 selects 75 baud
9343							; X=2 selects 150 baud
9344							; X=3 selects 300 baud
9345							; X=4 selects 1200 baud
9346							; X=5 selects 2400 baud
9347							; X=6 selects 4800 baud
9348							; X=7 selects 9600 baud
9349							; X=8 selects 19200 baud
9350							; Y=0
9351							;
9352							; On exit : X=Y=<old serial ACIA control register contents>

9354							                .if version!=400
9355	.ec6d						osbyte07:                                    ;ec6d
9356	.ec6d		49 3f		eor #$3f	                eor #$3F                     ;if OSBYTE 8,
9357							                                             ;A=%00000111, mask for
9358							                                             ;transmit rate; if OSBYTE
9359							                                             ;8, A=%000111000, mask
9360							                                             ;for receive rate.
9361	.ec6f		85 fa		sta $fa		                sta $FA                      ;save mask
9362	.ec71		ac 82 02	ldy $0282	                ldy serialULARegister                    ;
9363	.ec74		e0 09		cpx #$09	                cpx #$09                     ;check for invalid baud rate
9364	.ec76		b0 17		bcs $ec8f	                bcs LEC8F                    ;branch taken if invalid
9365	.ec78		3d ec f0	and $f0ec,x	                and serialBaudRatesTable,x   ;get setting in A
9366	.ec7b		85 fb		sta $fb		                sta $FB                      ;store setting
9367	.ec7d		98		tya		                tya                          ;
9368	.ec7e		05 fa		ora $fa		                ora $FA
9369	.ec80		45 fa		eor $fa		                eor $FA
9370	.ec82		05 fb		ora $fb		                ora $FB
9371	.ec84		09 40		ora #$40	                ora #$40
9372	.ec86		4d 5d 02	eor $025d	                eor rs423Destination ;mask in tape/serial flag set by OSBYTE 205ac
9373	.ec89						LEC89:
9374	.ec89		8d 82 02	sta $0282	                sta serialULARegister
9375	.ec8c		8d 10 fe	sta $fe10	                sta SERPROC+0
9376	.ec8f						LEC8F:
9377	.ec8f		98		tya		                tya
9378	.ec90						LEC90:
9379	.ec90		aa		tax		                tax
9380	.ec91		60		rts		                rts
9381							                .endif

9383							                .if version==400
9388							                .endif

9390							;-------------------------------------------------------------------------

9392							; Y=0 on entry.

9394	.ec92						osbyte09:                       ;ec92
9395	.ec92		c8		iny		                iny
9396	.ec93		18		clc		                clc
9397	.ec94						osbyte0A:                                    ;ec94
9398	.ec94		b9 52 02	lda $0252,y	                lda firstFlashColourDuration,y
9399	.ec97		48		pha		                pha
9400	.ec98		8a		txa		                txa
9401	.ec99		99 52 02	sta $0252,y	                sta firstFlashColourDuration,y
9402	.ec9c		7a		ply		                ply
9403	.ec9d		ad 51 02	lda $0251	                lda flashCounter
9404	.eca0		d0 ed		bne $ec8f	                bne LEC8F
9405	.eca2		8e 51 02	stx $0251	                stx flashCounter
9406	.eca5		ad 48 02	lda $0248	                lda vcontrolRegister
9407	.eca8		08		php		                php
9408	.eca9		6a		ror a		                ror a
9409	.ecaa		28		plp		                plp
9410	.ecab		2a		rol a		                rol a
9411	.ecac		8d 48 02	sta $0248	                sta vcontrolRegister
9412	.ecaf		8d 20 fe	sta $fe20	                sta VCONTROL
9413	.ecb2		80 db		bra $ec8f	                bra LEC8F

9415							;-------------------------------------------------------------------------
9416							;
9417							; OSBYTE 2 (&02) Specify input stream
9418							;
9419							; Input may be taken from either the keyboard (by default) or the
9420							; RS423 port. This call specifies the selection for all subsequent
9421							; input.
9422							;
9423							; Entry parameters :
9424							; X=0 selects keyboard input and disables RS423
9425							; X=1 selects and enables RS423 input
9426							; X=2 selects keyboard input and enables RS423
9427							; Y=0
9428							;
9429							; On exit : X=0 indicates previous input was from the keyboard
9430							;           X=1 indicates previous input was from RS423
9431							;           Y is undefined
9432							;
9433							; D.2-18
9434							                .if version!=400
9435	.ecb4						osbyte02:                       ;ecb4
9436	.ecb4		8a		txa		                txa
9437	.ecb5		29 01		and #$01	                and #$01
9438	.ecb7		48		pha		                pha
9439	.ecb8		ad 50 02	lda $0250	                lda aciaControlRegister
9440	.ecbb		2a		rol a		                rol a
9441	.ecbc		e0 01		cpx #$01	                cpx #$01
9442	.ecbe		6a		ror a		                ror a
9443	.ecbf		cd 50 02	cmp $0250	                cmp aciaControlRegister
9444	.ecc2		08		php		                php
9445	.ecc3		8d 50 02	sta $0250	                sta aciaControlRegister
9446	.ecc6		8d 08 fe	sta $fe08	                sta ACIA+0
9447	.ecc9		20 0b e9	jsr $e90b	                jsr setRS423Active
9448	.eccc		28		plp		                plp
9449	.eccd		f0 03		beq $ecd2	                beq LECD2
9450	.eccf		2c 09 fe	bit $fe09	                bit ACIA+1
9451	.ecd2						LECD2:
9452	.ecd2		ae 41 02	ldx $0241	                ldx inputSource
9453	.ecd5		68		pla		                pla
9454	.ecd6		8d 41 02	sta $0241	                sta inputSource
9455	.ecd9						LECD9:
9456	.ecd9		60		rts		                rts
9457							                .endif

9459							;-------------------------------------------------------------------------
9460							;
9461							; OSBYTE 13 (&0D) Disable event
9462							;
9463							; All events are assigned a unique number and this call provides a
9464							; means of disabling specific events.
9465							;
9466							; Entry parameters:
9467							; X = event number
9468							;
9469							; On exit: X = Y = <old enable state> (0=disabled)
9470	.ecda						osbyte0D:
9471	.ecda		98		tya		                tya             ;A=0

9473							;-------------------------------------------------------------------------
9474							;
9475							; OSBYTE 14 (&0E) Enable event
9476							;
9477							; This call provides a means of enabling specific events.
9478							;
9479							;
9480	.ecdb						osbyte0E:
9481	.ecdb		e0 0a		cpx #$0a	                cpx #eventMax+1
9482							                .if version!=400
9483	.ecdd		b0 b1		bcs $ec90	                bcs LEC90
9486							                .endif
9487	.ecdf		bc bf 02	ldy $02bf,x	                ldy eventEnabledFlags,x
9488	.ece2		9d bf 02	sta $02bf,x	                sta eventEnabledFlags,x
9489							                .if version!=400
9490	.ece5		80 a8		bra $ec8f	                bra LEC8F
9499							                .endif

9501							;-------------------------------------------------------------------------
9502							;
9503							; OSBYTE 16 (&10) Write number of ADC channels
9504							;
9505							; By default, each of the four ADC channels is sampled and converted
9506							; in turn so that each reading is updated every 40 milliseconds. This
9507							; call enables the number of channels to be changed so that if, for
9508							; example, only two channels are required, each will be updated every
9509							; 20 milliseconds.
9510							;
9511							                .if version!=400
9512	.ece7						osbyte10:
9513							                .if version<500
9514	.ece7		f0 03		beq $ecec	                beq +                        ;taken if X=0
9515	.ece9		20 9c e7	jsr $e79c	                jsr osbyte11
9516	.ecec						+
9517							                .endif
9518	.ecec		ad 4d 02	lda $024d	                lda maximumADCChannel
9519	.ecef		8e 4d 02	stx $024d	                stx maximumADCChannel
9520	.ecf2		aa		tax		                tax
9521	.ecf3		60		rts		                rts
9522							                .endif

9524							;-------------------------------------------------------------------------
9525							;
9526							; OSBYTE 129 (&81) Read key with time limit
9527							;
9528							; This call may be used to read a key from the keyboard subject to a
9529							; specified time limit or to perform a keyboard scan for a specified
9530							; key depression.

9532	.ecf4						osbyte81:
9533	.ecf4		98		tya		                tya
9534	.ecf5		30 0a		bmi $ed01	                bmi LED01          ;taken if scanning for specific key
9535	.ecf7		20 b1 e7	jsr $e7b1	                jsr osbyte81Timed
9536	.ecfa		b0 03		bcs $ecff	                bcs LECFF                 ;taken if timed out or error
9537	.ecfc		aa		tax		                tax                       ;X = ASCII char
9538	.ecfd						LECFD:
9539	.ecfd		a9 00		lda #$00	                lda #$00
9540	.ecff						LECFF:
9541	.ecff		a8		tay		                tay
9542	.ed00		60		rts		                rts

9544	.ed01						LED01:
9545	.ed01		8a		txa		                txa
9546	.ed02		f0 10		beq $ed14	                beq LED14
9547	.ed04		49 7f		eor #$7f	                eor #$7F
9548	.ed06		aa		tax		                tax
9549	.ed07		20 02 f9	jsr $f902	                jsr callKEYV
9550	.ed0a		2a		rol a		                rol a
9551							                ; fall through

9553							;-------------------------------------------------------------------------

9555	.ed0b						osbyte82:
9556	.ed0b		a2 ff		ldx #$ff	                ldx #$FF
9557	.ed0d		a0 ff		ldy #$ff	                ldy #$FF
9558	.ed0f		b0 02		bcs $ed13	                bcs LEB13                    ;if OSBYTE $82, done
9559	.ed11		e8		inx		                inx
9560	.ed12		c8		iny		                iny
9561	.ed13						LEB13:
9562	.ed13		60		rts		                rts

9564	.ed14						LED14:
9565							                .if version==320
9566	.ed14		a2 fd		ldx #$fd	                ldx #$FD
9575							                .endif
9576	.ed16		80 e5		bra $ecfd	                bra LECFD

9578	.ed18						LED18:
9579							                .if version==400
9581							                .endif
9582	.ed18		8a		txa		                txa
9583	.ed19		49 ff		eor #$ff	                eor #$FF
9584	.ed1b		aa		tax		                tax
9585	.ed1c		e0 02		cpx #$02	                cpx #$02
9586							                ; fall through

9588							;-------------------------------------------------------------------------

9590	.ed1e						countBufferViaCNPV:
9591	.ed1e		b8		clv		                clv
9592	.ed1f		80 03		bra $ed24	                bra callCNPV

9594	.ed21						purgeBufferViaCNPV:
9595	.ed21		2c 4e e3	bit $e34e	                bit valueFF                  ;V=1
9596	.ed24						callCNPV:
9597	.ed24		6c 2e 02	jmp ($022e)	                jmp (CNPV)

9599							;-------------------------------------------------------------------------

9601							                .if version!=400
9602	.ed27						getRS423InputBufferFreeBytes:
9603	.ed27		38		sec		                sec
9604	.ed28		a2 01		ldx #$01	                ldx #bufferRS423Input
9605	.ed2a		20 1e ed	jsr $ed1e	                jsr countBufferViaCNPV
9606	.ed2d		c0 01		cpy #$01	                cpy #$01                     ;check MSB
9607	.ed2f		b0 03		bcs $ed34	                bcs +                        ;if >= 256 bytes, all good
9608	.ed31		ec 5b 02	cpx $025b	                cpx rs423InputBufferMinimumSpace ;compare to min space
9609	.ed34						+
9610	.ed34		60		rts		                rts
9611							                .endif

9613							;-------------------------------------------------------------------------

9615							                .if version!=400
9616	.ed35						osbyte80:
9617	.ed35		30 e1		bmi $ed18	                bmi LED18
9618	.ed37		f0 0c		beq $ed45	                beq LED45
9619							                .if version<500
9620	.ed39		e0 05		cpx #$05	                cpx #$05
9621	.ed3b		b0 ce		bcs $ed0b	                bcs osbyte82                 ;return with X=$ff Y=$ff
9622	.ed3d		bc b9 02	ldy $02b9,x	                ldy adcResultMSBs-1,x
9623	.ed40		bd b5 02	lda $02b5,x	                lda adcResultLSBs-1,x
9624	.ed43		aa		tax		                tax
9634							                .endif
9635	.ed44		60		rts		                rts
9636							                .endif

9638							;-------------------------------------------------------------------------

9640							                .if version!=400
9641	.ed45						LED45:
9642							                .if version<500
9643							                ; Put joystick buttons in bits 0/1.
9644	.ed45		ad 40 fe	lda $fe40	                lda systemVIA.irb
9645	.ed48		6a		ror a		                ror a
9646	.ed49		6a		ror a		                ror a
9647	.ed4a		6a		ror a		                ror a
9648	.ed4b		6a		ror a		                ror a
9649	.ed4c		49 ff		eor #$ff	                eor #$FF
9650	.ed4e		29 03		and #$03	                and #$03
9651	.ed50		ac be 02	ldy $02be	                ldy adcLastChannelRead
9652	.ed53		8e be 02	stx $02be	                stx adcLastChannelRead
9653	.ed56		aa		tax		                tax
9657							                .endif
9658	.ed57		60		rts		                rts
9659							                .endif

9661							;-------------------------------------------------------------------------
9662							;
9663							; OSBYTE $70
9664							;
9665							; D.2-31
9666							;
9667	.ed58						osbyte70:                       ;ed58
9668	.ed58		20 70 ed	jsr $ed70	                jsr osbyte7071
9669	.ed5b		0a		asl a		                asl a
9670	.ed5c		f0 04		beq $ed62	                beq clearACCCCONE
9671	.ed5e						LED5E:
9672	.ed5e		0c 34 fe	tsb $fe34	                tsb ACCCON
9673	.ed61		60		rts		                rts

9675	.ed62						clearACCCCONE:
9676	.ed62		a9 02		lda #$02	                lda #ACCCON.E
9677	.ed64						LED64:
9678	.ed64		1c 34 fe	trb $fe34	                trb ACCCON
9679	.ed67		60		rts		                rts

9681							;-------------------------------------------------------------------------

9683	.ed68						osbyte71:                       ;ed68
9684	.ed68		20 70 ed	jsr $ed70	                jsr osbyte7071
9685	.ed6b		d0 f1		bne $ed5e	                bne LED5E
9686	.ed6d		1a		inc a		                inc a
9687	.ed6e		80 f4		bra $ed64	                bra LED64

9689							;-------------------------------------------------------------------------
9690							;
9691							; Handle OSBYTE $70 or OSBYTE $71
9692							;
9693							; Entry: A=$70 or $71
9694							;
9695	.ed70						osbyte7071:
9696	.ed70		a8		tay		                tay
9697	.ed71		8a		txa		                txa
9698							                .cerror vduDriverMemory+1!=displayMemory
9699	.ed72		99 1a 02	sta $021a,y	                sta vduDriverMemory-$70,y
9700	.ed75		d0 09		bne $ed80	                bne LED80
9701	.ed77		a5 d0		lda $d0		                lda STATE
9702	.ed79		29 10		and #$10	                and #STATE.isShadowMode
9703	.ed7b		f0 06		beq $ed83	                beq LED83
9704	.ed7d						LED7D:
9705	.ed7d		a9 01		lda #$01	                lda #$01
9706	.ed7f		60		rts		                rts

9708	.ed80						LED80:
9709	.ed80		3a		dec a		                dec a
9710	.ed81		d0 fa		bne $ed7d	                bne LED7D
9711	.ed83						LED83:
9712	.ed83		60		rts		                rts

9714							;-------------------------------------------------------------------------

9716							; OSBYTE &6E (110), &6F (111)
9717							; ===========================
9718							; Pass to sideways ROMs
9719	.ed84						osbyteUnused:                   ;ed84
9720	.ed84		a2 07		ldx #$07	                ldx #romServiceCallUnrecognisedOSBYTE
9721	.ed86		20 72 ee	jsr $ee72	                jsr makeROMServiceCall
9722	.ed89		a6 f0		ldx $f0		                ldx originalX
9723							                .if version!=400
9724	.ed8b		49 00		eor #$00	                eor #$00
9725							                .endif
9726	.ed8d		60		rts		                rts

9728							;-------------------------------------------------------------------------

9730							                .if version!=350
9731	.ed8e						osbyteA1:
9732	.ed8e		20 84 f3	jsr $f384	                jsr withTerminalROM
9733	.ed91		4c b2 98	jmp $98b2	                jmp terminal.readCMOSByte
9734							                .endif

9736							;-------------------------------------------------------------------------

9738							                .if version!=350
9739	.ed94						osbyteA2:
9740	.ed94		20 84 f3	jsr $f384	                jsr withTerminalROM
9741	.ed97		4c dc 98	jmp $98dc	                jmp terminal.writeCMOSByte
9742							                .endif

9744							;-------------------------------------------------------------------------
9745							;
9746							; OSBYTE 140 (&8C) Select Cassette Filing System [MasRef D.2-43]
9747							; OSBYTE 141 (&8D) Select ROM Filing System [MasRef D.2-43]
9748							;
9749	.ed9a						osbyte8C8D:
9750	.ed9a		20 c0 ed	jsr $edc0	                jsr selectROMOrTAPEByOSBYTE
9751	.ed9d		ad 34 fe	lda $fe34	                lda ACCCON                    ; Save ACCON register
9752	.eda0		48		pha		                pha
9753	.eda1		20 ba ed	jsr $edba	                jsr selectHAZEL         ; Page Hazel workspace in
9754	.eda4		ae 01 df	ldx $df01	                ldx hazel.activeFS
9755	.eda7		8e 00 df	stx $df00	                stx hazel.currentFS
9756	.edaa		a9 0f		lda #$0f	                lda #terminalROM
9757	.edac		8d 03 df	sta $df03	                sta hazel.currentFSROM
9758	.edaf		68		pla		                pla                          ; Restore ACCON
9759	.edb0						selectMOSOrHAZEL:                                       ;edb0
9760	.edb0		29 08		and #$08	                and #ACCCON.Y   ;get just the HAZEL/MOS bit
9761	.edb2		d0 08		bne $edbc	                bne tsbACCCON   ;branch taken if HAZEL at $c000
9762	.edb4						selectMOS:
9763	.edb4		a9 08		lda #$08	                lda #ACCCON.Y
9764	.edb6		1c 34 fe	trb $fe34	                trb ACCCON      ;page in MOS at $c000
9765	.edb9		60		rts		                rts

9767	.edba						selectHAZEL:
9768	.edba		a9 08		lda #$08	                lda #ACCCON.Y
9769	.edbc						tsbACCCON:
9770	.edbc		0c 34 fe	tsb $fe34	                tsb ACCCON      ;page in HAZEL at $c000
9771	.edbf		60		rts		                rts

9773							;-------------------------------------------------------------------------

9775							                .if version==400
9779							                .endif

9781							;-------------------------------------------------------------------------
9782							;
9783							; Select ROM or TAPE.
9784							;
9785							; Two entry points: selectROMOrTAPEByOSBYTE picks FS by OSBYTE number
9786							; ($8c=TAPE, $8d=ROM), and selectROMOrTAPE picks FS by number (0=TAPE,
9787							; 1=ROM).
9788							;
9789							; entry:
9790							;
9791							; A = FS to select
9792							;
9793	.edc0						selectROMOrTAPEByOSBYTE:
9794							                .if version==400
9805							                .else

9807	.edc0		49 8c		eor #$8c	                eor #$8C                     ;A=0 if tape, A=1 if ROM
9808	.edc2						selectROMOrTAPE:
9809	.edc2		0a		asl a		                asl a           ; Set CFS/RFS switch to 0=CFS or 2=RFS
9810	.edc3		8d 47 02	sta $0247	                sta cfsRFSFSSwitch
9811	.edc6		d0 04		bne $edcc	                bne LEDCC                    ;taken if ROM
9812	.edc8		a9 04		lda #$04	                lda #$04                     ; CFS, clear b2 of status
9813	.edca		14 e2		trb $e2		                trb $E2
9814	.edcc						LEDCC:
9815	.edcc		e0 03		cpx #$03	                cpx #$03                     ; EQ=TAPE 300, NE=TAPE 1200
9816	.edce		80 06		bra $edd6	                bra LEDD6

9818	.edd0						LEDD0:
9819							                .if version==350
9821							                .endif
9822	.edd0		20 64 ee	jsr $ee64	                jsr LEE64
9823	.edd3		20 ee f1	jsr $f1ee	                jsr LF1EE
9824	.edd6						LEDD6:
9825	.edd6		08		php		                php                          ; Save baud flag in Carry
9826	.edd7		a9 06		lda #$06	                lda #$06                     ; Vectors about to change
9827	.edd9		20 e5 f1	jsr $f1e5	                jsr callFSCV
9828	.eddc		ad 47 02	lda $0247	                lda cfsRFSFSSwitch           ; Jump if RFS selected
9829	.eddf		d0 0d		bne $edee	                bne LEDEE
9830	.ede1		a2 06		ldx #$06	                ldx #$06                     ; Prepare baud=6 for TAPE300
9831	.ede3		28		plp		                plp                          ; Skip past if TAPE300
9832	.ede4		f0 05		beq $edeb	                beq LEDEB
9833	.ede6		a9 04		lda #$04	                lda #$04                     ; TAPE1200, set bit 2 of status
9834	.ede8		04 e2		tsb $e2		                tsb $E2
9835	.edea		ca		dex		                dex                          ; Change to baud=5 for TAPE1200
9836	.edeb						LEDEB:
9837	.edeb		86 c6		stx $c6		                stx $C6                      ; Store baud rate setting
9838	.eded		08		php		                php
9839	.edee						LEDEE:
9840	.edee		64 ce		stz $ce		                stz $CE                      ; Clear byte (unused on BBC)
9841	.edf0		28		plp		                plp
9842							                .endif

9844	.edf1		a2 0e		ldx #$0e	                ldx #defaultVectorTable.fsVectors.end-defaultVectorTable.fsVectors ; Prepare to set 7 vectors
9845	.edf3						LEDF3:
9846	.edf3		bd e8 e2	lda $e2e8,x	                lda defaultVectorTable.fsVectors-1,x ; Set filing
9847							                                                     ; system vectors
9848							                                                     ; to point to
9849							                                                     ; extended
9850							                                                     ; vectors
9851	.edf6		9d 11 02	sta $0211,x	                sta FILEV-1,x
9852	.edf9		ca		dex		                dex
9853	.edfa		d0 f7		bne $edf3	                bne LEDF3
9854	.edfc		20 ee f1	jsr $f1ee	                jsr LF1EE                    ; Set extended vectors
9855	.edff		64 c2		stz $c2		                stz $C2                      ; Set Progress=idle
9856	.ee01		a2 0f		ldx #$0f	                ldx #romServiceCallVectorsClaimed ; Send service call &0F - vectors changed

9858							;-------------------------------------------------------------------------
9859							;
9860							; OSBYTE 143 (&8F) Issue paged ROM service request [MasRef D.2-44]
9861							;
9862	.ee03						osbyte8F: .proc                    ;ee03
9863	.ee03		5a		phy		                phy
9864	.ee04		da		phx		                phx                          ; Send service call
9865	.ee05		20 72 ee	jsr $ee72	                jsr makeROMServiceCall
9866	.ee08		fa		plx		                plx
9867	.ee09		e0 0f		cpx #$0f	                cpx #romServiceCallVectorsClaimed ; If VectorsClaimed,
9868							                                                  ; hook FileSwitch
9869							                                                  ; back in
9870	.ee0b		f0 36		beq $ee43	                beq handleVectorsClaimed
9871	.ee0d		1a		inc a		                inc a       ; If claimed, check for
9872							                            ; InitialiseFilingSystem or
9873							                            ; UnrecognisedCommand
9874	.ee0e		3a		dec a		                dec a       ;Z=1 if claimed
9875	.ee0f		f0 03		beq $ee14	                beq wasClaimed  ;branch taken if claimed
9876	.ee11						done:
9877	.ee11		fa		plx		                plx             ; Return with result in X, EQ=Claimed
9878	.ee12		aa		tax		                tax
9879	.ee13		60		rts		                rts

9881	.ee14						wasClaimed:
9882	.ee14		e0 12		cpx #$12	                cpx #romServiceCallInitialiseFilingSystem
9883	.ee16		f0 04		beq $ee1c	                beq +
9884	.ee18		e0 04		cpx #$04	                cpx #romServiceCallUnrecognisedCommand
9885	.ee1a		d0 f5		bne $ee11	                bne done
9886	.ee1c						+

9888							; handle InitialiseFilingSystem ($12) or UnrecognisedCommand ($04)

9890	.ee1c		7a		ply		                ply                     ;Y=service call arg
9891	.ee1d		48		pha		                pha                     ;save A (though actually it's
9892							                                        ;always $00...)
9893	.ee1e		ad 34 fe	lda $fe34	                lda ACCCON
9894	.ee21		48		pha		                pha                     ;save ACCCON
9895	.ee22		20 ba ed	jsr $edba	                jsr selectHAZEL
9896	.ee25		38		sec		                sec
9897	.ee26		6e 00 df	ror $df00	                ror hazel.currentFS ;set currentFS bit 7
9898	.ee29						LEE29:
9899	.ee29		5a		phy		                phy             ;save ROM service call argument
9900	.ee2a		a9 00		lda #$00	                lda #$00
9901	.ee2c		a8		tay		                tay
9902	.ee2d		20 18 fa	jsr $fa18	                jsr callARGSV   ;A=0, Y=0 - get active FS number
9903	.ee30		8d 01 df	sta $df01	                sta hazel.activeFS ;save active FS number
9904	.ee33		2c 00 df	bit $df00	                bit hazel.currentFS
9905	.ee36		10 03		bpl $ee3b	                bpl LEE3B
9906	.ee38		20 0f f2	jsr $f20f	                jsr osbyte6D
9907	.ee3b						LEE3B:
9908	.ee3b		7a		ply		                ply
9909	.ee3c		68		pla		                pla
9910	.ee3d		20 b0 ed	jsr $edb0	                jsr selectMOSOrHAZEL
9911	.ee40		68		pla		                pla
9912	.ee41		aa		tax		                tax
9913	.ee42		60		rts		                rts

9915	.ee43						handleVectorsClaimed:
9916	.ee43		7a		ply		                ply
9917	.ee44		48		pha		                pha
9918	.ee45		ad 34 fe	lda $fe34	                lda ACCCON
9919	.ee48		48		pha		                pha
9920	.ee49		20 ba ed	jsr $edba	                jsr selectHAZEL
9921	.ee4c		ad 1e 02	lda $021e	                lda FSCV+0
9922	.ee4f		8d da df	sta $dfda	                sta hazel.activeFSCV+0
9923	.ee52		ad 1f 02	lda $021f	                lda FSCV+1
9924	.ee55		8d db df	sta $dfdb	                sta hazel.activeFSCV+1
9925	.ee58		a9 69		lda #$69	                lda #<fileswitchFSCEntryPoint
9926	.ee5a		8d 1e 02	sta $021e	                sta FSCV+0
9927	.ee5d		a9 fb		lda #$fb	                lda #>fileswitchFSCEntryPoint
9928	.ee5f		8d 1f 02	sta $021f	                sta FSCV+1
9929	.ee62		80 c5		bra $ee29	                bra LEE29
9930							                .pend

9932							;-------------------------------------------------------------------------

9934	.ee64						LEE64:
9935	.ee64		a9 a1		lda #$a1	                lda #$A1
9936	.ee66		85 e3		sta $e3		                sta $E3
9937	.ee68		a9 19		lda #$19	                lda #$19
9938	.ee6a		8d d1 03	sta $03d1	                sta $03D1
9939	.ee6d		a9 04		lda #$04	                lda #$04
9940	.ee6f		04 e2		tsb $e2		                tsb $E2
9941	.ee71		60		rts		                rts

9943							;-------------------------------------------------------------------------
9944							;
9945							; Pass service call around sideways ROMs
9946							;
9947							; Entry:
9948							; X=service call number
9949							; Y=any parameters
9950							;
9951							; Exit:
9952							; X=0 or preserved
9953							; Y=any returned parameters
9954							; EQ=call claimed if called directly
9955							;
9956	.ee72						makeROMServiceCall: .proc                    ;ee72
9957	.ee72		a5 f4		lda $f4		                lda $F4         ; Save current ROM
9958	.ee74		48		pha		                pha
9959	.ee75		ad 34 fe	lda $fe34	                lda ACCCON      ; Save current paging state
9960	.ee78		48		pha		                pha
9961	.ee79		20 ba ed	jsr $edba	                jsr selectHAZEL ; Page in Hazel
9962	.ee7c		8a		txa		                txa             ; Pass service call number to A
9963	.ee7d		a2 0f		ldx #$0f	                ldx #$0F     ; Start at ROM 15, and always call ROM 15
9964	.ee7f		80 05		bra $ee86	                bra callServiceEntry
9965	.ee81						callServiceEntriesLoop:
9966	.ee81		3c a1 02	bit $02a1,x	                bit romInformationTable,x ;check if ROM X has a service entry
9967	.ee84		10 0b		bpl $ee91	                bpl nextROM       ;branch taken if no service entry
9968	.ee86						callServiceEntry:
9969	.ee86		20 81 e5	jsr $e581	                jsr selectROMX  ; Page in ROM X
9970	.ee89		20 03 80	jsr $8003	                jsr $8003       ; Call ROM service entry point
9971	.ee8c		aa		tax		                tax             ; X = service call result
9972	.ee8d		f0 05		beq $ee94	                beq done       ;branch taken if service call claimed
9973	.ee8f		a6 f4		ldx $f4		                ldx $F4         ; Get ROM number
9974	.ee91						nextROM:
9975	.ee91		ca		dex		                dex       ; Step down to next ROM, loop until all done
9976	.ee92		10 ed		bpl $ee81	                bpl callServiceEntriesLoop

9978	.ee94						done:
9979	.ee94		68		pla		                pla                          ; Restore paging state
9980	.ee95		20 b0 ed	jsr $edb0	                jsr selectMOSOrHAZEL
9981	.ee98		68		pla		                pla                          ; Restore current ROM
9982	.ee99		20 92 e5	jsr $e592	                jsr selectROMA
9983	.ee9c		8a		txa		                txa                          ; Pass claim/noclaim to A
9984	.ee9d		60		rts		                rts
9985							                .pend

9987							;-------------------------------------------------------------------------

9989							; OSBYTE &6B (107) - Select memory for direct access
9990							; ==============================================
9991	.ee9e						osbyte6B:                       ;ee9e
9992	.ee9e		a0 20		ldy #$20	                ldy #$20                     ; Y=&20 to change 1MHz bit
9993	.eea0		80 02		bra $eea4	                bra LEEA4

9995							;-------------------------------------------------------------------------

9997							; OSBYTE &6C (108) - Select memory for direct access
9998							; ==============================================
9999	.eea2						osbyte6C:
10000	.eea2		a0 04		ldy #$04	                ldy #ACCCON.X                ; Y=&04 to change RAM bit
10001	.eea4						LEEA4:
10002	.eea4		98		tya		                tya                          ; Clear RAM or 1MHz bit
10003	.eea5		1c 34 fe	trb $fe34	                trb ACCCON
10004	.eea8		8a		txa		                txa                          ; If X=0, exit with normal RAM/1MHz selected
10005	.eea9		f0 05		beq $eeb0	                beq LEEB0
10006							                .if version==350
10008							                .else
10009	.eeab		a9 04		lda #$04	                lda #ACCCON.X                ; BUG! This should be TYA
10010							                .endif
10011	.eead		0c 34 fe	tsb $fe34	                tsb ACCCON                   ; Page in shadow RAM
10012	.eeb0						LEEB0:
10013	.eeb0		60		rts		                rts                          ; X preserved, Y=&04 or &20

10015							;-------------------------------------------------------------------------

10017							osword06Macro: .macro
10024							                .endmacro

10026							LEF1BMacro: .macro
10038							                .endmacro

10040							;-------------------------------------------------------------------------

10042							                .if version>=350
10045							                .endif

10047							;-------------------------------------------------------------------------

10049							                .if version>=500
10082							                .endif

10084							;-------------------------------------------------------------------------

10086							                .if version>=350
10092							                .endif

10094							;-------------------------------------------------------------------------

10096							                .if version>=500||version==350
10102							                .endif

10104							;-------------------------------------------------------------------------


10107							; OSBYTE
10108							; ======
10109	.eeb1						osbyteEntryPoint:
10110	.eeb1		48		pha		                pha
10111	.eeb2		08		php		                php
10112	.eeb3		78		sei		                sei
10113	.eeb4		85 ef		sta $ef		                sta originalA
10114	.eeb6		86 f0		stx $f0		                stx originalX
10115	.eeb8		84 f1		sty $f1		                sty originalY
10116	.eeba		a2 07		ldx #$07	                ldx #romServiceCallUnrecognisedOSBYTE
10117	.eebc		c9 6b		cmp #$6b	                cmp #$6B
10118	.eebe		90 40		bcc $ef00	                bcc osbyte00To6A
10119	.eec0		c9 a6		cmp #$a6	                cmp #$A6
10120	.eec2		90 09		bcc $eecd	                bcc osbyte6BToA5
10121	.eec4		c9 a6		cmp #$a6	                cmp #$A6
10122	.eec6		90 44		bcc $ef0c	                bcc handleUnrecognisedOSBYTEOrOSWORD       ;??? - wait... didn't we just do this?

10124	.eec8						osbyteA6ToFF:
10125	.eec8		18		clc		                clc
10126	.eec9						osbyteOrUSERV:      ;call OSBYTE A6+ routine if C=0; call USERV if C=1
10127	.eec9		a9 a6		lda #$a6	                lda #$A6
10128	.eecb		69 00		adc #$00	                adc #$00
10129							                .if version<350
10130	.eecd						osbyte6BToA5:
10131	.eecd		e9 50		sbc #$50	                sbc #$50        ;map $6b-$a5 to $1b-$56
10137							                .endif
10138	.eecf						osbyteUseTable:
10139	.eecf		0a		asl a		                asl a           ;table is of words
10140	.eed0		38		sec		                sec
10141	.eed1						callOSBYTEOrOSWORDFromTable:
10142	.eed1		84 f1		sty $f1		                sty originalY
10143	.eed3		a8		tay		                tay             ;get table offset in Y
10144	.eed4		2c 5e 02	bit $025e	                bit econetInterceptionStatus
10145	.eed7		10 07		bpl $eee0	                bpl LEEE0             ;taken if no Econet interception
10146	.eed9		8a		txa		                txa
10147							                .cerror (netOSBYTEAttempted!=romServiceCallUnrecognisedOSBYTE),"net/rom reason codes mismatch"
10148							                .cerror (netOSWORDAttempted!=romServiceCallUnrecognisedOSWORD),"net/rom reason codes mismatch"
10149	.eeda		b8		clv		                clv
10150	.eedb		20 04 eb	jsr $eb04	                jsr callNETV
10151	.eede		70 1a		bvs $eefa	                bvs LEEFA
10152	.eee0						LEEE0:
10153							                .if version>=500
10160							                .endif
10161							                .if version==350
10166							                .else
10167	.eee0		b9 6a eb	lda $eb6a,y	                lda osbyteAndOSWORDRoutineTable+1,y
10168	.eee3		85 fb		sta $fb		                sta SEIWKB
10169	.eee5		b9 69 eb	lda $eb69,y	                lda osbyteAndOSWORDRoutineTable,y
10170	.eee8		85 fa		sta $fa		                sta SEIWKA
10171							                .endif
10172							                .if version>=500
10179							                .endif
10180	.eeea		a5 ef		lda $ef		                lda originalA
10181	.eeec		a4 f1		ldy $f1		                ldy originalY
10182	.eeee		b0 04		bcs $eef4	                bcs +
10183	.eef0		a0 00		ldy #$00	                ldy #$00            ;??? - is this actually desirable?
10184	.eef2		b2 f0		lda ($f0)	                lda ($F0)           ;fetch 0th byte of parameter block
10185	.eef4						+
10186	.eef4		38		sec		                sec
10187							                .if version==350
10189							                .else
10190	.eef5		a6 f0		ldx $f0		                ldx originalX

10192							; on entry to the OSBYTE handlers, C=1, N/Z set as per X.

10194	.eef7		20 df f8	jsr $f8df	                jsr callSEIWKA
10195							                .endif
10196	.eefa						LEEFA:
10197	.eefa		6a		ror a		                ror a
10198	.eefb		28		plp		                plp
10199	.eefc		2a		rol a		                rol a
10200	.eefd		68		pla		                pla
10201	.eefe		b8		clv		                clv
10202	.eeff		60		rts		                rts

10204	.ef00						osbyte00To6A:
10205	.ef00		a0 00		ldy #$00	                ldy #$00        ;Y=0 on entry for this lot
10206	.ef02		c9 1a		cmp #$1a	                cmp #$1A        ;OSBYTE <=$19 is table-driven
10207	.ef04		90 c9		bcc $eecf	                bcc osbyteUseTable ;taken if OSBYTE $00-$19
10208							                .if version>=350
10213							                .endif
10214	.ef06		80 04		bra $ef0c	                bra handleUnrecognisedOSBYTEOrOSWORD

10216	.ef08						handleUnrecognisedOSWORD:
10217	.ef08		a2 08		ldx #$08	                ldx #romServiceCallUnrecognisedOSWORD
10218	.ef0a		68		pla		                pla
10219	.ef0b		68		pla		                pla
10220	.ef0c						handleUnrecognisedOSBYTEOrOSWORD:
10221	.ef0c		20 72 ee	jsr $ee72	                jsr makeROMServiceCall
10222							                .if version<500&&version!=350
10223	.ef0f		d0 04		bne $ef15	                bne LEF15
10226							                .endif
10227	.ef11		a6 f0		ldx $f0		                ldx originalX
10228	.ef13		80 e5		bra $eefa	                bra LEEFA
10229							                .if version<500&&version!=350
10230	.ef15						LEF15:
10231	.ef15		28		plp		                plp
10232	.ef16		68		pla		                pla
10233	.ef17		2c 4e e3	bit $e34e	                bit valueFF
10234	.ef1a		60		rts		                rts
10235							                .endif

10237							;-------------------------------------------------------------------------

10239							                .if version<350
10240	.ef1b						LEF1B:
10027	.ef1b		a5 eb		lda $eb		                lda $EB
10028	.ef1d		30 41		bmi $ef60	                bmi osword06.ret
10029	.ef1f		ad 57 02	lda $0257	                lda spoolFileHandle
10030	.ef22		d0 3c		bne $ef60	                bne osword06.ret
10031	.ef24		a9 08		lda #$08	                lda #$08
10032	.ef26		25 e2		and $e2		                and $E2
10033	.ef28		d0 04		bne $ef2e	                bne LEF2E
10034	.ef2a		a9 88		lda #$88	                lda #$88
10035	.ef2c		25 bb		and $bb		                and $BB
10036	.ef2e						LEF2E:
10037	.ef2e		60		rts		                rts
10241							                .endif

10243							;-------------------------------------------------------------------------
10244							;
10245							; OSWORD 14 (&0E) Read CMOS clock [MasRef D.3-22]
10246							;
10247							                .if version<350
10248	.ef2f						osword0E:
10249	.ef2f		c9 03		cmp #$03	                cmp #$03                   ;only codes 0/1/2 are valid
10250	.ef31		b0 d5		bcs $ef08	                bcs handleUnrecognisedOSWORD
10251	.ef33		20 84 f3	jsr $f384	                jsr withTerminalROM
10252	.ef36		4c b4 97	jmp $97b4	                jmp terminal.osword0E
10253							                .endif

10255							;-------------------------------------------------------------------------
10256							;
10257							; Entry point for OSWORD.
10258							;
10259							; D.3-3
10260							;
10261							                .if version<500
10262	.ef39						oswordEntryPoint:
10263	.ef39		48		pha		                pha             ;save OSWORD request
10264	.ef3a		08		php		                php
10265	.ef3b		78		sei		                sei
10266	.ef3c		85 ef		sta $ef		                sta originalA
10267	.ef3e		86 f0		stx $f0		                stx originalX
10268	.ef40		84 f1		sty $f1		                sty originalY
10269	.ef42		a2 08		ldx #$08	                ldx #romServiceCallUnrecognisedOSWORD
10270	.ef44		c9 e0		cmp #$e0	                cmp #$E0
10271	.ef46		b0 81		bcs $eec9	                bcs osbyteOrUSERV ;taken if OSWORD $E0 or higher -
10272							                                  ;these go via USERV

10274							                .if version<350
10275	.ef48		c9 10		cmp #$10	                cmp #16
10276	.ef4a		b0 c0		bcs $ef0c	                bcs handleUnrecognisedOSBYTEOrOSWORD ;taken if unknown OSWORD

10278							; adjust request number so it's a suitable index into the
10279							; OSBYTE/OSWORD routine table.

10281	.ef4c		69 57		adc #$57	                adc #(oswordRoutineTable-osbyteAndOSWORDRoutineTable)/2
10282	.ef4e		0a		asl a		                asl a
10283	.ef4f		80 80		bra $eed1	                bra callOSBYTEOrOSWORDFromTable

10302							                .endif
10303							                .endif

10305							;-------------------------------------------------------------------------
10306							;
10307							; OSWORD 5 (&05) Read byte from I/O processor memory [MasRef D.3-9]
10308							;
10309	.ef51						osword05:
10310	.ef51		20 63 ef	jsr $ef63	                jsr getAddressFromOSWORDParameterBlock
10311	.ef54		b2 fa		lda ($fa)	                lda (SEIWKA)                 ;read byte from the address
10312	.ef56		91 f0		sta ($f0),y	                sta (originalX),y                  ;update parameter block
10313	.ef58		60		rts		                rts

10315							;-------------------------------------------------------------------------
10316							;
10317							; OSWORD 6 (&06) Write byte to I/O processor memory [MasRef D.3-9]
10318							;

10320							                .if version<350
10321	.ef59						osword06:
10018	.ef59		20 63 ef	jsr $ef63	                jsr getAddressFromOSWORDParameterBlock
10019	.ef5c		b1 f0		lda ($f0),y	                lda (originalX),y
10020	.ef5e		92 fa		sta ($fa)	                sta (SEIWKA)
10021	.ef60						ret:
10022	.ef60		a9 00		lda #$00	                lda #$00
10023	.ef62		60		rts		                rts
10322							                .endif

10324							;-------------------------------------------------------------------------
10325							;
10326							; Get address from OSWORD parameter block.
10327							;
10328							; entry:
10329							;
10330							; A = 0th byte of parameter block
10331							;
10332							; Y = 0
10333							;
10334							; (originalX) = parameter block
10335							;
10336							; exit:
10337							;
10338							; (SEIWKA) = address, first two bytes from parameter block
10339							;
10340							; Y = 4 (this is just convenient for both callers)
10341							;
10342	.ef63						getAddressFromOSWORDParameterBlock:
10343	.ef63		85 fa		sta $fa		                sta SEIWKA
10344	.ef65		c8		iny		                iny
10345	.ef66		b1 f0		lda ($f0),y	                lda (originalX),y
10346	.ef68		85 fb		sta $fb		                sta SEIWKA+1
10347	.ef6a		a0 04		ldy #$04	                ldy #$04
10348	.ef6c						ldxim03_rts:
10349							                .if version<400
10350	.ef6c		a2 03		ldx #$03	                ldx #$03
10355							                .endif
10356	.ef6e		60		rts		                rts

10358							;-------------------------------------------------------------------------
10359							;
10360							; OSBYTE 0 (&00) Display MOS version
10361							;
10362							; OSBYTE 0 has the effect of performing a BRK instruction and
10363							; displaying the MOS version number.
10364							;
10365							; Entry parameters :
10366							;
10367							; X=0 executes a BRK and displays the OS version
10368							;
10369							; X=1 executes an RTS and returns the Operating system version
10370							;
10371							; On exit : X=<OS version>
10372							;
10373							; D.2-18
10374							;
10375	.ef6f						osbyte00:                       ;ef6f
10376	.ef6f		d0 fb		bne $ef6c	                bne ldxim03_rts ;branch taken if X<>0 - return with
10377							                                 ;X=3

10379							; do a BRK and print MOS version number.

10381	.ef71		00		brk #		                brk
10382	>ef72		f7				                .byte $f7
10383							                .if version==320
10384	>ef73		4f 53 20 33 2e 32 30		                .text "OS 3.20"
10409							                .endif
10410	>ef7a		00				                .byte 0

10412							;-------------------------------------------------------------------------
10413							;
10414							; OSWORD 7 (&07) Generate a sound [MasRef D.3-10]
10415							;
10416	.ef7b						osword07:
10417	.ef7b		c8		iny		                iny
10418	.ef7c		b1 f0		lda ($f0),y	                lda ($F0),y
10419	.ef7e		c9 20		cmp #$20	                cmp #$20
10420	.ef80		b0 86		bcs $ef08	                bcs handleUnrecognisedOSWORD
10421	.ef82		88		dey		                dey
10422	.ef83		20 f6 ef	jsr $eff6	                jsr LEFF6
10423	.ef86		09 04		ora #$04	                ora #$04
10424	.ef88		aa		tax		                tax
10425	.ef89		90 05		bcc $ef90	                bcc LEF90
10426	.ef8b		20 5a e9	jsr $e95a	                jsr LE95A
10427	.ef8e		a0 01		ldy #$01	                ldy #$01
10428	.ef90						LEF90:
10429	.ef90		20 f6 ef	jsr $eff6	                jsr LEFF6
10430	.ef93		85 fa		sta $fa		                sta $FA
10431	.ef95		08		php		                php
10432	.ef96		a0 06		ldy #$06	                ldy #$06
10433	.ef98		b1 f0		lda ($f0),y	                lda ($F0),y
10434	.ef9a		48		pha		                pha
10435	.ef9b		a0 04		ldy #$04	                ldy #$04
10436	.ef9d		b1 f0		lda ($f0),y	                lda ($F0),y
10437	.ef9f		48		pha		                pha
10438	.efa0		a0 02		ldy #$02	                ldy #$02
10439	.efa2		b1 f0		lda ($f0),y	                lda ($F0),y
10440	.efa4		2a		rol a		                rol a
10441	.efa5		3a		dec a		                dec a
10442	.efa6		3a		dec a		                dec a
10443	.efa7		0a		asl a		                asl a
10444	.efa8		0a		asl a		                asl a
10445	.efa9		05 fa		ora $fa		                ora $FA
10446	.efab		20 a3 e9	jsr $e9a3	                jsr LE9A3
10447	.efae		90 1e		bcc $efce	                bcc LEFCE
10448	.efb0		68		pla		                pla
10449	.efb1		68		pla		                pla
10450	.efb2		28		plp		                plp

10452							                ; WTF... fall through to OSBYTE $75!

10454							;-------------------------------------------------------------------------
10455							;
10456							; OSBYTE 117 (&75) Read VDU status [MasRef D.2-32]
10457							;
10458	.efb3						osbyte75:
10459	.efb3		a6 d0		ldx $d0		                ldx STATE
10460	.efb5		60		rts		                rts

10462							;-------------------------------------------------------------------------
10463							;
10464							; VDU 7 (&07) Produce BELL sound [MasRef E.3-4]
10465							;
10466	.efb6						vdu7EntryPoint:
10467	.efb6		08		php		                php
10468	.efb7		78		sei		                sei
10469	.efb8		ad 63 02	lda $0263	                lda bellChannel
10470	.efbb		29 07		and #$07	                and #$07
10471	.efbd		09 04		ora #$04	                ora #$04
10472	.efbf		aa		tax		                tax
10473	.efc0		ad 64 02	lda $0264	                lda bellSound
10474	.efc3		20 40 ea	jsr $ea40	                jsr callINSV
10475	.efc6		ad 66 02	lda $0266	                lda bellDuration
10476	.efc9		48		pha		                pha
10477	.efca		ad 65 02	lda $0265	                lda bellFrequency
10478	.efcd		48		pha		                pha
10479	.efce						LEFCE:
10480	.efce		38		sec		                sec
10481	.efcf		7e 00 08	ror $0800,x	                ror $0800,x
10482	.efd2		68		pla		                pla
10483	.efd3		20 40 ea	jsr $ea40	                jsr callINSV
10484	.efd6		68		pla		                pla
10485	.efd7		20 40 ea	jsr $ea40	                jsr callINSV
10486	.efda		28		plp		                plp
10487	.efdb		60		rts		                rts

10489							;-------------------------------------------------------------------------
10490							;
10491							; OSWORD 8 (&08) Define a sound envelope [MasRef D.3-14]
10492							;
10493	.efdc						osword08:
10494	.efdc		3a		dec a		                dec a                   ;get index of 1-based envelope
10495	.efdd		0a		asl a		                asl a
10496	.efde		0a		asl a		                asl a
10497	.efdf		0a		asl a		                asl a
10498	.efe0		0a		asl a		                asl a                        ;index*16
10499	.efe1		09 0f		ora #$0f	                ora #$0F                     ;index*16+15
10500	.efe3		aa		tax		                tax                          ;
10501	.efe4		a9 00		lda #$00	                lda #$00                     ;
10502	.efe6		a0 10		ldy #$10	                ldy #16             ;16 bytes of envelope data get set
10503	.efe8						-
10504	.efe8		c0 0e		cpy #$0e	                cpy #$0E                     ;
10505	.efea		b0 02		bcs $efee	                bcs + ;taken if last 2 bytes of data - they get initialized to $00
10506	.efec		b1 f0		lda ($f0),y	                lda (originalX),y        ;fetch byte from OSWORD block
10507	.efee						+
10508	.efee		9d c0 08	sta $08c0,x	                sta envelope1Data,x          ;set envelope data bytes
10509	.eff1		ca		dex		                dex
10510	.eff2		88		dey		                dey
10511	.eff3		d0 f3		bne $efe8	                bne -
10512	.eff5		60		rts		                rts

10514							;-------------------------------------------------------------------------

10516	.eff6						LEFF6:
10517	.eff6		b1 f0		lda ($f0),y	                lda ($F0),y
10518	.eff8		c9 10		cmp #$10	                cmp #$10
10519	.effa		29 03		and #$03	                and #$03
10520	.effc		c8		iny		                iny
10521	.effd		60		rts		                rts

10523							;-------------------------------------------------------------------------
10524							;
10525							; OSWORD 3 (&03) Read interval timer [MasRef D.3-8]
10526							;
10527	.effe						osword03:
10528	.effe		a2 0f		ldx #$0f	                ldx #$0F
10529	.f000		80 03		bra $f005	                bra LF005

10531							;-------------------------------------------------------------------------
10532							;
10533							; OSWORD 1 (&01) Read system clock [MasRef D.3-7]
10534							;
10535	.f002						osword01:
10536	.f002		ae 83 02	ldx $0283	                ldx timerSwitchState
10537	.f005						LF005:
10538	.f005		a0 04		ldy #$04	                ldy #$04
10539	.f007						-
10540	.f007		bd 8d 02	lda $028d,x	                lda timer0-initialTimerSwitchState,x
10541	.f00a		91 f0		sta ($f0),y	                sta (originalX),y
10542	.f00c		e8		inx		                inx
10543	.f00d		88		dey		                dey
10544	.f00e		10 f7		bpl $f007	                bpl -
10545	.f010						rtsF010:
10546	.f010		60		rts		                rts

10548							;-------------------------------------------------------------------------
10549							;
10550							; OSWORD 4 (&04) Write interval timer [MasRef D.3-9]
10551							;
10552	.f011						osword04:
10553	.f011		a9 0f		lda #$0f	                lda #intervalTimer-(timer0-initialTimerSwitchState)
10554	.f013		80 06		bra $f01b	                bra copyTIMEValue

10556							;-------------------------------------------------------------------------
10557							;
10558							; OSWORD 2 (&02) Write system clock [MasRef D.3-8]
10559							;
10560	.f015						osword02:
10561	.f015		ad 83 02	lda $0283	                lda timerSwitchState
10562	.f018		49 0f		eor #$0f	                eor #$0F       ;select the timer that isn't being used
10563	.f01a		18		clc		                clc
10564	.f01b						copyTIMEValue:
10565	.f01b		48		pha		                pha
10566	.f01c		aa		tax		                tax
10567	.f01d		a0 04		ldy #$04	                ldy #$04
10568	.f01f						-
10569	.f01f		b1 f0		lda ($f0),y	                lda (originalX),y
10570	.f021		9d 8d 02	sta $028d,x	                sta timer0-initialTimerSwitchState,x
10571	.f024		e8		inx		                inx
10572	.f025		88		dey		                dey
10573	.f026		10 f7		bpl $f01f	                bpl -
10574	.f028		68		pla		                pla
10575	.f029		b0 e5		bcs $f010	                bcs rtsF010
10576	.f02b		8d 83 02	sta $0283	                sta timerSwitchState
10577	.f02e		60		rts		                rts

10579							;-------------------------------------------------------------------------
10580							;
10581							; OSWORD 0 (&00) Read line from input stream to memory [MasRef D.3-6]
10582							;
10583	.f02f						osword00:
10584	.f02f		a0 04		ldy #$04	                ldy #$04
10585	.f031						LF031:
10586	.f031		b1 f0		lda ($f0),y	                lda (originalX),y
10587							                .cerror osword0MaxLineLength+1!=osword0MinASCIICharacter
10588							                .cerror osword0MinASCIICharacter+1!=osword0MaxASCIICharacter
10589	.f033		99 b1 02	sta $02b1,y	                sta osword0MaxLineLength-2,y
10590	.f036		88		dey		                dey
10591	.f037		c0 02		cpy #$02	                cpy #$02
10592	.f039		b0 f6		bcs $f031	                bcs LF031
10593	.f03b		b1 f0		lda ($f0),y	                lda ($F0),y
10594	.f03d		85 e9		sta $e9		                sta $E9
10595	.f03f		88		dey		                dey
10596	.f040		9c 69 02	stz $0269	                stz pagedModeCounter
10597	.f043		b2 f0		lda ($f0)	                lda ($F0)
10598	.f045		85 e8		sta $e8		                sta $E8
10599	.f047		58		cli		                cli
10600	.f048		80 07		bra $f051	                bra LF051

10602	.f04a						LF04A:
10603	.f04a		a9 07		lda #$07	                lda #$07
10604	.f04c						LF04C:
10605	.f04c		88		dey		                dey
10606	.f04d						LF04D:
10607	.f04d		c8		iny		                iny
10608	.f04e						LF04E:
10609	.f04e		20 ee ff	jsr $ffee	                jsr OSWRCH
10610	.f051						LF051:
10611	.f051		20 e0 ff	jsr $ffe0	                jsr OSRDCH
10612	.f054		b0 49		bcs $f09f	                bcs LF09F
10613	.f056		aa		tax		                tax
10614	.f057		ad 7c 02	lda $027c	                lda characterDestinationStatus
10615	.f05a		6a		ror a		                ror a
10616	.f05b		6a		ror a		                ror a
10617	.f05c		8a		txa		                txa
10618	.f05d		b0 05		bcs $f064	                bcs LF064
10619	.f05f		ae 6a 02	ldx $026a	                ldx vduQueueNegativeLength
10620	.f062		d0 ea		bne $f04e	                bne LF04E
10621	.f064						LF064:
10622	.f064		c9 7f		cmp #$7f	                cmp #$7F
10623	.f066		d0 07		bne $f06f	                bne LF06F
10624	.f068		c0 00		cpy #$00	                cpy #$00
10625	.f06a		f0 e5		beq $f051	                beq LF051
10626	.f06c		88		dey		                dey
10627	.f06d		80 df		bra $f04e	                bra LF04E

10629	.f06f						LF06F:
10630	.f06f		c9 15		cmp #$15	                cmp #$15
10631	.f071		d0 0d		bne $f080	                bne LF080
10632	.f073		98		tya		                tya
10633	.f074		f0 db		beq $f051	                beq LF051
10634	.f076		a9 7f		lda #$7f	                lda #$7F
10635	.f078						LF078:
10636	.f078		20 ee ff	jsr $ffee	                jsr OSWRCH
10637	.f07b		88		dey		                dey
10638	.f07c		d0 fa		bne $f078	                bne LF078
10639	.f07e		80 d1		bra $f051	                bra LF051

10641	.f080						LF080:
10642	.f080		91 e8		sta ($e8),y	                sta ($E8),y
10643	.f082		c9 0d		cmp #$0d	                cmp #$0D
10644	.f084		f0 13		beq $f099	                beq LF099
10645	.f086		cc b3 02	cpy $02b3	                cpy osword0MaxLineLength
10646	.f089		b0 bf		bcs $f04a	                bcs LF04A
10647	.f08b		cd b4 02	cmp $02b4	                cmp osword0MinASCIICharacter
10648	.f08e		90 bc		bcc $f04c	                bcc LF04C
10649	.f090		cd b5 02	cmp $02b5	                cmp osword0MaxASCIICharacter
10650	.f093		f0 b8		beq $f04d	                beq LF04D
10651	.f095		90 b6		bcc $f04d	                bcc LF04D
10652	.f097		80 b3		bra $f04c	                bra LF04C

10654	.f099						LF099:
10655	.f099		20 e7 ff	jsr $ffe7	                jsr OSNEWL
10656	.f09c		20 04 eb	jsr $eb04	                jsr callNETV
10657	.f09f						LF09F:
10658	.f09f		a5 ff		lda $ff		                lda $FF
10659	.f0a1		2a		rol a		                rol a
10660	.f0a2		60		rts		                rts

10662							;-------------------------------------------------------------------------
10663							;
10664							; OSBYTE 3 (&03) Specify output stream [MasRef D.2-19]
10665							;
10666	.f0a3						osbyte03:
10667	.f0a3		da		phx		                phx
10668	.f0a4		ae 7c 02	ldx $027c	                ldx characterDestinationStatus
10669	.f0a7		a9 0a		lda #$0a	                lda #printerDriverFX3
10670	.f0a9		20 3c e9	jsr $e93c	                jsr callPrinterDriver
10671	.f0ac		fa		plx		                plx
10672	.f0ad		a9 03		lda #$03	                lda #$03
10673	.f0af		a0 00		ldy #$00	                ldy #$00
10674	.f0b1		80 23		bra $f0d6	                bra osbyte04

10676							;-------------------------------------------------------------------------
10677							;
10678							; OSBYTE 6 (&06) Write printer ignore character [MasRef D.2-21]
10679							;
10680	.f0b3						osbyte06:                       ;f0b3
10681	.f0b3		4e 46 02	lsr $0246	                lsr noignoreState
10682	.f0b6		80 16		bra $f0ce	                bra osbyte01

10684							;-------------------------------------------------------------------------
10685							;
10686							; OSBYTE 114 (&72) Write usage of shadow memory [MasRef D.2-32]
10687							;
10688	.f0b8						osbyte72:                       ;f0b8
10689	.f0b8		a9 1f		lda #$1f	                lda #$1F
10690	.f0ba		80 10		bra $f0cc	                bra LF0CC

10692							;-------------------------------------------------------------------------
10693							;
10694							; OSBYTE 5 (&05) Write printer driver type [MasRef D.2-20]
10695							;
10696	.f0bc						osbyte05:
10697	.f0bc						waitForPrinterDriverDormant:
10698	.f0bc		58		cli		                cli
10699	.f0bd		78		sei		                sei
10700	.f0be		24 ff		bit $ff		                bit $FF                      ;test for ESCAPE
10701	.f0c0		30 29		bmi $f0eb	                bmi rtsF0EB                  ;taken if ESCAPE pressed
10702	.f0c2		2c d1 02	bit $02d1	                bit bufferEmptyFlags+bufferPrinter
10703	.f0c5		10 f5		bpl $f0bc	                bpl waitForPrinterDriverDormant ;taken if printer driver active
10704	.f0c7		20 3c e9	jsr $e93c	                jsr callPrinterDriver    ;call with A=printerDriverFX5
10705	.f0ca		a0 00		ldy #$00	                ldy #$00
10706	.f0cc						LF0CC:
10707	.f0cc		64 f1		stz $f1		                stz $F1

10709							                ; fall through to standard MOS variable handling,
10710							                ; affecting printerDriverType

10712							;-------------------------------------------------------------------------
10713							;
10714							; OSBYTE 1 (&01) Write user flag [MasRef D.2-18]
10715							;
10716	.f0ce						osbyte01:
10717	.f0ce		49 f0		eor #$f0	                eor #firstMOSVariableOSBYTE+(userFlag-mosVariables)-1 ;-1 because OSBYTE 1
10718	.f0d0		80 07		bra $f0d9	                bra osbyteA6X  ;jump to standard MOS variable handling

10720							;-------------------------------------------------------------------------
10721							;
10722							; OSBYTE 12 (&0C) Write keyboard auto-repeat rate [MasRef D.2-23]
10723							;
10724	.f0d2						osbyte0C:
10725	.f0d2		f0 33		beq $f107	                beq resetKeyRepeat    ;taken if X=0

10727							;-------------------------------------------------------------------------
10728							;
10729							; OSBYTE 11 (&0B) Write keyboard auto-repeat delay [MasRef D.2-22]
10730							;
10731	.f0d4						osbyte0B:
10732							                ; TODO - turn this constant into an expression
10733	.f0d4		69 cf		adc #$cf	                adc #$CF

10735							                ;if osbyte0C, A=$db
10736							                ;if osbyteOD, A=$dc

10738							;-------------------------------------------------------------------------
10739							;
10740							; OSBYTE 4 (&04) Enable/disable cursor editing [MasRef D.2-19]
10741							;
10742	.f0d6						osbyte04:
10743	.f0d6		18		clc		                clc
10744	.f0d7		69 e9		adc #$e9	                adc #firstMOSVariableOSBYTE+(editKeysMode-mosVariables)-4 ;-4 because OSBYTE 4

10746							                ;if originally OSBYTE 4 (&04) Enable/disable cursor
10747							                ;editing [MasRef D.2-19], it's now OSBYTE 237 (&ED)
10748							                ;Read/write cursor editing status [MasRef D.2-77].
10749							                ;
10750							                ;if originally OSBYTE 12 (&0C) Write keyboard
10751							                ;auto-repeat rate [MasRef D.2-23], it's now OSBYTE 197
10752							                ;(&C5) Read/write keyboard auto-repeat rate [MasRef
10753							                ;D.2-60].
10754							                ;
10755							                ;if originally OSBYTE 11 (&0B) Write keyboard
10756							                ;auto-repeat delay [MasRef D.2-22], it's now OSBYTE
10757							                ;196 (&C4) Read/write keyboard auto-repeat delay
10758							                ;[MasRef D.2-60].

10760	.f0d9						osbyteA6X:
10761	.f0d9		86 f0		stx $f0		                stx originalX

10763							;-------------------------------------------------------------------------
10764							;
10765							; OSBYTE 166 (&A6) Read start address of MOS variables [MasRef D.2-50]
10766							;
10767	.f0db						osbyteA6:
10768	.f0db		a8		tay		                tay             ;
10769	.f0dc		b9 90 01	lda $0190,y	                lda mosVariables-firstMOSVariableOSBYTE,y;
10770	.f0df		aa		tax		                tax             ;save old value
10771	.f0e0		25 f1		and $f1		                and originalY   ;AND old value with Y
10772	.f0e2		45 f0		eor $f0		                eor originalX   ;EOR old value with X
10773	.f0e4		99 90 01	sta $0190,y	                sta mosVariables-firstMOSVariableOSBYTE,y     ;set new variable value
10774	.f0e7		b9 91 01	lda $0191,y	                lda mosVariables-firstMOSVariableOSBYTE+1,y
10775	.f0ea		a8		tay		                tay             ;Y=contents of next location
10776	.f0eb						rtsF0EB:
10777	.f0eb		60		rts		                rts

10779							;-------------------------------------------------------------------------
10780							;
10781							; This table is used to set the serial baud rate.
10782							;
10783							;   - bit 7 is not used (always clear)
10784							;   - bit 6 is not used (always set)
10785							;   - bits 3,4,5 indicate the serial receive baud rate
10786							;   - bits 0,1,2 indicate the serial transmit baud rate
10787							;
10788							;       111 =    75 baud
10789							;       011 =   150 baud
10790							;       101 =   300 baud
10791							;       001 =  1200 baud
10792							;       110 =  2400 baud
10793							;       010 =  4800 baud
10794							;       100 =  9600 baud
10795							;       000 = 19200 baud
10796							;
10797							                .if version!=400
10798	.f0ec						serialBaudRatesTable:
10799	>f0ec		64				                .byte %01100100;$64
10800	>f0ed		7f				                .byte %01111111;$7f
10801	>f0ee		5b				                .byte %01011011;$5b
10802	>f0ef		6d				                .byte %01101101;$6d
10803	>f0f0		49				                .byte %01001001;$49
10804	>f0f1		76				                .byte %01110110;$76
10805	>f0f2		52				                .byte %01010010;$52
10806	>f0f3		64				                .byte %01100100;$64
10807	>f0f4		40				                .byte %01000000;$40
10808							                .endif

10810							;-------------------------------------------------------------------------
10811							;
10812							; OSBYTE 19 (&13) Wait for vertical sync [MasRef D.2-26]
10813							;
10814	.f0f5						osbyte13:
10815	.f0f5		ad 40 02	lda $0240	                lda cfsTimeoutCounter
10816	.f0f8						-
10817	.f0f8		58		cli		                cli
10818	.f0f9		78		sei		                sei
10819	.f0fa		cd 40 02	cmp $0240	                cmp cfsTimeoutCounter
10820	.f0fd		f0 f9		beq $f0f8	                beq -

10822							                ; fall through to OSBYTE $a0 (!!)

10824							;-------------------------------------------------------------------------
10825							;
10826							; OSBYTE 160 (&A0) Read VDU variable value [MasRef D.2-49]
10827							;
10828	.f0ff						osbyteA0:
10829	.f0ff		bc 01 03	ldy $0301,x	                ldy vduv+1,x
10830	.f102		bd 00 03	lda $0300,x	                lda vduv+0,x
10831	.f105		aa		tax		                tax
10832	.f106		60		rts		                rts

10834							;-------------------------------------------------------------------------
10835							;
10836							; Reset key auto repeat settings to the defaults set in CMOS.
10837							;
10838							                .if version==350
10841							                .endif
10842	.f107						resetKeyRepeat:
10843	.f107		20 84 f3	jsr $f384	                jsr withTerminalROM
10844							                .if version<500&&version!=350
10845	.f10a		20 3a 8b	jsr $8b3a	                jsr terminal.getDefaultKeyboardAutoRepeatDelay
10846	.f10d		8c 54 02	sty $0254	                sty keyboardAutoRepeatDelay
10847	.f110		20 3f 8b	jsr $8b3f	                jsr terminal.getDefaultKeyboardAutoRepeatRate
10855							                .endif
10856	.f113		ae 55 02	ldx $0255	                ldx keyboardAutoRepeatRate
10857	.f116		8c 55 02	sty $0255	                sty keyboardAutoRepeatRate
10858	.f119		60		rts		                rts

10860							;-------------------------------------------------------------------------
10861							;
10862							; OSBYTE 18 (&12) Reset soft keys [MasRef D.2-26]
10863							;
10864							; MasRef says X undefined on exit; in fact, X=0, and terminal.scanROMs
10865							; relies on this.
10866							;
10867	.f11a						osbyte12:
10868	.f11a		38		sec		                sec
10869	.f11b		6e 84 02	ror $0284	                ror softKeyConsistencyFlag   ;mark soft keys inconsistent
10870	.f11e		a5 f4		lda $f4		                lda $F4
10871	.f120		48		pha		                pha                          ;push selected paged ROM
10872	.f121		20 7f e5	jsr $e57f	                jsr selectTerminalROMAndANDY

10874							                ; point each soft key at the 0th byte of the strings -
10875							                ; they all then have length 0.
10876	.f124		a2 10		ldx #$10	                ldx #softKeyCount
10877	.f126						-
10878	.f126		a9 22		lda #$22	                lda #<andy.softKeys.strings
10879	.f128		9d 00 80	sta $8000,x	                sta andy.softKeys.stringLSBs,x
10880	.f12b		a9 80		lda #$80	                lda #>andy.softKeys.strings
10881	.f12d		9d 11 80	sta $8011,x	                sta andy.softKeys.stringMSBs,x
10882	.f130		ca		dex		                dex
10883	.f131		10 f3		bpl $f126	                bpl -

10885	.f133		68		pla		                pla                 ;pop previously selected paged ROM
10886	.f134		20 92 e5	jsr $e592	                jsr selectROMA

10888	.f137		9c 68 02	stz $0268	                stz softKeyStringLength
10889	.f13a		9c 84 02	stz $0284	                stz softKeyConsistencyFlag   ;mark soft keys consistent
10890	.f13d		e8		inx		                inx
10891	.f13e		60		rts		                rts

10893							;-------------------------------------------------------------------------
10894							;
10895							; OSWORD 11 (&0B) Read the palette [MasRef D.3-20]
10896							;
10897	.f13f						osword0B:
10898	.f13f		2d 60 03	and $0360	                and vduv.numberOfLogicalColoursMinusOne
10899	.f142		aa		tax		                tax
10900	.f143		bd 6f 03	lda $036f,x	                lda vduv.currentPalette,x
10901	.f146						LF146:
10902	.f146		c8		iny		                iny
10903	.f147						LF147:
10904	.f147		91 f0		sta ($f0),y	                sta (originalX),y
10905	.f149		a9 00		lda #$00	                lda #$00                     ;fill last 3 bytes with 0
10906	.f14b		c0 04		cpy #$04	                cpy #$04
10907	.f14d		d0 f7		bne $f146	                bne LF146
10908	.f14f		60		rts		                rts

10910							;-------------------------------------------------------------------------
10911							;
10912							; OSWORD 9 (&09) Read pixel logical colour [MasRef D.3-19]
10913							;
10914	.f150						osword09:                                    ;f150
10915	.f150		20 ab f3	jsr $f3ab	                jsr withMOSROM               ; sF150= 20 AB F3     +s
10916	.f153		a0 03		ldy #$03	                ldy #$03
10917	.f155						-
10918	.f155		b1 f0		lda ($f0),y	                lda (originalX),y
10919	.f157		99 28 03	sta $0328,y	                sta vduv.workspace._28,y
10920	.f15a		b9 10 03	lda $0310,y	                lda $0310,y
10921	.f15d		48		pha		                pha
10922	.f15e		88		dey		                dey
10923	.f15f		10 f4		bpl $f155	                bpl -
10924	.f161		a9 28		lda #$28	                lda #VDUVariables.workspace._28
10925	.f163		20 b7 dd	jsr $ddb7	                jsr readPixelColour
10926	.f166		aa		tax		                tax
10927	.f167		a0 00		ldy #$00	                ldy #$00
10928	.f169						LF169:
10929	.f169		68		pla		                pla
10930	.f16a		99 10 03	sta $0310,y	                sta $0310,y
10931	.f16d		c8		iny		                iny
10932	.f16e		c0 04		cpy #$04	                cpy #$04
10933	.f170		d0 f7		bne $f169	                bne LF169
10934	.f172		8a		txa		                txa
10935	.f173		80 d2		bra $f147	                bra LF147

10937	.f175						osword0A:                                    ;f175
10938	.f175		20 2c e2	jsr $e22c	                jsr getSoftCharacterDefinitionAddress
10939	.f178		a0 00		ldy #$00	                ldy #$00
10940	.f17a		a5 f4		lda $f4		                lda $F4
10941	.f17c		48		pha		                pha
10942	.f17d		20 7f e5	jsr $e57f	                jsr selectTerminalROMAndANDY
10943	.f180						LF180:
10944	.f180		b1 de		lda ($de),y	                lda ($DE),y
10945	.f182		c8		iny		                iny
10946	.f183		91 f0		sta ($f0),y	                sta ($F0),y
10947	.f185		c0 08		cpy #$08	                cpy #$08
10948	.f187		d0 f7		bne $f180	                bne LF180
10949	.f189		fa		plx		                plx
10950	.f18a		4c 81 e5	jmp $e581	                jmp selectROMX

10952	.f18d						osword0C:                                    ;f18d
10953	.f18d		20 ab f3	jsr $f3ab	                jsr withMOSROM
10954	.f190		08		php		                php
10955	.f191		2d 60 03	and $0360	                and $0360
10956	.f194		aa		tax		                tax
10957	.f195		c8		iny		                iny
10958	.f196		b1 f0		lda ($f0),y	                lda ($F0),y
10959	.f198		4c 39 c6	jmp $c639	                jmp LC639

10961	.f19b						osword0D:                                    ;f19b
10962	.f19b		20 ab f3	jsr $f3ab	                jsr withMOSROM
10963	.f19e		a9 03		lda #$03	                lda #$03
10964	.f1a0		20 a5 f1	jsr $f1a5	                jsr LF1A5
10965	.f1a3		a9 07		lda #$07	                lda #$07
10966	.f1a5						LF1A5:
10967	.f1a5		48		pha		                pha
10968	.f1a6		20 b6 e2	jsr $e2b6	                jsr LE2B6
10969	.f1a9		20 df c4	jsr $c4df	                jsr LC4DF
10970	.f1ac		a2 03		ldx #$03	                ldx #$03
10971	.f1ae		68		pla		                pla
10972	.f1af		a8		tay		                tay
10973	.f1b0						LF1B0:
10974	.f1b0		bd 10 03	lda $0310,x	                lda $0310,x
10975	.f1b3		91 f0		sta ($f0),y	                sta ($F0),y
10976	.f1b5		88		dey		                dey
10977	.f1b6		ca		dex		                dex
10978	.f1b7		10 f7		bpl $f1b0	                bpl LF1B0
10979	.f1b9		60		rts		                rts

10981							; Read address of bottom of screen/top of user memory
10982							; ===================================================
10983	.f1ba						osbyte84:                     ;f1ba
10984	.f1ba		a5 d0		lda $d0		                lda STATE     ; Get VDU status
10985	.f1bc		89 10		bit #$10	                bit #STATE.isShadowMode ; If shadow screen, jump to return &8000
10986	.f1be		d0 18		bne $f1d8	                bne LF1D8
10987	.f1c0						LF1C0:
10988	.f1c0		ad 55 03	lda $0355	                lda $0355                    ; Get current screen MODE

10990							; Return start of screen for non-shadow MODE in X
10991							; -----------------------------------------------
10992	.f1c3						LF1C3:
10993	.f1c3		29 07		and #$07	                and #$07
10994	.f1c5		a8		tay		                tay
10995	.f1c6		be 68 e1	ldx $e168,y	                ldx screenMODEGroupForMODE,y ; Get screen map for supplied MODE
10996	.f1c9		bd 7e e1	lda $e17e,x	                lda startScreenAddressHighByteForScreenMODEGroup,x ; Get address top byte for this screen map
10997	.f1cc						LF1CC:
10998	.f1cc		a2 00		ldx #$00	                ldx #$00                     ; Address=&xx00
10999	.f1ce		a8		tay		                tay
11000	.f1cf		60		rts		                rts

11002							;-------------------------------------------------------------------------
11003							;
11004							; OSBYTE 133 (&85) Read top of user RAM for given mode [MasRef D.2-41]
11005							;
11006	.f1d0						osbyte85:
11007	.f1d0		8a		txa		                txa                          ; If MODE &80+n, return &8000
11008	.f1d1		30 05		bmi $f1d8	                bmi LF1D8
11009	.f1d3		ae 7f 02	ldx $027f	                ldx shadowRAMState ; If *SHADOW<>0, jump to return non-shadow address
11010	.f1d6		d0 eb		bne $f1c3	                bne LF1C3
11011	.f1d8						LF1D8:
11012	.f1d8		a9 80		lda #$80	                lda #$80                     ; Return &8000
11013	.f1da		80 f0		bra $f1cc	                bra LF1CC

11015							;-------------------------------------------------------------------------
11016							;
11017							; OSBYTE 135 (&87) Read screen mode and character at text cursor
11018							; position [MasRef D.2-42]
11019							;
11020	.f1dc						osbyte87: ;F1DC:
11021	.f1dc		20 ab f3	jsr $f3ab	                jsr withMOSROM
11022	.f1df		4c f8 dd	jmp $ddf8	                jmp readCharacterAtTextCursor

11024							;-------------------------------------------------------------------------
11025							;
11026							; OSBYTE 139 (&8B) Write Filing System options [MasRef D.2-43]
11027							;
11028	.f1e2						osbyte8B:
11029	.f1e2		0a		asl a		                asl a

11031							;-------------------------------------------------------------------------
11032							;
11033							; OSBYTE 127 (&7F) Check for end of file on an opened file [MasRef D.2-37]
11034							;
11035	.f1e3						osbyte7F:
11036	.f1e3		29 01		and #$01	                and #$01

11038							;-------------------------------------------------------------------------
11039							;
11040							; Call OSFSC. There's no entry point for this.
11041							;
11042	.f1e5						callFSCV:
11043	.f1e5		6c 1e 02	jmp ($021e)	                jmp (FSCV)

11045							;-------------------------------------------------------------------------
11046							;
11047							; OSWORD 15 (&0F) Write CMOS clock [MasRef D.3-24]
11048							;
11049							                .if version!=350
11050	.f1e8						osword0F:
11051	.f1e8		20 84 f3	jsr $f384	                jsr withTerminalROM       ; Page in ROM 15
11052	.f1eb		4c 56 96	jmp $9656	                jmp terminal.osword0F
11053							                .endif

11055							;-------------------------------------------------------------------------

11057							; Set TAPE/ROM extended vectors
11058							; =============================
11059	.f1ee						LF1EE:
11060	.f1ee		a2 15		ldx #$15	                ldx #$15
11061	.f1f0						LF1F0:
11062	.f1f0		bd f9 f1	lda $f1f9,x	                lda LF1FA-1,x
11063	.f1f3		9d b9 0d	sta $0db9,x	                sta ExtendedVectorAddress(FILEV)-1,x
11064	.f1f6		ca		dex		                dex
11065	.f1f7		d0 f7		bne $f1f0	                bne LF1F0
11066	.f1f9						LF1F9:
11067	.f1f9		60		rts		                rts

11069							; TAPE/ROM extended vector values
11070							; -------------------------------
11071	.f1fa						LF1FA:
11072	>f1fa		8c a0				                .word terminal.osfileTapeOrROM ; FILEV
11073	>f1fc		0f				                .byte terminalROM
11074	>f1fd		29 9f				                .word terminal.osargsTapeOrROM ; ARGSV
11075	>f1ff		0f				                .byte terminalROM
11076	>f200		ea a2				                .word terminal.bputTapeOrROM ; BPUTV
11077	>f202		0f				                .byte terminalROM
11078							                .if version==400
11080							                .else
11081	>f203		4b a3				                .word terminal.bgetTapeOrROM ; BGETV
11082							                .endif
11083	>f205		0f				                .byte terminalROM
11084	>f206		6d a3				                .word terminal.osgbpbTapeOrROM ; GBPBV
11085	>f208		0f				                .byte terminalROM
11086	>f209		f9 a1				                .word terminal.osfindTapeOrROM ; FINDV
11087	>f20b		0f				                .byte terminalROM
11088	>f20c		8c 9f				                .word terminal.fscTapeOrROM  ; FSCV
11089	>f20e		0f				                .byte terminalROM

11091							;-------------------------------------------------------------------------
11092							;
11093							; OSBYTE 109 (&6D) Make temporary Filing System permanent
11094							;
11095							; MasRef D.2-30
11096							;
11097	.f20f						osbyte6D:;f20f
11098	.f20f		ae 01 df	ldx $df01	                ldx hazel.activeFS; Copy active FS to current FS
11099	.f212		8e 00 df	stx $df00	                stx hazel.currentFS
11100	.f215		ad bc 0d	lda $0dbc	                lda ExtendedVectorAddress(FILEV)+2 ; Copy XFILEV ROM to current FS ROM number
11101	.f218		8d 03 df	sta $df03	                sta hazel.currentFSROM
11102	.f21b						rtsF180:
11103	.f21b		60		rts		                rts

11105							;-------------------------------------------------------------------------
11106							;
11107							; OSBYTE 20 (&14) Restore default font definitions
11108							;
11109							; MasRef D.2-24
11110							;
11111							                .if version!=350
11112	.f21c						osbyte14:                       ;f21c
11113	.f21c		20 84 f3	jsr $f384	                jsr withTerminalROM
11114	.f21f		4c a4 92	jmp $92a4	                jmp terminal.restoreFont32To126
11115							                .endif

11117							;-------------------------------------------------------------------------
11118							;
11119							; OSBYTE 25 (&19) Restore a group of font definitions
11120							;
11121							; MasRef D.2-28
11122							;
11123	.f222						osbyte19:                       ;f222
11124							                .if version>=511||version==350
11133							                .endif
11134	.f222		20 84 f3	jsr $f384	                jsr withTerminalROM
11135	.f225		4c a8 92	jmp $92a8	                jmp terminal.osbyte19

11137							;-------------------------------------------------------------------------

11139							; OSBYTE &16 - Increment ROM polling semaphore
11140							; ========================================
11141	.f228						osbyte16:                       ;f228
11142	.f228		ee 43 02	inc $0243	                inc romPollingSemaphore
11143	.f22b						LF2EB:
11144	.f22b		60		rts		                rts

11146							;-------------------------------------------------------------------------

11148							; OSBYTE &17 - Decrement ROM polling semaphore
11149	.f22c						osbyte17:                       ;f22c
11150							; ========================================
11151	.f22c		ce 43 02	dec $0243	                dec romPollingSemaphore
11152	.f22f		60		rts		                rts

11154							;-------------------------------------------------------------------------

11156							                .if version==350
11164							                .endif

11166							;-------------------------------------------------------------------------

11168							; OSBYTE &76 - Set LEDs to keyboard state
11169							; =======================================
11170	.f230						osbyte76:
11171	.f230		08		php		                php                          ; Disable IRQs
11172	.f231		78		sei		                sei
11173	.f232		a9 40		lda #$40	                lda #$40                     ; Turn on LEDs
11174	.f234		20 41 f2	jsr $f241	                jsr LF241
11175	.f237		30 05		bmi $f23e	                bmi LF23E                    ; Exit if Escape pending
11176	.f239		18		clc		                clc                          ; Call KEYV to read SHIFT and CTRL
11177	.f23a		b8		clv		                clv
11178	.f23b		20 02 f9	jsr $f902	                jsr callKEYV
11179							; Returns A.b7=CTRL, A.b6=SHIFT, MI=CTRL, VS=SHIFT
11180	.f23e						LF23E:
11181	.f23e		28		plp		                plp                          ; Restore IRQs
11182	.f23f		2a		rol a		                rol a                        ; Set Carry from A bit 7 and return
11183	.f240		60		rts		                rts
11184							; Returns A.b7=SHIFT, CS=CTRL

11186							; Set keyboard LEDs
11187							; -----------------
11188	.f241						LF241:
11189	.f241		90 09		bcc $f24c	                bcc LF24C                    ; Skip if not called from OSBYTE
11190	.f243		a0 07		ldy #$07	                ldy #$07                     ; Turn ShiftLock LED on
11191	.f245		8c 40 fe	sty $fe40	                sty systemVIA.orb
11192	.f248		88		dey		                dey                          ; Turn CapsLock LED on
11193	.f249		8c 40 fe	sty $fe40	                sty systemVIA.orb
11194	.f24c						LF24C:
11195	.f24c		24 ff		bit $ff		                bit $FF                      ; Test Escape and return
11196	.f24e		60		rts		                rts

11198							;-------------------------------------------------------------------------

11200	.f24f						osbyte9A:
11201	.f24f		8a		txa		                txa
11202	.f250						setVCONTROL:
11203	.f250		08		php		                php
11204	.f251		78		sei		                sei
11205	.f252		8d 48 02	sta $0248	                sta vcontrolRegister
11206	.f255		8d 20 fe	sta $fe20	                sta VCONTROL
11207	.f258		ad 53 02	lda $0253	                lda secondFlashColourDuration
11208	.f25b		8d 51 02	sta $0251	                sta flashCounter
11209	.f25e		28		plp		                plp
11210	.f25f		60		rts		                rts

11212							;-------------------------------------------------------------------------
11213							;
11214							; OSBYTE 155 (&9B) Write to video ULA palette register and copy
11215							;
11216	.f260						osbyte9B:
11217	.f260		8a		txa		                txa
11218	.f261						writeVPALETTE:
11219	.f261		49 07		eor #$07	                eor #$07
11220	.f263		08		php		                php
11221	.f264		78		sei		                sei
11222	.f265		8d 49 02	sta $0249	                sta vpaletteRegister
11223	.f268		8d 21 fe	sta $fe21	                sta VPALETTE
11224	.f26b		28		plp		                plp
11225	.f26c		60		rts		                rts

11227							;-------------------------------------------------------------------------

11229	.f26d						gsinitForFilenameParsing:
11230	.f26d		18		clc		                clc


11233							;-------------------------------------------------------------------------
11234							;
11235							; GSINIT
11236							;
11237							; MasRef D.10-1
11238							;
11239	.f26e						gsinitEntryPoint:
11240	.f26e		66 e4		ror $e4		                ror stringInputOptions    ;put C into bit 7
11241	.f270		20 ff f2	jsr $f2ff	                jsr skipSpacesAndCheckForCRInStringInput
11242	.f273		c8		iny		                iny
11243	.f274		c9 22		cmp #$22	                cmp #'"'
11244	.f276		f0 02		beq $f27a	                beq +                       ; C=1 if double quotes
11245	.f278		88		dey		                dey
11246	.f279		18		clc		                clc                         ; clear double quotes flag
11247	.f27a						+
11248	.f27a		66 e4		ror $e4		                ror stringInputOptions ; set doubleQuotes; move bit 7 into spaceNotATerminator
11249	.f27c		c9 0d		cmp #$0d	                cmp #$0D                     ; set Z if initial CR
11250	.f27e		60		rts		                rts

11252							;-------------------------------------------------------------------------
11253							;
11254							; GSREAD
11255							;
11256							; MasRef D.10-2
11257							; MasRef C.5-8 has the | syntax
11258							;
11259	.f27f						gsreadEntryPoint:
11260	.f27f		a9 01		lda #$01	                lda #stringInputOptions.goodString
11261	.f281		04 e4		tsb $e4		                tsb stringInputOptions
11262	.f283		20 9c f2	jsr $f29c	                jsr LF29C
11263	.f286		08		php		                php                          ; save flags
11264	.f287		46 e4		lsr $e4		                lsr stringInputOptions       ; move goodString into C
11265	.f289		90 04		bcc $f28f	                bcc badStringError           ; branch taken if bad string
11266	.f28b		26 e4		rol $e4		                rol stringInputOptions       ; reinstate goodString
11267	.f28d		28		plp		                plp                          ; restore flags
11268	.f28e		60		rts		                rts                          ;

11270	.f28f						badStringError:
11271	.f28f		00		brk #		                brk                          ;
11272	>f290		fd 42 61 64 20 73 74 72		                .text $fd,"Bad string",0
	>f298		69 6e 67 00
11273	.f29c						LF29C:
11274	.f29c		18		clc		                clc                          ; last char not !
11275	.f29d						LF29D:
11276							                ; C=1 at this point if |! was the last sequence seen.
11277	.f29d		64 e5		stz $e5		                stz stringInputPlingFlag
11278	.f29f		66 e5		ror $e5		                ror stringInputPlingFlag     ; set ! flag as required
11279	.f2a1		b1 f2		lda ($f2),y	                lda (stringInputBufferAddress),y
11280	.f2a3		c9 0d		cmp #$0d	                cmp #13                      ;EOL?
11281	.f2a5		d0 09		bne $f2b0	                bne notRETURN                ;taken if not EOL
11282	.f2a7		24 e4		bit $e4		                bit stringInputOptions
11283	.f2a9		10 20		bpl $f2cb	                bpl finishedString           ;taken if !doubleQuotes
11284	.f2ab						badString:
11285	.f2ab		a9 01		lda #$01	                lda #stringInputOptions.goodString
11286	.f2ad		14 e4		trb $e4		                trb stringInputOptions
11287	.f2af		60		rts		                rts

11289	.f2b0						notRETURN:
11290	.f2b0		c9 20		cmp #$20	                cmp #' '
11291	.f2b2		90 f7		bcc $f2ab	                bcc badString ;taken if unprintable control char
11292	.f2b4		d0 06		bne $f2bc	                bne notSPACE
11293	.f2b6		24 e4		bit $e4		                bit stringInputOptions ;N=doubleQuotes, V=spaceNotATerminator
11294	.f2b8		30 3e		bmi $f2f8	                bmi finishUpReadClearV ;taken if quoted
11295	.f2ba		50 0f		bvc $f2cb	                bvc finishedString ;taken if space is a terminator
11296	.f2bc						notSPACE:
11297	.f2bc		c9 22		cmp #$22	                cmp #'"'
11298	.f2be		d0 10		bne $f2d0	                bne notDOUBLEQUOTE         ;taken if not quotes
11299	.f2c0		24 e4		bit $e4		                bit stringInputOptions ;N=doubleQuotes, V=spaceNotATerminator
11300	.f2c2		10 34		bpl $f2f8	                bpl finishUpReadClearV ;taken if not double quotes
11301	.f2c4		c8		iny		                iny
11302	.f2c5		b1 f2		lda ($f2),y	                lda (stringInputBufferAddress),y
11303	.f2c7		c9 22		cmp #$22	                cmp #'"'
11304	.f2c9		f0 2d		beq $f2f8	                beq finishUpReadClearV       ;taken if quotes
11305	.f2cb						finishedString:
11306	.f2cb		20 ff f2	jsr $f2ff	                jsr skipSpacesAndCheckForCRInStringInput
11307	.f2ce		38		sec		                sec
11308	.f2cf		60		rts		                rts

11310	.f2d0						notDOUBLEQUOTE:
11311	.f2d0		c9 7c		cmp #$7c	                cmp #'|'
11312	.f2d2		d0 24		bne $f2f8	                bne finishUpReadClearV       ;taken if not |
11313	.f2d4		c8		iny		                iny                          ;skip |
11314	.f2d5		b1 f2		lda ($f2),y	                lda (stringInputBufferAddress),y
11315	.f2d7		c9 7c		cmp #$7c	                cmp #'|'
11316	.f2d9		f0 1d		beq $f2f8	                beq finishUpReadClearV ;branch taken if "||" - literal |
11317	.f2db		c9 22		cmp #$22	                cmp #'"'
11318	.f2dd		f0 19		beq $f2f8	                beq finishUpReadClearV ;branch taken if "|\"" - literal "
11319	.f2df		c9 21		cmp #$21	                cmp #'!'
11320	.f2e1		d0 03		bne $f2e6	                bne LF2E6                    ;taken if not "|!"

11322							                ; Handle |! - ASCII 128-255
11323	.f2e3		c8		iny		                iny                          ;skip !
11324	.f2e4		80 b7		bra $f29d	                bra LF29D

11326	.f2e6						LF2E6:
11327	.f2e6		c9 20		cmp #$20	                cmp #' '
11328	.f2e8		90 c1		bcc $f2ab	                bcc badString ;taken if | followed by a non-printable char
11329	.f2ea		c9 3f		cmp #$3f	                cmp #'?'
11330	.f2ec		f0 08		beq $f2f6	                beq ascii127                 ;taken if "|?" - CHR$127
11331	.f2ee		20 36 f3	jsr $f336	                jsr implementCTRLCodes
11332	.f2f1		2c 4e e3	bit $e34e	                bit valueFF
11333	.f2f4		80 03		bra $f2f9	                bra LF2F9

11335	.f2f6						ascii127:
11336	.f2f6		a9 7f		lda #$7f	                lda #$7F
11337	.f2f8						finishUpReadClearV:
11338	.f2f8		b8		clv		                clv
11339	.f2f9						LF2F9:
11340	.f2f9		c8		iny		                iny
11341	.f2fa		05 e5		ora $e5		                ora stringInputPlingFlag ;if it was a |! char, set bit 7
11342	.f2fc		18		clc		                clc
11343	.f2fd		60		rts		                rts

11345							;-------------------------------------------------------------------------

11347	.f2fe						incAndSkipSpaces:
11348	.f2fe		c8		iny		                iny
11349	.f2ff						skipSpacesAndCheckForCRInStringInput:
11350	.f2ff		b1 f2		lda ($f2),y	                lda (stringInputBufferAddress),y
11351	.f301		c9 20		cmp #$20	                cmp #' '
11352	.f303		f0 f9		beq $f2fe	                beq incAndSkipSpaces
11353	.f305						checkForCR:
11354	.f305		c9 0d		cmp #$0d	                cmp #13
11355	.f307		60		rts		                rts

11357							;-------------------------------------------------------------------------

11359	.f308						LF308:
11360	.f308		90 f5		bcc $f2ff	                bcc skipSpacesAndCheckForCRInStringInput
11361	.f30a						LF30A:
11362	.f30a		20 ff f2	jsr $f2ff	                jsr skipSpacesAndCheckForCRInStringInput
11363	.f30d		c9 2c		cmp #$2c	                cmp #','
11364	.f30f		d0 f4		bne $f305	                bne checkForCR
11365	.f311		c8		iny		                iny
11366	.f312		60		rts		                rts

11368							;-------------------------------------------------------------------------

11370							                .if version==510&&olivetti
11459							                .endif

11461							;-------------------------------------------------------------------------
11462							;
11463							; Modify character in A as if the SHIFT key is being pressed.
11464							;

11466	.f313						implementShift:
11467							                .if version<500&&version!=350

11469	.f313		c9 30		cmp #$30	                cmp #'0'
11470	.f315		f0 1e		beq $f335	                beq gotShiftedChar           ;taken if SHIFT+0 - no change
11471	.f317		c9 40		cmp #$40	                cmp #$40
11472	.f319		f0 1a		beq $f335	                beq gotShiftedChar           ;taken if SHIFT+@ - no change
11473	.f31b		90 12		bcc $f32f	                bcc shiftMaybeNumber ;taken if probably a "number" (ASCII 33-63)
11474	.f31d		c9 7f		cmp #$7f	                cmp #$7F
11475	.f31f		f0 14		beq $f335	                beq gotShiftedChar  ;taken if SHIFT+DELETE - no change
11476	.f321		b0 10		bcs $f333	                bcs shiftNumber     ;taken if SHIFT+CHR$>=127 - ???
11477	.f323						flipBitsForShift:
11478	.f323		49 30		eor #$30	                eor #$30                     ;
11479	.f325		c9 6f		cmp #$6f	                cmp #$6F                     ;
11480	.f327		f0 04		beq $f32d	                beq +                        ;taken if originally _
11481	.f329		c9 50		cmp #$50	                cmp #$50                     ;
11482	.f32b		d0 02		bne $f32f	                bne shiftMaybeNumber         ;taken if not originally GBP
11483	.f32d						+
11484	.f32d		49 1f		eor #$1f	                eor #$1F                     ;extra step for GBP/_ toggle
11485	.f32f						shiftMaybeNumber:
11486	.f32f		c9 21		cmp #$21	                cmp #' '+1
11487	.f331		90 02		bcc $f335	                bcc gotShiftedChar         ;taken if non-printing char
11488	.f333						shiftNumber:
11489	.f333		49 10		eor #$10	                eor #$10                     ;
11490	.f335						gotShiftedChar:
11491	.f335		60		rts		                rts

11537							                .endif

11539							;-------------------------------------------------------------------------
11540							;
11541							; See MasRef C.5-8
11542							;
11543							;
11544	.f336						implementCTRLCodes:
11545							                .if version<500&&version!=350

11547	.f336		c9 7f		cmp #$7f	                cmp #$7F
11548	.f338		f0 0e		beq $f348	                beq gotCtrlChar
11549	.f33a		b0 e7		bcs $f323	                bcs flipBitsForShift         ;taken if CHR$>=128
11550	.f33c		c9 60		cmp #$60	                cmp #$60
11551	.f33e		d0 02		bne $f342	                bne +                        ;taken if not GBP
11552	.f340		a9 5f		lda #$5f	                lda #'_'                     ;GBP and _ are equivalent
11553	.f342						+
11554	.f342		c9 40		cmp #$40	                cmp #$40                     ;
11555	.f344		90 02		bcc $f348	                bcc gotCtrlChar              ;taken if CHR$<64
11556	.f346		29 1f		and #$1f	                and #$1F                     ;|@=0, |A=1, |a=1, etc.
11557	.f348						gotCtrlChar:
11558	.f348		60		rts		                rts

11590							                .endif

11592							;-------------------------------------------------------------------------

11594	.f349						osbyte247EntryPoint:
11595							                .if version==350
11598							                .endif
11599	.f349		ad 87 02	lda $0287	                lda breakVectorByte0
11600	.f34c		49 4c		eor #$4c	                eor #$4C                     ; JMP abs
11601	.f34e		d0 13		bne $f363	                bne rtsF363
11602							                .if version==350
11605							                .elsif version<500
11606	.f350		4c 87 02	jmp $0287	                jmp breakVectorByte0
11614							                .endif

11616							;-------------------------------------------------------------------------
11617							;
11618							; OSBYTE 144 (&90)
11619							; Set vertical screen shift and interlace
11620							;
11621							; MasRef D.2-44
11622							;
11623	.f353						osbyte90:
11624	.f353		ad 90 02	lda $0290	                lda tvOffset
11625	.f356		8e 90 02	stx $0290	                stx tvOffset
11626	.f359		aa		tax		                tax
11627	.f35a		98		tya		                tya
11628	.f35b		29 01		and #$01	                and #$01
11629	.f35d		ac 91 02	ldy $0291	                ldy tvInterlace
11630	.f360		8d 91 02	sta $0291	                sta tvInterlace
11631	.f363						rtsF363:
11632	.f363		60		rts		                rts

11634							;-------------------------------------------------------------------------
11635							;
11636							; OSBYTE 149 (&95) â<80><93> write to JIM
11637							;
11638							; MasRef D.2-45
11639							;
11640	.f364						osbyte95:
11641	.f364		98		tya		                tya
11642	.f365		9d 00 fd	sta $fd00,x	                sta $FD00,x
11643	.f368		60		rts		                rts

11645							;-------------------------------------------------------------------------
11646							;
11647							; OSBYTE 151 (&97) â<80><93> write to SHEILA
11648							;
11649							; MasRef D.2-45
11650							;
11651	.f369						osbyte97:
11652	.f369		98		tya		                tya
11653	.f36a		9d 00 fe	sta $fe00,x	                sta $FE00,x
11654	.f36d		60		rts		                rts

11656							;-------------------------------------------------------------------------
11657							;
11658							; OSBYTE 147 (&93) â<80><93> write to FRED
11659							;
11660							; MasRef D.2-45
11661							;
11662	.f36e						osbyte93:
11663	.f36e		98		tya		                tya
11664	.f36f		9d 00 fc	sta $fc00,x	                sta $FC00,x
11665	.f372		60		rts		                rts

11667							;-------------------------------------------------------------------------
11668							;
11669							; *SHUT [MasRef G.5-10]
11670							;
11671	.f373						starSHUT:
11672	.f373		a2 26		ldx #$26	                ldx #romServiceCallCloseAllOpenFiles
11673	.f375		4c 72 ee	jmp $ee72	                jmp makeROMServiceCall

11675							;-------------------------------------------------------------------------
11676							;
11677							; Return thunk used by withTerminalROM.
11678							;
11679							; On entry here, the old value of $f4 is at the top of the stack.
11680							;
11681	.f378						withTerminalROMReturnThunk:
11682	.f378		08		php		                php                          ; S=[p; old ROMSEL]
11683	.f379		48		pha		                pha                          ; S=[a; p; old ROMSEL]
11684	.f37a		da		phx		                phx                          ; S=[x; a; p; old ROMSEL]
11685	.f37b		ba		tsx		                tsx
11686	.f37c		bd 04 01	lda $0104,x	                lda $0104,x                  ; get old ROMSEL
11687	.f37f		20 92 e5	jsr $e592	                jsr selectROMA               ; re-select old ROM
11688	.f382		80 5d		bra $f3e1	                bra returnThunkSuffix

11690							;-------------------------------------------------------------------------
11691							;
11692							; Select the Terminal ROM. Rearrange the stack so that the original
11693							; ROM is re-selected when withTerminalROM's caller itself returns.
11694							;
11695	.f384						withTerminalROM:
11696							                .if version==350
11704							                .else
11705	.f384		48		pha		                pha                          ; S=[A]
11706	.f385		48		pha		                pha                          ; S=[A; A]
11707	.f386		48		pha		                pha                          ; S=[A; A; A]
11708	.f387		08		php		                php                          ; S=[P; A; A; A]
11709	.f388		48		pha		                pha                          ; S=[A; P; A; A; A]
11710	.f389		da		phx		                phx                          ; S=[X; A; P; A; A; A]
11711	.f38a		ba		tsx		                tsx                          ; S=[X; A; P; A; A; A; RL; RH]
11712	.f38b		bd 07 01	lda $0107,x	                lda $0107,x                  ; get RL
11713	.f38e		9d 04 01	sta $0104,x	                sta $0104,x                  ; overwrite placeholder A
11714	.f391		bd 08 01	lda $0108,x	                lda $0108,x                  ; get RH
11715	.f394		9d 05 01	sta $0105,x	                sta $0105,x                  ; overwrite placeholder A
11716	.f397		a5 f4		lda $f4		                lda $F4                      ; get ROMSEL
11717	.f399		9d 08 01	sta $0108,x	                sta $0108,x                  ; overwrite RH

11719							                ; put return thunk in the right spot
11720	.f39c		a9 f3		lda #$f3	                lda #>withTerminalROMReturnThunk-1
11721	.f39e		9d 07 01	sta $0107,x	                sta $0107,x
11722	.f3a1		a9 77		lda #$77	                lda #<withTerminalROMReturnThunk-1
11723	.f3a3		9d 06 01	sta $0106,x	                sta $0106,x
11724							                .endif
11725	.f3a6		20 90 e5	jsr $e590	                jsr selectTerminalROM
11726	.f3a9		80 28		bra $f3d3	                bra plx_pla_plp_rts

11728							;-------------------------------------------------------------------------
11729							;
11730							; Select the MOS ROM (i.e., no HAZEL). Rearrange the stack so that the
11731							; original HAZEL state is restored when withMOSROM's caller itself
11732							; returns.
11733							;
11734	.f3ab						withMOSROM:
11735							                .if version==350
11744							                .else
11745	.f3ab		48		pha		                pha                          ; S=[A]
11746	.f3ac		48		pha		                pha                          ; S=[A; A]
11747	.f3ad		48		pha		                pha                          ; S=[A; A; A]
11748	.f3ae		08		php		                php                          ; S=[P; A; A; A]
11749	.f3af		48		pha		                pha                          ; S=[A; P; A; A; A]
11750	.f3b0		da		phx		                phx                          ; S=[X; A; P; A; A; A]
11751	.f3b1		ba		tsx		                tsx                          ; S=[X; A; P; A; A; A; RL; RH]
11752	.f3b2		bd 08 01	lda $0108,x	                lda $0108,x                  ; get RH
11753	.f3b5		9d 05 01	sta $0105,x	                sta $0105,x                  ; overwrite placeholder A
11754	.f3b8		bd 07 01	lda $0107,x	                lda $0107,x                  ; get RL
11755	.f3bb		9d 04 01	sta $0104,x	                sta $0104,x                  ; overwrite placeholder A

11757							                ; put return thunk in the right spot
11758	.f3be		a9 f3		lda #$f3	                lda #>withMOSROMReturnThunk-1
11759	.f3c0		9d 07 01	sta $0107,x	                sta $0107,x
11760	.f3c3		a9 d6		lda #$d6	                lda #<withMOSROMReturnThunk-1
11761	.f3c5		9d 06 01	sta $0106,x	                sta $0106,x

11763	.f3c8		ad 34 fe	lda $fe34	                lda ACCCON                   ; get ACCCON
11764	.f3cb		9d 08 01	sta $0108,x	                sta $0108,x                  ; overwrite RH
11765	.f3ce		a9 08		lda #$08	                lda #ACCCON.Y
11766	.f3d0		1c 34 fe	trb $fe34	                trb ACCCON
11767							                ; HAZEL off
11768							                .endif
11769	.f3d3						plx_pla_plp_rts:
11770							                ; S=[X; A; P; RL; RH; thunkRL; thunkRH; old ACCCON/ROMSEL]
11771	.f3d3		fa		plx		                plx
11772	.f3d4		68		pla		                pla
11773	.f3d5		28		plp		                plp
11774	.f3d6		60		rts		                rts

11776	.f3d7						withMOSROMReturnThunk:
11777	.f3d7		08		php		                php                          ; S=[P]
11778	.f3d8		48		pha		                pha                          ; S=[A; P]
11779	.f3d9		da		phx		                phx                          ; S=[X; A; P]
11780	.f3da		ba		tsx		                tsx                          ; S=[X; A; P; old ACCCON]
11781	.f3db		bd 04 01	lda $0104,x	                lda $0104,x                  ; get old ACCCON
11782	.f3de		20 b0 ed	jsr $edb0	                jsr selectMOSOrHAZEL         ; re-select old HAZEL state
11783	.f3e1						returnThunkSuffix:
11784							                ; double up P, as that's the easiest way of ending up
11785							                ; discarding the TOS without affecting the flags.
11786	.f3e1		bd 03 01	lda $0103,x	                lda $0103,x
11787	.f3e4		9d 04 01	sta $0104,x	                sta $0104,x
11788	.f3e7		fa		plx		                plx
11789	.f3e8		68		pla		                pla
11790	.f3e9		28		plp		                plp
11791	.f3ea		28		plp		                plp
11792	.f3eb		60		rts		                rts

11794							;-------------------------------------------------------------------------

11796							                .if version==350
11819							                .endif

11821							;-------------------------------------------------------------------------

11823							                .if version==350
11840							                .endif

11842							;-------------------------------------------------------------------------

11844	.f3ec						vduChrEntryPoint:
11845	.f3ec		20 ab f3	jsr $f3ab	                jsr withMOSROM
11846	.f3ef		a6 f4		ldx $f4		                ldx $F4
11847	.f3f1		da		phx		                phx
11848	.f3f2		20 7f e5	jsr $e57f	                jsr selectTerminalROMAndANDY
11849	.f3f5		20 27 c0	jsr $c027	                jsr outputToVDU
11850	.f3f8		fa		plx		                plx
11851	.f3f9		4c 81 e5	jmp $e581	                jmp selectROMX

11853							;-------------------------------------------------------------------------
11854							;
11855							; OSRDSC [MasRef D.6-1]
11856							;
11857	.f3fc						osrdscEntryPoint:
11858	.f3fc		20 ab f3	jsr $f3ab	                jsr withMOSROM
11859	.f3ff		4c 18 c0	jmp $c018	                jmp LC018

11861							;-------------------------------------------------------------------------
11862							;
11863							; OSWRSC [MasRef D.8-1]
11864							;
11865	.f402						oswrscEntryPoint:
11866	.f402		20 ab f3	jsr $f3ab	                jsr withMOSROM
11867	.f405		4c 5f db	jmp $db5f	                jmp oswrscCode

11869							;-------------------------------------------------------------------------

11871	.f408						starRunBOOT:
11872	>f408		2f 21 42 4f 4f 54 0d		                .text "/!BOOT",13

11874							;-------------------------------------------------------------------------

11876							                .if version<500&&version!=350
11877							                .include "sound_stuff.s65"

:16	;******  Processing file: src/sound_stuff.s65

1							; Table to convert channel number to the bits required by the chip
2	.f40f						soundParameterTable:
3	>f40f		e0 c0 a0 80			                .byte $e0,$c0,$a0,$80

5							;-------------------------------------------------------------------------

7	.f413						LF413:
8	.f413		4c 20 f5	jmp $f520	                jmp LF520

10							;-------------------------------------------------------------------------

12	.f416						LF416:
13	.f416		a2 00		ldx #$00	                ldx #$00
14	.f418		ad 38 08	lda $0838	                lda $0838
15	.f41b		d0 04		bne $f421	                bne LF421
16	.f41d		e8		inx		                inx
17	.f41e		ce 38 08	dec $0838	                dec $0838
18	.f421						LF421:
19	.f421		8e 3b 08	stx $083b	                stx $083B
20	.f424		a2 08		ldx #$08	                ldx #$08
21	.f426						LF426:
22	.f426		ca		dex		                dex
23	.f427		bd 00 08	lda $0800,x	                lda $0800,x
24	.f42a		f0 e7		beq $f413	                beq LF413
25	.f42c		bd ce 02	lda $02ce,x	                lda bufferEmptyFlags,x
26	.f42f		30 05		bmi $f436	                bmi LF436
27	.f431		bd 18 08	lda $0818,x	                lda $0818,x
28	.f434		d0 08		bne $f43e	                bne LF43E
29	.f436						LF436:
30	.f436		20 28 f5	jsr $f528	                jsr LF528
31	.f439		bd 18 08	lda $0818,x	                lda $0818,x
32	.f43c		f0 12		beq $f450	                beq LF450
33	.f43e						LF43E:
34	.f43e		1a		inc a		                inc a
35	.f43f		f0 12		beq $f453	                beq LF453
36	.f441		de 1c 08	dec $081c,x	                dec $081C,x
37	.f444		d0 0d		bne $f453	                bne LF453
38	.f446		a9 05		lda #$05	                lda #$05
39	.f448		9d 1c 08	sta $081c,x	                sta $081C,x
40	.f44b		de 18 08	dec $0818,x	                dec $0818,x
41	.f44e		d0 03		bne $f453	                bne LF453
42	.f450						LF450:
43	.f450		20 28 f5	jsr $f528	                jsr LF528
44	.f453						LF453:
45	.f453		bd 24 08	lda $0824,x	                lda $0824,x
46	.f456		f0 05		beq $f45d	                beq LF45D
47	.f458		de 24 08	dec $0824,x	                dec $0824,x
48	.f45b		d0 b6		bne $f413	                bne LF413
49	.f45d						LF45D:
50	.f45d		bc 20 08	ldy $0820,x	                ldy $0820,x
51	.f460		c0 ff		cpy #$ff	                cpy #$FF
52	.f462		f0 af		beq $f413	                beq LF413
53	.f464		b9 c0 08	lda $08c0,y	                lda $08C0,y
54	.f467		29 7f		and #$7f	                and #$7F
55	.f469		9d 24 08	sta $0824,x	                sta $0824,x
56	.f46c		bd 08 08	lda $0808,x	                lda $0808,x
57	.f46f		c9 04		cmp #$04	                cmp #$04
58	.f471		f0 5d		beq $f4d0	                beq LF4D0
59	.f473		18		clc		                clc
60	.f474		7d 20 08	adc $0820,x	                adc $0820,x
61	.f477		a8		tay		                tay
62	.f478		b9 cb 08	lda $08cb,y	                lda $08CB,y
63	.f47b		38		sec		                sec
64	.f47c		e9 3f		sbc #$3f	                sbc #$3F
65	.f47e		8d 3a 08	sta $083a	                sta $083A
66	.f481		b9 c7 08	lda $08c7,y	                lda $08C7,y
67	.f484		8d 39 08	sta $0839	                sta $0839
68	.f487		bd 04 08	lda $0804,x	                lda $0804,x
69	.f48a						LF48A:
70	.f48a		48		pha		                pha
71	.f48b		18		clc		                clc
72	.f48c		6d 39 08	adc $0839	                adc $0839
73	.f48f		50 07		bvc $f498	                bvc LF498
74	.f491		2a		rol a		                rol a
75	.f492		a9 3f		lda #$3f	                lda #$3F
76	.f494		b0 02		bcs $f498	                bcs LF498
77	.f496		49 ff		eor #$ff	                eor #$FF
78	.f498						LF498:
79	.f498		9d 04 08	sta $0804,x	                sta $0804,x
80	.f49b		2a		rol a		                rol a
81	.f49c		5d 04 08	eor $0804,x	                eor $0804,x
82	.f49f		10 09		bpl $f4aa	                bpl LF4AA
83	.f4a1		a9 3f		lda #$3f	                lda #$3F
84	.f4a3		90 02		bcc $f4a7	                bcc LF4A7
85	.f4a5		49 ff		eor #$ff	                eor #$FF
86	.f4a7						LF4A7:
87	.f4a7		9d 04 08	sta $0804,x	                sta $0804,x
88	.f4aa						LF4AA:
89	.f4aa		ce 39 08	dec $0839	                dec $0839
90	.f4ad		bd 04 08	lda $0804,x	                lda $0804,x
91	.f4b0		38		sec		                sec
92	.f4b1		ed 3a 08	sbc $083a	                sbc $083A
93	.f4b4		4d 39 08	eor $0839	                eor $0839
94	.f4b7		30 09		bmi $f4c2	                bmi LF4C2
95	.f4b9		ad 3a 08	lda $083a	                lda $083A
96	.f4bc		9d 04 08	sta $0804,x	                sta $0804,x
97	.f4bf		fe 08 08	inc $0808,x	                inc $0808,x
98	.f4c2						LF4C2:
99	.f4c2		68		pla		                pla
100	.f4c3		5d 04 08	eor $0804,x	                eor $0804,x
101	.f4c6		29 f8		and #$f8	                and #$F8
102	.f4c8		f0 06		beq $f4d0	                beq LF4D0
103	.f4ca		bd 04 08	lda $0804,x	                lda $0804,x
104	.f4cd		20 99 f5	jsr $f599	                jsr LF599
105	.f4d0						LF4D0:
106	.f4d0		bd 10 08	lda $0810,x	                lda $0810,x
107	.f4d3		c9 03		cmp #$03	                cmp #$03
108	.f4d5		f0 49		beq $f520	                beq LF520
109	.f4d7		bd 14 08	lda $0814,x	                lda $0814,x
110	.f4da		d0 28		bne $f504	                bne LF504
111	.f4dc		fe 10 08	inc $0810,x	                inc $0810,x
112	.f4df		bd 10 08	lda $0810,x	                lda $0810,x
113	.f4e2		c9 03		cmp #$03	                cmp #$03
114	.f4e4		d0 0e		bne $f4f4	                bne LF4F4
115	.f4e6		bc 20 08	ldy $0820,x	                ldy $0820,x
116	.f4e9		b9 c0 08	lda $08c0,y	                lda $08C0,y
117	.f4ec		30 32		bmi $f520	                bmi LF520
118	.f4ee		9e 30 08	stz $0830,x	                stz $0830,x
119	.f4f1		9e 10 08	stz $0810,x	                stz $0810,x
120	.f4f4						LF4F4:
121	.f4f4		bd 10 08	lda $0810,x	                lda $0810,x
122	.f4f7		18		clc		                clc
123	.f4f8		7d 20 08	adc $0820,x	                adc $0820,x
124	.f4fb		a8		tay		                tay
125	.f4fc		b9 c4 08	lda $08c4,y	                lda $08C4,y
126	.f4ff		9d 14 08	sta $0814,x	                sta $0814,x
127	.f502		f0 1c		beq $f520	                beq LF520
128	.f504						LF504:
129	.f504		de 14 08	dec $0814,x	                dec $0814,x
130	.f507		bd 20 08	lda $0820,x	                lda $0820,x
131	.f50a		18		clc		                clc
132	.f50b		7d 10 08	adc $0810,x	                adc $0810,x
133	.f50e		a8		tay		                tay
134	.f50f		b9 c1 08	lda $08c1,y	                lda $08C1,y
135	.f512		18		clc		                clc
136	.f513		7d 30 08	adc $0830,x	                adc $0830,x
137	.f516		9d 30 08	sta $0830,x	                sta $0830,x
138	.f519		18		clc		                clc
139	.f51a		7d 0c 08	adc $080c,x	                adc $080C,x
140	.f51d		20 d5 f5	jsr $f5d5	                jsr LF5D5
141	.f520						LF520:
142	.f520		e0 04		cpx #$04	                cpx #$04
143	.f522		f0 03		beq $f527	                beq LF527
144	.f524		4c 26 f4	jmp $f426	                jmp LF426

146	.f527						LF527:
147	.f527		60		rts		                rts

149	.f528						LF528:
150	.f528		bd 08 08	lda $0808,x	                lda $0808,x
151	.f52b		c9 04		cmp #$04	                cmp #$04
152	.f52d		f0 05		beq $f534	                beq LF534
153	.f52f		a9 03		lda #$03	                lda #$03
154	.f531		9d 08 08	sta $0808,x	                sta $0808,x
155	.f534						LF534:
156	.f534		bd ce 02	lda $02ce,x	                lda bufferEmptyFlags,x
157	.f537		f0 14		beq $f54d	                beq LF54D
158	.f539		a9 00		lda #$00	                lda #$00
159	.f53b		9e ce 02	stz $02ce,x	                stz bufferEmptyFlags,x
160	.f53e		a0 04		ldy #$04	                ldy #$04
161	.f540						LF540:
162	.f540		99 2b 08	sta $082b,y	                sta $082B,y
163	.f543		88		dey		                dey
164	.f544		d0 fa		bne $f540	                bne LF540
165	.f546		9e 18 08	stz $0818,x	                stz $0818,x
166	.f549		88		dey		                dey
167	.f54a		8c 38 08	sty $0838	                sty $0838
168	.f54d						LF54D:
169	.f54d		bd 28 08	lda $0828,x	                lda $0828,x
170	.f550		f0 60		beq $f5b2	                beq LF5B2
171	.f552		ad 3b 08	lda $083b	                lda $083B
172	.f555		f0 34		beq $f58b	                beq LF58B
173	.f557		9e 28 08	stz $0828,x	                stz $0828,x
174	.f55a						LF55A:
175	.f55a		4c 85 f6	jmp $f685	                jmp LF685

177							;-------------------------------------------------------------------------
178							;
179							; Clear a buffer that's a sound channel.
180							;
181							; https://tobylobster.github.io/mos/mos/S-s16.html#SP7
182							;
183							; Entry:
184							;
185							; X = buffer number (must be a sound channel buffer)
186							;
187							                .if version==350
191							                .else
192	.f55d						clearSoundChannelBuffer:
193							                .endif
194							                .block
195	.f55d		20 92 f5	jsr $f592	                jsr LF592
196	.f560		98		tya		                tya
197	.f561		9e 18 08	stz $0818,x	                stz $0818,x
198	.f564		9e ce 02	stz $02ce,x	                stz bufferEmptyFlags,x
199	.f567		9e 00 08	stz $0800,x	                stz $0800,x
200	.f56a		a0 03		ldy #$03	                ldy #$03
201	.f56c						loop:
202	.f56c		99 2c 08	sta $082c,y	                sta $082C,y
203	.f56f		88		dey		                dey
204	.f570		10 fa		bpl $f56c	                bpl loop
205	.f572		8c 38 08	sty $0838	                sty $0838
206	.f575		80 63		bra $f5da	                bra LF5DA
207							                .endblock

209							;-------------------------------------------------------------------------

211	.f577						LF577:
212	.f577		08		php		                php
213	.f578		78		sei		                sei
214	.f579		bd 08 08	lda $0808,x	                lda $0808,x
215	.f57c		c9 04		cmp #$04	                cmp #$04
216	.f57e		d0 0a		bne $f58a	                bne LF58A
217	.f580		20 ef e9	jsr $e9ef	                jsr mos.osbyte98
218	.f583		90 05		bcc $f58a	                bcc LF58A
219	.f585		a9 00		lda #$00	                lda #$00
220	.f587		9e 00 08	stz $0800,x	                stz $0800,x
221	.f58a						LF58A:
222	.f58a		28		plp		                plp
223	.f58b						LF58B:
224	.f58b		bc 20 08	ldy $0820,x	                ldy $0820,x
225	.f58e		c0 ff		cpy #$ff	                cpy #$FF
226	.f590		d0 72		bne $f604	                bne LF604

228							                ; https://tobylobster.github.io/mos/mos/S-s16.html#SP2
229	.f592						LF592:
230	.f592		a9 04		lda #$04	                lda #$04
231	.f594		9d 08 08	sta $0808,x	                sta $0808,x
232	.f597		a9 c0		lda #$c0	                lda #$C0
233	.f599						LF599:
234	.f599		9d 04 08	sta $0804,x	                sta $0804,x
235	.f59c		ac 62 02	ldy $0262	                ldy soundSuppressionStatus
236	.f59f		f0 02		beq $f5a3	                beq LF5A3
237	.f5a1		a9 c0		lda #$c0	                lda #$C0
238	.f5a3						LF5A3:
239	.f5a3		38		sec		                sec
240	.f5a4		e9 40		sbc #$40	                sbc #$40
241	.f5a6		4a		lsr a		                lsr a
242	.f5a7		4a		lsr a		                lsr a
243	.f5a8		4a		lsr a		                lsr a
244	.f5a9		49 0f		eor #$0f	                eor #$0F
245	.f5ab		1d 0b f4	ora $f40b,x	                ora soundParameterTable-bufferNumberSound0,x
246	.f5ae		09 10		ora #$10	                ora #$10
247	.f5b0		80 34		bra $f5e6	                bra LF5E6

249	.f5b2						LF5B2:
250	.f5b2		20 ef e9	jsr $e9ef	                jsr mos.osbyte98
251	.f5b5		b0 c0		bcs $f577	                bcs LF577
252	.f5b7		29 03		and #$03	                and #$03
253	.f5b9		f0 9f		beq $f55a	                beq LF55A
254	.f5bb		ad 38 08	lda $0838	                lda $0838
255	.f5be		f0 cb		beq $f58b	                beq LF58B
256	.f5c0		fe 28 08	inc $0828,x	                inc $0828,x
257	.f5c3		a8		tay		                tay
258	.f5c4		10 0a		bpl $f5d0	                bpl LF5D0
259	.f5c6		20 ef e9	jsr $e9ef	                jsr mos.osbyte98
260	.f5c9		29 03		and #$03	                and #$03
261	.f5cb		8d 38 08	sta $0838	                sta $0838
262	.f5ce		80 bb		bra $f58b	                bra LF58B

264	.f5d0						LF5D0:
265	.f5d0		ce 38 08	dec $0838	                dec $0838
266	.f5d3		80 b6		bra $f58b	                bra LF58B

268	.f5d5						LF5D5:
269	.f5d5		dd 2c 08	cmp $082c,x	                cmp $082C,x
270	.f5d8		f0 2a		beq $f604	                beq LF604
271	.f5da						LF5DA:
272	.f5da		9d 2c 08	sta $082c,x	                sta $082C,x
273	.f5dd		e0 04		cpx #$04	                cpx #$04
274	.f5df		d0 24		bne $f605	                bne LF605
275	.f5e1		29 0f		and #$0f	                and #$0F
276	.f5e3		1d 0b f4	ora $f40b,x	                ora soundParameterTable-bufferNumberSound0,x
277	.f5e6						LF5E6:
278	.f5e6		08		php		                php
279	.f5e7						LF5E7:
280	.f5e7		78		sei		                sei
281	.f5e8		a0 ff		ldy #$ff	                ldy #$FF
282	.f5ea		8c 43 fe	sty $fe43	                sty systemVIA.ddra
283	.f5ed		8d 4f fe	sta $fe4f	                sta systemVIA.oraNoHandshake
284	.f5f0		c8		iny		                iny
285	.f5f1		8c 40 fe	sty $fe40	                sty systemVIA.orb
286	.f5f4		a0 02		ldy #$02	                ldy #$02
287	.f5f6						LF5F6:
288	.f5f6		88		dey		                dey
289	.f5f7		d0 fd		bne $f5f6	                bne LF5F6
290	.f5f9		a0 08		ldy #$08	                ldy #$08
291	.f5fb		8c 40 fe	sty $fe40	                sty systemVIA.orb
292	.f5fe		a0 04		ldy #$04	                ldy #$04
293	.f600						LF600:
294	.f600		88		dey		                dey
295	.f601		d0 fd		bne $f600	                bne LF600
296	.f603		28		plp		                plp
297	.f604						LF604:
298	.f604		60		rts		                rts

300	.f605						LF605:
301	.f605		48		pha		                pha
302	.f606		29 03		and #$03	                and #$03
303	.f608		8d 3c 08	sta $083c	                sta $083C
304	.f60b		9c 3d 08	stz $083d	                stz $083D
305	.f60e		68		pla		                pla
306	.f60f		4a		lsr a		                lsr a
307	.f610		4a		lsr a		                lsr a
308	.f611						LF611:
309	.f611		c9 0c		cmp #$0c	                cmp #$0C
310	.f613		90 07		bcc $f61c	                bcc LF61C
311	.f615		ee 3d 08	inc $083d	                inc $083D
312	.f618		e9 0c		sbc #$0c	                sbc #$0C
313	.f61a		d0 f5		bne $f611	                bne LF611
314	.f61c						LF61C:
315	.f61c		a8		tay		                tay
316	.f61d		ad 3d 08	lda $083d	                lda $083D
317	.f620		48		pha		                pha
318	.f621		b9 e4 f6	lda $f6e4,y	                lda LF6E4,y
319	.f624		8d 3d 08	sta $083d	                sta $083D
320	.f627		b9 f0 f6	lda $f6f0,y	                lda LF6F0,y
321	.f62a		48		pha		                pha
322	.f62b		29 03		and #$03	                and #$03
323	.f62d		8d 3e 08	sta $083e	                sta $083E
324	.f630		68		pla		                pla
325							                .if version==350
327							                .else
328	.f631		4a		lsr a		                lsr a
329	.f632		4a		lsr a		                lsr a
330	.f633		4a		lsr a		                lsr a
331	.f634		4a		lsr a		                lsr a
332							                .endif
333	.f635		8d 3f 08	sta $083f	                sta $083F
334	.f638		ad 3d 08	lda $083d	                lda $083D
335	.f63b		ac 3c 08	ldy $083c	                ldy $083C
336	.f63e		f0 0c		beq $f64c	                beq LF64C
337	.f640						LF640:
338	.f640		38		sec		                sec
339	.f641		ed 3f 08	sbc $083f	                sbc $083F
340	.f644		b0 03		bcs $f649	                bcs LF649
341	.f646		ce 3e 08	dec $083e	                dec $083E
342	.f649						LF649:
343	.f649		88		dey		                dey
344	.f64a		d0 f4		bne $f640	                bne LF640
345	.f64c						LF64C:
346	.f64c		8d 3d 08	sta $083d	                sta $083D
347	.f64f		68		pla		                pla
348	.f650		a8		tay		                tay
349	.f651		f0 09		beq $f65c	                beq LF65C
350	.f653						LF653:
351	.f653		4e 3e 08	lsr $083e	                lsr $083E
352	.f656		6e 3d 08	ror $083d	                ror $083D
353	.f659		88		dey		                dey
354	.f65a		d0 f7		bne $f653	                bne LF653
355	.f65c						LF65C:
356	.f65c		ad 3d 08	lda $083d	                lda $083D
357	.f65f		18		clc		                clc
358	.f660		7d 65 e1	adc $e165,x	                adc mos.LE165,x
359	.f663		8d 3d 08	sta $083d	                sta $083D
360	.f666		90 03		bcc $f66b	                bcc LF66B
361	.f668		ee 3e 08	inc $083e	                inc $083E
362	.f66b						LF66B:
363	.f66b		29 0f		and #$0f	                and #$0F
364	.f66d		1d 0b f4	ora $f40b,x	                ora soundParameterTable-bufferNumberSound0,x
365	.f670		08		php		                php
366	.f671		78		sei		                sei
367	.f672		20 e6 f5	jsr $f5e6	                jsr LF5E6
368	.f675		ad 3d 08	lda $083d	                lda $083D
369	.f678		4e 3e 08	lsr $083e	                lsr $083E
370	.f67b		6a		ror a		                ror a
371	.f67c		4e 3e 08	lsr $083e	                lsr $083E
372	.f67f		6a		ror a		                ror a
373	.f680		4a		lsr a		                lsr a
374	.f681		4a		lsr a		                lsr a
375	.f682		4c e7 f5	jmp $f5e7	                jmp LF5E7

377	.f685						LF685:
378	.f685		08		php		                php
379	.f686		78		sei		                sei
380	.f687		20 f4 e9	jsr $e9f4	                jsr mos.osbyte91
381	.f68a		48		pha		                pha
382	.f68b		29 04		and #$04	                and #$04
383	.f68d		f0 13		beq $f6a2	                beq LF6A2
384	.f68f		68		pla		                pla
385	.f690		bc 20 08	ldy $0820,x	                ldy $0820,x
386	.f693		c8		iny		                iny
387	.f694		d0 03		bne $f699	                bne LF699
388	.f696		20 92 f5	jsr $f592	                jsr LF592
389	.f699						LF699:
390	.f699		20 f4 e9	jsr $e9f4	                jsr mos.osbyte91
391	.f69c		20 f4 e9	jsr $e9f4	                jsr mos.osbyte91
392	.f69f		28		plp		                plp
393	.f6a0		80 3e		bra $f6e0	                bra LF6E0

395	.f6a2						LF6A2:
396	.f6a2		68		pla		                pla
397	.f6a3		29 f8		and #$f8	                and #$F8
398	.f6a5		0a		asl a		                asl a
399	.f6a6		90 0b		bcc $f6b3	                bcc LF6B3
400	.f6a8		49 ff		eor #$ff	                eor #$FF
401	.f6aa		4a		lsr a		                lsr a
402	.f6ab		38		sec		                sec
403	.f6ac		e9 40		sbc #$40	                sbc #$40
404	.f6ae		20 99 f5	jsr $f599	                jsr LF599
405	.f6b1		a9 ff		lda #$ff	                lda #$FF
406	.f6b3						LF6B3:
407	.f6b3		9d 20 08	sta $0820,x	                sta $0820,x
408	.f6b6		a9 05		lda #$05	                lda #$05
409	.f6b8		9d 1c 08	sta $081c,x	                sta $081C,x
410	.f6bb		a9 01		lda #$01	                lda #$01
411	.f6bd		9d 24 08	sta $0824,x	                sta $0824,x
412	.f6c0		9e 14 08	stz $0814,x	                stz $0814,x
413	.f6c3		9e 08 08	stz $0808,x	                stz $0808,x
414	.f6c6		9e 30 08	stz $0830,x	                stz $0830,x
415	.f6c9		a9 ff		lda #$ff	                lda #$FF
416	.f6cb		9d 10 08	sta $0810,x	                sta $0810,x
417	.f6ce		20 f4 e9	jsr $e9f4	                jsr mos.osbyte91
418	.f6d1		9d 0c 08	sta $080c,x	                sta $080C,x
419	.f6d4		20 f4 e9	jsr $e9f4	                jsr mos.osbyte91
420	.f6d7		28		plp		                plp
421	.f6d8		48		pha		                pha
422	.f6d9		bd 0c 08	lda $080c,x	                lda $080C,x
423	.f6dc		20 d5 f5	jsr $f5d5	                jsr LF5D5
424	.f6df		68		pla		                pla
425	.f6e0						LF6E0:
426	.f6e0		9d 18 08	sta $0818,x	                sta $0818,x
427	.f6e3		60		rts		                rts

429	.f6e4						LF6E4:
430	>f6e4		f0				                .byte $F0
431	>f6e5		b7				                .byte $B7
432	>f6e6		82				                .byte $82
433	>f6e7		4f				                .byte $4F
434	>f6e8		20				                .byte $20
435	>f6e9		f3				                .byte $F3
436	>f6ea		c8				                .byte $C8
437	>f6eb		a0				                .byte $A0
438	>f6ec		7b				                .byte $7B
439	>f6ed		57				                .byte $57
440	>f6ee		35				                .byte $35
441	>f6ef		16				                .byte $16
442	.f6f0						LF6F0:
443	>f6f0		e7				                .byte $E7
444	>f6f1		d7				                .byte $D7
445	>f6f2		cb				                .byte $CB
446	>f6f3		c3				                .byte $C3
447	>f6f4		b7				                .byte $B7
448	>f6f5		aa				                .byte $AA
449	>f6f6		a2				                .byte $A2
450	>f6f7		9a				                .byte $9a
451	>f6f8		92				                .byte $92
452	>f6f9		8a				                .byte $8a
453	>f6fa		82				                .byte $82
454	>f6fb		7a				                .byte $7a

:13	;******  Return to file: src/mos.s65

11878							                .endif

11880							;-------------------------------------------------------------------------

11882							                .if version>=500
11903							                .endif

11905							;-------------------------------------------------------------------------

11907							                .if version==350
11913							                .endif

11915							;-------------------------------------------------------------------------

11917							                .if version==350
11925							                .endif

11927							;-------------------------------------------------------------------------

11929							                .if version==350
11934							                .endif

11936							;-------------------------------------------------------------------------

11938	.f6fc						LF6FC:
11939	.f6fc		a9 ff		lda #$ff	                lda #$FF
11940	.f6fe		85 f5		sta $f5		                sta $F5
11941	.f700		60		rts		                rts

11943	.f701						LF701:
11944	.f701		e6 f5		inc $f5		                inc $F5
11945	.f703		a4 f5		ldy $f5		                ldy $F5
11946	.f705		a2 0d		ldx #$0d	                ldx #romServiceCallROMFilingSystemInitialize
11947	.f707						LF707:
11948	.f707		08		php		                php
11949	.f708		20 72 ee	jsr $ee72	                jsr makeROMServiceCall
11950	.f70b		28		plp		                plp
11951	.f70c		c9 01		cmp #$01	                cmp #$01
11952	.f70e		98		tya		                tya
11953	.f70f		60		rts		                rts

11955	.f710						LF710:
11956	.f710		a2 0e		ldx #$0e	                ldx #$0E
11957	.f712		a0 ff		ldy #$ff	                ldy #$FF
11958	.f714		4c 07 f7	jmp $f707	                jmp LF707

11960	.f717						LF717:
11961	.f717		ad cb 03	lda $03cb	                lda $03CB
11962	.f71a		85 f6		sta $f6		                sta $F6
11963	.f71c		ad cc 03	lda $03cc	                lda $03CC
11964	.f71f		85 f7		sta $f7		                sta $F7
11965	.f721		a5 f5		lda $f5		                lda $F5
11966	.f723		60		rts		                rts

11968	.f724						tidyUpAfterKeyboardProcessing:
11969	.f724		a2 ff		ldx #$ff	                ldx #$FF
11970	.f726		a5 ec		lda $ec		                lda lastKeyPressedInternal
11971	.f728		05 ed		ora $ed		                ora firstKeyPressedInternal
11972	.f72a		d0 06		bne $f732	                bne +                    ;taken if any keys pressed
11973	.f72c		a9 81		lda #$81	                lda #$81
11974	.f72e		8d 4e fe	sta $fe4e	                sta systemVIA.ier            ;re-enable keyboard IRQ
11975	.f731		e8		inx		                inx                          ;X=0
11976	.f732						+
11977	.f732		8e 42 02	stx $0242	                stx keyboardSemaphore
11978	.f735						updateKeyboardLEDs:
11979	.f735		08		php		                php
11980	.f736		ad 5a 02	lda $025a	                lda keyboardStatusByte
11981	.f739		4a		lsr a		                lsr a

11983							                ; bit 3 = caps lock off
11984							                ; bit 4 = shift lock off
11985	.f73a		29 18		and #$18	                and #(keyboardStatusByte.capsLockDisengaged|keyboardStatusByte.shiftLockDisengaged)>>1
11986	.f73c		09 06		ora #$06	                ora #$06                     ;latch B6 - caps lock
11987	.f73e		8d 40 fe	sta $fe40	                sta systemVIA.orb            ;update caps lock LED
11988	.f741		4a		lsr a		                lsr a                        ;bit 3 = shift lock off
11989	.f742		09 07		ora #$07	                ora #$07                     ;latch B7 - shift lock
11990	.f744		8d 40 fe	sta $fe40	                sta systemVIA.orb            ;update shift lock LED
11991	.f747		20 1c f9	jsr $f91c	                jsr enableKeyboardScanning
11992	.f74a		68		pla		                pla
11993	.f74b		60		rts		                rts

11995							; KEYV handler
11996							; ============
11997	.f74c						keyEntryPoint:
11998	.f74c		50 0a		bvc $f758	                bvc keyVClear
11999	.f74e		a9 01		lda #$01	                lda #$01
12000	.f750		8d 4e fe	sta $fe4e	                sta systemVIA.ier
12001	.f753		b0 08		bcs $f75d	                bcs keyboardTimerInterrupt
12002	.f755		4c 65 f8	jmp $f865	                jmp keyPressedInterrupt

12004	.f758						keyVClear:
12005	.f758		90 06		bcc $f760	                bcc keyTestSHIFTAndCTRLOrTimerInterrupt
12006	.f75a		4c 16 f9	jmp $f916	                jmp scanKeyboard

12008	.f75d						keyboardTimerInterrupt:
12009	.f75d		ee 42 02	inc $0242	                inc keyboardSemaphore

12011							;-------------------------------------------------------------------------
12012							;
12013							; Test Shift & Ctrl keys, or deal with timer interrupt.
12014							;
12015							; Entry: C=0 if KEYV V=0 C=0 - test SHIFT+CTRL keys
12016							;        C=1 if KEYV V=1 C=1 - keyboard timer interrupt
12017							;
12018	.f760						keyTestSHIFTAndCTRLOrTimerInterrupt:
12019	.f760		ad 5a 02	lda $025a	                lda keyboardStatusByte
12020	.f763		29 b7		and #$b7	                and #~(keyboardStatusByte.shiftPressed|keyboardStatusByte.ctrlPressed)
12021	.f765		a2 00		ldx #$00	                ldx #key_shift
12022	.f767		20 80 f8	jsr $f880	                jsr interrogateKeyboard      ;X=$80 if SHIFT pressed
12023	.f76a		90 02		bcc $f76e	                bcc +                        ;taken if testing
12024							                                             ;SHIFT+CTRL only
12025	.f76c		86 fa		stx $fa		                stx SEIWKA                   ;b7 set if SHIFT pressed
12026	.f76e						+
12027	.f76e		b8		clv		                clv                        ;V=0
12028	.f76f		10 05		bpl $f776	                bpl testCTRL               ;taken if SHIFT not pressed
12029	.f771		2c 4e e3	bit $e34e	                bit valueFF                ;V=1 N=1
12030	.f774		09 08		ora #$08	                ora #keyboardStatusByte.shiftPressed
12031	.f776						testCTRL:
12032	.f776		e8		inx		                inx                          ;X=1 - key_ctrl
12033	.f777		20 80 f8	jsr $f880	                jsr interrogateKeyboard
12034	.f77a		90 b9		bcc $f735	                bcc updateKeyboardLEDs ;taken if testing SHIFT+CTRL only
12035	.f77c		10 02		bpl $f780	                bpl updateKeyboardStatusByte ;taken if CTRL not pressed
12036	.f77e		09 40		ora #$40	                ora #keyboardStatusByte.ctrlPressed
12037	.f780						updateKeyboardStatusByte:
12038	.f780		8d 5a 02	sta $025a	                sta keyboardStatusByte
12039	.f783		a6 ec		ldx $ec		                ldx lastKeyPressedInternal
12040	.f785		f0 4d		beq $f7d4	                beq braRolloverChecks        ;taken if no key pressed
12041	.f787		20 80 f8	jsr $f880	                jsr interrogateKeyboard      ;still pressed?
12042	.f78a		30 0d		bmi $f799	                bmi checkForKeyAutoRepeat    ;taken if still pressed
12043	.f78c		e4 ec		cpx $ec		                cpx lastKeyPressedInternal   ;X=0 at this point
12044	.f78e						storeLastKeyPressed:
12045	.f78e		86 ec		stx $ec		                stx lastKeyPressedInternal   ;update last key pressed
12046	.f790		d0 42		bne $f7d4	                bne braRolloverChecks  ;taken if still nothing pressed
12047	.f792		64 ec		stz $ec		                stz lastKeyPressedInternal   ;reset last key pressed
12048	.f794						resetAutoRepeatAndContinue:
12049	.f794		20 75 f8	jsr $f875	                jsr resetAutoRepeatCounters
12050	.f797		80 3b		bra $f7d4	                bra braRolloverChecks

12052	.f799						checkForKeyAutoRepeat:
12053	.f799		e4 ec		cpx $ec		                cpx lastKeyPressedInternal
12054	.f79b		d0 f1		bne $f78e	                bne storeLastKeyPressed      ;taken if new key pressed
12055	.f79d		a5 e7		lda $e7		                lda autoRepeatCountdownTimer
12056	.f79f		f0 33		beq $f7d4	                beq braRolloverChecks      ;taken if countdown timer 0
12057	.f7a1		c6 e7		dec $e7		                dec autoRepeatCountdownTimer ;timer--
12058	.f7a3		d0 2f		bne $f7d4	                bne braRolloverChecks        ;taken if timer newly 0
12059	.f7a5		ad ca 02	lda $02ca	                lda keyboardFirstAutoRepeatCount
12060	.f7a8		85 e7		sta $e7		                sta autoRepeatCountdownTimer
12061	.f7aa		ad 55 02	lda $0255	                lda keyboardAutoRepeatRate
12062	.f7ad		8d ca 02	sta $02ca	                sta keyboardFirstAutoRepeatCount
12063	.f7b0		ad 5a 02	lda $025a	                lda keyboardStatusByte
12064	.f7b3		a6 ec		ldx $ec		                ldx lastKeyPressedInternal
12065	.f7b5		e0 d0		cpx #$d0	                cpx #$80|key_shift_lock
12066	.f7b7		f0 12		beq $f7cb	                beq shiftLockPressed
12067	.f7b9		e0 c0		cpx #$c0	                cpx #$80|key_caps_lock
12068							                .if version>=511||version==350
12070							                .else
12071	.f7bb		d0 19		bne $f7d6	                bne getASCIICode
12072							                .endif
12073	.f7bd						capsLockPressed:
12074	.f7bd		09 a0		ora #$a0	                ora #keyboardStatusByte.shiftEnabled|keyboardStatusByte.shiftLockDisengaged
12075	.f7bf		24 fa		bit $fa		                bit SEIWKA                   ;test SHIFT status
12076	.f7c1		10 04		bpl $f7c7	                bpl +                        ;taken if SHIFT not pressed
12077							                ; Do the SHIFT+CAPS LOCK thing
12078	.f7c3		09 10		ora #$10	                ora #keyboardStatusByte.capsLockDisengaged
12079	.f7c5		49 80		eor #$80	                eor #keyboardStatusByte.shiftEnabled
12080	.f7c7						+
12081	.f7c7		49 90		eor #$90	                eor #keyboardStatusByte.shiftEnabled|keyboardStatusByte.capsLockDisengaged
12082	.f7c9		80 04		bra $f7cf	                bra resetKeyboardStatusAndTimer

12084	.f7cb						shiftLockPressed:
12085	.f7cb		09 90		ora #$90	                ora #keyboardStatusByte.shiftEnabled|keyboardStatusByte.capsLockDisengaged
12086	.f7cd		49 a0		eor #$a0	                eor #keyboardStatusByte.shiftEnabled|keyboardStatusByte.shiftLockDisengaged
12087	.f7cf						resetKeyboardStatusAndTimer:
12088	.f7cf		8d 5a 02	sta $025a	                sta keyboardStatusByte
12089	.f7d2		64 e7		stz $e7		                stz autoRepeatCountdownTimer
12090	.f7d4						braRolloverChecks:
12091							                .if version<500&&version!=350
12092	.f7d4		80 6f		bra $f845	                bra keyboardRolloverChecks
12095							                .endif

12097							;-------------------------------------------------------------------------

12099							                .if version>=511||version==350
12127							                .endif
12128							;-------------------------------------------------------------------------
12129							;
12130							; Convert internal key number (with bit 7 set) to ASCII code, taking
12131							; into account state of CTRL, SHIFT, CAPS LOCK and SHIFT LOCK.
12132							;
12133	.f7d6						getASCIICode:
12134							                ; -$80 to adjust for bit 7 set; -16 because
12135							                ; interesting keys start at 16
12136	.f7d6		bd 02 f8	lda $f802,x	                lda keyTranslationTable-$80-16,x
12137							                .if version>=500
12153							                .endif
12154	.f7d9		f0 08		beq $f7e3	                beq handleTAB                ;taken if TAB
12155	.f7db		c9 9d		cmp #$9d	                cmp #$9D                     ;was it key_numpad_return?
12156							                .if version<500&&version!=350
12157	.f7dd		d0 07		bne $f7e6	                bne handleKey                ;taken if not
12160							                .endif

12162							                ;Transform $9d into $8d, aka 13|$80. ($8d is already
12163							                ; used in the table for right arrow.)
12164	.f7df		49 10		eor #$10	                eor #$10
12165	.f7e1		80 07		bra $f7ea	                bra getNumpadASCIICode

12167	.f7e3						handleTAB:
12168	.f7e3		ad 6b 02	lda $026b	                lda tabKeyCode
12169							                .if version>=500
12202							                .endif
12203	.f7e6						handleKey:
12204	.f7e6		c9 a0		cmp #$a0	                cmp #$A0                     ;numpad key?
12205	.f7e8		90 0c		bcc $f7f6	                bcc processModifiers         ;taken if not
12206	.f7ea						getNumpadASCIICode:
12207							                .if version>=500||version==350
12209							                .endif
12210							                ; C=1 at this point
12211	.f7ea		e9 31		sbc #$31	                sbc #'0'+1      ;+1 to compensate for C=1 in the next
12212							                                ;addition
12213	.f7ec		6d 7e 02	adc $027e	                adc numericKeypadInterpretation ;form actual ASCII value
12214							                .if version>=500||version==350
12216							                .endif
12217	.f7ef		49 80		eor #$80	                eor #$80                     ;clear bit 7
12218	.f7f1		ae 8e 02	ldx $028e	                ldx numericKeypadShiftEffect ;does SHIFT affect the
12219							                                             ;keypad?
12220	.f7f4		d0 43		bne $f839	                bne LF839                    ;taken if no
12221	.f7f6						processModifiers:
12222	.f7f6		ae 5a 02	ldx $025a	                ldx keyboardStatusByte
12223	.f7f9		86 fa		stx $fa		                stx SEIWKA
12224	.f7fb		26 fa		rol $fa		                rol SEIWKA                  ;b7 = ctrlPressed
12225	.f7fd		10 07		bpl $f806	                bpl testShiftLock           ;taken if ctrl not pressed
12226	.f7ff		a6 ed		ldx $ed		                ldx firstKeyPressedInternal
12227	.f801						localResetAutoRepeatAndContinue:
12228							                .if version<500&&version!=350
12229	.f801		d0 91		bne $f794	                bne resetAutoRepeatAndContinue
12230	.f803		20 36 f3	jsr $f336	                jsr implementCTRLCodes
12236							                .endif
12237	.f806						testShiftLock:
12238	.f806		26 fa		rol $fa		                rol SEIWKA                   ;b7 = shiftLockDisengaged
12239	.f808		30 07		bmi $f811	                bmi testCapsLock             ;taken if shift lock off
12240	.f80a		20 13 f3	jsr $f313	                jsr implementShift           ;shift lock on - apply shift
12241	.f80d		26 fa		rol $fa		                rol SEIWKA                   ;b7 = capsLockDisengaged
12242	.f80f		80 0c		bra $f81d	                bra testShiftEnabled

12244	.f811						testCapsLock:
12245	.f811		26 fa		rol $fa		                rol SEIWKA                   ;b7 = capsLockDisengaged
12246	.f813		30 0d		bmi $f822	                bmi testShift                ;taken if caps lock off
12247	.f815		20 71 ea	jsr $ea71	                jsr isLetter
12248	.f818		b0 08		bcs $f822	                bcs testShift                ;taken if not a letter
12249	.f81a		20 13 f3	jsr $f313	                jsr implementShift ;letter + caps lock - make upper case
12250	.f81d						testShiftEnabled:
12251	.f81d		ae 5a 02	ldx $025a	                ldx keyboardStatusByte       ;b7 = shiftEnabled
12252	.f820		10 0b		bpl $f82d	                bpl testEscape               ;taken if not shiftEnabled
12253	.f822						testShift:
12254	.f822		26 fa		rol $fa		                rol SEIWKA                   ;b7 = shiftPressed
12255	.f824		10 07		bpl $f82d	                bpl testEscape               ;taken if not shiftPressed
12256	.f826		a6 ed		ldx $ed		                ldx firstKeyPressedInternal
12257	.f828		d0 d7		bne $f801	                bne localResetAutoRepeatAndContinue
12258	.f82a		20 13 f3	jsr $f313	                jsr implementShift
12259	.f82d						testEscape:
12260	.f82d		cd 6c 02	cmp $026c	                cmp escapeCharacter
12261	.f830		d0 07		bne $f839	                bne LF839
12262	.f832		ae 75 02	ldx $0275	                ldx escapeKeyStatus
12263	.f835		d0 02		bne $f839	                bne LF839
12264	.f837		64 e7		stz $e7		                stz autoRepeatCountdownTimer

12266	.f839						LF839:

12268							                .if version==350
12288							                .elsif version<500

12290	.f839		a8		tay		                tay
12291	.f83a		20 a6 f9	jsr $f9a6	                jsr enableKeyboardScanningFlippingInterrupts
12292	.f83d		ad 59 02	lda $0259	                lda keyboardStatus
12293	.f840		d0 03		bne $f845	                bne keyboardRolloverChecks
12294	.f842		20 7e ea	jsr $ea7e	                jsr insertCharacterIntoKeyboardBuffer

12384							                .endif

12386	.f845						keyboardRolloverChecks:
12387	.f845		a6 ed		ldx $ed		                ldx firstKeyPressedInternal
12388	.f847		f0 09		beq $f852	                beq LF852                    ;taken if 1 key down
12389	.f849		20 80 f8	jsr $f880	                jsr interrogateKeyboard      ;test first key pressed
12390	.f84c		86 ed		stx $ed		                stx firstKeyPressedInternal  ;save it
12391	.f84e		30 18		bmi $f868	                bmi LF868                    ;taken if still pressed
12392	.f850		64 ed		stz $ed		                stz firstKeyPressedInternal  ;reset first key
12393	.f852						LF852:
12394	.f852		a0 ec		ldy #$ec	                ldy #lastKeyPressedInternal
12395	.f854		20 6c f9	jsr $f96c	                jsr scanKeyboardWithExclusion
12396	.f857		30 09		bmi $f862	                bmi LF862
12397	.f859		a5 ec		lda $ec		                lda lastKeyPressedInternal
12398	.f85b		85 ed		sta $ed		                sta firstKeyPressedInternal
12399	.f85d						updateLastKeyPressedInternal:
12400	.f85d		86 ec		stx $ec		                stx lastKeyPressedInternal
12401	.f85f		20 75 f8	jsr $f875	                jsr resetAutoRepeatCounters
12402	.f862						LF862:
12403	.f862		4c 24 f7	jmp $f724	                jmp tidyUpAfterKeyboardProcessing

12405	.f865						keyPressedInterrupt:
12406	.f865		20 80 f8	jsr $f880	                jsr interrogateKeyboard
12407	.f868						LF868:
12408	.f868		a5 ec		lda $ec		                lda lastKeyPressedInternal
12409	.f86a		d0 f6		bne $f862	                bne LF862
12410	.f86c		a0 ed		ldy #$ed	                ldy #firstKeyPressedInternal
12411	.f86e		20 6c f9	jsr $f96c	                jsr scanKeyboardWithExclusion
12412	.f871		30 ef		bmi $f862	                bmi LF862
12413	.f873		80 e8		bra $f85d	                bra updateLastKeyPressedInternal

12415	.f875						resetAutoRepeatCounters:
12416	.f875		a2 01		ldx #$01	                ldx #$01
12417	.f877		86 e7		stx $e7		                stx autoRepeatCountdownTimer
12418	.f879		ae 54 02	ldx $0254	                ldx keyboardAutoRepeatDelay
12419	.f87c		8e ca 02	stx $02ca	                stx keyboardFirstAutoRepeatCount
12420	.f87f		60		rts		                rts

12422							;-------------------------------------------------------------------------
12423							;
12424							; Read a single key's state from the keyboard
12425							;
12426							; Entry:
12427							;
12428							; X = key to test
12429							;
12430							; Exit:
12431							;
12432							; X=$80, N=1 if key pressed; X=$00, N=0 if key not pressed
12433							;
12434							; Preserves: A/C
12435							;
12436							                .if version==350
12439							                .endif
12440	.f880						interrogateKeyboard:
12441	.f880		a0 03		ldy #$03	                ldy #$03                     ;write to keyboard
12442	.f882		8c 40 fe	sty $fe40	                sty systemVIA.orb
12443	.f885		a0 7f		ldy #$7f	                ldy #$7F
12444	.f887		8c 43 fe	sty $fe43	                sty systemVIA.ddra           ;bit 7=input, bits 6-0=output
12445	.f88a		8e 4f fe	stx $fe4f	                stx systemVIA.oraNoHandshake ;store key value
12446	.f88d		ea		nop		                nop
12447	.f88e		ae 4f fe	ldx $fe4f	                ldx systemVIA.iraNoHandshake ;read key state
12448	.f891		60		rts		                rts

12450							; Default keyboard table
12451							; ======================

12453	.f892						keyTranslationTable:
12454	>f892		71				                .text "q"                    ;10 q
12455	>f893		33				                .byte "3"                    ;11 3
12456	>f894		34				                .byte "4"                    ;12 4
12457	>f895		35				                .byte "5"                    ;13 5
12458	>f896		84				                .byte $84                    ;14 f4
12459	>f897		38				                .text "8"                    ;15 8
12460	>f898		87				                .byte $87                    ;16 f7
12461	>f899		2d				                .text "-"                    ;17 minus
12462	>f89a		5e				                .text "^"                    ;18 caret
12463	>f89b		8c				                .byte $8C                    ;19 left
12464	>f89c		b6				                .byte "6"|$80                ;1a numpad_6
12465	>f89d		b7				                .byte "7"|$80                ;1b numpad_7
12466	.f89e						osbyte92:
12467	.f89e		bc 00 fc	ldy $fc00,x	                ldy $FC00,x                  ;1c 1d 1e
12468	.f8a1		60		rts		                rts                          ;1f

12470							                .cerror *-keyTranslationTable!=16,'oops'
12471	>f8a2		80				                .byte $80                    ;20 f0
12472	>f8a3		77				                .text "w"                    ;21 w
12473	>f8a4		65				                .text "e"                    ;22 e
12474	>f8a5		74				                .text "t"                    ;23 t
12475	>f8a6		37				                .text "7"                    ;24 7
12476	>f8a7		69				                .text "i"                    ;25 i
12477	>f8a8		39				                .text "9"                    ;26 9
12478	>f8a9		30				                .text "0"                    ;27 0
12479	>f8aa		5f				                .text "_"                    ;28 underline
12480	>f8ab		8e				                .byte $8E                    ;29 down
12481	>f8ac		b8				                .byte "8"|$80                ;2a numpad_8
12482	>f8ad		b9				                .byte "9"|$80                ;2b numpad_9
12483	.f8ae						osbyte94:
12484	.f8ae		bc 00 fd	ldy $fd00,x	                ldy $FD00,x                  ;2c 2d 2e
12485	.f8b1		60		rts		                rts                          ;2f

12487							                .cerror *-keyTranslationTable!=32,'oops'
12488	>f8b2		31				                .text "1"                    ;30 1
12489	>f8b3		32				                .text "2"                    ;31 2
12490	>f8b4		64				                .text "d"                    ;32 d
12491	>f8b5		72				                .text "r"                    ;33 r
12492	>f8b6		36				                .text "6"                    ;34 6
12493	>f8b7		75				                .text "u"                    ;35 u
12494	>f8b8		6f				                .text "o"                    ;36 o
12495	>f8b9		70				                .text "p"                    ;37 p
12496	>f8ba		5b				                .text "["                    ;38 left_square_bracket
12497	>f8bb		8f				                .byte $8F                    ;39 up
12498	>f8bc		ab				                .byte "+"|$80                ;3a numpad_plus
12499	>f8bd		ad				                .byte "-"|$80                ;3b numpad_minus
12500	>f8be		9d				                .byte $9D                    ;3c numpad_return
12501	.f8bf						LF8BF:
12502	.f8bf		6c 20 02	jmp ($0220)	                jmp (EVENTV)                 ;3d 3e 3f
12503							                .cerror *-keyTranslationTable!=48,'oops'
12504	>f8c2		01				                .byte 1                      ;40 caps_lock
12505	>f8c3		61				                .text "a"                    ;41 a
12506	>f8c4		78				                .text "x"                    ;42 x
12507	>f8c5		66				                .text "f"                    ;43 f
12508	>f8c6		79				                .text "y"                    ;44 y
12509	>f8c7		6a				                .text "j"                    ;45 j
12510	>f8c8		6b				                .text "k"                    ;46 k
12511							                .if version<500
12512	>f8c9		40				                .text "@"                    ;47 at
12515							                .endif
12516	>f8ca		3a				                .text ":"                    ;48 colon
12517	>f8cb		0d				                .byte $0D                    ;49 return
12518	>f8cc		af				                .byte "/"|$80                ;4a numpad_divide
12519	>f8cd		ff				                .byte 127|$80                ;4b numpad_delete
12520	>f8ce		ae				                .byte "."|$80                ;4c numpad_stop
12521	.f8cf						call1MHzBusHook:
12522	.f8cf		6c fe fd	jmp ($fdfe)	                jmp ($FDFE)                  ;4d 4e 4f

12524							                .cerror *-keyTranslationTable!=64,'oops'
12525	>f8d2		02				                .byte 2                      ;50 shift_lock
12526	>f8d3		73				                .text "s"                    ;51 s
12527	>f8d4		63				                .text "c"                    ;52 c
12528	>f8d5		67				                .text "g"                    ;53 g
12529	>f8d6		68				                .text "h"                    ;54 h
12530	>f8d7		6e				                .text "n"                    ;55 n
12531	>f8d8		6c				                .text "l"                    ;56 l
12532	>f8d9		3b				                .text ";"                    ;57 semicolon
12533	>f8da		5d				                .text "]"                    ;58 right_square_bracket
12534	>f8db		7f				                .byte $7F                    ;59 delete
12535	>f8dc		a3				                .byte "#"|$80                ;5a numpad_hash
12536	>f8dd		aa				                .byte "*"|$80                ;5b numpad_multiply
12537	>f8de		ac				                .byte ","|$80                ;5c numpad_comma
12538	.f8df						callSEIWKA:
12539	.f8df		6c fa 00	jmp ($00fa)	                jmp (SEIWKA)                 ;5d 5e 5f
12540							                .cerror *-keyTranslationTable!=80,'oops'
12541	>f8e2		00				                .byte 0                      ;60 tab
12542	>f8e3		7a				                .text "z"                    ;61 z
12543	>f8e4		20				                .text " "                    ;62 space
12544	>f8e5		76				                .text "v"                    ;63 v
12545	>f8e6		62				                .text "b"                    ;64 b
12546	>f8e7		6d				                .text "m"                    ;65 m
12547	>f8e8		2c				                .text ","                    ;66 comma
12548	>f8e9		2e				                .text "."                    ;67 stop
12549	>f8ea		2f				                .text "/"                    ;68 divide
12550	>f8eb		8b				                .byte $8B                    ;69 copy
12551	>f8ec		b0				                .byte "0"|$80                ;6a numpad_0
12552	>f8ed		b1				                .byte "1"|$80                ;6b numpad_1
12553	>f8ee		b3				                .byte "3"|$80                ;6c numpad_3
12554	>f8ef		00				                .byte 0                      ;6d
12555	>f8f0		00				                .byte 0                      ;6e
12556	>f8f1		00				                .byte 0                      ;6f
12557							                .cerror *-keyTranslationTable!=96,'oops'
12558	>f8f2		1b				                .byte 27                     ;70 escape
12559	>f8f3		81				                .byte $81                    ;71 f1
12560	>f8f4		82				                .byte $82                    ;72 f2
12561	>f8f5		83				                .byte $83                    ;73 f3
12562	>f8f6		85				                .byte $85                    ;74 f5
12563	>f8f7		86				                .byte $86                    ;75 f6
12564	>f8f8		88				                .byte $88                    ;76 f8
12565	>f8f9		89				                .byte $89                    ;77 f9
12566	>f8fa		5c				                .byte $5C                    ;78 backslash
12567	>f8fb		8d				                .byte $8D                    ;79 right
12568	>f8fc		b4				                .byte "4"|$80                ;7a numpad_4
12569	>f8fd		b5				                .byte "5"|$80                ;7b numpad_5
12570	>f8fe		b2				                .byte "2"|$80                ;7c numpad_2
12571	.f8ff						LF8FF:
12572	.f8ff		2c 4e e3	bit $e34e	                bit valueFF                  ; Set V
12573	.f902						callKEYV:
12574	.f902		6c 28 02	jmp ($0228)	                jmp (KEYV)                   ; Jump to KEYV

12576							;-------------------------------------------------------------------------
12577							;
12578							; OSBYTE 131 (&83) - Read Operating System High Water Mark (OSHWM)
12579							;
12580							; MasRef D.2-40
12581							;
12582	.f905						osbyte83:
12583	.f905		ac 44 02	ldy $0244	                ldy oshwm
12584	.f908		a2 00		ldx #$00	                ldx #$00
12585	.f90a		60		rts		                rts

12587							;-------------------------------------------------------------------------
12588							;
12589							; OSBYTE 120 ($78) - Write keys pressed information
12590							;
12591							; MasRef D.2-33
12592							;
12593	.f90b						osbyte78:                          ;f90b
12594	.f90b		84 ec		sty $ec		                sty lastKeyPressedInternal
12595	.f90d		86 ed		stx $ed		                stx firstKeyPressedInternal
12596	.f90f		60		rts		                rts

12598							;-------------------------------------------------------------------------
12599							;
12600							; OSBYTE 122 (&7A) Keyboard scan from 16 decimal
12601							;
12602							; MasRef D.2-36
12603							;
12604							                .if version==350
12607							                .endif
12608	.f910						osbyte7A:
12609	.f910		a2 10		ldx #$10	                ldx #$10
12610	.f912		b8		clv		                clv
12611	.f913		38		sec		                sec
12612	.f914		80 ec		bra $f902	                bra callKEYV

12614							;-------------------------------------------------------------------------

12616	.f916						scanKeyboard:
12617	.f916		8a		txa		                txa
12618	.f917		10 0a		bpl $f923	                bpl LF923
12619	.f919		20 80 f8	jsr $f880	                jsr interrogateKeyboard
12620	.f91c						enableKeyboardScanning:
12621	.f91c		a9 0b		lda #$0b	                lda #8|3                     ;set latch B3 - auto scan mode
12622	.f91e		8d 40 fe	sta $fe40	                sta systemVIA.orb            ;set auto scan mode
12623	.f921		8a		txa		                txa
12624	.f922		60		rts		                rts

12626	.f923						LF923:
12627	.f923		8e cb 02	stx $02cb	                stx previousKeyPressedWhenReadingLastKey
12628	.f926		a9 ff		lda #$ff	                lda #$FF
12629	.f928		8d cc 02	sta $02cc	                sta previousKeyPressedWhenReadingFirstKey
12630	.f92b		a2 0c		ldx #$0c	                ldx #$0C
12631	.f92d		a9 7f		lda #$7f	                lda #$7F
12632	.f92f		8d 43 fe	sta $fe43	                sta systemVIA.ddra
12633	.f932		a9 03		lda #$03	                lda #0|3            ;reset latch B3 - manual scan mode
12634	.f934		8d 40 fe	sta $fe40	                sta systemVIA.orb
12635	.f937						loopKeyboardColumns:
12636	.f937		a9 0f		lda #$0f	                lda #$0F
12637	.f939		8d 4f fe	sta $fe4f	                sta systemVIA.oraNoHandshake ;select a non-existent column
12638	.f93c		a9 01		lda #$01	                lda #$01
12639	.f93e		8d 4d fe	sta $fe4d	                sta systemVIA.ifr            ;cancel keyboard interrupts
12640	.f941		8e 4f fe	stx $fe4f	                stx systemVIA.oraNoHandshake ;select column
12641	.f944		2c 4d fe	bit $fe4d	                bit systemVIA.ifr            ;any key in this column
12642							                                             ;pressed?
12643	.f947		f0 1b		beq $f964	                beq tryNextKeyboardColumn    ;taken if no key
12644	.f949		8a		txa		                txa                          ;A = first key in column
12645	.f94a						loopKeyboardRows:
12646	.f94a		18		clc		                clc
12647	.f94b		69 10		adc #$10	                adc #$10                     ;next row
12648	.f94d		30 15		bmi $f964	                bmi tryNextKeyboardColumn    ;taken if done
12649	.f94f		8d 4f fe	sta $fe4f	                sta systemVIA.oraNoHandshake ;store key
12650	.f952		2c 4f fe	bit $fe4f	                bit systemVIA.iraNoHandshake ;pressed?
12651	.f955		10 f3		bpl $f94a	                bpl loopKeyboardRows         ;taken if not
12652	.f957		cd cb 02	cmp $02cb	                cmp previousKeyPressedWhenReadingLastKey
12653	.f95a		90 ee		bcc $f94a	                bcc loopKeyboardRows
12654	.f95c		cd cc 02	cmp $02cc	                cmp previousKeyPressedWhenReadingFirstKey
12655	.f95f		b0 e9		bcs $f94a	                bcs loopKeyboardRows
12656	.f961		8d cc 02	sta $02cc	                sta previousKeyPressedWhenReadingFirstKey
12657	.f964						tryNextKeyboardColumn:
12658	.f964		ca		dex		                dex
12659	.f965		10 d0		bpl $f937	                bpl loopKeyboardColumns
12660	.f967		ae cc 02	ldx $02cc	                ldx previousKeyPressedWhenReadingFirstKey
12661	.f96a		80 b0		bra $f91c	                bra enableKeyboardScanning

12663	.f96c						scanKeyboardWithExclusion:
12664	.f96c		a2 0c		ldx #$0c	                ldx #$0c
12665	.f96e						LF96E:
12666	.f96e		20 a6 f9	jsr $f9a6	                jsr enableKeyboardScanningFlippingInterrupts
12667	.f971		a9 7f		lda #$7f	                lda #$7F
12668	.f973		8d 43 fe	sta $fe43	                sta systemVIA.ddra
12669	.f976		a9 03		lda #$03	                lda #0|3
12670	.f978		8d 40 fe	sta $fe40	                sta systemVIA.orb
12671	.f97b		a9 0f		lda #$0f	                lda #$0F
12672	.f97d		8d 4f fe	sta $fe4f	                sta systemVIA.oraNoHandshake ;select non-existent column
12673	.f980		a9 01		lda #$01	                lda #$01
12674	.f982		8d 4d fe	sta $fe4d	                sta systemVIA.ifr            ;cancel keyboard interrupts
12675	.f985		8e 4f fe	stx $fe4f	                stx systemVIA.oraNoHandshake
12676	.f988		2c 4d fe	bit $fe4d	                bit systemVIA.ifr
12677	.f98b		f0 20		beq $f9ad	                beq LF9AD
12678	.f98d		8a		txa		                txa
12679	.f98e						LF98E:
12680	.f98e		18		clc		                clc
12681	.f98f		69 10		adc #$10	                adc #$10
12682	.f991		30 1a		bmi $f9ad	                bmi LF9AD                    ;taken if done
12683	.f993		8d 4f fe	sta $fe4f	                sta systemVIA.oraNoHandshake ;test key
12684	.f996		2c 4f fe	bit $fe4f	                bit systemVIA.iraNoHandshake ;pressed?
12685	.f999		10 f3		bpl $f98e	                bpl LF98E                    ;taken if not
12686	.f99b		48		pha		                pha                          ;save key number
12687	.f99c						LF99C:
12688	.f99c		59 00 00	eor $0000,y	                eor $0000,y                  ;compare to value
12689	.f99f		0a		asl a		                asl a                        ;discard irrelevant bit 7
12690	.f9a0		c9 01		cmp #$01	                cmp #$01                     ;C set if different
12691	.f9a2		68		pla		                pla                          ;restore key number
12692	.f9a3		90 e9		bcc $f98e	                bcc LF98E                    ;same key found - keep going
12693	.f9a5		aa		tax		                tax
12694	.f9a6						enableKeyboardScanningFlippingInterrupts:
12695	.f9a6		20 1c f9	jsr $f91c	                jsr enableKeyboardScanning
12696	.f9a9		58		cli		                cli
12697	.f9aa		78		sei		                sei
12698	.f9ab		8a		txa		                txa
12699	.f9ac		60		rts		                rts

12701	.f9ad						LF9AD:
12702	.f9ad		ca		dex		                dex
12703	.f9ae		10 be		bpl $f96e	                bpl LF96E
12704	.f9b0		80 f4		bra $f9a6	                bra enableKeyboardScanningFlippingInterrupts

12706							;-------------------------------------------------------------------------

12708							                .if version==400
12710							                .endif

12712							;-------------------------------------------------------------------------

12714							                .if version>=500
12735							                .endif

12737							;-------------------------------------------------------------------------

12739							                .if version>=500
12760							                .endif

12762							;-------------------------------------------------------------------------

12764							                .if version>=400
12766							                .endif

12768							;-------------------------------------------------------------------------

12770							                .if version>=400
12795							                .endif

12797							;-------------------------------------------------------------------------

12799							LF8D1Macro: .macro
12811							                .endmacro

12813							                .if version>=500
12815							                .endif

12817							;-------------------------------------------------------------------------

12819							                .if version>=400
12823							                .endif

12825							;-------------------------------------------------------------------------

12827							                .if version>=400
12831							                .endif

12833							;-------------------------------------------------------------------------

12835							                .if version>=400
12839							                .endif

12841							;-------------------------------------------------------------------------

12843							                .if version>=400
12847							                .endif

12849							;-------------------------------------------------------------------------

12851							                .if version==350
12872							                .endif

12874							;-------------------------------------------------------------------------
12875							;
12876							; OSBPUT [AUG p339]
12877							;
12878	.f9b2						osbputEntryPoint:
12879	.f9b2		20 97 fa	jsr $fa97	                jsr selectFSForHandle
12880	.f9b5		6c 18 02	jmp ($0218)	                jmp (BPUTV)

12882							;-------------------------------------------------------------------------
12883							;
12884							; OSBGET [AUG p338]
12885							;
12886	.f9b8						osbgetEntryPoint:
12887	.f9b8		20 97 fa	jsr $fa97	                jsr selectFSForHandle
12888	.f9bb		6c 16 02	jmp ($0216)	                jmp (BGETV)

12890							;-------------------------------------------------------------------------
12891							;
12892							; OSGBPB [AUG p339]
12893							;
12894	.f9be						osgbpbEntryPoint: .proc
12895	.f9be		c9 05		cmp #$05	                cmp #gbpbGetMediaMetadata
12896	.f9c0		b0 15		bcs $f9d7	                bcs nonFileOperation
12897	.f9c2		c9 00		cmp #$00	                cmp #$00
12898	.f9c4		f0 11		beq $f9d7	                beq nonFileOperation

12900							                ; Handle OSGBPB call that's an operation on a file
12901							                ; handle. Select the appropriate FS, given the file
12902							                ; handle, and pass the request along.
12903	.f9c6		5a		phy		                phy                          ;save OSGBPB Y
12904	.f9c7		48		pha		                pha                          ;save OSGBPB A
12905	.f9c8		86 b0		stx $b0		                stx osgbpbWorkspace.ptr+0
12906	.f9ca		84 b1		sty $b1		                sty osgbpbWorkspace.ptr+1
12907	.f9cc		b2 b0		lda ($b0)	                lda (osgbpbWorkspace.ptr)    ;get file handle
12908	.f9ce		a8		tay		                tay
12909	.f9cf		68		pla		                pla                          ;restore OSGBPB A
12910	.f9d0		20 97 fa	jsr $fa97	                jsr selectFSForHandle
12911	.f9d3						passToCurrentFS:
12912	.f9d3		7a		ply		                ply                          ;restore OSGBPB Y
12913	.f9d4		6c 1a 02	jmp ($021a)	                jmp (GBPBV)

12915							;-------------------------------------------------------------------------
12916							;
12917							; Handle OSGBPB call that isn't an operation on a file handle. Select
12918							; current FS and pass the request along.
12919							;
12920	.f9d7						nonFileOperation:
12921	.f9d7		5a		phy		                phy
12922	.f9d8		da		phx		                phx
12923	.f9d9		48		pha		                pha
12924	.f9da		20 ba ed	jsr $edba	                jsr selectHAZEL
12925	.f9dd		ad 00 df	lda $df00	                lda hazel.currentFS
12926	.f9e0		20 4d fb	jsr $fb4d	                jsr selectFS
12927	.f9e3		68		pla		                pla
12928	.f9e4		fa		plx		                plx
12929	.f9e5		80 ec		bra $f9d3	                bra passToCurrentFS
12930							                .endproc

12932							;-------------------------------------------------------------------------
12933							;
12934							; OSARGS [AUG p337[
12935							;
12936							;
12937	.f9e7						osargsEntryPoint: .proc
12938	.f9e7		c0 00		cpy #$00	                cpy #$00
12939	.f9e9		d0 2a		bne $fa15	                bne fileOperation            ;taken if file operation
12940	.f9eb		c9 04		cmp #$04	                cmp #$04
12941	.f9ed		b0 26		bcs $fa15	                bcs fileOperation ;taken if Y=0, A>=4 - honorary file operation
12942	.f9ef		48		pha		                pha
12943	.f9f0		20 ba ed	jsr $edba	                jsr selectHAZEL
12944	.f9f3		68		pla		                pla
12945	.f9f4		d0 04		bne $f9fa	                bne notGetFS
12946	.f9f6						getFS:
12947							                ; OSARGS Y=0 A=0 - read current FS number
12948	.f9f6		ad 00 df	lda $df00	                lda hazel.currentFS
12949	.f9f9		60		rts		                rts

12951	.f9fa						notGetFS:
12952	.f9fa		3a		dec a		                dec a
12953	.f9fb		d0 10		bne $fa0d	                bne notGetCommandLine
12954	.f9fd						getCommandLine:
12955							                ; OSARGS Y=0 A=1 - read command line tail address
12956	.f9fd		3a		dec a		                dec a                        ;A=$ff
12957	.f9fe		95 02		sta $02,x	                sta 2,x                    ;store full 32-bit address
12958	.fa00		95 03		sta $03,x	                sta 3,x                    ;store full 32-bit address
12959	.fa02		ad 04 df	lda $df04	                lda hazel.commandLinePointer+0
12960	.fa05		95 00		sta $00,x	                sta 0,x                    ;
12961	.fa07		ad 05 df	lda $df05	                lda hazel.commandLinePointer+1
12962	.fa0a		95 01		sta $01,x	                sta 1,x
12963	.fa0c		60		rts		                rts

12965	.fa0d						notGetCommandLine:
12966	.fa0d		c9 01		cmp #$01	                cmp #argsCheckANFS-1    ;-1 due to the dec a above
12967	.fa0f		f0 03		beq $fa14	                beq rtsFA14            ; OSARGS Y=0 A=2 - Read OldNFS flag
12968	.fa11						getLibFS:
12969	.fa11		ad 02 df	lda $df02	                lda hazel.libFS      ;OSARGS Y=0 A=3 - Read libfs filing system number
12970	.fa14						rtsFA14:
12971	.fa14		60		rts		                rts

12973	.fa15						fileOperation:
12974							                ; Operating on a file. Select appropriate FS first.
12975	.fa15		20 97 fa	jsr $fa97	                jsr selectFSForHandle
12976							                .endproc


12979							;-------------------------------------------------------------------------
12980							;
12981							; Call current FS's OSARGS routine, bypassing the FileSwitch stuff.
12982							;
12983	.fa18						callARGSV:                      ;fa18
12984	.fa18		6c 14 02	jmp ($0214)	                jmp (ARGSV)

12986							;-------------------------------------------------------------------------
12987							;
12988							; OSFIND [AUG p342]
12989							;
12990	.fa1b						osfindEntryPoint: .proc
12991	.fa1b		09 00		ora #$00	                ora #$00        ;A=$00 if a file is to be closed
12992	.fa1d		f0 05		beq $fa24	                beq close       ;branch taken if closing a file
12993	.fa1f		20 6e fa	jsr $fa6e	                jsr parseFileNameAndSelectFS       ;handle something other than a file close
12994	.fa22		80 03		bra $fa27	                bra callFINDV

12996	.fa24						close:
12997	.fa24		20 97 fa	jsr $fa97	                jsr selectFSForHandle
12998	.fa27						callFINDV:
12999	.fa27		6c 1c 02	jmp ($021c)	                jmp (FINDV)
13000							                .pend

13002							;-------------------------------------------------------------------------
13003							;
13004							; OSFILE [AUG p335]
13005							;
13006	.fa2a						osfileEntryPoint:               ;fa2a
13007	.fa2a		da		phx		                phx
13008	.fa2b		5a		phy		                phy
13009	.fa2c		48		pha		                pha
13010	.fa2d		86 f2		stx $f2		                stx stringInputBufferAddress+0
13011	.fa2f		84 f3		sty $f3		                sty stringInputBufferAddress+1
13012	.fa31		a0 11		ldy #$11	                ldy #size(OSFILEParameterBlock)-1
13013	.fa33						-
13014	.fa33		b1 f2		lda ($f2),y	                lda (stringInputBufferAddress),y
13015	.fa35		99 ed 02	sta $02ed,y	                sta osfileParameterBlock,y
13016	.fa38		88		dey		                dey
13017	.fa39		10 f8		bpl $fa33	                bpl -
13018	.fa3b		ae ed 02	ldx $02ed	                ldx osfileParameterBlock+OSFILEParameterBlock.fileName+0
13019	.fa3e		ac ee 02	ldy $02ee	                ldy osfileParameterBlock+OSFILEParameterBlock.fileName+1
13020	.fa41		20 6e fa	jsr $fa6e	                jsr parseFileNameAndSelectFS
13021	.fa44		8e ed 02	stx $02ed	                stx osfileParameterBlock+OSFILEParameterBlock.fileName+0
13022	.fa47		8c ee 02	sty $02ee	                sty osfileParameterBlock+OSFILEParameterBlock.fileName+1
13023	.fa4a		68		pla		                pla
13024	.fa4b		a2 ed		ldx #$ed	                ldx #<osfileParameterBlock
13025	.fa4d		a0 02		ldy #$02	                ldy #>osfileParameterBlock
13026	.fa4f		20 6b fa	jsr $fa6b	                jsr callFILEV
13027	.fa52		7a		ply		                ply
13028	.fa53		84 f3		sty $f3		                sty stringInputBufferAddress+1
13029	.fa55		fa		plx		                plx
13030	.fa56		86 f2		stx $f2		                stx stringInputBufferAddress+0
13031	.fa58		48		pha		                pha
13032	.fa59		a0 11		ldy #$11	                ldy #size(OSFILEParameterBlock)-1
13033	.fa5b						-
13034	.fa5b		b9 ed 02	lda $02ed,y	                lda osfileParameterBlock,y
13035	.fa5e		91 f2		sta ($f2),y	                sta (stringInputBufferAddress),y
13036	.fa60		88		dey		                dey
13037	.fa61		c0 02		cpy #$02	                cpy #$02                     ;don't overwrite file name
13038	.fa63		b0 f6		bcs $fa5b	                bcs -
13039	.fa65		68		pla		                pla
13040	.fa66		a6 f2		ldx $f2		                ldx stringInputBufferAddress+0
13041	.fa68		a4 f3		ldy $f3		                ldy stringInputBufferAddress+1
13042	.fa6a		60		rts		                rts

13044	.fa6b						callFILEV:
13045	.fa6b		6c 12 02	jmp ($0212)	                jmp (FILEV)

13047							;-------------------------------------------------------------------------
13048							;
13049							; Parse file name. Handle (and skip) any -FS- tempfs syntax, selecting
13050							; the FS specified if required.
13051							;
13052							; entry:
13053							;
13054							; Y (MSB)/X (LSB) = address of file name string
13055							;
13056							; exit:
13057							;
13058							; Y (MSB)/X (LSB) = address of file name part
13059							;
13060							; - New FS may have been selected
13061							;
13062	.fa6e						parseFileNameAndSelectFS:
13063	.fa6e		48		pha		                pha
13064	.fa6f		a5 f2		lda $f2		                lda stringInputBufferAddress+0
13065	.fa71		48		pha		                pha
13066	.fa72		a5 f3		lda $f3		                lda stringInputBufferAddress+1
13067	.fa74		48		pha		                pha
13068	.fa75		20 ba ed	jsr $edba	                jsr selectHAZEL
13069	.fa78		86 f2		stx $f2		                stx stringInputBufferAddress+0
13070	.fa7a		84 f3		sty $f3		                sty stringInputBufferAddress+1
13071	.fa7c		a0 00		ldy #$00	                ldy #$00
13072	.fa7e		20 a6 fa	jsr $faa6	                jsr parseFileNameFS      ;find -FS- prefix, if any
13073	.fa81		5a		phy		                phy                      ;save offset
13074	.fa82		20 4d fb	jsr $fb4d	                jsr selectFS                 ;select desired FS
13075	.fa85		68		pla		                pla
13076	.fa86		18		clc		                clc
13077	.fa87		65 f2		adc $f2		                adc stringInputBufferAddress+0
13078	.fa89		aa		tax		                tax                          ;save string address LSB
13079	.fa8a		a4 f3		ldy $f3		                ldy stringInputBufferAddress+1
13080	.fa8c		90 01		bcc $fa8f	                bcc +
13081	.fa8e		c8		iny		                iny
13082	.fa8f						+
13083	.fa8f		68		pla		                pla
13084	.fa90		85 f3		sta $f3		                sta stringInputBufferAddress+1
13085	.fa92		68		pla		                pla
13086	.fa93		85 f2		sta $f2		                sta stringInputBufferAddress+0
13087	.fa95		68		pla		                pla
13088	.fa96		60		rts		                rts

13090							;-------------------------------------------------------------------------
13091							;
13092							; Select appropriate FS for the given file handle.
13093							;
13094							; entry:
13095							;
13096							; Y = file handle
13097							;
13098							; exit:
13099							;
13100							; - appropriate FS selected
13101							;
13102							; preserves: Y/X/A

13104	.fa97						selectFSForHandle:
13105	.fa97		da		phx		                phx
13106	.fa98		48		pha		                pha
13107	.fa99		20 ba ed	jsr $edba	                jsr selectHAZEL
13108	.fa9c		20 23 fb	jsr $fb23	                jsr findFSForHandle
13109	.fa9f		8a		txa		                txa
13110	.faa0		20 4d fb	jsr $fb4d	                jsr selectFS
13111	.faa3		68		pla		                pla
13112	.faa4		fa		plx		                plx
13113	.faa5		60		rts		                rts

13115							;-------------------------------------------------------------------------
13116							;
13117							; Parse the FS part of a file name, if any, and return the filing
13118							; system to use.
13119							;
13120							; Entry:
13121							;
13122							; (stringInputBufferAddress),y = the string
13123							;
13124							; Exit:
13125							;
13126							; A = FS number to use
13127							;
13128							; (stringInputBufferAddress),y = next char after any tempfs prefix has
13129							; been consumed
13130	.faa6						parseFileNameFS: .proc

13132	.faa6		4e c6 df	lsr $dfc6	                lsr hazel.tempFSFlag
13133	.faa9		20 ff f2	jsr $f2ff	                jsr skipSpacesAndCheckForCRInStringInput
13134	.faac		b1 f2		lda ($f2),y	                lda (stringInputBufferAddress),y
13135	.faae		c9 2d		cmp #$2d	                cmp #'-'
13136	.fab0		f0 0c		beq $fabe	                beq parseFSNamePrefix ; branch taken if tempfs syntax
13137	.fab2		2c c6 df	bit $dfc6	                bit hazel.tempFSFlag
13138	.fab5		ad 00 df	lda $df00	                lda hazel.currentFS
13139	.fab8		50 03		bvc $fabd	                bvc +
13140	.faba		ad 01 df	lda $df01	                lda hazel.activeFS
13141	.fabd						+
13142	.fabd		60		rts		                rts

13144	.fabe						parseFSNamePrefix:
13145	.fabe		c8		iny		                iny
13146	.fabf		a2 00		ldx #$00	                ldx #$00
13147	.fac1						LFAC1:
13148	.fac1		bd 06 df	lda $df06,x	                lda hazel.fsInfoBlocks,x ;get FS name char
13149	.fac4		f0 44		beq $fb0a	                beq badFilingSystemName
13150	.fac6		8a		txa		                txa                      ;A=offset in info blocks
13151	.fac7		18		clc		                clc
13152	.fac8		69 08		adc #$08	                adc #size(fsInfoBlock.name)
13153	.faca		85 b0		sta $b0		                sta parseFileNameFSWorkspace.fsInfoOffset
13154	.facc		5a		phy		                phy
13155	.facd						compareFSNameLoop:
13156	.facd		b1 f2		lda ($f2),y	                lda (stringInputBufferAddress),y

13158							; validate FS name char. Must be letter or digit.

13160	.facf		20 71 ea	jsr $ea71	                jsr isLetter
13161	.fad2		90 08		bcc $fadc	                bcc validFSNameChar           ;branch taken if letter
13162	.fad4		c9 30		cmp #$30	                cmp #'0'
13163	.fad6		90 1b		bcc $faf3	                bcc notValidFSNameChar       ;branch taken if not digit
13164	.fad8		c9 3a		cmp #$3a	                cmp #'9'+1
13165	.fada		b0 17		bcs $faf3	                bcs notValidFSNameChar       ;branch taken if not digit
13166	.fadc						validFSNameChar:
13167	.fadc		e4 b0		cpx $b0		                cpx parseFileNameFSWorkspace.fsInfoOffset
13168	.fade		b0 0b		bcs $faeb	                bcs nextFSInfoBlock ;branch taken if end of FS
13169							                                         ;info block name was reached
13170	.fae0		5d 06 df	eor $df06,x	                eor hazel.fsInfoBlocks,x
13171	.fae3		29 df		and #$df	                and #$DF                 ;Z=1 if char matches FS name
13172	.fae5		d0 04		bne $faeb	                bne nextFSInfoBlock      ;branch taken if not a match
13173	.fae7		e8		inx		                inx                      ;next fs info block byte
13174	.fae8		c8		iny		                iny                      ;next input string byte
13175	.fae9		80 e2		bra $facd	                bra compareFSNameLoop

13177	.faeb						nextFSInfoBlock:
13178	.faeb		7a		ply		                ply
13179	.faec		a6 b0		ldx $b0		                ldx parseFileNameFSWorkspace.fsInfoOffset ;offset of end of name
13180	.faee		e8		inx		                inx
13181	.faef		e8		inx		                inx
13182	.faf0		e8		inx		                inx             ;advance to next entry
13183	.faf1		80 ce		bra $fac1	                bra LFAC1

13185	.faf3						notValidFSNameChar:

13187							; Matching FS name must be terminated with -. Otherwise, it's bad
13188							; syntax, or perhaps an overly long name.

13190	.faf3		c9 2d		cmp #$2d	                cmp #'-'
13191	.faf5		d0 13		bne $fb0a	                bne badFilingSystemName
13192	.faf7		c8		iny		                iny                       ;consume input '-'
13193	.faf8		e4 b0		cpx $b0		                cpx parseFileNameFSWorkspace.fsInfoOffset
13194	.fafa		f0 07		beq $fb03	                beq foundFSInfoBlock     ;branch taken if a match due
13195							                                         ;to being right at end of the
13196							                                         ;FS info block name
13197	.fafc		bd 06 df	lda $df06,x	                lda hazel.fsInfoBlocks,x ;
13198	.faff		c9 20		cmp #$20	                cmp #' '
13199	.fb01		d0 e8		bne $faeb	                bne nextFSInfoBlock      ;branch taken if not a match
13200							                                         ;as tthe supplied name was a
13201							                                         ;prefix of this FS's name
13202	.fb03						foundFSInfoBlock:
13203	.fb03		68		pla		                pla
13204	.fb04		a6 b0		ldx $b0		                ldx parseFileNameFSWorkspace.fsInfoOffset
13205	.fb06		bd 08 df	lda $df08,x	                lda hazel.fsInfoBlocks+(fsInfoBlock.fsNumber-(fsInfoBlock.name+size(fsInfoBlock.name))),x
13206	.fb09		60		rts		                rts

13208	.fb0a						badFilingSystemName:
13209	.fb0a		00		brk #		                brk
13210	>fb0b		f8 42 61 64 20 66 69 6c		                .text $f8,'Bad filing system name',0
	>fb13		69 6e 67 20 73 79 73 74 65 6d 20 6e 61 6d 65 00
13211							                .pend

13213							;-------------------------------------------------------------------------
13214							;
13215							; Find FS for the given handle
13216							;
13217							; entry:
13218							;
13219							; Y = file handle
13220							;
13221							; exit:
13222							;
13223							; X = FS number - will just use current FS if none suitable found
13224							;
13225	.fb23						findFSForHandle: .proc
13226	.fb23		48		pha		                pha                          ;
13227	.fb24		5a		phy		                phy                          ;
13228	.fb25		98		tya		                tya                          ;A = handle to search for
13229	.fb26		a0 00		ldy #$00	                ldy #$00                     ;
13230	.fb28						loop:
13231	.fb28		be 06 df	ldx $df06,y	                ldx hazel.fsInfoBlocks.name+0,y
13232	.fb2b		f0 15		beq $fb42	                beq notFound                  ;taken if terminating entry
13233	.fb2d		d9 0e df	cmp $df0e,y	                cmp hazel.fsInfoBlocks.minHandle,y
13234	.fb30		90 07		bcc $fb39	                bcc next                     ;taken if not this FS
13235	.fb32		d9 0f df	cmp $df0f,y	                cmp hazel.fsInfoBlocks.maxHandle,y
13236	.fb35		90 10		bcc $fb47	                bcc found                    ;taken if this FS
13237	.fb37		f0 0e		beq $fb47	                beq found                    ;taken if this FS

13239	.fb39						next:
13240	.fb39		48		pha		                pha
13241	.fb3a		98		tya		                tya
13242	.fb3b		18		clc		                clc
13243	.fb3c		69 0b		adc #$0b	                adc #size(fsInfoBlock)
13244	.fb3e		a8		tay		                tay
13245	.fb3f		68		pla		                pla
13246	.fb40		80 e6		bra $fb28	                bra loop

13248	.fb42						notFound:
13249	.fb42		ae 00 df	ldx $df00	                ldx hazel.currentFS
13250	.fb45		80 03		bra $fb4a	                bra done

13252	.fb47						found:
13253	.fb47		be 10 df	ldx $df10,y	                ldx hazel.fsInfoBlocks.fsNumber,y
13254	.fb4a						done:
13255	.fb4a		7a		ply		                ply
13256	.fb4b		68		pla		                pla
13257	.fb4c		60		rts		                rts
13258							                .endproc

13260							;-------------------------------------------------------------------------
13261							;
13262							; Select filing system in A.
13263							;
13264							; Entry:
13265							;
13266							; A = FS number
13267							;
13268	.fb4d						selectFS:                               ;fb4d
13269	.fb4d		cd 01 df	cmp $df01	                cmp hazel.activeFS      ; Check active fs
13270	.fb50		f0 16		beq $fb68	                beq rtsFB68               ; Already active fs, return
13271	.fb52		5a		phy		                phy
13272	.fb53		da		phx		                phx
13273	.fb54		a8		tay		                tay
13274	.fb55		3a		dec a		                dec a
13275	.fb56		d0 07		bne $fb5f	                bne LFB5F       ;taken if not FS 1 (tape)

13277							; ??? - only if trying to select tape FS

13279	.fb58		a9 04		lda #$04	                lda #$04
13280	.fb5a		24 e2		bit $e2		                bit $E2
13281	.fb5c		d0 01		bne $fb5f	                bne LFB5F
13282	.fb5e		c8		iny		                iny
13283	.fb5f						LFB5F:
13284	.fb5f		5a		phy		                phy
13285	.fb60		a2 12		ldx #$12	                ldx #romServiceCallInitialiseFilingSystem
13286	.fb62		20 72 ee	jsr $ee72	                jsr makeROMServiceCall
13287	.fb65		68		pla		                pla
13288	.fb66		fa		plx		                plx
13289	.fb67		7a		ply		                ply
13290	.fb68						rtsFB68:
13291	.fb68		60		rts		                rts

13293							;-------------------------------------------------------------------------
13294							;
13295							; FileSwitch FSC
13296							; ==============
13297							;
13298	.fb69						fileswitchFSCEntryPoint:
13299	.fb69		48		pha		                pha                          ;save request type
13300	.fb6a		20 ba ed	jsr $edba	                jsr selectHAZEL
13301	.fb6d		4e c6 df	lsr $dfc6	                lsr hazel.tempFSFlag
13302	.fb70		68		pla		                pla                          ;restore request type
13303	.fb71		48		pha		                pha                          ;save request type
13304	.fb72		da		phx		                phx                          ;save request X
13305	.fb73		0a		asl a		                asl a
13306	.fb74		aa		tax		                tax
13307	.fb75		c9 17		cmp #$17	                cmp #11*2+1
13308	.fb77		b0 03		bcs $fb7c	                bcs fileswitchPassFSCToCurrentFS ;taken if out of range
13309	.fb79		7c 81 fb	jmp ($fb81,x)	                jmp (fileswitchFSCRoutinesTable,x)

13311							;-------------------------------------------------------------------------
13312							;
13313							; Pass to filing system's FSC
13314							;
13315							; There's 2 entry points - fileswitchPassFSCToCurrentFS, for
13316							; when X and A are both on the stack, and
13317							; fileswitchPassFSCToCurrentFS_X, for when only A is on the
13318							; stack.
13319							;
13320	.fb7c						fileswitchPassFSCToCurrentFS:
13321	.fb7c						fileswitchFSCNewFS:
13322	.fb7c						fileswitchFSCFileHandleRange:
13323	.fb7c						fileswitchFSCStarCommand:
13324	.fb7c		fa		plx		                plx                          ;restore request X
13325	.fb7d						fileswitchPassFSCToCurrentFS_X:
13326	.fb7d		68		pla		                pla                          ;restore request type
13327	.fb7e		6c da df	jmp ($dfda)	                jmp (hazel.activeFSCV) ;call active FS's real FSCV entry point

13329							;-------------------------------------------------------------------------
13330							;
13331							; FileSwitch FSC table
13332							;
13333	.fb81						fileswitchFSCRoutinesTable:
13334	>fb81		a6 fb				                .word fileswitchFSCOPT
13335	>fb83		9f fb				                .word fileswitchFSCCheckEOF
13336	>fb85		b3 fb				                .word fileswitchFSCStarSlash
13337	>fb87		99 fb				                .word fileswitchFSCUnknownCommand
13338	>fb89		b3 fb				                .word fileswitchFSCStarRUN
13339	>fb8b		b8 fb				                .word fileswitchFSCStarCAT
13340	>fb8d		7c fb				                .word fileswitchFSCNewFS
13341	>fb8f		7c fb				                .word fileswitchFSCFileHandleRange
13342	>fb91		7c fb				                .word fileswitchFSCStarCommand
13343	>fb93		b8 fb				                .word fileswitchFSCStarEX
13344	>fb95		b8 fb				                .word fileswitchFSCStarINFO
13345	>fb97		e8 fb				                .word fileswitchFSCRUNLibrary

13347							;-------------------------------------------------------------------------
13348							;
13349							; FSC 3 - *command [AUG p344]
13350							;
13351	.fb99						fileswitchFSCUnknownCommand:
13352	.fb99		fa		plx		                plx
13353	.fb9a		20 c1 fb	jsr $fbc1	                jsr getCommandLinePointer
13354	.fb9d		80 de		bra $fb7d	                bra fileswitchPassFSCToCurrentFS_X

13356							;-------------------------------------------------------------------------
13357							;
13358							; FSC 1 - check EOF [AUG p343]
13359							;
13360	.fb9f						fileswitchFSCCheckEOF:
13361	.fb9f		7a		ply		                ply                         ;Y = file handle
13362	.fba0		5a		phy		                phy                         ;restore stack arrangement
13363	.fba1		20 97 fa	jsr $fa97	                jsr selectFSForHandle
13364	.fba4		80 d6		bra $fb7c	                bra fileswitchPassFSCToCurrentFS

13366							;-------------------------------------------------------------------------
13367							;
13368							; FSC 0 - *OPT [AUG p343]
13369							;
13370	.fba6						fileswitchFSCOPT:
13371	.fba6		2c c6 df	bit $dfc6	                bit hazel.tempFSFlag   ; Check temporary fs flag
13372	.fba9		70 d1		bvs $fb7c	                bvs fileswitchPassFSCToCurrentFS
13373	.fbab		ad 00 df	lda $df00	                lda hazel.currentFS ; Get current filing system number

13375							;-------------------------------------------------------------------------
13376							;
13377							; Pass FSCV request through to a particular FS.
13378							;
13379							; entry:
13380							;
13381							; A = FS to select
13382							;
13383							; Y = FSCV Y
13384							;
13385							; S = [FSCV X; FSCV A]
13386							;
13387	.fbae						fileswitchPassFSCToSpecificFS:
13388	.fbae		20 4d fb	jsr $fb4d	                jsr selectFS        ; Select filing system
13389	.fbb1		80 c9		bra $fb7c	                bra fileswitchPassFSCToCurrentFS

13391							;-------------------------------------------------------------------------
13392							;
13393							; FSC 2 - */filename [AUG p343]
13394							; FSC 4 - *RUN filename [AUG p344]
13395							;
13396	.fbb3						fileswitchFSCStarSlash:
13397	.fbb3						fileswitchFSCStarRUN:
13398	.fbb3		fa		plx		                plx
13399	.fbb4		20 c1 fb	jsr $fbc1	                jsr getCommandLinePointer ; Skip '*'s and spaces, set command line address
13400	.fbb7		da		phx		                phx             ; Continue on to pass to filing system


13403							;-------------------------------------------------------------------------
13404							;
13405							; FSC 5 - *CAT [AUG p344]
13406							; FSC 9 - *EX [NAUG p257]
13407							; FSC, 10 - *INFO [NAUG p257]
13408							;
13409	.fbb8						fileswitchFSCStarCAT:
13410	.fbb8						fileswitchFSCStarEX:
13411	.fbb8						fileswitchFSCStarINFO:
13412	.fbb8		fa		plx		                plx
13413	.fbb9		0e c6 df	asl $dfc6	                asl hazel.tempFSFlag
13414	.fbbc		20 6e fa	jsr $fa6e	                jsr parseFileNameAndSelectFS
13415	.fbbf		80 bc		bra $fb7d	                bra fileswitchPassFSCToCurrentFS_X

13417							;-------------------------------------------------------------------------
13418							;
13419							; Get command line pointer.
13420							;
13421							; Entry:
13422							;
13423							; X/Y - pointer to CR-terminated command line string
13424							;
13425							; Exit:
13426							;
13427							; X/Y, (hazel.commandLinePointer) - pointer to first non-space char in
13428							; command line string
13429	.fbc1						getCommandLinePointer: .proc ;fbc1
13430	.fbc1		86 f2		stx $f2		                stx stringInputBufferAddress+0
13431	.fbc3		84 f3		sty $f3		                sty stringInputBufferAddress+1

13433							; skip spaces. Stop if terminating CR encountered.

13435	.fbc5		a0 ff		ldy #$ff	                ldy #$FF
13436	.fbc7						-
13437	.fbc7		c8		iny		                iny
13438	.fbc8		b1 f2		lda ($f2),y	                lda (stringInputBufferAddress),y
13439	.fbca		c9 0d		cmp #$0d	                cmp #$0D
13440	.fbcc		f0 04		beq $fbd2	                beq +
13441	.fbce		c9 20		cmp #$20	                cmp #' '
13442	.fbd0		d0 f5		bne $fbc7	                bne -

13444	.fbd2						+

13446							; Hmm. Didn't we just do this bit already?

13448	.fbd2		20 ff f2	jsr $f2ff	                jsr skipSpacesAndCheckForCRInStringInput

13450							; Store address of first non-space char in the HAZEL command line
13451							; pointer.

13453	.fbd5		98		tya		                tya
13454	.fbd6		18		clc		                clc
13455	.fbd7		65 f2		adc $f2		                adc stringInputBufferAddress+0
13456	.fbd9		8d 04 df	sta $df04	                sta hazel.commandLinePointer+0
13457	.fbdc		a5 f3		lda $f3		                lda stringInputBufferAddress+1
13458	.fbde		69 00		adc #$00	                adc #$00
13459	.fbe0		8d 05 df	sta $df05	                sta hazel.commandLinePointer+1
13460	.fbe3		a4 f3		ldy $f3		                ldy stringInputBufferAddress+1
13461	.fbe5		a6 f2		ldx $f2		                ldx stringInputBufferAddress+0
13462	.fbe7		60		rts		                rts
13463							                .pend

13465							;-------------------------------------------------------------------------
13466							;
13467							; FSC 11 - RUN from libfs [NAUG p257]
13468							;
13469	.fbe8						fileswitchFSCRUNLibrary:
13470	.fbe8		ad 02 df	lda $df02	                lda hazel.libFS      ; Is a libfs set?
13471	.fbeb		10 c1		bpl $fbae	                bpl fileswitchPassFSCToSpecificFS
13472	.fbed						badCommandError:
13473	.fbed		00		brk #		                brk
13474	>fbee		fe				                .byte 254
13475	>fbef		42 61 64 20 63 6f 6d 6d		                .text "Bad command"
	>fbf7		61 6e 64
13476	.fbfa		00		brk #		                brk

13478							;-------------------------------------------------------------------------

13480							                .if version==350
13708							                .endif


13711							;-------------------------------------------------------------------------

13713	>fbfb		ff ff ff ff ff			                .fill $fc00-*,$ff

13715							                .if version==350
13744							                .else

13746							;-------------------------------------------------------------------------
13747							;
13748							; Credits - normally hidden by the I/O region.
13749							;

13751							                .if version<500
13752	>fc00		28 43 29 20 31 39 38 34		                .text "(C) 1984 Acorn Computers Ltd."
	>fc08		20 41 63 6f 72 6e 20 43 6f 6d 70 75 74 65 72 73
	>fc18		20 4c 74 64 2e
13753	>fc1d		54 68 61 6e 6b 73 20 61		                .text "Thanks are due to the following contributors to the BBC Computer (among others too numerous to mention):- "
	>fc25		72 65 20 64 75 65 20 74 6f 20 74 68 65 20 66 6f
	>fc35		6c 6c 6f 77 69 6e 67 20 63 6f 6e 74 72 69 62 75
	>fc45		74 6f 72 73 20 74 6f 20 74 68 65 20 42 42 43 20
	>fc55		43 6f 6d 70 75 74 65 72 20 28 61 6d 6f 6e 67 20
	>fc65		6f 74 68 65 72 73 20 74 6f 6f 20 6e 75 6d 65 72
	>fc75		6f 75 73 20 74 6f 20 6d 65 6e 74 69 6f 6e 29 3a
	>fc85		2d 20
13761							                .endif
13762	>fc87		44 61 76 69 64 20 41 6c		                .text "David Allen,"
	>fc8f		6c 65 6e 2c
13763							                .if version<500
13764	>fc93		43 6c 69 76 65 20 41 6e		                .text "Clive Angel,"
	>fc9b		67 65 6c 2c
13765							                .endif
13766	>fc9f		44 61 76 69 64 20 42 65		                .text "David Bell,"
	>fca7		6c 6c 2c
13767	>fcaa		50 61 75 6c 20 42 6f 6e		                .text "Paul Bond,"
	>fcb2		64 2c
13768							                .if version<500
13769	>fcb4		41 6c 6c 65 6e 20 42 6f		                .text "Allen Boothroyd,"
	>fcbc		6f 74 68 72 6f 79 64 2c
13770							                .endif
13771	>fcc4		4a 75 6c 69 61 6e 20 42		                .text "Julian Brown,"
	>fccc		72 6f 77 6e 2c
13772	>fcd1		54 75 64 6f 72 20 42 72		                .text "Tudor Brown,"
	>fcd9		6f 77 6e 2c
13773							                .if version>=500
13775							                .endif
13776	>fcdd		42 72 69 61 6e 20 43 6f		                .text "Brian Cockburn,"
	>fce5		63 6b 62 75 72 6e 2c
13777							                .if version>=500
13779							                .endif
13780							                .if version<500
13781	>fcec		50 65 74 65 20 43 6f 63		                .text "Pete Cockerell,"
	>fcf4		6b 65 72 65 6c 6c 2c
13782							                .endif
13783	>fcfb		4d 61 72 6b 20 43 6f 6c		                .text "Mark Colton,"
	>fd03		74 6f 6e 2c
13784	>fd07		43 68 72 69 73 20 43 75		                .text "Chris Curry,"
	>fd0f		72 72 79 2c
13785							                .if version>=500
13788							                .endif
13789	>fd13		4a 6f 65 20 44 75 6e 6e		                .text "Joe Dunn,"
	>fd1b		2c
13790							                .if version==400
13792							                .endif
13793							                .if version<500
13794	>fd1c		50 61 75 6c 20 46 72 65		                .text "Paul Freakley,"
	>fd24		61 6b 6c 65 79 2c
13795							                .endif
13796							                .if version>=500
13799							                .endif
13800	>fd2a		53 74 65 76 65 20 46 75		                .text "Steve Furber,"
	>fd32		72 62 65 72 2c
13801	>fd37		4d 61 72 74 79 6e 20 47		                .text "Martyn Gilbert,"
	>fd3f		69 6c 62 65 72 74 2c
13802	>fd46		4a 6f 68 6e 20 48 61 72		                .text "John Harrison,"
	>fd4e		72 69 73 6f 6e 2c
13803	>fd54		48 65 72 6d 61 6e 6e 20		                .text "Hermann Hauser,"
	>fd5c		48 61 75 73 65 72 2c
13804							                .if version!=400
13805	>fd63		4d 69 6b 65 20 48 69 6c		                .text "Mike Hill,"
	>fd6b		6c 2c
13806							                .endif
13807							                .if version>=500
13809							                .endif
13810	>fd6d		4a 6f 68 6e 20 48 6f 72		                .text "John Horton,"
	>fd75		74 6f 6e 2c
13811							                .if version==400
13813							                .endif
13814							                .if version>=500
13816							                .endif
13817							                .if version<500
13818	>fd79		4e 65 69 6c 20 4a 6f 68		                .text "Neil Johnson,"
	>fd81		6e 73 6f 6e 2c
13819							                .endif
13820	>fd86		52 69 63 68 61 72 64 20		                .text "Richard King,"
	>fd8e		4b 69 6e 67 2c
13821	>fd93		44 61 76 69 64 20 4b 69		                .text "David Kitson,"
	>fd9b		74 73 6f 6e 2c
13822							                .if version>=500
13824							                .endif
13825	>fda0		4a 75 6c 69 61 6e 20 4c		                .text "Julian Lomberg,"
	>fda8		6f 6d 62 65 72 67 2c
13826	>fdaf		52 6f 62 20 4d 61 63 6d		                .text "Rob Macmillan,"
	>fdb7		69 6c 6c 61 6e 2c
13827							                .if version>=500
13829							                .endif
13830	>fdbd		52 69 63 68 61 72 64 20		                .text "Richard Manby,"
	>fdc5		4d 61 6e 62 79 2c
13831							                .if version<500
13832	>fdcb		50 65 74 65 72 20 4d 63		                .text "Peter McKenna,"
	>fdd3		4b 65 6e 6e 61 2c
13833	>fdd9		41 6e 64 72 65 77 20 4d		                .text "Andrew McKernan,"
	>fde1		63 4b 65 72 6e 61 6e 2c
13834							                .if version==400
13836							                .else
13837	>fde9		4d 69 63 6b 20 4e 65 69		                .text "Mick Neil,"
	>fdf1		6c 2c
13838							                .endif
13839	>fdf3		49 61 6e 20 4e 69 62 6c		                .text "Ian Niblock,"
	>fdfb		6f 63 6b 2c
13840							                .endif
13841							                .if version>=500
13844							                .endif
13845	>fdff		47 6c 65 6e 20 4e 69 63		                .text "Glen Nicholls,"
	>fe07		68 6f 6c 6c 73 2c
13846	>fe0d		52 6f 62 65 72 74 20 4e		                .text "Robert Nokes,"
	>fe15		6f 6b 65 73 2c
13847							                .if version>=500
13849							                .endif
13850	>fe1a		52 69 63 68 61 72 64 20		                .text "Richard Page,"
	>fe22		50 61 67 65 2c
13851							                .if version<400
13852	>fe27		53 74 65 76 65 20 50 61		                .text "Steve Parsons,"
	>fe2f		72 73 6f 6e 73 2c
13853							                .endif
13854							                .if version<=400
13855	>fe35		45 64 20 50 68 69 70 70		                .text "Ed Phipps,"
	>fe3d		73 2c
13856							                .endif
13857	>fe3f		4a 6f 68 6e 20 52 61 64		                .text "John Radcliffe,"
	>fe47		63 6c 69 66 66 65 2c
13858	>fe4e		52 69 63 6b 20 52 61 6e		                .text "Rick Rand,"
	>fe56		64 2c
13859							                .if version>=400
13861							                .endif
13862	>fe58		42 72 69 61 6e 20 52 6f		                .text "Brian Robertson,"
	>fe60		62 65 72 74 73 6f 6e 2c
13863							                .if version>=500
13865							                .endif
13866	>fe68		52 69 63 68 61 72 64 20		                .text "Richard Russell,"
	>fe70		52 75 73 73 65 6c 6c 2c
13867							                .if version<500
13868	>fe78		47 6f 72 64 6f 6e 20 53		                .text "Gordon Sage,"
	>fe80		61 67 65 2c
13869	>fe84		54 65 72 72 79 20 53 63		                .text "Terry Scotcher,"
	>fe8c		6f 74 63 68 65 72 2c
13870							                .endif
13871							                .if version>=500
13874							                .endif
13875	>fe93		44 61 76 69 64 20 53 65		                .text "David Seal,"
	>fe9b		61 6c 2c
13876							                .if version>=500
13879							                .endif
13880							                .if version!=400
13881	>fe9e		50 61 75 6c 20 53 77 69		                .text "Paul Swindell,"
	>fea6		6e 64 65 6c 6c 2c
13882							                .endif
13883	>feac		4a 6f 6e 20 54 68 61 63		                .text "Jon Thackray,"
	>feb4		6b 72 61 79 2c
13884							                .if version>=500
13886							                .endif
13887	>feb9		48 75 67 6f 20 54 79 73		                .text "Hugo Tyson,"
	>fec1		6f 6e 2c
13888							                .if version<500
13889	>fec4		41 64 72 69 61 6e 20 57		                .text "Adrian Warner,"
	>fecc		61 72 6e 65 72 2c
13890							                .if version==400
13892							                .else
13893	>fed2		4a 65 73 73 20 57 69 6c		                .text "Jess Wills,"
	>feda		6c 73 2c
13894							                .endif
13895							                .endif
13896							                .if version<500
13897	>fedd		52 6f 67 65 72 20 57 69		                .text "Roger Wilson,"
	>fee5		6c 73 6f 6e 2c
13898	>feea		47 72 61 68 61 6d 20 57		                .text "Graham Winterflood."
	>fef2		69 6e 74 65 72 66 6c 6f 6f 64 2e
13899							                ;.text "   "
13900							                .endif
13901							                .if version>=500
13903							                .endif
13904							                .if version!=400
13905							                .if olivetti
13907							                .else
13908	>fefd		20 20 20			                .align 256,' '
13909							                .endif
13912							                .endif

13914							;-------------------------------------------------------------------------

13916							                .endif

13918							;-------------------------------------------------------------------------

13920	.ff00						E_USERV: ; ff00
13921	.ff00		20 51 ff	jsr $ff51	                jsr extendedVectorEntryPoint
13922	.ff03						E_BRKV: ; ff03
13923	.ff03		20 51 ff	jsr $ff51	                jsr extendedVectorEntryPoint
13924	.ff06						E_IRQ1V: ; ff06
13925	.ff06		20 51 ff	jsr $ff51	                jsr extendedVectorEntryPoint
13926	.ff09						E_IRQ2V: ; ff09
13927	.ff09		20 51 ff	jsr $ff51	                jsr extendedVectorEntryPoint
13928	.ff0c						E_CLIV: ; ff0c
13929	.ff0c		20 51 ff	jsr $ff51	                jsr extendedVectorEntryPoint
13930	.ff0f						E_BYTEV: ; ff0f
13931	.ff0f		20 51 ff	jsr $ff51	                jsr extendedVectorEntryPoint
13932	.ff12						E_WORDV: ; ff12
13933	.ff12		20 51 ff	jsr $ff51	                jsr extendedVectorEntryPoint
13934	.ff15						E_WRCHV: ; ff15
13935	.ff15		20 51 ff	jsr $ff51	                jsr extendedVectorEntryPoint
13936	.ff18						E_RDCHV: ; ff18
13937	.ff18		20 51 ff	jsr $ff51	                jsr extendedVectorEntryPoint
13938	.ff1b						E_FILEV: ; ff1b
13939	.ff1b		20 51 ff	jsr $ff51	                jsr extendedVectorEntryPoint
13940	.ff1e						E_ARGSV: ; ff1e
13941	.ff1e		20 51 ff	jsr $ff51	                jsr extendedVectorEntryPoint
13942	.ff21						E_BGETV: ; ff21
13943	.ff21		20 51 ff	jsr $ff51	                jsr extendedVectorEntryPoint
13944	.ff24						E_BPUTV: ; ff24
13945	.ff24		20 51 ff	jsr $ff51	                jsr extendedVectorEntryPoint
13946	.ff27						E_GBPBV: ; ff27
13947	.ff27		20 51 ff	jsr $ff51	                jsr extendedVectorEntryPoint
13948	.ff2a						E_FINDV: ; ff2a
13949	.ff2a		20 51 ff	jsr $ff51	                jsr extendedVectorEntryPoint
13950	.ff2d						E_FSCV: ; ff2d
13951	.ff2d		20 51 ff	jsr $ff51	                jsr extendedVectorEntryPoint
13952	.ff30						E_EVENTV: ; ff30
13953	.ff30		20 51 ff	jsr $ff51	                jsr extendedVectorEntryPoint
13954	.ff33						E_UPTV: ; ff33
13955	.ff33		20 51 ff	jsr $ff51	                jsr extendedVectorEntryPoint
13956	.ff36						E_NETV: ; ff36
13957	.ff36		20 51 ff	jsr $ff51	                jsr extendedVectorEntryPoint
13958	.ff39						E_VDUV: ; ff39
13959	.ff39		20 51 ff	jsr $ff51	                jsr extendedVectorEntryPoint
13960	.ff3c						E_KEYV: ; ff3c
13961	.ff3c		20 51 ff	jsr $ff51	                jsr extendedVectorEntryPoint
13962	.ff3f						E_INSV: ; ff3f
13963	.ff3f		20 51 ff	jsr $ff51	                jsr extendedVectorEntryPoint
13964	.ff42						E_REMV: ; ff42
13965	.ff42		20 51 ff	jsr $ff51	                jsr extendedVectorEntryPoint
13966	.ff45						E_CNPV: ; ff45
13967	.ff45		20 51 ff	jsr $ff51	                jsr extendedVectorEntryPoint
13968	.ff48						E_IND1V: ; ff48
13969	.ff48		20 51 ff	jsr $ff51	                jsr extendedVectorEntryPoint
13970	.ff4b						E_IND2V: ; ff4b
13971	.ff4b		20 51 ff	jsr $ff51	                jsr extendedVectorEntryPoint
13972	.ff4e						E_IND3V: ; ff4e
13973	.ff4e		20 51 ff	jsr $ff51	                jsr extendedVectorEntryPoint

13975							;-------------------------------------------------------------------------

13977	.ff51						extendedVectorEntryPoint:
13978							                ; .if CFA3000
13979							                ; ;...
13980							                ; .else
13981							                ; $10b,x = rL
13982	.ff51		48		pha		                pha                 ; $10a,x  (old ROMSEL)
13983	.ff52		48		pha		                pha                 ; $109,x  (old ACCCON)
13984	.ff53		48		pha		                pha                 ; $108,x  (thunk rH)
13985	.ff54		48		pha		                pha                 ; $107,x  (thunk rL)
13986	.ff55		48		pha		                pha                 ; $106,x  (jump dest MSB)
13987	.ff56		48		pha		                pha                 ; $105,x  (jump dest LSB)
13988	.ff57		08		php		                php                 ; $104,x  (P for RTI)
13989	.ff58		48		pha		                pha                 ; $103,x  (old A)
13990	.ff59		da		phx		                phx                 ; $102,x  (old X)
13991	.ff5a		5a		phy		                phy                 ; $101,x  (old Y)
13992	.ff5b		ba		tsx		                tsx
13993	.ff5c		a9 ff		lda #$ff	                lda #>extendedVectorReturnThunk-1
13994	.ff5e		9d 08 01	sta $0108,x	                sta $0108,x
13995	.ff61		a9 8c		lda #$8c	                lda #<extendedVectorReturnThunk-1
13996	.ff63		9d 07 01	sta $0107,x	                sta $0107,x

13998							                ; this routine is only ever called from $ff00, $ff03,
13999							                ; $ff06, etc. - so rL holds vectorIndex*3+2, suitable
14000							                ; for indexing into the extended vector space.
14001	.ff66		bc 0b 01	ldy $010b,x	                ldy $010B,x                  ;Y=vectorIndex*3+2
14002	.ff69		b9 9d 0d	lda $0d9d,y	                lda extendedVectorSpace-2,y  ;get vector LSB
14003	.ff6c		9d 05 01	sta $0105,x	                sta $0105,x                  ;
14004	.ff6f		b9 9e 0d	lda $0d9e,y	                lda extendedVectorSpace-1,y  ;get vector MSB
14005	.ff72		9d 06 01	sta $0106,x	                sta $0106,x
14006	.ff75		a5 f4		lda $f4		                lda $F4
14007	.ff77		9d 0a 01	sta $010a,x	                sta $010A,x
14008	.ff7a		ad 34 fe	lda $fe34	                lda ACCCON
14009	.ff7d		9d 09 01	sta $0109,x	                sta $0109,x

14011							                ; New stack layout:
14012							                ;
14013							                ; $10a,x - old ROMSEL
14014							                ; $109,x - old ACCCON
14015							                ; $108,x - thunk rH
14016							                ; $107,x - thunk rL
14017							                ; $106,x - jump dest MSB
14018							                ; $105,x - jump dest LSB
14019							                ; $104,x - P (for RTI)
14020							                ; $103,x - old A
14021							                ; $102,x - old X
14022							                ; $101,x - old Y

14024	.ff80		20 ba ed	jsr $edba	                jsr mos.selectHAZEL
14025	.ff83		b9 9f 0d	lda $0d9f,y	                lda extendedVectorSpace,y    ;get vector ROM number
14026	.ff86		20 92 e5	jsr $e592	                jsr mos.selectROMA
14027	.ff89		7a		ply		                ply
14028	.ff8a		fa		plx		                plx
14029	.ff8b		68		pla		                pla
14030	.ff8c		40		rti		                rti
14031							;                .endif

14033							;-------------------------------------------------------------------------

14035	.ff8d						extendedVectorReturnThunk:
14036	.ff8d		08		php		                php
14037	.ff8e		48		pha		                pha
14038	.ff8f		da		phx		                phx
14039	.ff90		ba		tsx		                tsx
14040	.ff91		bd 02 01	lda $0102,x	                lda $0102,x
14041	.ff94		9d 06 01	sta $0106,x	                sta $0106,x
14042	.ff97		bd 03 01	lda $0103,x	                lda $0103,x
14043	.ff9a		9d 07 01	sta $0107,x	                sta $0107,x
14044	.ff9d		fa		plx		                plx
14045	.ff9e		68		pla		                pla
14046	.ff9f		68		pla		                pla
14047	.ffa0		68		pla		                pla
14048	.ffa1		20 b0 ed	jsr $edb0	                jsr mos.selectMOSOrHAZEL
14049	.ffa4		68		pla		                pla
14050	.ffa5		20 92 e5	jsr $e592	                jsr mos.selectROMA
14051	.ffa8		68		pla		                pla
14052	.ffa9		28		plp		                plp
14053	.ffaa						rtsFFAA:
14054	.ffaa		60		rts		                rts

14056							;-------------------------------------------------------------------------
14057							;
14058							; OSBYTE 150 (&96) Read from SHEILA (&FE00 â<80><93> &FEFF) [MasRef D.2-45]
14059							;
14060	.ffab						osbyte96:
14061	.ffab		bc 00 fe	ldy $fe00,x	                ldy $fe00,x
14062	.ffae		60		rts		                rts

14064							;-------------------------------------------------------------------------
14065							;
14066							; OSBYTE 157 (&9D) Write byte across Tube [MasRef D.2-48]
14067							;
14068	.ffaf						osbyte9D:
14069	.ffaf		8a		txa		                txa
14070	.ffb0		80 22		bra $ffd4	                bra OSBPUT

14072	.ffb2		00		brk #		                brk

14074							;-------------------------------------------------------------------------

14076							; MOS block ends here, so that the standard entry points have
14077							; unadorned names.
14078							;
14079							; A couple of the E_ entry points need namespacing in the Terminal
14080							; ROM.
14081							                .endblock


14084							;-------------------------------------------------------------------------
14085	.ffb3						OSWRSC:
14086	.ffb3		4c 02 f4	jmp $f402	                jmp mos.oswrscEntryPoint ; FFB3
14087	>ffb6		36				                .byte mos.defaultVectorTable.end-mos.defaultVectorTable ;
14088	>ffb7		d7 e2				                .word mos.defaultVectorTable ;
14089	.ffb9						OSRDSC:
14090	.ffb9		4c fc f3	jmp $f3fc	                jmp mos.osrdscEntryPoint ; FFB9
14091	.ffbc						VDUCHR:
14092	.ffbc		4c ec f3	jmp $f3ec	                jmp mos.vduChrEntryPoint ; FFBC
14093	.ffbf						OSEVEN:
14094	.ffbf		4c 28 ea	jmp $ea28	                jmp mos.eventEntryPoint ; FFBF
14095	.ffc2						GSINIT:
14096	.ffc2		4c 6e f2	jmp $f26e	                jmp mos.gsinitEntryPoint ; FFC2
14097	.ffc5						GSREAD:
14098	.ffc5		4c 7f f2	jmp $f27f	                jmp mos.gsreadEntryPoint ; FFC5
14099	.ffc8						NVRDCH:
14100	.ffc8		4c bc e7	jmp $e7bc	                jmp mos.osrdchEntryPoint                    ; FFC8
14101	.ffcb						NVWRCH:
14102	.ffcb		4c 22 e8	jmp $e822	                jmp mos.oswrchEntryPoint                    ; FFCB
14103	.ffce						OSFIND:
14104	.ffce		4c 1b fa	jmp $fa1b	                jmp mos.osfindEntryPoint                    ; FFCE
14105	.ffd1						OSGBPB:
14106	.ffd1		4c be f9	jmp $f9be	                jmp mos.osgbpbEntryPoint                    ; FFD1
14107	.ffd4						OSBPUT:
14108	.ffd4		4c b2 f9	jmp $f9b2	                jmp mos.osbputEntryPoint                    ; FFD4
14109	.ffd7						OSBGET:
14110	.ffd7		4c b8 f9	jmp $f9b8	                jmp mos.osbgetEntryPoint                    ; FFD7
14111	.ffda						OSARGS:
14112	.ffda		4c e7 f9	jmp $f9e7	                jmp mos.osargsEntryPoint ; FFDA
14113	.ffdd						OSFILE:
14114	.ffdd		4c 2a fa	jmp $fa2a	                jmp mos.osfileEntryPoint ; FFDD
14115	.ffe0						OSRDCH:
14116	.ffe0		6c 10 02	jmp ($0210)	                jmp (RDCHV)                  ; FFE0
14117	.ffe3						OSASCI:
14118	.ffe3		c9 0d		cmp #$0d	                cmp #$0D                     ; FFE3
14119	.ffe5		d0 07		bne $ffee	                bne OSWRCH                   ; FFE5
14120	.ffe7						OSNEWL:
14121	.ffe7		a9 0a		lda #$0a	                lda #$0A                     ; FFE7
14122	.ffe9		20 ee ff	jsr $ffee	                jsr OSWRCH                   ; FFE9
14123	.ffec		a9 0d		lda #$0d	                lda #$0D                     ; FFEC
14124	.ffee						OSWRCH:
14125	.ffee		6c 0e 02	jmp ($020e)	                jmp (WRCHV)                  ; FFEE
14126	.fff1						OSWORD:
14127	.fff1		6c 0c 02	jmp ($020c)	                jmp (WORDV)                  ; FFF1
14128	.fff4						OSBYTE:
14129	.fff4		6c 0a 02	jmp ($020a)	                jmp (BYTEV)                  ; FFF4
14130	.fff7						OSCLI:
14131	.fff7		6c 08 02	jmp ($0208)	                jmp (CLIV)                  ; FFF7

14133	.fffa						LFFFA:                                       ; FFFA NMIV
14134	>fffa		00 0d				                .word nmiEntryPoint
14135	.fffc						LFFFC:                                       ; FFFB RESETV
14136	>fffc		64 e3				                .word mos.resetEntryPoint
14137	.fffe						LFFFE:                                       ; FFFE IRQV
14138	>fffe		9e e5				                .word mos.irqEntryPoint


:1	;******  Return to file: mos320multios.s65

40							                .endsection

;******  End of listing
