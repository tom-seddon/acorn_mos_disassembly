
; 64tass Turbo Assembler Macro V1.59.3120+ listing file
; 64tass --m65c02 --nostart -Wall -q --case-sensitive --line-numbers --verbose-list -Lbuild/mos500.lst --output-section mos -o build/500/mos.rom --output-section utils -o build/500/utils.rom mos500.s65
; Wed Nov 15 00:54:53 2023

;Line	;Offset	;Hex		;Monitor	;Source

:1	;******  Processing input file: mos500.s65

1						                .include "src/hardware.s65"

:2	;******  Processing file: src/hardware.s65

1						;-------------------------------------------------------------------------

3						                .virtual $fe00

5	.fe00					CRTC: .block

7						                .virtual 8
8	.0008					R8: .block
9	=$00					normalSync=%00000000
10	=$01					interlaceSync=%00000001
11	=$02					normalSyncAlt=%00000010
12	=$03					interlaceSyncAndVideo=%00000011

14	=0					displayDelay0=0<<4
15	=16					displayDelay1=1<<4
16	=32					displayDelay2=2<<4
17	=48					displayDisable=3<<4

19	=0					cursorDelay0=0<<6
20	=64					cursorDelay1=1<<6
21	=128					cursorDelay2=2<<6
22	=192					cursorDisable=3<<6
23						                .endblock
24						                .endvirtual

26						                .virtual 10
27	.000a					R10: .block
28	=$40					blink=$40
29	=$20					slowBlink=$20
30						                .endblock
31						                .endvirtual

33						                .endblock

35						                .endvirtual

37						;-------------------------------------------------------------------------
38						; ACIA=$fe08
39	=$fe10					SERPROC=$fe10
40						;HADC=$fe18
41	=$fee0					TUBE=$fee0
42	=$fe30					ROMSEL=$fe30
43						;ACCCON=$fe34
44						                .virtual $fe20
45	.fe20					VCONTROL: .block
46	=$01					flash=$01
47	=$02					isTeletext=$02
48	=$00					shift2MHz=$00
49	=$04					shift4MHz=$04
50	=$08					shift8MHz=$08
51	=$0c					shift16MHz=$0c
52	=$00					crtc1MHz=$00
53	=$10					crtc2MHz=$10
54	=$00					cursor____=$00
55	=$20					cursor__XX=$20
56	=$40					cursor_X__=$40
57	=$60					cursor_XXX=$60
58	=$80					cursorX___=$80
59	=$a0					cursorX_XX=$a0
60	=$c0					cursorXX__=$c0
61	=$e0					cursorXXXX=$e0
62						                .endblock
63						                .endvirtual
64	=$fe21					VPALETTE=$fe21

66						;-------------------------------------------------------------------------

68						                .virtual $fe08
69	.fe08					ACIA: .block

71	.fe08					control: .block
72	=0					counterDivide1=0<<0
73	=1					counterDivide16=1<<0
74	=2					counterDivide64=2<<0
75	=3					reset=3<<0

77	=0					word7DataEventParity2Stop=0<<2
78	=4					word7DataOddParity2Stop=1<<2
79	=8					word7DataEvenParity1Stop=2<<2
80	=12					word7DataOddParity1Stop=3<<2
81	=16					word8DataNoParity2Stop=4<<2
82	=20					word8DataNoParity1Stop=5<<2
83	=24					word8DataEvenParity1Stop=6<<2
84	=28					word8DataOddParity1Stop=7<<2

86	=0					rtsLowTXInterruptDisabled=0<<5
87	=32					rtsLowTXInterruptEnabled=1<<5
88	=64					rtsHighTXInterruptDisabled=2<<5
89	=96					rtsLowBreakTXInterruptDisabled=3<<5

91	=0					rtsRXInterruptDisabled=0<<7
92	=128					rtsRTSInterruptEnabled=1<<7

94						                .endblock
95	.fe08					status: .block
96						                .endblock

98	>fe08					                .fill 1
99	.fe09					tdr:
100	.fe09					rdr:
101	>fe09					                .fill 1
102						                .endblock
103						                .endvirtual

105						;-------------------------------------------------------------------------

107						                .virtual $fe18
108	.fe18					HADC: .block
109	.fe18					status: .block
110						                .endblock
111	.fe18					latch: .block
112						                .endblock
113	>fe18					                .fill 1

115						                .endblock
116						                .endvirtual

118						;-------------------------------------------------------------------------

120						                .virtual $fe34
121	.fe34					ACCCON: .block
122						;D=1 = display shadow RAM; D=0 = display main RAM
123	=$01					D=$01

125						;E=1 = VDU code ($c000-$dfff in MOS ROM) accesses shadow RAM; E=0 =
126						;VDU code accesses main RAM
127	=$02					E=$02

129						;X=1 = shadow RAM at $3000; X=0 = main RAM at $3000
130	=$04					X=$04

132						;Y=1 = HAZEL at $c000; Y=0 = MOS ROM at $c000
133	=$08					Y=$08

135						;ITU=1 = access internal Tube; ITU=0 = access external Tube
136	=$10					ITU=$10

138						;IFJ=1 = $fc00...$fdff accesses cartridge; IFJ=0 = $fc00...$fdff
139						;accesses 1MHz bus
140	=$20					IFJ=$20

142						; TST=1 = read MOS ROM at $fc00...$feff; TST=0 = read I/O at
143						; $fc00...$feff
144	=$40					TST=$40

146						;IRR=1 = IRQ to CPU
147	=$80					IRR=$80
148						                .bend
149						                .endv

151						                VIA: .struct                    ;
152	.0000					orb:
153	.0000					irb:
154	>0000					                .fill 1         ;0
155	.0001					ora:
156	.0001					ira:
157	>0001					                .fill 1         ;1
158	.0002					ddrb:
159	>0002					                .fill 1         ;2
160	.0003					ddra:
161	>0003					                .fill 1         ;3
162	.0004					t1cL:
163	>0004					                .fill 1         ;4
164	.0005					t1cH:
165	>0005					                .fill 1         ;5
166	.0006					t1lL:
167	>0006					                .fill 1         ;6
168	.0007					t1lH:
169	>0007					                .fill 1         ;7
170	.0008					t2cL:
171	>0008					                .fill 1         ;8
172	.0009					t2cH:
173	>0009					                .fill 1         ;9
174	.000a					sr:
175	>000a					                .fill 1         ;10
176	.000b					acr: .block
177	=0					t1OneShot=0<<6
178	=64					t1Continuous=1<<6
179	=128					t1OneShotPB7=2<<6
180	=192					t1ContinuousPB7=3<<6

182	=0					t2Timer=0<<5
183	=32					t2CountPB6=1<<5

185	=0					srDisabled=0<<2
186	=4					srShiftInT2=1<<2
187	=8					srShiftInVIAClock=2<<2
188	=12					srShiftInExtClock=3<<2
189	=16					srShiftOutT2FreeRun=4<<2
190	=20					srShiftOutT2=5<<2
191	=24					srShiftOutVIAClock=6<<2
192	=28					srShiftOutExtClock=7<<2

194	=0					pbLatchDisabled=0<<1
195	=2					pbLatchEnabled=1<<1

197	=0					paLatchDisabled=0<<0
198	=1					paLatchEnabled=1<<0

200	>000b					                .fill 1         ;11
201						                .endblock
202	.000c					pcr: .block

204	=0					cb2InputNegativeActiveEdge=0<<5
205	=32					cb2IndependentInterruptInputNegativeEdge=1<<5
206	=64					cb2InputPositiveEdge=2<<5
207	=96					cb2IndependentInterruptInputPositiveEdge=3<<5
208	=128					cb2HandshakeOutput=4<<5
209	=160					cb2PulseOutput=5<<5
210	=192					cb2LowOutput=6<<5
211	=224					cb2HighOutput=7<<5

213	=0					cb1NegativeActiveEdge=0<<4
214	=16					cb1PositiveActiveEdge=1<<4

216	=0					ca2InputNegativeActiveEdge=0<<1
217	=2					ca2IndependentInterruptInputNegativeEdge=1<<1
218	=4					ca2InputPositiveEdge=2<<1
219	=6					ca2IndependentInterruptInputPositiveEdge=3<<1
220	=8					ca2HandshakeOutput=4<<1
221	=10					ca2PulseOutput=5<<1
222	=12					ca2LowOutput=6<<1
223	=14					ca2HighOutput=7<<1

225	=0					ca1NegativeActiveEdge=0<<0
226	=1					ca1PositiveActiveEdge=1<<0

228	>000c					                .fill 1         ;12
229						                .endblock
230	.000d					ifr:
231	>000d					                .fill 1         ;13
232	.000e					ier:
233	>000e					                .fill 1         ;14
234	.000f					oraNoHandshake:
235	.000f					iraNoHandshake:
236	>000f					                .fill 1         ;15

238	.0010					irq: .block
239	=1					ca2=1
240	=2					ca1=2
241	=4					sr=4
242	=8					cb2=8
243	=16					cb1=16
244	=32					t2=32
245	=64					t1=64
246						                .endblock
247						                .ends

249						                                .virtual $fe40
250	.fe40					systemVIA: .dstruct VIA
152	.fe40					orb:
153	.fe40					irb:
154	>fe40					                .fill 1         ;0
155	.fe41					ora:
156	.fe41					ira:
157	>fe41					                .fill 1         ;1
158	.fe42					ddrb:
159	>fe42					                .fill 1         ;2
160	.fe43					ddra:
161	>fe43					                .fill 1         ;3
162	.fe44					t1cL:
163	>fe44					                .fill 1         ;4
164	.fe45					t1cH:
165	>fe45					                .fill 1         ;5
166	.fe46					t1lL:
167	>fe46					                .fill 1         ;6
168	.fe47					t1lH:
169	>fe47					                .fill 1         ;7
170	.fe48					t2cL:
171	>fe48					                .fill 1         ;8
172	.fe49					t2cH:
173	>fe49					                .fill 1         ;9
174	.fe4a					sr:
175	>fe4a					                .fill 1         ;10
176	.fe4b					acr: .block
177	=0					t1OneShot=0<<6
178	=64					t1Continuous=1<<6
179	=128					t1OneShotPB7=2<<6
180	=192					t1ContinuousPB7=3<<6

182	=0					t2Timer=0<<5
183	=32					t2CountPB6=1<<5

185	=0					srDisabled=0<<2
186	=4					srShiftInT2=1<<2
187	=8					srShiftInVIAClock=2<<2
188	=12					srShiftInExtClock=3<<2
189	=16					srShiftOutT2FreeRun=4<<2
190	=20					srShiftOutT2=5<<2
191	=24					srShiftOutVIAClock=6<<2
192	=28					srShiftOutExtClock=7<<2

194	=0					pbLatchDisabled=0<<1
195	=2					pbLatchEnabled=1<<1

197	=0					paLatchDisabled=0<<0
198	=1					paLatchEnabled=1<<0

200	>fe4b					                .fill 1         ;11
201						                .endblock
202	.fe4c					pcr: .block

204	=0					cb2InputNegativeActiveEdge=0<<5
205	=32					cb2IndependentInterruptInputNegativeEdge=1<<5
206	=64					cb2InputPositiveEdge=2<<5
207	=96					cb2IndependentInterruptInputPositiveEdge=3<<5
208	=128					cb2HandshakeOutput=4<<5
209	=160					cb2PulseOutput=5<<5
210	=192					cb2LowOutput=6<<5
211	=224					cb2HighOutput=7<<5

213	=0					cb1NegativeActiveEdge=0<<4
214	=16					cb1PositiveActiveEdge=1<<4

216	=0					ca2InputNegativeActiveEdge=0<<1
217	=2					ca2IndependentInterruptInputNegativeEdge=1<<1
218	=4					ca2InputPositiveEdge=2<<1
219	=6					ca2IndependentInterruptInputPositiveEdge=3<<1
220	=8					ca2HandshakeOutput=4<<1
221	=10					ca2PulseOutput=5<<1
222	=12					ca2LowOutput=6<<1
223	=14					ca2HighOutput=7<<1

225	=0					ca1NegativeActiveEdge=0<<0
226	=1					ca1PositiveActiveEdge=1<<0

228	>fe4c					                .fill 1         ;12
229						                .endblock
230	.fe4d					ifr:
231	>fe4d					                .fill 1         ;13
232	.fe4e					ier:
233	>fe4e					                .fill 1         ;14
234	.fe4f					oraNoHandshake:
235	.fe4f					iraNoHandshake:
236	>fe4f					                .fill 1         ;15

238	.fe50					irq: .block
239	=1					ca2=1
240	=2					ca1=2
241	=4					sr=4
242	=8					cb2=8
243	=16					cb1=16
244	=32					t2=32
245	=64					t1=64
246						                .endblock
247						                .ends
251						                .endv

253						                .virtual $fe60
254	.fe60					userVIA: .dstruct VIA
152	.fe60					orb:
153	.fe60					irb:
154	>fe60					                .fill 1         ;0
155	.fe61					ora:
156	.fe61					ira:
157	>fe61					                .fill 1         ;1
158	.fe62					ddrb:
159	>fe62					                .fill 1         ;2
160	.fe63					ddra:
161	>fe63					                .fill 1         ;3
162	.fe64					t1cL:
163	>fe64					                .fill 1         ;4
164	.fe65					t1cH:
165	>fe65					                .fill 1         ;5
166	.fe66					t1lL:
167	>fe66					                .fill 1         ;6
168	.fe67					t1lH:
169	>fe67					                .fill 1         ;7
170	.fe68					t2cL:
171	>fe68					                .fill 1         ;8
172	.fe69					t2cH:
173	>fe69					                .fill 1         ;9
174	.fe6a					sr:
175	>fe6a					                .fill 1         ;10
176	.fe6b					acr: .block
177	=0					t1OneShot=0<<6
178	=64					t1Continuous=1<<6
179	=128					t1OneShotPB7=2<<6
180	=192					t1ContinuousPB7=3<<6

182	=0					t2Timer=0<<5
183	=32					t2CountPB6=1<<5

185	=0					srDisabled=0<<2
186	=4					srShiftInT2=1<<2
187	=8					srShiftInVIAClock=2<<2
188	=12					srShiftInExtClock=3<<2
189	=16					srShiftOutT2FreeRun=4<<2
190	=20					srShiftOutT2=5<<2
191	=24					srShiftOutVIAClock=6<<2
192	=28					srShiftOutExtClock=7<<2

194	=0					pbLatchDisabled=0<<1
195	=2					pbLatchEnabled=1<<1

197	=0					paLatchDisabled=0<<0
198	=1					paLatchEnabled=1<<0

200	>fe6b					                .fill 1         ;11
201						                .endblock
202	.fe6c					pcr: .block

204	=0					cb2InputNegativeActiveEdge=0<<5
205	=32					cb2IndependentInterruptInputNegativeEdge=1<<5
206	=64					cb2InputPositiveEdge=2<<5
207	=96					cb2IndependentInterruptInputPositiveEdge=3<<5
208	=128					cb2HandshakeOutput=4<<5
209	=160					cb2PulseOutput=5<<5
210	=192					cb2LowOutput=6<<5
211	=224					cb2HighOutput=7<<5

213	=0					cb1NegativeActiveEdge=0<<4
214	=16					cb1PositiveActiveEdge=1<<4

216	=0					ca2InputNegativeActiveEdge=0<<1
217	=2					ca2IndependentInterruptInputNegativeEdge=1<<1
218	=4					ca2InputPositiveEdge=2<<1
219	=6					ca2IndependentInterruptInputPositiveEdge=3<<1
220	=8					ca2HandshakeOutput=4<<1
221	=10					ca2PulseOutput=5<<1
222	=12					ca2LowOutput=6<<1
223	=14					ca2HighOutput=7<<1

225	=0					ca1NegativeActiveEdge=0<<0
226	=1					ca1PositiveActiveEdge=1<<0

228	>fe6c					                .fill 1         ;12
229						                .endblock
230	.fe6d					ifr:
231	>fe6d					                .fill 1         ;13
232	.fe6e					ier:
233	>fe6e					                .fill 1         ;14
234	.fe6f					oraNoHandshake:
235	.fe6f					iraNoHandshake:
236	>fe6f					                .fill 1         ;15

238	.fe70					irq: .block
239	=1					ca2=1
240	=2					ca1=2
241	=4					sr=4
242	=8					cb2=8
243	=16					cb1=16
244	=32					t2=32
245	=64					t1=64
246						                .endblock
247						                .ends
255						                .endv

257						                .virtual $fee0
258	.fee0					tube: .block
259						; Parasite to Host: Carries the OSWRCH call. Data register is a FIFO
260						; that can handle a VDU command length (10 bytes).
261						;
262						; Host to Parasite: There is a 1 byte buffer. It is used to generate
263						; IRQ's in the parasite from events in the host.

265						; write/read (clears IRQ)
266	.fee0					status1: .block
267						; [Tube p13]
268	=$01					Q=$01                           ;enable HIRQ from R4
269	=$02					I=$02                           ;enable PIRQ from R1
270	=$04					J=$04                           ;enable PIRQ from R3
271	=$08					M=$08                           ;enable PNMI from R3
272	=$10					V=$10                           ;2-byte R3
273	=$20					P=$20                           ;activate PRST
274	=$40					T=$40                           ;clear all Tube registers
275	=$80					S=$80                           ;set/clear bits
276						                .bend
277	>fee0					                .fill 1

279						; bit 7 - data available/IRQ
280						; bit 6 - not full
281	.fee1					data1:
282	>fee1					                .fill 1

284						; Used to implement OS calls that take a long time or that cannot
285						; interrupt Host tasks. The parasite passes a byte describing the
286						; required task. The two processors then exchange data until the task
287						; is complete. OS calls handled through this register include: OSRDCH,
288						; OSCLI, OSBYTE, OSWORD, OSBPUT, OSBGET, OSFIND, OSARGS, OSFILE,
289						; OSGBPB.

291						; write/read
292	.fee2					status2:
293	>fee2					                .fill 1

295						; bit 7 - data available
296						; bit 6 - not full
297	.fee3					data2:
298	>fee3					                .fill 1

300						; Used for the background task of fast data transfer between the two
301						; processors.

303						; write/read
304	.fee4					status3:
305	>fee4					                .fill 1

307						; bit 7 - data available/NMI
308						; bit 6 - not full
309	.fee5					data3:
310	>fee5					                .fill 1

312						; Used as the control channel for block transfers going through
313						; Register 3, and also the transfer register for error strings from
314						; host to parasite. In both cases, the host interrupts the parasite by
315						; placing a byte into the Register. In the former case it is a byte
316						; describing the required action, in the latter it is an error code.

318						; write (sets IRQ)/read (clears IRQ)
319	.fee6					status4:
320	>fee6					                .fill 1

322						; bit 7 - data available/IRQ
323						; bit 6 - not full/IRQ
324	.fee7					data4:
325	>fee7					                .fill 1
326						                .bend
327						                .endv

329						RTC: .struct
330	>0000					seconds: .fill 1
331	>0001					secondsAlarm: .fill 1
332	>0002					minutes: .fill 1
333	>0003					minutesAlarm: .fill 1
334	>0004					hours: .fill 1
335	>0005					hoursAlarm: .fill 1
336	>0006					dayOfWeek: .fill 1
337	>0007					dayOfMonth: .fill 1
338	>0008					month: .fill 1
339	>0009					year: .fill 1
340	.000a					a: .block
341	=7					dvMask=7
342	=4					dvShift=4
343	=0					dv4194304Hz=0<<dvShift
344	=16					dv1048576Hz=1<<dvShift
345	=32					dv32768Hz=2<<dvShift
346	>000a					                .fill 1
347						                .endblock
348	.000b					b: .block
349	=$80					set=$80
350	=$02					_24h=$02
351	=$01					dse=$01
352	>000b					                .fill 1
353						                .endblock
354	.000c					c: .block
355	=$10					uf=$10
356	>000c					                .fill 1
357						                .endblock
358	.000d					d: .block
359	>000d					                .fill 1
360						                .endblock
361	=50					ram_size=50
362	>000e					ram: .fill ram_size
363						                .endstruct

:1	;******  Return to file: mos500.s65

2						                .include "src/mos_workspace.s65"

:3	;******  Processing file: src/mos_workspace.s65


2						;-------------------------------------------------------------------------
3						;
4						; Disorganized jumble of constants. They'll get tidied up at some
5						; point... promise...
6						;
7						;-------------------------------------------------------------------------

9						; These variant flags are applicable to the stated versions only, and
10						; may or may not be separable from the various .if/.endif constructs
11						; for that version. If they're set for any other version, the output
12						; may not make sense.

14						                .weak
15						                ; Set if building Olivetti MOS, a variant of 5.10.
16	=false					olivetti=false

18						                ; Set if building CFA3000 MOS, a variant of 3.50.
19	=false					CFA3000=false

21						                ; Set if building Autocue 1500 MOS, a variant of 5.11.
22	=false					autocue=false

24						                ; Set if building MOS 3.29 (Acorn FinMOS), a variant
25						                ; of 3.50.
26	=false					finmos329=false

28						                ; Set if building the Y2K-fixed version found in the
29						                ; RetroClinic multi-OS adapter, a variant of 3.20.
30	=false					multios=false
31						                .endweak

33						;-------------------------------------------------------------------------


36	=$400					tubeHostAddr=$400

38						                .if version==350
45						                .endif

47						;-------------------------------------------------------------------------

49	=$a8					osargsBuffer=$a8                ;4-byte ZP buffer for use with OSARGS
50	=$b8					printMessageAddress=$b8

52						                .virtual $bb
53	.00bb					tapeCurrentOptionsByte: .block
54						                .endblock
55						                .endvirtual

57						                .virtual $f2
58	.00f2					fsStatusByte: .block
59	=$01					inputFileOpen=$01
60	=$02					outputFileOpen=$02
61	=$08					catStatus=$08
62	=$40					eofReached=$40
63	=$80					eofWarningGiven=$80
64						                .endblock
65						                .endvirtual

67						                .virtual $e4
68	.00e4					stringInputOptions: .block
69	=$80					doubleQuotes=$80
70	=$40					spaceNotATerminator=$40
71	=$01					goodString=$01
72						                .endblock
73						                .endvirtual
74	=$e5					stringInputPlingFlag=$e5        ;bit 7 set if last char was '!'
75	=$e6					readCharacterTimedFlag=$e6
76	=$e7					autoRepeatCountdownTimer=$e7
77	=$eb					tapeCritical=$eb
78	=$ec					lastKeyPressedInternal=$ec
79	=$ed					firstKeyPressedInternal=$ed
80	=$f2					stringInputBufferAddress=$f2    ;word

82						;-------------------------------------------------------------------------

84	=$01					romServiceCallAbsoluteWorkspaceClaim=$01 ; memory used only when ROM is paged in
85	=$02					romServiceCallPrivateWorkspaceClaim=$02 ; memory used even when ROM is not paged in
86	=$03					romServiceCallAutoBoot=$03              ;
87	=$04					romServiceCallUnrecognisedCommand=$04   ; star command not recognised
88	=$05					romServiceCallUnrecognisedInterrupt=$05 ;
89	=$06					romServiceCallBreakInstruction=$06      ;
90	=$07					romServiceCallUnrecognisedOSBYTE=$07    ;
91	=$08					romServiceCallUnrecognisedOSWORD=$08    ;
92	=$09					romServiceCallHelp=$09                  ;
93	=$0a					romServiceCallClaimStaticWorkspace=$0A ; (Issued by paged ROMs, not the OS)
94	=$0b					romServiceCallNMIRelease=$0B    ; (Issued by paged ROMs, not the OS)
95	=$0c					romServiceCallNMIClaim=$0C      ; (Issued by paged ROMs, not the OS)
96	=$0d					romServiceCallROMFilingSystemInitialize=$0D    ;
97	=$0e					romServiceCallROMFilingSystemByteGet=$0E    ;
98	=$0f					romServiceCallVectorsClaimed=$0F    ; Used when a filing system starts
99	=$10					romServiceCallSpoolExecClosureWarning=$10    ;
100						;romServiceCallFontImplosionExplosionWarning=$11    ;
101	=$12					romServiceCallInitialiseFilingSystem=$12    ; (Issued from paged ROMs, not the OS)
102	=$15					romServiceCallPollingInterrupt=$15
103	=$18					romServiceCallReserved=$18
104	=$21					romServiceCallAbsoluteHAZELWorkspaceClaim=$21
105	=$22					romServiceCallPrivateHAZELWorkspaceClam=$22
106	=$23					romServiceCallTopOfHAZELWorkspace=$23
107	=$24					romServiceCallCountDynamicHAZELWorkspace=$24
108	=$25					romServiceCallRequestFSInfo=$25
109	=$26					romServiceCallCloseAllOpenFiles=$26
110	=$27					romServiceCallInformReset=$27
111	=$28					romServiceCallUnknownCONFIG=$28
112	=$29					romServiceCallUnknownSTATUS=$29
113	=$2a					romServiceCallLanguageChange=$2a
114	=$30					romServiceCall30=$30
115	=$fe					romServiceCallTubeSystemPostInitialisation=$FE    ;
116	=$ff					romServiceCallTubeMainInitialisation=$FF    ;

118						;-------------------------------------------------------------------------

120						; [MasRef D.2-24]

122	=0					eventOutputBufferEmpty=0
123	=1					eventInputBufferFull=1
124	=2					eventCharacterEnteringBuffer=2
125	=3					eventADCConversionComplete=3
126	=4					eventStartOfVerticalSync=4
127	=5					eventIntervalTimerCrossingZero=5
128	=6					eventESCAPEPressed=6
129	=7					eventRS423Error=7
130	=8					eventNetworkError=8
131	=9					eventUser=9
132	=9					eventMax=9

134						;-------------------------------------------------------------------------

136						; [MasRef D.2-27]

138						; Input buffers
139	=0					bufferKeyboard=0
140	=1					bufferRS423Input=1

142						; Output buffers
143	=2					bufferFirstOutput=2
144	=2					bufferRS423Output=2
145	=3					bufferPrinter=3
146	=4					bufferSoundChannel0=4
147	=5					bufferSoundChannel1=5
148	=6					bufferSoundChannel2=6
149	=7					bufferSoundChannel3=7
150						; What's buffer 8? Previously speech on OS 1.20. There's indices
151						; allocated for it...
152	=8					bufferMax=8


155	=$03e0					bufferKeyboardAddress=$03e0
156	=32					bufferKeyboardSize=32
157	=$0a00					bufferRS423InputAddress=$0a00
158	=256					bufferRS423InputSize=256
159	=$0900					bufferRS423OutputAddress=$0900
160	=192					bufferRS423OutputSize=192
161	=$0880					bufferPrinterAddress=$0880
162	=64					bufferPrinterSize=64
163	=$0840					bufferSoundChannel0Address=$0840
164	=16					bufferSoundChannel0Size=16
165	=$0850					bufferSoundChannel1Address=$0850
166	=16					bufferSoundChannel1Size=16
167	=$0860					bufferSoundChannel2Address=$0860
168	=16					bufferSoundChannel2Size=16
169	=$0870					bufferSoundChannel3Address=$0870
170	=16					bufferSoundChannel3Size=16
171	=$09c0					buffer8Address=$09c0
172	=64					buffer8Size=64



176						; BufferInfo: .function bufferAddress,bufferSizeByte
177						;                 .endfunction (bufferAddress,256-bufferSizeByte)

179						; ; buffer info is (base address,size)
180						;  _:=[]
181						; _..=[BufferInfo($0300,32)];bufferKeyboard=0
182						; _..=[BufferInfo($0a00,256)];bufferRS423Input=1
183						; _..=[BufferInfo($08c0,192)];bufferRS423Output=2
184						; _..=[BufferInfo($07c0,64)];bufferPrinter=3
185						; _..=[BufferInfo($0750,16)];bufferSoundChannel0=4
186						; _..=[BufferInfo($0760,16)];bufferSoundChannel1=5
187						; _..=[BufferInfo($0770,16)];bufferSoundChannel2=6
188						; _..=[BufferInfo($0780,16)];bufferSoundChannel3=7
189						; _..=[BufferInfo($0900,64)];What's buffer 8?

191						;-------------------------------------------------------------------------

193						; [MasRef C.5-5]

195	=0					printerDriverTypeSink=0
196	=1					printerDriverTypeParallel=1
197	=2					printerDriverTypeSerial=2
198	=3					printerDriverTypeUser=3
199	=4					printerDriverTypeNetwork=4

201						; AUG p259

203	=0					printerDriverPoll=0
204	=1					printerDriverActivate=1
205	=2					printerDriverVDU2=2
206	=3					printerDriverVDU3=3
207	=5					printerDriverFX5=5

209	=10					printerDriverFX3=10             ;undocumented???

211						;-------------------------------------------------------------------------

213						; AUG p261

215	=0					netPrinterRequest0=0
216	=1					netPrinterRequest1=1
217	=2					netPrinterRequest2=2
218	=3					netPrinterRequest3=3
219	=4					netWriteCharacterAttempted=4
220	=5					netPrinterRequest5=5
221	=6					netReadCharacterAttempted=6
222	=7					netOSBYTEAttempted=7
223	=8					netOSWORDAttempted=8
224	=13					netOSWORD0Complete=13

226						;-------------------------------------------------------------------------

228	=0					fscOPT=0
229	=1					fscCheckEOF=1
230	=2					fscStarSlash=2
231	=3					fscUnknownCommand=3
232	=4					fscStarRUN=4
233	=5					fscStarCAT=5
234	=6					fscNewFS=6
235	=7					fscFileHandleRange=7
236	=8					fscStarCommand=8
237	=9					fscStarEX=9
238	=10					fscStarINFO=10
239	=11					fscRUNLibrary=11

241						; NAUG mentions this. But it doesn't appear to
242						; actually exist in the code.
243						;
244						; Maybe it's present in MOS 3.50 or later?
245	=12					fscRENAME=12

247	=1					gbpbPutBytesNewPTR=1            ;[AUG p340]
248	=2					gbppPutBytesCurrentPTR=2        ;[AUG p340]
249	=3					gbpbGetBytesNewPTR=3            ;[AUG p341]
250	=4					gbpbGetBytesCurrentPTR=4        ;[AUG p341]
251	=5					gbpbGetMediaMetadata=5          ;[AUG p341]
252	=6					gbpbGetCurrentDevice=6          ;[AUG p341]
253	=7					gbpbGetLibraryDevice=7          ;[AUG p341]
254	=8					gbpbReadFileNames=8             ;[AUG p341]

256						OSGBPBParameterBlock: .struct
257	.0000					handle:
258	>0000					                .fill 1
259	.0001					address:
260	>0001					                .fill 4
261	.0005					count:
262	>0005					                .fill 4
263	.0009					ptr:
264	>0009					                .fill 4
265						                .endstruct

267	=0					argsGetFS=0                     ;[AUG p337]
268	=1					argsGetCommandLine=1            ;[AUG p338]
269	=2					argsCheckANFS=2                 ;https://beebwiki.mdfs.net/OSARGS
270	=3					argsGetLibFS=3                  ;
271	=$ff					argsFlushBuffers=$ff            ;[AUG p338]

273	=0					argsFileGetPTR=0
274	=1					argsFileSetPTR=1
275	=2					argsFileGetEXT=2
276	=$ff					argsFileFlush=$ff

278	=0					fileSave=0                      ;[AUG p336]
279	=1					fileWriteMetadata=1             ;[AUG p336]
280	=2					fileWriteLoadAddress=2          ;[AUG p336]
281	=3					fileWriteExecAddress=3          ;[AUG p336]
282	=4					fileWritettributes=4            ;[AUG p336]
283	=5					fileReadMetadata=5              ;[AUG p336]
284	=6					fileDelete=6                    ;[AUG p336]
285	=$ff					fileLoad=$ff                    ;[AUG p336]

287						OSFILEParameterBlock: .struct
288	.0000					fileName:
289	>0000					                .fill 2
290	.0002					addresses:
291	.0002					load:
292	>0002					                .fill 4
293	.0006					exec:
294	>0006					                .fill 4
295	.000a					length:
296	.000a					saveStart:
297	>000a					                .fill 4
298	.000e					attributes:
299	.000e					saveEnd:
300	>000e					                .fill 4
301						                .endstruct

303						;-------------------------------------------------------------------------

305	=0					bufferNumberKeyboard=0          ;
306	=1					bufferNumberRS423Input=1        ;
307	=2					bufferNumberRS423Output=2       ;
308	=3					bufferNumberPrinter=3           ;
309	=4					bufferNumberSound0=4            ; Noise channel
310	=5					bufferNumberSound1=5            ;
311	=6					bufferNumberSound2=6            ;
312	=7					bufferNumberSound3=7            ;
313						; bufferNumberSpeech=8            ;
314	=8					bufferNumberHighest=8           ;

316						;-------------------------------------------------------------------------

318						; uservIndex=0
319						; brkvIndex=1
320						; irq1vIndex=2
321						; irq2vIndex=3
322						; clivIndex=4
323						; bytevIndex=5
324						; wordvIndex=6
325						; wrchvIndex=7
326						; rdchvIndex=8
327						; filevIndex=9
328						; argsvIndex=10
329						; bgetvIndex=11
330						; bputvIndex=12
331						; gbpbvIndex=13
332						; findvIndex=14
333						; fscvIndex=15
334						; eventvIndex=16
335						; uptvIndex=17
336						; netvIndex=18
337						; vduvIndex=19
338						; keyvIndex=20
339						; insvIndex=21
340						; remvIndex=22
341						; cnpvIndex=23
342						; ind1vIndex=24
343						; ind2vIndex=25
344						; ind3vIndex=26


347						                .virtual $200
348	.0200					vectors:
349	.0200					USERV:
350	>0200					                .fill 2
351	.0202					BRKV:
352	>0202					                .fill 2
353	.0204					IRQ1V:
354	>0204					                .fill 2
355	.0206					IRQ2V:
356	>0206					                .fill 2
357	.0208					CLIV:
358	>0208					                .fill 2
359	.020a					BYTEV:
360	>020a					                .fill 2
361	.020c					WORDV:
362	>020c					                .fill 2
363	.020e					WRCHV:
364	>020e					                .fill 2
365	.0210					RDCHV:
366	>0210					                .fill 2
367	.0212					FILEV:
368	>0212					                .fill 2
369	.0214					ARGSV:
370	>0214					                .fill 2
371	.0216					BGETV:
372	>0216					                .fill 2
373	.0218					BPUTV:
374	>0218					                .fill 2
375	.021a					GBPBV:
376	>021a					                .fill 2
377	.021c					FINDV:
378	>021c					                .fill 2
379	.021e					FSCV:
380	>021e					                .fill 2
381	.0220					EVENTV:
382	>0220					                .fill 2
383	.0222					UPTV:
384	>0222					                .fill 2
385	.0224					NETV:
386	>0224					                .fill 2
387	.0226					VDUV:
388	>0226					                .fill 2
389	.0228					KEYV:
390	>0228					                .fill 2
391	.022a					INSV:
392	>022a					                .fill 2
393	.022c					REMV:
394	>022c					                .fill 2
395	.022e					CNPV:
396	>022e					                .fill 2
397	.0230					IND1V:
398	>0230					                .fill 2
399	.0232					IND2V:
400	>0232					                .fill 2
401	.0234					IND3V:
402	>0234					                .fill 2
403	.0236					mosVariables:

405						; OSBYTE 166 (&A6) Read start address of MOS variables [MasRef D.2-50]
406						; OSBYTE 167 (&A7) Read start address of MOS variablespointer table  [MasRef D.2-50]
407	>0236					mosVariablesAddress: .fill 2

409						; OSBYTE 168 (&A8) Read address of ROM pointer table [MasRef D.2-51]
410						; OSBYTE 169 (&A9) Read address of ROM pointer table [MasRef D.2-51]
411	>0238					extendedVectorSpaceAddress: .fill 2

413						; OSBYTE 170 (&AA) Read address of ROM information table [MasRef D.2-51]
414						; OSBYTE 171 (&AB) Read address of ROM information table [MasRef D.2-51]
415	>023a					romInformationTableAddress: .fill 2

417						; OSBYTE 172 (&AC) Read address of keyboard translation table [MasRef D.2-52]
418						; OSBYTE 173 (&AD) Read address of keyboard translation table [MasRef D.2-52]
419	>023c					keyboardTranslationTableAddress: .fill 2

421						; OSBYTE 174 (&AE) Read address of VDU variables origin [MasRef D.2-52]
422						; OSBYTE 175 (&AF) Read address of VDU variables origin [MasRef D.2-52]
423	>023e					vduVariablesAddress: .fill 2

425						; OSBYTE 176 (&B0) Read/Write CFS timeout counter [MasRef D.2-52]
426	>0240					cfsTimeoutCounter: .fill 1

428						; OSBYTE 177 (&B1) Read/write input source [MasRef D.2-53]
429	>0241					inputSource: .fill 1

431						; OSBYTE 178 (&B2) Read/write keyboard semaphore [MasRef D.2-53]
432	>0242					keyboardSemaphore: .fill 1

434						; OSBYTE 179 (&B3) Read/write ROM polling semaphore [MasRef D.2-54]
435	>0243					romPollingSemaphore: .fill 1

437						; OSBYTE 180 (&B4) Read/write Operating System High [MasRef D.2-54]
438	>0244					oshwm: .fill 1

440						; OSBYTE 181 (&B5) Read/write RS243 input interpretation [MasRef D.2-54]
441	>0245					rs423InputInterpretationStatus: .fill 1

443						; OSBYTE 182 (&B6) Read NOIGNORE state [MasRef D.2-55]
444						;
445						; TODO - not a great name, no matter how official - should probably be usePrinterIgnoreChar or something
446	>0246					noignoreState: .fill 1

448						; OSBYTE 183 (&B7) Read/write cassette/ROM filing system [MasRef D.2-55]
449	>0247					cfsRFSFSSwitch: .fill 1

451						; OSBYTE 184 (&B8) Read OS copy of video ULA control [MasRef D.2-56]
452	>0248					vcontrolRegister: .fill 1

454						; OSBYTE 185 (&B9) Read OS copy of video ULA palette [MasRef D.2-56]
455	>0249					vpaletteRegister: .fill 1

457						; OSBYTE 186 (&BA) Read ROM number active at last BRK [MasRef D.2-56]
458	>024a					romActiveAtLastBRK: .fill 1

460						; OSBYTE 187 (&BB) Read ROM number of socket [MasRef D.2-57]
461	>024b					basicROMNumber: .fill 1

463						; OSBYTE 188 (&BC) Read current ADC channel number [MasRef D.2-57]
464	>024c					currentADCChannel: .fill 1

466						; OSBYTE 189 (&BD) Read maximum ADC channel number [MasRef D.2-57]
467	>024d					maximumADCChannel: .fill 1

469						; OSBYTE 190 (&BE) Read/write ADC conversion type [MasRef D.2-58]
470	>024e					adcConversionType: .fill 1

472						; OSBYTE 191 (&BF) Read/write RS423 busy flag [MasRef D.2-58]
473	>024f					rs423Busy: .fill 1

475						; OSBYTE 192 (&C0) Read serial ACIA control register [MasRef D.2-58]
476	>0250					aciaControlRegister: .fill 1

478						; OSBYTE 193 (&C1) Read/write flash counter [MasRef D.2-59]
479	>0251					flashCounter: .fill 1

481						; OSBYTE 194 (&C2) Read/write duration of first colour [MasRef D.2-59]
482	>0252					firstFlashColourDuration: .fill 1

484						; OSBYTE 195 (&C3) Read/write duration of second colour [MasRef D.2-60]
485	>0253					secondFlashColourDuration: .fill 1

487						; OSBYTE 196 (&C4) Read/write keyboard auto-repeat delay [MasRef D.2-60]
488	>0254					keyboardAutoRepeatDelay: .fill 1

490						; OSBYTE 197 (&C5) Read/write keyboard auto-repeat rate [MasRef D.2-60]
491	>0255					keyboardAutoRepeatRate: .fill 1

493						; OSBYTE 198 (&C6) Read/write *EXEC file handle [MasRef D.2-61]
494	>0256					execFileHandle: .fill 1

496						; OSBYTE 199 (&C7) Read/write *SPOOL file handle [MasRef D.2-62]
497	>0257					spoolFileHandle: .fill 1

499						; OSBYTE 200 (&C8) Read/write BREAK and ESCAPE effect [MasRef D.2-62]
500	>0258					breakAndESCAPEEffect: .fill 1

502						; OSBYTE 201 (&C9) Read/write keyboard status [MasRef D.2-63]
503	>0259					keyboardStatus: .fill 1

505						; OSBYTE 202 (&CA) Read/write keyboard status byte [MasRef D.2-63]
506	.025a					keyboardStatusByte: .block
507	=$8					shiftPressed=%1<<3
508	=%10000					capsLockDisengaged=%1<<4
509	=%100000				shiftLockDisengaged=%1<<5
510	=%1000000				ctrlPressed=%1<<6
511	=$80					shiftEnabled=%1<<7
512	>025a					                .fill 1
513						                .endblock

515						; OSBYTE 203 (&CB) Read/write RS423 input buffer [MasRef D.2-64]
516	>025b					rs423InputBufferMinimumSpace: .fill 1

518						; OSBYTE 204 (&CC) Read/write RS423 ignore flag [MasRef D.2-65]
519	>025c					rs423Ignore: .fill 1

521						; OSBYTE 205 (&CD) Read/write RS423 destination [MasRef D.2-65]
522	>025d					rs423Destination: .fill 1

524						; OSBYTE 206 (&CE) Read/write Econet OS call interception [MasRef D.2-66]
525	>025e					econetInterceptionStatus: .fill 1

527						; OSBYTE 207 (&CF) Read/write Econet input interpretation [MasRef D.2-66]
528	>025f					econetInputInterpretationStatus: .fill 1

530						; OSBYTE 208 (&D0) Read write Econet output [MasRef D.2-67]
531	>0260					econetOutputInterpretationStatus: .fill 1

533						; OSBYTE 209 (&D1) is reserved for the speech system [MasRef D.2-67]
534	>0261					speechSystemByte1:  .fill 1

536						; OSBYTE 210 (&D2) Read/write sound suppression status [MasRef D.2-67]
537	>0262					soundSuppressionStatus: .fill 1

539						; OSBYTE 211 (&D3) Read/write BELL channel [MasRef D.2-67]
540	>0263					bellChannel: .fill 1

542						; OSBYTE 212 (&D4) Read/write BELL sound information [MasRef D.2-68]
543	>0264					bellSound: .fill 1

545						; OSBYTE 213 (&D5) Read/write BELL frequency [MasRef D.2-69]
546	>0265					bellFrequency: .fill 1

548						; OSBYTE 214 (&D6) Read/write BELL duration [MasRef D.2-69]
549	>0266					bellDuration: .fill 1

551						; OSBYTE 215 (&D7) Read/write startup message [MasRef D.2-69]
552	>0267					startupMessageSuppressionStatus: .fill 1

554						; OSBYTE 216 (&D8) Read/write length of soft key string [MasRef D.2-70]
555	>0268					softKeyStringLength: .fill 1

557						; OSBYTE 217 (&D9) Read/write paged mode line count [MasRef D.2-71]
558	>0269					pagedModeCounter: .fill 1

560						; OSBYTE 218 (&DA) Read/write bytes in VDU queue [MasRef D.2-71]
561	>026a					vduQueueNegativeLength: .fill 1

563						; OSBYTE 219 (&DB) Read/write TAB key code [MasRef D.2-72]
564	>026b					tabKeyCode: .fill 1

566						; OSBYTE 220 (&DC) Read/write ESCAPE character [MasRef D.2-72]
567	>026c					escapeCharacter: .fill 1

569						; OSBYTE 221 (&DD) Read/write interpretation of input values 192-207 [MasRef D.2-73]
570	>026d					input192To207Interpretation: .fill 1

572						; OSBYTE 222 (&DE) Read/write interpretation of input values 208-223 [MasRef D.2-73]
573	>026e					input208To223Interpretation: .fill 1

575						; OSBYTE 223 (&DF) Read/write interpretation of input values 224-239 [MasRef D.2-73]
576	>026f					input224To239Interpretation: .fill 1

578						; OSBYTE 224 (&E0) Read/write interpretation of input values 240-255 [MasRef D.2-73]
579	>0270					input240To255Interpretation: .fill 1

581						; OSBYTE 225 (&E1) Read/write soft key interpretation [MasRef D.2-74]
582	>0271					softKeyInterpretation: .fill 1

584						; OSBYTE 226 (&E2) Read/write SHIFT+soft key interpretation [MasRef D.2-74]
585	>0272					shiftSoftKeyInterpretation: .fill 1

587						; OSBYTE 227 (&E3) Read/write CTRL+soft key interpretation [MasRef D.2-74]
588	>0273					ctrlSoftKeyInterpretation: .fill 1

590						; OSBYTE 228 (&E4) Read/write SHIFT+CTRL+soft key interpretation [MasRef D.2-74]
591	>0274					shiftCtrlSoftKeyInterpretation: .fill 1

593						; OSBYTE 229 (&E5) Read/write ESCAPE key status [MasRef D.2-75]
594	>0275					escapeKeyStatus: .fill 1

596						; OSBYTE 230 (&E6) Read/write ESCAPE effects [MasRef D.2-75]
597	>0276					escapeEffects: .fill 1

599						; OSBYTE 231 (&E7) Read/write IRQ bit mask for user 6522 [MasRef D.2-76]
600	>0277					userVIAInterruptMask: .fill 1

602						; OSBYTE 232 (&E8) Read/write IRQ bit mask for 6850 [MasRef D.2-76]
603	>0278					rs423InterruptMask: .fill 1

605						; OSBYTE 233 (&E9) Read write IRQ bit mask for system [MasRef D.2-76]
606	>0279					systemVIAInterruptMask: .fill 1

608						; OSBYTE 234 (&EA) Read flag indicating Tube presence [MasRef D.2-76]
609	>027a					tubePresence: .fill 1

611						; OSBYTE 235 (&EB) is reserved for the speech system. [MasRef D.2-77]
612	>027b					speechSystemByte2: .fill 1

614						; OSBYTE 236 (&EC) Read/write character destination status [MasRef D.2-77]
615	.027c					characterDestinationStatus: .block
616	>027c					                .fill 1
617	=1					rs423_enable=1
618	=2					vdu_disable=2
619	=4					printer_disable=4               ;printer always off
620	=8					printer_enable=8                ;printer always on
621	=16					spool_disable=16
622	=64					printer_maybe=64                ;printer on when VDU 1 only
623						                .endblock

625						; OSBYTE 237 (&ED) Read/write cursor editing status [MasRef D.2-77]
626	.027d					editKeysMode: .block
627	=0					editKeys=0                      ;edit keys do editing
628	=1					asciiKeys=1                     ;edit keys are ASCII 135-139
629	=2					functionKeys=2                  ;edit keys are F keys 11-15
630	>027d					                .fill 1
631						                .endblock

633						; OSBYTE 238 (&EE) Read/write numeric keypad [MasRef D.2-78]
634	>027e					numericKeypadInterpretation: .fill 1

636						; OSBYTE 239 (&EF) Read/write *SHADOW state [MasRef D.2-78]
637	>027f					shadowRAMState: .fill 1

639						; OSBYTE 240 (&F0) Read country flag [MasRef D.2-79]
640	>0280					countryFlag: .fill 1

642						; OSBYTE 241 (&F1) Read/write user flag [MasRef D.2-79]
643	>0281					userFlag: .fill 1

645						; OSBYTE 242 (&F2) Read copy of serial processor ULA [MasRef D.2-80]
646	>0282					serialULARegister: .fill 1

648						; OSBYTE 243 (&F3) Read timer switch state [MasRef D.2-80]
649						;
650						; The location holds either 5 (initialTimerSwitchState) or 10
651						; (initialTimerSwitchState^15) - i.e., the offset of the byte after
652						; the last of the timer.
653						;
654						; Various offsets are applied to the timer addresses to make this
655						; work.
656	>0283					timerSwitchState: .fill 1

658						; OSBYTE 244 (&F4) Read/write soft key consistency flag [MasRef D.2-81]
659	>0284					softKeyConsistencyFlag: .fill 1

661						; OSBYTE 245 (&F5) Read printer driver type [MasRef D.2-81[
662	>0285					printerDriverType: .fill 1

664						; OSBYTE 246 (&F6) Read/write printer ignore character [MasRef D.2-81]
665	>0286					printerIgnoreChar: .fill 1

667						; OSBYTE 247 (&F7) Read/write BREAK intercept vector [MasRef D.2-82]
668	>0287					breakVectorByte0: .fill 1

670						; OSBYTE 248 (&F7) Read/write BREAK intercept vector [MasRef D.2-82]
671	>0288					breakVectorByte1: .fill 1

673						; OSBYTE 249 (&F7) Read/write BREAK intercept vector [MasRef D.2-82]
674	>0289					breakVectorByte2: .fill 1

676						; OSBYTE 250 (&FA) Read memory written by VDU driver [MasRef D.2-82]
677	>028a					vduDriverMemory: .fill 1

679						; OSBYTE 251 (&FB) Read memory displayed [MasRef D.2-83]
680	>028b					displayMemory: .fill 1

682						; OSBYTE 252 (&FC) Read/write current language ROM number [MasRef D.2-83]
683	>028c					currentLanguageROM: .fill 1

685						; OSBYTE 253 (&FD) Read last BREAK type [MasRef D.2-83]
686	.028d					lastBREAKType: .block
687	>028d					                .fill 1
688	=0					softBREAK=0
689	=1					powerOn=1
690	=2					hardBREAK=2
691						                .endblock
692						; OSBYTE 254 (&FE) Set effect of SHIFT on numeric keypad [MasRef D.2-84]
693	>028e					numericKeypadShiftEffect: .fill 1
694						; OSBYTE 255 (&FF) Read/write startup options [MasRef D.2-84]
695	>028f					startupOptions: .fill 1
696	=7					modeMask=7

698						                .endvirtual

700	=166					firstMOSVariableOSBYTE=166

702	=5					initialTimerSwitchState=5
703	=$290					tvOffset=$290
704	=$291					tvInterlace=$291
705	=$292					timer0=$292
706	=$297					timer1=$297
707	=$29c					intervalTimer=$29c
708	=$2a1					romInformationTable=$2a1
709	=$2b1					inkeyTimeoutCounter=$2b1
710	=$2b3					osword0MaxLineLength=$2b3
711	=$2b4					osword0MinASCIICharacter=$2b4
712	=$2b5					osword0MaxASCIICharacter=$2b5
713	=$2b6					adcResultLSBs=$2b6
714	=$2ba					adcResultMSBs=$2ba
715	=$2be					adcLastChannelRead=$2be         ;Two names for the same thing!
716	=$2be					adcLastConvertedChannel=$2be    ;Two names for the same thing!
717	=$2bf					eventEnabledFlags=$2bf
718	=$02c9					currentSoftKey=$02c9
719	=$02ca					keyboardFirstAutoRepeatCount=$02ca
720	=$2cb					previousKeyPressedWhenReadingLastKey=$2cb
721	=$2cc					previousKeyPressedWhenReadingFirstKey=$2cc
722	=$2cd					previousKeyPressedWhenReadingOSBYTE=$2cd
723						; soundIsUpdatingFlag=$2ce
724	=$2ce					bufferEmptyFlags=$2ce
725	=$2d7					bufferStartIndices=$2d7
726	=$2e0					bufferEndIndices=$2e0

728	=$2e9					tapeInputCurrentBlockSize=$2e9
729	=$2eb					blockFlagOfCurrentlyResidentBlock=$2eb
730	=$2ec					lastCharacterOfCurrentlyResidentBlock=$2ec

732						; Probably needs a better name :(
733						;
734						; Used by various file routines to store OSGBPB and OSFILE parameter
735						; blocks.
736						;
737						; Used by the clock routines to hold a (possibly partial) mirror of
738						; the RTC time/date registers.
739						;
740						; Used when parsing hex addresses from the command line - obviously
741						; designed primarily for convenient use when building up the OSFILE
742						; parameter block for use with *LOAD and *SAVE.
743	=$2ed					osfileParameterBlock=$2ed

745						; rtcTempData=$2ee

747						ExtendedVectorAddress: .function vectorAddress
749						                .endfunction extendedVectorSpace+(vectorAddress-vectors)/2*3

751						;-------------------------------------------------------------------------

753	=$d9f					extendedVectorSpace=$d9f

755	=$62					key_space=$62
756	=$66					key_comma=$66
757	=$17					key_minus=$17
758	=$67					key_stop=$67
759	=$68					key_slash=$68
760	=$27					key_0=$27
761	=$30					key_1=$30
762	=$31					key_2=$31
763	=$11					key_3=$11
764	=$12					key_4=$12
765	=$13					key_5=$13
766	=$34					key_6=$34
767	=$24					key_7=$24
768	=$15					key_8=$15
769	=$26					key_9=$26
770	=$48					key_colon=$48
771	=$57					key_semicolon=$57
772	=$47					key_at=$47
773	=$41					key_a=$41
774	=$64					key_b=$64
775	=$52					key_c=$52
776	=$32					key_d=$32
777	=$22					key_e=$22
778	=$43					key_f=$43
779	=$53					key_g=$53
780	=$54					key_h=$54
781	=$25					key_i=$25
782	=$45					key_j=$45
783	=$46					key_k=$46
784	=$56					key_l=$56
785	=$65					key_m=$65
786	=$55					key_n=$55
787	=$36					key_o=$36
788	=$37					key_p=$37
789	=$10					key_q=$10
790	=$33					key_r=$33
791	=$51					key_s=$51
792	=$23					key_t=$23
793	=$35					key_u=$35
794	=$63					key_v=$63
795	=$21					key_w=$21
796	=$42					key_x=$42
797	=$44					key_y=$44
798	=$61					key_z=$61
799	=$38					key_left_square_bracket=$38
800	=$78					key_backslash=$78
801	=$58					key_right_square_bracket=$58
802	=$18					key_caret=$18
803	=$28					key_underline=$28
804	=$70					key_escape=$70
805	=$60					key_tab=$60
806	=$40					key_caps_lock=$40
807	=$1					key_ctrl=$1
808	=$50					key_shift_lock=$50
809	=$0					key_shift=$0
810	=$59					key_delete=$59
811	=$69					key_copy=$69
812	=$49					key_return=$49
813	=$39					key_up=$39
814	=$29					key_down=$29
815	=$19					key_left=$19
816	=$79					key_right=$79
817	=$20					key_f0=$20
818	=$71					key_f1=$71
819	=$72					key_f2=$72
820	=$73					key_f3=$73
821	=$14					key_f4=$14
822	=$74					key_f5=$74
823	=$75					key_f6=$75
824	=$16					key_f7=$16
825	=$76					key_f8=$76
826	=$77					key_f9=$77
827	=$6a					key_numpad_0=$6a
828	=$6b					key_numpad_1=$6b
829	=$7c					key_numpad_2=$7c
830	=$6c					key_numpad_3=$6c
831	=$7a					key_numpad_4=$7a
832	=$7b					key_numpad_5=$7b
833	=$1a					key_numpad_6=$1a
834	=$1b					key_numpad_7=$1b
835	=$2a					key_numpad_8=$2a
836	=$2b					key_numpad_9=$2b
837	=$3a					key_numpad_plus=$3a
838	=$3b					key_numpad_minus=$3b
839	=$4a					key_numpad_divide=$4a
840	=$5a					key_numpad_hash=$5a
841	=$5b					key_numpad_multiply=$5b
842	=$5c					key_numpad_comma=$5c
843	=$3c					key_numpad_return=$3c
844	=$4b					key_numpad_delete=$4b
845	=$4c					key_numpad_stop=$4c

847						fsInfoBlock: .struct
848	>0000					name: .fill 8
849	>0008					minHandle: .fill 1
850	>0009					maxHandle: .fill 1
851	>000a					fsNumber: .fill 1
852						                .ends

854						osgbpbBlock: .struct
855	>0000					handle: .fill 1
856	>0001					addr: .fill 4
857	>0005					numBytes: .fill 4
858	>0009					ptr: .fill 4
859						                .ends

861						                ; NAUG p260
862						                .virtual $dc00
863	.dc00					hazel: .block
864	.dc00					commandLine:                    ;dc00
865	>dc00					                .fill 256
866	.dd00					ddxx:                           ;dd00
867	>dd00					                .fill 256
868	.de00					dexx:
869	>de00					                .fill 256
870	.df00					currentFS:                      ;df00
871	>df00					                .fill 1
872	.df01					activeFS:                       ;df01
873	>df01					                .fill 1
874	.df02					libFS:                          ;df02
875	>df02					                .fill 1
876	.df03					currentFSROM:                   ;df03
877	>df03					                .fill 1
878	.df04					commandLinePointer:             ;df04
879	>df04					                .fill 2

881						                ; 17 info blocks in total, but everything is relative
882						                ; to the 0th, so there's only a need to instantiate a
883						                ; struct for that one. Don't think 64tass handles
884						                ; arrays of structs anyway.
885	.df06					fsInfoBlocks:   .dstruct fsInfoBlock ;df06
848	>df06					name: .fill 8
849	>df0e					minHandle: .fill 1
850	>df0f					maxHandle: .fill 1
851	>df10					fsNumber: .fill 1
852						                .ends
886	>df11					                .fill 16*size(fsInfoBlock)
887	.dfc1					fsInfoBlocksTerminator:         ;dfc1
888						                ; space reserved for the 0 terminator when the full
889						                ; set of info blocks are filled.
890	>dfc1					                .fill 1
891	.dfc2					fsFlags: .block                 ;dfc2
892	>dfc2					                .fill 1
893	=$80					useASCII=$80
894	=$80					isAPPEND=$80
895	=$40					noLineNumbers=$40
896						                .bend
897	.dfc3					lineNumberBCD:                  ;dfc3
898	>dfc3					                .fill 2
899	.dfc5					lastCharPrinted:                ;dfc5
900	>dfc5					                .fill 1
901	.dfc6					tempFSFlag:                     ;dfc6
902	>dfc6					                .fill 1
903	.dfc7					moveOSGBPB: .dstruct osgbpbBlock ;dfc7
855	>dfc7					handle: .fill 1
856	>dfc8					addr: .fill 4
857	>dfcc					numBytes: .fill 4
858	>dfd0					ptr: .fill 4
859						                .ends
904	.dfd4					moveSrcHandle:                  ;dfd4
905	>dfd4					                .fill 1
906	.dfd5					moveDestHandle:                 ;dfd5
907	>dfd5					                .fill 1
908	.dfd6					moveBufferMSB:                  ;dfd6
909	>dfd6					                .fill 1
910	.dfd7					moveNumPages:                   ;dfd7
911	>dfd7					                .fill 1
912	.dfd8					moveDestName:                   ;dfd8
913	>dfd8					                .fill 2
914	.dfda					activeFSCV:                     ;dfda
915	>dfda					                .fill 2
916	.dfdc					oldACCCON:                      ;dfdc
917	>dfdc					                .fill 1
918	.dfdd					hasACCCONChanged:                ;dfdd
919	>dfdd					                .fill 1
920	.dfde					dfde:
921	>dfde					                .fill 1
922						                .bend
923						                .endv

925						;-------------------------------------------------------------------------
926						;
927						; VDU variables
928						;
929						; MasRef E.4-1
930						;
931						VDUVariables: .struct
932	.0000					graphicsWindow:
933						;graphicsWindowLeftBottom:
934						; &00 2 Graphics window left column. (p)
935	>0000					graphicsWindowPixelsLeft: .fill 2
936						; &02 2 Graphics window bottom row. (p)
937	>0002					graphicsWindowPixelsBottom: .fill 2
938						;graphicsWindowRightTop:
939						; &04 2 Graphics window right column. (p)
940	>0004					graphicsWindowPixelsRight: .fill 2
941						; &06 2 Graphics window top row. (p)
942	>0006					graphicsWindowPixelsTop: .fill 2
943	.0008					textWindow:
944						; &08 1 Text window left column.
945	>0008					textWindowLeft: .fill 1
946						; &09 1 Text window bottom row.
947	>0009					textWindowBottom: .fill 1
948						; &0A 1 Text window right column.
949	>000a					textWindowRight: .fill 1
950						; &0B 1 Text window top row.
951	>000b					textWindowTop: .fill 1
952						; &0C 2 Graphics origin X coordinate. (e)
953	>000c					graphicsWindowOriginX: .fill 2
954						; &0E 2 Graphics origin Y coordinate. (e)
955	>000e					graphicsWindowOriginY: .fill 2
956						; &10 2 Graphics cursor X coordinate. (e)
957	>0010					graphicsCursorPositionX: .fill 2
958						; &12 2 Graphics cursor Y coordinate. (e)
959	>0012					graphicsCursorPositionY: .fill 2
960						; &14 2 Previous graphics cursor X coordinate. (p)
961	.0014					oldGraphicsCursorPixels:
962	>0014					oldGraphicsCursorPixelsX: .fill 2
963						; &16 2 Previous graphics cursor Y coordinate. (p)
964	>0016					oldGraphicsCursorPixelsY: .fill 2
965						; &18 1 Text cursor X coordinate (from left of screen) when not cursor editing. When cursor editing, normally the input cursor X coordinate, but the output cursor X coordinate within an <80><9C>unknown PLOT codes<80><9D> routine.
966	>0018					textCursorXPosition: .fill 1
967						; &19 1 Text cursor Y coordinate (from top of screen) when not cursor editing. When cursor editing, normally t.lsthe input cursor Y coordinate, but the output cursor Y coordinate within an <80><9C>unknown PLOT codes<80><9D> routine.
968	>0019					textCursorYPosition: .fill 1
969						; &1A 1 Y produced by GADDR (see next section) so that (ZMEMG),Y addresses the correct byte.
970	>001a					graphicsAddressOffset: .fill 1
971						; &1B<80><93>&23 VDU queue: &23 contains last byte of queue, other bytes immediately precede it.
972	=9					queueSize=9
973	>001b					queueBegin: .fill queueSize
974	.0024					queueEnd:
975	.0024					graphicsCursorPixels:
976						; &24 2 Graphics cursor X coordinate. (p)
977	>0024					graphicsCursorPixelsX: .fill 2
978						; &26 2 Graphics cursor Y coordinate. (p)
979	>0026					graphicsCursorPixelsY: .fill 2
980						; &28<80><93>&49 Workspace. But variable &38 must not be used in a Teletext mode (mode 7 or 135).
981						                .union
982	.0028					hlfw: .dstruct HorizontalLineFillWorkspaceVDUVariables
1198	>0028					                .fill 6
1199	.002e					pixelsX:                        ;2e
1200	>002e					                .fill 2
1201	.0030					pixelsY:                        ;30
1202	>0030					                .fill 2
1203	.0032					pixelsRightEndX:
1204	>0032					                .fill 2         ;32
1205	.0034					pixelsLimitX:                   ;34
1206	>0034					                .fill 2
1207						                .endstruct
983	.0028					mocr: .dstruct MoveOrCopyRectangleWorkspaceVDUVariables
1189	.0028					src: .dstruct VDUAABB
1103	.0028					min: .dstruct VDUCoordinate
1098	>0028					x: .fill 2
1099	>002a					y: .fill 2
1100						                .endstruct
1104	.002c					max: .dstruct VDUCoordinate
1098	>002c					x: .fill 2
1099	>002e					y: .fill 2
1100						                .endstruct
1105						                .endstruct
1190	>0030					                .fill 4
1191	.0034					dest: .dstruct VDUAABB
1103	.0034					min: .dstruct VDUCoordinate
1098	>0034					x: .fill 2
1099	>0036					y: .fill 2
1100						                .endstruct
1104	.0038					max: .dstruct VDUCoordinate
1098	>0038					x: .fill 2
1099	>003a					y: .fill 2
1100						                .endstruct
1105						                .endstruct
1192	>003c					                .fill 9
1193	.0045					copy:
1194	>0045					                .fill 1         ;0=move, 2=copy
1195						                .endstruct
984	.0028					workspace: .dstruct GenericWorkspaceVDUVariables
1108	.0028					_28:
1109	>0028					                .fill 1
1110	.0029					_29:
1111	>0029					                .fill 1
1112	.002a					_2A:
1113	>002a					                .fill 1
1114	.002b					_2B:
1115	>002b					                .fill 1
1116	.002c					_2C:
1117	>002c					                .fill 1
1118	.002d					_2D:
1119	>002d					                .fill 1
1120	.002e					_2E:
1121	>002e					                .fill 1
1122	.002f					_2F:
1123	>002f					                .fill 1
1124	.0030					_30:
1125	>0030					                .fill 1
1126	.0031					_31:
1127	>0031					                .fill 1
1128	.0032					_32:
1129	>0032					                .fill 1
1130	.0033					_33:
1131	>0033					                .fill 1
1132	.0034					_34:
1133	>0034					                .fill 1
1134	.0035					_35:
1135	>0035					                .fill 1
1136	.0036					_36:
1137	>0036					                .fill 1
1138	.0037					_37:
1139	>0037					                .fill 1
1140	.0038					_38:
1141	>0038					                .fill 1
1142	.0039					_39:
1143	>0039					                .fill 1
1144	.003a					_3A:
1145	>003a					                .fill 1
1146	.003b					_3B:
1147	>003b					                .fill 1
1148	.003c					_3C:
1149	>003c					                .fill 1
1150	.003d					_3D:
1151	>003d					                .fill 1
1152	.003e					_3E:
1153	>003e					                .fill 1
1154	.003f					_3F:
1155	>003f					                .fill 1
1156	.0040					_40:
1157	>0040					                .fill 1
1158	.0041					_41:
1159	>0041					                .fill 1
1160	.0042					_42:
1161	>0042					                .fill 1
1162	.0043					_43:
1163	>0043					                .fill 1
1164	.0044					_44:
1165	>0044					                .fill 1
1166	.0045					_45:
1167	>0045					                .fill 1
1168	.0046					_46:
1169	>0046					                .fill 1
1170	.0047					_47:
1171	>0047					                .fill 1
1172	.0048					_48:
1173	>0048					                .fill 1
1174	.0049					_49:
1175	>0049					                .fill 1
1176						                .endstruct
985						                .endunion
986						; &4A 2 Address at which the 6845 is to display the text cursor.
987	>004a					textCursorCRTCAddress: .fill 2
988						; &4C 2 Number of bytes in a character row of the text window.
989	>004c					textWindowWidthInBytes: .fill 2
990						; &4E 1 Most significant byte of address of first byte of screen memory.
991	>004e					startScreenAddressHighByte: .fill 1
992						; &4F 1 Number of bytes in a character.
993	>004f					bytesPerCharacter: .fill 1
994						; &50 2 Address of byte in top left corner of screen display.
995	>0050					screenTopLeftAddress: .fill 2
996						; &52 2 Number of bytes in a character row of the whole screen.
997	>0052					bytesPerCharacterRow: .fill 2
998						; &54 1 Most significant byte of number of bytes of screen memory.
999	>0054					screenSizeHighByte: .fill 1
1000						; &55 1 Current screen mode (in range 0<80><93>7, i.e. without regard to <80><98>shadowing<80><99>).
1001	>0055					currentScreenMODE: .fill 1
1002						; &56 1 Memory mode: 0 for 20K modes, 1 for 16K modes, 2 for 10K modes, 3 for 8K modes, 4 for 1K modes.
1003	>0056					currentScreenMODEGroup: .fill 1
1004						; &57 1 Foreground text colour mask.
1005	>0057					foregroundTextColour: .fill 1
1006						; &58 1 Background text colour mask.
1007	>0058					backgroundTextColour: .fill 1
1008						; &59 1 0 if plotting graphics foreground, 8 if plotting graphics background.
1009	>0059					graphicsPlotState: .fill 1
1010						; &5A 1 Current graphics plot mode (usually set to one of following two reduced mod 16).
1011	>005a					graphicsPlotMode: .fill 1
1012						; &5B 1 Current graphics foreground plot mode (as set by VDU 18).
1013	>005b					foregroundGCOLMode: .fill 1
1014						; &5C 1 Current graphics background plot mode (as set by VDU 18).
1015	>005c					backgroundGCOLMode: .fill 1
1016						; &5D 2 Address of routine to process current VDU sequence.
1017	>005d					jumpVector: .fill 2
1018						; &5F 1 Value for 6845 register 10 to revert to on leaving cursor editing.
1019	>005f					lastCursorStartRegisterValue: .fill 1
1020						; &60 1 (Number of logical colours)<88><92>1 (0 if Teletext).
1021	>0060					numberOfLogicalColoursMinusOne: .fill 1
1022						; &61 1 (Number of pixels/byte)<88><92>1 (0 if not graphics).
1023	>0061					pixelsPerByteMinusOne: .fill 1
1024						; &62 1 Mask for leftmost pixel in a byte.
1025	>0062					colourMaskLeft: .fill 1
1026						; &63 1 Mask for rightmost pixel in a byte.
1027	>0063					colourMaskRight: .fill 1
1028						; &64 1 Output cursor X coordinate when cursor editing, but input cursor X coordinate when cursor editing and inside an <80><98>unknown PLOT codes<80><99> routine.
1029	>0064					editCursorXPosition: .fill 1
1030						; &65 1 Output cursor Y coordinate when cursor editing, but input cursor Y coordinate when cursor editing and inside an <80><98>unknown PLOT codes<80><99> routine.
1031	>0065					editCursorYPosition: .fill 1
1032						; &66 1 Cursor control flags (as set by VDU 23 16).
1033	.0066					cursorFlags: .block
1034	>0066					                .fill 1
1035						; MasRef E.3-18
1036	=$40					noSpecialVDU5Actions=$40
1037	=$20					noMoveCursorAfterPrint=$20
1038	=$10					noVerticalScroll=$10
1039	=$08					swapAxes=$08                    ;if set, X=vert; if clear, X=horiz
1040	=$04					invertVertical=$04              ;if set, vert=up; if clear, vert=down
1041	=$02					invertHorizontal=$02            ;if set, horiz=left; if clear, horiz=right
1042	=$01					scrollProtect=$01
1043						                .endblock
1044						; &67 1 Dot pattern (as set by VDU 23 6).
1045	>0067					dotPattern: .fill 1
1046						; &68 1 Current state of dot pattern.
1047	>0068					dotPatternState: .fill 1
1048						; &69 1 0 if colour being plotted is solid, non-zero if colour is an ECF
1049	>0069					isColourECF: .fill 1
1050						; &6A 1 0 if graphics foreground colour is solid, non-zero if foreground colour is an ECF
1051	>006a					isForegroundECF: .fill 1
1052						; &6B 1 0 if graphics background colour is solid, non-zero if background colour is an ECF
1053	>006b					isBackgroundECF: .fill 1
1054						; &6C 1 Top bit set when cursor is in "column 81".
1055	>006c					column81: .fill 1
1056						; &6D 1 Current graphics foreground colour (as set by VDU 18).
1057	>006d					foregroundGraphicsColour: .fill 1
1058						; &6E 1 Current graphics background colour (as set by VDU 18)
1059	>006e					backgroundGraphicsColour: .fill 1
1060						; &6F<80><93>&7E Software copy of the current palette.
1061	>006f					currentPalette: .fill 16
1062						; &7F 1 Reserved.
1063	>007f					reserved: .fill 1
1064						                .endstruct

1066						                .virtual $300
1067	.0300					vduv: .dstruct VDUVariables
932	.0300					graphicsWindow:
933						;graphicsWindowLeftBottom:
934						; &00 2 Graphics window left column. (p)
935	>0300					graphicsWindowPixelsLeft: .fill 2
936						; &02 2 Graphics window bottom row. (p)
937	>0302					graphicsWindowPixelsBottom: .fill 2
938						;graphicsWindowRightTop:
939						; &04 2 Graphics window right column. (p)
940	>0304					graphicsWindowPixelsRight: .fill 2
941						; &06 2 Graphics window top row. (p)
942	>0306					graphicsWindowPixelsTop: .fill 2
943	.0308					textWindow:
944						; &08 1 Text window left column.
945	>0308					textWindowLeft: .fill 1
946						; &09 1 Text window bottom row.
947	>0309					textWindowBottom: .fill 1
948						; &0A 1 Text window right column.
949	>030a					textWindowRight: .fill 1
950						; &0B 1 Text window top row.
951	>030b					textWindowTop: .fill 1
952						; &0C 2 Graphics origin X coordinate. (e)
953	>030c					graphicsWindowOriginX: .fill 2
954						; &0E 2 Graphics origin Y coordinate. (e)
955	>030e					graphicsWindowOriginY: .fill 2
956						; &10 2 Graphics cursor X coordinate. (e)
957	>0310					graphicsCursorPositionX: .fill 2
958						; &12 2 Graphics cursor Y coordinate. (e)
959	>0312					graphicsCursorPositionY: .fill 2
960						; &14 2 Previous graphics cursor X coordinate. (p)
961	.0314					oldGraphicsCursorPixels:
962	>0314					oldGraphicsCursorPixelsX: .fill 2
963						; &16 2 Previous graphics cursor Y coordinate. (p)
964	>0316					oldGraphicsCursorPixelsY: .fill 2
965						; &18 1 Text cursor X coordinate (from left of screen) when not cursor editing. When cursor editing, normally the input cursor X coordinate, but the output cursor X coordinate within an <80><9C>unknown PLOT codes<80><9D> routine.
966	>0318					textCursorXPosition: .fill 1
967						; &19 1 Text cursor Y coordinate (from top of screen) when not cursor editing. When cursor editing, normally t.lsthe input cursor Y coordinate, but the output cursor Y coordinate within an <80><9C>unknown PLOT codes<80><9D> routine.
968	>0319					textCursorYPosition: .fill 1
969						; &1A 1 Y produced by GADDR (see next section) so that (ZMEMG),Y addresses the correct byte.
970	>031a					graphicsAddressOffset: .fill 1
971						; &1B<80><93>&23 VDU queue: &23 contains last byte of queue, other bytes immediately precede it.
972	=9					queueSize=9
973	>031b					queueBegin: .fill queueSize
974	.0324					queueEnd:
975	.0324					graphicsCursorPixels:
976						; &24 2 Graphics cursor X coordinate. (p)
977	>0324					graphicsCursorPixelsX: .fill 2
978						; &26 2 Graphics cursor Y coordinate. (p)
979	>0326					graphicsCursorPixelsY: .fill 2
980						; &28<80><93>&49 Workspace. But variable &38 must not be used in a Teletext mode (mode 7 or 135).
981						                .union
982	.0328					hlfw: .dstruct HorizontalLineFillWorkspaceVDUVariables
1198	>0328					                .fill 6
1199	.032e					pixelsX:                        ;2e
1200	>032e					                .fill 2
1201	.0330					pixelsY:                        ;30
1202	>0330					                .fill 2
1203	.0332					pixelsRightEndX:
1204	>0332					                .fill 2         ;32
1205	.0334					pixelsLimitX:                   ;34
1206	>0334					                .fill 2
1207						                .endstruct
983	.0328					mocr: .dstruct MoveOrCopyRectangleWorkspaceVDUVariables
1189	.0328					src: .dstruct VDUAABB
1103	.0328					min: .dstruct VDUCoordinate
1098	>0328					x: .fill 2
1099	>032a					y: .fill 2
1100						                .endstruct
1104	.032c					max: .dstruct VDUCoordinate
1098	>032c					x: .fill 2
1099	>032e					y: .fill 2
1100						                .endstruct
1105						                .endstruct
1190	>0330					                .fill 4
1191	.0334					dest: .dstruct VDUAABB
1103	.0334					min: .dstruct VDUCoordinate
1098	>0334					x: .fill 2
1099	>0336					y: .fill 2
1100						                .endstruct
1104	.0338					max: .dstruct VDUCoordinate
1098	>0338					x: .fill 2
1099	>033a					y: .fill 2
1100						                .endstruct
1105						                .endstruct
1192	>033c					                .fill 9
1193	.0345					copy:
1194	>0345					                .fill 1         ;0=move, 2=copy
1195						                .endstruct
984	.0328					workspace: .dstruct GenericWorkspaceVDUVariables
1108	.0328					_28:
1109	>0328					                .fill 1
1110	.0329					_29:
1111	>0329					                .fill 1
1112	.032a					_2A:
1113	>032a					                .fill 1
1114	.032b					_2B:
1115	>032b					                .fill 1
1116	.032c					_2C:
1117	>032c					                .fill 1
1118	.032d					_2D:
1119	>032d					                .fill 1
1120	.032e					_2E:
1121	>032e					                .fill 1
1122	.032f					_2F:
1123	>032f					                .fill 1
1124	.0330					_30:
1125	>0330					                .fill 1
1126	.0331					_31:
1127	>0331					                .fill 1
1128	.0332					_32:
1129	>0332					                .fill 1
1130	.0333					_33:
1131	>0333					                .fill 1
1132	.0334					_34:
1133	>0334					                .fill 1
1134	.0335					_35:
1135	>0335					                .fill 1
1136	.0336					_36:
1137	>0336					                .fill 1
1138	.0337					_37:
1139	>0337					                .fill 1
1140	.0338					_38:
1141	>0338					                .fill 1
1142	.0339					_39:
1143	>0339					                .fill 1
1144	.033a					_3A:
1145	>033a					                .fill 1
1146	.033b					_3B:
1147	>033b					                .fill 1
1148	.033c					_3C:
1149	>033c					                .fill 1
1150	.033d					_3D:
1151	>033d					                .fill 1
1152	.033e					_3E:
1153	>033e					                .fill 1
1154	.033f					_3F:
1155	>033f					                .fill 1
1156	.0340					_40:
1157	>0340					                .fill 1
1158	.0341					_41:
1159	>0341					                .fill 1
1160	.0342					_42:
1161	>0342					                .fill 1
1162	.0343					_43:
1163	>0343					                .fill 1
1164	.0344					_44:
1165	>0344					                .fill 1
1166	.0345					_45:
1167	>0345					                .fill 1
1168	.0346					_46:
1169	>0346					                .fill 1
1170	.0347					_47:
1171	>0347					                .fill 1
1172	.0348					_48:
1173	>0348					                .fill 1
1174	.0349					_49:
1175	>0349					                .fill 1
1176						                .endstruct
985						                .endunion
986						; &4A 2 Address at which the 6845 is to display the text cursor.
987	>034a					textCursorCRTCAddress: .fill 2
988						; &4C 2 Number of bytes in a character row of the text window.
989	>034c					textWindowWidthInBytes: .fill 2
990						; &4E 1 Most significant byte of address of first byte of screen memory.
991	>034e					startScreenAddressHighByte: .fill 1
992						; &4F 1 Number of bytes in a character.
993	>034f					bytesPerCharacter: .fill 1
994						; &50 2 Address of byte in top left corner of screen display.
995	>0350					screenTopLeftAddress: .fill 2
996						; &52 2 Number of bytes in a character row of the whole screen.
997	>0352					bytesPerCharacterRow: .fill 2
998						; &54 1 Most significant byte of number of bytes of screen memory.
999	>0354					screenSizeHighByte: .fill 1
1000						; &55 1 Current screen mode (in range 0<80><93>7, i.e. without regard to <80><98>shadowing<80><99>).
1001	>0355					currentScreenMODE: .fill 1
1002						; &56 1 Memory mode: 0 for 20K modes, 1 for 16K modes, 2 for 10K modes, 3 for 8K modes, 4 for 1K modes.
1003	>0356					currentScreenMODEGroup: .fill 1
1004						; &57 1 Foreground text colour mask.
1005	>0357					foregroundTextColour: .fill 1
1006						; &58 1 Background text colour mask.
1007	>0358					backgroundTextColour: .fill 1
1008						; &59 1 0 if plotting graphics foreground, 8 if plotting graphics background.
1009	>0359					graphicsPlotState: .fill 1
1010						; &5A 1 Current graphics plot mode (usually set to one of following two reduced mod 16).
1011	>035a					graphicsPlotMode: .fill 1
1012						; &5B 1 Current graphics foreground plot mode (as set by VDU 18).
1013	>035b					foregroundGCOLMode: .fill 1
1014						; &5C 1 Current graphics background plot mode (as set by VDU 18).
1015	>035c					backgroundGCOLMode: .fill 1
1016						; &5D 2 Address of routine to process current VDU sequence.
1017	>035d					jumpVector: .fill 2
1018						; &5F 1 Value for 6845 register 10 to revert to on leaving cursor editing.
1019	>035f					lastCursorStartRegisterValue: .fill 1
1020						; &60 1 (Number of logical colours)<88><92>1 (0 if Teletext).
1021	>0360					numberOfLogicalColoursMinusOne: .fill 1
1022						; &61 1 (Number of pixels/byte)<88><92>1 (0 if not graphics).
1023	>0361					pixelsPerByteMinusOne: .fill 1
1024						; &62 1 Mask for leftmost pixel in a byte.
1025	>0362					colourMaskLeft: .fill 1
1026						; &63 1 Mask for rightmost pixel in a byte.
1027	>0363					colourMaskRight: .fill 1
1028						; &64 1 Output cursor X coordinate when cursor editing, but input cursor X coordinate when cursor editing and inside an <80><98>unknown PLOT codes<80><99> routine.
1029	>0364					editCursorXPosition: .fill 1
1030						; &65 1 Output cursor Y coordinate when cursor editing, but input cursor Y coordinate when cursor editing and inside an <80><98>unknown PLOT codes<80><99> routine.
1031	>0365					editCursorYPosition: .fill 1
1032						; &66 1 Cursor control flags (as set by VDU 23 16).
1033	.0366					cursorFlags: .block
1034	>0366					                .fill 1
1035						; MasRef E.3-18
1036	=$40					noSpecialVDU5Actions=$40
1037	=$20					noMoveCursorAfterPrint=$20
1038	=$10					noVerticalScroll=$10
1039	=$08					swapAxes=$08                    ;if set, X=vert; if clear, X=horiz
1040	=$04					invertVertical=$04              ;if set, vert=up; if clear, vert=down
1041	=$02					invertHorizontal=$02            ;if set, horiz=left; if clear, horiz=right
1042	=$01					scrollProtect=$01
1043						                .endblock
1044						; &67 1 Dot pattern (as set by VDU 23 6).
1045	>0367					dotPattern: .fill 1
1046						; &68 1 Current state of dot pattern.
1047	>0368					dotPatternState: .fill 1
1048						; &69 1 0 if colour being plotted is solid, non-zero if colour is an ECF
1049	>0369					isColourECF: .fill 1
1050						; &6A 1 0 if graphics foreground colour is solid, non-zero if foreground colour is an ECF
1051	>036a					isForegroundECF: .fill 1
1052						; &6B 1 0 if graphics background colour is solid, non-zero if background colour is an ECF
1053	>036b					isBackgroundECF: .fill 1
1054						; &6C 1 Top bit set when cursor is in "column 81".
1055	>036c					column81: .fill 1
1056						; &6D 1 Current graphics foreground colour (as set by VDU 18).
1057	>036d					foregroundGraphicsColour: .fill 1
1058						; &6E 1 Current graphics background colour (as set by VDU 18)
1059	>036e					backgroundGraphicsColour: .fill 1
1060						; &6F<80><93>&7E Software copy of the current palette.
1061	>036f					currentPalette: .fill 16
1062						; &7F 1 Reserved.
1063	>037f					reserved: .fill 1
1064						                .endstruct
1068						                .endvirtual

1070						; vduQueueItemAddr: .function index
1071						;                 .cerror index<0||index>=vdu.queueSize,"bad VDU queue index"
1072						;                 .endfunction vdu.queue+vdu.queueSize-1-index

1074						; Presumed addresses in ANDY that don't happen to coincide with other
1075						; labels.
1076						;
1077						; MasRef E.4-5, MasRef F.6-10
1078						;
1079						; &8000-83FF  RAM  Soft key expansions buffer
1080						; &8400<80><93>87FF  RAM  VDU workspace.
1081						; &8800<80><93>07    RAM  ECF pattern 1 definition.
1082						; &8808<80><93>0F    RAM  ECF pattern 2 definition.
1083						; &8810<80><93>17    RAM  ECF pattern 3 definition.
1084						; &8818<80><93>1F    RAM  ECF pattern 4 definition.
1085						; &8820<80><93>27    RAM  Current foreground ECF pattern or solid colour.
1086						; &8828<80><93>2F    RAM  Current background ECF pattern or solid colour.
1087						; &8830<80><93>BF    RAM  VDU workspace.
1088						; &88C0<80><93>FF    RAM  Reserved for future expansion.
1089						; &8900<80><93>FF    RAM  Current definitions of characters &20<80><93>3F.
1090						; &8A00<80><93>FF    RAM  Current definitions of characters &40<80><93>5F.
1091						; &8B00<80><93>FF    RAM  Current definitions of characters &60<80><93>7F.
1092						; &8C00<80><93>FF    RAM  Current definitions of characters &80<80><93>9F.
1093						; &8D00<80><93>FF    RAM  Current definitions of characters &A0<80><93>BF.
1094						; &8E00<80><93>FF    RAM  Current definitions of characters &C0<80><93>DF.
1095						; &8F00<80><93>FF    RAM  Current definitions of characters &E0<80><93>FF.

1097						VDUCoordinate: .struct
1098	>0000					x: .fill 2
1099	>0002					y: .fill 2
1100						                .endstruct

1102						VDUAABB: .struct
1103	.0000					min: .dstruct VDUCoordinate
1098	>0000					x: .fill 2
1099	>0002					y: .fill 2
1100						                .endstruct
1104	.0004					max: .dstruct VDUCoordinate
1098	>0004					x: .fill 2
1099	>0006					y: .fill 2
1100						                .endstruct
1105						                .endstruct

1107						GenericWorkspaceVDUVariables: .struct
1108	.0000					_28:
1109	>0000					                .fill 1
1110	.0001					_29:
1111	>0001					                .fill 1
1112	.0002					_2A:
1113	>0002					                .fill 1
1114	.0003					_2B:
1115	>0003					                .fill 1
1116	.0004					_2C:
1117	>0004					                .fill 1
1118	.0005					_2D:
1119	>0005					                .fill 1
1120	.0006					_2E:
1121	>0006					                .fill 1
1122	.0007					_2F:
1123	>0007					                .fill 1
1124	.0008					_30:
1125	>0008					                .fill 1
1126	.0009					_31:
1127	>0009					                .fill 1
1128	.000a					_32:
1129	>000a					                .fill 1
1130	.000b					_33:
1131	>000b					                .fill 1
1132	.000c					_34:
1133	>000c					                .fill 1
1134	.000d					_35:
1135	>000d					                .fill 1
1136	.000e					_36:
1137	>000e					                .fill 1
1138	.000f					_37:
1139	>000f					                .fill 1
1140	.0010					_38:
1141	>0010					                .fill 1
1142	.0011					_39:
1143	>0011					                .fill 1
1144	.0012					_3A:
1145	>0012					                .fill 1
1146	.0013					_3B:
1147	>0013					                .fill 1
1148	.0014					_3C:
1149	>0014					                .fill 1
1150	.0015					_3D:
1151	>0015					                .fill 1
1152	.0016					_3E:
1153	>0016					                .fill 1
1154	.0017					_3F:
1155	>0017					                .fill 1
1156	.0018					_40:
1157	>0018					                .fill 1
1158	.0019					_41:
1159	>0019					                .fill 1
1160	.001a					_42:
1161	>001a					                .fill 1
1162	.001b					_43:
1163	>001b					                .fill 1
1164	.001c					_44:
1165	>001c					                .fill 1
1166	.001d					_45:
1167	>001d					                .fill 1
1168	.001e					_46:
1169	>001e					                .fill 1
1170	.001f					_47:
1171	>001f					                .fill 1
1172	.0020					_48:
1173	>0020					                .fill 1
1174	.0021					_49:
1175	>0021					                .fill 1
1176						                .endstruct

1178						HorizontalLineFillWorkspaceZP: .struct
1179	>0000					notByteMatch: .fill 1
1180	>0001					a: .fill 1
1181	>0002					b: .fill 2
1182						;c: .fill 2
1183	>0004					pixelsX: .fill 2
1184	>0006					d: .fill 1
1185	>0007					resultEOR: .fill 1
1186						                .endstruct

1188						MoveOrCopyRectangleWorkspaceVDUVariables: .struct
1189	.0000					src: .dstruct VDUAABB
1103	.0000					min: .dstruct VDUCoordinate
1098	>0000					x: .fill 2
1099	>0002					y: .fill 2
1100						                .endstruct
1104	.0004					max: .dstruct VDUCoordinate
1098	>0004					x: .fill 2
1099	>0006					y: .fill 2
1100						                .endstruct
1105						                .endstruct
1190	>0008					                .fill 4
1191	.000c					dest: .dstruct VDUAABB
1103	.000c					min: .dstruct VDUCoordinate
1098	>000c					x: .fill 2
1099	>000e					y: .fill 2
1100						                .endstruct
1104	.0010					max: .dstruct VDUCoordinate
1098	>0010					x: .fill 2
1099	>0012					y: .fill 2
1100						                .endstruct
1105						                .endstruct
1192	>0014					                .fill 9
1193	.001d					copy:
1194	>001d					                .fill 1         ;0=move, 2=copy
1195						                .endstruct

1197						HorizontalLineFillWorkspaceVDUVariables: .struct
1198	>0000					                .fill 6
1199	.0006					pixelsX:                        ;2e
1200	>0006					                .fill 2
1201	.0008					pixelsY:                        ;30
1202	>0008					                .fill 2
1203	.000a					pixelsRightEndX:
1204	>000a					                .fill 2         ;32
1205	.000c					pixelsLimitX:                   ;34
1206	>000c					                .fill 2
1207						                .endstruct

1209						HorizontalLineFillWorkspaceANDY: .struct
1210	>0000					ecfPattern: .fill 8
1211						                .endstruct

1213	=16					softKeyCount=16
1214	=$400					softKeyDataTotalSize=$400

1216						                .virtual $8000
1217	.8000					andy: .block
1218	.8000					softKeys: .block
1219	>8000					stringLSBs: .fill softKeyCount
1220	>8010					endLSB: .fill 1
1221	>8011					stringMSBs: .fill softKeyCount
1222	>8021					endMSB: .fill 1
1223	.8022					strings:
1224	>8022					                .fill softKeys+$400-*
1225	.8400					end:
1226						                .endblock
1227	>8400					                .fill $8800-*;(softKeyCount*2+1)
1228	.8800					ecfPatterns:
1229	>8800					ecfPattern1: .fill 8
1230	>8808					ecfPattern2: .fill 8
1231	>8810					ecfPattern3: .fill 8
1232	>8818					ecfPattern4: .fill 8
1233	.8820					currentECFPatterns:
1234	>8820					fgECFPattern: .fill 8
1235	>8828					bgECFPattern: .fill 8
1236	.8830					workspace:
1237						                .union
1238	.8830					hlfw: .dstruct HorizontalLineFillWorkspaceANDY
1210	>8830					ecfPattern: .fill 8
1211						                .endstruct
1239	>8830					                .fill 208
1240						                .endunion
1241	.8900					softCharacterDefinitions:
1242	>8900					                .fill (256-32)*8
1243						                .cerror (<andy.softCharacterDefinitions)!=0,"Soft character definitions must be page aligned"
1244						                .cerror *!=$9000,"ANDY is the wrong size"
1245						                .endblock
1246						                .endvirtual


1249	=$8000					L8000=$8000
1250	=$8001					L8001=$8001
1251	=$8002					L8002=$8002
1252	=$8004					L8004=$8004
1253	=$8010					L8010=$8010
1254	=$8011					L8011=$8011
1255	=$8012					L8012=$8012
1256						                ;l8011=$8011
1257						                ;l8012=$8012
1258	=$8021					L8021=$8021

1260						; see $d40d, $d4ae
1261						;
1262						; (suspect these are actually references to $8840-$104 and $8848-$104)
1263	=$873c					L873C=$873c
1264	=$8744					L8744=$8744

1266	=$8400					L8400=$8400
1267	=$8500					L8500=$8500
1268	=$8600					L8600=$8600
1269	=$8700					L8700=$8700
1270	=$87f8					L87F8=$87f8
1271	=$87ff					L87FF=$87FF
1272	=$8800					L8800=$8800
1273	=$8803					L8803=$8803
1274	=$8804					L8804=$8804
1275	=$881e					L881E=$881E
1276	=$8820					L8820=$8820
1277	=$8830					L8830=$8830
1278	=$8831					L8831=$8831
1279	=$8832					L8832=$8832
1280	=$8833					L8833=$8833
1281	=$8834					L8834=$8834
1282	=$8835					L8835=$8835
1283	=$8836					L8836=$8836
1284	=$8837					L8837=$8837
1285	=$8838					L8838=$8838
1286	=$8839					L8839=$8839
1287	=$883a					L883A=$883a
1288	=$883b					L883B=$883b
1289	=$883c					L883C=$883C
1290	=$883d					L883D=$883D
1291	=$883e					L883E=$883e
1292	=$883f					L883F=$883f
1293	=$8840					L8840=$8840
1294	=$8841					L8841=$8841
1295	=$8842					L8842=$8842
1296	=$8843					L8843=$8843
1297	=$8844					L8844=$8844
1298	=$8845					L8845=$8845
1299	=$8846					L8846=$8846
1300	=$8847					L8847=$8847
1301	=$8848					L8848=$8848
1302	=$8849					L8849=$8849
1303	=$884a					L884A=$884a
1304	=$884b					L884B=$884b
1305	=$884c					L884C=$884c
1306	=$884d					L884D=$884d
1307	=$884e					L884E=$884e

1309						                ; written to during startup
1310	=$fe8e					LFE8E=$fe8e

1312						;-------------------------------------------------------------------------

1314						                .virtual $00
1315						                .union
1316	.0000					tubeOSFILEParameterBlock: .dstruct OSFILEParameterBlock
288	.0000					fileName:
289	>0000					                .fill 2
290	.0002					addresses:
291	.0002					load:
292	>0002					                .fill 4
293	.0006					exec:
294	>0006					                .fill 4
295	.000a					length:
296	.000a					saveStart:
297	>000a					                .fill 4
298	.000e					attributes:
299	.000e					saveEnd:
300	>000e					                .fill 4
301						                .endstruct
1317	.0000					tubeOSGBPBParameterBlock: .dstruct OSGBPBParameterBlock
257	.0000					handle:
258	>0000					                .fill 1
259	.0001					address:
260	>0001					                .fill 4
261	.0005					count:
262	>0005					                .fill 4
263	.0009					ptr:
264	>0009					                .fill 4
265						                .endstruct
1318	>0000					tubeLanguageHostAddr: .fill 2
1319						                .endunion
1320	>0012					tubeTransferAddr: .fill 2
1321	>0014					tubeNotClaimed: .fill 1            ;bit 7 clear if tube claimed
1322	>0015					tubeClaimantID: .fill 1
1323	.0016					tubeBrkHandlerAddr:
1324						                ; Tube BRK handler sits here.
1325						                .endv

1327	=$700					tubeStringBuffer=$700
1328	=$0128					tubeOSWORDBuffer=$0128

1330						;-------------------------------------------------------------------------

1332						                .virtual $53
1333	>0053					tubeLanguageParasiteAddr: .fill 4
1334						                .endv

1336						; MasRef E.4-4
1337						                .virtual $d0
1338	.00d0					STATE: .block
1339	>00d0					                .fill 1
1340						                ; D.2-32
1341	=$01					isPrinterEnabled=$01
1342	=$02					isScrollingDisabled=$02
1343	=$04					isPagedScrolling=$04
1344	=$08					isTextWindow=$08
1345	=$10					isShadowMode=$10
1346	=$20					isVDU5=$20
1347	=$40					isCursorEditing=$40
1348	=$80					isVDU21=$80
1349						                .bend

1351	>00d1					ZMASK: .fill 1                       ;Pixel mask
1352	>00d2					ZORA: .fill 1                        ;Text OR mask
1353	>00d3					ZEOR: .fill 1                        ;Text EOR mask
1354	>00d4					ZGORA: .fill 1                       ;Graphics OR mask
1355	>00d5					ZGEOR: .fill 1                       ;Graphics EOR mask
1356	>00d6					ZMEMG: .fill 2                       ;Graphics pointer
1357	>00d8					ZMEMT: .fill 2                       ;Text pointer
1358	>00da					ZTEMP: .fill 2                       ;Temporary space
1359	>00dc					ZTEMPB: .fill 2                      ;Temporary space
1360	>00de					ZTEMPC: .fill 2                      ;Temporary space
1361	>00e0					ZTEMPD: .fill 2                      ;Temporary space
1362						                .endv

1364						                .virtual ZTEMP
1365	.00da					zhlfw: .dstruct HorizontalLineFillWorkspaceZP
1179	>00da					notByteMatch: .fill 1
1180	>00db					a: .fill 1
1181	>00dc					b: .fill 2
1182						;c: .fill 2
1183	>00de					pixelsX: .fill 2
1184	>00e0					d: .fill 1
1185	>00e1					resultEOR: .fill 1
1186						                .endstruct
1366						                .endv


1369	=$f8					softKeyExpansionPtr=$f8       ;pointer to current char when expanding soft key.
1370	=$fa					SEIWKA=$fa
1371	=$fb					SEIWKB=$fb

1373	=$d8					vduWriteCursor=$d8

1375	=$d00					nmiEntryPoint=$d00

1377	=0					gcolModeOverwrite=0
1378	=1					gcolModeOR=1
1379	=2					gcolModeAND=2
1380	=3					gcolModeEOR=3
1381	=4					gcolModeInvert=4
1382	=5					gcolModeLeave=5

1384						;-------------------------------------------------------------------------

1386						StarKEYWorkspace: .struct
1387	>0000					newStringLength: .fill 1
1388	>0001					destPtr: .fill 2
1389	>0003					srcPtr: .fill 2
1390	>0005					counter: .fill 2
1391						                .endstruct

1393						OSGBPBWorkspace: .struct
1394	>0000					ptr: .fill 2
1395						                .endstruct

1397						ParseFileNameFSWorkspace: .struct
1398	>0000					fsInfoOffset: .fill 1
1399						                .endstruct

1401						OSCLIWorkspace: .struct
1402	>0000					tablePtr: .fill 2
1403						                .endstruct

1405						                ; TODO - could do being renamed, as it's used (in the
1406						                ; same way) by *UNPLUG and *INSERT.
1407						StarROMSWorkspace: .struct
1408	>0000					insertedFlagMask: .fill 1
1409						                .endstruct

1411						TerminalHELPWorkspace: .struct
1412	>0000					tablePtr: .fill 2
1413						                .endstruct

1415						                ; TODO - tediously verbose names. Acronyms work well
1416						                ; enough for the VDU variables. Do the same thing
1417						                ; here.
1418						                .virtual $b0
1419						                .union
1420	.00b0					starKEYWorkspace: .dstruct StarKEYWorkspace
1387	>00b0					newStringLength: .fill 1
1388	>00b1					destPtr: .fill 2
1389	>00b3					srcPtr: .fill 2
1390	>00b5					counter: .fill 2
1391						                .endstruct
1421	.00b0					osgbpbWorkspace: .dstruct OSGBPBWorkspace
1394	>00b0					ptr: .fill 2
1395						                .endstruct
1422	.00b0					parseFileNameFSWorkspace: .dstruct ParseFileNameFSWorkspace
1398	>00b0					fsInfoOffset: .fill 1
1399						                .endstruct
1423	.00b0					oscliWorkspace: .dstruct OSCLIWorkspace
1402	>00b0					tablePtr: .fill 2
1403						                .endstruct
1424	.00b0					starROMSWorkspace: .dstruct StarROMSWorkspace
1408	>00b0					insertedFlagMask: .fill 1
1409						                .endstruct
1425	.00b0					terminalHELPWorkspace: .dstruct TerminalHELPWorkspace
1412	>00b0					tablePtr: .fill 2
1413						                .endstruct
1426						                .endunion
1427						                .endvirtual

1429						;-------------------------------------------------------------------------

1431						; ROM number containing Terminal
1432	=15					terminalROM=15

1434						; ROM number containing the extXXXX entry points
1435						                .if version==320
1439						                .elsif version>=400
1440	=15					extROM=15
1441						                .endif

1443						; Base page for VDU routines
1444	=$c0					vduRoutinesPage=$c0

1446						                .if version<500
1448						                .elsif version>=500
1449	=0					cmosBytesOffset=0
1450						                .endif

1452						CMOSBytes: .struct
1453	>0000					econetStationNumber: .fill 1
1454	>0001					fileServerStationNumber: .fill 1
1455	>0002					fileServerNetworkNumber: .fill 1
1456	>0003					printerServerStationNumber: .fill 1
1457	>0004					printerServerNetworkNumber: .fill 1
1458	.0005					defaultROMs: .block
1459	>0005					                .fill 1
1460	=0					fsShift=0
1461	=4					languageShift=4
1462						                .endblock

1464	>0006					insertedROMs: .fill 2

1466	>0008					editROMByte: .fill 1
1467	>0009					telecommsByte: .fill 1

1469						                ; TODO - don't need to say "default" so much...
1470	.000a					defaults0: .block
1471	>000a					                .fill 1
1472	=7					defaultMODEMask=7
1473	=8					defaultSHADOWMask=8
1474	=16					defaultInterlaceMask=16
1475	=7					defaultTVMask=7
1476	=5					defaultTVShift=5
1477						                .endblock

1479	.000b					defaults1: .block
1480	>000b					                .fill 1
1481	=7					defaultFDRIVEMask=7
1482	=8					defaultShiftLockMask=8
1483	=16					defaultNoLockMask=16
1484	=32					defaultCapsLockMask=32
1485	=64					defaultADFSLoadDirMask=64
1486	=128					defaultFloppyDrive=128
1487						                .endblock

1489	>000c					keyboardAutoRepeatDelay: .fill 1
1490	>000d					keyboardAutoRepeatRate: .fill 1
1491	>000e					printerIgnoreChar: .fill 1

1493	.000f					defaults2: .block
1494	>000f					                .fill 1
1495	=1					tubeOnMask=1
1496	=2					usePrinterIgnoreCharMask=2
1497	=7					serialBaudRateIndexMask=7
1498	=2					serialBaudRateIndexShift=2
1499	=7					fx5SettingMask=7
1500	=5					fx5SettingShift=5
1501						                .endblock

1503	.0010					defaults3: .block
1504	>0010					                .fill 1
1505	=2					loudMask=2
1506	=4					extTubeMask=4
1507	=8					protectedScrollingMask=8
1508	=16					autoBootMask=16
1509	=7					defaultSerialDataFormatMask=7
1510	=5					defaultSerialDataFormatShift=5
1511						                .endblock

1513						                .if version>=500
1514						                ; Purpose currently unknown. Is it even used?
1515	.0011					unknown11:
1516	>0011					                .fill 1

1518	.0012					joystick: .block
1519	=$f					stickMask=$f
1520	=32					isSwitchedMask=32
1521	>0012					                .fill 1
1522						                .endblock

1524						                .if version>=511||olivetti
1531						                .endif
1532						                .endif

1534						                .endstruct

1536	=$ef					originalA=$ef
1537	=$f0					originalX=$f0
1538	=$f1					originalY=$f1
1539	=$fc					irqTempA=$fc
1540	=$fd					errPtr=$fd                      ;REPTR in OS 1.20
1541	=$ff					escapeFlag=$ff

1543	=$8c0					envelope1Data=$8c0

1545	=$8000					sidewaysROMLanguageEntry=$8000
1546	=$8003					sidewaysROMServiceEntry=$8003
1547						                .virtual $8006
1548	.8006					sidewaysROMType: .block
1549	=32					hasRelocationAddress=32
1550	=64					hasLanguageEntry=64
1551	=128					hasServiceEntry=128
1552						                .endblock
1553						                .endvirtual
1554	=$8007					sidewaysROMCopyrightOffset=$8007
1555	=$8008					sidewaysROMVersion=$8008
1556	=$8009					sidewaysROMName=$8009

1558						;-------------------------------------------------------------------------

1560						                ; [MasRef D.3-22]
1561						ClockStringFormat: .struct
1562	.0000					ddd:
1563	>0000					                .fill 3
1564	>0003					                .fill 1                      ;','
1565	.0004					nn:
1566	>0004					                .fill 2
1567	>0006					                .fill 1                      ;' '
1568	.0007					mmm:
1569	>0007					                .fill 3
1570	>000a					                .fill 1                      ;' '
1571	.000b					yyyy:
1572	>000b					                .fill 4
1573	>000f					                .fill 1                      ;'.'
1574	.0010					hh:
1575	>0010					                .fill 2
1576	>0012					                .fill 1                      ;':'
1577	.0013					mm:
1578	>0013					                .fill 2
1579	>0015					                .fill 1                      ;':'
1580	.0016					ss:
1581	>0016					                .fill 2
1582	.0018					cr:
1583	>0018					                .fill 1                      ;'\n'
1584						                .endstruct

1586						;-------------------------------------------------------------------------

:1	;******  Return to file: mos500.s65

3						                .include "src/terminal_workspace.s65"

:4	;******  Processing file: src/terminal_workspace.s65

1						;-------------------------------------------------------------------------

3						; Not really MOS stuff. This is the Terminal ROM zero page workspace.

5	=$70					oldINSV=$70
6	=$72					oldREMV=$72
7						                .cerror oldREMV!=oldINSV+2,"oldREMV and oldINSV must be adjacent"

9						;-------------------------------------------------------------------------

11						beword .macro value
14						                .endm

16						;-------------------------------------------------------------------------

18						zterm: .struct
19	=$39					numRowsMinusOne=$39
20	=$38					numColumns=$38
21	=$37					numColumnsMinusOne=$37
22						; TODO old INSV and oldREMV should probably go in here too!
23						                .endstruct


:1	;******  Return to file: mos500.s65


5	=500					version=500

7						*=$8000
8						                .dsection utils
9						                .cwarn *>$c000,'utils ROM is too large'

11						*=$c000
12						                .dsection mos
13						                ; there's no need for a size check here - 64tass gives
14						                ; you an error if the code would go past the 64 K
15						                ; barrier.

17						;-------------------------------------------------------------------------

19						; Is there a better way of doing this?
20	=$8fa8					osbyteAndOSWORDRoutineTable=terminal.osbyteAndOSWORDRoutineTable
21	=$aecc					ext=terminal.ext
22	=$f2ca					osbyte14=mos.osbyte14

24						;-------------------------------------------------------------------------

26						                .section utils
27						                .include "src/terminal.s65"

:5	;******  Processing file: src/terminal.s65

1						; -*- comment-column:45; -*-

3	.8000					terminal: .block
4						                .if version==320||version==350
36						                .elsif version>=500

38						                ; Language entry point
39	.8000	00		brk #		                brk
40	.8001	00		brk #		                brk
41	.8002	00		brk #		                brk

43						                ; Service entry point
44	.8003	4c 3c a2	jmp $a23c	                jmp utilsServiceEntryPoint

46	>8006	82				                .byte $82
47	>8007	0e				                .byte copyright-1-terminal
48						                .if version==500
49	>8008	00				                .byte 0
58						                .endif
59	>8009	55 54 49 4c 53 00		                .text "UTILS",0
60	.800f					copyright:
61						                .if olivetti
63						                .else
64	>800f	28 43 29 31 39 38 36 20		                .text "(C)1986 Acorn",0
	>8017	41 63 6f 72 6e 00
65						                .endif
66						                .endif

68						;-------------------------------------------------------------------------

70						                .if version==350
75						                .endif

77						;-------------------------------------------------------------------------

79						                .if version==350
84						                .endif

86						;-------------------------------------------------------------------------

88						                .if version==350
93						                .endif

95						;-------------------------------------------------------------------------

97						                .if version==350
106						                .endif

108						;-------------------------------------------------------------------------

110						                .if version==350
123						                .endif

125						;-------------------------------------------------------------------------

127						                .if version==350
137						                .endif

139						;-------------------------------------------------------------------------

141						; STARTUP
142						; =======


145						                .if version==350             ;stripped_out_reset
151						                .else                        ;stripped_out_reset
152	.801d					reset:                          ;8020
153						                .include "reset.s65"

:6	;******  Processing file: src/reset.s65

1						                .if version==350
3						                .endif
4						                .if version!=350
5	.801d	a9 fe		lda #$fe	                lda #~ACCCON.D
6	.801f	1c 34 fe	trb $fe34	                trb ACCCON
7						                .endif
8						                .if version<500
10						                .endif
11						                .if version!=350
12	.8022	1c 66 03	trb $0366	                trb $0366
13						                .endif
14	.8025	d8		cld		                cld
15	.8026	a2 ff		ldx #$ff	                ldx #$FF
16	.8028	9a		txs		                txs              ;reset stack
17	.8029	8e 63 fe	stx $fe63	                stx userVIA.ddra ;port A all outputs
18	.802c	a9 cf		lda #$cf	                lda #%11001111
19	.802e	8d 42 fe	sta $fe42	                sta systemVIA.ddrb
20						                .if version==350
23						                .endif
24						                .if version<500
29						                .endif
30						                .if version!=350
31	.8031	a9 0c		lda #$0c	                lda #ACCCON.Y|ACCCON.X       ; page in HAZEL+shadow
32	.8033	0c 34 fe	tsb $fe34	                tsb ACCCON
33						                .if version>=500
34	.8036	9c dd df	stz $dfdd	                stz hazel.hasACCCONChanged
35	.8039	20 63 83	jsr $8363	                jsr L8363
38						                .endif
42						                .endif
43						                .if version==350
45						                .else
46	.803c	ad 4e fe	lda $fe4e	                lda systemVIA.ier
47						                .endif
48	.803f	0a		asl a		                asl a
49	.8040	48		pha		                pha
50						                .if version==350
100						                .else
101						                .if version<400
111						                .else
112	.8041	d0 2b		bne $806e	                bne nonPowerOnReset
113	.8043	a2 07		ldx #$07	                ldx #7
114	.8045	20 b4 f8	jsr $f8b4	                jsr mos.LF8B4
115						                .if version==400
117						                .else
118	.8048	98		tya		                tya
119						                .endif
120						                .endif
121	.8049					startClearRAM:
122	.8049	a8		tay		                tay             ;Y=0
123	.804a					clearRAM:
124	.804a	98		tya		                tya             ;A=0
125	.804b	64 01		stz $01		                stz $01
126	.804d	64 00		stz $00		                stz $00         ;start at $0000
127	.804f					clearRAMPageLoop:
128	.804f	91 00		sta ($00),y	                sta ($00),y     ;clear RAM
129	.8051	c8		iny		                iny
130	.8052	d0 fb		bne $804f	                bne clearRAMPageLoop
131	.8054	e6 01		inc $01		                inc $01
132	.8056	a2 40		ldx #$40	                ldx #$40          ;$40=RTI
133	.8058	8e 00 0d	stx $0d00	                stx nmiEntryPoint ;restore the RTI previously written,
134						                                  ;as each iteration will potentially
135						                                  ;overwrite it
136	.805b	a6 01		ldx $01		                ldx $01
137	.805d	e0 e0		cpx #$e0	                cpx #$E0        ;hit the end of RAM?
138	.805f	90 ee		bcc $804f	                bcc clearRAMPageLoop ;branch taken if still more to go
139	.8061	a9 04		lda #$04	                lda #ACCCON.X   ;page out shadow RAM
140	.8063	1c 34 fe	trb $fe34	                trb ACCCON
141	.8066	d0 e2		bne $804a	                bne clearRAM    ;branch taken if shadow RAM bit
142						                             ;previously set - i.e., that was the
143						                             ;first iteration, and we need to go back
144						                             ;to do main RAM
145						                .if version>=400
146	.8068	ad 28 fe	lda $fe28	                lda $fe28
147	.806b	ad 2b fe	lda $fe2b	                lda $fe2b
148						                .endif
149						                .endif
150	.806e					nonPowerOnReset:
151						                .if version>=350
152	.806e	ad 58 02	lda $0258	                lda breakAndESCAPEEffect
153	.8071	4a		lsr a		                lsr a
154	.8072	3a		dec a		                dec a
155	.8073	f0 d4		beq $8049	                beq startClearRAM
156						                .endif
157	.8075	a9 3c		lda #$3c	                lda #<mos.emptyCommandLine
158	.8077	8d 04 df	sta $df04	                sta hazel.commandLinePointer+0
159	.807a	a9 e9		lda #$e9	                lda #>mos.emptyCommandLine
160	.807c	8d 05 df	sta $df05	                sta hazel.commandLinePointer+1
161	.807f	a9 0c		lda #$0c	                lda #ACCCON.Y|ACCCON.X ; page in MOS ROM, page in main
162						                                       ; RAM
163						                .if version==350
165						                .else
166	.8081	1c 34 fe	trb $fe34	                trb ACCCON
167						                .endif
168	.8084	a9 0f		lda #$0f	                lda #$0F
169	.8086	8d 8e 02	sta $028e	                sta numericKeypadShiftEffect
170						                .if version<500&&version!=350
176						                .endif
177	.8089	a2 01		ldx #$01	                ldx #key_ctrl
178						                .if version==350
180						                .else
181	.808b	20 f9 f6	jsr $f6f9	                jsr mos.interrogateKeyboard
182						                .endif
183	.808e	e0 80		cpx #$80	                cpx #$80        ;Z=0 C=1 if CTRL+BREAK
184	.8090	20 31 f5	jsr $f531	                jsr mos.updateKeyboardLEDs
185	.8093	9c 8d 02	stz $028d	                stz lastBREAKType            ;softBREAK
186	.8096	6a		ror a		                ror a
187	.8097	a2 9c		ldx #$9c	                ldx #$9c                     ;what is this?
188	.8099	a0 8d		ldy #$8d	                ldy #$8D                     ;what is this?
189	.809b	68		pla		                pla
190	.809c	f0 09		beq $80a7	                beq L80AD
191	.809e	a0 7e		ldy #$7e	                ldy #$7E                     ;what is this?
192	.80a0	90 3c		bcc $80de	                bcc L80DF
193	.80a2	a0 87		ldy #$87	                ldy #$87                     ;what is this?
194	.80a4	ee 8d 02	inc $028d	                inc lastBREAKType
195	.80a7					L80AD:
196	.80a7	ee 8d 02	inc $028d	                inc lastBREAKType
197	.80aa	5a		phy		                phy
198						                .if version==350&&CFA3000
204						                .endif
205						                .if version==350
210						                .else
211	.80ab	20 58 9e	jsr $9e58	                jsr L9E58
212	.80ae	a2 4d		ldx #$4d	                ldx #configureTable.mode.metadata-configureTable;$56
213	.80b0	20 64 8a	jsr $8a64	                jsr readConfigurationByte
214						                .endif
215	.80b3	09 08		ora #$08	                ora #CMOSBytes.defaults0.defaultSHADOWMask
216	.80b5	8d 8f 02	sta $028f	                sta startupOptions
217	.80b8	20 a6 9d	jsr $9da6	                jsr terminal.readDefaults3 ; Read configured BOOT
218	.80bb	29 10		and #$10	                and #CMOSBytes.defaults3.autoBootMask
219	.80bd	4a		lsr a		                lsr a         ; Reset OSBYTE 255 boot bit (b3) if BOOT
220	.80be	1c 8f 02	trb $028f	                trb startupOptions
221						                .if version==350
223						                .else
224	.80c1	20 d6 8b	jsr $8bd6	                jsr terminal.readDefaultTVSettings
225						                .endif
226	.80c4	8c 90 02	sty $0290	                sty tvOffset
227	.80c7	8e 91 02	stx $0291	                stx tvInterlace
228	.80ca	20 a6 9d	jsr $9da6	                jsr terminal.readDefaults3
229	.80cd	29 08		and #$08	                and #CMOSBytes.defaults3.protectedScrollingMask
230	.80cf	f0 02		beq $80d3	                beq L80D4
231	.80d1	a9 01		lda #$01	                lda #VDUVariables.cursorFlags.scrollProtect
232	.80d3					L80D4:
233	.80d3	8d 66 03	sta $0366	                sta vduv.cursorFlags
234	.80d6	20 53 94	jsr $9453	                jsr terminal.restoreFont32To255
235	.80d9	7a		ply		                ply
236	.80da	a2 92		ldx #$92	                ldx #$92
237	.80dc	80 1b		bra $80f9	                bra initializePage2Loop
238	.80de					L80DF:
239						                .if version>=500
240	.80de	20 58 9e	jsr $9e58	                jsr L9E58
241						                .endif
242	.80e1	a9 87		lda #$87	                lda #$87             ; Clear MODE bits from OSBYTE 255
243	.80e3	1c 8f 02	trb $028f	                trb startupOptions
244	.80e6	ad 55 03	lda $0355	                lda vduv.currentScreenMODE ; Get current screen MODE b0-b2
245	.80e9	29 07		and #$07	                and #$07
246	.80eb	0c 8f 02	tsb $028f	                tsb startupOptions           ; Copy to OSBYTE 255
247	.80ee	a9 10		lda #$10	                lda #STATE.isShadowMode ; Test shadow screen bit in VDU flags
248	.80f0	24 d0		bit $d0		                bit STATE                      ; Not shadow screen
249	.80f2	f0 05		beq $80f9	                beq initializePage2Loop
250	.80f4	a9 80		lda #$80	                lda #$80                     ; Set shadow screen bit in OSBYTE 255
251	.80f6	0c 8f 02	tsb $028f	                tsb startupOptions

253	.80f9					initializePage2Loop:
254	.80f9	ad 8d 02	lda $028d	                lda lastBREAKType
255	.80fc	d0 08		bne $8106	                bne clearPage2Byte           ;taken unless soft BREAK

257						                ; leave the ROM information table alone on a soft
258						                ; BREAK.
259	.80fe	e0 b1		cpx #$b1	                cpx #<romInformationTable+16
260	.8100	b0 04		bcs $8106	                bcs clearPage2Byte
261	.8102	e0 a1		cpx #$a1	                cpx #<romInformationTable
262	.8104	b0 0a		bcs $8110	                bcs nextPage2Byte
263	.8106					clearPage2Byte:
264	.8106	9e 00 02	stz $0200,x	                stz $0200,x
265	.8109	e0 cd		cpx #$cd	                cpx #$CD
266	.810b	90 03		bcc $8110	                bcc nextPage2Byte
267	.810d	de 00 02	dec $0200,x	                dec $0200,x                  ;initialize later values to $ff
268	.8110					nextPage2Byte:
269	.8110	e8		inx		                inx
270	.8111	d0 e6		bne $80f9	                bne initializePage2Loop

272						                .if version==350
274						                .endif
275	.8113	a2 cf		ldx #$cf	                ldx #$CF
276	.8115					initializeZeroPageLoop:
277	.8115	74 00		stz $00,x	                stz $00,x
278	.8117	e8		inx		                inx
279	.8118	d0 fb		bne $8115	                bne initializeZeroPageLoop
280						                .if version==350
283						                .endif

285	.811a	ad 8d 02	lda $028d	                lda lastBREAKType
286	.811d	d0 20		bne $813f	                bne L813D                    ;taken if not soft BREAK

288						                .if version!=400
289	.811f	ad 46 02	lda $0246	                lda noignoreState
290	.8122	48		pha		                pha
291						                .endif
292	.8123	ad 4b 02	lda $024b	                lda basicROMNumber
293	.8126	48		pha		                pha
294	.8127	ad 44 02	lda $0244	                lda oshwm
295	.812a	48		pha		                pha
296	.812b	ad 57 02	lda $0257	                lda spoolFileHandle
297	.812e	48		pha		                pha
298	.812f	ae 56 02	ldx $0256	                ldx execFileHandle

300	.8132					L8130:
301	.8132	b9 f8 e2	lda $e2f8,y	                lda mos.defaultVectorTable-1,y
302	.8135	99 ff 01	sta $01ff,y	                sta vectors-1,y
303	.8138	88		dey		                dey
304	.8139	c0 21		cpy #$21	                cpy #EVENTV+1-vectors
305	.813b	b0 f5		bcs $8132	                bcs L8130

307	.813d	a0 12		ldy #$12	                ldy #FILEV-vectors

309	.813f					L813D:
310	.813f	b9 f8 e2	lda $e2f8,y	                lda mos.defaultVectorTable-1,y
311	.8142	99 ff 01	sta $01ff,y	                sta vectors-1,y
312	.8145	88		dey		                dey
313	.8146	d0 f7		bne $813f	                bne L813D

315	.8148	ad 8d 02	lda $028d	                lda lastBREAKType
316	.814b	d0 19		bne $8166	                bne L8164
317	.814d	8e 56 02	stx $0256	                stx execFileHandle
318	.8150	68		pla		                pla                          ;restore *SPOOL file handle
319	.8151	c9 04		cmp #$04	                cmp #$04                     ;is it a TAPE or ROM handle?
320	.8153	b0 02		bcs $8157	                bcs L8155                    ;taken if no - keep it

322						                .if version==350
324						                .else
325	.8155	a9 00		lda #$00	                lda #$00          ;auto-close it if TAPE or ROM handle
326						                .endif
327	.8157					L8155:
328	.8157	8d 57 02	sta $0257	                sta spoolFileHandle
329	.815a	68		pla		                pla
330	.815b	8d 44 02	sta $0244	                sta oshwm
331	.815e	68		pla		                pla
332	.815f	8d 4b 02	sta $024b	                sta basicROMNumber
333						                .if version!=400
334	.8162	68		pla		                pla
335	.8163	8d 46 02	sta $0246	                sta noignoreState
336						                .endif

338	.8166					L8164:
339						                .if version==350
344						                .elsif version>=500
345	.8166	a2 0b		ldx #$0b	                ldx #cmosBytesOffset+CMOSBytes.defaults1
346	.8168	20 ca 9d	jsr $9dca	                jsr terminal.readRTCByte
347						                .endif
348	.816b	a2 20		ldx #$20	                ldx #keyboardStatusByte.shiftLockDisengaged
349	.816d	0a		asl a		                asl a
350	.816e	0a		asl a		                asl a                        ;N=defaultCapsLockMask
351	.816f	30 07		bmi $8178	                bmi gotKeyboardStatusByte                    ;taken if defaultCapsLock
352	.8171	a2 30		ldx #$30	                ldx #keyboardStatusByte.shiftLockDisengaged|keyboardStatusByte.capsLockDisengaged
353	.8173	0a		asl a		                asl a                        ;N=defaultNoLockMask
354	.8174	30 02		bmi $8178	                bmi gotKeyboardStatusByte
355	.8176	a2 a0		ldx #$a0	                ldx #keyboardStatusByte.shiftEnabled|keyboardStatusByte.shiftLockDisengaged
356	.8178					gotKeyboardStatusByte:
357	.8178	8e 5a 02	stx $025a	                stx keyboardStatusByte
358						                .if version==350
360						                .else
361	.817b	20 a9 e5	jsr $e5a9	                jsr mos.selectTerminalROM
362	.817e	20 b0 f1	jsr $f1b0	                jsr mos.resetKeyRepeat
363						                .endif
364	.8181	ad 8d 02	lda $028d	                lda lastBREAKType
365	.8184	f0 16		beq $819c	                beq L8196
366						                .if version==350
371						                .elsif version>=500
372	.8186	a2 0e		ldx #$0e	                ldx #cmosBytesOffset+CMOSBytes.printerIgnoreChar
373	.8188	20 ca 9d	jsr $9dca	                jsr terminal.readRTCByte
374						                .endif
375	.818b	8d 86 02	sta $0286	                sta printerIgnoreChar
376						                .if version==350
382						                .elsif version>=500
383	.818e	20 a1 8b	jsr $8ba1	                jsr readUsePrinterIgnoreChar
384						                .endif
385	.8191	6e 46 02	ror $0246	                ror noignoreState
386						                .if version==350
391						                .elsif version>=500
392	.8194	a2 75		ldx #$75	                ldx #configureTable.print.metadata-configureTable
393	.8196	20 64 8a	jsr $8a64	                jsr readConfigurationByte
394						                .endif
395	.8199	8d 85 02	sta $0285	                sta printerDriverType
396	.819c					L8196:
397						                .if version==400
399						                .else
400						                .if version==350
405						                .elsif version>=500
406	.819c	a2 19		ldx #$19	                ldx #configureTable.data.metadata-configureTable
407	.819e	20 64 8a	jsr $8a64	                jsr readConfigurationByte
408						                .endif
409	.81a1	0a		asl a		                asl a                        ;
410	.81a2	0a		asl a		                asl a       ;shift into the control registerword field
411	.81a3	09 42		ora #$42	                ora #ACIA.control.rtsHighTXInterruptDisabled|ACIA.control.counterDivide64
412	.81a5	8d 50 02	sta $0250	                sta aciaControlRegister

414						                .if version<500
417						                .elsif version>=500
418	.81a8	a2 12		ldx #$12	                ldx #CMOSBytes.joystick
419	.81aa	20 ca 9d	jsr $9dca	                jsr readRTCByte
420	.81ad	8d 4e 02	sta $024e	                sta adcConversionType
421						                .if olivetti
425						                .endif
426	.81b0	a2 ff		ldx #$ff	                ldx #$ff
427	.81b2					L81B2:
428	.81b2	20 d7 ad	jsr $add7	                jsr resetACIA
429	.81b5	ad 08 fe	lda $fe08	                lda $fe08
430	.81b8	d0 0e		bne $81c8	                bne L81C8
431	.81ba	a9 20		lda #$20	                lda #$20
432	.81bc	8d 08 fe	sta $fe08	                sta $fe08
433	.81bf	ad 08 fe	lda $fe08	                lda $fe08
434	.81c2	29 f7		and #$f7	                and #$f7
435	.81c4	c9 82		cmp #$82	                cmp #$82
436	.81c6	f0 07		beq $81cf	                beq L81CF
437	.81c8					L81C8:
438	.81c8	c9 08		cmp #$08	                cmp #8
439	.81ca	f0 03		beq $81cf	                beq L81CF
440	.81cc	9c 78 02	stz $0278	                stz rs423InterruptMask
441	.81cf					L81CF:
442	.81cf	ca		dex		                dex
443	.81d0	d0 e0		bne $81b2	                bne L81B2
444	.81d2	20 9b ad	jsr $ad9b	                jsr resetACIAThenRewriteControlRegister
445	.81d5	e8		inx		                inx
446						                .endif
447						                .endif

449	.81d6	a9 7f		lda #$7f	                lda #$7F
450	.81d8					initializeVIAInterruptsLoop:
451	.81d8	9d 4d fe	sta $fe4d,x	                sta systemVIA.ifr,x
452	.81db	9d 6d fe	sta $fe6d,x	                sta userVIA.ifr,x
453	.81de	ca		dex		                dex
454	.81df	10 f7		bpl $81d8	                bpl initializeVIAInterruptsLoop

456						                .if version!=350
457						                ; Let through 1 IRQ.
458	.81e1	58		cli		                cli
459	.81e2	78		sei		                sei

461						                ; $FC was cleared above, so if bit 6 is set, there
462						                ; must have been an IRQ (as A=$7f).
463	.81e3	24 fc		bit $fc		                bit $FC
464	.81e5	50 03		bvc $81ea	                bvc +
465	.81e7	20 48 f7	jsr $f748	                jsr mos.call1MHzBusHook
466	.81ea					+
467						                .endif

469						                .if version!=400
470	.81ea	a2 d2		ldx #$d2	                ldx #$80|VIA.irq.t1|VIA.irq.cb1|VIA.irq.ca1
473						                .endif
474	.81ec	8e 4e fe	stx $fe4e	                stx systemVIA.ier

476						                .if version>=500
477	.81ef	a2 98		ldx #$98	                ldx #$80|VIA.irq.cb1|VIA.irq.cb2
478	.81f1	8e 6e fe	stx $fe6e	                stx userVIA.ier
479						                .endif

481	.81f4	a2 04		ldx #$04	                ldx #VIA.pcr.cb2InputNegativeActiveEdge|VIA.pcr.cb1NegativeActiveEdge|VIA.pcr.ca2InputPositiveEdge|VIA.pcr.ca1NegativeActiveEdge
482	.81f6	8e 4c fe	stx $fe4c	                stx systemVIA.pcr
483	.81f9	a9 40		lda #$40	                lda #VIA.acr.t1Continuous|VIA.acr.t2Timer|VIA.acr.srDisabled|VIA.acr.pbLatchDisabled|VIA.acr.paLatchDisabled
484	.81fb	8d 4b fe	sta $fe4b	                sta systemVIA.acr
485	.81fe	a9 0e		lda #$0e	                lda #$0E
486	.8200	8d 46 fe	sta $fe46	                sta systemVIA.t1lL
487	.8203	8d 6c fe	sta $fe6c	                sta userVIA.pcr              ;VIA.pcr.cb2InputNegativeActiveEdge|VIA.pcr.cb1NegativeActiveEdge|VIA.pcr.ca2HighOutput|VIA.pcr.ca1NegativeActiveEdge
488						                .if version==350
492						                .endif
493	.8206	a9 27		lda #$27	                lda #$27
494	.8208	8d 47 fe	sta $fe47	                sta systemVIA.t1lH
495	.820b	8d 45 fe	sta $fe45	                sta systemVIA.t1cH

497						                .if version==350||version>=400
498	.820e	20 6d 83	jsr $836d	                jsr clearAllSoundChannelBuffers
506						                .endif

508						                .if version==350
510						                .else
511	.8211	20 89 f7	jsr $f789	                jsr mos.osbyte7A
512						                .endif
513	.8214	86 ed		stx $ed		                stx firstKeyPressedInternal
514	.8216	a2 00		ldx #$00	                ldx #$00
515						                .if version>=500
516	.8218	8e 62 fe	stx $fe62	                stx userVIA.ddrb
517						                .endif
518	.821b	20 a8 ea	jsr $eaa8	                jsr mos.purgeBuffer

520						                .if version!=400
521	.821e	ad 82 02	lda $0282	                lda serialULARegister
522	.8221	29 7f		and #$7f	                and #$7F
523	.8223	20 1e ed	jsr $ed1e	                jsr mos.LEC89
524						                .if version<500&&version!=350
526						                .else
527	.8226	a2 07		ldx #$07	                ldx #terminal.configureTable.baud.metadata-terminal.configureTable
528						                .if version==350
530						                .else
531	.8228	20 64 8a	jsr $8a64	                jsr readConfigurationByte
532						                .endif
533						                .endif
534	.822b	48		pha		                pha
535	.822c	aa		tax		                tax
536	.822d	20 00 ed	jsr $ed00	                jsr mos.osbyte08
537	.8230	fa		plx		                plx
538	.8231	a9 07		lda #$07	                lda #$07
539	.8233	20 02 ed	jsr $ed02	                jsr mos.osbyte07
540						                .endif

542	.8236	20 a6 9d	jsr $9da6	                jsr terminal.readDefaults3
543	.8239	89 02		bit #$02	                bit #CMOSBytes.defaults3.loudMask
544	.823b	d0 05		bne $8242	                bne L8211
545	.823d	a9 f0		lda #$f0	                lda #$F0
546	.823f	8d 64 02	sta $0264	                sta bellSound
547	.8242					L8211:
548						                .if version!=350
549	.8242	20 a9 e5	jsr $e5a9	                jsr mos.selectTerminalROM
550						                .endif

552	.8245	ae 84 02	ldx $0284	                ldx softKeyConsistencyFlag
553	.8248	f0 03		beq $824d	                beq checkResetType
554	.824a	20 c8 f1	jsr $f1c8	                jsr mos.osbyte12
555	.824d					checkResetType:
556	.824d	ad 8d 02	lda $028d	                lda lastBREAKType
557	.8250	f0 03		beq $8255	                beq romsScanned                    ;taken if soft BREAK

559						                .if version==350
562						                .else
563	.8252	4c ba e3	jmp $e3ba	                jmp mos.scanROMs
564						                .endif

566	.8255					romsScanned:
567	.8255	ad 8f 02	lda $028f	                lda startupOptions
568	.8258	20 99 c7	jsr $c799	                jsr mos.setStartupMODE
569	.825b	ad 8d 02	lda $028d	                lda lastBREAKType
570	.825e	3a		dec a		                dec a
571						                .if version>=510
574						                .else
575	.825f	d0 72		bne $82d3	                bne softReset                    ;taken if not power-on reset
576						                .endif

578	.8261					powerOnReset:
579						                .if version>=500
580	.8261	a2 ff		ldx #$ff	                ldx #$ff
581	.8263	20 ca 9e	jsr $9eca	                jsr L9ECA
582	.8266	b0 10		bcs $8278	                bcs checkForNVRAMReset
583	.8268	98		tya		                tya
584	.8269	29 7f		and #$7f	                and #$7f
585						                .if version>=511||olivetti
587						                .else
588	.826b	c9 30		cmp #$30	                cmp #$30
589						                .endif
590	.826d	f0 09		beq $8278	                beq checkForNVRAMReset
591	.826f	a2 00		ldx #$00	                ldx #0
592	.8271	a0 00		ldy #$00	                ldy #0
593	.8273	20 99 9e	jsr $9e99	                jsr L9E99
594	.8276	80 06		bra $827e	                bra resetCMOSRAM
595						                .endif
596	.8278					checkForNVRAMReset:

598						                .if version>=510
617						                .endif

619						                .if version<510
620	.8278	a5 ed		lda $ed		                lda firstKeyPressedInternal
621						                .endif
622	.827a					checkForResetKey:
623	.827a	c9 33		cmp #$33	                cmp #key_r
624	.827c	d0 55		bne $82d3	                bne softReset                    ;taken if R not pressed

626						                .if version<500
661						                .else
662	.827e					resetCMOSRAM:                                ;82bb in MOS 5.10
663	.827e	a2 13		ldx #$13	                ldx #size(CMOSBytes)
664	.8280					resetCMOSRAMLoop:
665	.8280	da		phx		                phx
666	.8281	ca		dex		                dex
667	.8282	20 e1 9d	jsr $9de1	                jsr L9DE1
668	.8285	20 f8 9d	jsr $9df8	                jsr writeCMOSByte
669	.8288	fa		plx		                plx
670	.8289	ca		dex		                dex
671	.828a	d0 f4		bne $8280	                bne resetCMOSRAMLoop
672						                .endif

674						                .if version==350
676						                .else

678						                .if version>=500
679	.828c	a2 7f		ldx #$7f	                ldx #$7f
680	.828e	20 ca 9e	jsr $9eca	                jsr L9ECA
681	.8291	98		tya		                tya
682	.8292	29 80		and #$80	                and #$80
683						                .if version>=511||olivetti
685						                .else
686	.8294	49 b0		eor #$b0	                eor #$b0
687						                .endif
688	.8296	a8		tay		                tay
689	.8297	a2 ff		ldx #$ff	                ldx #$ff
690	.8299	20 99 9e	jsr $9e99	                jsr L9E99
691						                .endif

693	.829c	20 27 ad	jsr $ad27	                jsr alwaysPrintFollowingMessage
694						                .if version>=500
695	>829f	16 07				                .byte 22,7
696						                .endif
697	>82a1	0d 0a				                .text 13,10
698						                .if version<500
700						                .elsif version>=500
701	>82a3	4f 70 74 69 6f 6e 73 20		                .text "Options reset"
	>82ab	72 65 73 65 74
702						                .endif
703	>82b0	0d 0a 50 72 65 73 73 20		                .text 13,10,"Press break to continue"
	>82b8	62 72 65 61 6b 20 74 6f 20 63 6f 6e 74 69 6e 75
	>82c8	65
704	>82c9	0d 0a 00			                .text 13,10,0
705						                .endif

707	.82cc	a9 03		lda #$03	                lda #$03
708	.82ce	8d 58 02	sta $0258	                sta breakAndESCAPEEffect
709	.82d1					hang:
710	.82d1	80 fe		bra $82d1	                bra hang

712						;-------------------------------------------------------------------------

714						                .if version==350
741						.endif

743						;-------------------------------------------------------------------------

745	.82d3					softReset:
746						                .if version==350
749						                .else
750	.82d3	20 40 ee	jsr $ee40	                jsr mos.selectHAZEL
751						                .endif
752	.82d6	9c d4 df	stz $dfd4	                stz hazel.moveSrcHandle
753	.82d9	9c d5 df	stz $dfd5	                stz hazel.moveDestHandle
754	.82dc	a0 ca		ldy #$ca	                ldy #$CA
755	.82de	20 a9 eb	jsr $eba9	                jsr mos.insertCharacterIntoKeyboardBuffer
756	.82e1	20 0e f4	jsr $f40e	                jsr mos.osbyte247EntryPoint
757	.82e4	ad 8d 02	lda $028d	                lda lastBREAKType
758	.82e7	f0 03		beq $82ec	                beq L829D
759						                .if version==400
761						                .else
762	.82e9	20 56 ee	jsr $ee56	                jsr mos.LEDD0
763						                .endif
764	.82ec					L829D:
765						                .if version<500
819						                .endif

:5	;******  Return to file: src/terminal.s65

154						                .endif

156						                .if version<500
163						                .endif
164	.82ec					continueSoftReset:
165	.82ec	ad 8d 02	lda $028d	                lda lastBREAKType ; Soft Break, don't ask about workspace
166	.82ef	f0 27		beq $8318	                beq L82FC
167	.82f1	a0 dc		ldy #$dc	                ldy #$DC                     ; Start high workspace at &DC00 and work downwards
168	.82f3	a2 24		ldx #$24	                ldx #romServiceCallCountDynamicHAZELWorkspace ; Ask ROMs how much private high workspace required
169	.82f5	20 f8 ee	jsr $eef8	                jsr mos.makeROMServiceCall   ;
170	.82f8	a2 21		ldx #$21	                ldx #romServiceCallAbsoluteHAZELWorkspaceClaim ; Ask ROMs for maximum shared high workspace required
171	.82fa	20 f8 ee	jsr $eef8	                jsr mos.makeROMServiceCall   ;
172	.82fd	5a		phy		                phy                          ; Save top of shared workspace
173	.82fe	a2 22		ldx #$22	                ldx #romServiceCallPrivateHAZELWorkspaceClam ; Ask ROMs for private high workspace required
174	.8300	20 f8 ee	jsr $eef8	                jsr mos.makeROMServiceCall   ;
175	.8303	a0 0e		ldy #$0e	                ldy #$0E                     ; Start low workspace at &0E00
176	.8305	a2 01		ldx #$01	                ldx #romServiceCallAbsoluteWorkspaceClaim ; Ask ROMs for maximum shared workspace
177	.8307	20 f8 ee	jsr $eef8	                jsr mos.makeROMServiceCall   ;
178	.830a	a2 02		ldx #$02	                ldx #romServiceCallPrivateWorkspaceClaim ; Ask ROMs for private workspace
179	.830c	20 f8 ee	jsr $eef8	                jsr mos.makeROMServiceCall   ;
180	.830f	8c 44 02	sty $0244	                sty oshwm                    ; Set OSHWM - default PAGE
181	.8312	7a		ply		                ply                          ; Get top of shared high workspace
182	.8313	a2 23		ldx #$23	                ldx #romServiceCallTopOfHAZELWorkspace ; Tell ROMs top of shared high workspace
183	.8315	20 f8 ee	jsr $eef8	                jsr mos.makeROMServiceCall   ;
184	.8318					L82FC:
185	.8318	a2 0b		ldx #$0b	                ldx #size(defaultFsInfoBlocks)
186	.831a					L82FE:
187	.831a	bd 77 83	lda $8377,x	                lda defaultFsInfoBlocks-1,x                ; Copy initial FS info blocks for CFS, TAPE, ROM
188	.831d	9d 05 df	sta $df05,x	                sta hazel.fsInfoBlocks-1,x
189	.8320	ca		dex		                dex
190	.8321	d0 f7		bne $831a	                bne L82FE
191	.8323	64 f2		stz $f2		                stz $F2                      ; &F2/3=>FS Info Blocks
192	.8325	a9 df		lda #$df	                lda #>hazel.fsInfoBlocks
193	.8327	85 f3		sta $f3		                sta $F3
194						                ; Y=>end of FS Info Blocks
195	.8329	a0 11		ldy #$11	                ldy #<hazel.fsInfoBlocks+size(defaultFsInfoBlocks)
196	.832b	a2 25		ldx #$25	                ldx #$25                     ; Ask ROMs for FS Info Blocks
197	.832d	20 f8 ee	jsr $eef8	                jsr mos.makeROMServiceCall   ;
198	.8330	a9 00		lda #$00	                lda #$00                     ; Terminate FS Info blocks
199	.8332	91 f2		sta ($f2),y	                sta ($F2),y

201	.8334	ad 57 02	lda $0257	                lda spoolFileHandle ; Save Spool handle and disable Spooling
202	.8337	48		pha		                pha
203	.8338	9c 57 02	stz $0257	                stz spoolFileHandle
204	.833b	a2 fe		ldx #$fe	                ldx #romServiceCallTubeSystemPostInitialisation
205	.833d	ac 7a 02	ldy $027a	                ldy tubePresence
206	.8340	20 f8 ee	jsr $eef8	                jsr mos.makeROMServiceCall   ; Tube PostInit
207	.8343	2d 67 02	and $0267	                and startupMessageSuppressionStatus
208	.8346	10 14		bpl $835c	                bpl L8340

210						                ; use +$ff rather than -1 to avoid 64tass warning.
211						                ; Only the LSB is used.
212	.8348	a0 0f		ldy #$0f	                ldy #((mos.startupMessages.acornMOS-(mos.startupMessages&$ff00))+$ff)&$ff
213	.834a	20 7b e7	jsr $e77b	                jsr mos.printStartupMessage
214	.834d	ad 8d 02	lda $028d	                lda lastBREAKType            ; Skip past if Soft Break
215	.8350	f0 05		beq $8357	                beq L833B
216	.8352	a0 1a		ldy #$1a	                ldy #((mos.startupMessages.beep-(mos.startupMessages&$ff00))-1)&$ff
217	.8354	20 7b e7	jsr $e77b	                jsr mos.printStartupMessage
218	.8357					L833B:
219	.8357	a0 1f		ldy #$1f	                ldy #((mos.startupMessages.twoNewlines-(mos.startupMessages&$ff00))-1)&$ff
220	.8359	20 7b e7	jsr $e77b	                jsr mos.printStartupMessage
221	.835c					L8340:
222	.835c	68		pla		                pla                          ; Restore Spool handle
223	.835d	8d 57 02	sta $0257	                sta spoolFileHandle
224	.8360	4c 35 e4	jmp $e435	                jmp mos.LE40E                ;

226						;-------------------------------------------------------------------------

228						                .if version>=500
229	.8363					L8363:
230	.8363	a9 0f		lda #$0f	                lda #$0f
231	.8365					L8365:
232	.8365	3a		dec a		                dec a
233	.8366	8d 40 fe	sta $fe40	                sta $fe40
234	.8369	c9 09		cmp #$09	                cmp #9
235	.836b	b0 f8		bcs $8365	                bcs L8365
236						                .endif
237						                .if version>=400
238	.836d					clearAllSoundChannelBuffers:
239	.836d	a2 08		ldx #$08	                ldx #8
240	.836f					L836F:
241	.836f	ca		dex		                dex
242	.8370	20 e8 f4	jsr $f4e8	                jsr mos.clearSoundChannelBuffer
243	.8373	e0 04		cpx #$04	                cpx #4
244	.8375	d0 f8		bne $836f	                bne L836F
245	.8377	60		rts		                rts
246						                .endif

248						;-------------------------------------------------------------------------

250						; Default FS Info Blocks
251						; ======================
252	.8378					defaultFsInfoBlocks: .block
253						                .if version<500
262						                .endif
263	>8378	52 4f 4d 20 20 20 20 20		                .text "ROM     "
264	>8380	03				                .byte $03
265	>8381	03				                .byte $03
266	>8382	03				                .byte $03
267						                .endblock

269						;-------------------------------------------------------------------------
270						;
271						; MOS command table

273						mos_command .macro name,routine,byte1,byte2
290						                .endm

292	.8383					mosCommandTable:
274						                ; Name of command, compared case-insensitively.
275	>8383	43 41 54			                .text "CAT"

277						                ; Address of command routine, big-endian so that the
278						                ; first byte always has bit 7 set.
12:4	>8386	f2				                .byte >mos.callFSCV
13	>8387	93				                .byte <mos.callFSCV

281:5						                ; If bit 7 set, reset the tempFS flag before
282						                ; starting.
283	>8388	80				                .byte $80

285						                ; If bit 7 set, update string input buffer address
286						                ; before starting.
287						                ;
288						                ; A is set to this value on entry to the routine.
289	>8389	05				                .byte $05
294						                .if version!=400
274						                ; Name of command, compared case-insensitively.
275	>838a	41 44 46 53			                .text "ADFS"

277						                ; Address of command routine, big-endian so that the
278						                ; first byte always has bit 7 set.
12:4	>838e	85				                .byte >passStarCommandThrough
13	>838f	c2				                .byte <passStarCommandThrough

281:5						                ; If bit 7 set, reset the tempFS flag before
282						                ; starting.
283	>8390	00				                .byte $00

285						                ; If bit 7 set, update string input buffer address
286						                ; before starting.
287						                ;
288						                ; A is set to this value on entry to the routine.
289	>8391	00				                .byte $00
296						                .endif
274						                ; Name of command, compared case-insensitively.
275	>8392	41 50 50 45 4e 44		                .text "APPEND"

277						                ; Address of command routine, big-endian so that the
278						                ; first byte always has bit 7 set.
12:4	>8398	91				                .byte >starAPPEND
13	>8399	e1				                .byte <starAPPEND

281:5						                ; If bit 7 set, reset the tempFS flag before
282						                ; starting.
283	>839a	80				                .byte $80

285						                ; If bit 7 set, update string input buffer address
286						                ; before starting.
287						                ;
288						                ; A is set to this value on entry to the routine.
289	>839b	00				                .byte $00
274						                ; Name of command, compared case-insensitively.
275	>839c	42 41 53 49 43			                .text "BASIC"

277						                ; Address of command routine, big-endian so that the
278						                ; first byte always has bit 7 set.
12:4	>83a1	85				                .byte >starBASIC
13	>83a2	b8				                .byte <starBASIC

281:5						                ; If bit 7 set, reset the tempFS flag before
282						                ; starting.
283	>83a3	00				                .byte $00

285						                ; If bit 7 set, update string input buffer address
286						                ; before starting.
287						                ;
288						                ; A is set to this value on entry to the routine.
289	>83a4	00				                .byte $00
274						                ; Name of command, compared case-insensitively.
275	>83a5	42 55 49 4c 44			                .text "BUILD"

277						                ; Address of command routine, big-endian so that the
278						                ; first byte always has bit 7 set.
12:4	>83aa	91				                .byte >starBUILD
13	>83ab	dc				                .byte <starBUILD

281:5						                ; If bit 7 set, reset the tempFS flag before
282						                ; starting.
283	>83ac	80				                .byte $80

285						                ; If bit 7 set, update string input buffer address
286						                ; before starting.
287						                ;
288						                ; A is set to this value on entry to the routine.
289	>83ad	00				                .byte $00
274						                ; Name of command, compared case-insensitively.
275	>83ae	43 4c 4f 53 45			                .text "CLOSE"

277						                ; Address of command routine, big-endian so that the
278						                ; first byte always has bit 7 set.
12:4	>83b3	95				                .byte >starCLOSE
13	>83b4	58				                .byte <starCLOSE

281:5						                ; If bit 7 set, reset the tempFS flag before
282						                ; starting.
283	>83b5	00				                .byte $00

285						                ; If bit 7 set, update string input buffer address
286						                ; before starting.
287						                ;
288						                ; A is set to this value on entry to the routine.
289	>83b6	ff				                .byte $FF
301						                .if version<500&&version!=350
303						                .else
274						                ; Name of command, compared case-insensitively.
275	>83b7	43 4f 4e 46 49 47 55 52		                .text "CONFIGURE"
	>83bf	45

277						                ; Address of command routine, big-endian so that the
278						                ; first byte always has bit 7 set.
12:4	>83c0	88				                .byte >starCONFIGUREOrStarSTATUS
13	>83c1	56				                .byte <starCONFIGUREOrStarSTATUS

281:5						                ; If bit 7 set, reset the tempFS flag before
282						                ; starting.
283	>83c2	00				                .byte $00

285						                ; If bit 7 set, update string input buffer address
286						                ; before starting.
287						                ;
288						                ; A is set to this value on entry to the routine.
289	>83c3	80				                .byte $80
305						                .endif
274						                ; Name of command, compared case-insensitively.
275	>83c4	43 4f 44 45			                .text "CODE"

277						                ; Address of command routine, big-endian so that the
278						                ; first byte always has bit 7 set.
12:4	>83c8	95				                .byte >starCommandThroughOSBYTE
13	>83c9	c7				                .byte <starCommandThroughOSBYTE

281:5						                ; If bit 7 set, reset the tempFS flag before
282						                ; starting.
283	>83ca	00				                .byte $00

285						                ; If bit 7 set, update string input buffer address
286						                ; before starting.
287						                ;
288						                ; A is set to this value on entry to the routine.
289	>83cb	88				                .byte $88
274						                ; Name of command, compared case-insensitively.
275	>83cc	43 52 45 41 54 45		                .text "CREATE"

277						                ; Address of command routine, big-endian so that the
278						                ; first byte always has bit 7 set.
12:4	>83d2	94				                .byte >starCommandThroughOSFILE
13	>83d3	f4				                .byte <starCommandThroughOSFILE

281:5						                ; If bit 7 set, reset the tempFS flag before
282						                ; starting.
283	>83d4	80				                .byte $80

285						                ; If bit 7 set, update string input buffer address
286						                ; before starting.
287						                ;
288						                ; A is set to this value on entry to the routine.
289	>83d5	07				                .byte $07
274						                ; Name of command, compared case-insensitively.
275	>83d6	44 55 4d 50			                .text "DUMP"

277						                ; Address of command routine, big-endian so that the
278						                ; first byte always has bit 7 set.
12:4	>83da	91				                .byte >starDUMP
13	>83db	0f				                .byte <starDUMP

281:5						                ; If bit 7 set, reset the tempFS flag before
282						                ; starting.
283	>83dc	80				                .byte $80

285						                ; If bit 7 set, update string input buffer address
286						                ; before starting.
287						                ;
288						                ; A is set to this value on entry to the routine.
289	>83dd	00				                .byte $00
274						                ; Name of command, compared case-insensitively.
275	>83de	44 45 4c 45 54 45		                .text "DELETE"

277						                ; Address of command routine, big-endian so that the
278						                ; first byte always has bit 7 set.
12:4	>83e4	96				                .byte >starDELETE
13	>83e5	46				                .byte <starDELETE

281:5						                ; If bit 7 set, reset the tempFS flag before
282						                ; starting.
283	>83e6	80				                .byte $80

285						                ; If bit 7 set, update string input buffer address
286						                ; before starting.
287						                ;
288						                ; A is set to this value on entry to the routine.
289	>83e7	00				                .byte $00
274						                ; Name of command, compared case-insensitively.
275	>83e8	45 58 45 43			                .text "EXEC"

277						                ; Address of command routine, big-endian so that the
278						                ; first byte always has bit 7 set.
12:4	>83ec	a9				                .byte >starEXEC
13	>83ed	8d				                .byte <starEXEC

281:5						                ; If bit 7 set, reset the tempFS flag before
282						                ; starting.
283	>83ee	80				                .byte $80

285						                ; If bit 7 set, update string input buffer address
286						                ; before starting.
287						                ;
288						                ; A is set to this value on entry to the routine.
289	>83ef	00				                .byte $00
274						                ; Name of command, compared case-insensitively.
275	>83f0	45 58				                .text "EX"

277						                ; Address of command routine, big-endian so that the
278						                ; first byte always has bit 7 set.
12:4	>83f2	f2				                .byte >mos.callFSCV
13	>83f3	93				                .byte <mos.callFSCV

281:5						                ; If bit 7 set, reset the tempFS flag before
282						                ; starting.
283	>83f4	80				                .byte $80

285						                ; If bit 7 set, update string input buffer address
286						                ; before starting.
287						                ;
288						                ; A is set to this value on entry to the routine.
289	>83f5	09				                .byte $09
274						                ; Name of command, compared case-insensitively.
275	>83f6	46 58				                .text "FX"

277						                ; Address of command routine, big-endian so that the
278						                ; first byte always has bit 7 set.
12:4	>83f8	95				                .byte >starFX
13	>83f9	c1				                .byte <starFX

281:5						                ; If bit 7 set, reset the tempFS flag before
282						                ; starting.
283	>83fa	00				                .byte $00

285						                ; If bit 7 set, update string input buffer address
286						                ; before starting.
287						                ;
288						                ; A is set to this value on entry to the routine.
289	>83fb	ff				                .byte $FF
274						                ; Name of command, compared case-insensitively.
275	>83fc	47 4f 49 4f			                .text "GOIO"

277						                ; Address of command routine, big-endian so that the
278						                ; first byte always has bit 7 set.
12:4	>8400	94				                .byte >starGOIO
13	>8401	d9				                .byte <starGOIO

281:5						                ; If bit 7 set, reset the tempFS flag before
282						                ; starting.
283	>8402	00				                .byte $00

285						                ; If bit 7 set, update string input buffer address
286						                ; before starting.
287						                ;
288						                ; A is set to this value on entry to the routine.
289	>8403	ff				                .byte $FF
274						                ; Name of command, compared case-insensitively.
275	>8404	47 4f				                .text "GO"

277						                ; Address of command routine, big-endian so that the
278						                ; first byte always has bit 7 set.
12:4	>8406	94				                .byte >starGO
13	>8407	d1				                .byte <starGO

281:5						                ; If bit 7 set, reset the tempFS flag before
282						                ; starting.
283	>8408	00				                .byte $00

285						                ; If bit 7 set, update string input buffer address
286						                ; before starting.
287						                ;
288						                ; A is set to this value on entry to the routine.
289	>8409	ff				                .byte $FF
274						                ; Name of command, compared case-insensitively.
275	>840a	48 45 4c 50			                .text "HELP"

277						                ; Address of command routine, big-endian so that the
278						                ; first byte always has bit 7 set.
12:4	>840e	85				                .byte >starHELP
13	>840f	dd				                .byte <starHELP

281:5						                ; If bit 7 set, reset the tempFS flag before
282						                ; starting.
283	>8410	00				                .byte $00

285						                ; If bit 7 set, update string input buffer address
286						                ; before starting.
287						                ;
288						                ; A is set to this value on entry to the routine.
289	>8411	ff				                .byte $FF
274						                ; Name of command, compared case-insensitively.
275	>8412	49 4e 46 4f			                .text "INFO"

277						                ; Address of command routine, big-endian so that the
278						                ; first byte always has bit 7 set.
12:4	>8416	f2				                .byte >mos.callFSCV
13	>8417	93				                .byte <mos.callFSCV

281:5						                ; If bit 7 set, reset the tempFS flag before
282						                ; starting.
283	>8418	80				                .byte $80

285						                ; If bit 7 set, update string input buffer address
286						                ; before starting.
287						                ;
288						                ; A is set to this value on entry to the routine.
289	>8419	0a				                .byte $0A
274						                ; Name of command, compared case-insensitively.
275	>841a	49 47 4e 4f 52 45		                .text "IGNORE"

277						                ; Address of command routine, big-endian so that the
278						                ; first byte always has bit 7 set.
12:4	>8420	95				                .byte >starIGNORE
13	>8421	63				                .byte <starIGNORE

281:5						                ; If bit 7 set, reset the tempFS flag before
282						                ; starting.
283	>8422	00				                .byte $00

285						                ; If bit 7 set, update string input buffer address
286						                ; before starting.
287						                ;
288						                ; A is set to this value on entry to the routine.
289	>8423	ff				                .byte $FF
274						                ; Name of command, compared case-insensitively.
275	>8424	49 4e 53 45 52 54		                .text "INSERT"

277						                ; Address of command routine, big-endian so that the
278						                ; first byte always has bit 7 set.
12:4	>842a	87				                .byte >starINSERT
13	>842b	4a				                .byte <starINSERT

281:5						                ; If bit 7 set, reset the tempFS flag before
282						                ; starting.
283	>842c	00				                .byte $00

285						                ; If bit 7 set, update string input buffer address
286						                ; before starting.
287						                ;
288						                ; A is set to this value on entry to the routine.
289	>842d	ff				                .byte $FF
274						                ; Name of command, compared case-insensitively.
275	>842e	4b 45 59			                .text "KEY"

277						                ; Address of command routine, big-endian so that the
278						                ; first byte always has bit 7 set.
12:4	>8431	96				                .byte >starKEY
13	>8432	a3				                .byte <starKEY

281:5						                ; If bit 7 set, reset the tempFS flag before
282						                ; starting.
283	>8433	00				                .byte $00

285						                ; If bit 7 set, update string input buffer address
286						                ; before starting.
287						                ;
288						                ; A is set to this value on entry to the routine.
289	>8434	ff				                .byte $FF
274						                ; Name of command, compared case-insensitively.
275	>8435	4c 4f 41 44			                .text "LOAD"

277						                ; Address of command routine, big-endian so that the
278						                ; first byte always has bit 7 set.
12:4	>8439	94				                .byte >starLOAD
13	>843a	f2				                .byte <starLOAD

281:5						                ; If bit 7 set, reset the tempFS flag before
282						                ; starting.
283	>843b	80				                .byte $80

285						                ; If bit 7 set, update string input buffer address
286						                ; before starting.
287						                ;
288						                ; A is set to this value on entry to the routine.
289	>843c	00				                .byte $00
274						                ; Name of command, compared case-insensitively.
275	>843d	4c 49 53 54			                .text "LIST"

277						                ; Address of command routine, big-endian so that the
278						                ; first byte always has bit 7 set.
12:4	>8441	90				                .byte >starLIST
13	>8442	8d				                .byte <starLIST

281:5						                ; If bit 7 set, reset the tempFS flag before
282						                ; starting.
283	>8443	80				                .byte $80

285						                ; If bit 7 set, update string input buffer address
286						                ; before starting.
287						                ;
288						                ; A is set to this value on entry to the routine.
289	>8444	00				                .byte $00
274						                ; Name of command, compared case-insensitively.
275	>8445	4c 49 4e 45			                .text "LINE"

277						                ; Address of command routine, big-endian so that the
278						                ; first byte always has bit 7 set.
12:4	>8449	ec				                .byte >mos.callUSERV
13	>844a	d7				                .byte <mos.callUSERV

281:5						                ; If bit 7 set, reset the tempFS flag before
282						                ; starting.
283	>844b	00				                .byte $00

285						                ; If bit 7 set, update string input buffer address
286						                ; before starting.
287						                ;
288						                ; A is set to this value on entry to the routine.
289	>844c	01				                .byte $01
274						                ; Name of command, compared case-insensitively.
275	>844d	4c 49 42 46 53			                .text "LIBFS"

277						                ; Address of command routine, big-endian so that the
278						                ; first byte always has bit 7 set.
12:4	>8452	e9				                .byte >mos.starLIBFS
13	>8453	26				                .byte <mos.starLIBFS

281:5						                ; If bit 7 set, reset the tempFS flag before
282						                ; starting.
283	>8454	00				                .byte $00

285						                ; If bit 7 set, update string input buffer address
286						                ; before starting.
287						                ;
288						                ; A is set to this value on entry to the routine.
289	>8455	00				                .byte $00
324						                .if version<400
328						                .elsif version>=500
274						                ; Name of command, compared case-insensitively.
275	>8456	4d 4f 54 4f 52			                .text "MOTOR"

277						                ; Address of command routine, big-endian so that the
278						                ; first byte always has bit 7 set.
12:4	>845b	ff				                .byte >mos.rtsFFAA
13	>845c	aa				                .byte <mos.rtsFFAA

281:5						                ; If bit 7 set, reset the tempFS flag before
282						                ; starting.
283	>845d	00				                .byte $00

285						                ; If bit 7 set, update string input buffer address
286						                ; before starting.
287						                ;
288						                ; A is set to this value on entry to the routine.
289	>845e	89				                .byte $89
330						                .endif
274						                ; Name of command, compared case-insensitively.
275	>845f	4d 4f 56 45			                .text "MOVE"

277						                ; Address of command routine, big-endian so that the
278						                ; first byte always has bit 7 set.
12:4	>8463	92				                .byte >starMOVE
13	>8464	8e				                .byte <starMOVE

281:5						                ; If bit 7 set, reset the tempFS flag before
282						                ; starting.
283	>8465	80				                .byte $80

285						                ; If bit 7 set, update string input buffer address
286						                ; before starting.
287						                ;
288						                ; A is set to this value on entry to the routine.
289	>8466	00				                .byte $00
274						                ; Name of command, compared case-insensitively.
275	>8467	4f 50 54			                .text "OPT"

277						                ; Address of command routine, big-endian so that the
278						                ; first byte always has bit 7 set.
12:4	>846a	95				                .byte >starCommandThroughOSBYTE
13	>846b	c7				                .byte <starCommandThroughOSBYTE

281:5						                ; If bit 7 set, reset the tempFS flag before
282						                ; starting.
283	>846c	80				                .byte $80

285						                ; If bit 7 set, update string input buffer address
286						                ; before starting.
287						                ;
288						                ; A is set to this value on entry to the routine.
289	>846d	8b				                .byte $8B
274						                ; Name of command, compared case-insensitively.
275	>846e	50 52 49 4e 54			                .text "PRINT"

277						                ; Address of command routine, big-endian so that the
278						                ; first byte always has bit 7 set.
12:4	>8473	90				                .byte >starPRINT
13	>8474	86				                .byte <starPRINT

281:5						                ; If bit 7 set, reset the tempFS flag before
282						                ; starting.
283	>8475	80				                .byte $80

285						                ; If bit 7 set, update string input buffer address
286						                ; before starting.
287						                ;
288						                ; A is set to this value on entry to the routine.
289	>8476	00				                .byte $00
274						                ; Name of command, compared case-insensitively.
275	>8477	52 55 4e			                .text "RUN"

277						                ; Address of command routine, big-endian so that the
278						                ; first byte always has bit 7 set.
12:4	>847a	f2				                .byte >mos.callFSCV
13	>847b	93				                .byte <mos.callFSCV

281:5						                ; If bit 7 set, reset the tempFS flag before
282						                ; starting.
283	>847c	80				                .byte $80

285						                ; If bit 7 set, update string input buffer address
286						                ; before starting.
287						                ;
288						                ; A is set to this value on entry to the routine.
289	>847d	04				                .byte $04
274						                ; Name of command, compared case-insensitively.
275	>847e	52 45 4d 4f 56 45		                .text "REMOVE"

277						                ; Address of command routine, big-endian so that the
278						                ; first byte always has bit 7 set.
12:4	>8484	95				                .byte >starREMOVE
13	>8485	4d				                .byte <starREMOVE

281:5						                ; If bit 7 set, reset the tempFS flag before
282						                ; starting.
283	>8486	80				                .byte $80

285						                ; If bit 7 set, update string input buffer address
286						                ; before starting.
287						                ;
288						                ; A is set to this value on entry to the routine.
289	>8487	00				                .byte $00
274						                ; Name of command, compared case-insensitively.
275	>8488	52 4f 4d			                .text "ROM"

277						                ; Address of command routine, big-endian so that the
278						                ; first byte always has bit 7 set.
12:4	>848b	95				                .byte >starCommandThroughOSBYTE
13	>848c	c7				                .byte <starCommandThroughOSBYTE

281:5						                ; If bit 7 set, reset the tempFS flag before
282						                ; starting.
283	>848d	00				                .byte $00

285						                ; If bit 7 set, update string input buffer address
286						                ; before starting.
287						                ;
288						                ; A is set to this value on entry to the routine.
289	>848e	8d				                .byte $8D
274						                ; Name of command, compared case-insensitively.
275	>848f	52 4f 4d 53			                .text "ROMS"

277						                ; Address of command routine, big-endian so that the
278						                ; first byte always has bit 7 set.
12:4	>8493	86				                .byte >starROMS
13	>8494	b9				                .byte <starROMS

281:5						                ; If bit 7 set, reset the tempFS flag before
282						                ; starting.
283	>8495	00				                .byte $00

285						                ; If bit 7 set, update string input buffer address
286						                ; before starting.
287						                ;
288						                ; A is set to this value on entry to the routine.
289	>8496	ff				                .byte $FF
274						                ; Name of command, compared case-insensitively.
275	>8497	53 41 56 45			                .text "SAVE"

277						                ; Address of command routine, big-endian so that the
278						                ; first byte always has bit 7 set.
12:4	>849b	94				                .byte >starCommandThroughOSFILE
13	>849c	f4				                .byte <starCommandThroughOSFILE

281:5						                ; If bit 7 set, reset the tempFS flag before
282						                ; starting.
283	>849d	80				                .byte $80

285						                ; If bit 7 set, update string input buffer address
286						                ; before starting.
287						                ;
288						                ; A is set to this value on entry to the routine.
289	>849e	00				                .byte $00
274						                ; Name of command, compared case-insensitively.
275	>849f	53 48 41 44 4f 57		                .text "SHADOW"

277						                ; Address of command routine, big-endian so that the
278						                ; first byte always has bit 7 set.
12:4	>84a5	96				                .byte >starSHADOW
13	>84a6	42				                .byte <starSHADOW

281:5						                ; If bit 7 set, reset the tempFS flag before
282						                ; starting.
283	>84a7	00				                .byte $00

285						                ; If bit 7 set, update string input buffer address
286						                ; before starting.
287						                ;
288						                ; A is set to this value on entry to the routine.
289	>84a8	ff				                .byte $FF
274						                ; Name of command, compared case-insensitively.
275	>84a9	53 48 4f 57			                .text "SHOW"

277						                ; Address of command routine, big-endian so that the
278						                ; first byte always has bit 7 set.
12:4	>84ad	96				                .byte >starSHOW
13	>84ae	64				                .byte <starSHOW

281:5						                ; If bit 7 set, reset the tempFS flag before
282						                ; starting.
283	>84af	00				                .byte $00

285						                ; If bit 7 set, update string input buffer address
286						                ; before starting.
287						                ;
288						                ; A is set to this value on entry to the routine.
289	>84b0	ff				                .byte $FF
274						                ; Name of command, compared case-insensitively.
275	>84b1	53 48 55 54			                .text "SHUT"

277						                ; Address of command routine, big-endian so that the
278						                ; first byte always has bit 7 set.
12:4	>84b5	f4				                .byte >mos.starSHUT
13	>84b6	3f				                .byte <mos.starSHUT

281:5						                ; If bit 7 set, reset the tempFS flag before
282						                ; starting.
283	>84b7	00				                .byte $00

285						                ; If bit 7 set, update string input buffer address
286						                ; before starting.
287						                ;
288						                ; A is set to this value on entry to the routine.
289	>84b8	00				                .byte $00
274						                ; Name of command, compared case-insensitively.
275	>84b9	53 50 4f 4f 4c			                .text "SPOOL"

277						                ; Address of command routine, big-endian so that the
278						                ; first byte always has bit 7 set.
12:4	>84be	96				                .byte >starSPOOL
13	>84bf	0f				                .byte <starSPOOL

281:5						                ; If bit 7 set, reset the tempFS flag before
282						                ; starting.
283	>84c0	80				                .byte $80

285						                ; If bit 7 set, update string input buffer address
286						                ; before starting.
287						                ;
288						                ; A is set to this value on entry to the routine.
289	>84c1	00				                .byte $00
274						                ; Name of command, compared case-insensitively.
275	>84c2	53 50 4f 4f 4c 4f 4e		                .text "SPOOLON"

277						                ; Address of command routine, big-endian so that the
278						                ; first byte always has bit 7 set.
12:4	>84c9	95				                .byte >starSPOOLON
13	>84ca	fc				                .byte <starSPOOLON

281:5						                ; If bit 7 set, reset the tempFS flag before
282						                ; starting.
283	>84cb	80				                .byte $80

285						                ; If bit 7 set, update string input buffer address
286						                ; before starting.
287						                ;
288						                ; A is set to this value on entry to the routine.
289	>84cc	00				                .byte $00
344						                .if version>=350
274						                ; Name of command, compared case-insensitively.
275	>84cd	53 52 44 41 54 41		                .text "SRDATA"

277						                ; Address of command routine, big-endian so that the
278						                ; first byte always has bit 7 set.
12:4	>84d3	8c				                .byte >starSRDATAOrStarSRROM
13	>84d4	ad				                .byte <starSRDATAOrStarSRROM

281:5						                ; If bit 7 set, reset the tempFS flag before
282						                ; starting.
283	>84d5	00				                .byte $00

285						                ; If bit 7 set, update string input buffer address
286						                ; before starting.
287						                ;
288						                ; A is set to this value on entry to the routine.
289	>84d6	a0				                .byte $a0
274						                ; Name of command, compared case-insensitively.
275	>84d7	53 52 4c 4f 41 44		                .text "SRLOAD"

277						                ; Address of command routine, big-endian so that the
278						                ; first byte always has bit 7 set.
12:4	>84dd	8d				                .byte >starSRLOADOrStarSRSAVE
13	>84de	ca				                .byte <starSRLOADOrStarSRSAVE

281:5						                ; If bit 7 set, reset the tempFS flag before
282						                ; starting.
283	>84df	80				                .byte $80

285						                ; If bit 7 set, update string input buffer address
286						                ; before starting.
287						                ;
288						                ; A is set to this value on entry to the routine.
289	>84e0	60				                .byte $60
274						                ; Name of command, compared case-insensitively.
275	>84e1	53 52 52 45 41 44		                .text "SRREAD"

277						                ; Address of command routine, big-endian so that the
278						                ; first byte always has bit 7 set.
12:4	>84e7	8d				                .byte >starSRREADOrStarSRWRITE
13	>84e8	7f				                .byte <starSRREADOrStarSRWRITE

281:5						                ; If bit 7 set, reset the tempFS flag before
282						                ; starting.
283	>84e9	00				                .byte $00

285						                ; If bit 7 set, update string input buffer address
286						                ; before starting.
287						                ;
288						                ; A is set to this value on entry to the routine.
289	>84ea	a0				                .byte $a0
274						                ; Name of command, compared case-insensitively.
275	>84eb	53 52 52 4f 4d			                .text "SRROM"

277						                ; Address of command routine, big-endian so that the
278						                ; first byte always has bit 7 set.
12:4	>84f0	8c				                .byte >starSRDATAOrStarSRROM
13	>84f1	ad				                .byte <starSRDATAOrStarSRROM

281:5						                ; If bit 7 set, reset the tempFS flag before
282						                ; starting.
283	>84f2	00				                .byte $00

285						                ; If bit 7 set, update string input buffer address
286						                ; before starting.
287						                ;
288						                ; A is set to this value on entry to the routine.
289	>84f3	80				                .byte $80
274						                ; Name of command, compared case-insensitively.
275	>84f4	53 52 53 41 56 45		                .text "SRSAVE"

277						                ; Address of command routine, big-endian so that the
278						                ; first byte always has bit 7 set.
12:4	>84fa	8d				                .byte >starSRLOADOrStarSRSAVE
13	>84fb	ca				                .byte <starSRLOADOrStarSRSAVE

281:5						                ; If bit 7 set, reset the tempFS flag before
282						                ; starting.
283	>84fc	80				                .byte $80

285						                ; If bit 7 set, update string input buffer address
286						                ; before starting.
287						                ;
288						                ; A is set to this value on entry to the routine.
289	>84fd	20				                .byte $20
274						                ; Name of command, compared case-insensitively.
275	>84fe	53 52 57 52 49 54 45		                .text "SRWRITE"

277						                ; Address of command routine, big-endian so that the
278						                ; first byte always has bit 7 set.
12:4	>8505	8d				                .byte >starSRREADOrStarSRWRITE
13	>8506	7f				                .byte <starSRREADOrStarSRWRITE

281:5						                ; If bit 7 set, reset the tempFS flag before
282						                ; starting.
283	>8507	00				                .byte $00

285						                ; If bit 7 set, update string input buffer address
286						                ; before starting.
287						                ;
288						                ; A is set to this value on entry to the routine.
289	>8508	e0				                .byte $e0
351						                .endif
352						                .if version<500&&version!=350
354						                .else
274						                ; Name of command, compared case-insensitively.
275	>8509	53 54 41 54 55 53		                .text "STATUS"

277						                ; Address of command routine, big-endian so that the
278						                ; first byte always has bit 7 set.
12:4	>850f	88				                .byte >starCONFIGUREOrStarSTATUS
13	>8510	56				                .byte <starCONFIGUREOrStarSTATUS

281:5						                ; If bit 7 set, reset the tempFS flag before
282						                ; starting.
283	>8511	00				                .byte $00

285						                ; If bit 7 set, update string input buffer address
286						                ; before starting.
287						                ;
288						                ; A is set to this value on entry to the routine.
289	>8512	c0				                .byte $c0
356						                .endif
357						                .if version<400
361						                .elsif version>=500
274						                ; Name of command, compared case-insensitively.
275	>8513	54 41 50 45			                .text "TAPE"

277						                ; Address of command routine, big-endian so that the
278						                ; first byte always has bit 7 set.
12:4	>8517	ff				                .byte >mos.rtsFFAA
13	>8518	aa				                .byte <mos.rtsFFAA

281:5						                ; If bit 7 set, reset the tempFS flag before
282						                ; starting.
283	>8519	00				                .byte $00

285						                ; If bit 7 set, update string input buffer address
286						                ; before starting.
287						                ;
288						                ; A is set to this value on entry to the routine.
289	>851a	8c				                .byte $8C
363						                .endif
274						                ; Name of command, compared case-insensitively.
275	>851b	54 56				                .text "TV"

277						                ; Address of command routine, big-endian so that the
278						                ; first byte always has bit 7 set.
12:4	>851d	95				                .byte >starCommandThroughOSBYTE
13	>851e	c7				                .byte <starCommandThroughOSBYTE

281:5						                ; If bit 7 set, reset the tempFS flag before
282						                ; starting.
283	>851f	00				                .byte $00

285						                ; If bit 7 set, update string input buffer address
286						                ; before starting.
287						                ;
288						                ; A is set to this value on entry to the routine.
289	>8520	90				                .byte $90
274						                ; Name of command, compared case-insensitively.
275	>8521	54 49 4d 45			                .text "TIME"

277						                ; Address of command routine, big-endian so that the
278						                ; first byte always has bit 7 set.
12:4	>8525	87				                .byte >starTIME
13	>8526	6f				                .byte <starTIME

281:5						                ; If bit 7 set, reset the tempFS flag before
282						                ; starting.
283	>8527	00				                .byte $00

285						                ; If bit 7 set, update string input buffer address
286						                ; before starting.
287						                ;
288						                ; A is set to this value on entry to the routine.
289	>8528	00				                .byte $00
274						                ; Name of command, compared case-insensitively.
275	>8529	54 59 50 45			                .text "TYPE"

277						                ; Address of command routine, big-endian so that the
278						                ; first byte always has bit 7 set.
12:4	>852d	90				                .byte >starTYPE
13	>852e	98				                .byte <starTYPE

281:5						                ; If bit 7 set, reset the tempFS flag before
282						                ; starting.
283	>852f	80				                .byte $80

285						                ; If bit 7 set, update string input buffer address
286						                ; before starting.
287						                ;
288						                ; A is set to this value on entry to the routine.
289	>8530	00				                .byte $00
274						                ; Name of command, compared case-insensitively.
275	>8531	55 4e 50 4c 55 47		                .text "UNPLUG"

277						                ; Address of command routine, big-endian so that the
278						                ; first byte always has bit 7 set.
12:4	>8537	87				                .byte >starUNPLUG
13	>8538	4d				                .byte <starUNPLUG

281:5						                ; If bit 7 set, reset the tempFS flag before
282						                ; starting.
283	>8539	00				                .byte $00

285						                ; If bit 7 set, update string input buffer address
286						                ; before starting.
287						                ;
288						                ; A is set to this value on entry to the routine.
289	>853a	ff				                .byte $FF
368						                .if version<500
370						                .endif
274						                ; Name of command, compared case-insensitively.
275	>853b					                .text ""

277						                ; Address of command routine, big-endian so that the
278						                ; first byte always has bit 7 set.
12:4	>853b	f2				                .byte >mos.callFSCV
13	>853c	93				                .byte <mos.callFSCV

281:5						                ; If bit 7 set, reset the tempFS flag before
282						                ; starting.
283	>853d	00				                .byte $00

285						                ; If bit 7 set, update string input buffer address
286						                ; before starting.
287						                ;
288						                ; A is set to this value on entry to the routine.
289	>853e	03				                .byte $03
372	>853f	00				                .byte $00

374						;-------------------------------------------------------------------------
375						;
376						; Get string input buffer address tail according to table byte.
377						;
378						; Entry:
379						;
380						; oscliWorkspace.tablePtr; = pointer to table byte
381						; (stringInputBufferAddress),y = pointer to input
382						;
383						; Exit:
384						;
385						; A = table byte
386						;
387						; if table byte bit 7 set: Y/X points to command line tail
388	.8540					maybeGetStringInputBufferAddress:
389	.8540	b2 b0		lda ($b0)	                lda (oscliWorkspace.tablePtr)
390	.8542	30 0c		bmi $8550	                bmi rts84FE
391	.8544					getStringInputBufferAddressWithYOffset:
392	.8544	98		tya		                tya
393	.8545					getStringInputBufferAddressWithAOffset:
394	.8545	18		clc		                clc
395	.8546	65 f2		adc $f2		                adc stringInputBufferAddress+0
396	.8548	aa		tax		                tax
397	.8549	a4 f3		ldy $f3		                ldy stringInputBufferAddress+1
398	.854b	90 01		bcc $854e	                bcc +
399	.854d	c8		iny		                iny
400	.854e					+
401	.854e	b2 b0		lda ($b0)	                lda (oscliWorkspace.tablePtr)
402	.8550					rts84FE:
403	.8550	60		rts		                rts

405						; Prepare OSCLI command line
406						; ==========================
407	.8551					oscli:
408	.8551	86 f2		stx $f2		                stx stringInputBufferAddress+0
409	.8553	84 f3		sty $f3		                sty stringInputBufferAddress+1
410	.8555	ad 00 df	lda $df00	                lda hazel.currentFS
411	.8558	20 9d fa	jsr $fa9d	                jsr mos.selectFS
412	.855b	a9 08		lda #$08	                lda #fscStarCommand
413	.855d	20 93 f2	jsr $f293	                jsr mos.callFSCV
414	.8560	a0 ff		ldy #$ff	                ldy #$FF
415	.8562					L8510:
416	.8562	20 ac f3	jsr $f3ac	                jsr mos.incAndSkipSpaces
417	.8565	f0 e9		beq $8550	                beq rts84FE
418	.8567	c9 2a		cmp #$2a	                cmp #'*'
419	.8569	f0 f7		beq $8562	                beq L8510
420	.856b	20 ad f3	jsr $f3ad	                jsr mos.skipSpacesAndCheckForCRInStringInput
421	.856e	f0 e0		beq $8550	                beq rts84FE
422	.8570	c9 7c		cmp #$7c	                cmp #'|'
423	.8572	f0 dc		beq $8550	                beq rts84FE
424	.8574	9c c6 df	stz $dfc6	                stz hazel.tempFSFlag
425	.8577	c9 2d		cmp #$2d	                cmp #'-'
426	.8579	d0 0c		bne $8587	                bne L8535
427	.857b	20 f6 f9	jsr $f9f6	                jsr mos.parseFileNameFS
428	.857e	20 9d fa	jsr $fa9d	                jsr mos.selectFS
429	.8581	38		sec		                sec
430	.8582	6e c6 df	ror $dfc6	                ror hazel.tempFSFlag
431	.8585	b1 f2		lda ($f2),y	                lda (stringInputBufferAddress),y
432	.8587					L8535:
433	.8587	c9 2f		cmp #$2f	                cmp #'/'
434	.8589	d0 09		bne $8594	                bne L8542
435	.858b	c8		iny		                iny
436	.858c	20 44 85	jsr $8544	                jsr getStringInputBufferAddressWithYOffset
437	.858f	a9 02		lda #$02	                lda #fscStarSlash
438	.8591	4c 93 f2	jmp $f293	                jmp mos.callFSCV

440	.8594					L8542:
441						                .if version<500&&version!=350
443						                .endif
444	.8594	a9 83		lda #$83	                lda #<mosCommandTable
445	.8596	85 b0		sta $b0		                sta oscliWorkspace.tablePtr+0
446	.8598	a9 83		lda #$83	                lda #>mosCommandTable
447	.859a	85 b1		sta $b1		                sta oscliWorkspace.tablePtr+1
448						                .if version<500&&version!=350
450						                .else
451	.859c	b8		clv		                clv
452	.859d	20 8f 8a	jsr $8a8f	                jsr findCommand
453	.85a0	90 20		bcc $85c2	                bcc passStarCommandThrough
454						                .endif

456						                .if version<500&&version!=350
490						                .endif
491	.85a2					L8585:
492	.85a2	48		pha		                pha
493	.85a3	20 ce 8a	jsr $8ace	                jsr fetchCommandTableByte
494	.85a6	48		pha		                pha
495	.85a7	20 ce 8a	jsr $8ace	                jsr fetchCommandTableByte
496	.85aa	30 03		bmi $85af	                bmi L8592
497	.85ac	9c c6 df	stz $dfc6	                stz hazel.tempFSFlag
498	.85af					L8592:
499	.85af	20 ad f3	jsr $f3ad	                jsr mos.skipSpacesAndCheckForCRInStringInput
500	.85b2	18		clc		                clc
501	.85b3	08		php		                php
502	.85b4	20 40 85	jsr $8540	                jsr maybeGetStringInputBufferAddress
503	.85b7	40		rti		                rti

505						                .if version<500&&version!=350
516						                .endif

518						;-------------------------------------------------------------------------

520						; *BASIC
521						; ======
522	.85b8					starBASIC:
523	.85b8	ae 4b 02	ldx $024b	                ldx basicROMNumber           ; Get BASIC ROM number
524	.85bb	30 05		bmi $85c2	                bmi passStarCommandThrough ; If no BASIC ROM, jump to pass to ROMs and filing system
525						                .if version==350
530						                .else
531	.85bd	a9 8e		lda #$8e	                lda #$8e
532	.85bf	4c f4 ff	jmp $fff4	                jmp OSBYTE
533						                .endif

535						;-------------------------------------------------------------------------

537						; *ADFS - pass straight to ROMs/Filing System
538						; ===========================================
539	.85c2					passStarCommandThrough:
540	.85c2	2c c6 df	bit $dfc6	                bit hazel.tempFSFlag      ; Check filing system flag
541	.85c5	30 0c		bmi $85d3	                bmi L85C0                    ; If ... skip ROM service call
542	.85c7	9c c6 df	stz $dfc6	                stz hazel.tempFSFlag      ; Clear filing system flag
543	.85ca	a4 e6		ldy $e6		                ldy $E6
544	.85cc	a2 04		ldx #$04	                ldx #romServiceCallUnrecognisedCommand
545	.85ce	20 89 ee	jsr $ee89	                jsr mos.osbyte8F    ; Service call 4 - Unknown command
546						                .if version<500&&version!=350
548						                .else
549	.85d1	f0 4d		beq $8620	                beq parseDone
550						                .endif
551	.85d3					L85C0:
552	.85d3	a5 e6		lda $e6		                lda $E6
553	.85d5	20 45 85	jsr $8545	                jsr getStringInputBufferAddressWithAOffset
554	.85d8	a9 03		lda #$03	                lda #$03
555	.85da	4c 93 f2	jmp $f293	                jmp mos.callFSCV ; mos.Pass to FSCV,3 - Unknown command

557	.85dd					starHELP:
558	.85dd	a2 09		ldx #$09	                ldx #romServiceCallHelp      ;
559	.85df	a5 d0		lda $d0		                lda STATE                    ;
560	.85e1	48		pha		                pha                          ;save STATE
561	.85e2	a9 0e		lda #$0e	                lda #14
562	.85e4	20 ee ff	jsr $ffee	                jsr OSWRCH                   ; paged mode ON
563	.85e7	20 f8 ee	jsr $eef8	                jsr mos.makeROMServiceCall   ;
564	.85ea	a2 18		ldx #$18	                ldx #romServiceCallReserved  ;???
565	.85ec	20 f8 ee	jsr $eef8	                jsr mos.makeROMServiceCall
566	.85ef	68		pla		                pla                          ;restore STATE
567	.85f0	89 04		bit #$04	                bit #STATE.isPagedScrolling  ;was paged mode on originally?
568	.85f2	d0 2c		bne $8620	                bne parseDone   ;taken if paged mode was originally on
569						                                ;(branch target is an arbitrary nearby
570						                                ;RTS)
571	.85f4	a9 0f		lda #$0f	                lda #15         ;restore non-paged mode
572	.85f6	4c ee ff	jmp $ffee	                jmp OSWRCH

574						;-------------------------------------------------------------------------
575						;
576						; Read a byte value (0-255) from a string. If the number has a '&'
577						; prefix, interpret it as hex.
578						;
579						; entry:
580						;
581						; (stringInputBufferAddress),y - string
582						;
583						; exit:
584						;
585						; X = result
586						; ?$e6 = result
587						; C=0 if error
588						; Z=1 if CR encountered
589						;
590	.85f9					parseNumberFromString:
591	.85f9	20 ad f3	jsr $f3ad	                jsr mos.skipSpacesAndCheckForCRInStringInput
592	.85fc	c9 26		cmp #$26	                cmp #'&'                     ; hex value incoming?
593	.85fe	d0 21		bne $8621	                bne parseDecimal             ; taken if not hex value
594	.8600					parseHex:
595	.8600	c8		iny		                iny                          ; skip '&'
596	.8601	20 5b 86	jsr $865b	                jsr readHexDigit             ; read first hex digit
597	.8604	90 53		bcc $8659	                bcc errorReadingString
598	.8606	85 e6		sta $e6		                sta $E6                      ; save first hex digit
599	.8608	20 5b 86	jsr $865b	                jsr readHexDigit             ; read second hex digih
600	.860b	90 0e		bcc $861b	                bcc parsedValue         ; taken if not hex digit
601						                ; The first digit read was actually the high nybble,
602						                ; and the current digit read is therefore the low
603						                ; nybble.
604						                ;
605						                ; Shift saved digit 4 bits left.
606	.860d	a2 04		ldx #$04	                ldx #$04
607	.860f					-
608	.860f	06 e6		asl $e6		                asl $E6
609	.8611	ca		dex		                dex
610	.8612	d0 fb		bne $860f	                bne -
611	.8614	04 e6		tsb $e6		                tsb $E6                      ; insert low nybble
612	.8616	20 5b 86	jsr $865b	                jsr readHexDigit             ; read third hex digit
613	.8619	b0 29		bcs $8644	                bcs errorReadingString2 ; 3+-digit hex values are not valid
614	.861b					parsedValue:
615	.861b	a6 e6		ldx $e6		                ldx $E6
616	.861d	c9 0d		cmp #$0d	                cmp #$0D
617	.861f	38		sec		                sec
618	.8620					parseDone:
619	.8620	60		rts		                rts

621	.8621					parseDecimal:
622	.8621	20 47 86	jsr $8647	                jsr readDigitFromString
623	.8624	90 33		bcc $8659	                bcc errorReadingString      ;branch taken if not digit
624	.8626					parseDecimalDigit:
625	.8626	85 e6		sta $e6		                sta $E6                     ;save current value
626	.8628	20 46 86	jsr $8646	                jsr readNextDigitFromString
627	.862b	90 ee		bcc $861b	                bcc parsedValue ;branch taken if not digit, meaning number
628						                                     ;parsed successfully
629	.862d	aa		tax		                tax                         ;X=digit

631						                ; calculate (value*4+value)*2 - i.e., value*10. Carry
632						                ; at any point indicates the value was greater than
633						                ; 255, and therefore an error.
634	.862e	a5 e6		lda $e6		                lda $E6                     ;value
635	.8630	0a		asl a		                asl a                       ;value*2
636	.8631	b0 26		bcs $8659	                bcs errorReadingString
637	.8633	0a		asl a		                asl a                       ;value*4
638	.8634	b0 23		bcs $8659	                bcs errorReadingString
639	.8636	65 e6		adc $e6		                adc $E6                     ;value*5
640	.8638	b0 1f		bcs $8659	                bcs errorReadingString
641	.863a	0a		asl a		                asl a                       ;value*10
642	.863b	b0 1c		bcs $8659	                bcs errorReadingString
643	.863d	85 e6		sta $e6		                sta $E6                      ;save value*10
644	.863f	8a		txa		                txa                          ;A=digit
645	.8640	65 e6		adc $e6		                adc $E6                      ;value*10+digit
646	.8642	90 e2		bcc $8626	                bcc parseDecimalDigit
647	.8644					errorReadingString2:
648	.8644	18		clc		                clc
649	.8645	60		rts		                rts

651	.8646					readNextDigitFromString:
652	.8646	c8		iny		                iny

654						; check if current string input byte is a digit.
655						;
656						; exit: C=1 if digit; C=0 if not digit
657	.8647					readDigitFromString:
658	.8647	b1 f2		lda ($f2),y	                lda (stringInputBufferAddress),y
659	.8649	c9 3a		cmp #$3a	                cmp #'9'+1
660	.864b	b0 0c		bcs $8659	                bcs errorReadingString       ;taken if not ASCII decimal digit
661	.864d	c9 30		cmp #$30	                cmp #'0'
662	.864f	90 08		bcc $8659	                bcc errorReadingString       ;taken if not ASCII decimal digit
663	.8651	29 0f		and #$0f	                and #$0F         ;convert ASCII decimaldigit to number
664	.8653	60		rts		                rts

666	.8654					L8641:
667	.8654	20 ad f3	jsr $f3ad	                jsr mos.skipSpacesAndCheckForCRInStringInput
668						                .if version!=350
669	.8657	c9 0d		cmp #$0d	                cmp #$0D
670						                .endif
671	.8659					errorReadingString:
672	.8659	18		clc		                clc
673	.865a	60		rts		                rts

675						;-------------------------------------------------------------------------
676						;
677						; Read a hex digit from a string
678						;
679						; entry:
680						;
681						; (stringInputBufferAddress),y = next byte to read
682						;
683						; exit:
684						;
685						; C=1 if ok: A = digit read
686						;
687						; C=0 if error: Z=1 if CR encountered
688						;
689	.865b					readHexDigit:
690	.865b	20 47 86	jsr $8647	                jsr readDigitFromString
691	.865e	b0 0d		bcs $866d	                bcs +                        ; branch taken if digit
692	.8660	29 df		and #$df	                and #$DF                     ; convert to upper case
693	.8662	c9 47		cmp #$47	                cmp #'F'+1
694	.8664	b0 ee		bcs $8654	                bcs L8641    ; branch taken if not ASCII A-F hex digit
695	.8666	c9 41		cmp #$41	                cmp #'A'
696	.8668	90 ea		bcc $8654	                bcc L8641     ;branch taken if not ASCII A-F hex digit
697						                ; convert ASCII A-F hex digit to number.
698	.866a	49 48		eor #$48	                eor #$48
699	.866c	1a		inc a		                inc a
700	.866d					+
701	.866d	c8		iny		                iny
702	.866e	60		rts		                rts

704						;-------------------------------------------------------------------------
705						;
706						; OSWORD 0 control block for *commands
707						; ====================================
708	.866f					commandLineUIOSWORD0Parameters:
709	>866f	00 dc				                .word hazel.commandLine      ; address
710	>8671	f0				                .byte $F0			; max # chars
711	>8672	20				                .byte $20			; min ASCII char
712	>8673	7e				                .byte $7E			; max ASCII char

714						;-------------------------------------------------------------------------

716	.8674					commandLineUI:
717	.8674	a9 a0		lda #$a0	                lda #<commandLineUIBRKHandler
718	.8676	8d 02 02	sta $0202	                sta BRKV+0
719	.8679	a9 86		lda #$86	                lda #>commandLineUIBRKHandler
720	.867b	8d 03 02	sta $0203	                sta BRKV+1
721	.867e	a9 1f		lda #$1f	                lda #$10|terminalROM         ;????
722	.8680	8d 8c 02	sta $028c	                sta currentLanguageROM
723	.8683					commandLineUILoop:
724	.8683	a2 ff		ldx #$ff	                ldx #$FF
725	.8685	9a		txs		                txs
726	.8686	58		cli		                cli
727	.8687	20 40 ee	jsr $ee40	                jsr mos.selectHAZEL
728	.868a	a9 2a		lda #$2a	                lda #'*'
729	.868c	20 ee ff	jsr $ffee	                jsr OSWRCH
730	.868f	20 b0 86	jsr $86b0	                jsr readCommandLine
731	.8692	90 03		bcc $8697	                bcc +                     ;taken if ESCAPE not pressed
732	.8694	4c 60 ac	jmp $ac60	                jmp escapeError
733	.8697					+
734	.8697	a2 00		ldx #$00	                ldx #<hazel.commandLine
735	.8699	a0 dc		ldy #$dc	                ldy #>hazel.commandLine
736	.869b	20 f7 ff	jsr $fff7	                jsr OSCLI
737	.869e	80 e3		bra $8683	                bra commandLineUILoop

739	.86a0					commandLineUIBRKHandler:
740	.86a0	20 e7 ff	jsr $ffe7	                jsr OSNEWL
741	.86a3	a0 00		ldy #$00	                ldy #$00
742	.86a5	20 81 e7	jsr $e781	                jsr mos.printBRKMessage
743	.86a8	20 e7 ff	jsr $ffe7	                jsr OSNEWL
744	.86ab	80 c7		bra $8674	                bra commandLineUI

746	.86ad					badCommandError869A:
747	.86ad	4c 3d fb	jmp $fb3d	                jmp mos.badCommandError

749	.86b0					readCommandLine:
750	.86b0	a9 00		lda #$00	                lda #$00
751	.86b2	a2 6f		ldx #$6f	                ldx #<commandLineUIOSWORD0Parameters
752	.86b4	a0 86		ldy #$86	                ldy #>commandLineUIOSWORD0Parameters
753	.86b6	4c f1 ff	jmp $fff1	                jmp OSWORD

755						;-------------------------------------------------------------------------
756						;
757						; *ROMS [MasRef C.5-10]
758						;
759	.86b9					starROMS:
760	.86b9	20 ad f3	jsr $f3ad	                jsr mos.skipSpacesAndCheckForCRInStringInput
761	.86bc	d0 ef		bne $86ad	                bne badCommandError869A
762	.86be	a0 0f		ldy #$0f	                ldy #$0F
763	.86c0					printROMsLoop:
764						                .if version<400&&version!=350
771						                .else
772	.86c0	98		tya		                tya
773	.86c1	aa		tax		                tax
774	.86c2	5a		phy		                phy
775	.86c3	20 9a f8	jsr $f89a	                jsr mos.LF89A
776	.86c6	b0 0a		bcs $86d2	                bcs L86D2
777	.86c8	20 27 ad	jsr $ad27	                jsr alwaysPrintFollowingMessage
778	>86cb	52 4f 4d 20 00			                .text "ROM ",0
779	.86d0	80 08		bra $86da	                bra L86DA
780	.86d2					L86D2:
781	.86d2	20 27 ad	jsr $ad27	                jsr alwaysPrintFollowingMessage
782	>86d5	52 41 4d 20 00			                .text "RAM ",0
783	.86da					L86DA:
784	.86da	7a		ply		                ply
785	.86db	98		tya		                tya
786						                .endif
787	.86dc	20 42 ac	jsr $ac42	                jsr printHexDigit            ;print ROM slot
788	.86df	20 80 a3	jsr $a380	                jsr printSpace
789	.86e2	a9 09		lda #$09	                lda #<sidewaysROMName
790	.86e4	85 f6		sta $f6		                sta $F6
791	.86e6	a9 80		lda #$80	                lda #>sidewaysROMName
792	.86e8	85 f7		sta $f7		                sta $F7
793						                .if version<400&&version!=350
795						                .endif
796	.86ea	20 a0 e5	jsr $e5a0	                jsr mos.isROMValidThenSelectTerminalROM
797						                .if version<400&&version!=350
799						                .endif
800	.86ed	90 49		bcc $8738	                bcc invalidROM
801						                .if version>=500||version==350
802	.86ef	b9 a1 02	lda $02a1,y	                lda romInformationTable,y
803	.86f2	3a		dec a		                dec a
804	.86f3	f0 43		beq $8738	                beq invalidROM
805						                .endif
806	.86f5					printROMNameLoop:
807	.86f5	20 c8 f4	jsr $f4c8	                jsr mos.osrdscEntryPoint     ;read name byte
808	.86f8	c9 20		cmp #$20	                cmp #' '
809	.86fa	90 0f		bcc $870b	                bcc printROMVersion ;taken if non-printable char, including the terminating 0
810	.86fc	c9 7f		cmp #$7f	                cmp #127
811	.86fe	b0 38		bcs $8738	                bcs invalidROM  ;taken if bad (bit 7 set) char in name
812	.8700	20 ee ff	jsr $ffee	                jsr OSWRCH
813	.8703	e6 f6		inc $f6		                inc $F6
814	.8705	24 f6		bit $f6		                bit $F6
815	.8707	50 ec		bvc $86f5	                bvc printROMNameLoop         ;taken if address<$8040
816	.8709	80 2d		bra $8738	                bra invalidROM               ;taken if name too long

818	.870b					printROMVersion:
819	.870b	aa		tax		                tax               ;Z=1 if final char was the expected 0
820	.870c	d0 2a		bne $8738	                bne invalidROM    ;taken if bad (control) char in name
821	.870e	a9 08		lda #$08	                lda #<sidewaysROMVersion
822	.8710	85 f6		sta $f6		                sta $F6
823	.8712	a9 80		lda #$80	                lda #>sidewaysROMVersion
824	.8714	85 f7		sta $f7		                sta $F7
825	.8716	20 c8 f4	jsr $f4c8	                jsr mos.osrdscEntryPoint
826	.8719	20 34 ac	jsr $ac34	                jsr printSpaceThenPrintHexByte
827	.871c					printInsertionStatus:
828	.871c	5a		phy		                phy
829						                .if version<500&&version!=350
834						                .else
835	.871d	20 3f 87	jsr $873f	                jsr L873F
836						                .endif
837	.8720	d0 0e		bne $8730	                bne +
838	.8722	20 27 ad	jsr $ad27	                jsr alwaysPrintFollowingMessage
839	>8725	20 75 6e 70 6c 75 67 67		                .text " unplugged",0
	>872d	65 64 00
840	.8730					+
841	.8730	7a		ply		                ply
842	.8731	20 e7 ff	jsr $ffe7	                jsr OSNEWL
843	.8734	88		dey		                dey
844	.8735	10 89		bpl $86c0	                bpl printROMsLoop
845	.8737	60		rts		                rts

847	.8738					invalidROM:
848	.8738	a9 3f		lda #$3f	                lda #'?'
849	.873a	20 ee ff	jsr $ffee	                jsr OSWRCH
850	.873d	80 dd		bra $871c	                bra printInsertionStatus

852						;-------------------------------------------------------------------------

854						                .if version>=500||version==350
855	.873f					L873F:
856	.873f	20 e6 ea	jsr $eae6	                jsr mos.getROMInsertedFlagRTCAddressAndMask
857	.8742	85 b0		sta $b0		                sta $b0
858	.8744	20 ca 9d	jsr $9dca	                jsr readRTCByte
859	.8747	25 b0		and $b0		                and $b0
860	.8749	60		rts		                rts
861						                .endif

863						;-------------------------------------------------------------------------
864						;
865						; *INSERT [MasRef C.5-8]
866						;
867	.874a					starINSERT:
868	.874a	38		sec		                sec
869	.874b	80 01		bra $874e	                bra starINSERTOrStarUNPLUG

871						;-------------------------------------------------------------------------
872						;
873						; *UNPLUG [MasRef C.5-13]
874						;
875	.874d					starUNPLUG:
876	.874d	18		clc		                clc
877	.874e					starINSERTOrStarUNPLUG:
878	.874e	08		php		                php
879	.874f	20 ad f3	jsr $f3ad	                jsr mos.skipSpacesAndCheckForCRInStringInput
880						                .if version<500&&version!=350
882						                .else
883	.8752	20 53 89	jsr $8953	                jsr L8953
884						                .endif
885	.8755	a8		tay		                tay                          ;Y=ROM number
886	.8756	20 e6 ea	jsr $eae6	                jsr mos.getROMInsertedFlagRTCAddressAndMask
887	.8759	48		pha		                pha
888	.875a	20 ca 9d	jsr $9dca	                jsr readRTCByte
889	.875d	84 b0		sty $b0		                sty starROMSWorkspace.insertedFlagMask
890	.875f	68		pla		                pla
891	.8760	28		plp		                plp
892	.8761	90 04		bcc $8767	                bcc unplug                   ;taken if it's *UNPLUG

894						                ; it's *INSERT
895	.8763	05 b0		ora $b0		                ora starROMSWorkspace.insertedFlagMask
896	.8765	80 04		bra $876b	                bra +
897	.8767					unplug:
898	.8767	49 ff		eor #$ff	                eor #$FF
899	.8769	25 b0		and $b0		                and starROMSWorkspace.insertedFlagMask
900	.876b					+
901	.876b	a8		tay		                tay
902	.876c	4c 02 9e	jmp $9e02	                jmp writeRTCByte

904						;-------------------------------------------------------------------------
905						;
906						; *TIME [MasRef C.5-12]
907						;
908	.876f					starTIME:
909	.876f	9c 00 dc	stz $dc00	                stz hazel.commandLine
910	.8772	a2 00		ldx #$00	                ldx #<hazel.commandLine
911	.8774	a0 dc		ldy #$dc	                ldy #>hazel.commandLine
912	.8776	a9 0e		lda #$0e	                lda #$0E
913	.8778	20 f1 ff	jsr $fff1	                jsr OSWORD
914	.877b	a2 e7		ldx #$e7	                ldx #256-size(ClockStringFormat)
915	.877d					L8752:
916	.877d	bd 19 db	lda $db19,x	                lda hazel.commandLine-(256-size(ClockStringFormat)),x
917	.8780	20 e3 ff	jsr $ffe3	                jsr OSASCI
918	.8783	e8		inx		                inx
919	.8784	d0 f7		bne $877d	                bne L8752
920	.8786	60		rts		                rts

922						;-------------------------------------------------------------------------

924						                .if version==350
933						                .elsif version>=500
934						                .include "configure500.s65"

:7	;******  Processing file: src/configure500.s65

1						byte2: .macro value,value350
7						                .endmacro

9						                ; Metadata layout

11						                ; +0

13						                ;   7   6   5   4   3   2   1   0
14						                ; +---+---+---+---+---+---+---+---+
15						                ; |X  |V0 |MaskCount  |Value      |
16						                ; +---+---+---+---+---+---+---+---+

18						                ; X is unused - it's generally set in the configure
19						                ; table, so that the names can be terminated by a byte
20						                ; with bit 7 set.
21						                ;
22						                ; If V0 is clear, this field is actually the address
23						                ; of a routine.
24						                ;
25						                ; Value is the value for the bitfield when this option
26						                ; is in effect.
27						                ;
28						                ; MaskCount
29						                ;

31						                ; +1

33						                ;   7   6   5   4   3   2   1   0
34						                ; +---+---+---+---+---+---+---+---+
35						                ; |N1 |RTCByteIndex   |ShiftCount |
36						                ; +---+---+---+---+---+---+---+---+
37						                ;
38						                ; N1 = tested by L8ADF

40						                ; The RTC byte indexes in the table are actually
41						                ; offset.
42						                .if version==350
44						                .else
45	=5					rtcByteIndexOffset=cmosBytesOffset+CMOSBytes.defaultROMs
46						                .endif

48						itemWithAddress: .macro name,addr
53						                .endmacro

55						countLS0s: .function value
75						                .endfunction n

77						itemMaskInfo: .macro value
83						                .endmacro

85						itemMetadata: .macro topMask,rtcByteIndex,mask,matchValue,n1
96						                .endmacro

98						itemWithMetadata: .macro name,rtcByteIndex,mask,matchValue,n1
102						                .endmacro

104	.8787					configureTable: .block
49	>8787	2e				                .text "."
50	.8788					metadata:
51						                .cerror (printConfigureOrStatusHeader&$c000)!=$8000
12:4	>8788	89				                .byte >printConfigureOrStatusHeader-1
13	>8789	bc				                .byte <printConfigureOrStatusHeader-1
106:7	.878a					baud:
99	>878a	42 61 75 64			                .text ("Baud")
100	.878e					metadata:
86						                ; constants need some rationalisation here...
87						                .cerror ((CMOSBytes.defaults2))<(rtcByteIndexOffset)-cmosBytesOffset
88						                .cerror ((CMOSBytes.defaults2))>=(rtcByteIndexOffset)+16-cmosBytesOffset
89						                .cerror !(((0))>=0&&((0))<8)
90						                .cerror ((CMOSBytes.defaults2.serialBaudRateIndexMask<<CMOSBytes.defaults2.serialBaudRateIndexShift))<0||((CMOSBytes.defaults2.serialBaudRateIndexMask<<CMOSBytes.defaults2.serialBaudRateIndexShift))>256,format("Bad mask: $%02x",(CMOSBytes.defaults2.serialBaudRateIndexMask<<CMOSBytes.defaults2.serialBaudRateIndexShift))

92	.878e					info:
78	=2					shift=countLS0s(((CMOSBytes.defaults2.serialBaudRateIndexMask<<CMOSBytes.defaults2.serialBaudRateIndexShift)))
79	=7					unshiftedMask=(((CMOSBytes.defaults2.serialBaudRateIndexMask<<CMOSBytes.defaults2.serialBaudRateIndexShift)))>>shift
80						                .cerror (unshiftedMask&(unshiftedMask+1))!=0,format("bad mask: $%02x (shift: %d; unshifted: $%02x)",((CMOSBytes.defaults2.serialBaudRateIndexMask<<CMOSBytes.defaults2.serialBaudRateIndexShift)),shift,unshiftedMask)
81	=3					maskWidth=countLS0s(~unshiftedMask)
82						                .cerror !(maskWidth>=1&&maskWidth<=8),format("bad mask: $%02x",((CMOSBytes.defaults2.serialBaudRateIndexMask<<CMOSBytes.defaults2.serialBaudRateIndexShift)))

94	>878e	d0				                .byte ($c0)|((info.maskWidth-1)<<3)|((0))
95	>878f	d2				                .byte (((true))?$80:$00)|(((CMOSBytes.defaults2)-(rtcByteIndexOffset-cmosBytesOffset))<<3)|info.shift
107	.8790					boot:
99	>8790	42 6f 6f 74			                .text ("Boot")
100	.8794					metadata:
86						                ; constants need some rationalisation here...
87						                .cerror ((CMOSBytes.defaults3))<(rtcByteIndexOffset)-cmosBytesOffset
88						                .cerror ((CMOSBytes.defaults3))>=(rtcByteIndexOffset)+16-cmosBytesOffset
89						                .cerror !(((1))>=0&&((1))<8)
90						                .cerror ((CMOSBytes.defaults3.autoBootMask))<0||((CMOSBytes.defaults3.autoBootMask))>256,format("Bad mask: $%02x",(CMOSBytes.defaults3.autoBootMask))

92	.8794					info:
78	=4					shift=countLS0s(((CMOSBytes.defaults3.autoBootMask)))
79	=1					unshiftedMask=(((CMOSBytes.defaults3.autoBootMask)))>>shift
80						                .cerror (unshiftedMask&(unshiftedMask+1))!=0,format("bad mask: $%02x (shift: %d; unshifted: $%02x)",((CMOSBytes.defaults3.autoBootMask)),shift,unshiftedMask)
81	=1					maskWidth=countLS0s(~unshiftedMask)
82						                .cerror !(maskWidth>=1&&maskWidth<=8),format("bad mask: $%02x",((CMOSBytes.defaults3.autoBootMask)))

94	>8794	c1				                .byte ($c0)|((info.maskWidth-1)<<3)|((1))
95	>8795	5c				                .byte (((false))?$80:$00)|(((CMOSBytes.defaults3)-(rtcByteIndexOffset-cmosBytesOffset))<<3)|info.shift
99	>8796	43 61 70 73			                .text ("Caps")
100	.879a					metadata:
86						                ; constants need some rationalisation here...
87						                .cerror ((CMOSBytes.defaults1))<(rtcByteIndexOffset)-cmosBytesOffset
88						                .cerror ((CMOSBytes.defaults1))>=(rtcByteIndexOffset)+16-cmosBytesOffset
89						                .cerror !(((4))>=0&&((4))<8)
90						                .cerror (((CMOSBytes.defaults1.defaultCapsLockMask|CMOSBytes.defaults1.defaultShiftLockMask|CMOSBytes.defaults1.defaultNoLockMask)))<0||(((CMOSBytes.defaults1.defaultCapsLockMask|CMOSBytes.defaults1.defaultShiftLockMask|CMOSBytes.defaults1.defaultNoLockMask)))>256,format("Bad mask: $%02x",((CMOSBytes.defaults1.defaultCapsLockMask|CMOSBytes.defaults1.defaultShiftLockMask|CMOSBytes.defaults1.defaultNoLockMask)))

92	.879a					info:
78	=3					shift=countLS0s((((CMOSBytes.defaults1.defaultCapsLockMask|CMOSBytes.defaults1.defaultShiftLockMask|CMOSBytes.defaults1.defaultNoLockMask))))
79	=7					unshiftedMask=((((CMOSBytes.defaults1.defaultCapsLockMask|CMOSBytes.defaults1.defaultShiftLockMask|CMOSBytes.defaults1.defaultNoLockMask))))>>shift
80						                .cerror (unshiftedMask&(unshiftedMask+1))!=0,format("bad mask: $%02x (shift: %d; unshifted: $%02x)",(((CMOSBytes.defaults1.defaultCapsLockMask|CMOSBytes.defaults1.defaultShiftLockMask|CMOSBytes.defaults1.defaultNoLockMask))),shift,unshiftedMask)
81	=3					maskWidth=countLS0s(~unshiftedMask)
82						                .cerror !(maskWidth>=1&&maskWidth<=8),format("bad mask: $%02x",(((CMOSBytes.defaults1.defaultCapsLockMask|CMOSBytes.defaults1.defaultShiftLockMask|CMOSBytes.defaults1.defaultNoLockMask))))

94	>879a	d4				                .byte ($c0)|((info.maskWidth-1)<<3)|((4))
95	>879b	33				                .byte (((false))?$80:$00)|(((CMOSBytes.defaults1)-(rtcByteIndexOffset-cmosBytesOffset))<<3)|info.shift
109						                .if olivetti
111						                .endif
112	.879c					data:
99	>879c	44 61 74 61			                .text ("Data")
100	.87a0					metadata:
86						                ; constants need some rationalisation here...
87						                .cerror ((CMOSBytes.defaults3))<(rtcByteIndexOffset)-cmosBytesOffset
88						                .cerror ((CMOSBytes.defaults3))>=(rtcByteIndexOffset)+16-cmosBytesOffset
89						                .cerror !(((0))>=0&&((0))<8)
90						                .cerror ((CMOSBytes.defaults3.defaultSerialDataFormatMask<<CMOSBytes.defaults3.defaultSerialDataFormatShift))<0||((CMOSBytes.defaults3.defaultSerialDataFormatMask<<CMOSBytes.defaults3.defaultSerialDataFormatShift))>256,format("Bad mask: $%02x",(CMOSBytes.defaults3.defaultSerialDataFormatMask<<CMOSBytes.defaults3.defaultSerialDataFormatShift))

92	.87a0					info:
78	=5					shift=countLS0s(((CMOSBytes.defaults3.defaultSerialDataFormatMask<<CMOSBytes.defaults3.defaultSerialDataFormatShift)))
79	=7					unshiftedMask=(((CMOSBytes.defaults3.defaultSerialDataFormatMask<<CMOSBytes.defaults3.defaultSerialDataFormatShift)))>>shift
80						                .cerror (unshiftedMask&(unshiftedMask+1))!=0,format("bad mask: $%02x (shift: %d; unshifted: $%02x)",((CMOSBytes.defaults3.defaultSerialDataFormatMask<<CMOSBytes.defaults3.defaultSerialDataFormatShift)),shift,unshiftedMask)
81	=3					maskWidth=countLS0s(~unshiftedMask)
82						                .cerror !(maskWidth>=1&&maskWidth<=8),format("bad mask: $%02x",((CMOSBytes.defaults3.defaultSerialDataFormatMask<<CMOSBytes.defaults3.defaultSerialDataFormatShift)))

94	>87a0	d0				                .byte ($c0)|((info.maskWidth-1)<<3)|((0))
95	>87a1	dd				                .byte (((true))?$80:$00)|(((CMOSBytes.defaults3)-(rtcByteIndexOffset-cmosBytesOffset))<<3)|info.shift
99	>87a2	44 65 6c 61 79			                .text ("Delay")
100	.87a7					metadata:
86						                ; constants need some rationalisation here...
87						                .cerror ((CMOSBytes.keyboardAutoRepeatDelay))<(rtcByteIndexOffset)-cmosBytesOffset
88						                .cerror ((CMOSBytes.keyboardAutoRepeatDelay))>=(rtcByteIndexOffset)+16-cmosBytesOffset
89						                .cerror !(((0))>=0&&((0))<8)
90						                .cerror (($ff))<0||(($ff))>256,format("Bad mask: $%02x",($ff))

92	.87a7					info:
78	=0					shift=countLS0s((($ff)))
79	=$ff					unshiftedMask=((($ff)))>>shift
80						                .cerror (unshiftedMask&(unshiftedMask+1))!=0,format("bad mask: $%02x (shift: %d; unshifted: $%02x)",(($ff)),shift,unshiftedMask)
81	=8					maskWidth=countLS0s(~unshiftedMask)
82						                .cerror !(maskWidth>=1&&maskWidth<=8),format("bad mask: $%02x",(($ff)))

94	>87a7	f8				                .byte ($c0)|((info.maskWidth-1)<<3)|((0))
95	>87a8	b8				                .byte (((true))?$80:$00)|(((CMOSBytes.keyboardAutoRepeatDelay)-(rtcByteIndexOffset-cmosBytesOffset))<<3)|info.shift
114	.87a9					dir:
99	>87a9	44 69 72			                .text ("Dir")
100	.87ac					metadata:
86						                ; constants need some rationalisation here...
87						                .cerror ((CMOSBytes.defaults1))<(rtcByteIndexOffset)-cmosBytesOffset
88						                .cerror ((CMOSBytes.defaults1))>=(rtcByteIndexOffset)+16-cmosBytesOffset
89						                .cerror !(((0))>=0&&((0))<8)
90						                .cerror ((CMOSBytes.defaults1.defaultADFSLoadDirMask))<0||((CMOSBytes.defaults1.defaultADFSLoadDirMask))>256,format("Bad mask: $%02x",(CMOSBytes.defaults1.defaultADFSLoadDirMask))

92	.87ac					info:
78	=6					shift=countLS0s(((CMOSBytes.defaults1.defaultADFSLoadDirMask)))
79	=1					unshiftedMask=(((CMOSBytes.defaults1.defaultADFSLoadDirMask)))>>shift
80						                .cerror (unshiftedMask&(unshiftedMask+1))!=0,format("bad mask: $%02x (shift: %d; unshifted: $%02x)",((CMOSBytes.defaults1.defaultADFSLoadDirMask)),shift,unshiftedMask)
81	=1					maskWidth=countLS0s(~unshiftedMask)
82						                .cerror !(maskWidth>=1&&maskWidth<=8),format("bad mask: $%02x",((CMOSBytes.defaults1.defaultADFSLoadDirMask)))

94	>87ac	c0				                .byte ($c0)|((info.maskWidth-1)<<3)|((0))
95	>87ad	36				                .byte (((false))?$80:$00)|(((CMOSBytes.defaults1)-(rtcByteIndexOffset-cmosBytesOffset))<<3)|info.shift
115	=$87ab					lastDirChar=dir.metadata-1
116						                .if version==350
119						                .endif
99	>87ae	46 64 72 69 76 65		                .text ("Fdrive")
100	.87b4					metadata:
86						                ; constants need some rationalisation here...
87						                .cerror ((CMOSBytes.defaults1))<(rtcByteIndexOffset)-cmosBytesOffset
88						                .cerror ((CMOSBytes.defaults1))>=(rtcByteIndexOffset)+16-cmosBytesOffset
89						                .cerror !(((0))>=0&&((0))<8)
90						                .cerror ((CMOSBytes.defaults1.defaultFDRIVEMask))<0||((CMOSBytes.defaults1.defaultFDRIVEMask))>256,format("Bad mask: $%02x",(CMOSBytes.defaults1.defaultFDRIVEMask))

92	.87b4					info:
78	=0					shift=countLS0s(((CMOSBytes.defaults1.defaultFDRIVEMask)))
79	=7					unshiftedMask=(((CMOSBytes.defaults1.defaultFDRIVEMask)))>>shift
80						                .cerror (unshiftedMask&(unshiftedMask+1))!=0,format("bad mask: $%02x (shift: %d; unshifted: $%02x)",((CMOSBytes.defaults1.defaultFDRIVEMask)),shift,unshiftedMask)
81	=3					maskWidth=countLS0s(~unshiftedMask)
82						                .cerror !(maskWidth>=1&&maskWidth<=8),format("bad mask: $%02x",((CMOSBytes.defaults1.defaultFDRIVEMask)))

94	>87b4	d0				                .byte ($c0)|((info.maskWidth-1)<<3)|((0))
95	>87b5	b0				                .byte (((true))?$80:$00)|(((CMOSBytes.defaults1)-(rtcByteIndexOffset-cmosBytesOffset))<<3)|info.shift
121	.87b6					file:
99	>87b6	46 69 6c 65			                .text ("File")
100	.87ba					metadata:
86						                ; constants need some rationalisation here...
87						                .cerror ((CMOSBytes.defaultROMs))<(rtcByteIndexOffset)-cmosBytesOffset
88						                .cerror ((CMOSBytes.defaultROMs))>=(rtcByteIndexOffset)+16-cmosBytesOffset
89						                .cerror !(((0))>=0&&((0))<8)
90						                .cerror (($f<<CMOSBytes.defaultROMs.fsShift))<0||(($f<<CMOSBytes.defaultROMs.fsShift))>256,format("Bad mask: $%02x",($f<<CMOSBytes.defaultROMs.fsShift))

92	.87ba					info:
78	=0					shift=countLS0s((($f<<CMOSBytes.defaultROMs.fsShift)))
79	=$f					unshiftedMask=((($f<<CMOSBytes.defaultROMs.fsShift)))>>shift
80						                .cerror (unshiftedMask&(unshiftedMask+1))!=0,format("bad mask: $%02x (shift: %d; unshifted: $%02x)",(($f<<CMOSBytes.defaultROMs.fsShift)),shift,unshiftedMask)
81	=4					maskWidth=countLS0s(~unshiftedMask)
82						                .cerror !(maskWidth>=1&&maskWidth<=8),format("bad mask: $%02x",(($f<<CMOSBytes.defaultROMs.fsShift)))

94	>87ba	d8				                .byte ($c0)|((info.maskWidth-1)<<3)|((0))
95	>87bb	80				                .byte (((true))?$80:$00)|(((CMOSBytes.defaultROMs)-(rtcByteIndexOffset-cmosBytesOffset))<<3)|info.shift
122						                .if version==350
124						                .endif
125						                .if version==350
127						                .endif
128	.87bc					ignore:
49	>87bc	49 67 6e 6f 72 65		                .text "Ignore"
50	.87c2					metadata:
51						                .cerror (handlePrinterIgnoreChar&$c000)!=$8000
12:4	>87c2	89				                .byte >handlePrinterIgnoreChar-1
13	>87c3	12				                .byte <handlePrinterIgnoreChar-1
129:7						                .if version==350
132						                .endif
133	.87c4					lang:
99	>87c4	4c 61 6e 67			                .text ("Lang")
100	.87c8					metadata:
86						                ; constants need some rationalisation here...
87						                .cerror ((CMOSBytes.defaultROMs))<(rtcByteIndexOffset)-cmosBytesOffset
88						                .cerror ((CMOSBytes.defaultROMs))>=(rtcByteIndexOffset)+16-cmosBytesOffset
89						                .cerror !(((0))>=0&&((0))<8)
90						                .cerror (($f<<CMOSBytes.defaultROMs.languageShift))<0||(($f<<CMOSBytes.defaultROMs.languageShift))>256,format("Bad mask: $%02x",($f<<CMOSBytes.defaultROMs.languageShift))

92	.87c8					info:
78	=4					shift=countLS0s((($f<<CMOSBytes.defaultROMs.languageShift)))
79	=$f					unshiftedMask=((($f<<CMOSBytes.defaultROMs.languageShift)))>>shift
80						                .cerror (unshiftedMask&(unshiftedMask+1))!=0,format("bad mask: $%02x (shift: %d; unshifted: $%02x)",(($f<<CMOSBytes.defaultROMs.languageShift)),shift,unshiftedMask)
81	=4					maskWidth=countLS0s(~unshiftedMask)
82						                .cerror !(maskWidth>=1&&maskWidth<=8),format("bad mask: $%02x",(($f<<CMOSBytes.defaultROMs.languageShift)))

94	>87c8	d8				                .byte ($c0)|((info.maskWidth-1)<<3)|((0))
95	>87c9	84				                .byte (((true))?$80:$00)|(((CMOSBytes.defaultROMs)-(rtcByteIndexOffset-cmosBytesOffset))<<3)|info.shift
99	>87ca	4c 6f 75 64			                .text ("Loud")
100	.87ce					metadata:
86						                ; constants need some rationalisation here...
87						                .cerror ((CMOSBytes.defaults3))<(rtcByteIndexOffset)-cmosBytesOffset
88						                .cerror ((CMOSBytes.defaults3))>=(rtcByteIndexOffset)+16-cmosBytesOffset
89						                .cerror !(((1))>=0&&((1))<8)
90						                .cerror ((CMOSBytes.defaults3.loudMask))<0||((CMOSBytes.defaults3.loudMask))>256,format("Bad mask: $%02x",(CMOSBytes.defaults3.loudMask))

92	.87ce					info:
78	=1					shift=countLS0s(((CMOSBytes.defaults3.loudMask)))
79	=1					unshiftedMask=(((CMOSBytes.defaults3.loudMask)))>>shift
80						                .cerror (unshiftedMask&(unshiftedMask+1))!=0,format("bad mask: $%02x (shift: %d; unshifted: $%02x)",((CMOSBytes.defaults3.loudMask)),shift,unshiftedMask)
81	=1					maskWidth=countLS0s(~unshiftedMask)
82						                .cerror !(maskWidth>=1&&maskWidth<=8),format("bad mask: $%02x",((CMOSBytes.defaults3.loudMask)))

94	>87ce	c1				                .byte ($c0)|((info.maskWidth-1)<<3)|((1))
95	>87cf	59				                .byte (((false))?$80:$00)|(((CMOSBytes.defaults3)-(rtcByteIndexOffset-cmosBytesOffset))<<3)|info.shift
135	.87d0					mode:
99	>87d0	4d 6f 64 65			                .text ("Mode")
100	.87d4					metadata:
86						                ; constants need some rationalisation here...
87						                .cerror ((CMOSBytes.defaults0))<(rtcByteIndexOffset)-cmosBytesOffset
88						                .cerror ((CMOSBytes.defaults0))>=(rtcByteIndexOffset)+16-cmosBytesOffset
89						                .cerror !(((0))>=0&&((0))<8)
90						                .cerror ((CMOSBytes.defaults0.defaultMODEMask|CMOSBytes.defaults0.defaultSHADOWMask))<0||((CMOSBytes.defaults0.defaultMODEMask|CMOSBytes.defaults0.defaultSHADOWMask))>256,format("Bad mask: $%02x",(CMOSBytes.defaults0.defaultMODEMask|CMOSBytes.defaults0.defaultSHADOWMask))

92	.87d4					info:
78	=0					shift=countLS0s(((CMOSBytes.defaults0.defaultMODEMask|CMOSBytes.defaults0.defaultSHADOWMask)))
79	=15					unshiftedMask=(((CMOSBytes.defaults0.defaultMODEMask|CMOSBytes.defaults0.defaultSHADOWMask)))>>shift
80						                .cerror (unshiftedMask&(unshiftedMask+1))!=0,format("bad mask: $%02x (shift: %d; unshifted: $%02x)",((CMOSBytes.defaults0.defaultMODEMask|CMOSBytes.defaults0.defaultSHADOWMask)),shift,unshiftedMask)
81	=4					maskWidth=countLS0s(~unshiftedMask)
82						                .cerror !(maskWidth>=1&&maskWidth<=8),format("bad mask: $%02x",((CMOSBytes.defaults0.defaultMODEMask|CMOSBytes.defaults0.defaultSHADOWMask)))

94	>87d4	d8				                .byte ($c0)|((info.maskWidth-1)<<3)|((0))
95	>87d5	a8				                .byte (((true))?$80:$00)|(((CMOSBytes.defaults0)-(rtcByteIndexOffset-cmosBytesOffset))<<3)|info.shift
99	>87d6	4e 6f 42 6f 6f 74		                .text ("NoBoot")
100	.87dc					metadata:
86						                ; constants need some rationalisation here...
87						                .cerror ((CMOSBytes.defaults3))<(rtcByteIndexOffset)-cmosBytesOffset
88						                .cerror ((CMOSBytes.defaults3))>=(rtcByteIndexOffset)+16-cmosBytesOffset
89						                .cerror !(((0))>=0&&((0))<8)
90						                .cerror ((CMOSBytes.defaults3.autoBootMask))<0||((CMOSBytes.defaults3.autoBootMask))>256,format("Bad mask: $%02x",(CMOSBytes.defaults3.autoBootMask))

92	.87dc					info:
78	=4					shift=countLS0s(((CMOSBytes.defaults3.autoBootMask)))
79	=1					unshiftedMask=(((CMOSBytes.defaults3.autoBootMask)))>>shift
80						                .cerror (unshiftedMask&(unshiftedMask+1))!=0,format("bad mask: $%02x (shift: %d; unshifted: $%02x)",((CMOSBytes.defaults3.autoBootMask)),shift,unshiftedMask)
81	=1					maskWidth=countLS0s(~unshiftedMask)
82						                .cerror !(maskWidth>=1&&maskWidth<=8),format("bad mask: $%02x",((CMOSBytes.defaults3.autoBootMask)))

94	>87dc	c0				                .byte ($c0)|((info.maskWidth-1)<<3)|((0))
95	>87dd	5c				                .byte (((false))?$80:$00)|(((CMOSBytes.defaults3)-(rtcByteIndexOffset-cmosBytesOffset))<<3)|info.shift
99	>87de	4e 6f 43 61 70 73		                .text ("NoCaps")
100	.87e4					metadata:
86						                ; constants need some rationalisation here...
87						                .cerror ((CMOSBytes.defaults1))<(rtcByteIndexOffset)-cmosBytesOffset
88						                .cerror ((CMOSBytes.defaults1))>=(rtcByteIndexOffset)+16-cmosBytesOffset
89						                .cerror !(((2))>=0&&((2))<8)
90						                .cerror ((CMOSBytes.defaults1.defaultShiftLockMask|CMOSBytes.defaults1.defaultNoLockMask|CMOSBytes.defaults1.defaultCapsLockMask))<0||((CMOSBytes.defaults1.defaultShiftLockMask|CMOSBytes.defaults1.defaultNoLockMask|CMOSBytes.defaults1.defaultCapsLockMask))>256,format("Bad mask: $%02x",(CMOSBytes.defaults1.defaultShiftLockMask|CMOSBytes.defaults1.defaultNoLockMask|CMOSBytes.defaults1.defaultCapsLockMask))

92	.87e4					info:
78	=3					shift=countLS0s(((CMOSBytes.defaults1.defaultShiftLockMask|CMOSBytes.defaults1.defaultNoLockMask|CMOSBytes.defaults1.defaultCapsLockMask)))
79	=7					unshiftedMask=(((CMOSBytes.defaults1.defaultShiftLockMask|CMOSBytes.defaults1.defaultNoLockMask|CMOSBytes.defaults1.defaultCapsLockMask)))>>shift
80						                .cerror (unshiftedMask&(unshiftedMask+1))!=0,format("bad mask: $%02x (shift: %d; unshifted: $%02x)",((CMOSBytes.defaults1.defaultShiftLockMask|CMOSBytes.defaults1.defaultNoLockMask|CMOSBytes.defaults1.defaultCapsLockMask)),shift,unshiftedMask)
81	=3					maskWidth=countLS0s(~unshiftedMask)
82						                .cerror !(maskWidth>=1&&maskWidth<=8),format("bad mask: $%02x",((CMOSBytes.defaults1.defaultShiftLockMask|CMOSBytes.defaults1.defaultNoLockMask|CMOSBytes.defaults1.defaultCapsLockMask)))

94	>87e4	d2				                .byte ($c0)|((info.maskWidth-1)<<3)|((2))
95	>87e5	33				                .byte (((false))?$80:$00)|(((CMOSBytes.defaults1)-(rtcByteIndexOffset-cmosBytesOffset))<<3)|info.shift
138	.87e6					noDir:
99	>87e6	4e 6f 44 69 72			                .text ("NoDir")
100	.87eb					metadata:
86						                ; constants need some rationalisation here...
87						                .cerror ((CMOSBytes.defaults1))<(rtcByteIndexOffset)-cmosBytesOffset
88						                .cerror ((CMOSBytes.defaults1))>=(rtcByteIndexOffset)+16-cmosBytesOffset
89						                .cerror !(((1))>=0&&((1))<8)
90						                .cerror ((CMOSBytes.defaults1.defaultADFSLoadDirMask))<0||((CMOSBytes.defaults1.defaultADFSLoadDirMask))>256,format("Bad mask: $%02x",(CMOSBytes.defaults1.defaultADFSLoadDirMask))

92	.87eb					info:
78	=6					shift=countLS0s(((CMOSBytes.defaults1.defaultADFSLoadDirMask)))
79	=1					unshiftedMask=(((CMOSBytes.defaults1.defaultADFSLoadDirMask)))>>shift
80						                .cerror (unshiftedMask&(unshiftedMask+1))!=0,format("bad mask: $%02x (shift: %d; unshifted: $%02x)",((CMOSBytes.defaults1.defaultADFSLoadDirMask)),shift,unshiftedMask)
81	=1					maskWidth=countLS0s(~unshiftedMask)
82						                .cerror !(maskWidth>=1&&maskWidth<=8),format("bad mask: $%02x",((CMOSBytes.defaults1.defaultADFSLoadDirMask)))

94	>87eb	c1				                .byte ($c0)|((info.maskWidth-1)<<3)|((1))
95	>87ec	36				                .byte (((false))?$80:$00)|(((CMOSBytes.defaults1)-(rtcByteIndexOffset-cmosBytesOffset))<<3)|info.shift
139	=$87ea					lastNoDirChar:=noDir.metadata-1
99	>87ed	4e 6f 53 63 72 6f 6c 6c		                .text ("NoScroll")
100	.87f5					metadata:
86						                ; constants need some rationalisation here...
87						                .cerror ((CMOSBytes.defaults3))<(rtcByteIndexOffset)-cmosBytesOffset
88						                .cerror ((CMOSBytes.defaults3))>=(rtcByteIndexOffset)+16-cmosBytesOffset
89						                .cerror !(((1))>=0&&((1))<8)
90						                .cerror ((CMOSBytes.defaults3.protectedScrollingMask))<0||((CMOSBytes.defaults3.protectedScrollingMask))>256,format("Bad mask: $%02x",(CMOSBytes.defaults3.protectedScrollingMask))

92	.87f5					info:
78	=3					shift=countLS0s(((CMOSBytes.defaults3.protectedScrollingMask)))
79	=1					unshiftedMask=(((CMOSBytes.defaults3.protectedScrollingMask)))>>shift
80						                .cerror (unshiftedMask&(unshiftedMask+1))!=0,format("bad mask: $%02x (shift: %d; unshifted: $%02x)",((CMOSBytes.defaults3.protectedScrollingMask)),shift,unshiftedMask)
81	=1					maskWidth=countLS0s(~unshiftedMask)
82						                .cerror !(maskWidth>=1&&maskWidth<=8),format("bad mask: $%02x",((CMOSBytes.defaults3.protectedScrollingMask)))

94	>87f5	c1				                .byte ($c0)|((info.maskWidth-1)<<3)|((1))
95	>87f6	5b				                .byte (((false))?$80:$00)|(((CMOSBytes.defaults3)-(rtcByteIndexOffset-cmosBytesOffset))<<3)|info.shift
141						                .if version==350
143						                .endif
144	.87f7					print:
99	>87f7	50 72 69 6e 74			                .text ("Print")
100	.87fc					metadata:
86						                ; constants need some rationalisation here...
87						                .cerror ((CMOSBytes.defaults2))<(rtcByteIndexOffset)-cmosBytesOffset
88						                .cerror ((CMOSBytes.defaults2))>=(rtcByteIndexOffset)+16-cmosBytesOffset
89						                .cerror !(((0))>=0&&((0))<8)
90						                .cerror ((CMOSBytes.defaults2.fx5SettingMask<<CMOSBytes.defaults2.fx5SettingShift))<0||((CMOSBytes.defaults2.fx5SettingMask<<CMOSBytes.defaults2.fx5SettingShift))>256,format("Bad mask: $%02x",(CMOSBytes.defaults2.fx5SettingMask<<CMOSBytes.defaults2.fx5SettingShift))

92	.87fc					info:
78	=5					shift=countLS0s(((CMOSBytes.defaults2.fx5SettingMask<<CMOSBytes.defaults2.fx5SettingShift)))
79	=7					unshiftedMask=(((CMOSBytes.defaults2.fx5SettingMask<<CMOSBytes.defaults2.fx5SettingShift)))>>shift
80						                .cerror (unshiftedMask&(unshiftedMask+1))!=0,format("bad mask: $%02x (shift: %d; unshifted: $%02x)",((CMOSBytes.defaults2.fx5SettingMask<<CMOSBytes.defaults2.fx5SettingShift)),shift,unshiftedMask)
81	=3					maskWidth=countLS0s(~unshiftedMask)
82						                .cerror !(maskWidth>=1&&maskWidth<=8),format("bad mask: $%02x",((CMOSBytes.defaults2.fx5SettingMask<<CMOSBytes.defaults2.fx5SettingShift)))

94	>87fc	d0				                .byte ($c0)|((info.maskWidth-1)<<3)|((0))
95	>87fd	d5				                .byte (((true))?$80:$00)|(((CMOSBytes.defaults2)-(rtcByteIndexOffset-cmosBytesOffset))<<3)|info.shift
99	>87fe	51 75 69 65 74			                .text ("Quiet")
100	.8803					metadata:
86						                ; constants need some rationalisation here...
87						                .cerror ((CMOSBytes.defaults3))<(rtcByteIndexOffset)-cmosBytesOffset
88						                .cerror ((CMOSBytes.defaults3))>=(rtcByteIndexOffset)+16-cmosBytesOffset
89						                .cerror !(((0))>=0&&((0))<8)
90						                .cerror ((CMOSBytes.defaults3.loudMask))<0||((CMOSBytes.defaults3.loudMask))>256,format("Bad mask: $%02x",(CMOSBytes.defaults3.loudMask))

92	.8803					info:
78	=1					shift=countLS0s(((CMOSBytes.defaults3.loudMask)))
79	=1					unshiftedMask=(((CMOSBytes.defaults3.loudMask)))>>shift
80						                .cerror (unshiftedMask&(unshiftedMask+1))!=0,format("bad mask: $%02x (shift: %d; unshifted: $%02x)",((CMOSBytes.defaults3.loudMask)),shift,unshiftedMask)
81	=1					maskWidth=countLS0s(~unshiftedMask)
82						                .cerror !(maskWidth>=1&&maskWidth<=8),format("bad mask: $%02x",((CMOSBytes.defaults3.loudMask)))

94	>8803	c0				                .byte ($c0)|((info.maskWidth-1)<<3)|((0))
95	>8804	59				                .byte (((false))?$80:$00)|(((CMOSBytes.defaults3)-(rtcByteIndexOffset-cmosBytesOffset))<<3)|info.shift
99	>8805	52 65 70 65 61 74		                .text ("Repeat")
100	.880b					metadata:
86						                ; constants need some rationalisation here...
87						                .cerror ((CMOSBytes.keyboardAutoRepeatRate))<(rtcByteIndexOffset)-cmosBytesOffset
88						                .cerror ((CMOSBytes.keyboardAutoRepeatRate))>=(rtcByteIndexOffset)+16-cmosBytesOffset
89						                .cerror !(((0))>=0&&((0))<8)
90						                .cerror (($ff))<0||(($ff))>256,format("Bad mask: $%02x",($ff))

92	.880b					info:
78	=0					shift=countLS0s((($ff)))
79	=$ff					unshiftedMask=((($ff)))>>shift
80						                .cerror (unshiftedMask&(unshiftedMask+1))!=0,format("bad mask: $%02x (shift: %d; unshifted: $%02x)",(($ff)),shift,unshiftedMask)
81	=8					maskWidth=countLS0s(~unshiftedMask)
82						                .cerror !(maskWidth>=1&&maskWidth<=8),format("bad mask: $%02x",(($ff)))

94	>880b	f8				                .byte ($c0)|((info.maskWidth-1)<<3)|((0))
95	>880c	c0				                .byte (((true))?$80:$00)|(((CMOSBytes.keyboardAutoRepeatRate)-(rtcByteIndexOffset-cmosBytesOffset))<<3)|info.shift
99	>880d	53 63 72 6f 6c 6c		                .text ("Scroll")
100	.8813					metadata:
86						                ; constants need some rationalisation here...
87						                .cerror ((CMOSBytes.defaults3))<(rtcByteIndexOffset)-cmosBytesOffset
88						                .cerror ((CMOSBytes.defaults3))>=(rtcByteIndexOffset)+16-cmosBytesOffset
89						                .cerror !(((0))>=0&&((0))<8)
90						                .cerror ((CMOSBytes.defaults3.protectedScrollingMask))<0||((CMOSBytes.defaults3.protectedScrollingMask))>256,format("Bad mask: $%02x",(CMOSBytes.defaults3.protectedScrollingMask))

92	.8813					info:
78	=3					shift=countLS0s(((CMOSBytes.defaults3.protectedScrollingMask)))
79	=1					unshiftedMask=(((CMOSBytes.defaults3.protectedScrollingMask)))>>shift
80						                .cerror (unshiftedMask&(unshiftedMask+1))!=0,format("bad mask: $%02x (shift: %d; unshifted: $%02x)",((CMOSBytes.defaults3.protectedScrollingMask)),shift,unshiftedMask)
81	=1					maskWidth=countLS0s(~unshiftedMask)
82						                .cerror !(maskWidth>=1&&maskWidth<=8),format("bad mask: $%02x",((CMOSBytes.defaults3.protectedScrollingMask)))

94	>8813	c0				                .byte ($c0)|((info.maskWidth-1)<<3)|((0))
95	>8814	5b				                .byte (((false))?$80:$00)|(((CMOSBytes.defaults3)-(rtcByteIndexOffset-cmosBytesOffset))<<3)|info.shift
148	.8815					shCaps:
99	>8815	53 68 43 61 70 73		                .text ("ShCaps")
100	.881b					metadata:
86						                ; constants need some rationalisation here...
87						                .cerror ((CMOSBytes.defaults1))<(rtcByteIndexOffset)-cmosBytesOffset
88						                .cerror ((CMOSBytes.defaults1))>=(rtcByteIndexOffset)+16-cmosBytesOffset
89						                .cerror !(((1))>=0&&((1))<8)
90						                .cerror ((CMOSBytes.defaults1.defaultShiftLockMask|CMOSBytes.defaults1.defaultNoLockMask|CMOSBytes.defaults1.defaultCapsLockMask))<0||((CMOSBytes.defaults1.defaultShiftLockMask|CMOSBytes.defaults1.defaultNoLockMask|CMOSBytes.defaults1.defaultCapsLockMask))>256,format("Bad mask: $%02x",(CMOSBytes.defaults1.defaultShiftLockMask|CMOSBytes.defaults1.defaultNoLockMask|CMOSBytes.defaults1.defaultCapsLockMask))

92	.881b					info:
78	=3					shift=countLS0s(((CMOSBytes.defaults1.defaultShiftLockMask|CMOSBytes.defaults1.defaultNoLockMask|CMOSBytes.defaults1.defaultCapsLockMask)))
79	=7					unshiftedMask=(((CMOSBytes.defaults1.defaultShiftLockMask|CMOSBytes.defaults1.defaultNoLockMask|CMOSBytes.defaults1.defaultCapsLockMask)))>>shift
80						                .cerror (unshiftedMask&(unshiftedMask+1))!=0,format("bad mask: $%02x (shift: %d; unshifted: $%02x)",((CMOSBytes.defaults1.defaultShiftLockMask|CMOSBytes.defaults1.defaultNoLockMask|CMOSBytes.defaults1.defaultCapsLockMask)),shift,unshiftedMask)
81	=3					maskWidth=countLS0s(~unshiftedMask)
82						                .cerror !(maskWidth>=1&&maskWidth<=8),format("bad mask: $%02x",((CMOSBytes.defaults1.defaultShiftLockMask|CMOSBytes.defaults1.defaultNoLockMask|CMOSBytes.defaults1.defaultCapsLockMask)))

94	>881b	d1				                .byte ($c0)|((info.maskWidth-1)<<3)|((1))
95	>881c	33				                .byte (((false))?$80:$00)|(((CMOSBytes.defaults1)-(rtcByteIndexOffset-cmosBytesOffset))<<3)|info.shift
149	=$8816					lastShChar=shCaps+1
150						                .if version==350
152						                .endif
153						                .if version>=500
99	>881d	50 72 6f 70 6f 72 74 69		                .text ("Proportional")
	>8825	6f 6e 61 6c
100	.8829					metadata:
86						                ; constants need some rationalisation here...
87						                .cerror ((CMOSBytes.joystick))<(rtcByteIndexOffset)-cmosBytesOffset
88						                .cerror ((CMOSBytes.joystick))>=(rtcByteIndexOffset)+16-cmosBytesOffset
89						                .cerror !(((0))>=0&&((0))<8)
90						                .cerror ((CMOSBytes.joystick.isSwitchedMask))<0||((CMOSBytes.joystick.isSwitchedMask))>256,format("Bad mask: $%02x",(CMOSBytes.joystick.isSwitchedMask))

92	.8829					info:
78	=5					shift=countLS0s(((CMOSBytes.joystick.isSwitchedMask)))
79	=1					unshiftedMask=(((CMOSBytes.joystick.isSwitchedMask)))>>shift
80						                .cerror (unshiftedMask&(unshiftedMask+1))!=0,format("bad mask: $%02x (shift: %d; unshifted: $%02x)",((CMOSBytes.joystick.isSwitchedMask)),shift,unshiftedMask)
81	=1					maskWidth=countLS0s(~unshiftedMask)
82						                .cerror !(maskWidth>=1&&maskWidth<=8),format("bad mask: $%02x",((CMOSBytes.joystick.isSwitchedMask)))

94	>8829	c0				                .byte ($c0)|((info.maskWidth-1)<<3)|((0))
95	>882a	6d				                .byte (((false))?$80:$00)|(((CMOSBytes.joystick)-(rtcByteIndexOffset-cmosBytesOffset))<<3)|info.shift
155						                .endif
156						                .if version>=500
99	>882b	53 77 69 74 63 68 65 64		                .text ("Switched")
100	.8833					metadata:
86						                ; constants need some rationalisation here...
87						                .cerror ((CMOSBytes.joystick))<(rtcByteIndexOffset)-cmosBytesOffset
88						                .cerror ((CMOSBytes.joystick))>=(rtcByteIndexOffset)+16-cmosBytesOffset
89						                .cerror !(((1))>=0&&((1))<8)
90						                .cerror ((CMOSBytes.joystick.isSwitchedMask))<0||((CMOSBytes.joystick.isSwitchedMask))>256,format("Bad mask: $%02x",(CMOSBytes.joystick.isSwitchedMask))

92	.8833					info:
78	=5					shift=countLS0s(((CMOSBytes.joystick.isSwitchedMask)))
79	=1					unshiftedMask=(((CMOSBytes.joystick.isSwitchedMask)))>>shift
80						                .cerror (unshiftedMask&(unshiftedMask+1))!=0,format("bad mask: $%02x (shift: %d; unshifted: $%02x)",((CMOSBytes.joystick.isSwitchedMask)),shift,unshiftedMask)
81	=1					maskWidth=countLS0s(~unshiftedMask)
82						                .cerror !(maskWidth>=1&&maskWidth<=8),format("bad mask: $%02x",((CMOSBytes.joystick.isSwitchedMask)))

94	>8833	c1				                .byte ($c0)|((info.maskWidth-1)<<3)|((1))
95	>8834	6d				                .byte (((false))?$80:$00)|(((CMOSBytes.joystick)-(rtcByteIndexOffset-cmosBytesOffset))<<3)|info.shift
158						                .endif
159						                .if version>=500
99	>8835	53 74 69 63 6b			                .text ("Stick")
100	.883a					metadata:
86						                ; constants need some rationalisation here...
87						                .cerror ((CMOSBytes.joystick))<(rtcByteIndexOffset)-cmosBytesOffset
88						                .cerror ((CMOSBytes.joystick))>=(rtcByteIndexOffset)+16-cmosBytesOffset
89						                .cerror !(((0))>=0&&((0))<8)
90						                .cerror ((CMOSBytes.joystick.stickMask))<0||((CMOSBytes.joystick.stickMask))>256,format("Bad mask: $%02x",(CMOSBytes.joystick.stickMask))

92	.883a					info:
78	=0					shift=countLS0s(((CMOSBytes.joystick.stickMask)))
79	=$f					unshiftedMask=(((CMOSBytes.joystick.stickMask)))>>shift
80						                .cerror (unshiftedMask&(unshiftedMask+1))!=0,format("bad mask: $%02x (shift: %d; unshifted: $%02x)",((CMOSBytes.joystick.stickMask)),shift,unshiftedMask)
81	=4					maskWidth=countLS0s(~unshiftedMask)
82						                .cerror !(maskWidth>=1&&maskWidth<=8),format("bad mask: $%02x",((CMOSBytes.joystick.stickMask)))

94	>883a	d8				                .byte ($c0)|((info.maskWidth-1)<<3)|((0))
95	>883b	e8				                .byte (((true))?$80:$00)|(((CMOSBytes.joystick)-(rtcByteIndexOffset-cmosBytesOffset))<<3)|info.shift
161						                .endif
49	>883c	54 56				                .text "TV"
50	.883e					metadata:
51						                .cerror (handleTV&$c000)!=$8000
12:4	>883e	89				                .byte >handleTV-1
13	>883f	64				                .byte <handleTV-1
163:7	>8840	00				                .byte 0
164	.8841					L8603:
165						                .if version==350
167						                .else
168						                ; This must be a bug, surely? The mask looks wrong.
86						                ; constants need some rationalisation here...
87						                .cerror (CMOSBytes.defaults2)<(rtcByteIndexOffset)-cmosBytesOffset
88						                .cerror (CMOSBytes.defaults2)>=(rtcByteIndexOffset)+16-cmosBytesOffset
89						                .cerror !((0)>=0&&(0)<8)
90						                .cerror (3<<1)<0||(3<<1)>256,format("Bad mask: $%02x",3<<1)

92	.8841					info:
78	=1					shift=countLS0s((3<<1))
79	=3					unshiftedMask=((3<<1))>>shift
80						                .cerror (unshiftedMask&(unshiftedMask+1))!=0,format("bad mask: $%02x (shift: %d; unshifted: $%02x)",(3<<1),shift,unshiftedMask)
81	=2					maskWidth=countLS0s(~unshiftedMask)
82						                .cerror !(maskWidth>=1&&maskWidth<=8),format("bad mask: $%02x",(3<<1))

94	>8841	08				                .byte ($00)|((info.maskWidth-1)<<3)|(0)
95	>8842	51				                .byte ((false)?$80:$00)|((CMOSBytes.defaults2-(rtcByteIndexOffset-cmosBytesOffset))<<3)|info.shift
170						                .endif
171	.8843					L8605:
86						                ; constants need some rationalisation here...
87						                .cerror (CMOSBytes.defaults0)<(rtcByteIndexOffset)-cmosBytesOffset
88						                .cerror (CMOSBytes.defaults0)>=(rtcByteIndexOffset)+16-cmosBytesOffset
89						                .cerror !((0)>=0&&(0)<8)
90						                .cerror (CMOSBytes.defaults0.defaultInterlaceMask|(CMOSBytes.defaults0.defaultTVMask<<CMOSBytes.defaults0.defaultTVShift))<0||(CMOSBytes.defaults0.defaultInterlaceMask|(CMOSBytes.defaults0.defaultTVMask<<CMOSBytes.defaults0.defaultTVShift))>256,format("Bad mask: $%02x",CMOSBytes.defaults0.defaultInterlaceMask|(CMOSBytes.defaults0.defaultTVMask<<CMOSBytes.defaults0.defaultTVShift))

92	.8843					info:
78	=4					shift=countLS0s((CMOSBytes.defaults0.defaultInterlaceMask|(CMOSBytes.defaults0.defaultTVMask<<CMOSBytes.defaults0.defaultTVShift)))
79	=15					unshiftedMask=((CMOSBytes.defaults0.defaultInterlaceMask|(CMOSBytes.defaults0.defaultTVMask<<CMOSBytes.defaults0.defaultTVShift)))>>shift
80						                .cerror (unshiftedMask&(unshiftedMask+1))!=0,format("bad mask: $%02x (shift: %d; unshifted: $%02x)",(CMOSBytes.defaults0.defaultInterlaceMask|(CMOSBytes.defaults0.defaultTVMask<<CMOSBytes.defaults0.defaultTVShift)),shift,unshiftedMask)
81	=4					maskWidth=countLS0s(~unshiftedMask)
82						                .cerror !(maskWidth>=1&&maskWidth<=8),format("bad mask: $%02x",(CMOSBytes.defaults0.defaultInterlaceMask|(CMOSBytes.defaults0.defaultTVMask<<CMOSBytes.defaults0.defaultTVShift)))

94	>8843	18				                .byte ($00)|((info.maskWidth-1)<<3)|(0)
95	>8844	2c				                .byte ((false)?$80:$00)|((CMOSBytes.defaults0-(rtcByteIndexOffset-cmosBytesOffset))<<3)|info.shift
173	.8845					ectory:
174	>8845	65 63 74 6f 72 79 ff		                .text "ectory",$ff
175						                .if version==350
178						                .endif
179	.884c					ift:
180	>884c	69 66 74 ff			                .text "ift",$ff

182	.8850					textSnippetInsertPointOffsets:
183	>8850	24				                .text lastDirChar-configureTable   ;"Directory"
184	>8851	63				                .byte lastNoDirChar-configureTable ;"NoDirectory"
185						                .if version==350
188						                .endif
189	>8852	8f				                .byte lastShChar-configureTable    ;"Shift"
190	=3					textSnippetsCount=*-textSnippetInsertPointOffsets

192	.8853					textSnippetOffsets:
193	>8853	be				                .byte configureTable.ectory-configureTable
194	>8854	be				                .byte configureTable.ectory-configureTable
195						                .if version==350
198						                .endif
199	>8855	c5				                .byte configureTable.ift-configureTable
200						                .cerror *-textSnippetOffsets!=textSnippetsCount

202						                .endblock

204						;-------------------------------------------------------------------------

206	.8856					starCONFIGUREOrStarSTATUS:
207	.8856	0a		asl a		                asl a
208	.8857	69 80		adc #$80	                adc #$80

210						                ; *STATUS: A=1 V=1 C=1
211						                ; *CONFIGURE: A=0 V=0 C=1
212	.8859	08		php		                php
213	.885a	a9 87		lda #$87	                lda #<configureTable
214	.885c	85 b0		sta $b0		                sta oscliWorkspace.tablePtr+0
215	.885e	a9 87		lda #$87	                lda #>configureTable
216	.8860	85 b1		sta $b1		                sta oscliWorkspace.tablePtr+1
217	.8862	a2 ff		ldx #$ff	                ldx #$FF
218	.8864	20 ad f3	jsr $f3ad	                jsr mos.skipSpacesAndCheckForCRInStringInput
219	.8867	d0 03		bne $886c	                bne L886C
220	.8869	20 ce 8a	jsr $8ace	                jsr fetchCommandTableByte

222	.886c					L886C:
223	.886c	2c 70 e3	bit $e370	                bit mos.valueFF ; V=1 to indicate 2-byte metadata
224	.886f	20 8f 8a	jsr $8a8f	                jsr findCommand
225	.8872	b0 07		bcs $887b	                bcs foundCONFIGOrSTATUSTopic
226	.8874	28		plp		                plp
227	.8875	20 71 8b	jsr $8b71	                jsr unknownCONFIGOrStatus
228	.8878	d0 71		bne $88eb	                bne jmpBadCommandError
229	.887a	60		rts		                rts

231						;-------------------------------------------------------------------------

233	.887b					foundCONFIGOrSTATUSTopic:
234	.887b	20 ad f3	jsr $f3ad	                jsr mos.skipSpacesAndCheckForCRInStringInput
235	.887e	28		plp		                plp
236	.887f	50 03		bvc $8884	                bvc L8884
237	.8881	20 5d 89	jsr $895d	                jsr L895D

239						;-------------------------------------------------------------------------

241	.8884					L8884:
242	.8884	bd 87 87	lda $8787,x	                lda configureTable,x
243	.8887	89 40		bit #$40	                bit #$40
244	.8889	d0 0a		bne $8895	                bne L8895       ;taken if V0 clear
245	.888b	48		pha		                pha
246	.888c	bd 88 87	lda $8788,x	                lda configureTable+1,x
247	.888f	48		pha		                pha
248	.8890	b1 f2		lda ($f2),y	                lda (stringInputBufferAddress),y
249	.8892	49 0d		eor #$0d	                eor #$D         ;A=0 Z=1 if command line tail is empty
250	.8894	60		rts		                rts             ;call routine, in effect

252						;-------------------------------------------------------------------------

254	.8895					L8895:
255	.8895	29 07		and #$07	                and #7
256						                .if version==350
258						                .else
259	.8897	fe 88 87	inc $8788,x	                inc configureTable+1,x
260						                .endif
261	.889a	70 3d		bvs $88d9	                bvs L88D9
262	.889c	b0 30		bcs $88ce	                bcs print1NumberHelp
263	.889e	30 05		bmi $88a5	                bmi L88A5
264	.88a0	20 5d 89	jsr $895d	                jsr L895D
265	.88a3	80 26		bra $88cb	                bra jmpL88EE

267						;-------------------------------------------------------------------------

269	.88a5					L88A5:
270	.88a5	da		phx		                phx
271	.88a6	20 b5 89	jsr $89b5	                jsr L89B5
272	.88a9	fa		plx		                plx
273	.88aa	e0 07		cpx #$07	                cpx #7
274	.88ac	d0 06		bne $88b4	                bne L88B4
275	.88ae	a8		tay		                tay
276	.88af	d0 02		bne $88b3	                bne L88B3
277	.88b1	a9 07		lda #$07	                lda #7

279	.88b3					L88B3:
280	.88b3	3a		dec a		                dec a

282	.88b4					L88B4:
283	.88b4	e0 4d		cpx #$4d	                cpx #configureTable.mode.metadata-configureTable
284	.88b6	d0 09		bne $88c1	                bne L88C1
285	.88b8	89 78		bit #$78	                bit #$78
286	.88ba	d0 2f		bne $88eb	                bne jmpBadCommandError
287	.88bc	a8		tay		                tay
288	.88bd	10 02		bpl $88c1	                bpl L88C1
289	.88bf	49 88		eor #$88	                eor #$88

291	.88c1					L88C1:
292	.88c1	20 8d 8b	jsr $8b8d	                jsr getMaskCount
293	.88c4	d9 99 8b	cmp $8b99,y	                cmp maskByBitCount,y
294	.88c7	f0 02		beq $88cb	                beq jmpL88EE
295	.88c9	b0 20		bcs $88eb	                bcs jmpBadCommandError


298	.88cb					jmpL88EE:
299	.88cb	4c ee 88	jmp $88ee	                jmp L88EE

301						;-------------------------------------------------------------------------

303	.88ce					print1NumberHelp:
304	.88ce	10 08		bpl $88d8	                bpl L88D8
305	.88d0	20 27 ad	jsr $ad27	                jsr alwaysPrintFollowingMessage
306	>88d3	3c 44 3e 0d 00			                .text "<D>",13,0
307	.88d8					L88D8:
308	.88d8	60		rts		                rts

310						;-------------------------------------------------------------------------

312	.88d9					L88D9:
313	.88d9	30 07		bmi $88e2	                bmi printDecimalConfigurationByte
314	.88db	bd 88 87	lda $8788,x	                lda configureTable+1,x
315	.88de	18		clc		                clc
316	.88df	4c da 8a	jmp $8ada	                jmp L8ADA

318						;-------------------------------------------------------------------------

320	.88e2					printDecimalConfigurationByte:
321	.88e2	20 64 8a	jsr $8a64	                jsr readConfigurationByte

323	.88e5					printDecimalByteAThenNewLine:
324	.88e5	20 aa 8b	jsr $8baa	                jsr printDecimalByteA
325	.88e8	4c e7 ff	jmp $ffe7	                jmp OSNEWL

327						;-------------------------------------------------------------------------

329	.88eb					jmpBadCommandError:
330	.88eb	4c 3d fb	jmp $fb3d	                jmp mos.badCommandError

332						;-------------------------------------------------------------------------

334	.88ee					L88EE: .block
335	.88ee	85 b0		sta $b0		                sta $B0         ;save value
336	.88f0	20 8d 8b	jsr $8b8d	                jsr getMaskCount
337	.88f3	b9 99 8b	lda $8b99,y	                lda maskByBitCount,y
338	.88f6	20 84 8b	jsr $8b84	                jsr getShiftCount
339	.88f9	80 03		bra $88fe	                bra shift
340	.88fb					shiftLoop:
341	.88fb	0a		asl a		                asl a           ;shift mask
342	.88fc	06 b0		asl $b0		                asl $B0         ;shift value

344	.88fe					shift:
345	.88fe	88		dey		                dey
346	.88ff	10 fa		bpl $88fb	                bpl shiftLoop
347	.8901	85 b1		sta $b1		                sta $B1         ;store shifted value
348	.8903	20 78 8b	jsr $8b78	                jsr getRTCByteIndex
349	.8906	20 ca 9d	jsr $9dca	                jsr readRTCByte ;get previous value
350	.8909	05 b1		ora $b1		                ora $B1         ;set all masked bits to 1
351	.890b	45 b1		eor $b1		                eor $B1         ;set all masked bits to 0
352	.890d	05 b0		ora $b0		                ora $B0         ;insert value
353	.890f	a8		tay		                tay             ;Y=byte to write
354						                .endblock

356	.8910					jmpWriteRTCByte:
357	.8910	4c 02 9e	jmp $9e02	                jmp writeRTCByte

359						;-------------------------------------------------------------------------

361	.8913					handlePrinterIgnoreChar:
362	.8913	70 18		bvs $892d	                bvs printDefaultPrinterIgnoreChar ;taken if *STATUS
363	.8915	b0 31		bcs $8948	                bcs print1OptionalNumberHelp
364	.8917	f0 0e		beq $8927	                beq L8927
365	.8919	20 b5 89	jsr $89b5	                jsr L89B5
366	.891c	da		phx		                phx
367	.891d	a9 00		lda #$00	                lda #0
368	.891f	20 29 89	jsr $8929	                jsr L8929
369	.8922	7a		ply		                ply
370	.8923	a2 0e		ldx #$0e	                ldx #$E+cmosBytesOffset
371	.8925	80 e9		bra $8910	                bra jmpWriteRTCByte

373						;-------------------------------------------------------------------------

375	.8927					L8927:
376	.8927	a9 01		lda #$01	                lda #1

378						;-------------------------------------------------------------------------

380	.8929					L8929:
381	.8929	a2 ba		ldx #$ba	                ldx #configureTable.L8603-configureTable
382	.892b					L892B:
383	.892b	80 9e		bra $88cb	                bra jmpL88EE

385						;-------------------------------------------------------------------------

387	.892d					printDefaultPrinterIgnoreChar:
388	.892d	20 a1 8b	jsr $8ba1	                jsr readUsePrinterIgnoreChar
389	.8930	90 0f		bcc $8941	                bcc gotPrinterIgnoreChar
390	.8932	20 27 ad	jsr $ad27	                jsr alwaysPrintFollowingMessage
391	>8935	4e 6f 20 49 67 6e 6f 72		                .text "No Ignore",13,0
	>893d	65 0d 00
392	.8940	60		rts		                rts

394						;-------------------------------------------------------------------------

396	.8941					gotPrinterIgnoreChar:
397	.8941	a2 0e		ldx #$0e	                ldx #CMOSBytes.printerIgnoreChar+cmosBytesOffset
398	.8943	20 ca 9d	jsr $9dca	                jsr readRTCByte
399	.8946					L8946:
400	.8946	80 9d		bra $88e5	                bra printDecimalByteAThenNewLine

402						;-------------------------------------------------------------------------

404	.8948					print1OptionalNumberHelp:
405	.8948	20 27 ad	jsr $ad27	                jsr alwaysPrintFollowingMessage
406	>894b	5b 3c 44 3e 5d 0d 00		                .text "[<D>]",13,0
407	.8952	60		rts		                rts

409						;-------------------------------------------------------------------------

411	.8953					L8953:

413	.8953	20 f9 85	jsr $85f9	                jsr parseNumberFromString

415	.8956					L8956:
416	.8956	90 93		bcc $88eb	                bcc jmpBadCommandError
417	.8958	8a		txa		                txa
418	.8959	c9 10		cmp #$10	                cmp #$10

420	.895b					L895B:
421	.895b	b0 8e		bcs $88eb	                bcs jmpBadCommandError

423	.895d					L895D:
424	.895d	48		pha		                pha
425	.895e	20 ad f3	jsr $f3ad	                jsr mos.skipSpacesAndCheckForCRInStringInput

427	.8961					L8961:
428	.8961	d0 88		bne $88eb	                bne jmpBadCommandError
429	.8963	68		pla		                pla
430	.8964	60		rts		                rts

432						;-------------------------------------------------------------------------

434	.8965					handleTV:
435	.8965	70 2f		bvs $8996	                bvs L8996
436	.8967	b0 3b		bcs $89a4	                bcs printTVHelp
437	.8969	f0 27		beq $8992	                beq L8992
438	.896b	20 f9 85	jsr $85f9	                jsr parseNumberFromString
439	.896e	90 e6		bcc $8956	                bcc L8956
440	.8970	e0 fc		cpx #$fc	                cpx #$FC
441	.8972	b0 04		bcs $8978	                bcs L8978
442	.8974	e0 04		cpx #$04	                cpx #4
443	.8976	b0 e3		bcs $895b	                bcs L895B

445	.8978					L8978:
446	.8978	8a		txa		                txa
447	.8979	0a		asl a		                asl a
448	.897a	85 b1		sta $b1		                sta $B1
449	.897c	a2 00		ldx #$00	                ldx #0
450	.897e	20 b8 f3	jsr $f3b8	                jsr mos.LF30A
451	.8981	f0 08		beq $898b	                beq L898B
452	.8983	20 b5 89	jsr $89b5	                jsr L89B5
453	.8986	c9 02		cmp #$02	                cmp #2
454	.8988	b0 d1		bcs $895b	                bcs L895B
455	.898a	aa		tax		                tax

457	.898b					L898B:
458	.898b	8a		txa		                txa
459	.898c	05 b1		ora $b1		                ora $B1

461	.898e					L898E:
462	.898e	a2 bc		ldx #$bc	                ldx #configureTable.L8605-configureTable
463	.8990	80 99		bra $892b	                bra L892B

465						;-------------------------------------------------------------------------

467	.8992					L8992:
468	.8992	a9 00		lda #$00	                lda #0
469	.8994	80 f8		bra $898e	                bra L898E

471						;-------------------------------------------------------------------------

473	.8996					L8996:
474	.8996	20 d6 8b	jsr $8bd6	                jsr readDefaultTVSettings
475	.8999	20 a9 8b	jsr $8ba9	                jsr printDecimalByteY
476	.899c	a9 2c		lda #$2c	                lda #','
477	.899e	20 ee ff	jsr $ffee	                jsr OSWRCH
478	.89a1	8a		txa		                txa
479	.89a2	80 a2		bra $8946	                bra L8946

481						;-------------------------------------------------------------------------

483	.89a4					printTVHelp:
484	.89a4	20 27 ad	jsr $ad27	                jsr alwaysPrintFollowingMessage
485	>89a7	5b 3c 44 3e 5b 2c 3c 44		                .text "[<D>[,<D>]]",13,0
	>89af	3e 5d 5d 0d 00
486	.89b4	60		rts		                rts

488						;-------------------------------------------------------------------------

490	.89b5					L89B5:
491	.89b5	20 f9 85	jsr $85f9	                jsr parseNumberFromString
492	.89b8	90 9c		bcc $8956	                bcc L8956
493	.89ba	8a		txa		                txa
494	.89bb	80 a0		bra $895d	                bra L895D


497						;-------------------------------------------------------------------------

499	.89bd					printConfigureOrStatusHeader: .block
500	.89bd	d0 a2		bne $8961	                bne L8961
501	.89bf	08		php		                php
502	.89c0	5a		phy		                phy
503	.89c1	20 27 ad	jsr $ad27	                jsr alwaysPrintFollowingMessage
504	>89c4	43 6f 6e 66 69 67 75 72		                .text "Configuration ",0
	>89cc	61 74 69 6f 6e 20 00
505	.89d3	70 0f		bvs $89e4	                bvs printStatusHeader ;taken if *STATUS
506	.89d5	20 27 ad	jsr $ad27	                jsr alwaysPrintFollowingMessage
507	>89d8	6f 70 74 69 6f 6e 73 3a		                .text "options:",13,0
	>89e0	0d 00
508	.89e2	80 0c		bra $89f0	                bra printItems
509	.89e4					printStatusHeader:
510	.89e4	20 27 ad	jsr $ad27	                jsr alwaysPrintFollowingMessage
511	>89e7	73 74 61 74 75 73 3a 0d		                .text "status:",13,0
	>89ef	00
512	.89f0					printItems:
513	.89f0	38		sec		                sec
514	.89f1	20 da 8a	jsr $8ada	                jsr L8ADA
515	.89f4	7a		ply		                ply
516	.89f5	28		plp		                plp
517	.89f6	08		php		                php
518	.89f7	20 71 8b	jsr $8b71	                jsr unknownCONFIGOrStatus
519	.89fa	28		plp		                plp
520	.89fb	70 66		bvs $8a63	                bvs done        ;taken if *STATUS
521	.89fd	20 27 ad	jsr $ad27	                jsr alwaysPrintFollowingMessage
522	>8a00	57 68 65 72 65 3a 0d		                .text "Where:",13
523	>8a07	44 20 69 73 20 61 20 64		                .text "D is a decimal number, or",13
	>8a0f	65 63 69 6d 61 6c 20 6e 75 6d 62 65 72 2c 20 6f
	>8a1f	72 0d
524	>8a21	61 20 68 65 78 61 64 65		                .text "a hexadecimal number preceded by &",13
	>8a29	63 69 6d 61 6c 20 6e 75 6d 62 65 72 20 70 72 65
	>8a39	63 65 64 65 64 20 62 79 20 26 0d
525	>8a44	49 74 65 6d 73 20 77 69		                .text "Items within [ ] are optional",13
	>8a4c	74 68 69 6e 20 5b 20 5d 20 61 72 65 20 6f 70 74
	>8a5c	69 6f 6e 61 6c 0d
526	>8a62	00				                .byte 0
527	.8a63					done:
528	.8a63	60		rts		                rts
529						                .endblock

531						;-------------------------------------------------------------------------
532						;
533						; Read configuration byte, given offset of metadata in the configure
534						; table.
535						;
536						; Entry:
537						;
538						; X = offset of metadata in the configure table
539						;
540						; Exit:
541						;
542						; A = value read
543						;
544						; Preserves: X/Y/P

546						                .if version==350
549						                .endif
550	.8a64					readConfigurationByte: .block
551	.8a64	08		php		                php
552	.8a65	5a		phy		                phy
553	.8a66	da		phx		                phx
554	.8a67	20 78 8b	jsr $8b78	                jsr getRTCByteIndex ;
555	.8a6a	20 ca 9d	jsr $9dca	                jsr readRTCByte
556	.8a6d	fa		plx		                plx
557	.8a6e	20 84 8b	jsr $8b84	                jsr getShiftCount
558	.8a71	80 01		bra $8a74	                bra shift

560						;-------------------------------------------------------------------------

562	.8a73					shiftLoop:
563	.8a73	4a		lsr a		                lsr a

565	.8a74					shift:
566	.8a74	88		dey		                dey
567	.8a75	10 fc		bpl $8a73	                bpl shiftLoop

569	.8a77	20 8d 8b	jsr $8b8d	                jsr getMaskCount
570	.8a7a	39 99 8b	and $8b99,y	                and maskByBitCount,y
571	.8a7d	e0 07		cpx #$07	                cpx #configureTable.baud.metadata-configureTable
572	.8a7f	d0 01		bne $8a82	                bne gotMaskedByte
573	.8a81	1a		inc a		                inc a

575	.8a82					gotMaskedByte:
576						                ; If retrieving the MODE value, rearrange things so
577						                ; the shadow modes are 128-135.
578	.8a82	e0 4d		cpx #$4d	                cpx #configureTable.mode.metadata-configureTable
579	.8a84	d0 06		bne $8a8c	                bne done        ;taken if not MODE
580	.8a86	89 08		bit #$08	                bit #CMOSBytes.defaults0.defaultSHADOWMask ;test shadow bit
581	.8a88	f0 02		beq $8a8c	                beq done                                   ;taken if not shadow mode
582	.8a8a	49 88		eor #$88	                eor #$80|CMOSBytes.defaults0.defaultSHADOWMask ;turn mode|flag into mode|$80

584	.8a8c					done:
585	.8a8c	7a		ply		                ply
586	.8a8d	28		plp		                plp
587	.8a8e	60		rts		                rts
588						                .endblock

590						;-------------------------------------------------------------------------
591						;
592						; Find command in command table.
593						;
594						; Entry:
595						;
596						; (stringInputBufferAddress),y = input
597						; oscliWorkspace.tablePtr; = address of command table
598						; V = 0 if commands have 4 bytes of metadata
599						;     1 if commands have 2 bytes of metadata
600						;
601						; Exit:
602						;
603						; C=0 = no match
604						;
605						; C=1 = match;
606						;       A holds 1st byte of metadata
607						;       oscliWorkspace.tablePtr; = address of 2nd and following metadata bytes
608						;       (stringInputBufferAddress),y = input following command
609						;
610						; Preserves: X/V

612	.8a8f					findCommand: .block
613	.8a8f	84 e6		sty $e6		                sty $E6         ;save Y
614	.8a91	80 0a		bra $8a9d	                bra checkInput       ;get going...

616	.8a93					checkLetter:
617	.8a93	52 b0		eor ($b0)	                eor (oscliWorkspace.tablePtr)
618	.8a95	29 df		and #$df	                and #$DF
619	.8a97	d0 15		bne $8aae	                bne noMatch    ; taken if char didn't match
620	.8a99	20 ce 8a	jsr $8ace	                jsr fetchCommandTableByte
621	.8a9c	c8		iny		                iny

623	.8a9d					checkInput:
624	.8a9d	b1 f2		lda ($f2),y	                lda (stringInputBufferAddress),y
625	.8a9f	20 9c eb	jsr $eb9c	                jsr mos.isLetter
626	.8aa2	90 ef		bcc $8a93	                bcc checkLetter ; taken if letter

628						                ; Non-letter input means potentially end of command
629						                ; name.
630	.8aa4	b2 b0		lda ($b0)	                lda (oscliWorkspace.tablePtr) ; next table byte
631	.8aa6	30 21		bmi $8ac9	                bmi commandMatch ; taken if end of string - a match
632	.8aa8	b1 f2		lda ($f2),y	                lda (stringInputBufferAddress),y
633	.8aaa	c9 2e		cmp #$2e	                cmp #'.'        ; '.' is the abbreviation char
634	.8aac	f0 04		beq $8ab2	                beq abbreviationMatch ;taken with C=1 if match

636	.8aae					noMatch:
637	.8aae	18		clc		                clc             ;indicate no match
638	.8aaf	a4 e6		ldy $e6		                ldy $E6         ;restore Y
639	.8ab1	88		dey		                dey             ;compensate for upcoming iny

641	.8ab2					abbreviationMatch:
642	.8ab2	c8		iny		                iny             ; skip the '.'

644	.8ab3					findCommandMetadataLoop:
645	.8ab3	20 ce 8a	jsr $8ace	                jsr fetchCommandTableByte
646	.8ab6	f0 15		beq $8acd	                beq rts8ACD
647	.8ab8	10 f9		bpl $8ab3	                bpl findCommandMetadataLoop ; keep looping through chars if necessary
648	.8aba	b0 11		bcs $8acd	                bcs rts8ACD                 ;taken if it was a match
649	.8abc	20 ce 8a	jsr $8ace	                jsr fetchCommandTableByte   ;discard 2nd metadata byte
650	.8abf	70 dc		bvs $8a9d	                bvs checkInput ; if V=1, 2-byte metadata; if V=0, 4-byte metadata
651	.8ac1	20 ce 8a	jsr $8ace	                jsr fetchCommandTableByte ;discard 3rd metadata byte
652	.8ac4	20 ce 8a	jsr $8ace	                jsr fetchCommandTableByte ;discard 4th metadata byte
653	.8ac7	80 d4		bra $8a9d	                bra checkInput

655						;-------------------------------------------------------------------------

657	.8ac9					commandMatch:
658	.8ac9	20 ce 8a	jsr $8ace	                jsr fetchCommandTableByte
659	.8acc	38		sec		                sec

661	.8acd					rts8ACD:
662	.8acd	60		rts		                rts
663						                .endblock

665						;-------------------------------------------------------------------------
666						;
667						; Fetch byte from command table with postincrement.
668						;
669						; Entry:
670						;
671						; oscliWorkspace.tablePtr; = address of byte to fetch
672						;
673						; Exit:
674						;
675						; A = byte fetched
676						; oscliWorkspace.tablePtr; incremented
677						;
678						; Preserves: X/Y/C/V

680	.8ace					fetchCommandTableByte:
681	.8ace	e8		inx		                inx
682	.8acf	b2 b0		lda ($b0)	                lda (oscliWorkspace.tablePtr)
683	.8ad1	48		pha		                pha
684	.8ad2	e6 b0		inc $b0		                inc oscliWorkspace.tablePtr+0
685	.8ad4	d0 02		bne $8ad8	                bne L8AD8
686	.8ad6	e6 b1		inc $b1		                inc oscliWorkspace.tablePtr+1

688	.8ad8					L8AD8:
689	.8ad8	68		pla		                pla
690	.8ad9	60		rts		                rts

692						;-------------------------------------------------------------------------
693						;
694						; Print configure table items.
695						;
696						; Entry:
697						;
698						; C = ???
699						;
700						; V=0 if *CONFIGURE; V=1 if *STATUS
701						;
702	.8ada					L8ADA: .block
703	.8ada	48		pha		                pha
704	.8adb	a0 03		ldy #$03	                ldy #configureTable.baud-configureTable
705	.8add	a2 02		ldx #$02	                ldx #(configureTable.baud-configureTable)-1

707	.8adf					loop:
708	.8adf	e8		inx		                inx
709	.8ae0	bd 87 87	lda $8787,x	                lda configureTable,x ;get name byte
710	.8ae3	f0 5a		beq $8b3f	                beq done            ;all done if 0
711	.8ae5	10 f8		bpl $8adf	                bpl loop            ;keep going until end of name
712						                                     ;reached
713	.8ae7	50 1f		bvc $8b08	                bvc L8B08            ;taken if *CONFIGURE

715						                ; A = metadata byte 0
716	.8ae9	29 40		and #$40	                and #$40
717	.8aeb	f0 10		beq $8afd	                beq L8AFD       ;taken if V0 clear

719	.8aed	bd 88 87	lda $8788,x	                lda configureTable+1,x ;A = metadata byte 1
720	.8af0	30 0b		bmi $8afd	                bmi L8AFD              ;taken if N1 set

722	.8af2	20 64 8a	jsr $8a64	                jsr readConfigurationByte ;Read the actual value
723	.8af5	5d 87 87	eor $8787,x	                eor configureTable,x      ;eor with MatchValue
724	.8af8	29 07		and #$07	                and #7                    ;A=0 if value matches MatchValue
725	.8afa	d0 3d		bne $8b39	                bne next                  ;taken if value isn't MatchValue
726	.8afc	3a		dec a		                dec a                     ;A=$ff

728	.8afd					L8AFD:
729	.8afd	b0 09		bcs $8b08	                bcs L8B08       ;
730	.8aff	10 38		bpl $8b39	                bpl next        ;
731	.8b01	68		pla		                pla
732	.8b02	48		pha		                pha
733	.8b03	5d 88 87	eor $8788,x	                eor configureTable+1,x
734	.8b06	d0 31		bne $8b39	                bne next

736	.8b08					L8B08:
737	.8b08	08		php		                php
738	.8b09	da		phx		                phx
739	.8b0a	50 09		bvc $8b15	                bvc printOrdinaryItem
740	.8b0c	c0 35		cpy #$35	                cpy #configureTable.ignore-configureTable
741	.8b0e	d0 05		bne $8b15	                bne printOrdinaryItem
742	.8b10	20 a1 8b	jsr $8ba1	                jsr readUsePrinterIgnoreChar
743	.8b13	b0 1b		bcs $8b30	                bcs L8B30

745	.8b15					printOrdinaryItem:
746	.8b15	a2 09		ldx #$09	                ldx #9
747	.8b17	20 6b 8b	jsr $8b6b	                jsr printConfigureTableString
748	.8b1a	29 40		and #$40	                and #$40
749	.8b1c	f0 0f		beq $8b2d	                beq printSpaces       ;taken if V0 clear
750	.8b1e	b9 88 87	lda $8788,y	                lda configureTable+1,y
751	.8b21	30 0a		bmi $8b2d	                bmi printSpaces ;taken if N1 set

753						                ; V0 set, N1 clear = newline and next item
754	.8b23	20 e7 ff	jsr $ffe7	                jsr OSNEWL
755	.8b26	80 0f		bra $8b37	                bra next2

757	.8b28					printSpacesLoop:
758	.8b28	a9 20		lda #$20	                lda #' '
759	.8b2a	20 ee ff	jsr $ffee	                jsr OSWRCH

761	.8b2d					printSpaces:
762	.8b2d	ca		dex		                dex
763	.8b2e	10 f8		bpl $8b28	                bpl printSpacesLoop

765	.8b30					L8B30:
766	.8b30	fa		plx		                plx
767	.8b31	28		plp		                plp
768	.8b32	08		php		                php
769	.8b33	da		phx		                phx
770	.8b34	20 84 88	jsr $8884	                jsr L8884

772	.8b37					next2:
773	.8b37	fa		plx		                plx
774	.8b38	28		plp		                plp

776	.8b39					next:
777	.8b39	e8		inx		                inx             ;point X just before next item
778	.8b3a	8a		txa		                txa
779	.8b3b	a8		tay		                tay
780	.8b3c	c8		iny		                iny             ;point Y at next item
781	.8b3d	80 a0		bra $8adf	                bra loop

783	.8b3f					done:
784	.8b3f	68		pla		                pla
785	.8b40	60		rts		                rts
786						                .endblock

788						;-------------------------------------------------------------------------

790	.8b41					printConfigureTableStringLoop:
791	.8b41	20 ee ff	jsr $ffee	                jsr OSWRCH      ;print char
792	.8b44	48		pha		                pha             ;save A (char to print)
793	.8b45	5a		phy		                phy             ;save Y (table offset)
794	.8b46	98		tya		                tya             ;get table offset in A

796						                ; If we're at a snippet insert point, insert the
797						                ; snippet, recursively.
798	.8b47	a0 02		ldy #$02	                ldy #configureTable.textSnippetsCount-1
799	.8b49					findSnippetInsertPointLoop:
800	.8b49	d9 50 88	cmp $8850,y	                cmp configureTable.textSnippetInsertPointOffsets,y
801	.8b4c	d0 07		bne $8b55	                bne nextSnippetInsertPoint

803						                ; Insert a snippet here. Load the new snippet's offset
804						                ; in Y and repeat.
805	.8b4e	b9 53 88	lda $8853,y	                lda configureTable.textSnippetOffsets,y
806	.8b51	a8		tay		                tay
807	.8b52	20 6b 8b	jsr $8b6b	                jsr printConfigureTableString
808	.8b55					nextSnippetInsertPoint
809	.8b55	88		dey		                dey
810	.8b56	10 f1		bpl $8b49	                bpl findSnippetInsertPointLoop
811	.8b58	7a		ply		                ply             ;restore Y (table offset)
812	.8b59	68		pla		                pla             ;restore A (char to print)
813	.8b5a	c8		iny		                iny             ;next byte in table
814	.8b5b	ca		dex		                dex             ;
815	.8b5c	49 20		eor #$20	                eor #$20
816	.8b5e	19 87 87	ora $8787,y	                ora configureTable,y
817	.8b61	29 a0		and #$a0	                and #%10100000
818	.8b63	d0 06		bne $8b6b	                bne printConfigureTableString

820						                ; if char case changed, but it wasn't the end of the
821						                ; string, pop a space in.
822	.8b65	a9 20		lda #$20	                lda #' '
823	.8b67	20 ee ff	jsr $ffee	                jsr OSWRCH
824	.8b6a	ca		dex		                dex
825						                .cerror *!=printConfigureTableString

827						;-------------------------------------------------------------------------
828						;
829						; Print string from configure table, with snippets inserted as
830						; required.
831						;
832						; Entry:
833						;
834						; X = column counter start value
835						; Y = configure table offset
836						;
837						; Exit:
838						;
839						; A = item's metadata byte 0
840						; X decremented for each char printed
841						;
842	.8b6b					printConfigureTableString:
843	.8b6b	b9 87 87	lda $8787,y	                lda configureTable,y
844	.8b6e	10 d1		bpl $8b41	                bpl printConfigureTableStringLoop
845	.8b70	60		rts		                rts


848						;-------------------------------------------------------------------------
849						;
850						; Issue ROM service call romServiceCallUnknownCONFIG ($28) or
851						; romServiceCallUnknownSTATUS ($29).
852						;
853						; Entry:
854						;
855						; C=1 for unknown CONFIG, or C=0 for unknown STATUS
856						;
857						; Exit:
858						;
859						; as per appropriate ROM service call
860						;
861	.8b71					unknownCONFIGOrStatus:
862	.8b71	a9 14		lda #$14	                lda #$14
863	.8b73	2a		rol a		                rol a           ;form $28 or $29 according to C
864	.8b74	aa		tax		                tax
865	.8b75	4c f8 ee	jmp $eef8	                jmp mos.makeROMServiceCall

867						;-------------------------------------------------------------------------
868						;
869						; Get actual RTC byte index for configure item, given offset in
870						; configure table to its metadata.
871						;
872						; Entry:
873						;
874						; X = offset into configure table for item's metadata
875						;
876						; Exit:
877						;
878						; X = index of byte read
879						;
880						; Preserves: Y/C

882	.8b78					getRTCByteIndex:
883	.8b78	bd 88 87	lda $8788,x	                lda configureTable+1,x
884	.8b7b	29 78		and #$78	                and #%01111000
885	.8b7d	4a		lsr a		                lsr a
886	.8b7e	4a		lsr a		                lsr a
887	.8b7f	4a		lsr a		                lsr a
888	.8b80	69 05		adc #$05	                adc #rtcByteIndexOffset
889	.8b82	aa		tax		                tax
890	.8b83	60		rts		                rts

892						;-------------------------------------------------------------------------
893						;
894						; Get shift count for configure item's data, given offset in configure
895						; table for its metadata.
896						;
897						; Entry:
898						;
899						; X = offset into configure table for item's metadata
900						;
901						; Exit:
902						;
903						; Y = shift count
904						;
905						; Preserves: A/X/C
906						;
907	.8b84					getShiftCount:
908	.8b84	48		pha		                pha
909	.8b85	bd 88 87	lda $8788,x	                lda configureTable+1,x
910	.8b88	29 07		and #$07	                and #%00000111
911	.8b8a	a8		tay		                tay
912	.8b8b	68		pla		                pla
913	.8b8c	60		rts		                rts


916						;-------------------------------------------------------------------------
917						;
918						; Get mask bit count for configure item's data, given offset in
919						; configure table for its metadata.
920						;
921						; Entry:
922						;
923						; X = offset into configure table for item's metadata
924						;
925						; Exit:
926						;
927						; Y = mask bit count, -1 (0 = 1 bits ... 7 = 8 bits)
928						;
929						; Preserves: A/X
930						;
931	.8b8d					getMaskCount:
932	.8b8d	48		pha		                pha
933	.8b8e	bd 87 87	lda $8787,x	                lda configureTable,x; "."
934	.8b91	4a		lsr a		                lsr a
935	.8b92	4a		lsr a		                lsr a
936	.8b93	4a		lsr a		                lsr a
937	.8b94	29 07		and #$07	                and #7
938	.8b96	a8		tay		                tay
939	.8b97	68		pla		                pla
940	.8b98	60		rts		                rts

942	.8b99					maskByBitCount:
943	>8b99	01				                .byte %00000001
944	>8b9a	03				                .byte %00000011
945	>8b9b	07				                .byte %00000111
946	>8b9c	0f				                .byte %00001111
947	>8b9d	1f				                .byte %00011111
948	>8b9e	3f				                .byte %00111111
949	>8b9f	7f				                .byte %01111111
950	>8ba0	ff				                .byte %11111111

952						;-------------------------------------------------------------------------
953						;
954						; Read the use printer ignore char flag.
955						;
956						; Exit:
957						;
958						; C=0 if using printer ignore char; C=1 if not.
959						;
960						; Preserves: Y

962						                .if version==350
965						                .endif
966	.8ba1					readUsePrinterIgnoreChar:
967	.8ba1	5a		phy		                phy
968	.8ba2	20 a2 9d	jsr $9da2	                jsr readDefaults2
969	.8ba5	4a		lsr a		                lsr a
970	.8ba6	4a		lsr a		                lsr a
971	.8ba7	7a		ply		                ply
972	.8ba8	60		rts		                rts

974						;-------------------------------------------------------------------------
975						;
976						; Print decimal byte.
977						;
978						; Entry:
979						;
980						; (printDecimalByteA) A = value to print
981						;
982						; (printDecimalByteY) Y = value to print
983						;
984	.8ba9					printDecimalByteY:
985	.8ba9	98		tya		                tya
986	.8baa					printDecimalByteA:
987	.8baa	38		sec		                sec             ;set leading zeros flag
988	.8bab	a0 ff		ldy #$ff	                ldy #$FF        ;reset digit counter
989	.8bad	08		php		                php             ;save leading zeros flag

991	.8bae					countHundredsLoop:
992	.8bae	c8		iny		                iny
993	.8baf	e9 64		sbc #$64	                sbc #100
994	.8bb1	b0 fb		bcs $8bae	                bcs countHundredsLoop

996	.8bb3	69 64		adc #$64	                adc #100        ;put 0 back in the hundreds column
997	.8bb5	28		plp		                plp             ;restore leading zeros flag
998	.8bb6	20 ca 8b	jsr $8bca	                jsr maybePrintHexDigit

1000	.8bb9	a0 ff		ldy #$ff	                ldy #$FF        ;reset digit counter
1001	.8bbb	08		php		                php             ;save leading zeros flag
1002	.8bbc	38		sec		                sec

1004	.8bbd					countTensLoop:
1005	.8bbd	c8		iny		                iny
1006	.8bbe	e9 0a		sbc #$0a	                sbc #10
1007	.8bc0	b0 fb		bcs $8bbd	                bcs countTensLoop

1009	.8bc2	69 0a		adc #$0a	                adc #10         ;put 0 back in the tens column
1010	.8bc4	28		plp		                plp             ;restore leading zeros flag
1011	.8bc5	20 ca 8b	jsr $8bca	                jsr maybePrintHexDigit
1012	.8bc8	18		clc		                clc             ;always clear leading zeros flag for
1013						                                ;units
1014	.8bc9	a8		tay		                tay             ;Y=3rd digit

1016	.8bca					maybePrintHexDigit:
1017	.8bca	48		pha		                pha
1018	.8bcb	98		tya		                tya
1019	.8bcc	d0 02		bne $8bd0	                bne L8BD0       ;always print if non-zero
1020	.8bce	b0 04		bcs $8bd4	                bcs L8BD4       ;print non-leading zeros
1021	.8bd0					L8BD0:
1022	.8bd0	20 42 ac	jsr $ac42	                jsr printHexDigit
1023	.8bd3	18		clc		                clc             ;indicate non-zero digit printed
1024	.8bd4					L8BD4:
1025	.8bd4	68		pla		                pla
1026	.8bd5	60		rts		                rts

1028						;-------------------------------------------------------------------------

1030						                .if version==350
1033						                .endif
1034	.8bd6					readDefaultTVSettings:
1035	.8bd6	a2 bc		ldx #$bc	                ldx #configureTable.L8605-configureTable
1036	.8bd8	20 64 8a	jsr $8a64	                jsr readConfigurationByte
1037	.8bdb	4a		lsr a		                lsr a
1038	.8bdc	89 04		bit #$04	                bit #%00000100
1039	.8bde	f0 02		beq $8be2	                beq L8BE2
1040	.8be0	09 fc		ora #$fc	                ora #%11111100
1041	.8be2					L8BE2:
1042	.8be2	a8		tay		                tay
1043	.8be3	a9 00		lda #$00	                lda #0
1044	.8be5	2a		rol a		                rol a
1045	.8be6	aa		tax		                tax
1046	.8be7	60		rts		                rts

1048						;-------------------------------------------------------------------------

:5	;******  Return to file: src/terminal.s65

935						                .include "sram_utils.s65"

:8	;******  Processing file: src/sram_utils.s65

1						;-------------------------------------------------------------------------

3	.8be8					unk_8BE8:
4						                .if version>=500||version==350
5	>8be8	01				                .byte 1
6						                .endif
7	>8be9	09				                .byte 9
8	>8bea	0a				                .byte $A
9	>8beb	0b				                .byte $B
10	>8bec	0c				                .byte $C
11	>8bed	02				                .byte 2
12	>8bee	03				                .byte 3
13	>8bef	04				                .byte 4
14	>8bf0	05				                .byte 5
15	>8bf1	06				                .byte 6

17						;-------------------------------------------------------------------------

19	.8bf2					L8BF2:
20						                .if version==400
24						                .endif
25	.8bf2	a0 09		ldy #$09	                ldy #9

27	.8bf4					L8BF4:
28	.8bf4	b1 f0		lda ($f0),y	                lda ($F0),y
29						                .if version==400
31						                .else
32	.8bf6	be e8 8b	ldx $8be8,y	                ldx unk_8BE8,y
33						                .endif
34	.8bf9	9d ed 02	sta $02ed,x	                sta osfileParameterBlock,x
35	.8bfc	88		dey		                dey
36						                .if version==400
38						                .else
39	.8bfd	10 f5		bpl $8bf4	                bpl L8BF4
40	.8bff	c8		iny		                iny
41						                .endif

43	.8c00					L8C00:
44	.8c00	b9 b0 00	lda $00b0,y	                lda $B0,y
45	.8c03	48		pha		                pha
46	.8c04	c8		iny		                iny
47	.8c05	c0 04		cpy #$04	                cpy #4
48	.8c07	90 f7		bcc $8c00	                bcc L8C00
49	.8c09	20 b7 8d	jsr $8db7	                jsr L8DB7
50	.8c0c	a0 03		ldy #$03	                ldy #3

52	.8c0e					L8C0E:
53	.8c0e	68		pla		                pla
54	.8c0f	99 b0 00	sta $00b0,y	                sta $B0,y
55	.8c12	88		dey		                dey
56	.8c13	10 f9		bpl $8c0e	                bpl L8C0E
57	.8c15	60		rts		                rts

59						;-------------------------------------------------------------------------

61	.8c16					L8C16:
62	.8c16	2c ee 02	bit $02ee	                bit osfileParameterBlock+1
63	.8c19	50 30		bvc $8c4b	                bvc L8C4B
64	.8c1b	a0 04		ldy #$04	                ldy #4
65	.8c1d	ad f2 02	lda $02f2	                lda osfileParameterBlock+5
66	.8c20	ae f3 02	ldx $02f3	                ldx osfileParameterBlock+6

68	.8c23					L8C23:
69	.8c23	e0 3f		cpx #$3f	                cpx #$3F
70	.8c25	90 16		bcc $8c3d	                bcc L8C3D
71	.8c27	d0 04		bne $8c2d	                bne L8C2D
72	.8c29	c9 f0		cmp #$f0	                cmp #$F0
73	.8c2b	90 10		bcc $8c3d	                bcc L8C3D

75	.8c2d					L8C2D:
76	.8c2d	e9 f0		sbc #$f0	                sbc #$F0
77	.8c2f	48		pha		                pha
78	.8c30	8a		txa		                txa
79	.8c31	e9 3f		sbc #$3f	                sbc #$3F
80	.8c33	aa		tax		                tax
81	.8c34	68		pla		                pla
82	.8c35	c8		iny		                iny
83	.8c36	c0 08		cpy #$08	                cpy #8
84	.8c38	90 e9		bcc $8c23	                bcc L8C23
85	.8c3a	4c 27 95	jmp $9527	                jmp badAddressError

87						;-------------------------------------------------------------------------

89	.8c3d					L8C3D:
90	.8c3d	69 10		adc #$10	                adc #$10
91	.8c3f	8d f2 02	sta $02f2	                sta osfileParameterBlock+5
92	.8c42	8a		txa		                txa
93	.8c43	69 80		adc #$80	                adc #$80
94	.8c45	8d f3 02	sta $02f3	                sta osfileParameterBlock+6
95	.8c48	8c f1 02	sty $02f1	                sty osfileParameterBlock+4

97	.8c4b					L8C4B:
98	.8c4b	ad f1 02	lda $02f1	                lda osfileParameterBlock+4
99	.8c4e	c9 10		cmp #$10	                cmp #$10
100	.8c50	90 09		bcc $8c5b	                bcc L8C5B
101	.8c52	c9 14		cmp #$14	                cmp #$14
102	.8c54	b0 1e		bcs $8c74	                bcs L8C74
103	.8c56	49 14		eor #$14	                eor #$14
104	.8c58	8d f1 02	sta $02f1	                sta osfileParameterBlock+4

106	.8c5b					L8C5B:
107	.8c5b	aa		tax		                tax
108	.8c5c	20 9a f8	jsr $f89a	                jsr mos.LF89A
109	.8c5f	b0 07		bcs $8c68	                bcs L8C68
110	.8c61	2c ee 02	bit $02ee	                bit osfileParameterBlock+1
111	.8c64	10 0e		bpl $8c74	                bpl L8C74
112	.8c66	70 0c		bvs $8c74	                bvs L8C74

114	.8c68					L8C68:
115	.8c68	20 84 8f	jsr $8f84	                jsr L8F84
116	.8c6b	ae f1 02	ldx $02f1	                ldx osfileParameterBlock+4
117	.8c6e	4d ee 02	eor $02ee	                eor osfileParameterBlock+1
118	.8c71	29 40		and #$40	                and #$40
119	.8c73	60		rts		                rts

121						;-------------------------------------------------------------------------

123	.8c74					L8C74:
124	.8c74	20 8c ae	jsr $ae8c	                jsr doFollowingError

126						;-------------------------------------------------------------------------

128	>8c77	80				                .byte $80
129	>8c78	42 61 64 20 69 64		                .text "Bad id"
130	>8c7e	00				                .byte 0

132						;-------------------------------------------------------------------------

134	.8c7f					L8C7F:
135	.8c7f	20 5b 86	jsr $865b	                jsr readHexDigit
136	.8c82	2c 70 e3	bit $e370	                bit mos.valueFF
137	.8c85	b0 0d		bcs $8c94	                bcs L8C94
138	.8c87	29 df		and #$df	                and #$DF
139	.8c89	c9 5b		cmp #$5b	                cmp #$5B
140	.8c8b	b0 1d		bcs $8caa	                bcs L8CAA
141	.8c8d	c9 57		cmp #$57	                cmp #'W'
142	.8c8f	90 19		bcc $8caa	                bcc L8CAA
143	.8c91	e9 53		sbc #$53	                sbc #'S'
144	.8c93	c8		iny		                iny

146	.8c94					L8C94:
147	.8c94	c9 01		cmp #$01	                cmp #1
148	.8c96	d0 09		bne $8ca1	                bne L8CA1
149	.8c98	88		dey		                dey
150	.8c99	20 f9 85	jsr $85f9	                jsr parseNumberFromString
151	.8c9c	8a		txa		                txa
152	.8c9d	c9 10		cmp #$10	                cmp #$10
153	.8c9f	b0 d3		bcs $8c74	                bcs L8C74

155	.8ca1					L8CA1:
156	.8ca1	8d f1 02	sta $02f1	                sta osfileParameterBlock+4
157	.8ca4	a9 40		lda #$40	                lda #$40
158	.8ca6	1c ee 02	trb $02ee	                trb osfileParameterBlock+1
159	.8ca9	b8		clv		                clv

161	.8caa					L8CAA:
162	.8caa	4c ad f3	jmp $f3ad	                jmp mos.skipSpacesAndCheckForCRInStringInput


165						;-------------------------------------------------------------------------

167	.8cad					starSRDATAOrStarSRROM:
168	.8cad	48		pha		                pha
169	.8cae	20 7f 8c	jsr $8c7f	                jsr L8C7F
170	.8cb1	70 23		bvs $8cd6	                bvs L8CD6
171	.8cb3	d0 21		bne $8cd6	                bne L8CD6
172	.8cb5	68		pla		                pla
173						                .if version==400
175						                .else
176	.8cb6	0a		asl a		                asl a
177	.8cb7	8d ee 02	sta $02ee	                sta osfileParameterBlock+1
178						                .endif
179	.8cba	20 4b 8c	jsr $8c4b	                jsr L8C4B
180	.8cbd	b0 b5		bcs $8c74	                bcs L8C74
181	.8cbf	d0 06		bne $8cc7	                bne L8CC7
182	.8cc1	1d a1 02	ora $02a1,x	                ora romInformationTable,x
183	.8cc4	f0 0a		beq $8cd0	                beq L8CD0
184	.8cc6	60		rts		                rts

186						;-------------------------------------------------------------------------

188	.8cc7					L8CC7:
189	.8cc7	ad de df	lda $dfde	                lda hazel.dfde
190	.8cca	5d 4c 8f	eor $8f4c,x	                eor L8F4C,x
191	.8ccd	8d de df	sta $dfde	                sta hazel.dfde

193	.8cd0					L8CD0:
194	.8cd0	20 4a 8f	jsr $8f4a	                jsr L8F4A
195	.8cd3	4c 7c f8	jmp $f87c	                jmp mos.LF87C

197						;-------------------------------------------------------------------------

199	.8cd6					L8CD6:
200	.8cd6	4c 3d fb	jmp $fb3d	                jmp mos.badCommandError

202						;-------------------------------------------------------------------------

204	.8cd9					L8CD9:
205	.8cd9	20 ea 8c	jsr $8cea	                jsr L8CEA
206	.8cdc	b0 0b		bcs $8ce9	                bcs locret_8CE9
207	.8cde	20 46 f8	jsr $f846	                jsr mos.LF846
208	.8ce1	8c f2 02	sty $02f2	                sty osfileParameterBlock+5
209	.8ce4	b5 01		lda $01,x	                lda 1,x
210	.8ce6	8d f3 02	sta $02f3	                sta osfileParameterBlock+6

212	.8ce9					locret_8CE9:
213	.8ce9	60		rts		                rts


216						;-------------------------------------------------------------------------

218	.8cea					L8CEA:
219	.8cea	a2 b0		ldx #$b0	                ldx #$B0
220	.8cec	2c ee 02	bit $02ee	                bit osfileParameterBlock+1
221	.8cef	10 02		bpl $8cf3	                bpl L8CF3
222	.8cf1	a2 b2		ldx #$b2	                ldx #$B2

224	.8cf3					L8CF3:
225	.8cf3	74 00		stz $00,x	                stz 0,x
226	.8cf5	ac f2 02	ldy $02f2	                ldy osfileParameterBlock+5
227	.8cf8	98		tya		                tya
228	.8cf9	18		clc		                clc
229	.8cfa	6d ef 02	adc $02ef	                adc osfileParameterBlock+2
230	.8cfd	8d ef 02	sta $02ef	                sta osfileParameterBlock+2
231	.8d00	ad f3 02	lda $02f3	                lda osfileParameterBlock+6
232	.8d03	95 01		sta $01,x	                sta 1,x
233	.8d05	6d f0 02	adc $02f0	                adc osfileParameterBlock+3
234	.8d08	8d f0 02	sta $02f0	                sta osfileParameterBlock+3
235	.8d0b	38		sec		                sec
236	.8d0c	20 62 8f	jsr $8f62	                jsr L8F62


239						;-------------------------------------------------------------------------

241	.8d0f					L8D0F:

243	.8d0f	cc ef 02	cpy $02ef	                cpy osfileParameterBlock+2
244	.8d12	d0 08		bne $8d1c	                bne L8D1C
245	.8d14	b5 01		lda $01,x	                lda 1,x
246	.8d16	cd f0 02	cmp $02f0	                cmp osfileParameterBlock+3
247	.8d19	d0 01		bne $8d1c	                bne L8D1C
248	.8d1b	60		rts		                rts

250						;-------------------------------------------------------------------------

252	.8d1c					L8D1C:
253	.8d1c	2c ee 02	bit $02ee	                bit osfileParameterBlock+1
254	.8d1f	50 32		bvc $8d53	                bvc L8D53
255	.8d21	b5 01		lda $01,x	                lda 1,x
256	.8d23	c9 c0		cmp #$c0	                cmp #$C0
257	.8d25	90 2c		bcc $8d53	                bcc L8D53
258	.8d27	a9 80		lda #$80	                lda #$80
259	.8d29	95 01		sta $01,x	                sta 1,x
260	.8d2b	ee f1 02	inc $02f1	                inc osfileParameterBlock+4
261	.8d2e	ad f1 02	lda $02f1	                lda osfileParameterBlock+4
262	.8d31	c9 08		cmp #$08	                cmp #8
263	.8d33	b0 2e		bcs $8d63	                bcs L8D63
264	.8d35	da		phx		                phx
265	.8d36	20 4b 8c	jsr $8c4b	                jsr L8C4B
266	.8d39	d0 28		bne $8d63	                bne L8D63
267	.8d3b	fa		plx		                plx
268	.8d3c	a0 10		ldy #$10	                ldy #$10
269	.8d3e	ad ef 02	lda $02ef	                lda osfileParameterBlock+2
270	.8d41	38		sec		                sec
271	.8d42	e9 f0		sbc #$f0	                sbc #$F0
272	.8d44	8d ef 02	sta $02ef	                sta osfileParameterBlock+2
273	.8d47	ad f0 02	lda $02f0	                lda osfileParameterBlock+3
274	.8d4a	e9 3f		sbc #$3f	                sbc #$3F
275	.8d4c	8d f0 02	sta $02f0	                sta osfileParameterBlock+3
276	.8d4f	18		clc		                clc
277	.8d50	20 62 8f	jsr $8f62	                jsr L8F62

279	.8d53					L8D53:
280	.8d53	ad f1 02	lda $02f1	                lda osfileParameterBlock+4
281	.8d56	18		clc		                clc

283	.8d57					locret_8D57:
284	.8d57	60		rts		                rts

286						;-------------------------------------------------------------------------

288	.8d58					L8D58:
289	.8d58	20 37 95	jsr $9537	                jsr parseHexAddressFromCommandLine

291	.8d5b					L8D5B:
292	.8d5b	bd ef 02	lda $02ef,x	                lda osfileParameterBlock+2,x
293	.8d5e	1d f0 02	ora $02f0,x	                ora osfileParameterBlock+3,x
294	.8d61	f0 f4		beq $8d57	                beq locret_8D57

296	.8d63					L8D63:
297	.8d63	4c 27 95	jmp $9527	                jmp badAddressError

299						;-------------------------------------------------------------------------

301	.8d66					L8D66:
302						                .if version!=400
303	.8d66	20 ad f3	jsr $f3ad	                jsr mos.skipSpacesAndCheckForCRInStringInput
304	.8d69	29 df		and #$df	                and #$DF
305	.8d6b	c9 49		cmp #$49	                cmp #'I'
306	.8d6d	d0 0d		bne $8d7c	                bne L8D7C
307	.8d6f	c8		iny		                iny
308	.8d70	ad ee 02	lda $02ee	                lda osfileParameterBlock+1
309	.8d73	c9 80		cmp #$80	                cmp #$80
310	.8d75	d0 3d		bne $8db4	                bne L8DB4
311	.8d77	09 20		ora #$20	                ora #$20
312	.8d79	8d ee 02	sta $02ee	                sta osfileParameterBlock+1

314	.8d7c					L8D7C:
315	.8d7c	4c ad f3	jmp $f3ad	                jmp mos.skipSpacesAndCheckForCRInStringInput
316						                .endif

318						;-------------------------------------------------------------------------

320	.8d7f					starSRREADOrStarSRWRITE:
321						                .if version==400
323						                .else
324	.8d7f	0a		asl a		                asl a
325	.8d80	8d ee 02	sta $02ee	                sta osfileParameterBlock+1
326						                .endif
327	.8d83	a2 09		ldx #$09	                ldx #9
328	.8d85	20 37 95	jsr $9537	                jsr parseHexAddressFromCommandLine
329	.8d88	20 54 8f	jsr $8f54	                jsr L8F54
330	.8d8b	a2 02		ldx #$02	                ldx #2
331	.8d8d	20 37 95	jsr $9537	                jsr parseHexAddressFromCommandLine
332	.8d90	70 10		bvs $8da2	                bvs L8DA2
333	.8d92	a2 fc		ldx #$fc	                ldx #$FC

335	.8d94					L8D94:
336	.8d94	bd f3 01	lda $01f3,x	                lda osfileParameterBlock+2-$FC,x
337	.8d97	fd fa 01	sbc $01fa,x	                sbc osfileParameterBlock+9-$FC,x
338	.8d9a	9d f3 01	sta $01f3,x	                sta osfileParameterBlock+2-$FC,x
339	.8d9d	e8		inx		                inx
340	.8d9e	d0 f4		bne $8d94	                bne L8D94
341	.8da0	90 c1		bcc $8d63	                bcc L8D63

343	.8da2					L8DA2:
344	.8da2	a2 02		ldx #$02	                ldx #2
345	.8da4	20 5b 8d	jsr $8d5b	                jsr L8D5B
346	.8da7	a2 05		ldx #$05	                ldx #5
347	.8da9	20 58 8d	jsr $8d58	                jsr L8D58
348	.8dac	20 7f 8c	jsr $8c7f	                jsr L8C7F
349						                .if version>=500||version==350
350	.8daf	20 66 8d	jsr $8d66	                jsr L8D66
351						                .endif
352	.8db2	f0 03		beq $8db7	                beq L8DB7

354	.8db4					L8DB4:
355	.8db4	4c 3d fb	jmp $fb3d	                jmp mos.badCommandError

357						;-------------------------------------------------------------------------

359	.8db7					L8DB7:

361	.8db7	08		php		                php
362	.8db8	20 16 8c	jsr $8c16	                jsr L8C16
363	.8dbb	f0 03		beq $8dc0	                beq L8DC0
364	.8dbd	20 74 8c	jsr $8c74	                jsr L8C74

366	.8dc0					L8DC0:
367	.8dc0	20 40 8f	jsr $8f40	                jsr L8F40
368						                .if version==400||version==350
374						                .endif
375	.8dc3	20 d9 8c	jsr $8cd9	                jsr L8CD9
376	.8dc6	28		plp		                plp
377						                .if version==400
379						                .else
380	.8dc7	4c d1 f8	jmp $f8d1	                jmp mos.LF8D1
381						                .endif

383						;-------------------------------------------------------------------------

385						                .if version<500
406						                .endif

408						;-------------------------------------------------------------------------

410	.8dca					starSRLOADOrStarSRSAVE:
411						                .if version==400
413						                .else
414	.8dca	0a		asl a		                asl a
415	.8dcb	8d ee 02	sta $02ee	                sta osfileParameterBlock+1
416						                .endif
417	.8dce	4e c6 df	lsr $dfc6	                lsr hazel.tempFSFlag
418	.8dd1	86 f2		stx $f2		                stx stringInputBufferAddress
419	.8dd3	84 f3		sty $f3		                sty stringInputBufferAddress+1
420	.8dd5	8e ef 02	stx $02ef	                stx osfileParameterBlock+2
421	.8dd8	8c f0 02	sty $02f0	                sty osfileParameterBlock+3
422	.8ddb	a0 00		ldy #$00	                ldy #0
423	.8ddd	20 1b f3	jsr $f31b	                jsr mos.gsinitForFilenameParsing

425	.8de0					L8DE0:
426	.8de0	20 2d f3	jsr $f32d	                jsr mos.gsreadEntryPoint
427	.8de3	90 fb		bcc $8de0	                bcc L8DE0
428	.8de5	a2 05		ldx #$05	                ldx #5
429	.8de7	20 58 8d	jsr $8d58	                jsr L8D58
430	.8dea	2c ee 02	bit $02ee	                bit osfileParameterBlock+1
431	.8ded	30 1e		bmi $8e0d	                bmi L8E0D
432	.8def	20 54 8f	jsr $8f54	                jsr L8F54
433	.8df2	a2 07		ldx #$07	                ldx #7
434	.8df4	20 58 8d	jsr $8d58	                jsr L8D58
435	.8df7	70 14		bvs $8e0d	                bvs L8E0D
436	.8df9	38		sec		                sec
437	.8dfa	a2 fe		ldx #$fe	                ldx #$FE

439	.8dfc					L8DFC:
440	.8dfc	bd f6 01	lda $01f6,x	                lda osfileParameterBlock+7-$FE,x
441	.8dff	fd f4 01	sbc $01f4,x	                sbc osfileParameterBlock+5-$FE,x
442	.8e02	9d f6 01	sta $01f6,x	                sta osfileParameterBlock+7-$FE,x
443	.8e05	e8		inx		                inx
444	.8e06	d0 f4		bne $8dfc	                bne L8DFC
445	.8e08	b0 03		bcs $8e0d	                bcs L8E0D
446	.8e0a	4c 63 8d	jmp $8d63	                jmp L8D63

448						;-------------------------------------------------------------------------

450	.8e0d					L8E0D:
451	.8e0d	20 7f 8c	jsr $8c7f	                jsr L8C7F
452	.8e10	9c f8 02	stz $02f8	                stz osfileParameterBlock+$B
453						                .if version==350
455						                .else
456	.8e13	a2 00		ldx #$00	                ldx #0
457						                .endif
458						                .if version>=500||version==350
459	.8e15	20 66 8d	jsr $8d66	                jsr L8D66
460						                .endif
461	.8e18	29 df		and #$df	                and #$DF
462						                .if version==350
464						                .endif
465	.8e1a	c9 51		cmp #$51	                cmp #'Q'
466						                .if version==350
468						                .else
469	.8e1c	d0 02		bne $8e20	                bne L8E20
470						                .endif
471						                .if version==350
473						                .endif
474						                .if version==350
479						                .else
480	.8e1e	ca		dex		                dex
481	.8e1f	c8		iny		                iny
482						                .endif

484	.8e20					L8E20:
485	.8e20	8e f9 02	stx $02f9	                stx osfileParameterBlock+$C
486	.8e23	ae 34 fe	ldx $fe34	                ldx ACCCON
487						                .if version==400
489						                .else
490	.8e26	20 66 8d	jsr $8d66	                jsr L8D66
491						                .endif
492	.8e29	f0 16		beq $8e41	                beq L8E41
493	.8e2b	4c b4 8d	jmp $8db4	                jmp L8DB4

495						;-------------------------------------------------------------------------

497	.8e2e					L8E2E:
498	.8e2e	ae 34 fe	ldx $fe34	                ldx ACCCON
499	.8e31	20 40 ee	jsr $ee40	                jsr mos.selectHAZEL
500	.8e34	9c c6 df	stz $dfc6	                stz hazel.tempFSFlag
501	.8e37	a0 0b		ldy #$0b	                ldy #$B

503	.8e39					L8E39:
504	.8e39	b1 f0		lda ($f0),y	                lda ($F0),y
505	.8e3b	99 ee 02	sta $02ee,y	                sta osfileParameterBlock+1,y
506	.8e3e	88		dey		                dey
507	.8e3f	10 f8		bpl $8e39	                bpl L8E39
508						                .if version==400
511						                .endif

513	.8e41					L8E41:
514	.8e41	08		php		                php
515	.8e42	da		phx		                phx
516	.8e43	20 16 8c	jsr $8c16	                jsr L8C16
517	.8e46	f0 03		beq $8e4b	                beq L8E4B
518	.8e48	4c 74 8c	jmp $8c74	                jmp L8C74

520						;-------------------------------------------------------------------------

522	.8e4b					L8E4B:
523	.8e4b	ad f9 02	lda $02f9	                lda osfileParameterBlock+$C
524	.8e4e	30 0b		bmi $8e5b	                bmi L8E5B
525	.8e50	0d f8 02	ora $02f8	                ora osfileParameterBlock+$B
526	.8e53	d0 1d		bne $8e72	                bne L8E72
527	.8e55	a9 02		lda #$02	                lda #2
528	.8e57	a0 dd		ldy #$dd	                ldy #$DD
529	.8e59	80 0b		bra $8e66	                bra L8E66

531						;-------------------------------------------------------------------------

533	.8e5b					L8E5B:
534	.8e5b	20 68 f2	jsr $f268	                jsr mos.osbyte84
535	.8e5e	98		tya		                tya
536	.8e5f	38		sec		                sec
537	.8e60	ed 44 02	sbc $0244	                sbc oshwm
538	.8e63	ac 44 02	ldy $0244	                ldy oshwm

540	.8e66					L8E66:
541	.8e66	9c f6 02	stz $02f6	                stz osfileParameterBlock+9
542	.8e69	8c f7 02	sty $02f7	                sty osfileParameterBlock+$A
543	.8e6c	9c f8 02	stz $02f8	                stz osfileParameterBlock+$B
544	.8e6f	8d f9 02	sta $02f9	                sta osfileParameterBlock+$C

546	.8e72					L8E72:
547	.8e72	2c ee 02	bit $02ee	                bit osfileParameterBlock+1
548	.8e75	10 38		bpl $8eaf	                bpl L8EAF
549	.8e77	a9 40		lda #$40	                lda #$40
550	.8e79	20 1b 8f	jsr $8f1b	                jsr L8F1B

552	.8e7c					L8E7C:
553	.8e7c	38		sec		                sec
554	.8e7d	20 ed 8e	jsr $8eed	                jsr L8EED
555	.8e80	a9 04		lda #$04	                lda #4
556	.8e82	20 14 8f	jsr $8f14	                jsr L8F14_500
557	.8e85	08		php		                php
558	.8e86	90 0e		bcc $8e96	                bcc L8E96
559	.8e88	a2 fe		ldx #$fe	                ldx #$FE

561	.8e8a					L8E8A:
562	.8e8a	bd f1 01	lda $01f1,x	                lda osfileParameterBlock+2-$FE,x

564	.8e8d					L8E8D:
565	.8e8d	fd ce de	sbc $dece,x	                sbc hazel.moveOSGBPB+OSGBPBParameterBlock.count+0-$fe,x
566	.8e90	9d f1 01	sta $01f1,x	                sta osfileParameterBlock+2-$FE,x
567	.8e93	e8		inx		                inx
568	.8e94	d0 f4		bne $8e8a	                bne L8E8A

570	.8e96					L8E96:
571	.8e96	20 d9 8c	jsr $8cd9	                jsr L8CD9
572	.8e99	28		plp		                plp
573	.8e9a	90 e0		bcc $8e7c	                bcc L8E7C

575	.8e9c					L8E9C:
576	.8e9c	ac d4 df	ldy $dfd4	                ldy hazel.moveSrcHandle
577	.8e9f	9c d4 df	stz $dfd4	                stz hazel.moveSrcHandle
578	.8ea2	a9 00		lda #$00	                lda #0
579	.8ea4	20 ce ff	jsr $ffce	                jsr OSFIND
580	.8ea7	68		pla		                pla
581	.8ea8	8d 34 fe	sta $fe34	                sta ACCCON
582	.8eab	28		plp		                plp
583						                .if version==400
585						                .else
586	.8eac	4c d1 f8	jmp $f8d1	                jmp mos.LF8D1
587						                .endif

589						;-------------------------------------------------------------------------

591	.8eaf					L8EAF:
592	.8eaf	a9 80		lda #$80	                lda #$80
593	.8eb1	20 1b 8f	jsr $8f1b	                jsr L8F1B

595	.8eb4					L8EB4:
596	.8eb4	38		sec		                sec
597	.8eb5	a2 fe		ldx #$fe	                ldx #$FE

599	.8eb7					L8EB7:
600	.8eb7	bd f6 01	lda $01f6,x	                lda osfileParameterBlock+7-$FE,x
601	.8eba	9d b2 ff	sta $ffb2,x	                sta ($B0-$FE)&$ffff,x
602	.8ebd	fd fa 01	sbc $01fa,x	                sbc osfileParameterBlock+$B-$FE,x
603	.8ec0	9d f6 01	sta $01f6,x	                sta osfileParameterBlock+7-$FE,x
604	.8ec3	e8		inx		                inx
605	.8ec4	d0 f1		bne $8eb7	                bne L8EB7
606	.8ec6	0d f4 02	ora $02f4	                ora osfileParameterBlock+7
607	.8ec9	08		php		                php
608	.8eca	20 ed 8e	jsr $8eed	                jsr L8EED
609	.8ecd	20 d9 8c	jsr $8cd9	                jsr L8CD9
610	.8ed0	a9 02		lda #$02	                lda #2
611	.8ed2	20 14 8f	jsr $8f14	                jsr L8F14_500
612	.8ed5	28		plp		                plp
613	.8ed6	90 c4		bcc $8e9c	                bcc L8E9C
614	.8ed8	f0 c2		beq $8e9c	                beq L8E9C
615	.8eda	80 d8		bra $8eb4	                bra L8EB4

617						;-------------------------------------------------------------------------

619						                .if version==400
624						                .endif

626						;-------------------------------------------------------------------------

628	.8edc					L8EDC:
629	.8edc	a9 00		lda #$00	                lda #0
630	.8ede	a2 07		ldx #$07	                ldx #7

632	.8ee0					L8EE0:
633	.8ee0	48		pha		                pha
634	.8ee1	20 9a f8	jsr $f89a	                jsr mos.LF89A
635	.8ee4	68		pla		                pla
636	.8ee5	2a		rol a		                rol a
637	.8ee6	ca		dex		                dex
638	.8ee7	e0 04		cpx #$04	                cpx #4
639	.8ee9	b0 f5		bcs $8ee0	                bcs L8EE0
640	.8eeb	aa		tax		                tax
641	.8eec	60		rts		                rts

643						;-------------------------------------------------------------------------

645	.8eed					L8EED:
646	.8eed	ad d4 df	lda $dfd4	                lda hazel.moveSrcHandle
647	.8ef0	8d c7 df	sta $dfc7	                sta hazel.moveOSGBPB+0
648	.8ef3	a2 01		ldx #$01	                ldx #1

650	.8ef5					L8EF5:
651	.8ef5	bd f6 02	lda $02f6,x	                lda osfileParameterBlock+9,x
652	.8ef8	9d c8 df	sta $dfc8,x	                sta $DFC8,x
653	.8efb	bd f8 02	lda $02f8,x	                lda osfileParameterBlock+$B,x
654	.8efe	b0 02		bcs $8f02	                bcs L8F02
655	.8f00	b5 b0		lda $b0,x	                lda $B0,x

657	.8f02					L8F02:
658	.8f02	9d cc df	sta $dfcc,x	                sta $DFCC,x
659	.8f05	9d ef 02	sta $02ef,x	                sta osfileParameterBlock+2,x
660	.8f08	a9 ff		lda #$ff	                lda #$FF
661	.8f0a	9d ca df	sta $dfca,x	                sta $DFCA,x
662	.8f0d	9e ce df	stz $dfce,x	                stz $DFCE,x
663	.8f10	ca		dex		                dex
664	.8f11	10 e2		bpl $8ef5	                bpl L8EF5
665	.8f13	60		rts		                rts


668						;-------------------------------------------------------------------------

670	.8f14					L8F14_500:
671	.8f14	a2 c7		ldx #$c7	                ldx #<hazel.moveOSGBPB
672	.8f16	a0 df		ldy #$df	                ldy #>hazel.moveOSGBPB
673	.8f18	4c d1 ff	jmp $ffd1	                jmp OSGBPB


676						;-------------------------------------------------------------------------

678	.8f1b					L8F1B:
679	.8f1b	0e c6 df	asl $dfc6	                asl hazel.tempFSFlag
680	.8f1e	ae ef 02	ldx $02ef	                ldx osfileParameterBlock+2
681	.8f21	ac f0 02	ldy $02f0	                ldy osfileParameterBlock+3
682	.8f24	20 ce ff	jsr $ffce	                jsr OSFIND
683	.8f27	aa		tax		                tax
684	.8f28	d0 13		bne $8f3d	                bne L8F3D
685	.8f2a	20 8c ae	jsr $ae8c	                jsr doFollowingError

687						;-------------------------------------------------------------------------

689	>8f2d	d6				                .byte $D6
690	>8f2e	46 69 6c 65 20 6e 6f 74		                .text "File not found"
	>8f36	20 66 6f 75 6e 64
691	>8f3c	00				                .byte 0

693						;-------------------------------------------------------------------------

695	.8f3d					L8F3D:
696	.8f3d	8d d4 df	sta $dfd4	                sta hazel.moveSrcHandle


699						;-------------------------------------------------------------------------

701	.8f40					L8F40:
702	.8f40	ae f1 02	ldx $02f1	                ldx osfileParameterBlock+4
703	.8f43	2c ee 02	bit $02ee	                bit osfileParameterBlock+1
704	.8f46	10 07		bpl $8f4f	                bpl locret_8F4F
705	.8f48	70 05		bvs $8f4f	                bvs locret_8F4F

707	.8f4a					L8F4A:
708	.8f4a	a9 02		lda #$02	                lda #2

710	.8f4c					L8F4C:
711	.8f4c	9d a1 02	sta $02a1,x	                sta romInformationTable,x

713	.8f4f					locret_8F4F:
714	.8f4f	60		rts		                rts


717						;-------------------------------------------------------------------------

719	>8f50	01				unk_8F50:       .byte 1
720	>8f51	02				                .byte 2
721	>8f52	04				                .byte 4
722	>8f53	08				                .byte 8

724						;-------------------------------------------------------------------------

726	.8f54					L8F54:
727	.8f54	b8		clv		                clv
728	.8f55	b1 f2		lda ($f2),y	                lda (stringInputBufferAddress),y
729	.8f57	c9 2b		cmp #$2b	                cmp #'+'
730	.8f59	d0 06		bne $8f61	                bne locret_8F61
731	.8f5b	2c 70 e3	bit $e370	                bit mos.valueFF
732	.8f5e	20 ac f3	jsr $f3ac	                jsr mos.incAndSkipSpaces

734	.8f61					locret_8F61:
735	.8f61	60		rts		                rts


738						;-------------------------------------------------------------------------

740	.8f62					L8F62:
741	.8f62	da		phx		                phx
742	.8f63	8a		txa		                txa
743	.8f64	49 02		eor #$02	                eor #2
744	.8f66	aa		tax		                tax
745	.8f67	90 0a		bcc $8f73	                bcc L8F73
746	.8f69	ad f6 02	lda $02f6	                lda osfileParameterBlock+9
747	.8f6c	95 00		sta $00,x	                sta 0,x
748	.8f6e	ad f7 02	lda $02f7	                lda osfileParameterBlock+$A
749	.8f71	95 01		sta $01,x	                sta 1,x

751	.8f73					L8F73:
752	.8f73	8c ed 02	sty $02ed	                sty osfileParameterBlock
753	.8f76	b5 00		lda $00,x	                lda 0,x
754	.8f78	38		sec		                sec
755	.8f79	ed ed 02	sbc $02ed	                sbc osfileParameterBlock
756	.8f7c	95 00		sta $00,x	                sta 0,x
757	.8f7e	b0 02		bcs $8f82	                bcs L8F82
758	.8f80	d6 01		dec $01,x	                dec 1,x

760	.8f82					L8F82:
761	.8f82	fa		plx		                plx
762	.8f83	60		rts		                rts


765						;-------------------------------------------------------------------------

767	.8f84					L8F84:
768	.8f84	e0 04		cpx #$04	                cpx #4
769	.8f86	90 1c		bcc $8fa4	                bcc L8FA4
770	.8f88	e0 08		cpx #$08	                cpx #8
771	.8f8a	b0 18		bcs $8fa4	                bcs L8FA4

773	.8f8c					L8F8C:
774	.8f8c	ac 34 fe	ldy $fe34	                ldy ACCCON
775	.8f8f	20 40 ee	jsr $ee40	                jsr mos.selectHAZEL
776	.8f92	bd 4c 8f	lda $8f4c,x	                lda unk_8F50-4,x
777	.8f95	ae de df	ldx $dfde	                ldx hazel.dfde
778	.8f98	2d de df	and $dfde	                and hazel.dfde
779	.8f9b	f0 02		beq $8f9f	                beq L8F9F
780	.8f9d	a9 40		lda #$40	                lda #$40

782	.8f9f					L8F9F:
783	.8f9f	8c 34 fe	sty $fe34	                sty ACCCON
784	.8fa2	18		clc		                clc
785	.8fa3	60		rts		                rts

787						;-------------------------------------------------------------------------

789	.8fa4					L8FA4:
790	.8fa4	38		sec		                sec
791	.8fa5	a9 00		lda #$00	                lda #0
792	.8fa7	60		rts		                rts


:5	;******  Return to file: src/terminal.s65

936						                .include "osbyte_osword_table.s65"

:9	;******  Processing file: src/osbyte_osword_table.s65

1						; OSBYTE Dispatch Table
2						; =====================

4						; TODO structure probably the same as
5						; https://tobylobster.github.io/mos/mos/S-s15.html#SP1...

7						; entry:
8						;
9						; A = OSBYTE A
10						;
11						; X = OSBYTE X
12						;
13						; Y = OSBYTE Y
14						;
15						; ?originalA, ?originalX, ?originalY = OSBYTE arguments
16						;
17						; C=1
18						;
19						; N/Z set as per X
20						;

22	.8fa8					osbyteAndOSWORDRoutineTable:
23						                ;Display MOS version D.2-18
24	>8fa8	17 f0				                .word mos.osbyte00

26						                ;Write user flag D.2-18
27	>8faa	77 f1				                .word mos.osbyte01

29						                ;Specify input stream D.2-18
30						                .if version==400
32						                .else
33	>8fac	49 ed				                .word mos.osbyte02
34						                .endif

36						                ;Specify output stream D.2-19
37	>8fae	4c f1				                .word mos.osbyte03

39						                ;Enable/disable cursor editing
40	>8fb0	7f f1				                .word mos.osbyte04

42						                ;Write printer driver type D.2-20
43	>8fb2	65 f1				                .word mos.osbyte05

45						                ;Write printer ignore character D.2-21
46	>8fb4	5c f1				                .word mos.osbyte06

48						                ;Write RS423 receive rate D.2-21
49						                .if version==400
51						                .else
52	>8fb6	02 ed				                .word mos.osbyte07
53						                .endif

55						                ;Write RS423 transmit rate D.2-22
56						                .if version==400
58						                .else
59	>8fb8	00 ed				                .word mos.osbyte08
60						                .endif

62						                ;Write duration of first colour D.2-22
63	>8fba	27 ed				                .word mos.osbyte09

65						                ;Write duration of second colour D.2-22
66	>8fbc	29 ed				                .word mos.osbyte0A

68						                ;Write keyboard auto-repeat delay D.2-22
69	>8fbe	7d f1				                .word mos.osbyte0B

71						                ;Write keyboard auto-repeat rate D.2-23
72	>8fc0	7b f1				                .word mos.osbyte0C

74						                ;Disable event D.2-23
75	>8fc2	6f ed				                .word mos.osbyte0D

77						                ;Enable event D.2-24
78	>8fc4	70 ed				                .word mos.osbyte0E

80						                ;Flush buffer D.2-24
81	>8fc6	70 ea				                .word mos.osbyte0F

83						                ;Write number of ADC channels D.2-25
84						                .if version==400
86						                .else
87	>8fc8	7c ed				                .word mos.osbyte10
88						                .endif

90						                ;Write next ADC channel to be sampled D.2-25
91						                .if version==400
93						                .else
94	>8fca	76 e7				                .word mos.osbyte11
95						                .endif

97						                ;Reset soft keys D.2-26
98	>8fcc	c8 f1				                .word mos.osbyte12

100						                ;Wait for vertical sync D.2-26
101	>8fce	9e f1				                .word mos.osbyte13

103						                ;Restore default font definitions D.2-26
104	>8fd0	ca f2				                .word osbyte14

106						                ;Flush selected buffer D.2-27
107	>8fd2	7c ea				                .word mos.osbyte15

109						                ;Increment ROM polling semaphore D.2-27
110	>8fd4	d6 f2				                .word mos.osbyte16

112						                ;Decrement ROM polling semaphore D.2-27
113	>8fd6	da f2				                .word mos.osbyte17

115						                ; Reserved
116	>8fd8	0a ee				                .word mos.osbyteUnused

118						                ;Restore a group of font definitions D.2-28
119	>8fda	d0 f2				                .word mos.osbyte19

121						                ; Not sure...
122						                .if version==350
124						                .elsif version>=400
125	>8fdc	ea f8				                .word mos.LF8EA
126						                .endif

128						                ; Not sure...
129						                .if version==350
131						                .elsif version>=400
132	>8fde	f0 f8				                .word mos.LF8F0
133						                .endif

135						                ;Write 1MHz bus selection status D.2-29
136	>8fe0	24 ef				                .word mos.osbyte6B

138						                ;Write usage of main/shadow memory D.2-30
139	>8fe2	28 ef				                .word mos.osbyte6C

141						                ;Make temporary Filing System permanent D.2-30
142	>8fe4	bd f2				                .word mos.osbyte6D

144						                ;Unused
145	>8fe6	0a ee				                .word mos.osbyteUnused

147						                ;Unused
148	>8fe8	0a ee				                .word mos.osbyteUnused

150						                ;Select main/shadow memory for VDU access D.2-31
151	>8fea	de ed				                .word mos.osbyte70

153						                ;Select main/shadow memory for display D.2-31
154	>8fec	ee ed				                .word mos.osbyte71

156						                ;Write usage of shadow memory D.2-31
157	>8fee	61 f1				                .word mos.osbyte72

159						                ;Unused
160	>8ff0	aa ff				                .word mos.rtsFFAA

162						                ;Unused
163	>8ff2	aa ff				                .word mos.rtsFFAA

165						                ;Read VDU status D.2-32
166	>8ff4	5c f0				                .word mos.osbyte75

168						                ;Reflect keyboard status in keyboard LEDs D.2-33
169	>8ff6	de f2				                .word mos.osbyte76

171						                ;Close all *SPOOL/*SPOOLON or *EXEC files D.2-33
172						                .if version==350
174						                .else
175	>8ff8	e0 ea				                .word mos.osbyte77
176						                .endif

178						                ;Write keys pressed information D.2-33
179	>8ffa	84 f7				                .word mos.osbyte78

181						                ;Keyboard scan D.2-33
182	>8ffc	7b f7				                .word mos.callKEYV

184						                ;Keyboard scan from 16 decimal
185	>8ffe	89 f7				                .word mos.osbyte7A

187						                ;Inform MOS of printer driver going dormant
188	>9000	5a ea				                .word mos.osbyte7B

190						                ;Clear escape condition
191	>9002	f4 ec				                .word mos.osbyte7C

193						                ;Set escape condition
194	>9004	f5 ec				                .word mos.osbyte7D

196						                ;Acknowledge escape condition
197	>9006	da ec				                .word mos.osbyte7E

199						                ;Check for end of file on an opened file
200	>9008	91 f2				                .word mos.osbyte7F

202						                ;Read ADC channel or get buffer status
203						                .if version==400
205						                .else
206	>900a	c5 ed				                .word mos.osbyte80
207						                .endif

209						                ;Read key with time limit
210	>900c	84 ed				                .word mos.osbyte81

212						                ;Read machine high order address
213	>900e	9b ed				                .word mos.osbyte82

215						                ;Read Operating System High Water Mark (OSHWM)
216	>9010	7e f7				                .word mos.osbyte83

218						                ;Read top of user RAM
219	>9012	68 f2				                .word mos.osbyte84

221						                ;Read top of user RAM for given mode
222	>9014	7e f2				                .word mos.osbyte85

224						                ;Read text cursor position
225	>9016	79 e2				                .word mos.osbyte86

227						                ;Read screen mode and character at text cursor position
228	>9018	8a f2				                .word mos.osbyte87

230						                ;Execute user code
231	>901a	d5 ec				                .word mos.osbyte88

233						                .if version<400
237						                .else
238	>901c	0a ee				                .word mos.osbyteUnused
239						                .endif

241						                ;Insert character code into buffer
242	>901e	6a eb				                .word mos.osbyte8A

244						                ;Write Filing System options
245	>9020	90 f2				                .word mos.osbyte8B

247						                .if version<400
249						                .else
250	>9022	0a ee				                .word mos.osbyteUnused
251						                .endif


254						                ;Select ROM Filing System
255	>9024	20 ee				                .word mos.osbyte8C8D

257						                ;Enter language ROM
258	>9026	e9 e4				                .word mos.osbyte8E

260						                ;Issue paged ROM service request
261	>9028	89 ee				                .word mos.osbyte8F

263						                ;Set vertical screen shift and interlace option
264	>902a	1f f4				                .word mos.osbyte90

266						                ;Get character from buffer
267	>902c	1f eb				                .word mos.osbyte91

269						                ;Read from FRED (&FC00 <80><93> &FCFF)
270	>902e	17 f7				                .word mos.osbyte92

272						                ;Write to FRED (&FC00 <80><93> &FCFF)
273	>9030	3a f4				                .word mos.osbyte93

275						                ;Read from JIM (&FD00 - &FDFF)
276	>9032	27 f7				                .word mos.osbyte94

278						                ;Write to JIM (&FD00 - &FDFF)
279	>9034	30 f4				                .word mos.osbyte95

281						                ;Read from SHEILA (&FE00 - &FEFF)
282	>9036	ab ff				                .word mos.osbyte96

284						                ;Write to SHEILA (&FE00 - &FEFF)
285	>9038	35 f4				                .word mos.osbyte97

287						                ;Examine buffer status
288	>903a	1a eb				                .word mos.osbyte98

290						                ;Insert character code into buffer checking for escape
291						                .if version==400
293						                .else
294	>903c	ab eb				                .word mos.osbyte99
295						                .endif

297						                ;Write video ULA control register
298	>903e	fd f2				                .word mos.osbyte9A

300						                ;Write to video ULA palette register and copy
301	>9040	0e f3				                .word mos.osbyte9B

303						                ;Read/write serial ACIA control register and copy
304						                .if version==400
306						                .else
307	>9042	3f ea				                .word mos.osbyte9C
308						                .endif

310						                ;Write byte across Tube
311	>9044	af ff				                .word mos.osbyte9D

313						                ;reserved for the speech system
314	>9046	0a ee				                .word mos.osbyteUnused

316						                ;reserved for the speech system
317	>9048	0a ee				                .word mos.osbyteUnused

319						                ;Read VDU variable value
320	>904a	a8 f1				                .word mos.osbyteA0

322						                ;Read CMOS RAM
323						                .if version==350
325						                .else
326	>904c	14 ee				                .word mos.osbyteA1
327						                .endif

329						                ;Write CMOS RAM
330						                .if version==350
332						                .else
333	>904e	1a ee				                .word mos.osbyteA2
334						                .endif

336						                ;reserved for applications software
337	>9050	0a ee				                .word mos.osbyteUnused

339						                ;Check processor type
340	>9052	60 e5				                .word mos.osbyteA4

342						                ;Read output cursor position
343	>9054	4d e2				                .word mos.osbyteA5

345						                ;handle osbyte A6-FF
346	>9056	84 f1				                .word mos.osbyteA6

348						                ;*LINE - not part of the above table???
349	>9058	d7 ec				                .word mos.callUSERV

351						;-------------------------------------------------------------------------
352						;
353						; OSWORD dispatch table. Must follow on from the OSBYTE table.
354						;
355						; entry:
356						;
357						; A = 0th byte of parameter block
358						;
359						; X = OSWORD X
360						;
361						; Y = 0
362						;
363						; ?originalA, ?originalX, ?originalY = OSWORD arguments
364						;
365						; C=1
366						;
367						; N/Z set as per X
368						;
369	.905a					oswordRoutineTable:

371						;Read line from input stream to memory
372	>905a	d8 f0				                .word mos.osword00

374						                ;Read system clock
375	>905c	ab f0				                .word mos.osword01

377						                ;Write system clock
378	>905e	be f0				                .word mos.osword02

380						                ;Read interval timer
381	>9060	a7 f0				                .word mos.osword03

383						                ;Write interval timer
384	>9062	ba f0				                .word mos.osword04

386						                ;Read byte from I/O processor memory
387	>9064	03 f0				                .word mos.osword05

389						                ;Write byte to I/O processor memory
390	>9066	37 ef				                .word mos.osword06

392						                ;Generate a sound
393	>9068	24 f0				                .word mos.osword07

395						                ;Define a sound envelope
396	>906a	85 f0				                .word mos.osword08

398						                ;Read pixel logical colour
399	>906c	fe f1				                .word mos.osword09

401						                ;Read a character definition
402	>906e	23 f2				                .word mos.osword0A

404						                ;Read the palette
405	>9070	ed f1				                .word mos.osword0B

407						                ;Write the palette
408	>9072	3b f2				                .word mos.osword0C

410						                ;Read current and previous graphics cursor positions
411	>9074	49 f2				                .word mos.osword0D

413						                ;Read CMOS clock
414	>9076	7b ef				                .word mos.osword0E

416						                ;Write CMOS clock
417						                .if version==350
419						                .else
420	>9078	96 f2				                .word mos.osword0F
421						                .endif

423						                .if version==350
425						                .elsif version>=400
426	>907a	f6 f8				                .word mos.osword10
427						                .endif

429						                .if version==350
431						                .elsif version>=400
432	>907c	fc f8				                .word mos.osword11
433						                .endif


:5	;******  Return to file: src/terminal.s65

937						                .endif

939						;-------------------------------------------------------------------------

941						                .if version>=500
942	.907e					L907E:
943	.907e	da		phx		                phx
944	.907f	5a		phy		                phy
945	.9080	20 ca 9e	jsr $9eca	                jsr L9ECA
946	.9083	7a		ply		                ply
947	.9084	fa		plx		                plx
948	.9085	60		rts		                rts
949						                .endif

951						;-------------------------------------------------------------------------

953						                .if version<500&&version!=350
1071						                .endif

1073						;-------------------------------------------------------------------------
1074						;
1075						; [MasRef G.5-8]
1076						;
1077	.9086					starPRINT:
1078	.9086	a9 c0		lda #$c0	                lda #$C0
1079	.9088	8d c2 df	sta $dfc2	                sta hazel.fsFlags
1080	.908b	80 12		bra $909f	                bra L8ED2

1082						;-------------------------------------------------------------------------

1084	.908d					starLIST:
1085	.908d	4e c2 df	lsr $dfc2	                lsr hazel.fsFlags
1086	.9090	9c c3 df	stz $dfc3	                stz hazel.lineNumberBCD+0
1087	.9093	9c c4 df	stz $dfc4	                stz hazel.lineNumberBCD+1
1088	.9096	80 04		bra $909c	                bra L8ECF

1090						;-------------------------------------------------------------------------

1092	.9098					starTYPE:
1093	.9098	38		sec		                sec
1094	.9099	6e c2 df	ror $dfc2	                ror hazel.fsFlags
1095	.909c					L8ECF:
1096	.909c	4e c2 df	lsr $dfc2	                lsr hazel.fsFlags
1097	.909f					L8ED2:
1098	.909f	9c c5 df	stz $dfc5	                stz hazel.lastCharPrinted
1099	.90a2	20 41 a9	jsr $a941	                jsr openFileForReading
1100	.90a5					L8ED8:
1101	.90a5	24 ff		bit $ff		                bit $FF
1102	.90a7	30 52		bmi $90fb	                bmi handleESCAPEWithFileOpen
1103	.90a9	20 d7 ff	jsr $ffd7	                jsr OSBGET
1104	.90ac	b0 2e		bcs $90dc	                bcs closeFile
1105	.90ae	2c c2 df	bit $dfc2	                bit hazel.fsFlags
1106	.90b1	70 05		bvs $90b8	                bvs L8EEB
1107	.90b3	48		pha		                pha
1108	.90b4	20 c3 93	jsr $93c3	                jsr printLineNumber
1109	.90b7	68		pla		                pla
1110	.90b8					L8EEB:
1111	.90b8	2c c2 df	bit $dfc2	                bit hazel.fsFlags
1112	.90bb	30 14		bmi $90d1	                bmi L8F04
1113	.90bd	c9 0d		cmp #$0d	                cmp #$0D
1114	.90bf	f0 20		beq $90e1	                beq L8F14
1115	.90c1	c9 0a		cmp #$0a	                cmp #$0A
1116	.90c3	f0 1c		beq $90e1	                beq L8F14
1117	.90c5	8d c5 df	sta $dfc5	                sta hazel.lastCharPrinted
1118	.90c8	c9 22		cmp #$22	                cmp #'"'
1119	.90ca	f0 05		beq $90d1	                beq L8F04
1120	.90cc	20 e2 97	jsr $97e2	                jsr printGSREADChar
1121	.90cf	80 03		bra $90d4	                bra L8F07

1123	.90d1					L8F04:
1124	.90d1	20 ee ff	jsr $ffee	                jsr OSWRCH
1125	.90d4					L8F07:
1126	.90d4	20 07 91	jsr $9107	                jsr bgetAndCheckForESCAPE
1127	.90d7	90 df		bcc $90b8	                bcc L8EEB
1128	.90d9					printNewLineThenCloseFile:
1129	.90d9	20 e7 ff	jsr $ffe7	                jsr OSNEWL
1130	.90dc					closeFile:
1131	.90dc	a9 00		lda #$00	                lda #$00
1132	.90de	4c ce ff	jmp $ffce	                jmp OSFIND

1134	.90e1					L8F14:
1135	.90e1	cd c5 df	cmp $dfc5	                cmp hazel.lastCharPrinted
1136	.90e4	f0 10		beq $90f6	                beq L8F29
1137	.90e6	48		pha		                pha
1138	.90e7	ad c5 df	lda $dfc5	                lda hazel.lastCharPrinted
1139	.90ea	c9 0d		cmp #$0d	                cmp #$0D
1140	.90ec	f0 13		beq $9101	                beq L8F34
1141	.90ee	c9 0a		cmp #$0a	                cmp #$0A
1142	.90f0	f0 0f		beq $9101	                beq L8F34
1143	.90f2	68		pla		                pla
1144	.90f3	8d c5 df	sta $dfc5	                sta hazel.lastCharPrinted
1145	.90f6					L8F29:
1146	.90f6	20 e7 ff	jsr $ffe7	                jsr OSNEWL
1147	.90f9	80 aa		bra $90a5	                bra L8ED8

1149						;-------------------------------------------------------------------------
1150						;
1151						; Tidily handle ESCAPE when a file is open during *DUMP or whatever.
1152						; Prints a new line, closes the file, then does an Escape error.
1153						;
1154						; entry:
1155						;
1156						; Y = file handle
1157						;
1158	.90fb					handleESCAPEWithFileOpen:
1159	.90fb	20 d9 90	jsr $90d9	                jsr printNewLineThenCloseFile
1160	.90fe	4c 60 ac	jmp $ac60	                jmp escapeError

1162						;-------------------------------------------------------------------------

1164	.9101					L8F34:
1165	.9101	68		pla		                pla
1166	.9102	9c c5 df	stz $dfc5	                stz hazel.lastCharPrinted
1167	.9105	80 cd		bra $90d4	                bra L8F07

1169						;-------------------------------------------------------------------------
1170						;
1171						; Does an OSBGET and handles ESCAPE.
1172						;
1173						; entry:
1174						;
1175						; Y = file handle
1176						;
1177						; exit:
1178						;
1179						; A = byte read
1180						; C=1 if EOF
1181						; (as per OSBGET)
1182						;
1183	.9107					bgetAndCheckForESCAPE:
1184	.9107	20 d7 ff	jsr $ffd7	                jsr OSBGET
1185	.910a	24 ff		bit $ff		                bit $FF
1186	.910c	30 ed		bmi $90fb	                bmi handleESCAPEWithFileOpen
1187	.910e	60		rts		                rts

1189						;-------------------------------------------------------------------------
1190						;
1191						; *DUMP [MasRef G.5-4]
1192						;
1193	.910f					starDUMP:
1194	.910f	86 f2		stx $f2		                stx stringInputBufferAddress+0
1195	.9111	84 f3		sty $f3		                sty stringInputBufferAddress+1
1196	.9113	a2 00		ldx #$00	                ldx #$00
1197	.9115	20 98 94	jsr $9498	                jsr clearOSFILEParameterBlockDWORD
1198	.9118	a2 04		ldx #$04	                ldx #$04
1199	.911a	20 98 94	jsr $9498	                jsr clearOSFILEParameterBlockDWORD
1200	.911d	a0 00		ldy #$00	                ldy #$00
1201	.911f	4e c6 df	lsr $dfc6	                lsr hazel.tempFSFlag
1202	.9122	20 1b f3	jsr $f31b	                jsr mos.gsinitForFilenameParsing
1203	.9125					L8F58:
1204	.9125	20 2d f3	jsr $f32d	                jsr mos.gsreadEntryPoint
1205	.9128	90 fb		bcc $9125	                bcc L8F58
1206	.912a	f0 1a		beq $9146	                beq L8F79
1207	.912c	a2 00		ldx #$00	                ldx #$00
1208	.912e	20 37 95	jsr $9537	                jsr parseHexAddressFromCommandLine

1210	.9131	a2 03		ldx #$03	                ldx #$03
1211	.9133					-
1212	.9133	bd ed 02	lda $02ed,x	                lda osfileParameterBlock+0,x
1213	.9136	9d f1 02	sta $02f1,x	                sta osfileParameterBlock+4,x
1214	.9139	ca		dex		                dex
1215	.913a	10 f7		bpl $9133	                bpl -

1217	.913c	20 ad f3	jsr $f3ad	                jsr mos.skipSpacesAndCheckForCRInStringInput
1218	.913f	f0 05		beq $9146	                beq L8F79
1219	.9141	a2 04		ldx #$04	                ldx #$04
1220	.9143	20 37 95	jsr $9537	                jsr parseHexAddressFromCommandLine
1221	.9146					L8F79:
1222	.9146	a4 f3		ldy $f3		                ldy stringInputBufferAddress+1
1223	.9148	a6 f2		ldx $f2		                ldx stringInputBufferAddress+0
1224	.914a	0e c6 df	asl $dfc6	                asl hazel.tempFSFlag
1225	.914d	20 41 a9	jsr $a941	                jsr openFileForReading

1227	.9150	a9 02		lda #$02	                lda #argsFileGetEXT
1228	.9152	20 3d 96	jsr $963d	                jsr callOSARGSWithBuffer

1230	.9155	a2 03		ldx #$03	                ldx #$03
1231	.9157					L8F8A:
1232	.9157	b5 a8		lda $a8,x	                lda osargsBuffer,x
1233	.9159	dd ed 02	cmp $02ed,x	                cmp osfileParameterBlock+0,x
1234	.915c	90 6a		bcc $91c8	                bcc L8FFB
1235	.915e	d0 03		bne $9163	                bne L8F96
1236	.9160	ca		dex		                dex
1237	.9161	10 f4		bpl $9157	                bpl L8F8A
1238	.9163					L8F96:
1239	.9163	a2 03		ldx #$03	                ldx #$03
1240	.9165					-
1241	.9165	bd ed 02	lda $02ed,x	                lda osfileParameterBlock+0,x
1242	.9168	95 a8		sta $a8,x	                sta osargsBuffer,x
1243	.916a	ca		dex		                dex
1244	.916b	10 f8		bpl $9165	                bpl -
1245	.916d	20 3b 96	jsr $963b	                jsr setFilePointerFromOSARGSBuffer
1246	.9170					L8FA3:
1247	.9170	a2 00		ldx #$00	                ldx #$00
1248	.9172	20 d7 ff	jsr $ffd7	                jsr OSBGET
1249	.9175	b0 46		bcs $91bd	                bcs L8FF0
1250	.9177	20 11 94	jsr $9411	                jsr L9239
1251	.917a	48		pha		                pha
1252	.917b	ad f1 02	lda $02f1	                lda osfileParameterBlock+4
1253	.917e	29 07		and #$07	                and #$07
1254	.9180	f0 15		beq $9197	                beq L8FCA
1255	.9182	5a		phy		                phy
1256	.9183	a8		tay		                tay
1257	.9184					L8FB7:
1258	.9184	5a		phy		                phy
1259	.9185	20 27 ad	jsr $ad27	                jsr alwaysPrintFollowingMessage
1260	>9188	20 20 20 00			                .text "   ",0
1261	.918c	7a		ply		                ply
1262	.918d	a9 20		lda #$20	                lda #$20
1263	.918f	9d f5 02	sta $02f5,x	                sta osfileParameterBlock+8,x
1264	.9192	e8		inx		                inx
1265	.9193	88		dey		                dey
1266	.9194	d0 ee		bne $9184	                bne L8FB7
1267	.9196	7a		ply		                ply
1268	.9197					L8FCA:
1269	.9197	68		pla		                pla
1270	.9198					L8FCB:
1271	.9198	48		pha		                pha
1272	.9199	c9 20		cmp #$20	                cmp #32
1273	.919b	90 04		bcc $91a1	                bcc nonPrintable
1274	.919d	c9 7f		cmp #$7f	                cmp #127
1275	.919f	90 02		bcc $91a3	                bcc L8FD6                    ;taken if printable
1276	.91a1					nonPrintable:
1277	.91a1	a9 2e		lda #$2e	                lda #'.'          ;placeholder for non-printable chars
1278	.91a3					L8FD6:
1279	.91a3	9d f5 02	sta $02f5,x	                sta osfileParameterBlock+8,x
1280	.91a6	68		pla		                pla
1281	.91a7	20 34 ac	jsr $ac34	                jsr printSpaceThenPrintHexByte
1282	.91aa	e8		inx		                inx
1283	.91ab	20 20 94	jsr $9420	                jsr L9248
1284	.91ae	ad f1 02	lda $02f1	                lda osfileParameterBlock+4
1285	.91b1	29 07		and #$07	                and #$07
1286	.91b3	f0 0b		beq $91c0	                beq L8FF3
1287	.91b5	20 07 91	jsr $9107	                jsr bgetAndCheckForESCAPE
1288	.91b8	90 de		bcc $9198	                bcc L8FCB
1289	.91ba	20 2f 94	jsr $942f	                jsr L9257
1290	.91bd					L8FF0:
1291	.91bd	4c dc 90	jmp $90dc	                jmp closeFile

1293	.91c0					L8FF3:
1294	.91c0	20 2f 94	jsr $942f	                jsr L9257
1295	.91c3	80 ab		bra $9170	                bra L8FA3

1297	.91c5					L8FF8:
1298	.91c5	4c 49 a9	jmp $a949	                jmp notFoundError

1300	.91c8					L8FFB:
1301	.91c8	20 dc 90	jsr $90dc	                jsr closeFile
1302	.91cb	20 8c ae	jsr $ae8c	                jsr doFollowingError
1303	>91ce	b7 4f 75 74 73 69 64 65		                .text $b7,"Outside file",0
	>91d6	20 66 69 6c 65 00

1305						;-------------------------------------------------------------------------
1306						;
1307						; *BUILD
1308						;
1309	.91dc					starBUILD:
1310	.91dc	4e c2 df	lsr $dfc2	                lsr hazel.fsFlags            ;clear bit 7 of fsFlags
1311	.91df	80 04		bra $91e5	                bra starBUILDOrAPPEND

1313						;-------------------------------------------------------------------------
1314						;
1315						; *APPEND
1316						;
1317	.91e1					starAPPEND:
1318	.91e1	38		sec		                sec
1319	.91e2	6e c2 df	ror $dfc2	                ror hazel.fsFlags            ;set bit 7 of fsFlags
1320	.91e5					starBUILDOrAPPEND:
1321						                ; bit 7 of fsFlags indicates *BUILD (clear) or *APPEND
1322						                ; (set).
1323	.91e5	9c c3 df	stz $dfc3	                stz hazel.lineNumberBCD+0    ;reset line number
1324	.91e8	9c c4 df	stz $dfc4	                stz hazel.lineNumberBCD+1    ;reset line number
1325	.91eb	a9 80		lda #$80	                lda #$80                     ;open for output. Assume *BUILD
1326	.91ed	2c c2 df	bit $dfc2	                bit hazel.fsFlags            ;test *BUILD/*APPEND
1327	.91f0	10 02		bpl $91f4	                bpl +                        ;branch taken if *BUILD
1328	.91f2	a9 c0		lda #$c0	                lda #$C0                     ;*APPEND, so open for update
1329	.91f4					+
1330	.91f4	20 ce ff	jsr $ffce	                jsr OSFIND                   ;open the file
1331	.91f7	a8		tay		                tay                          ;Y=file handle
1332	.91f8	f0 cb		beq $91c5	                beq L8FF8                    ;branch taken if open failed
1333	.91fa	8c ed 02	sty $02ed	                sty osfileParameterBlock+0   ;save file handle
1334	.91fd	20 36 96	jsr $9636	                jsr setPTRToEOF ;move to EOF (effective no-op when *BUILD)
1335	.9200					L9033:
1336	.9200	20 c3 93	jsr $93c3	                jsr printLineNumber
1337	.9203					L9036:
1338						                .if version<500&&version!=350
1340						                .else
1341	.9203	a9 00		lda #$00	                lda #0
1342	.9205	a2 89		ldx #$89	                ldx #<starBuildOrAPPENDOSWORD0Parameters
1343	.9207	a0 92		ldy #$92	                ldy #>starBuildOrAPPENDOSWORD0Parameters
1344	.9209	20 f1 ff	jsr $fff1	                jsr OSWORD
1345						                .endif
1346	.920c	08		php		                php
1347	.920d	90 0f		bcc $921e	                bcc L904B
1348						                ; Handle ESCAPE
1349	.920f	20 e7 ff	jsr $ffe7	                jsr OSNEWL
1350	.9212	a9 0d		lda #$0d	                lda #$0D
1351	.9214	99 00 dc	sta $dc00,y	                sta hazel.commandLine,y      ;terminate current line
1352	.9217					L9044:
1353	.9217	5a		phy		                phy                          ;save line length
1354	.9218	a9 7e		lda #$7e	                lda #$7E
1355	.921a	20 f4 ff	jsr $fff4	                jsr OSBYTE                   ;acknowledge ESCAPE
1356	.921d	7a		ply		                ply                          ;restore line length
1357	.921e					L904B:
1358	.921e	98		tya		                tya                          ;A=line length
1359	.921f	f0 50		beq $9271	                beq L909E                    ;taken if line empty
1360	.9221	20 7e 92	jsr $927e	                jsr setStringInputBufferToCommandLine
1361	.9224	a0 00		ldy #$00	                ldy #$00
1362	.9226	a2 00		ldx #$00	                ldx #$00
1363	.9228					L9055:
1364	.9228	20 4a f3	jsr $f34a	                jsr mos.LF29C
1365	.922b	9d 00 dc	sta $dc00,x	                sta hazel.commandLine,x
1366	.922e	a9 01		lda #$01	                lda #stringInputOptions.goodString
1367	.9230	24 e4		bit $e4		                bit stringInputOptions
1368	.9232	d0 0b		bne $923f	                bne L906C
1369	.9234	a9 07		lda #$07	                lda #7
1370	.9236	20 ee ff	jsr $ffee	                jsr OSWRCH                   ;beep
1371	.9239	20 cd 93	jsr $93cd	                jsr L91F5
1372	.923c	28		plp		                plp
1373	.923d	80 c4		bra $9203	                bra L9036

1375	.923f					L906C:
1376	.923f	e8		inx		                inx
1377	.9240	90 e6		bcc $9228	                bcc L9055
1378	.9242	28		plp		                plp
1379	.9243	90 01		bcc $9246	                bcc L9073
1380	.9245	ca		dex		                dex
1381	.9246					L9073:
1382	.9246	08		php		                php
1383	.9247	da		phx		                phx
1384	.9248	a2 0b		ldx #$0b	                ldx #size(OSGBPBParameterBlock)-2
1385	.924a					L9077:
1386	.924a	9e ee 02	stz $02ee,x	                stz osfileParameterBlock+1,x
1387	.924d	ca		dex		                dex
1388	.924e	10 fa		bpl $924a	                bpl L9077
1389	.9250	fa		plx		                plx
1390	.9251	8e f2 02	stx $02f2	                stx osfileParameterBlock+OSGBPBParameterBlock.count+0
1391						                .cerror (<hazel.commandLine)!=0,"hazel.commandLine must be page aligned"
1392	.9254	a9 dc		lda #$dc	                lda #>hazel.commandLine
1393	.9256	8d ef 02	sta $02ef	                sta osfileParameterBlock+OSGBPBParameterBlock.address+1
1394	.9259	ce f0 02	dec $02f0	                dec osfileParameterBlock+OSGBPBParameterBlock.address+2
1395	.925c	ce f1 02	dec $02f1	                dec osfileParameterBlock+OSGBPBParameterBlock.address+3
1396	.925f	a9 02		lda #$02	                lda #gbppPutBytesCurrentPTR
1397	.9261	a2 ed		ldx #$ed	                ldx #<osfileParameterBlock
1398	.9263	a0 02		ldy #$02	                ldy #>osfileParameterBlock
1399	.9265	20 d1 ff	jsr $ffd1	                jsr OSGBPB
1400	.9268	28		plp		                plp
1401	.9269	90 95		bcc $9200	                bcc L9033
1402	.926b					L9098:
1403	.926b	ac ed 02	ldy $02ed	                ldy osfileParameterBlock+0
1404	.926e	4c dc 90	jmp $90dc	                jmp closeFile

1406	.9271					L909E:
1407	.9271	28		plp		                plp
1408	.9272	b0 f7		bcs $926b	                bcs L9098
1409	.9274	a9 0d		lda #$0d	                lda #13
1410	.9276	ac ed 02	ldy $02ed	                ldy osfileParameterBlock
1411	.9279	20 d4 ff	jsr $ffd4	                jsr OSBPUT
1412	.927c	80 82		bra $9200	                bra L9033

1414	.927e					setStringInputBufferToCommandLine:
1415	.927e	a9 41		lda #$41	                lda #$41
1416	.9280	85 e4		sta $e4		                sta $E4
1417						                .cerror (<hazel.commandLine)!=0,"hazel.commandLine must be page aligned"
1418	.9282	64 f2		stz $f2		                stz stringInputBufferAddress+0
1419	.9284	a9 dc		lda #$dc	                lda #>hazel.commandLine
1420	.9286	85 f3		sta $f3		                sta stringInputBufferAddress+1
1421	.9288	60		rts		                rts

1423						;-------------------------------------------------------------------------

1425						                .if version>=500||version==350
1426	.9289					starBuildOrAPPENDOSWORD0Parameters:
1427	>9289	00 dc				                .word hazel.commandLine      ;address
1428	>928b	f0				                .byte $f0                    ;max # chars
1429	>928c	00				                .byte 0                      ;min char
1430	>928d	ff				                .byte 255                    ;max char
1431						                .endif

1433						;-------------------------------------------------------------------------
1434						;
1435						; *MOVE
1436						;
1437	.928e					starMOVE:
1438	.928e	ad 34 fe	lda $fe34	                lda ACCCON                    ; Save ACCCON
1439	.9291	8d dc df	sta $dfdc	                sta hazel.oldACCCON
1440	.9294	48		pha		                pha                          ; Save ACCCON and command line pointer
1441	.9295	da		phx		                phx
1442	.9296	5a		phy		                phy
1443	.9297	a0 80		ldy #$80	                ldy #$80                     ; Top of available shadow memory at &8000
1444	.9299	a5 d0		lda $d0		                lda STATE                      ; Get VDU status
1445	.929b	89 10		bit #$10	                bit #$10                     ; Jump if not shadow screen, spare up to &8000
1446	.929d	f0 07		beq $92a6	                beq L90CE
1447						; Shadow screen selected
1448	.929f	20 6e f2	jsr $f26e	                jsr mos.LF1C0                ; Get screen bottom to XY
1449	.92a2	c0 30		cpy #$30	                cpy #$30                     ; Screen at &3000, no spare memory, jump to use Hazel
1450	.92a4	f0 14		beq $92ba	                beq L90E2

1452						; Non-shadow or small shadow screen selected
1453						; Y=top of available memory in shadow memory
1454	.92a6					L90CE:
1455	.92a6	a9 30		lda #$30	                lda #$30                     ; &3000=start of shadow memory
1456	.92a8	8d d6 df	sta $dfd6	                sta hazel.moveBufferMSB
1457	.92ab	a9 04		lda #$04	                lda #ACCCON.X
1458	.92ad	0c 34 fe	tsb $fe34	                tsb ACCCON
1459	.92b0	8d dd df	sta $dfdd	                sta hazel.hasACCCONChanged      ; set 'ACCCON changed'
1460	.92b3	98		tya		                tya                          ; A=length of space in shadow memory
1461	.92b4	38		sec		                sec
1462	.92b5	ed d6 df	sbc $dfd6	                sbc hazel.moveBufferMSB
1463	.92b8	80 07		bra $92c1	                bra L90E9

1465						; No shadow memory available, use Hazel
1466	.92ba					L90E2:
1467	.92ba	a9 dd		lda #$dd	                lda #$DD                     ; Buffer at &DD00
1468	.92bc	8d d6 df	sta $dfd6	                sta hazel.moveBufferMSB
1469	.92bf	a9 02		lda #$02	                lda #$02                     ; Buffer length=&200

1471						; &DFD6=high byte of buffer address
1472						; A=high byte of buffer length
1473	.92c1					L90E9:
1474	.92c1	8d d7 df	sta $dfd7	                sta hazel.moveNumPages      ; Store buffer length
1475	.92c4	7a		ply		                ply                          ; Get command line pointer
1476	.92c5	fa		plx		                plx
1477	.92c6	da		phx		                phx
1478	.92c7	5a		phy		                phy
1479	.92c8	a9 40		lda #$40	                lda #$40                     ; Open source file
1480	.92ca	20 ce ff	jsr $ffce	                jsr OSFIND
1481	.92cd	a8		tay		                tay                          ; Store source handle, jump if not found
1482	.92ce	8c d4 df	sty $dfd4	                sty hazel.moveSrcHandle
1483	.92d1	f0 39		beq $930c	                beq L9134
1484	.92d3	7a		ply		                ply                          ; Get command line back again
1485	.92d4	fa		plx		                plx
1486	.92d5	86 f2		stx $f2		                stx $F2
1487	.92d7	84 f3		sty $f3		                sty $F3
1488	.92d9	da		phx		                phx                          ; And save it again
1489	.92da	5a		phy		                phy
1490	.92db	a0 00		ldy #$00	                ldy #$00                     ; Step past first parameter
1491	.92dd	20 1b f3	jsr $f31b	                jsr mos.gsinitForFilenameParsing
1492	.92e0					L9108:
1493	.92e0	20 2d f3	jsr $f32d	                jsr mos.gsreadEntryPoint     ;
1494	.92e3	90 fb		bcc $92e0	                bcc L9108
1495	.92e5	98		tya		                tya                          ; Save address of dest filename
1496	.92e6	18		clc		                clc
1497	.92e7	65 f2		adc $f2		                adc $F2
1498	.92e9	8d d8 df	sta $dfd8	                sta hazel.moveDestName+0
1499	.92ec	aa		tax		                tax
1500	.92ed	a5 f3		lda $f3		                lda $F3
1501	.92ef	69 00		adc #$00	                adc #$00
1502	.92f1	8d d9 df	sta $dfd9	                sta hazel.moveDestName+1
1503	.92f4	a8		tay		                tay                          ; Temporary filing system flag
1504	.92f5	0e c6 df	asl $dfc6	                asl hazel.tempFSFlag
1505	.92f8	a9 80		lda #$80	                lda #$80                     ; Open destination file
1506	.92fa	20 ce ff	jsr $ffce	                jsr OSFIND
1507	.92fd	a8		tay		                tay                          ; Store dest handle, jump if opened
1508	.92fe	8c d5 df	sty $dfd5	                sty hazel.moveDestHandle
1509	.9301	d0 0c		bne $930f	                bne L9137

1511						; Couldn't open destination
1512	.9303	ac d4 df	ldy $dfd4	                ldy hazel.moveSrcHandle      ; Get source handle and clear it
1513	.9306	9c d4 df	stz $dfd4	                stz hazel.moveSrcHandle
1514	.9309	20 ce ff	jsr $ffce	                jsr OSFIND                   ; Close source file
1515	.930c					L9134:
1516	.930c	4c 49 a9	jmp $a949	                jmp notFoundError                    ; Jump to 'Not found' error

1518						; Source and dest opened
1519						; ----------------------
1520						; Build OSGBPB source file control block at &02ED
1521						; and destination control block at &DFC7
1522	.930f					L9137:
1523	.930f	a2 07		ldx #$07	                ldx #$07
1524	.9311					L9139:
1525	.9311	9e ee 02	stz $02ee,x	                stz @w osfileParameterBlock+OSGBPBParameterBlock.address,x ; Addr=0, Num=0
1526	.9314	9e c8 df	stz $dfc8,x	                stz hazel.moveOSGBPB+1,x
1527	.9317	ca		dex		                dex
1528	.9318	10 f7		bpl $9311	                bpl L9139
1529	.931a	ad d4 df	lda $dfd4	                lda hazel.moveSrcHandle      ; Source handle
1530	.931d	8d ed 02	sta $02ed	                sta osfileParameterBlock+OSGBPBParameterBlock.handle
1531	.9320	ad d6 df	lda $dfd6	                lda hazel.moveBufferMSB      ; Buffer address
1532	.9323	8d ef 02	sta $02ef	                sta osfileParameterBlock+OSGBPBParameterBlock.address+1
1533	.9326	8d c9 df	sta $dfc9	                sta hazel.moveOSGBPB.addr+1
1534	.9329	ad d7 df	lda $dfd7	                lda hazel.moveNumPages
1535	.932c	8d f3 02	sta $02f3	                sta osfileParameterBlock+OSGBPBParameterBlock.count+1
1536	.932f	8d cd df	sta $dfcd	                sta hazel.moveOSGBPB.numBytes+1
1537	.9332	ce f0 02	dec $02f0	                dec osfileParameterBlock+OSGBPBParameterBlock.address+2 ; Source addr=&FFFFxxxx
1538	.9335	ce f1 02	dec $02f1	                dec osfileParameterBlock+OSGBPBParameterBlock.address+3
1539	.9338	ce ca df	dec $dfca	                dec hazel.moveOSGBPB.addr+2
1540	.933b	ce cb df	dec $dfcb	                dec hazel.moveOSGBPB.addr+3

1542						; Should use &FFFExxxx and let filing system select correct memory
1543						; Unfortunately, CFS/RFS and DFS do not recognise &FFFExxxx, so
1544						; *MOVE has to do it itself, causing problems for filing systems
1545						; that /do/ recognise &FFFExxxx where they have to remember to
1546						; *do* *nothing* for &FFFFxxxx instead of select main memory as
1547						; &FFFFxxxx implies.

1549	.933e	a2 ed		ldx #$ed	                ldx #<osfileParameterBlock                     ; XY=>source OSGBPB block
1550	.9340	a0 02		ldy #$02	                ldy #>osfileParameterBlock
1551	.9342	a9 04		lda #$04	                lda #$04                     ; Read data from source
1552	.9344	20 d1 ff	jsr $ffd1	                jsr OSGBPB
1553	.9347	08		php		                php                          ; Jump if not at end of file
1554	.9348	90 11		bcc $935b	                bcc L9183
1555						; End of file, adjust destination buffer length for final part
1556	.934a	a9 00		lda #$00	                lda #$00
1557	.934c	ed f2 02	sbc $02f2	                sbc osfileParameterBlock+OSGBPBParameterBlock.count+0
1558	.934f	8d cc df	sta $dfcc	                sta hazel.moveOSGBPB.numBytes+0
1559	.9352	ad cd df	lda $dfcd	                lda hazel.moveOSGBPB.numBytes+1
1560	.9355	ed f3 02	sbc $02f3	                sbc osfileParameterBlock+OSGBPBParameterBlock.count+1
1561	.9358	8d cd df	sta $dfcd	                sta hazel.moveOSGBPB.numBytes+1
1562	.935b					L9183:
1563	.935b	ad d5 df	lda $dfd5	                lda hazel.moveDestHandle      ; Destination handle
1564	.935e	8d c7 df	sta $dfc7	                sta hazel.moveOSGBPB.handle
1565	.9361	a9 02		lda #$02	                lda #$02                     ; XY=>control block, A=write
1566	.9363	a2 c7		ldx #$c7	                ldx #<hazel.moveOSGBPB
1567	.9365	a0 df		ldy #$df	                ldy #>hazel.moveOSGBPB
1568	.9367	20 d1 ff	jsr $ffd1	                jsr OSGBPB
1569	.936a	28		plp		                plp                          ; Loop until end of file
1570	.936b	90 a2		bcc $930f	                bcc L9137
1571	.936d	a9 00		lda #$00	                lda #$00
1572	.936f	ac d4 df	ldy $dfd4	                ldy hazel.moveSrcHandle      ; Get and clear source handle
1573	.9372	9c d4 df	stz $dfd4	                stz hazel.moveSrcHandle
1574	.9375	5a		phy		                phy                          ; Close source file
1575	.9376	20 ce ff	jsr $ffce	                jsr OSFIND
1576	.9379	a9 00		lda #$00	                lda #$00                     ; Get dest handle
1577	.937b	ac d5 df	ldy $dfd5	                ldy hazel.moveDestHandle
1578	.937e	5a		phy		                phy                          ; Clear dest handle and close file
1579	.937f	9c d5 df	stz $dfd5	                stz hazel.moveDestHandle
1580	.9382	20 ce ff	jsr $ffce	                jsr OSFIND
1581	.9385	7a		ply		                ply                          ; Dest not CFS/RFS, jump to...
1582	.9386	c0 04		cpy #$04	                cpy #$04
1583	.9388	b0 0b		bcs $9395	                bcs L91BD
1584	.938a	7a		ply		                ply                          ; Pop source handle
1585	.938b					L91B3:
1586	.938b	7a		ply		                ply                          ; Restore XY
1587	.938c	fa		plx		                plx
1588	.938d					L91B5:
1589	.938d	68		pla		                pla                          ; Clear 'ACCCON changed', restore ACCCON
1590	.938e	9c dd df	stz $dfdd	                stz hazel.hasACCCONChanged
1591	.9391	8d 34 fe	sta $fe34	                sta ACCCON
1592	.9394	60		rts		                rts

1594	.9395					L91BD:
1595	.9395	7a		ply		                ply                          ; Source was CFS/RFS, jump to exit
1596	.9396	c0 04		cpy #$04	                cpy #$04
1597	.9398	90 f1		bcc $938b	                bcc L91B3
1598	.939a	7a		ply		                ply                          ; Point to first parameter
1599	.939b	8c ee 02	sty $02ee	                sty osfileParameterBlock+OSFILEParameterBlock.fileName+1
1600	.939e	fa		plx		                plx
1601	.939f	8e ed 02	stx $02ed	                stx osfileParameterBlock+OSFILEParameterBlock.fileName+0
1602	.93a2	a2 ed		ldx #$ed	                ldx #<osfileParameterBlock
1603	.93a4	a0 02		ldy #$02	                ldy #>osfileParameterBlock
1604	.93a6	a9 05		lda #$05	                lda #$05                     ; Read info on source file
1605	.93a8	20 dd ff	jsr $ffdd	                jsr OSFILE
1606	.93ab	ad d8 df	lda $dfd8	                lda hazel.moveDestName+0      ; Get address of dest filename
1607	.93ae	8d ed 02	sta $02ed	                sta osfileParameterBlock+OSFILEParameterBlock.fileName+0
1608	.93b1	ad d9 df	lda $dfd9	                lda hazel.moveDestName+1      ;  and put in control block
1609	.93b4	8d ee 02	sta $02ee	                sta osfileParameterBlock+OSFILEParameterBlock.fileName+1
1610	.93b7	a9 f0		lda #$f0	                lda #$F0                     ; Mask out 'public' access bits
1611	.93b9	1c fb 02	trb $02fb	                trb osfileParameterBlock+OSFILEParameterBlock.attributes+0
1612	.93bc	a9 01		lda #$01	                lda #$01                     ; Write info on dest file
1613	.93be	20 dd ff	jsr $ffdd	                jsr OSFILE
1614	.93c1	80 ca		bra $938d	                bra L91B5                    ; Jump to restore ACCCON and exit

1616	.93c3					printLineNumber:
1617	.93c3	a2 00		ldx #$00	                ldx #$00
1618	.93c5	38		sec		                sec
1619	.93c6	20 06 94	jsr $9406	                jsr adcLineNumberBCDX        ;increment line number LSB
1620	.93c9	e8		inx		                inx
1621	.93ca	20 06 94	jsr $9406	                jsr adcLineNumberBCDX        ;carry into line number MSB
1622	.93cd					L91F5:
1623	.93cd	38		sec		                sec                          ;printing leading 0s
1624	.93ce	ad c4 df	lda $dfc4	                lda hazel.lineNumberBCD+1    ;get line number MSB
1625	.93d1	20 e9 93	jsr $93e9	                jsr printPossiblyLeading0s
1626	.93d4	ad c3 df	lda $dfc3	                lda hazel.lineNumberBCD+0    ;get line number LSB
1627	.93d7	48		pha		                pha                          ;save line number LSB
1628	.93d8	08		php		                php                          ;save C
1629						                .if version==350
1631						                .else
1632	.93d9	4a		lsr a		                lsr a
1633	.93da	4a		lsr a		                lsr a
1634	.93db	4a		lsr a		                lsr a
1635	.93dc	4a		lsr a		                lsr a
1636						                .endif
1637	.93dd	28		plp		                plp                          ;restore  C
1638	.93de	20 f4 93	jsr $93f4	                jsr printPossiblyLeading0    ;print line number 3rd digit
1639	.93e1	68		pla		                pla                          ;restore line number LSB
1640	.93e2	18		clc		                clc                ;always print line number 4th digit
1641	.93e3	20 f4 93	jsr $93f4	                jsr printPossiblyLeading0    ;
1642	.93e6	4c 80 a3	jmp $a380	                jmp printSpace                    ;

1644	.93e9					printPossiblyLeading0s:
1645	.93e9	48		pha		                pha                          ;save value
1646	.93ea	08		php		                php                          ;save C
1647						                .if version==350
1649						                .else
1650	.93eb	4a		lsr a		                lsr a
1651	.93ec	4a		lsr a		                lsr a
1652	.93ed	4a		lsr a		                lsr a
1653	.93ee	4a		lsr a		                lsr a
1654						                .endif
1655	.93ef	28		plp		                plp                          ;restore C
1656	.93f0	20 f4 93	jsr $93f4	                jsr printPossiblyLeading0    ;print 1st digit
1657	.93f3	68		pla		                pla                          ;restore value
1658	.93f4					printPossiblyLeading0:
1659	.93f4	29 0f		and #$0f	                and #$0F                     ;get digit to print
1660	.93f6	d0 09		bne $9401	                bne printNonLeading0         ;always print if non-0
1661	.93f8	90 07		bcc $9401	                bcc printNonLeading0 ;branch taken if not leading 0
1662	.93fa	a9 20		lda #$20	                lda #$20             ;print space instead of leading 0
1663	.93fc	20 ee ff	jsr $ffee	                jsr OSWRCH
1664	.93ff	38		sec		                sec                ;indicate still in leading 0s state
1665	.9400	60		rts		                rts

1667	.9401					printNonLeading0:
1668	.9401	20 42 ac	jsr $ac42	                jsr printHexDigit            ;print digit
1669	.9404	18		clc		                clc                          ;no longer in leading 0s state
1670	.9405	60		rts		                rts                          ;

1672	.9406					adcLineNumberBCDX:
1673	.9406	a9 00		lda #$00	                lda #$00
1674	.9408	f8		sed		                sed
1675	.9409	7d c3 df	adc $dfc3,x	                adc hazel.lineNumberBCD,x
1676	.940c	9d c3 df	sta $dfc3,x	                sta hazel.lineNumberBCD,x
1677	.940f	d8		cld		                cld
1678	.9410					rts9238:
1679	.9410	60		rts		                rts

1681						;-------------------------------------------------------------------------

1683	.9411					L9239:
1684	.9411	da		phx		                phx
1685	.9412	48		pha		                pha
1686	.9413	a2 02		ldx #$02	                ldx #$02
1687	.9415					L923D:
1688	.9415	bd f1 02	lda $02f1,x	                lda osfileParameterBlock+4,x
1689	.9418	20 39 ac	jsr $ac39	                jsr printHexByte
1690	.941b	ca		dex		                dex
1691	.941c	10 f7		bpl $9415	                bpl L923D
1692	.941e	80 0c		bra $942c	                bra L9254

1694						;-------------------------------------------------------------------------

1696	.9420					L9248:
1697	.9420	da		phx		                phx
1698	.9421	48		pha		                pha
1699	.9422	a2 fc		ldx #$fc	                ldx #256-4
1700	.9424					L924C:
1701	.9424	fe f5 01	inc $01f5,x	                inc osfileParameterBlock+4-(256-4),x
1702	.9427	d0 03		bne $942c	                bne L9254
1703	.9429	e8		inx		                inx
1704	.942a	d0 f8		bne $9424	                bne L924C
1705	.942c					L9254:
1706	.942c	68		pla		                pla
1707	.942d	fa		plx		                plx
1708	.942e	60		rts		                rts

1710	.942f					L9257:
1711	.942f	5a		phy		                phy
1712	.9430	da		phx		                phx
1713	.9431					L9259:
1714	.9431	e0 08		cpx #$08	                cpx #$08
1715	.9433	f0 0a		beq $943f	                beq L9267
1716	.9435	20 27 ad	jsr $ad27	                jsr alwaysPrintFollowingMessage
1717	>9438	20 20 20 00			                .text "   ",0
1718	.943c	e8		inx		                inx
1719	.943d	80 f2		bra $9431	                bra L9259

1721	.943f					L9267:
1722	.943f	fa		plx		                plx
1723	.9440	20 80 a3	jsr $a380	                jsr printSpace
1724	.9443	a0 00		ldy #$00	                ldy #$00
1725	.9445					L926D:
1726	.9445	b9 f5 02	lda $02f5,y	                lda osfileParameterBlock+8,y
1727	.9448	20 ee ff	jsr $ffee	                jsr OSWRCH
1728	.944b	c8		iny		                iny
1729	.944c	ca		dex		                dex
1730	.944d	d0 f6		bne $9445	                bne L926D
1731	.944f	7a		ply		                ply
1732	.9450	4c e7 ff	jmp $ffe7	                jmp OSNEWL

1734						;-------------------------------------------------------------------------

1736						                .if version!=350
1737						                .include "restore_font.s65"

:10	;******  Processing file: src/restore_font.s65

1						;-------------------------------------------------------------------------
2						;
3						; restore entire font.
4						;
5	.9453					restoreFont32To255:
6	.9453	a2 07		ldx #$07	                ldx #$07                     ;224 chars - 32-255
7						                .cerror *!=restoreFont32ToN
8						                ; fall through to restoreFont32ToN

10						;-------------------------------------------------------------------------
11						;
12						; Restore part of the font, starting from char 32.
13						;
14						; entry:
15						;
16						; X = number of pages of font data to restore - X*32 chars will be
17						; restored
18						;
19	.9455					restoreFont32ToN:
20	.9455	08		php		                php
21	.9456	78		sei		                sei
22	.9457	a9 b9		lda #$b9	                lda #>LB900                ;start at beginning of font
23	.9459	85 f1		sta $f1		                sta $F1
24	.945b	a9 89		lda #$89	                lda #>andy.softCharacterDefinitions ;write to beginning of soft character definitions
25						                .cerror *!=restoreFontPart
26						                ; fall through to restoreFontPart

28						;-------------------------------------------------------------------------
29						;
30						; Restore part of the font.
31						;
32						; entry:
33						;
34						; ?$f1 = MSB of font data
35						;
36						; A = MSB of dest page in ANDY - should be part of the soft character
37						; definitions!
38						;
39						; X = number of pages of font data to restore - X*32 chars will be
40						; restored
41						;
42						; preserves: Y

44	.945d					restoreFontPart:
45	.945d	85 fb		sta $fb		                sta $FB                      ;save MSB of dest
46	.945f	20 b1 e5	jsr $e5b1	                jsr mos.selectTerminalROMAndANDY2
47	.9462	5a		phy		                phy                          ;
48	.9463	a0 00		ldy #$00	                ldy #$00                     ;
49	.9465	64 fa		stz $fa		                stz $FA                      ;initialize LSB of src
50	.9467	64 f0		stz $f0		                stz $F0                      ;initialize LSB of dest
51	.9469					-
52	.9469	b1 f0		lda ($f0),y	                lda ($F0),y
53	.946b	91 fa		sta ($fa),y	                sta ($FA),y
54	.946d	c8		iny		                iny
55	.946e	d0 f9		bne $9469	                bne -
56	.9470	e6 f1		inc $f1		                inc $F1
57	.9472	e6 fb		inc $fb		                inc $FB
58	.9474	ca		dex		                dex
59	.9475	d0 f2		bne $9469	                bne -
60	.9477	7a		ply		                ply
61	.9478	28		plp		                plp
62	.9479	4c a9 e5	jmp $e5a9	                jmp mos.selectTerminalROM

64						;-------------------------------------------------------------------------

66						                .if version==350
68						                .endif
69	.947c					restoreFont32To126:
70	.947c	a2 03		ldx #$03	                ldx #$03                     ;96 chars - 32-126
71	.947e	80 d5		bra $9455	                bra restoreFont32ToN

73						;-------------------------------------------------------------------------
74						;
75						; OSBYTE 25 (&19) Restore a group of font definitions
76						;
77						; MasRef D.2-28
78						;
79	.9480					osbyte19:
80	.9480	8a		txa		                txa                          ;A=group identifier
81	.9481	f0 d0		beq $9453	                beq restoreFont32To255   ;taken if group 0 - all chars
82						                .if version<500
89						                .elsif version>=500
90	.9483	c9 10		cmp #$10	                cmp #$10
91	.9485	b0 1d		bcs $94a4	                bcs rts94A4
92	.9487	29 07		and #$07	                and #7
93	.9489	f0 c8		beq $9453	                beq restoreFont32To255
94						                .endif
95	.948b	08		php		                php
96	.948c	78		sei		                sei
97	.948d	69 b8		adc #$b8	                adc #(>LB900)-1 ;form address of ROM font data for group
98	.948f	85 f1		sta $f1		                sta $F1
99	.9491	8a		txa		                txa
100	.9492	a2 01		ldx #$01	                ldx #$01                   ;copy 1 page, 32 chars
101	.9494	69 88		adc #$88	                adc #(>andy.softCharacterDefinitions)-1 ;get page in ANDY for group
102	.9496	80 c5		bra $945d	                bra restoreFontPart


:5	;******  Return to file: src/terminal.s65

1738						                .endif

1740						;-------------------------------------------------------------------------
1741						;
1742						; Clear 4 bytes in the OSFILE parameter block.
1743						;
1744						; entry:
1745						;
1746						; X = offset of the 4 bytes to clear
1747						;
1748	.9498					clearOSFILEParameterBlockDWORD:
1749	.9498	9e ed 02	stz $02ed,x	                stz osfileParameterBlock+0,x
1750	.949b	9e ee 02	stz $02ee,x	                stz osfileParameterBlock+1,x
1751	.949e	9e ef 02	stz $02ef,x	                stz osfileParameterBlock+2,x
1752	.94a1	9e f0 02	stz $02f0,x	                stz osfileParameterBlock+3,x
1753	.94a4					rts94A4:
1754	.94a4	60		rts		                rts

1756						;-------------------------------------------------------------------------
1757						;
1758						; Read a 32-bit hex value from a string.
1759						;
1760						; entry:
1761						;
1762						; X = offset into osfileParameterBlock to store the value
1763						;
1764						; exit:
1765						;
1766						; C=0 if error

1768	.94a5					parseHexAddressFromString:
1769	.94a5	20 ad f3	jsr $f3ad	                jsr mos.skipSpacesAndCheckForCRInStringInput ; Skip spaces
1770	.94a8	20 5b 86	jsr $865b	                jsr readHexDigit
1771	.94ab	90 23		bcc $94d0	                bcc rts92F4
1772	.94ad	20 98 94	jsr $9498	                jsr clearOSFILEParameterBlockDWORD
1773	.94b0					readDigitsLoop:
1774	.94b0	5a		phy		                phy
1775	.94b1	2a		rol a		                rol a
1776	.94b2	2a		rol a		                rol a
1777	.94b3	2a		rol a		                rol a
1778	.94b4	2a		rol a		                rol a                        ;put digit in top 4 bits
1779	.94b5	a0 04		ldy #$04	                ldy #$04
1780	.94b7					shiftIn1DigitLoop:
1781	.94b7	2a		rol a		                rol a
1782	.94b8	3e ed 02	rol $02ed,x	                rol osfileParameterBlock+0,x
1783	.94bb	3e ee 02	rol $02ee,x	                rol osfileParameterBlock+1,x
1784	.94be	3e ef 02	rol $02ef,x	                rol osfileParameterBlock+2,x
1785	.94c1	3e f0 02	rol $02f0,x	                rol osfileParameterBlock+3,x
1786	.94c4	b0 61		bcs $9527	                bcs badAddressError ;carry out of bit 31 implies too many digits
1787	.94c6	88		dey		                dey
1788	.94c7	d0 ee		bne $94b7	                bne shiftIn1DigitLoop
1789	.94c9	7a		ply		                ply
1790	.94ca	20 5b 86	jsr $865b	                jsr readHexDigit
1791	.94cd	b0 e1		bcs $94b0	                bcs readDigitsLoop   ;keep going until hex digits stop
1792	.94cf	38		sec		                sec       ;got at least 1 hex digit, so result is good
1793	.94d0					rts92F4:
1794	.94d0	60		rts		                rts

1796						;-------------------------------------------------------------------------
1797						;
1798						; *GO (<addr>) [MasRef C.5-6]
1799						;
1800	.94d1					starGO:
1801	.94d1	20 ad f3	jsr $f3ad	                jsr mos.skipSpacesAndCheckForCRInStringInput ; Skip spaces
1802	.94d4	d0 03		bne $94d9	                bne starGOIO             ; Jump to read parameters
1803	.94d6	4c 74 86	jmp $8674	                jmp commandLineUI        ; No parameters, enter CLICOM

1805						;-------------------------------------------------------------------------
1806						;
1807						; *GOIO <addr> [MasRef C.5-7]
1808						;
1809	.94d9					starGOIO:
1810	.94d9	a2 00		ldx #$00	                ldx #$00
1811	.94db	20 37 95	jsr $9537	                jsr parseHexAddressFromCommandLine ; Read hex address
1812	.94de	20 ad f3	jsr $f3ad	                jsr mos.skipSpacesAndCheckForCRInStringInput ; Skip spaces
1813	.94e1	08		php		                php  ; Update &F2/3 to point to any further parameters
1814	.94e2	98		tya		                tya
1815	.94e3	18		clc		                clc
1816	.94e4	65 f2		adc $f2		                adc stringInputBufferAddress+0
1817	.94e6	85 f2		sta $f2		                sta stringInputBufferAddress+0
1818	.94e8	90 02		bcc $94ec	                bcc +
1819	.94ea	e6 f3		inc $f3		                inc stringInputBufferAddress+1
1820	.94ec					+
1821	.94ec	a0 00		ldy #$00	                ldy #$00    ; (&F2),y=>parameters, EQ if no parameters
1822	.94ee	28		plp		                plp
1823	.94ef	6c ed 02	jmp ($02ed)	                jmp (osfileParameterBlock+0) ; Jump to address

1825						;-------------------------------------------------------------------------

1827	.94f2					starLOAD:
1828	.94f2	a9 ff		lda #$ff	                lda #fileLoad
1829	.94f4					starCommandThroughOSFILE:
1830	.94f4	4e c6 df	lsr $dfc6	                lsr hazel.tempFSFlag
1831	.94f7					L931B:
1832	.94f7	86 f2		stx $f2		                stx stringInputBufferAddress+0
1833	.94f9	84 f3		sty $f3		                sty stringInputBufferAddress+1
1834	.94fb	8e ed 02	stx $02ed	                stx osfileParameterBlock+OSFILEParameterBlock.fileName+0
1835	.94fe	8c ee 02	sty $02ee	                sty osfileParameterBlock+OSFILEParameterBlock.fileName+1
1836	.9501	48		pha		                pha                          ;save OSFILE reason
1837	.9502	a2 02		ldx #$02	                ldx #OSFILEParameterBlock.load
1838	.9504	20 98 94	jsr $9498	                jsr clearOSFILEParameterBlockDWORD
1839	.9507	a2 0a		ldx #$0a	                ldx #OSFILEParameterBlock.length
1840	.9509	20 98 94	jsr $9498	                jsr clearOSFILEParameterBlockDWORD
1841	.950c	a0 ff		ldy #$ff	                ldy #$FF
1842	.950e	8c f3 02	sty $02f3	                sty osfileParameterBlock+OSFILEParameterBlock.exec+0 ;by default, load to file's load address
1843	.9511	c8		iny		                iny                                                  ;Y=0
1844	.9512	20 1b f3	jsr $f31b	                jsr mos.gsinitForFilenameParsing
1845	.9515					L9339:
1846	.9515	20 2d f3	jsr $f32d	                jsr mos.gsreadEntryPoint
1847	.9518	90 fb		bcc $9515	                bcc L9339
1848	.951a	68		pla		                pla                          ;restore OSFILE reason
1849	.951b	48		pha		                pha                          ;save OSFILE reason
1850	.951c	10 50		bpl $956e	                bpl finishStarSAVE                    ;taken if *SAVE
1851	.951e	a2 02		ldx #$02	                ldx #OSFILEParameterBlock.load
1852	.9520	20 a5 94	jsr $94a5	                jsr parseHexAddressFromString ;parse *LOAD address
1853	.9523	b0 18		bcs $953d	                bcs doStarLOADWithExplicitAddress ;taken if good address
1854	.9525	f0 1b		beq $9542	                beq L9366        ;taken if CR encountered (this is ok)
1855	.9527					badAddressError:
1856	.9527	20 8c ae	jsr $ae8c	                jsr doFollowingError
1857	>952a	fc 42 61 64 20 61 64 64		                .text $fc,"Bad address",0
	>9532	72 65 73 73 00

1859						;-------------------------------------------------------------------------
1860						;
1861						; Parse hex address from command line.
1862						;
1863	.9537					parseHexAddressFromCommandLine:
1864	.9537	20 a5 94	jsr $94a5	                jsr parseHexAddressFromString ; Read hex address
1865	.953a	90 eb		bcc $9527	                bcc badAddressError           ; Jump with bad address
1866	.953c	60		rts		                rts

1868						;-------------------------------------------------------------------------

1870	.953d					doStarLOADWithExplicitAddress:
1871	.953d	d0 7f		bne $95be	                bne badCommandError93E2
1872	.953f	ee f3 02	inc $02f3	                inc osfileParameterBlock+OSFILEParameterBlock.exec+0 ;load to parameter block load address
1873	.9542					L9366:
1874	.9542	0e c6 df	asl $dfc6	                asl hazel.tempFSFlag
1875	.9545					callOSFILEWithOSFILEParameterBlock:
1876	.9545	a2 ed		ldx #$ed	                ldx #<osfileParameterBlock
1877	.9547	a0 02		ldy #$02	                ldy #>osfileParameterBlock
1878	.9549	68		pla		                pla
1879	.954a	4c dd ff	jmp $ffdd	                jmp OSFILE

1881						;-------------------------------------------------------------------------
1882						;
1883						; *REMOVE [MasRef G.5-9]
1884						;
1885	.954d					starREMOVE:
1886	.954d	8e ed 02	stx $02ed	                stx osfileParameterBlock+OSFILEParameterBlock.fileName+0
1887	.9550	8c ee 02	sty $02ee	                sty osfileParameterBlock+OSFILEParameterBlock.fileName+1
1888						                .if version>=510||version==350
1899						                .endif
1900	.9553	a9 06		lda #$06	                lda #fileDelete
1901	.9555	48		pha		                pha
1902	.9556	80 ed		bra $9545	                bra callOSFILEWithOSFILEParameterBlock

1904						;-------------------------------------------------------------------------
1905						                .if version<510&&version!=350
1906						;
1907						; *CLOSE [MasRef G.5-3]
1908						;
1909	.9558					starCLOSE:
1910	.9558	20 ad f3	jsr $f3ad	                jsr mos.skipSpacesAndCheckForCRInStringInput
1911	.955b	d0 61		bne $95be	                bne badCommandError93E2
1912	.955d	a9 00		lda #$00	                lda #$00
1913	.955f	a8		tay		                tay
1914	.9560	6c 1c 02	jmp ($021c)	                jmp (FINDV)                  ;OSFIND A=0 Y=0
1915						                .endif
1916						;-------------------------------------------------------------------------
1917						                .if version<510&&version!=350
1918						;
1919						; *IGNORE [MasRef C.5-7]
1920						;
1921	.9563					starIGNORE:
1922	.9563	d0 05		bne $956a	                bne L938E
1923	.9565	38		sec		                sec
1924	.9566	6e 46 02	ror $0246	                ror noignoreState
1925	.9569	60		rts		                rts

1927	.956a					L938E:
1928	.956a	a9 06		lda #$06	                lda #$06
1929	.956c	80 59		bra $95c7	                bra starCommandThroughOSBYTE
1930						                .endif
1931						;-------------------------------------------------------------------------

1933	.956e					finishStarSAVE:
1934	.956e	d0 07		bne $9577	                bne L939B
1935	.9570	a2 0a		ldx #$0a	                ldx #OSFILEParameterBlock.saveStart
1936	.9572	20 a5 94	jsr $94a5	                jsr parseHexAddressFromString
1937	.9575	90 47		bcc $95be	                bcc badCommandError93E2
1938	.9577					L939B:
1939	.9577	b8		clv		                clv
1940	.9578	b1 f2		lda ($f2),y	                lda (stringInputBufferAddress),y
1941	.957a	c9 2b		cmp #$2b	                cmp #'+'
1942	.957c	d0 04		bne $9582	                bne L93A6                    ;taken if "*SAVE START END..."
1943	.957e	2c 70 e3	bit $e370	                bit mos.valueFF              ;V=1
1944	.9581	c8		iny		                iny
1945	.9582					L93A6:
1946	.9582	a2 0e		ldx #$0e	                ldx #OSFILEParameterBlock.saveEnd
1947	.9584	20 a5 94	jsr $94a5	                jsr parseHexAddressFromString
1948	.9587	90 35		bcc $95be	                bcc badCommandError93E2
1949	.9589	08		php		                php
1950	.958a	50 0f		bvc $959b	                bvc L93BF                    ;taken if "*SAVE START END"

1952						                ; Get the save end address.
1953	.958c	a2 fc		ldx #$fc	                ldx #256-4
1954	.958e	18		clc		                clc
1955	.958f					-
1956						                ; TODO - not sure why the @w notation is required here?
1957	.958f	bd fb 01	lda $01fb,x	                lda@w osfileParameterBlock+OSFILEParameterBlock.saveStart-(256-4),x
1958	.9592	7d ff 01	adc $01ff,x	                adc@w osfileParameterBlock+OSFILEParameterBlock.saveEnd-(256-4),x
1959	.9595	9d ff 01	sta $01ff,x	                sta@w osfileParameterBlock+OSFILEParameterBlock.saveEnd-(256-4),x
1960	.9598	e8		inx		                inx
1961	.9599	d0 f4		bne $958f	                bne -
1962	.959b					L93BF:

1964						                ; Initialize load and exec addresses to save start
1965						                ; address.
1966	.959b	a2 03		ldx #$03	                ldx #$03
1967	.959d					-
1968	.959d	bd f7 02	lda $02f7,x	                lda@w osfileParameterBlock+OSFILEParameterBlock.saveStart,x
1969	.95a0	9d f3 02	sta $02f3,x	                sta@w osfileParameterBlock+OSFILEParameterBlock.exec,x
1970	.95a3	9d ef 02	sta $02ef,x	                sta@w osfileParameterBlock+OSFILEParameterBlock.load,x
1971	.95a6	ca		dex		                dex
1972	.95a7	10 f4		bpl $959d	                bpl -

1974	.95a9	28		plp		                plp
1975	.95aa	f0 96		beq $9542	                beq L9366

1977	.95ac	a2 06		ldx #$06	                ldx #OSFILEParameterBlock.exec
1978	.95ae	20 a5 94	jsr $94a5	                jsr parseHexAddressFromString
1979	.95b1	90 0b		bcc $95be	                bcc badCommandError93E2
1980	.95b3	f0 8d		beq $9542	                beq L9366

1982	.95b5	a2 02		ldx #$02	                ldx #OSFILEParameterBlock.load
1983	.95b7	20 a5 94	jsr $94a5	                jsr parseHexAddressFromString
1984	.95ba	90 02		bcc $95be	                bcc badCommandError93E2
1985	.95bc	f0 84		beq $9542	                beq L9366

1987	.95be					badCommandError93E2:
1988	.95be	4c 3d fb	jmp $fb3d	                jmp mos.badCommandError

1990						;-------------------------------------------------------------------------

1992	.95c1					starFX:
1993	.95c1	20 f9 85	jsr $85f9	                jsr parseNumberFromString
1994	.95c4	90 f8		bcc $95be	                bcc badCommandError93E2
1995	.95c6	8a		txa		                txa
1996	.95c7					starCommandThroughOSBYTE:
1997	.95c7	08		php		                php
1998	.95c8	4e c6 df	lsr $dfc6	                lsr hazel.tempFSFlag
1999	.95cb	28		plp		                plp
2000	.95cc	48		pha		                pha
2001	.95cd	64 e5		stz $e5		                stz $E5
2002	.95cf	64 e4		stz $e4		                stz $E4
2003	.95d1	20 b6 f3	jsr $f3b6	                jsr mos.LF308
2004	.95d4	f0 18		beq $95ee	                beq L9412
2005	.95d6	20 f9 85	jsr $85f9	                jsr parseNumberFromString
2006	.95d9	90 e3		bcc $95be	                bcc badCommandError93E2
2007	.95db	86 e5		stx $e5		                stx $E5
2008	.95dd	20 b8 f3	jsr $f3b8	                jsr mos.LF30A
2009	.95e0	f0 0c		beq $95ee	                beq L9412
2010	.95e2	20 f9 85	jsr $85f9	                jsr parseNumberFromString
2011	.95e5	90 d7		bcc $95be	                bcc badCommandError93E2
2012	.95e7	86 e4		stx $e4		                stx $E4
2013	.95e9	20 ad f3	jsr $f3ad	                jsr mos.skipSpacesAndCheckForCRInStringInput
2014	.95ec					L9625:
2015	.95ec	d0 d0		bne $95be	                bne badCommandError93E2
2016	.95ee					L9412:
2017	.95ee	a4 e4		ldy $e4		                ldy $E4
2018	.95f0	a6 e5		ldx $e5		                ldx $E5
2019	.95f2	68		pla		                pla
2020	.95f3	0e c6 df	asl $dfc6	                asl hazel.tempFSFlag
2021	.95f6	20 f4 ff	jsr $fff4	                jsr OSBYTE
2022	.95f9	70 c3		bvs $95be	                bvs badCommandError93E2
2023	.95fb					L941F:
2024	.95fb	60		rts		                rts

2026						;-------------------------------------------------------------------------

2028	.95fc					starSPOOLON:
2029	.95fc	38		sec		                sec
2030	.95fd	80 10		bra $960f	                bra starSPOOL

2032						;-------------------------------------------------------------------------

2034						                .if version>=510||version==350
2039						                .endif

2041						;-------------------------------------------------------------------------

2043	.95ff					L9423:
2044	.95ff	a2 10		ldx #$10	                ldx #romServiceCallSpoolExecClosureWarning
2045	.9601	20 f8 ee	jsr $eef8	                jsr mos.makeROMServiceCall
2046	.9604	f0 f5		beq $95fb	                beq L941F
2047	.9606	20 87 a9	jsr $a987	                jsr LA58B
2048	.9609	ad 57 02	lda $0257	                lda spoolFileHandle
2049	.960c	20 67 a9	jsr $a967	                jsr LA56B
2050	.960f					starSPOOL:
2051	.960f	08		php		                php
2052	.9610	5a		phy		                phy
2053	.9611	ac 57 02	ldy $0257	                ldy spoolFileHandle
2054	.9614	8d 57 02	sta $0257	                sta spoolFileHandle
2055	.9617	f0 03		beq $961c	                beq L9440
2056	.9619	20 ce ff	jsr $ffce	                jsr OSFIND
2057	.961c					L9440:
2058	.961c	4e c6 df	lsr $dfc6	                lsr hazel.tempFSFlag
2059	.961f	7a		ply		                ply
2060	.9620	28		plp		                plp
2061	.9621	f0 d8		beq $95fb	                beq L941F
2062	.9623	a9 80		lda #$80	                lda #$80
2063	.9625	90 02		bcc $9629	                bcc L944D
2064	.9627	a9 c0		lda #$c0	                lda #$C0
2065	.9629					L944D:
2066	.9629	0e c6 df	asl $dfc6	                asl hazel.tempFSFlag
2067	.962c	20 ce ff	jsr $ffce	                jsr OSFIND
2068	.962f	a8		tay		                tay
2069	.9630	f0 8c		beq $95be	                beq badCommandError93E2
2070	.9632	8d 57 02	sta $0257	                sta spoolFileHandle
2071	.9635	a8		tay		                tay
2072	.9636					setPTRToEOF:
2073	.9636	a9 02		lda #$02	                lda #argsFileGetEXT
2074	.9638	20 3d 96	jsr $963d	                jsr callOSARGSWithBuffer
2075	.963b					setFilePointerFromOSARGSBuffer:
2076	.963b	a9 01		lda #$01	                lda #argsFileSetPTR
2077	.963d					callOSARGSWithBuffer:
2078	.963d	a2 a8		ldx #$a8	                ldx #osargsBuffer
2079	.963f	4c da ff	jmp $ffda	                jmp OSARGS

2081						;-------------------------------------------------------------------------

2083						                .if version<510&&version!=350
2084	.9642					starSHADOW:
2085	.9642	a9 72		lda #$72	                lda #$72
2086	.9644	80 81		bra $95c7	                bra starCommandThroughOSBYTE
2087						                .endif

2089						;-------------------------------------------------------------------------

2091						                .if version>=510||version==350
2098						                .endif

2100						;-------------------------------------------------------------------------

2102						                .if version>=510||version==350
2112						                .endif

2114						;-------------------------------------------------------------------------
2115						;
2116	.9646					starDELETE:
2117	.9646	20 4d 95	jsr $954d	                jsr starREMOVE
2118	.9649	a8		tay		                tay
2119	.964a	d0 af		bne $95fb	                bne L941F
2120	.964c	4c 49 a9	jmp $a949	                jmp notFoundError

2122						;-------------------------------------------------------------------------

2124						                .if version==350
2127						                .endif

2129						;-------------------------------------------------------------------------

2131						                .if version==350
2146						                .endif

2148						;-------------------------------------------------------------------------

2150						                .if version>=510||version==350
2177						                .endif

2179						;-------------------------------------------------------------------------

2181						                .if version<510&&version!=350
2182	.964f					parseSoftKeyNumberFromCommandLine:
2183	.964f	20 f9 85	jsr $85f9	                jsr parseNumberFromString
2184	.9652	90 04		bcc $9658	                bcc badKeyError
2185	.9654	e0 10		cpx #$10	                cpx #softKeyCount
2186	.9656	90 a3		bcc $95fb	                bcc L941F
2187	.9658					badKeyError:
2188	.9658	20 8c ae	jsr $ae8c	                jsr doFollowingError
2189	>965b	fb				                .byte $FB
2190	>965c	42 61 64 20 6b 65 79		                .text "Bad key"
2191	>9663	00				                .byte 0
2192						                .endif

2194						;-------------------------------------------------------------------------
2195						;
2196						; [MasRef C.5-11]
2197						;

2199						                .if version<510&&version!=350
2200	.9664					starSHOW:
2201	.9664	20 4f 96	jsr $964f	                jsr parseSoftKeyNumberFromCommandLine
2202	.9667	20 ad f3	jsr $f3ad	                jsr mos.skipSpacesAndCheckForCRInStringInput
2203	.966a	d0 ec		bne $9658	                bne badKeyError
2206						                .endif
2207	.966c	a9 22		lda #$22	                lda #'"'
2208	.966e	20 ee ff	jsr $ffee	                jsr OSWRCH
2209	.9671	a5 f4		lda $f4		                lda $F4
2210	.9673	48		pha		                pha
2211	.9674	20 b1 e5	jsr $e5b1	                jsr mos.selectTerminalROMAndANDY2
2212	.9677	bd 00 80	lda $8000,x	                lda andy.softKeys.stringLSBs,x
2213	.967a	85 f2		sta $f2		                sta stringInputBufferAddress+0
2214	.967c	bd 11 80	lda $8011,x	                lda andy.softKeys.stringMSBs,x
2215	.967f	85 f3		sta $f3		                sta stringInputBufferAddress+1
2216						                .if version<510&&version!=350
2217	.9681	a4 e6		ldy $e6		                ldy $E6
2221						                .endif
2222	.9683	20 c1 ec	jsr $ecc1	                jsr mos.getSoftKeyStringLength
2223	.9686	a8		tay		                tay                          ;Y = string length
2224	.9687	f0 0e		beq $9697	                beq starSHOWDone                    ;done if length=0
2225	.9689					-
2226	.9689	b2 f2		lda ($f2)	                lda (stringInputBufferAddress)
2227	.968b	20 e2 97	jsr $97e2	                jsr printGSREADChar
2228	.968e	e6 f2		inc $f2		                inc stringInputBufferAddress+0
2229	.9690	d0 02		bne $9694	                bne +
2230	.9692	e6 f3		inc $f3		                inc stringInputBufferAddress+1
2231	.9694					+
2232	.9694	88		dey		                dey
2233	.9695	d0 f2		bne $9689	                bne -
2234	.9697					starSHOWDone:
2235	.9697	68		pla		                pla
2236	.9698	20 ab e5	jsr $e5ab	                jsr mos.selectROMA
2237	.969b	a9 22		lda #$22	                lda #'"'
2238	.969d	20 ee ff	jsr $ffee	                jsr OSWRCH
2239	.96a0	4c e7 ff	jmp $ffe7	                jmp OSNEWL

2241						;-------------------------------------------------------------------------

2243						                .if version>=510
2254						                .endif

2256						;-------------------------------------------------------------------------
2257						;
2258						; [MasRef C.5-8]
2259						;
2260	.96a3					starKEY: .proc
2261	.96a3	20 4f 96	jsr $964f	                jsr parseSoftKeyNumberFromCommandLine
2262	.96a6	a5 f4		lda $f4		                lda $F4
2263	.96a8	48		pha		                pha
2264	.96a9	20 98 e5	jsr $e598	                jsr mos.selectTerminalROMAndANDY
2265	.96ac	20 ad f3	jsr $f3ad	                jsr mos.skipSpacesAndCheckForCRInStringInput
2266	.96af	64 b0		stz $b0		                stz starKEYWorkspace.newStringLength
2267	.96b1	f0 15		beq $96c8	                beq commandLineTailEmpty
2268	.96b3	a2 00		ldx #$00	                ldx #$00
2269	.96b5	38		sec		                sec
2270	.96b6	20 1c f3	jsr $f31c	                jsr mos.gsinitEntryPoint
2271	.96b9					-
2272	.96b9	20 2d f3	jsr $f32d	                jsr mos.gsreadEntryPoint
2273	.96bc	b0 06		bcs $96c4	                bcs bneBadKeyError
2274	.96be	9d 00 dc	sta $dc00,x	                sta hazel.commandLine,x
2275	.96c1	e8		inx		                inx
2276	.96c2	80 f5		bra $96b9	                bra -

2278	.96c4					bneBadKeyError:
2279						                .if version==350
2281						                .else
2282	.96c4	d0 92		bne $9658	                bne badKeyError
2283						                .endif
2284	.96c6	86 b0		stx $b0		                stx starKEYWorkspace.newStringLength
2285	.96c8					commandLineTailEmpty:
2286	.96c8	a4 e6		ldy $e6		                ldy $E6                        ;Y = soft key number
2287	.96ca	20 c1 ec	jsr $ecc1	                jsr mos.getSoftKeyStringLength
2288	.96cd	85 b5		sta $b5		                sta starKEYWorkspace.counter+0
2289	.96cf	38		sec		                sec
2290	.96d0	e5 b0		sbc $b0		                sbc starKEYWorkspace.newStringLength ;A=existing len-new len
2291	.96d2	b0 16		bcs $96ea	                bcs newStringWillFit            ;taken if new string shorter, meaning it'll definitely fit

2293	.96d4	49 ff		eor #$ff	                eor #$FF
2294	.96d6	69 01		adc #$01	                adc #$01                     ;A=new len-existing len
2295	.96d8	6d 10 80	adc $8010	                adc andy.softKeys.endLSB
2296	.96db	aa		tax		                tax
2297	.96dc	ad 21 80	lda $8021	                lda andy.softKeys.endMSB
2298	.96df	69 00		adc #$00	                adc #$00
2299	.96e1	c9 84		cmp #$84	                cmp #>(andy.softKeys.end)
2300	.96e3	90 05		bcc $96ea	                bcc newStringWillFit

2302						                ; Produce slightly cryptic "Bad key" if string won't
2303						                ; fit.
2304	.96e5	d0 dd		bne $96c4	                bne bneBadKeyError
2305	.96e7	8a		txa		                txa
2306	.96e8	d0 da		bne $96c4	                bne bneBadKeyError
2307	.96ea					newStringWillFit:
2308	.96ea	ad 68 02	lda $0268	                lda softKeyStringLength
2309	.96ed	f0 32		beq $9721	                beq storeNewString          ;taken if new string empty
2310	.96ef	ad c9 02	lda $02c9	                lda currentSoftKey
2311	.96f2	c5 e6		cmp $e6		                cmp $E6
2312	.96f4	90 2b		bcc $9721	                bcc storeNewString ;taken if current soft key<key - expansion will not need to relocate
2313	.96f6	d0 0f		bne $9707	                bne relocateCurrentSoftKeyExpansion ;taken if current soft key>key - expansion must relocate
2314	.96f8	20 8c ae	jsr $ae8c	                jsr doFollowingError
2315	>96fb	fa 4b 65 79 20 69 6e 20		                .text $fa,"Key in use",0
	>9703	75 73 65 00
2316	.9707					relocateCurrentSoftKeyExpansion:
2317	.9707	64 b2		stz $b2		                stz starKEYWorkspace.destPtr+1
2318	.9709	38		sec		                sec
2319	.970a	a5 b0		lda $b0		                lda starKEYWorkspace.newStringLength
2320	.970c	e5 b5		sbc $b5		                sbc starKEYWorkspace.counter+0
2321	.970e	85 b1		sta $b1		                sta starKEYWorkspace.destPtr+0
2322	.9710	b0 02		bcs $9714	                bcs +
2323	.9712	c6 b2		dec $b2		                dec starKEYWorkspace.destPtr+1
2324	.9714					+
2325	.9714	18		clc		                clc
2326	.9715	a5 f8		lda $f8		                lda softKeyExpansionPtr+0
2327	.9717	65 b1		adc $b1		                adc starKEYWorkspace.destPtr+0
2328	.9719	85 f8		sta $f8		                sta softKeyExpansionPtr+0
2329	.971b	a5 f9		lda $f9		                lda softKeyExpansionPtr+1
2330	.971d	65 b2		adc $b2		                adc starKEYWorkspace.destPtr+1
2331	.971f	85 f9		sta $f9		                sta softKeyExpansionPtr+1
2332	.9721					storeNewString:
2333	.9721	ce 84 02	dec $0284	                dec softKeyConsistencyFlag   ;mark soft keys inconsistent
2334	.9724	a6 e6		ldx $e6		                ldx $E6                      ;X=key number
2335	.9726	a5 b5		lda $b5		                lda starKEYWorkspace.counter+0
2336	.9728	f0 45		beq $976f	                beq makeSpaceForNewString ;taken if no existing string for this soft key

2338						                ; delete existing string
2339	.972a	bd 00 80	lda $8000,x	                lda andy.softKeys.stringLSBs,x
2340	.972d	85 b1		sta $b1		                sta starKEYWorkspace.destPtr+0
2341	.972f	bd 11 80	lda $8011,x	                lda andy.softKeys.stringMSBs,x
2342	.9732	85 b2		sta $b2		                sta starKEYWorkspace.destPtr+1
2343	.9734	bd 01 80	lda $8001,x	                lda andy.softKeys.stringLSBs+1,x
2344	.9737	85 b3		sta $b3		                sta starKEYWorkspace.srcPtr+0
2345	.9739	bd 12 80	lda $8012,x	                lda andy.softKeys.stringMSBs+1,x
2346	.973c	85 b4		sta $b4		                sta starKEYWorkspace.srcPtr+1
2347	.973e					deleteExistingStringLoop:
2348						                ; copy byte (with postincrement)
2349	.973e	b2 b3		lda ($b3)	                lda (starKEYWorkspace.srcPtr)
2350	.9740	92 b1		sta ($b1)	                sta (starKEYWorkspace.destPtr)

2352						                ; increment destPtr
2353	.9742	e6 b1		inc $b1		                inc starKEYWorkspace.destPtr+0
2354	.9744	d0 02		bne $9748	                bne +
2355	.9746	e6 b2		inc $b2		                inc starKEYWorkspace.destPtr+1
2356	.9748					+

2358						                ; increment srcPtr
2359	.9748	e6 b3		inc $b3		                inc starKEYWorkspace.srcPtr+0
2360	.974a	d0 02		bne $974e	                bne +
2361	.974c	e6 b4		inc $b4		                inc starKEYWorkspace.srcPtr+1
2362	.974e					+

2364						                ; keep copying until end of buffer reached.
2365	.974e	a5 b3		lda $b3		                lda starKEYWorkspace.srcPtr+0
2366	.9750	cd 10 80	cmp $8010	                cmp andy.softKeys.endLSB
2367	.9753	a5 b4		lda $b4		                lda starKEYWorkspace.srcPtr+1
2368	.9755	ed 21 80	sbc $8021	                sbc andy.softKeys.endMSB
2369	.9758	90 e4		bcc $973e	                bcc deleteExistingStringLoop

2371						                ; update following strings' start addresses, which all
2372						                ; move down by the old string's length.
2373	.975a					updateAddressesLoop:
2374	.975a	e8		inx		                inx
2375	.975b	e0 11		cpx #$11	                cpx #softKeyCount+1
2376	.975d	b0 10		bcs $976f	                bcs makeSpaceForNewString
2377	.975f	38		sec		                sec
2378	.9760	bd 00 80	lda $8000,x	                lda andy.softKeys.stringLSBs,x
2379	.9763	e5 b5		sbc $b5		                sbc starKEYWorkspace.counter+0
2380	.9765	9d 00 80	sta $8000,x	                sta andy.softKeys.stringLSBs,x
2381	.9768	b0 f0		bcs $975a	                bcs updateAddressesLoop
2382	.976a	de 11 80	dec $8011,x	                dec andy.softKeys.stringMSBs,x
2383	.976d	80 eb		bra $975a	                bra updateAddressesLoop

2385	.976f					makeSpaceForNewString:
2386	.976f	a6 e6		ldx $e6		                ldx $E6
2387	.9771	a5 b0		lda $b0		                lda starKEYWorkspace.newStringLength
2388	.9773	f0 66		beq $97db	                beq done
2389	.9775	ad 10 80	lda $8010	                lda andy.softKeys.endLSB
2390	.9778	85 b3		sta $b3		                sta starKEYWorkspace.srcPtr+0
2391	.977a	18		clc		                clc
2392	.977b	65 b0		adc $b0		                adc starKEYWorkspace.newStringLength
2393	.977d	85 b1		sta $b1		                sta starKEYWorkspace.destPtr+0 ;new end ptr LSB
2394	.977f	ad 21 80	lda $8021	                lda andy.softKeys.endMSB
2395	.9782	85 b4		sta $b4		                sta starKEYWorkspace.srcPtr+1
2396	.9784	69 00		adc #$00	                adc #$00
2397	.9786	85 b2		sta $b2		                sta starKEYWorkspace.destPtr+1 ;new end ptr MSB
2398	.9788	a5 b3		lda $b3		                lda starKEYWorkspace.srcPtr+0
2399	.978a	38		sec		                sec
2400	.978b	fd 00 80	sbc $8000,x	                sbc andy.softKeys.stringLSBs,x
2401	.978e	85 b5		sta $b5		                sta starKEYWorkspace.counter+0
2402	.9790	a5 b4		lda $b4		                lda starKEYWorkspace.srcPtr+1
2403	.9792	fd 11 80	sbc $8011,x	                sbc andy.softKeys.stringMSBs,x
2404	.9795	85 b6		sta $b6		                sta starKEYWorkspace.counter+1
2405	.9797					makeSpaceForNewStringLoop:
2406						                ; loop while counter>0
2407	.9797	a5 b5		lda $b5		                lda starKEYWorkspace.counter+0
2408	.9799	05 b6		ora $b6		                ora starKEYWorkspace.counter+1
2409	.979b	f0 1e		beq $97bb	                beq updateAddressesLoop2

2411						                ; decrement destPtr
2412	.979d	a5 b1		lda $b1		                lda starKEYWorkspace.destPtr+0
2413	.979f	d0 02		bne $97a3	                bne +
2414	.97a1	c6 b2		dec $b2		                dec starKEYWorkspace.destPtr+1
2415	.97a3					+
2416	.97a3	c6 b1		dec $b1		                dec starKEYWorkspace.destPtr+0

2418						                ; decrement srcPtr
2419	.97a5	a5 b3		lda $b3		                lda starKEYWorkspace.srcPtr+0
2420	.97a7	d0 02		bne $97ab	                bne +
2421	.97a9	c6 b4		dec $b4		                dec starKEYWorkspace.srcPtr+1
2422	.97ab					+
2423	.97ab	c6 b3		dec $b3		                dec starKEYWorkspace.srcPtr+0

2425						                ; copy byte (with predecrement)
2426	.97ad	b2 b3		lda ($b3)	                lda (starKEYWorkspace.srcPtr)
2427	.97af	92 b1		sta ($b1)	                sta (starKEYWorkspace.destPtr)

2429						                ; decrement counter
2430	.97b1	a5 b5		lda $b5		                lda starKEYWorkspace.counter+0
2431	.97b3	d0 02		bne $97b7	                bne +
2432	.97b5	c6 b6		dec $b6		                dec starKEYWorkspace.counter+1
2433	.97b7					+
2434	.97b7	c6 b5		dec $b5		                dec starKEYWorkspace.counter+0

2436	.97b9	80 dc		bra $9797	                bra makeSpaceForNewStringLoop

2438						                ; update following strings' start addresses, which all
2439						                ; move up by the new string's length.
2440	.97bb					updateAddressesLoop2:
2441	.97bb	e8		inx		                inx
2442	.97bc	e0 11		cpx #$11	                cpx #softKeyCount+1
2443	.97be	b0 0f		bcs $97cf	                bcs copyNewString
2444	.97c0	bd 00 80	lda $8000,x	                lda andy.softKeys.stringLSBs,x
2445	.97c3	65 b0		adc $b0		                adc starKEYWorkspace.newStringLength
2446	.97c5	9d 00 80	sta $8000,x	                sta andy.softKeys.stringLSBs,x
2447	.97c8	90 f1		bcc $97bb	                bcc updateAddressesLoop2
2448	.97ca	fe 11 80	inc $8011,x	                inc andy.softKeys.stringMSBs,x
2449	.97cd	80 ec		bra $97bb	                bra updateAddressesLoop2

2451	.97cf					copyNewString:
2452	.97cf	a0 00		ldy #$00	                ldy #$00
2453	.97d1					copyNewStringLoop:
2454	.97d1	b9 00 dc	lda $dc00,y	                lda hazel.commandLine,y
2455	.97d4	91 b3		sta ($b3),y	                sta (starKEYWorkspace.srcPtr),y
2456	.97d6	c8		iny		                iny
2457	.97d7	c6 b0		dec $b0		                dec starKEYWorkspace.newStringLength
2458	.97d9	d0 f6		bne $97d1	                bne copyNewStringLoop
2459	.97db					done:
2460	.97db	ee 84 02	inc $0284	                inc softKeyConsistencyFlag   ;mark soft keys consistent
2461	.97de	68		pla		                pla
2462	.97df	4c ab e5	jmp $e5ab	                jmp mos.selectROMA
2463						                .endproc

2465						;-------------------------------------------------------------------------
2466						;
2467						; Print char, printing control codes using the string reader escape
2468						; syntax. [MasRef C.5-8]
2469						;
2470	.97e2					printGSREADChar: .proc
2471	.97e2	aa		tax		                tax                          ;X=char
2472	.97e3	30 28		bmi $980d	                bmi printHighBitChar
2473	.97e5	c9 20		cmp #$20	                cmp #$20
2474	.97e7	90 1f		bcc $9808	                bcc printControlChar
2475	.97e9	e8		inx		                inx
2476	.97ea	30 0f		bmi $97fb	                bmi vdu127
2477	.97ec	ca		dex		                dex                          ;restore old char
2478	.97ed	c9 22		cmp #$22	                cmp #'"'
2479	.97ef	f0 11		beq $9802	                beq printEscapedX
2480	.97f1	c9 7c		cmp #$7c	                cmp #'|'
2481	.97f3	d0 03		bne $97f8	                bne printA
2482						                ; print "||"
2483	.97f5	20 ee ff	jsr $ffee	                jsr OSWRCH
2484	.97f8					printA:
2485	.97f8	4c ee ff	jmp $ffee	                jmp OSWRCH

2487	.97fb					vdu127:
2488						                ; print "|?"
2489	.97fb	20 18 98	jsr $9818	                jsr printEscapeChar
2490	.97fe	a9 3f		lda #$3f	                lda #'?'
2491	.9800	80 f6		bra $97f8	                bra printA

2493	.9802					printEscapedX:
2494	.9802	20 18 98	jsr $9818	                jsr printEscapeChar
2495	.9805	8a		txa		                txa
2496	.9806	80 f0		bra $97f8	                bra printA

2498	.9808					printControlChar:
2499	.9808	09 40		ora #$40	                ora #$40
2500	.980a	aa		tax		                tax
2501	.980b	80 f5		bra $9802	                bra printEscapedX

2503	.980d					printHighBitChar:
2504	.980d	48		pha		                pha
2505	.980e	a2 21		ldx #$21	                ldx #'!'
2506	.9810	20 02 98	jsr $9802	                jsr printEscapedX
2507	.9813	68		pla		                pla
2508	.9814	29 7f		and #$7f	                and #$7F
2509	.9816	80 ca		bra $97e2	                bra printGSREADChar

2511	.9818					printEscapeChar:
2512	.9818	a9 7c		lda #$7c	                lda #'|'
2513	.981a	80 dc		bra $97f8	                bra printA
2514						                .endproc

2516						;-------------------------------------------------------------------------

2518						                .if version!=350
2519						                .include "rtc.s65"

:11	;******  Processing file: src/rtc.s65

1						                .if version<500
211						                .endif

213						;-------------------------------------------------------------------------

215						; TODO - is this necessary?
216						;
217						; There's a reference to dayOfWeekStrings-4, but that seems to be
218						; because days are 1-based. The data here is presumably never
219						; accesssed.
220	>981c	20 20 20 00			                .text "   ",0

222						;-------------------------------------------------------------------------

224	.9820					dayOfWeekStrings: .block
225	>9820	53 75 6e 01			                .text "Sun",$01
226	>9824	4d 6f 6e 02			                .text "Mon",$02
227	>9828	54 75 65 03			                .text "Tue",$03
228	>982c	57 65 64 04			                .text "Wed",$04
229	>9830	54 68 75 05			                .text "Thu",$05
230	>9834	46 72 69 06			                .text "Fri",$06
231	>9838	53 61 74 07			                .text "Sat",$07
232						                .endblock

234						;-------------------------------------------------------------------------

236	.983c					monthStrings: .block
237	>983c	4a 61 6e 01			                .text "Jan",$01
238	>9840	46 65 62 02			                .text "Feb",$02
239	>9844	4d 61 72 03			                .text "Mar",$03
240	>9848	41 70 72 04			                .text "Apr",$04
241	>984c	4d 61 79 05			                .text "May",$05
242	>9850	4a 75 6e 06			                .text "Jun",$06
243	>9854	4a 75 6c 07			                .text "Jul",$07
244	>9858	41 75 67 08			                .text "Aug",$08
245	>985c	53 65 70 09			                .text "Sep",$09
246	>9860	4f 63 74 10			                .text "Oct",$10
247	>9864	4e 6f 76 11			                .text "Nov",$11
248	>9868	44 65 63 12			                .text "Dec",$12
249						                .endblock

251						;-------------------------------------------------------------------------

253						                .if version>=500
254	.986c					L986C:
255	>986c	99				                .byte $99
256	>986d	12				                .byte $12
257	>986e	31				                .byte $31
258	>986f	06				                .byte $06
259	>9870	23				                .byte $23
260	>9871	59				                .byte $59
261	>9872	59				                .byte $59
262						                .endif

264						;-------------------------------------------------------------------------

266						                .if version>=500
267	.9873					osword0F:
268	.9873	a2 08		ldx #$08	                ldx #romServiceCallUnrecognisedOSWORD
269	.9875	4c f8 ee	jmp $eef8	                jmp mos.makeROMServiceCall
270						                .endif

272						;-------------------------------------------------------------------------
273						;
274						; OSWORD 14 (&0E) Read CMOS clock [MasRef D.3-22]
275						;

277	.9878					osword0E:
278						                .if version<500
282						                .else
283	.9878	c9 02		cmp #$02	                cmp #2
284	.987a	f0 2c		beq $98a8	                beq L98A8
285	.987c	48		pha		                pha
286	.987d	a5 f0		lda $f0		                lda originalX
287	.987f	48		pha		                pha
288	.9880	a5 f1		lda $f1		                lda originalY
289	.9882	48		pha		                pha
290	.9883	a2 08		ldx #$08	                ldx #romServiceCallUnrecognisedOSWORD
291	.9885	20 f8 ee	jsr $eef8	                jsr mos.makeROMServiceCall
292	.9888	c9 01		cmp #$01	                cmp #1
293	.988a	68		pla		                pla
294	.988b	85 f1		sta $f1		                sta originalY
295	.988d	68		pla		                pla
296	.988e	85 f0		sta $f0		                sta originalX
297	.9890	90 1e		bcc $98b0	                bcc L98B0
298	.9892	a0 07		ldy #$07	                ldy #7
299	.9894	68		pla		                pla
300	.9895	48		pha		                pha
301	.9896	f0 01		beq $9899	                beq L9899
302	.9898	88		dey		                dey
303	.9899					L9899:
304	.9899	a2 07		ldx #$07	                ldx #7
305	.989b					L989B:
306	.989b	bd 6b 98	lda $986b,x	                lda L986C-1,x
307	.989e	91 f0		sta ($f0),y	                sta (originalX),y
308	.98a0	88		dey		                dey
309	.98a1	ca		dex		                dex
310	.98a2	d0 f7		bne $989b	                bne L989B
311	.98a4	68		pla		                pla
312	.98a5	3a		dec a		                dec a
313	.98a6	f0 07		beq $98af	                beq L98AF
314	.98a8					L98A8:
315	.98a8	a2 08		ldx #$08	                ldx #romServiceCallUnrecognisedOSWORD
316	.98aa	20 f8 ee	jsr $eef8	                jsr mos.makeROMServiceCall
317	.98ad	d0 03		bne $98b2	                bne L98B2
318	.98af					L98AF:
319	.98af	48		pha		                pha
320	.98b0					L98B0:
321	.98b0	68		pla		                pla
322	.98b1	60		rts		                rts

324	.98b2					L98B2:
325						                .endif

327						                ; Convert given time to string. Fill out the RTC temp
328						                ; data with the info from the parameter block, then
329						                ; pass on to the common code.
330	.98b2	a0 07		ldy #$07	                ldy #$07

332						                ; Copy hours, mins, secs.
333	.98b4	a2 00		ldx #$00	                ldx #$00
334	.98b6					-
335	.98b6	b1 f0		lda ($f0),y	                lda ($F0),y
336	.98b8	9d ee 02	sta $02ee,x	                sta osfileParameterBlock+1,x
337	.98bb	88		dey		                dey
338	.98bc	e8		inx		                inx
339	.98bd	e8		inx		                inx
340	.98be	e0 06		cpx #$06	                cpx #$06
341	.98c0	90 f4		bcc $98b6	                bcc -

343						                ; Copy day of week, day of month, month, year.
344	.98c2					-
345	.98c2	b1 f0		lda ($f0),y	                lda (originalX),y
346	.98c4	9d ee 02	sta $02ee,x	                sta osfileParameterBlock+1,x
347	.98c7	e8		inx		                inx
348	.98c8	88		dey		                dey
349	.98c9	d0 f7		bne $98c2	                bne -

351						                .if version<500
411						                .endif

413	.98cb					convertTimeToString:
414						                ; Store terminating CR.
415	.98cb	a0 18		ldy #$18	                ldy #ClockStringFormat.cr
416	.98cd	a9 0d		lda #$0d	                lda #13
417	.98cf	91 f0		sta ($f0),y	                sta (originalX),y
418	.98d1	a2 00		ldx #$00	                ldx #$00
419	.98d3	88		dey		                dey
420	.98d4	20 39 99	jsr $9939	                jsr storeRTCDataByteString
421	.98d7	a9 3a		lda #$3a	                lda #':'
422	.98d9	91 f0		sta ($f0),y	                sta (originalX),y
423	.98db	a0 12		ldy #$12	                ldy #ClockStringFormat.hh+2
424	.98dd	91 f0		sta ($f0),y	                sta (originalX),y
425	.98df	a2 02		ldx #$02	                ldx #RTC.minutes
426	.98e1	a0 14		ldy #$14	                ldy #ClockStringFormat.mm+1
427	.98e3	20 39 99	jsr $9939	                jsr storeRTCDataByteString
428	.98e6	a2 04		ldx #$04	                ldx #RTC.hours
429	.98e8	a0 11		ldy #$11	                ldy #ClockStringFormat.hh+1
430	.98ea	20 39 99	jsr $9939	                jsr storeRTCDataByteString
431	.98ed	a9 2e		lda #$2e	                lda #'.'
432	.98ef	91 f0		sta ($f0),y	                sta (originalX),y
433	.98f1	ad f4 02	lda $02f4	                lda osfileParameterBlock+1+RTC.dayOfWeek;
434	.98f4	0a		asl a		                asl a
435	.98f5	0a		asl a		                asl a
436	.98f6	a0 00		ldy #$00	                ldy #$00
437	.98f8	aa		tax		                tax
438	.98f9					-
439	.98f9	bd 1c 98	lda $981c,x	                lda dayOfWeekStrings-4,x     ;-4 as 1=Sunday
440	.98fc	91 f0		sta ($f0),y	                sta (originalX),y
441	.98fe	e8		inx		                inx
442	.98ff	c8		iny		                iny
443	.9900	c0 03		cpy #$03	                cpy #$03
444	.9902	90 f5		bcc $98f9	                bcc -
445	.9904	a9 2c		lda #$2c	                lda #','
446	.9906	91 f0		sta ($f0),y	                sta (originalX),y
447	.9908	ad f6 02	lda $02f6	                lda osfileParameterBlock+1+RTC.month
448	.990b	c9 10		cmp #$10	                cmp #$10
449	.990d	90 02		bcc $9911	                bcc +
450	.990f	e9 06		sbc #$06	                sbc #$06            ;convert $10, $11 and $12 from BCD
451	.9911					+
452	.9911	3a		dec a		                dec a                        ;make month 0-based
453	.9912	0a		asl a		                asl a
454	.9913	0a		asl a		                asl a
455	.9914	aa		tax		                tax
456	.9915	a0 07		ldy #$07	                ldy #ClockStringFormat.mmm
457	.9917					-
458	.9917	bd 3c 98	lda $983c,x	                lda monthStrings,x
459	.991a	91 f0		sta ($f0),y	                sta ($F0),y
460	.991c	e8		inx		                inx
461	.991d	c8		iny		                iny
462	.991e	c0 0a		cpy #$0a	                cpy #ClockStringFormat.mmm+3
463	.9920	90 f5		bcc $9917	                bcc -
464	.9922	a2 09		ldx #$09	                ldx #RTC.year
465	.9924	a0 0e		ldy #$0e	                ldy #ClockStringFormat.yyyy+3
466	.9926	20 39 99	jsr $9939	                jsr storeRTCDataByteString
467						                .if multios
471						                .else
472	.9929	a9 19		lda #$19	                lda #$19                     ;it's always 19xx... right?
473	.992b	20 3c 99	jsr $993c	                jsr storeBCDByteString
474						                .endif
475	.992e	a9 20		lda #$20	                lda #$20
476	.9930	91 f0		sta ($f0),y	                sta ($F0),y
477	.9932	a0 06		ldy #$06	                ldy #ClockStringFormat.nn+2
478	.9934	91 f0		sta ($f0),y	                sta ($F0),y
479	.9936	88		dey		                dey
480	.9937	a2 07		ldx #$07	                ldx #RTC.dayOfMonth
481	.9939					storeRTCDataByteString:
482	.9939	bd ee 02	lda $02ee,x	                lda osfileParameterBlock+1,x
483	.993c					storeBCDByteString:
484	.993c	48		pha		                pha
485	.993d	20 45 99	jsr $9945	                jsr storeNybbleString
486	.9940	68		pla		                pla
487						                .if version==350
489						                .else
490	.9941	4a		lsr a		                lsr a
491	.9942	4a		lsr a		                lsr a
492	.9943	4a		lsr a		                lsr a
493	.9944	4a		lsr a		                lsr a
494						                .endif
495	.9945					storeNybbleString:
496	.9945	29 0f		and #$0f	                and #$0F
497	.9947	09 30		ora #$30	                ora #'0'
498	.9949	c9 3a		cmp #$3a	                cmp #'9'+1
499	.994b	90 02		bcc $994f	                bcc +
500	.994d	69 06		adc #$06	                adc #('A'-'9'-1)-1           ;(-1 because C set)
501	.994f					+
502	.994f	91 f0		sta ($f0),y	                sta (originalX),y
503	.9951	88		dey		                dey
504	.9952	60		rts		                rts

506						;-------------------------------------------------------------------------

508						                .if version<500
516						                .endif

518						;-------------------------------------------------------------------------

520						                .if version<500
528						                .endif

530						;-------------------------------------------------------------------------
531						;
532						; Read byte from RTC, either by 0-based CMOS RAM offset (readCMOSByte)
533						; or by RTC register index (readRTCByte).
534						;
535						; entry:
536						;
537						; X = address to read from
538						;
539						; exit:
540						;
541						; A = byte read
542						;
543						; N,Z = set as per byte read
544						;
545						                .if version<500
578						                .endif

580						;-------------------------------------------------------------------------
581						;
582						; Write byte to RTC, either by 0-based CMOS RAM offset (writeCMOSByte)
583						; or by RTC register index (writeRTCByte).
584						;
585						; (For some reason, writeCMOSByte can't be used to write to CMOS RAM
586						; offset 0.)
587						;
588						; entry:
589						;
590						; X = address to write to
591						;
592						; Y = value to write
593						;
594						                .if version<500
612						                .endif

614						;-------------------------------------------------------------------------
615						;
616						; Convert CMOS byte offset to actual RTC address.
617						;
618						; entry:
619						;
620						; X = CMOS byte offset - 0-49
621						;
622						; exit:
623						;
624						; C=1 = invalid address
625						;
626						; C=0 = valid address: X = register index
627						;
628						                .if version<500
637						                .endif

639						;-------------------------------------------------------------------------
640						;
641						; set RTC address for future read/write operation.
642						;
643						; entry:
644						;
645						; X = address to set
646						;
647						; preserves: Y
648						;
649						                .if version<500
664						                .endif

:5	;******  Return to file: src/terminal.s65

2520						                .endif

2522						;-------------------------------------------------------------------------

2524	.9953					L9923:
2525	.9953	a9 03		lda #$03	                lda #$03
2526	.9955	20 98 d2	jsr $d298	                jsr mos.LD298
2527	.9958	90 12		bcc $996c	                bcc L993C
2528	.995a	20 60 99	jsr $9960	                jsr L9930
2529	.995d	20 a9 d8	jsr $d8a9	                jsr mos.LD8A9
2530	.9960					L9930:
2531	.9960	a2 20		ldx #$20	                ldx #$20
2532	.9962	4c c8 e2	jmp $e2c8	                jmp mos.LE2B8

2534	.9965					L9935:
2535	.9965	a9 02		lda #$02	                lda #$02
2536	.9967	20 98 d2	jsr $d298	                jsr mos.LD298
2537	.996a	b0 64		bcs $99d0	                bcs L99A0
2538	.996c					L993C:
2539	.996c	20 d2 d3	jsr $d3d2	                jsr mos.LD3D2
2540	.996f	20 ef 9a	jsr $9aef	                jsr L9ABF
2541	.9972	80 08		bra $997c	                bra L994C

2543	.9974					L9944:
2544	.9974	20 1a d4	jsr $d41a	                jsr mos.LD41A
2545	.9977	f0 57		beq $99d0	                beq L99A0
2546	.9979	20 d2 d3	jsr $d3d2	                jsr mos.LD3D2
2547	.997c					L994C:
2548	.997c	a5 e1		lda $e1		                lda $E1
2549	.997e	89 20		bit #$20	                bit #$20
2550	.9980	f0 05		beq $9987	                beq L9957
2551	.9982	48		pha		                pha
2552	.9983	20 a3 d6	jsr $d6a3	                jsr mos.LD6A3
2553	.9986	68		pla		                pla
2554	.9987					L9957:
2555	.9987	89 10		bit #$10	                bit #$10
2556	.9989	f0 03		beq $998e	                beq L995E
2557	.998b	20 98 d6	jsr $d698	                jsr mos.LD698
2558	.998e					L995E:
2559	.998e	20 2c 9a	jsr $9a2c	                jsr L99FC
2560	.9991	08		php		                php
2561	.9992	20 8a 9a	jsr $9a8a	                jsr L9A5A
2562	.9995	a2 42		ldx #$42	                ldx #$42
2563	.9997	a0 46		ldy #$46	                ldy #$46
2564	.9999	a9 20		lda #$20	                lda #$20
2565	.999b	2c 49 88	bit $8849	                bit L8849
2566	.999e	f0 1c		beq $99bc	                beq L998C
2567	.99a0	30 18		bmi $99ba	                bmi L998A
2568	.99a2	ad 2c 03	lda $032c	                lda $032C
2569	.99a5	cd 37 03	cmp $0337	                cmp $0337
2570	.99a8	d0 08		bne $99b2	                bne L9982
2571	.99aa	ad 2d 03	lda $032d	                lda $032D
2572	.99ad	cd 38 03	cmp $0338	                cmp $0338
2573	.99b0	f0 10		beq $99c2	                beq L9992
2574	.99b2					L9982:
2575	.99b2	a2 37		ldx #$37	                ldx #$37
2576	.99b4	20 4d d2	jsr $d24d	                jsr mos.LD24D
2577	.99b7	a2 42		ldx #$42	                ldx #$42
2578	.99b9	b8		clv		                clv
2579	.99ba					L998A:
2580	.99ba	a0 2c		ldy #$2c	                ldy #$2C
2581	.99bc					L998C:
2582	.99bc	30 07		bmi $99c5	                bmi L9995
2583	.99be	50 02		bvc $99c2	                bvc L9992
2584	.99c0	a2 37		ldx #$37	                ldx #$37
2585	.99c2					L9992:
2586	.99c2	20 4d d2	jsr $d24d	                jsr mos.LD24D
2587	.99c5					L9995:
2588	.99c5	28		plp		                plp
2589	.99c6	90 b4		bcc $997c	                bcc L994C
2590	.99c8	60		rts		                rts

2592	.99c9					L9999:
2593	.99c9	a9 01		lda #$01	                lda #$01
2594	.99cb	20 98 d2	jsr $d298	                jsr mos.LD298
2595	.99ce	90 09		bcc $99d9	                bcc L99A9
2596	.99d0					L99A0:
2597	.99d0	a2 24		ldx #$24	                ldx #$24
2598	.99d2	80 37		bra $9a0b	                bra L99DB

2600	.99d4					L99A4:
2601	.99d4	20 1a d4	jsr $d41a	                jsr mos.LD41A
2602	.99d7	f0 f7		beq $99d0	                beq L99A0
2603	.99d9					L99A9:
2604	.99d9	20 d2 d3	jsr $d3d2	                jsr mos.LD3D2
2605	.99dc	20 f9 99	jsr $99f9	                jsr L99C9
2606	.99df					L99AF:
2607	.99df	20 e6 d5	jsr $d5e6	                jsr mos.LD5E6
2608	.99e2	20 f9 99	jsr $99f9	                jsr L99C9
2609	.99e5	ad 30 88	lda $8830	                lda L8830
2610	.99e8	0d 31 88	ora $8831	                ora L8831
2611	.99eb	f0 3e		beq $9a2b	                beq L99FB
2612	.99ed	2c 48 88	bit $8848	                bit L8848
2613	.99f0	70 ed		bvs $99df	                bvs L99AF
2614	.99f2	a2 42		ldx #$42	                ldx #$42
2615	.99f4	20 06 9a	jsr $9a06	                jsr L99D6
2616	.99f7	80 e6		bra $99df	                bra L99AF

2618	.99f9					L99C9:
2619	.99f9	20 34 d3	jsr $d334	                jsr mos.LD334
2620	.99fc	20 0e 9a	jsr $9a0e	                jsr L99DE
2621	.99ff	2c 48 88	bit $8848	                bit L8848
2622	.9a02	30 27		bmi $9a2b	                bmi L99FB
2623	.9a04	a2 46		ldx #$46	                ldx #$46
2624	.9a06					L99D6:
2625	.9a06	da		phx		                phx
2626	.9a07	20 80 d2	jsr $d280	                jsr mos.LD280
2627	.9a0a	fa		plx		                plx
2628	.9a0b					L99DB:
2629	.9a0b	4c 4c db	jmp $db4c	                jmp mos.LDB4C

2631	.9a0e					L99DE:
2632	.9a0e	a2 03		ldx #$03	                ldx #$03
2633	.9a10					L99E0:
2634	.9a10	bd 30 88	lda $8830,x	                lda L8830,x
2635	.9a13	9d 42 03	sta $0342,x	                sta $0342,x
2636	.9a16	9d 46 03	sta $0346,x	                sta $0346,x
2637	.9a19	ca		dex		                dex
2638	.9a1a	10 f4		bpl $9a10	                bpl L99E0
2639	.9a1c					L99EC:
2640	.9a1c	ac 42 03	ldy $0342	                ldy $0342
2641	.9a1f	ad 43 03	lda $0343	                lda $0343
2642	.9a22	20 2e c9	jsr $c92e	                jsr mos.negateAY
2643	.9a25	8c 42 03	sty $0342	                sty $0342
2644	.9a28	8d 43 03	sta $0343	                sta $0343
2645	.9a2b					L99FB:
2646	.9a2b	60		rts		                rts

2648	.9a2c					L99FC:
2649	.9a2c	a5 e1		lda $e1		                lda $E1
2650	.9a2e	8d 49 88	sta $8849	                sta L8849
2651	.9a31	20 0e 9a	jsr $9a0e	                jsr L99DE
2652	.9a34	a2 01		ldx #$01	                ldx #$01
2653	.9a36					L9A06:
2654	.9a36	9e 42 03	stz $0342,x	                stz $0342,x
2655	.9a39	9e 46 03	stz $0346,x	                stz $0346,x
2656	.9a3c	ca		dex		                dex
2657	.9a3d	10 f7		bpl $9a36	                bpl L9A06
2658	.9a3f					L9A0F:
2659	.9a3f	20 5e 9a	jsr $9a5e	                jsr L9A2E
2660	.9a42	ad 30 88	lda $8830	                lda L8830
2661	.9a45	0d 31 88	ora $8831	                ora L8831
2662	.9a48	d0 06		bne $9a50	                bne L9A20
2663	.9a4a	38		sec		                sec
2664	.9a4b	ad 47 88	lda $8847	                lda L8847
2665	.9a4e	d0 cc		bne $9a1c	                bne L99EC
2666	.9a50					L9A20:
2667	.9a50	20 e6 d5	jsr $d5e6	                jsr mos.LD5E6
2668	.9a53	ad 32 88	lda $8832	                lda L8832
2669	.9a56	cd 44 03	cmp $0344	                cmp $0344
2670	.9a59	f0 e4		beq $9a3f	                beq L9A0F
2671	.9a5b	18		clc		                clc
2672	.9a5c	80 be		bra $9a1c	                bra L99EC

2674	.9a5e					L9A2E:
2675	.9a5e	20 34 d3	jsr $d334	                jsr mos.LD334
2676	.9a61	2c 48 88	bit $8848	                bit L8848
2677	.9a64	30 07		bmi $9a6d	                bmi L9A3D
2678	.9a66	08		php		                php
2679	.9a67	a2 46		ldx #$46	                ldx #$46
2680	.9a69	20 71 9a	jsr $9a71	                jsr L9A41
2681	.9a6c	28		plp		                plp
2682	.9a6d					L9A3D:
2683	.9a6d	70 1a		bvs $9a89	                bvs L9A59
2684	.9a6f	a2 42		ldx #$42	                ldx #$42
2685	.9a71					L9A41:
2686	.9a71	ad 30 88	lda $8830	                lda L8830
2687	.9a74	a8		tay		                tay
2688	.9a75	dd 00 03	cmp $0300,x	                cmp $0300,x
2689	.9a78	ad 31 88	lda $8831	                lda L8831
2690	.9a7b	48		pha		                pha
2691	.9a7c	fd 01 03	sbc $0301,x	                sbc $0301,x
2692	.9a7f	68		pla		                pla
2693	.9a80	90 07		bcc $9a89	                bcc L9A59
2694	.9a82	9d 01 03	sta $0301,x	                sta $0301,x
2695	.9a85	98		tya		                tya
2696	.9a86	9d 00 03	sta $0300,x	                sta $0300,x
2697	.9a89					L9A59:
2698	.9a89	60		rts		                rts

2700	.9a8a					L9A5A:
2701	.9a8a	ad 44 03	lda $0344	                lda $0344
2702	.9a8d	0d 45 03	ora $0345	                ora $0345
2703	.9a90	d0 5c		bne $9aee	                bne L9ABE
2704	.9a92	a5 e1		lda $e1		                lda $E1
2705	.9a94	1a		inc a		                inc a
2706	.9a95	29 03		and #$03	                and #$03
2707	.9a97	d0 55		bne $9aee	                bne L9ABE
2708	.9a99	a9 20		lda #$20	                lda #$20
2709	.9a9b	2c 49 88	bit $8849	                bit L8849
2710	.9a9e	10 09		bpl $9aa9	                bpl L9A79
2711	.9aa0	f0 07		beq $9aa9	                beq L9A79
2712	.9aa2	a2 2c		ldx #$2c	                ldx #$2C
2713	.9aa4	a0 46		ldy #$46	                ldy #$46
2714	.9aa6	20 1e c9	jsr $c91e	                jsr mos.copyFourBytesWithinVDUVariables
2715	.9aa9					L9A79:
2716	.9aa9	a9 10		lda #$10	                lda #$10
2717	.9aab	2c 49 88	bit $8849	                bit L8849
2718	.9aae	50 09		bvc $9ab9	                bvc L9A89
2719	.9ab0	f0 07		beq $9ab9	                beq L9A89
2720	.9ab2	a2 37		ldx #$37	                ldx #$37
2721	.9ab4	a0 42		ldy #$42	                ldy #$42
2722	.9ab6	20 1e c9	jsr $c91e	                jsr mos.copyFourBytesWithinVDUVariables
2723	.9ab9					L9A89:
2724	.9ab9	20 ef 9a	jsr $9aef	                jsr L9ABF
2725	.9abc	a5 e1		lda $e1		                lda $E1
2726	.9abe	49 3c		eor #$3c	                eor #$3C
2727	.9ac0	2a		rol a		                rol a
2728	.9ac1	20 6f c6	jsr $c66f	                jsr mos.fixUpVPALETTEFor4Colours
2729	.9ac4	6a		ror a		                ror a
2730	.9ac5	85 e1		sta $e1		                sta $E1
2731	.9ac7	89 20		bit #$20	                bit #$20
2732	.9ac9	f0 10		beq $9adb	                beq L9AAB
2733	.9acb	48		pha		                pha
2734	.9acc	a2 2c		ldx #$2c	                ldx #$2C
2735	.9ace	a0 46		ldy #$46	                ldy #$46
2736	.9ad0	20 cc d5	jsr $d5cc	                jsr mos.sortVDUVariableWords
2737	.9ad3	98		tya		                tya
2738	.9ad4	aa		tax		                tax
2739	.9ad5	a0 46		ldy #$46	                ldy #$46
2740	.9ad7	20 1e c9	jsr $c91e	                jsr mos.copyFourBytesWithinVDUVariables
2741	.9ada	68		pla		                pla
2742	.9adb					L9AAB:
2743	.9adb	89 10		bit #$10	                bit #$10
2744	.9add	f0 0c		beq $9aeb	                beq L9ABB
2745	.9adf	a2 37		ldx #$37	                ldx #$37
2746	.9ae1	a0 42		ldy #$42	                ldy #$42
2747	.9ae3	20 cc d5	jsr $d5cc	                jsr mos.sortVDUVariableWords
2748	.9ae6	a0 42		ldy #$42	                ldy #$42
2749	.9ae8	20 1e c9	jsr $c91e	                jsr mos.copyFourBytesWithinVDUVariables
2750	.9aeb					L9ABB:
2751	.9aeb	9c 49 88	stz $8849	                stz L8849
2752	.9aee					L9ABE:
2753	.9aee	60		rts		                rts

2755	.9aef					L9ABF:
2756	.9aef	a2 03		ldx #$03	                ldx #$03
2757	.9af1					L9AC1:
2758	.9af1	9e 3b 03	stz $033b,x	                stz $033B,x
2759	.9af4	ca		dex		                dex
2760	.9af5	10 fa		bpl $9af1	                bpl L9AC1
2761	.9af7	a0 28		ldy #$28	                ldy #$28
2762	.9af9	a2 1b		ldx #$1b	                ldx #$1B
2763	.9afb	a9 2c		lda #$2c	                lda #$2C
2764	.9afd	20 0f 9b	jsr $9b0f	                jsr L9ADF
2765	.9b00	20 a8 d6	jsr $d6a8	                jsr mos.LD6A8
2766	.9b03	a0 1b		ldy #$1b	                ldy #$1B
2767	.9b05	a2 28		ldx #$28	                ldx #$28
2768	.9b07	a9 37		lda #$37	                lda #$37
2769	.9b09	20 0f 9b	jsr $9b0f	                jsr L9ADF
2770	.9b0c	4c 9d d6	jmp $d69d	                jmp mos.LD69D

2772	.9b0f					L9ADF:
2773	.9b0f	48		pha		                pha
2774	.9b10	a5 e1		lda $e1		                lda $E1
2775	.9b12	4a		lsr a		                lsr a
2776	.9b13	90 0b		bcc $9b20	                bcc L9AF0
2777	.9b15	ad 47 88	lda $8847	                lda L8847
2778	.9b18	d0 04		bne $9b1e	                bne L9AEE
2779	.9b1a	a2 3b		ldx #$3b	                ldx #$3B
2780	.9b1c	80 02		bra $9b20	                bra L9AF0

2782	.9b1e					L9AEE:
2783	.9b1e	a0 3b		ldy #$3b	                ldy #$3B
2784	.9b20					L9AF0:
2785	.9b20	8a		txa		                txa
2786	.9b21	fa		plx		                plx
2787	.9b22	da		phx		                phx
2788	.9b23	48		pha		                pha
2789	.9b24	5a		phy		                phy
2790	.9b25	a8		tay		                tay
2791	.9b26	a9 03		lda #$03	                lda #$03
2792	.9b28	85 da		sta $da		                sta $DA
2793	.9b2a					L9AFA:
2794	.9b2a	b9 00 03	lda $0300,y	                lda $0300,y
2795	.9b2d	9d 1e 88	sta $881e,x	                sta L881E,x
2796	.9b30	c8		iny		                iny
2797	.9b31	e8		inx		                inx
2798	.9b32	c6 da		dec $da		                dec $DA
2799	.9b34	10 f4		bpl $9b2a	                bpl L9AFA
2800	.9b36	7a		ply		                ply
2801	.9b37	68		pla		                pla
2802	.9b38	fa		plx		                plx
2803	.9b39					L9B09:
2804	.9b39	48		pha		                pha
2805	.9b3a	5a		phy		                phy
2806	.9b3b	20 91 9b	jsr $9b91	                jsr L9B61
2807	.9b3e	ca		dex		                dex
2808	.9b3f	7a		ply		                ply
2809	.9b40	68		pla		                pla
2810	.9b41	da		phx		                phx
2811	.9b42	c8		iny		                iny
2812	.9b43	c8		iny		                iny
2813	.9b44	1a		inc a		                inc a
2814	.9b45	1a		inc a		                inc a
2815	.9b46	e8		inx		                inx
2816	.9b47	e8		inx		                inx
2817	.9b48	20 91 9b	jsr $9b91	                jsr L9B61
2818	.9b4b	fa		plx		                plx
2819	.9b4c	20 c0 9b	jsr $9bc0	                jsr L9B90
2820	.9b4f	08		php		                php
2821	.9b50	48		pha		                pha
2822	.9b51	bd 05 03	lda $0305,x	                lda $0305,x
2823	.9b54	0a		asl a		                asl a
2824	.9b55	7e 0a 03	ror $030a,x	                ror $030A,x
2825	.9b58	10 03		bpl $9b5d	                bpl L9B2D
2826	.9b5a	20 af 9b	jsr $9baf	                jsr L9B7F
2827	.9b5d					L9B2D:
2828	.9b5d	68		pla		                pla
2829	.9b5e	0a		asl a		                asl a
2830	.9b5f	7e 0a 03	ror $030a,x	                ror $030A,x
2831	.9b62	10 07		bpl $9b6b	                bpl L9B3B
2832	.9b64	e8		inx		                inx
2833	.9b65	e8		inx		                inx
2834	.9b66	20 af 9b	jsr $9baf	                jsr L9B7F
2835	.9b69	ca		dex		                dex
2836	.9b6a	ca		dex		                dex
2837	.9b6b					L9B3B:
2838	.9b6b	20 c0 9b	jsr $9bc0	                jsr L9B90
2839	.9b6e	10 06		bpl $9b76	                bpl L9B46
2840	.9b70	bd 05 03	lda $0305,x	                lda $0305,x
2841	.9b73	bc 04 03	ldy $0304,x	                ldy $0304,x
2842	.9b76					L9B46:
2843	.9b76	28		plp		                plp
2844	.9b77	30 06		bmi $9b7f	                bmi L9B4F
2845	.9b79	c0 00		cpy #$00	                cpy #$00
2846	.9b7b	d0 01		bne $9b7e	                bne L9B4E
2847	.9b7d	3a		dec a		                dec a
2848	.9b7e					L9B4E:
2849	.9b7e	88		dey		                dey
2850	.9b7f					L9B4F:
2851	.9b7f	4a		lsr a		                lsr a
2852	.9b80	48		pha		                pha
2853	.9b81	98		tya		                tya
2854	.9b82	6a		ror a		                ror a
2855	.9b83	38		sec		                sec
2856	.9b84	ca		dex		                dex
2857	.9b85	20 8a 9b	jsr $9b8a	                jsr L9B5A
2858	.9b88	e8		inx		                inx
2859	.9b89	68		pla		                pla
2860	.9b8a					L9B5A:
2861	.9b8a	fd 07 03	sbc $0307,x	                sbc $0307,x
2862	.9b8d	9d 09 03	sta $0309,x	                sta $0309,x
2863	.9b90	60		rts		                rts

2865	.9b91					L9B61:
2866	.9b91	48		pha		                pha
2867	.9b92	b9 00 03	lda $0300,y	                lda $0300,y
2868	.9b95	9d 00 03	sta $0300,x	                sta $0300,x
2869	.9b98	b9 01 03	lda $0301,y	                lda $0301,y
2870	.9b9b	9d 01 03	sta $0301,x	                sta $0301,x
2871	.9b9e	7a		ply		                ply
2872	.9b9f	38		sec		                sec
2873	.9ba0	20 a5 9b	jsr $9ba5	                jsr L9B75
2874	.9ba3	e8		inx		                inx
2875	.9ba4	c8		iny		                iny
2876	.9ba5					L9B75:
2877	.9ba5	b9 00 03	lda $0300,y	                lda $0300,y
2878	.9ba8	fd 00 03	sbc $0300,x	                sbc $0300,x
2879	.9bab	9d 04 03	sta $0304,x	                sta $0304,x
2880	.9bae	60		rts		                rts

2882	.9baf					L9B7F:
2883	.9baf	bd 05 03	lda $0305,x	                lda $0305,x
2884	.9bb2	bc 04 03	ldy $0304,x	                ldy $0304,x
2885	.9bb5	20 2e c9	jsr $c92e	                jsr mos.negateAY
2886	.9bb8	9d 05 03	sta $0305,x	                sta $0305,x
2887	.9bbb	98		tya		                tya
2888	.9bbc	9d 04 03	sta $0304,x	                sta $0304,x
2889	.9bbf	60		rts		                rts

2891	.9bc0					L9B90:
2892	.9bc0	bd 06 03	lda $0306,x	                lda $0306,x
2893	.9bc3	a8		tay		                tay
2894	.9bc4	dd 04 03	cmp $0304,x	                cmp $0304,x
2895	.9bc7	bd 07 03	lda $0307,x	                lda $0307,x
2896	.9bca	fd 05 03	sbc $0305,x	                sbc $0305,x
2897	.9bcd	08		php		                php
2898	.9bce	bd 07 03	lda $0307,x	                lda $0307,x
2899	.9bd1	28		plp		                plp
2900	.9bd2	60		rts		                rts

2902						;-------------------------------------------------------------------------
2903						;
2904						; 112<80><93>119 = Plot parallelogram [MasRef E.3-27]
2905						;
2906	.9bd3					plotParallelogram:
2907	.9bd3	a2 28		ldx #$28	                ldx #$28
2908	.9bd5	86 da		stx $da		                stx $DA
2909	.9bd7	a2 14		ldx #$14	                ldx #$14
2910	.9bd9	a0 20		ldy #$20	                ldy #$20
2911	.9bdb	a9 24		lda #$24	                lda #$24
2912	.9bdd	20 80 d5	jsr $d580	                jsr mos.addRegionDimensionsToVDUVariableCoordinates
2913	.9be0	a0 14		ldy #$14	                ldy #$14
2914	.9be2	a2 24		ldx #$24	                ldx #$24
2915	.9be4	20 b7 d5	jsr $d5b7	                jsr mos.sortVDUVariableCoordinates
2916	.9be7	8e 30 88	stx $8830	                stx L8830
2917	.9bea	a2 20		ldx #$20	                ldx #$20
2918	.9bec	20 b7 d5	jsr $d5b7	                jsr mos.sortVDUVariableCoordinates
2919	.9bef	8e 31 88	stx $8831	                stx L8831
2920	.9bf2	a2 28		ldx #$28	                ldx #$28
2921	.9bf4	20 b7 d5	jsr $d5b7	                jsr mos.sortVDUVariableCoordinates
2922	.9bf7	8c 33 88	sty $8833	                sty L8833
2923	.9bfa	ac 31 88	ldy $8831	                ldy L8831
2924	.9bfd	20 b7 d5	jsr $d5b7	                jsr mos.sortVDUVariableCoordinates
2925	.9c00	8c 32 88	sty $8832	                sty L8832
2926	.9c03	ac 30 88	ldy $8830	                ldy L8830
2927	.9c06	20 3f 9c	jsr $9c3f	                jsr L9C0F
2928	.9c09	ad 33 88	lda $8833	                lda L8833
2929	.9c0c	85 e0		sta $e0		                sta $E0
2930	.9c0e	a2 2c		ldx #$2c	                ldx #$2C
2931	.9c10	20 39 9b	jsr $9b39	                jsr L9B09
2932	.9c13	a4 e1		ldy $e1		                ldy $E1
2933	.9c15	20 86 9c	jsr $9c86	                jsr L9C56
2934	.9c18	ac 32 88	ldy $8832	                ldy L8832
2935	.9c1b	ad 33 88	lda $8833	                lda L8833
2936	.9c1e	85 e1		sta $e1		                sta $E1
2937	.9c20	a2 37		ldx #$37	                ldx #$37
2938	.9c22	20 81 9c	jsr $9c81	                jsr L9C51
2939	.9c25	80 15		bra $9c3c	                bra L9C0C

2941	.9c27					L9BF7;
2942	.9c27	a0 14		ldy #$14	                ldy #$14
2943	.9c29	a2 24		ldx #$24	                ldx #$24
2944	.9c2b	20 b7 d5	jsr $d5b7	                jsr mos.sortVDUVariableCoordinates
2945	.9c2e	8c 32 88	sty $8832	                sty L8832
2946	.9c31	a0 20		ldy #$20	                ldy #$20
2947	.9c33	20 3f 9c	jsr $9c3f	                jsr L9C0F
2948	.9c36	ad 32 88	lda $8832	                lda L8832
2949	.9c39	20 7d 9c	jsr $9c7d	                jsr L9C4D
2950	.9c3c					L9C0C:
2951	.9c3c	4c e4 da	jmp $dae4	                jmp mos.LDAE4

2953	.9c3f					L9C0F:
2954	.9c3f	20 b7 d5	jsr $d5b7	                jsr mos.sortVDUVariableCoordinates
2955	.9c42	8e 30 88	stx $8830	                stx L8830
2956	.9c45	ae 32 88	ldx $8832	                ldx L8832
2957	.9c48	20 b7 d5	jsr $d5b7	                jsr mos.sortVDUVariableCoordinates
2958	.9c4b	8c 32 88	sty $8832	                sty L8832
2959	.9c4e	8e 31 88	stx $8831	                stx L8831
2960	.9c51	ac 30 88	ldy $8830	                ldy L8830
2961	.9c54	a2 fc		ldx #$fc	                ldx #$FC
2962	.9c56					L9C26:
2963	.9c56	b9 00 03	lda $0300,y	                lda $0300,y
2964	.9c59	9d 46 02	sta $0246,x	                sta vduv.workspace._42-$fc,x
2965	.9c5c	9d 4a 02	sta $024a,x	                sta vduv.workspace._46-$fc,x
2966	.9c5f	c8		iny		                iny
2967	.9c60	e8		inx		                inx
2968	.9c61	d0 f3		bne $9c56	                bne L9C26
2969	.9c63	ac 30 88	ldy $8830	                ldy L8830
2970	.9c66	ad 32 88	lda $8832	                lda L8832
2971	.9c69	85 e1		sta $e1		                sta $E1
2972	.9c6b	a2 37		ldx #$37	                ldx #$37
2973	.9c6d	20 39 9b	jsr $9b39	                jsr L9B09
2974	.9c70	ac 30 88	ldy $8830	                ldy L8830
2975	.9c73	ad 31 88	lda $8831	                lda L8831
2976	.9c76	20 7d 9c	jsr $9c7d	                jsr L9C4D
2977	.9c79	ac 31 88	ldy $8831	                ldy L8831
2978	.9c7c	60		rts		                rts

2980	.9c7d					L9C4D:
2981	.9c7d	85 e0		sta $e0		                sta $E0
2982	.9c7f	a2 2c		ldx #$2c	                ldx #$2C
2983	.9c81					L9C51:
2984	.9c81	20 39 9b	jsr $9b39	                jsr L9B09
2985	.9c84	a4 e0		ldy $e0		                ldy $E0
2986	.9c86					L9C56:
2987	.9c86	5a		phy		                phy
2988	.9c87	b9 02 03	lda $0302,y	                lda $0302,y
2989	.9c8a	cd 44 03	cmp $0344	                cmp $0344
2990	.9c8d	d0 08		bne $9c97	                bne L9C67
2991	.9c8f	b9 03 03	lda $0303,y	                lda $0303,y
2992	.9c92	cd 45 03	cmp $0345	                cmp $0345
2993	.9c95	f0 39		beq $9cd0	                beq L9CA0
2994	.9c97					L9C67:
2995	.9c97	a2 2c		ldx #$2c	                ldx #$2C
2996	.9c99	20 f0 9c	jsr $9cf0	                jsr L9CC0
2997	.9c9c	a2 37		ldx #$37	                ldx #$37
2998	.9c9e	20 f0 9c	jsr $9cf0	                jsr L9CC0
2999	.9ca1	20 e4 da	jsr $dae4	                jsr mos.LDAE4
3000	.9ca4	a2 37		ldx #$37	                ldx #$37
3001	.9ca6	20 26 d7	jsr $d726	                jsr mos.LD726
3002	.9ca9	a2 2c		ldx #$2c	                ldx #$2C
3003	.9cab	20 26 d7	jsr $d726	                jsr mos.LD726
3004	.9cae	a0 37		ldy #$37	                ldy #$37
3005	.9cb0	20 cc d5	jsr $d5cc	                jsr mos.sortVDUVariableWords
3006	.9cb3	da		phx		                phx
3007	.9cb4	a2 fc		ldx #$fc	                ldx #$FC
3008	.9cb6					L9C86:
3009	.9cb6	b9 00 03	lda $0300,y	                lda $0300,y
3010	.9cb9	9d 4a 02	sta $024a,x	                sta vduv.workspace._46-$fc,x
3011	.9cbc	c8		iny		                iny
3012	.9cbd	e8		inx		                inx
3013	.9cbe	d0 f6		bne $9cb6	                bne L9C86
3014	.9cc0	fa		plx		                plx
3015	.9cc1	a0 fc		ldy #$fc	                ldy #$FC
3016	.9cc3					L9C93:
3017	.9cc3	bd 00 03	lda $0300,x	                lda $0300,x
3018	.9cc6	99 46 02	sta $0246,y	                sta vduv.workspace._42-$fc,y
3019	.9cc9	e8		inx		                inx
3020	.9cca	c8		iny		                iny
3021	.9ccb	d0 f6		bne $9cc3	                bne L9C93
3022	.9ccd	7a		ply		                ply
3023	.9cce	80 b6		bra $9c86	                bra L9C56

3025	.9cd0					L9CA0:
3026	.9cd0	a9 2c		lda #$2c	                lda #$2C
3027	.9cd2	a6 e0		ldx $e0		                ldx $E0
3028	.9cd4	20 dc 9c	jsr $9cdc	                jsr L9CAC
3029	.9cd7	7a		ply		                ply
3030	.9cd8	a9 37		lda #$37	                lda #$37
3031	.9cda	a6 e1		ldx $e1		                ldx $E1
3032	.9cdc					L9CAC:
3033	.9cdc	85 de		sta $de		                sta $DE
3034	.9cde	bd 02 03	lda $0302,x	                lda vduv.graphicsWindowPixelsBottom+0,x
3035	.9ce1	d9 02 03	cmp $0302,y	                cmp vduv.graphicsWindowPixelsBottom+0,y
3036	.9ce4	d0 08		bne $9cee	                bne L9CBE
3037	.9ce6	bd 03 03	lda $0303,x	                lda vduv.graphicsWindowPixelsBottom+1,x
3038	.9ce9	d9 03 03	cmp $0303,y	                cmp vduv.graphicsWindowPixelsBottom+1,y
3039	.9cec	f0 05		beq $9cf3	                beq L9CC3
3040	.9cee					L9CBE:
3041	.9cee	a6 de		ldx $de		                ldx $DE
3042	.9cf0					L9CC0:
3043	.9cf0	20 1d d7	jsr $d71d	                jsr mos.LD71D
3044	.9cf3					L9CC3:
3045	.9cf3	bd 00 03	lda $0300,x	                lda $0300,x
3046	.9cf6	cd 42 03	cmp $0342	                cmp $0342
3047	.9cf9	bd 01 03	lda $0301,x	                lda $0301,x
3048	.9cfc	ed 43 03	sbc $0343	                sbc $0343
3049	.9cff	10 0d		bpl $9d0e	                bpl L9CDE
3050	.9d01	bd 00 03	lda $0300,x	                lda $0300,x
3051	.9d04	8d 42 03	sta $0342	                sta $0342
3052	.9d07	bd 01 03	lda $0301,x	                lda $0301,x
3053	.9d0a	8d 43 03	sta $0343	                sta $0343
3054	.9d0d	60		rts		                rts

3056	.9d0e					L9CDE:
3057	.9d0e	ad 46 03	lda $0346	                lda $0346
3058	.9d11	dd 00 03	cmp $0300,x	                cmp $0300,x
3059	.9d14	ad 47 03	lda $0347	                lda $0347
3060	.9d17	fd 01 03	sbc $0301,x	                sbc $0301,x
3061	.9d1a	10 0c		bpl $9d28	                bpl L9CF8
3062	.9d1c	bd 00 03	lda $0300,x	                lda $0300,x
3063	.9d1f	8d 46 03	sta $0346	                sta $0346
3064	.9d22	bd 01 03	lda $0301,x	                lda $0301,x
3065	.9d25	8d 47 03	sta $0347	                sta $0347
3066	.9d28					L9CF8:
3067	.9d28	60		rts		                rts

3069	.9d29					L9CF9:
3070	.9d29	20 a1 dd	jsr $dda1	                jsr mos.LDDA1
3071	.9d2c	9c 36 03	stz $0336	                stz $0336
3072	.9d2f	9c 37 03	stz $0337	                stz $0337
3073	.9d32	20 b0 dc	jsr $dcb0	                jsr mos.LDCB0
3074	.9d35	d0 4f		bne $9d86	                bne L9D56
3075	.9d37	20 1c dc	jsr $dc1c	                jsr mos.LDC1C
3076	.9d3a					L9D0A:
3077	.9d3a	24 ff		bit $ff		                bit $FF
3078	.9d3c	30 48		bmi $9d86	                bmi L9D56
3079	.9d3e	ad 36 03	lda $0336	                lda $0336
3080	.9d41	cd 37 03	cmp $0337	                cmp $0337
3081	.9d44	f0 40		beq $9d86	                beq L9D56
3082	.9d46	1a		inc a		                inc a
3083	.9d47	8d 36 03	sta $0336	                sta $0336
3084	.9d4a	aa		tax		                tax
3085	.9d4b	bd 00 84	lda $8400,x	                lda L8400,x
3086	.9d4e	8d 28 03	sta $0328	                sta $0328
3087	.9d51	bd 00 85	lda $8500,x	                lda L8500,x
3088	.9d54	8d 2c 03	sta $032c	                sta $032C
3089	.9d57	bd 00 86	lda $8600,x	                lda L8600,x
3090	.9d5a	48		pha		                pha
3091	.9d5b	4a		lsr a		                lsr a
3092	.9d5c	4a		lsr a		                lsr a
3093	.9d5d	8d 29 03	sta $0329	                sta $0329
3094	.9d60	68		pla		                pla
3095	.9d61	29 03		and #$03	                and #$03
3096	.9d63	8d 2d 03	sta $032d	                sta $032D
3097	.9d66	bd 00 87	lda $8700,x	                lda L8700,x
3098	.9d69	9c 2b 03	stz $032b	                stz $032B
3099	.9d6c	cd 06 03	cmp $0306	                cmp $0306
3100	.9d6f	f0 0a		beq $9d7b	                beq L9D4B
3101	.9d71	85 e0		sta $e0		                sta $E0
3102	.9d73	1a		inc a		                inc a
3103	.9d74	20 48 dc	jsr $dc48	                jsr mos.LDC48
3104	.9d77	b0 0d		bcs $9d86	                bcs L9D56
3105	.9d79	a5 e0		lda $e0		                lda $E0
3106	.9d7b					L9D4B:
3107	.9d7b	cd 02 03	cmp $0302	                cmp $0302
3108	.9d7e	f0 ba		beq $9d3a	                beq L9D0A
3109	.9d80	3a		dec a		                dec a
3110	.9d81	20 48 dc	jsr $dc48	                jsr mos.LDC48
3111	.9d84	90 b4		bcc $9d3a	                bcc L9D0A
3112	.9d86					L9D56:
3113	.9d86	60		rts		                rts

3115	.9d87					L9D57:
3116	.9d87	ad 32 03	lda $0332	                lda $0332
3117	.9d8a	a8		tay		                tay
3118	.9d8b	cd 2c 03	cmp $032c	                cmp $032C
3119	.9d8e	ad 33 03	lda $0333	                lda $0333
3120	.9d91	aa		tax		                tax
3121	.9d92	ed 2d 03	sbc $032d	                sbc $032D
3122	.9d95	b0 0a		bcs $9da1	                bcs L9D71
3123	.9d97	c8		iny		                iny
3124	.9d98	d0 01		bne $9d9b	                bne L9D6B
3125	.9d9a	e8		inx		                inx
3126	.9d9b					L9D6B:
3127	.9d9b	8c 2e 03	sty $032e	                sty $032E
3128	.9d9e	8e 2f 03	stx $032f	                stx $032F
3129	.9da1					L9D71:
3130	.9da1	60		rts		                rts

3132						;-------------------------------------------------------------------------

3134						                .if version>=500
3135	.9da2					readDefaults2:
3136	.9da2	a2 0f		ldx #$0f	                ldx #CMOSBytes.defaults2
3137	.9da4	80 24		bra $9dca	                bra readRTCByte
3138						                .endif

3140						;-------------------------------------------------------------------------

3142						                .if version>=500
3143	.9da6					readDefaults3:
3144	.9da6	a2 10		ldx #$10	                ldx #CMOSBytes.defaults3
3145	.9da8	80 20		bra $9dca	                bra readRTCByte
3146						                .endif

3148						;-------------------------------------------------------------------------

3150						                .if version>=500
3151	.9daa					readCMOSByte:
3152	.9daa	e0 ff		cpx #$ff	                cpx #$ff
3153	.9dac	d0 1c		bne $9dca	                bne readRTCByte
3154	.9dae	20 7e 90	jsr $907e	                jsr L907E
3155	.9db1	a0 00		ldy #$00	                ldy #0
3156	.9db3	b0 2b		bcs $9de0	                bcs L9DE0
3157	.9db5	a2 7f		ldx #$7f	                ldx #$7f
3158	.9db7	20 ca 9e	jsr $9eca	                jsr L9ECA
3159	.9dba	5a		phy		                phy
3160	.9dbb	a2 ff		ldx #$ff	                ldx #$ff
3161	.9dbd	20 ca 9e	jsr $9eca	                jsr L9ECA
3162	.9dc0	98		tya		                tya
3163	.9dc1	ba		tsx		                tsx
3164	.9dc2	5d 01 01	eor $0101,x	                eor $101,x
3165	.9dc5	09 7f		ora #$7f	                ora #$7f
3166	.9dc7	a8		tay		                tay
3167	.9dc8	80 15		bra $9ddf	                bra L9DDF
3168						                .endif

3170						                .if version>=500
3171	.9dca					readRTCByte:
3172	.9dca	da		phx		                phx
3173	.9dcb	20 7e 90	jsr $907e	                jsr L907E
3174	.9dce	90 0b		bcc $9ddb	                bcc L9DDB
3175	.9dd0					L9DD0:
3176	.9dd0	a0 00		ldy #$00	                ldy #0
3177						                .if version>=511||olivetti
3179						                .else
3180	.9dd2	e0 13		cpx #$13	                cpx #$13
3181						                .endif
3182	.9dd4	b0 08		bcs $9dde	                bcs L9DDE
3183	.9dd6	bc e4 9d	ldy $9de4,x	                ldy L9DE4,x
3184	.9dd9	80 03		bra $9dde	                bra L9DDE

3186	.9ddb					L9DDB:
3187	.9ddb	20 ca 9e	jsr $9eca	                jsr L9ECA
3188	.9dde					L9DDE:
3189	.9dde	98		tya		                tya
3190	.9ddf					L9DDF:
3191	.9ddf	fa		plx		                plx
3192	.9de0					L9DE0:
3193	.9de0	60		rts		                rts

3195	.9de1					L9DE1:
3196	.9de1	da		phx		                phx
3197	.9de2	80 ec		bra $9dd0	                bra L9DD0

3199	.9de4					L9DE4:
3200						                ; Default CMOS contents?
3201	>9de4	00				                .byte 0
3202	>9de5	fe				                .byte $FE
3203	>9de6	00				                .byte 0
3204	>9de7	eb				                .byte $EB
3205	>9de8	00				                .byte 0
3206	>9de9	ed				                .byte $ED
3207	>9dea	ff				                .byte $FF
3208	>9deb	ff				                .byte $FF
3209	>9dec	00				                .byte 0
3210	>9ded	00				                .byte 0
3211						                .if version>=511||olivetti
3213						                .else
3214	>9dee	f7				                .byte $F7
3215						                .endif
3216	>9def	e3				                .byte $E3
3217	>9df0	20				                .byte $20
3218	>9df1	08				                .byte 8
3219	>9df2	0a				                .byte $A
3220	>9df3	2c				                .byte $2C
3221	>9df4	80				                .byte $80
3222	>9df5	00				                .byte 0
3223	>9df6	03				                .byte 3
3224						                .if version>=511||olivetti
3226						                .endif
3227						                .endif

3229						;-------------------------------------------------------------------------

3231						                .if version>=500
3232	.9df7					L9DF7:
3233	.9df7	60		rts		                rts
3234						                .endif

3236						;-------------------------------------------------------------------------

3238						                .if version>=500
3239	.9df8					writeCMOSByte:
3240	.9df8	8a		txa		                txa
3241	.9df9	29 7f		and #$7f	                and #$7f
3242	.9dfb	f0 fa		beq $9df7	                beq L9DF7
3243	.9dfd	09 80		ora #$80	                ora #$80
3244	.9dff	1a		inc a		                inc a
3245	.9e00	f0 f5		beq $9df7	                beq L9DF7
3246	.9e02					writeRTCByte:
3247	.9e02	da		phx		                phx
3248	.9e03	5a		phy		                phy
3249	.9e04	20 99 9e	jsr $9e99	                jsr L9E99
3250	.9e07	7a		ply		                ply
3251	.9e08	fa		plx		                plx
3252	.9e09	60		rts		                rts
3253						                .endif

3255						;-------------------------------------------------------------------------

3257						                .if version>=500
3258	.9e0a					L9E0A:
3259	.9e0a	08		php		                php
3260	.9e0b	78		sei		                sei
3261	.9e0c	20 27 9e	jsr $9e27	                jsr L9E27
3262	.9e0f	20 80 9e	jsr $9e80	                jsr L9E80
3263	.9e12	20 1a 9e	jsr $9e1a	                jsr L9E1A
3264	.9e15	20 27 9e	jsr $9e27	                jsr L9E27
3265	.9e18	28		plp		                plp
3266	.9e19	60		rts		                rts
3267						                .endif

3269						;-------------------------------------------------------------------------

3271						                .if version>=500
3272	.9e1a					L9E1A:
3273	.9e1a	48		pha		                pha
3274	.9e1b	ad 40 fe	lda $fe40	                lda systemVIA.irb
3275	.9e1e	29 df		and #$df	                and #$df
3276	.9e20	09 20		ora #$20	                ora #$20
3277	.9e22	8d 40 fe	sta $fe40	                sta systemVIA.orb
3278	.9e25	68		pla		                pla
3279	.9e26	60		rts		                rts
3280						                .endif

3282						;-------------------------------------------------------------------------

3284						                .if version>=500
3285	.9e27					L9E27:
3286	.9e27	48		pha		                pha
3287	.9e28	ad 40 fe	lda $fe40	                lda systemVIA.irb
3288	.9e2b	29 df		and #$df	                and #$df
3289	.9e2d	8d 40 fe	sta $fe40	                sta systemVIA.orb
3290	.9e30	68		pla		                pla
3291	.9e31	60		rts		                rts
3292						                .endif

3294						;-------------------------------------------------------------------------

3296						                .if version>=500
3297	.9e32					L9E32:
3298	.9e32	08		php		                php
3299	.9e33	78		sei		                sei
3300	.9e34	ad 42 fe	lda $fe42	                lda systemVIA.ddrb
3301	.9e37	09 30		ora #$30	                ora #$30
3302	.9e39	8d 42 fe	sta $fe42	                sta systemVIA.ddrb
3303	.9e3c	20 27 9e	jsr $9e27	                jsr L9E27
3304	.9e3f	20 82 9e	jsr $9e82	                jsr L9E82
3305	.9e42	20 1a 9e	jsr $9e1a	                jsr L9E1A
3306	.9e45	20 4d 9e	jsr $9e4d	                jsr L9E4D
3307	.9e48	20 27 9e	jsr $9e27	                jsr L9E27
3308	.9e4b	28		plp		                plp
3309	.9e4c	60		rts		                rts
3310						                .endif

3312						;-------------------------------------------------------------------------

3314						                .if version>=500
3315	.9e4d					L9E4D:
3316	.9e4d	48		pha		                pha
3317	.9e4e	ad 40 fe	lda $fe40	                lda systemVIA.irb
3318	.9e51	29 ef		and #$ef	                and #$ef
3319	.9e53	8d 40 fe	sta $fe40	                sta systemVIA.orb
3320	.9e56	68		pla		                pla
3321	.9e57	60		rts		                rts
3322						                .endif

3324						;-------------------------------------------------------------------------

3326						                .if version>=500
3327	.9e58					L9E58:
3328	.9e58	20 32 9e	jsr $9e32	                jsr L9E32
3329	.9e5b	a9 00		lda #$00	                lda #0
3330	.9e5d	20 23 9f	jsr $9f23	                jsr L9F23
3331	.9e60	a9 06		lda #$06	                lda #6
3332	.9e62	20 23 9f	jsr $9f23	                jsr L9F23
3333	.9e65					L9E65:
3334	.9e65	08		php		                php
3335	.9e66	78		sei		                sei
3336	.9e67	20 27 9e	jsr $9e27	                jsr L9E27
3337	.9e6a	20 4d 9e	jsr $9e4d	                jsr L9E4D
3338	.9e6d	20 1a 9e	jsr $9e1a	                jsr L9E1A
3339	.9e70	20 82 9e	jsr $9e82	                jsr L9E82
3340	.9e73	20 27 9e	jsr $9e27	                jsr L9E27
3341	.9e76	ad 42 fe	lda $fe42	                lda systemVIA.ddrb
3342	.9e79	29 cf		and #$cf	                and #$cf
3343	.9e7b	8d 42 fe	sta $fe42	                sta systemVIA.ddrb
3344	.9e7e	28		plp		                plp
3345	.9e7f	60		rts		                rts
3346						                .endif

3348						;-------------------------------------------------------------------------

3350						                .if version>=500
3351	.9e80					L9E80:
3352	.9e80	90 cb		bcc $9e4d	                bcc L9E4D
3353	.9e82					L9E82:
3354	.9e82	48		pha		                pha
3355	.9e83	ad 40 fe	lda $fe40	                lda systemVIA.irb
3356	.9e86	09 10		ora #$10	                ora #$10
3357	.9e88	8d 40 fe	sta $fe40	                sta systemVIA.orb
3358	.9e8b	68		pla		                pla
3359	.9e8c	60		rts		                rts
3360						                .endif

3362						;-------------------------------------------------------------------------

3364						                .if version>=500
3365	.9e8d					L9E8D:
3366	.9e8d	08		php		                php
3367	.9e8e	78		sei		                sei
3368	.9e8f	38		sec		                sec
3369	.9e90	2a		rol a		                rol a
3370	.9e91					L9E91:
3371	.9e91	20 0a 9e	jsr $9e0a	                jsr L9E0A
3372	.9e94	0a		asl a		                asl a
3373	.9e95	d0 fa		bne $9e91	                bne L9E91
3374	.9e97	28		plp		                plp
3375	.9e98	60		rts		                rts
3376						                .endif

3378						;-------------------------------------------------------------------------

3380						                .if version>=500
3381	.9e99					L9E99:
3382	.9e99	da		phx		                phx
3383	.9e9a	5a		phy		                phy
3384	.9e9b	20 ca 9e	jsr $9eca	                jsr L9ECA
3385	.9e9e	b0 07		bcs $9ea7	                bcs L9EA7
3386	.9ea0	98		tya		                tya
3387	.9ea1	ba		tsx		                tsx
3388	.9ea2	5d 01 01	eor $0101,x	                eor $101,x
3389	.9ea5	c9 01		cmp #$01	                cmp #1
3390	.9ea7					L9EA7:
3391	.9ea7	7a		ply		                ply
3392	.9ea8	fa		plx		                plx
3393	.9ea9	b0 01		bcs $9eac	                bcs L9EAC_500
3394	.9eab	60		rts		                rts

3396	.9eac					L9EAC_500:
3397	.9eac	20 32 9e	jsr $9e32	                jsr L9E32
3398	.9eaf	a9 a0		lda #$a0	                lda #$a0
3399	.9eb1	20 23 9f	jsr $9f23	                jsr L9F23
3400	.9eb4	8a		txa		                txa
3401	.9eb5	20 23 9f	jsr $9f23	                jsr L9F23
3402	.9eb8	98		tya		                tya
3403	.9eb9	20 23 9f	jsr $9f23	                jsr L9F23
3404	.9ebc	20 65 9e	jsr $9e65	                jsr L9E65
3405	.9ebf	a0 a0		ldy #$a0	                ldy #$a0
3406	.9ec1	a2 00		ldx #$00	                ldx #0
3407	.9ec3					L9EC3:
3408	.9ec3	ca		dex		                dex
3409	.9ec4	d0 fd		bne $9ec3	                bne L9EC3
3410	.9ec6	88		dey		                dey
3411	.9ec7	d0 fa		bne $9ec3	                bne L9EC3
3412	.9ec9	60		rts		                rts

3414	.9eca					L9ECA:
3415	.9eca	20 32 9e	jsr $9e32	                jsr L9E32
3416						                .if version<500
3418						                .elsif version>=500
3419	.9ecd	a9 a0		lda #$a0	                lda #$a0
3420						                .endif
3421	.9ecf	20 23 9f	jsr $9f23	                jsr L9F23
3422	.9ed2	8a		txa		                txa
3423	.9ed3	20 23 9f	jsr $9f23	                jsr L9F23
3424	.9ed6	b0 36		bcs $9f0e	                bcs L9F0E_500
3425	.9ed8	20 32 9e	jsr $9e32	                jsr L9E32
3426	.9edb	a9 a1		lda #$a1	                lda #$a1
3427	.9edd	20 23 9f	jsr $9f23	                jsr L9F23
3428	.9ee0	b0 2c		bcs $9f0e	                bcs L9F0E_500
3429	.9ee2	20 27 9e	jsr $9e27	                jsr L9E27
3430	.9ee5	ad 42 fe	lda $fe42	                lda systemVIA.ddrb
3431	.9ee8	48		pha		                pha
3432	.9ee9	29 ef		and #$ef	                and #$ef
3433	.9eeb	8d 42 fe	sta $fe42	                sta systemVIA.ddrb
3434	.9eee	a9 01		lda #$01	                lda #1
3435	.9ef0					L9EF0:
3436	.9ef0	48		pha		                pha
3437	.9ef1	20 1a 9e	jsr $9e1a	                jsr L9E1A
3438	.9ef4	ea		nop		                nop
3439	.9ef5	ea		nop		                nop
3440	.9ef6	ad 40 fe	lda $fe40	                lda systemVIA.irb
3441	.9ef9	29 10		and #$10	                and #$10
3442	.9efb	c9 01		cmp #$01	                cmp #1
3443	.9efd	20 27 9e	jsr $9e27	                jsr L9E27
3444	.9f00	68		pla		                pla
3445	.9f01	2a		rol a		                rol a
3446	.9f02	90 ec		bcc $9ef0	                bcc L9EF0
3447	.9f04	a8		tay		                tay
3448	.9f05	68		pla		                pla
3449	.9f06	8d 42 fe	sta $fe42	                sta systemVIA.ddrb
3450	.9f09	38		sec		                sec
3451	.9f0a	20 0a 9e	jsr $9e0a	                jsr L9E0A
3452	.9f0d	18		clc		                clc
3453	.9f0e					L9F0E_500:
3454	.9f0e	4c 65 9e	jmp $9e65	                jmp L9E65
3455						                .endif

3457						;-------------------------------------------------------------------------

3459						                .if version>=500
3460	.9f11					L9F11:
3461	.9f11	20 32 9e	jsr $9e32	                jsr L9E32
3462	.9f14	a9 a0		lda #$a0	                lda #$a0
3463	.9f16	20 23 9f	jsr $9f23	                jsr L9F23
3464	.9f19	8a		txa		                txa
3465	.9f1a	20 23 9f	jsr $9f23	                jsr L9F23
3466	.9f1d	08		php		                php
3467	.9f1e	20 65 9e	jsr $9e65	                jsr L9E65
3468	.9f21	28		plp		                plp
3469	.9f22	60		rts		                rts
3470						                .endif

3472						;-------------------------------------------------------------------------

3474						                .if version>=500
3475	.9f23					L9F23:
3476	.9f23	08		php		                php
3477	.9f24	78		sei		                sei
3478	.9f25	20 8d 9e	jsr $9e8d	                jsr L9E8D
3479	.9f28	20 27 9e	jsr $9e27	                jsr L9E27
3480	.9f2b	ad 42 fe	lda $fe42	                lda systemVIA.ddrb
3481	.9f2e	48		pha		                pha
3482	.9f2f	29 ef		and #$ef	                and #$ef
3483	.9f31	8d 42 fe	sta $fe42	                sta systemVIA.ddrb
3484	.9f34	20 1a 9e	jsr $9e1a	                jsr L9E1A
3485	.9f37	ea		nop		                nop
3486	.9f38	ea		nop		                nop
3487	.9f39	ad 40 fe	lda $fe40	                lda systemVIA.irb
3488	.9f3c	29 10		and #$10	                and #$10
3489	.9f3e	c9 01		cmp #$01	                cmp #1
3490	.9f40	20 27 9e	jsr $9e27	                jsr L9E27
3491	.9f43	68		pla		                pla
3492	.9f44	8d 42 fe	sta $fe42	                sta systemVIA.ddrb
3493	.9f47	b0 03		bcs $9f4c	                bcs L9F4C
3494	.9f49	28		plp		                plp
3495	.9f4a	18		clc		                clc
3496	.9f4b					L9F4B:
3497	.9f4b	60		rts		                rts

3499	.9f4c					L9F4C:
3500	.9f4c	28		plp		                plp
3501	.9f4d	38		sec		                sec
3502	.9f4e	60		rts		                rts
3503						                .endif

3505						;-------------------------------------------------------------------------

3507						                .if version>=500
3508						                .include "sound_stuff.s65"

:12	;******  Processing file: src/sound_stuff.s65

1						; Table to convert channel number to the bits required by the chip
2	.9f4f					soundParameterTable:
3	>9f4f	e0 c0 a0 80			                .byte $e0,$c0,$a0,$80

5						;-------------------------------------------------------------------------

7	.9f53					LF413:
8	.9f53	4c 60 a0	jmp $a060	                jmp LF520

10						;-------------------------------------------------------------------------

12	.9f56					LF416:
13	.9f56	a2 00		ldx #$00	                ldx #$00
14	.9f58	ad 38 08	lda $0838	                lda $0838
15	.9f5b	d0 04		bne $9f61	                bne LF421
16	.9f5d	e8		inx		                inx
17	.9f5e	ce 38 08	dec $0838	                dec $0838
18	.9f61					LF421:
19	.9f61	8e 3b 08	stx $083b	                stx $083B
20	.9f64	a2 08		ldx #$08	                ldx #$08
21	.9f66					LF426:
22	.9f66	ca		dex		                dex
23	.9f67	bd 00 08	lda $0800,x	                lda $0800,x
24	.9f6a	f0 e7		beq $9f53	                beq LF413
25	.9f6c	bd ce 02	lda $02ce,x	                lda bufferEmptyFlags,x
26	.9f6f	30 05		bmi $9f76	                bmi LF436
27	.9f71	bd 18 08	lda $0818,x	                lda $0818,x
28	.9f74	d0 08		bne $9f7e	                bne LF43E
29	.9f76					LF436:
30	.9f76	20 68 a0	jsr $a068	                jsr LF528
31	.9f79	bd 18 08	lda $0818,x	                lda $0818,x
32	.9f7c	f0 12		beq $9f90	                beq LF450
33	.9f7e					LF43E:
34	.9f7e	1a		inc a		                inc a
35	.9f7f	f0 12		beq $9f93	                beq LF453
36	.9f81	de 1c 08	dec $081c,x	                dec $081C,x
37	.9f84	d0 0d		bne $9f93	                bne LF453
38	.9f86	a9 05		lda #$05	                lda #$05
39	.9f88	9d 1c 08	sta $081c,x	                sta $081C,x
40	.9f8b	de 18 08	dec $0818,x	                dec $0818,x
41	.9f8e	d0 03		bne $9f93	                bne LF453
42	.9f90					LF450:
43	.9f90	20 68 a0	jsr $a068	                jsr LF528
44	.9f93					LF453:
45	.9f93	bd 24 08	lda $0824,x	                lda $0824,x
46	.9f96	f0 05		beq $9f9d	                beq LF45D
47	.9f98	de 24 08	dec $0824,x	                dec $0824,x
48	.9f9b	d0 b6		bne $9f53	                bne LF413
49	.9f9d					LF45D:
50	.9f9d	bc 20 08	ldy $0820,x	                ldy $0820,x
51	.9fa0	c0 ff		cpy #$ff	                cpy #$FF
52	.9fa2	f0 af		beq $9f53	                beq LF413
53	.9fa4	b9 c0 08	lda $08c0,y	                lda $08C0,y
54	.9fa7	29 7f		and #$7f	                and #$7F
55	.9fa9	9d 24 08	sta $0824,x	                sta $0824,x
56	.9fac	bd 08 08	lda $0808,x	                lda $0808,x
57	.9faf	c9 04		cmp #$04	                cmp #$04
58	.9fb1	f0 5d		beq $a010	                beq LF4D0
59	.9fb3	18		clc		                clc
60	.9fb4	7d 20 08	adc $0820,x	                adc $0820,x
61	.9fb7	a8		tay		                tay
62	.9fb8	b9 cb 08	lda $08cb,y	                lda $08CB,y
63	.9fbb	38		sec		                sec
64	.9fbc	e9 3f		sbc #$3f	                sbc #$3F
65	.9fbe	8d 3a 08	sta $083a	                sta $083A
66	.9fc1	b9 c7 08	lda $08c7,y	                lda $08C7,y
67	.9fc4	8d 39 08	sta $0839	                sta $0839
68	.9fc7	bd 04 08	lda $0804,x	                lda $0804,x
69	.9fca					LF48A:
70	.9fca	48		pha		                pha
71	.9fcb	18		clc		                clc
72	.9fcc	6d 39 08	adc $0839	                adc $0839
73	.9fcf	50 07		bvc $9fd8	                bvc LF498
74	.9fd1	2a		rol a		                rol a
75	.9fd2	a9 3f		lda #$3f	                lda #$3F
76	.9fd4	b0 02		bcs $9fd8	                bcs LF498
77	.9fd6	49 ff		eor #$ff	                eor #$FF
78	.9fd8					LF498:
79	.9fd8	9d 04 08	sta $0804,x	                sta $0804,x
80	.9fdb	2a		rol a		                rol a
81	.9fdc	5d 04 08	eor $0804,x	                eor $0804,x
82	.9fdf	10 09		bpl $9fea	                bpl LF4AA
83	.9fe1	a9 3f		lda #$3f	                lda #$3F
84	.9fe3	90 02		bcc $9fe7	                bcc LF4A7
85	.9fe5	49 ff		eor #$ff	                eor #$FF
86	.9fe7					LF4A7:
87	.9fe7	9d 04 08	sta $0804,x	                sta $0804,x
88	.9fea					LF4AA:
89	.9fea	ce 39 08	dec $0839	                dec $0839
90	.9fed	bd 04 08	lda $0804,x	                lda $0804,x
91	.9ff0	38		sec		                sec
92	.9ff1	ed 3a 08	sbc $083a	                sbc $083A
93	.9ff4	4d 39 08	eor $0839	                eor $0839
94	.9ff7	30 09		bmi $a002	                bmi LF4C2
95	.9ff9	ad 3a 08	lda $083a	                lda $083A
96	.9ffc	9d 04 08	sta $0804,x	                sta $0804,x
97	.9fff	fe 08 08	inc $0808,x	                inc $0808,x
98	.a002					LF4C2:
99	.a002	68		pla		                pla
100	.a003	5d 04 08	eor $0804,x	                eor $0804,x
101	.a006	29 f8		and #$f8	                and #$F8
102	.a008	f0 06		beq $a010	                beq LF4D0
103	.a00a	bd 04 08	lda $0804,x	                lda $0804,x
104	.a00d	20 d9 a0	jsr $a0d9	                jsr LF599
105	.a010					LF4D0:
106	.a010	bd 10 08	lda $0810,x	                lda $0810,x
107	.a013	c9 03		cmp #$03	                cmp #$03
108	.a015	f0 49		beq $a060	                beq LF520
109	.a017	bd 14 08	lda $0814,x	                lda $0814,x
110	.a01a	d0 28		bne $a044	                bne LF504
111	.a01c	fe 10 08	inc $0810,x	                inc $0810,x
112	.a01f	bd 10 08	lda $0810,x	                lda $0810,x
113	.a022	c9 03		cmp #$03	                cmp #$03
114	.a024	d0 0e		bne $a034	                bne LF4F4
115	.a026	bc 20 08	ldy $0820,x	                ldy $0820,x
116	.a029	b9 c0 08	lda $08c0,y	                lda $08C0,y
117	.a02c	30 32		bmi $a060	                bmi LF520
118	.a02e	9e 30 08	stz $0830,x	                stz $0830,x
119	.a031	9e 10 08	stz $0810,x	                stz $0810,x
120	.a034					LF4F4:
121	.a034	bd 10 08	lda $0810,x	                lda $0810,x
122	.a037	18		clc		                clc
123	.a038	7d 20 08	adc $0820,x	                adc $0820,x
124	.a03b	a8		tay		                tay
125	.a03c	b9 c4 08	lda $08c4,y	                lda $08C4,y
126	.a03f	9d 14 08	sta $0814,x	                sta $0814,x
127	.a042	f0 1c		beq $a060	                beq LF520
128	.a044					LF504:
129	.a044	de 14 08	dec $0814,x	                dec $0814,x
130	.a047	bd 20 08	lda $0820,x	                lda $0820,x
131	.a04a	18		clc		                clc
132	.a04b	7d 10 08	adc $0810,x	                adc $0810,x
133	.a04e	a8		tay		                tay
134	.a04f	b9 c1 08	lda $08c1,y	                lda $08C1,y
135	.a052	18		clc		                clc
136	.a053	7d 30 08	adc $0830,x	                adc $0830,x
137	.a056	9d 30 08	sta $0830,x	                sta $0830,x
138	.a059	18		clc		                clc
139	.a05a	7d 0c 08	adc $080c,x	                adc $080C,x
140	.a05d	20 15 a1	jsr $a115	                jsr LF5D5
141	.a060					LF520:
142	.a060	e0 04		cpx #$04	                cpx #$04
143	.a062	f0 03		beq $a067	                beq LF527
144	.a064	4c 66 9f	jmp $9f66	                jmp LF426

146	.a067					LF527:
147	.a067	60		rts		                rts

149	.a068					LF528:
150	.a068	bd 08 08	lda $0808,x	                lda $0808,x
151	.a06b	c9 04		cmp #$04	                cmp #$04
152	.a06d	f0 05		beq $a074	                beq LF534
153	.a06f	a9 03		lda #$03	                lda #$03
154	.a071	9d 08 08	sta $0808,x	                sta $0808,x
155	.a074					LF534:
156	.a074	bd ce 02	lda $02ce,x	                lda bufferEmptyFlags,x
157	.a077	f0 14		beq $a08d	                beq LF54D
158	.a079	a9 00		lda #$00	                lda #$00
159	.a07b	9e ce 02	stz $02ce,x	                stz bufferEmptyFlags,x
160	.a07e	a0 04		ldy #$04	                ldy #$04
161	.a080					LF540:
162	.a080	99 2b 08	sta $082b,y	                sta $082B,y
163	.a083	88		dey		                dey
164	.a084	d0 fa		bne $a080	                bne LF540
165	.a086	9e 18 08	stz $0818,x	                stz $0818,x
166	.a089	88		dey		                dey
167	.a08a	8c 38 08	sty $0838	                sty $0838
168	.a08d					LF54D:
169	.a08d	bd 28 08	lda $0828,x	                lda $0828,x
170	.a090	f0 60		beq $a0f2	                beq LF5B2
171	.a092	ad 3b 08	lda $083b	                lda $083B
172	.a095	f0 34		beq $a0cb	                beq LF58B
173	.a097	9e 28 08	stz $0828,x	                stz $0828,x
174	.a09a					LF55A:
175	.a09a	4c c5 a1	jmp $a1c5	                jmp LF685

177						;-------------------------------------------------------------------------
178						;
179						; Clear a buffer that's a sound channel.
180						;
181						; https://tobylobster.github.io/mos/mos/S-s16.html#SP7
182						;
183						; Entry:
184						;
185						; X = buffer number (must be a sound channel buffer)
186						;
187						                .if version==350
191						                .else
192	.a09d					clearSoundChannelBuffer:
193						                .endif
194						                .block
195	.a09d	20 d2 a0	jsr $a0d2	                jsr LF592
196	.a0a0	98		tya		                tya
197	.a0a1	9e 18 08	stz $0818,x	                stz $0818,x
198	.a0a4	9e ce 02	stz $02ce,x	                stz bufferEmptyFlags,x
199	.a0a7	9e 00 08	stz $0800,x	                stz $0800,x
200	.a0aa	a0 03		ldy #$03	                ldy #$03
201	.a0ac					loop:
202	.a0ac	99 2c 08	sta $082c,y	                sta $082C,y
203	.a0af	88		dey		                dey
204	.a0b0	10 fa		bpl $a0ac	                bpl loop
205	.a0b2	8c 38 08	sty $0838	                sty $0838
206	.a0b5	80 63		bra $a11a	                bra LF5DA
207						                .endblock

209						;-------------------------------------------------------------------------

211	.a0b7					LF577:
212	.a0b7	08		php		                php
213	.a0b8	78		sei		                sei
214	.a0b9	bd 08 08	lda $0808,x	                lda $0808,x
215	.a0bc	c9 04		cmp #$04	                cmp #$04
216	.a0be	d0 0a		bne $a0ca	                bne LF58A
217	.a0c0	20 1a eb	jsr $eb1a	                jsr mos.osbyte98
218	.a0c3	90 05		bcc $a0ca	                bcc LF58A
219	.a0c5	a9 00		lda #$00	                lda #$00
220	.a0c7	9e 00 08	stz $0800,x	                stz $0800,x
221	.a0ca					LF58A:
222	.a0ca	28		plp		                plp
223	.a0cb					LF58B:
224	.a0cb	bc 20 08	ldy $0820,x	                ldy $0820,x
225	.a0ce	c0 ff		cpy #$ff	                cpy #$FF
226	.a0d0	d0 72		bne $a144	                bne LF604

228						                ; https://tobylobster.github.io/mos/mos/S-s16.html#SP2
229	.a0d2					LF592:
230	.a0d2	a9 04		lda #$04	                lda #$04
231	.a0d4	9d 08 08	sta $0808,x	                sta $0808,x
232	.a0d7	a9 c0		lda #$c0	                lda #$C0
233	.a0d9					LF599:
234	.a0d9	9d 04 08	sta $0804,x	                sta $0804,x
235	.a0dc	ac 62 02	ldy $0262	                ldy soundSuppressionStatus
236	.a0df	f0 02		beq $a0e3	                beq LF5A3
237	.a0e1	a9 c0		lda #$c0	                lda #$C0
238	.a0e3					LF5A3:
239	.a0e3	38		sec		                sec
240	.a0e4	e9 40		sbc #$40	                sbc #$40
241	.a0e6	4a		lsr a		                lsr a
242	.a0e7	4a		lsr a		                lsr a
243	.a0e8	4a		lsr a		                lsr a
244	.a0e9	49 0f		eor #$0f	                eor #$0F
245	.a0eb	1d 4b 9f	ora $9f4b,x	                ora soundParameterTable-bufferNumberSound0,x
246	.a0ee	09 10		ora #$10	                ora #$10
247	.a0f0	80 34		bra $a126	                bra LF5E6

249	.a0f2					LF5B2:
250	.a0f2	20 1a eb	jsr $eb1a	                jsr mos.osbyte98
251	.a0f5	b0 c0		bcs $a0b7	                bcs LF577
252	.a0f7	29 03		and #$03	                and #$03
253	.a0f9	f0 9f		beq $a09a	                beq LF55A
254	.a0fb	ad 38 08	lda $0838	                lda $0838
255	.a0fe	f0 cb		beq $a0cb	                beq LF58B
256	.a100	fe 28 08	inc $0828,x	                inc $0828,x
257	.a103	a8		tay		                tay
258	.a104	10 0a		bpl $a110	                bpl LF5D0
259	.a106	20 1a eb	jsr $eb1a	                jsr mos.osbyte98
260	.a109	29 03		and #$03	                and #$03
261	.a10b	8d 38 08	sta $0838	                sta $0838
262	.a10e	80 bb		bra $a0cb	                bra LF58B

264	.a110					LF5D0:
265	.a110	ce 38 08	dec $0838	                dec $0838
266	.a113	80 b6		bra $a0cb	                bra LF58B

268	.a115					LF5D5:
269	.a115	dd 2c 08	cmp $082c,x	                cmp $082C,x
270	.a118	f0 2a		beq $a144	                beq LF604
271	.a11a					LF5DA:
272	.a11a	9d 2c 08	sta $082c,x	                sta $082C,x
273	.a11d	e0 04		cpx #$04	                cpx #$04
274	.a11f	d0 24		bne $a145	                bne LF605
275	.a121	29 0f		and #$0f	                and #$0F
276	.a123	1d 4b 9f	ora $9f4b,x	                ora soundParameterTable-bufferNumberSound0,x
277	.a126					LF5E6:
278	.a126	08		php		                php
279	.a127					LF5E7:
280	.a127	78		sei		                sei
281	.a128	a0 ff		ldy #$ff	                ldy #$FF
282	.a12a	8c 43 fe	sty $fe43	                sty systemVIA.ddra
283	.a12d	8d 4f fe	sta $fe4f	                sta systemVIA.oraNoHandshake
284	.a130	c8		iny		                iny
285	.a131	8c 40 fe	sty $fe40	                sty systemVIA.orb
286	.a134	a0 02		ldy #$02	                ldy #$02
287	.a136					LF5F6:
288	.a136	88		dey		                dey
289	.a137	d0 fd		bne $a136	                bne LF5F6
290	.a139	a0 08		ldy #$08	                ldy #$08
291	.a13b	8c 40 fe	sty $fe40	                sty systemVIA.orb
292	.a13e	a0 04		ldy #$04	                ldy #$04
293	.a140					LF600:
294	.a140	88		dey		                dey
295	.a141	d0 fd		bne $a140	                bne LF600
296	.a143	28		plp		                plp
297	.a144					LF604:
298	.a144	60		rts		                rts

300	.a145					LF605:
301	.a145	48		pha		                pha
302	.a146	29 03		and #$03	                and #$03
303	.a148	8d 3c 08	sta $083c	                sta $083C
304	.a14b	9c 3d 08	stz $083d	                stz $083D
305	.a14e	68		pla		                pla
306	.a14f	4a		lsr a		                lsr a
307	.a150	4a		lsr a		                lsr a
308	.a151					LF611:
309	.a151	c9 0c		cmp #$0c	                cmp #$0C
310	.a153	90 07		bcc $a15c	                bcc LF61C
311	.a155	ee 3d 08	inc $083d	                inc $083D
312	.a158	e9 0c		sbc #$0c	                sbc #$0C
313	.a15a	d0 f5		bne $a151	                bne LF611
314	.a15c					LF61C:
315	.a15c	a8		tay		                tay
316	.a15d	ad 3d 08	lda $083d	                lda $083D
317	.a160	48		pha		                pha
318	.a161	b9 24 a2	lda $a224,y	                lda LF6E4,y
319	.a164	8d 3d 08	sta $083d	                sta $083D
320	.a167	b9 30 a2	lda $a230,y	                lda LF6F0,y
321	.a16a	48		pha		                pha
322	.a16b	29 03		and #$03	                and #$03
323	.a16d	8d 3e 08	sta $083e	                sta $083E
324	.a170	68		pla		                pla
325						                .if version==350
327						                .else
328	.a171	4a		lsr a		                lsr a
329	.a172	4a		lsr a		                lsr a
330	.a173	4a		lsr a		                lsr a
331	.a174	4a		lsr a		                lsr a
332						                .endif
333	.a175	8d 3f 08	sta $083f	                sta $083F
334	.a178	ad 3d 08	lda $083d	                lda $083D
335	.a17b	ac 3c 08	ldy $083c	                ldy $083C
336	.a17e	f0 0c		beq $a18c	                beq LF64C
337	.a180					LF640:
338	.a180	38		sec		                sec
339	.a181	ed 3f 08	sbc $083f	                sbc $083F
340	.a184	b0 03		bcs $a189	                bcs LF649
341	.a186	ce 3e 08	dec $083e	                dec $083E
342	.a189					LF649:
343	.a189	88		dey		                dey
344	.a18a	d0 f4		bne $a180	                bne LF640
345	.a18c					LF64C:
346	.a18c	8d 3d 08	sta $083d	                sta $083D
347	.a18f	68		pla		                pla
348	.a190	a8		tay		                tay
349	.a191	f0 09		beq $a19c	                beq LF65C
350	.a193					LF653:
351	.a193	4e 3e 08	lsr $083e	                lsr $083E
352	.a196	6e 3d 08	ror $083d	                ror $083D
353	.a199	88		dey		                dey
354	.a19a	d0 f7		bne $a193	                bne LF653
355	.a19c					LF65C:
356	.a19c	ad 3d 08	lda $083d	                lda $083D
357	.a19f	18		clc		                clc
358	.a1a0	7d 75 e1	adc $e175,x	                adc mos.LE165,x
359	.a1a3	8d 3d 08	sta $083d	                sta $083D
360	.a1a6	90 03		bcc $a1ab	                bcc LF66B
361	.a1a8	ee 3e 08	inc $083e	                inc $083E
362	.a1ab					LF66B:
363	.a1ab	29 0f		and #$0f	                and #$0F
364	.a1ad	1d 4b 9f	ora $9f4b,x	                ora soundParameterTable-bufferNumberSound0,x
365	.a1b0	08		php		                php
366	.a1b1	78		sei		                sei
367	.a1b2	20 26 a1	jsr $a126	                jsr LF5E6
368	.a1b5	ad 3d 08	lda $083d	                lda $083D
369	.a1b8	4e 3e 08	lsr $083e	                lsr $083E
370	.a1bb	6a		ror a		                ror a
371	.a1bc	4e 3e 08	lsr $083e	                lsr $083E
372	.a1bf	6a		ror a		                ror a
373	.a1c0	4a		lsr a		                lsr a
374	.a1c1	4a		lsr a		                lsr a
375	.a1c2	4c 27 a1	jmp $a127	                jmp LF5E7

377	.a1c5					LF685:
378	.a1c5	08		php		                php
379	.a1c6	78		sei		                sei
380	.a1c7	20 1f eb	jsr $eb1f	                jsr mos.osbyte91
381	.a1ca	48		pha		                pha
382	.a1cb	29 04		and #$04	                and #$04
383	.a1cd	f0 13		beq $a1e2	                beq LF6A2
384	.a1cf	68		pla		                pla
385	.a1d0	bc 20 08	ldy $0820,x	                ldy $0820,x
386	.a1d3	c8		iny		                iny
387	.a1d4	d0 03		bne $a1d9	                bne LF699
388	.a1d6	20 d2 a0	jsr $a0d2	                jsr LF592
389	.a1d9					LF699:
390	.a1d9	20 1f eb	jsr $eb1f	                jsr mos.osbyte91
391	.a1dc	20 1f eb	jsr $eb1f	                jsr mos.osbyte91
392	.a1df	28		plp		                plp
393	.a1e0	80 3e		bra $a220	                bra LF6E0

395	.a1e2					LF6A2:
396	.a1e2	68		pla		                pla
397	.a1e3	29 f8		and #$f8	                and #$F8
398	.a1e5	0a		asl a		                asl a
399	.a1e6	90 0b		bcc $a1f3	                bcc LF6B3
400	.a1e8	49 ff		eor #$ff	                eor #$FF
401	.a1ea	4a		lsr a		                lsr a
402	.a1eb	38		sec		                sec
403	.a1ec	e9 40		sbc #$40	                sbc #$40
404	.a1ee	20 d9 a0	jsr $a0d9	                jsr LF599
405	.a1f1	a9 ff		lda #$ff	                lda #$FF
406	.a1f3					LF6B3:
407	.a1f3	9d 20 08	sta $0820,x	                sta $0820,x
408	.a1f6	a9 05		lda #$05	                lda #$05
409	.a1f8	9d 1c 08	sta $081c,x	                sta $081C,x
410	.a1fb	a9 01		lda #$01	                lda #$01
411	.a1fd	9d 24 08	sta $0824,x	                sta $0824,x
412	.a200	9e 14 08	stz $0814,x	                stz $0814,x
413	.a203	9e 08 08	stz $0808,x	                stz $0808,x
414	.a206	9e 30 08	stz $0830,x	                stz $0830,x
415	.a209	a9 ff		lda #$ff	                lda #$FF
416	.a20b	9d 10 08	sta $0810,x	                sta $0810,x
417	.a20e	20 1f eb	jsr $eb1f	                jsr mos.osbyte91
418	.a211	9d 0c 08	sta $080c,x	                sta $080C,x
419	.a214	20 1f eb	jsr $eb1f	                jsr mos.osbyte91
420	.a217	28		plp		                plp
421	.a218	48		pha		                pha
422	.a219	bd 0c 08	lda $080c,x	                lda $080C,x
423	.a21c	20 15 a1	jsr $a115	                jsr LF5D5
424	.a21f	68		pla		                pla
425	.a220					LF6E0:
426	.a220	9d 18 08	sta $0818,x	                sta $0818,x
427	.a223	60		rts		                rts

429	.a224					LF6E4:
430	>a224	f0				                .byte $F0
431	>a225	b7				                .byte $B7
432	>a226	82				                .byte $82
433	>a227	4f				                .byte $4F
434	>a228	20				                .byte $20
435	>a229	f3				                .byte $F3
436	>a22a	c8				                .byte $C8
437	>a22b	a0				                .byte $A0
438	>a22c	7b				                .byte $7B
439	>a22d	57				                .byte $57
440	>a22e	35				                .byte $35
441	>a22f	16				                .byte $16
442	.a230					LF6F0:
443	>a230	e7				                .byte $E7
444	>a231	d7				                .byte $D7
445	>a232	cb				                .byte $CB
446	>a233	c3				                .byte $C3
447	>a234	b7				                .byte $B7
448	>a235	aa				                .byte $AA
449	>a236	a2				                .byte $A2
450	>a237	9a				                .byte $9a
451	>a238	92				                .byte $92
452	>a239	8a				                .byte $8a
453	>a23a	82				                .byte $82
454	>a23b	7a				                .byte $7a

:5	;******  Return to file: src/terminal.s65

3509						                .endif

3511						;-------------------------------------------------------------------------

3513						                .if version==400
3515						                .endif

3517						;-------------------------------------------------------------------------
3518						;
3519						; Utils/Terminal ROM service entry point.
3520						;
3521	.a23c					utilsServiceEntryPoint:
3522						                .if version==400
3529						                .endif
3530						                .if version<500
3586						                .elsif version>=500
3587	.a23c	e0 0f		cpx #$0f	                cpx #15
3588	.a23e	f0 01		beq $a241	                beq utilsInCorrectBank
3589	.a240	60		rts		                rts
3590	.a241					utilsInCorrectBank:
3591	.a241	80 02		bra $a245	                bra LA245
3592	.a243					L9DCA:
3593	.a243	a9 00		lda #$00	                lda #$00
3594	.a245					LA245:
3595						                .endif
3596	.a245	c9 12		cmp #$12	                cmp #romServiceCallInitialiseFilingSystem
3597	.a247	d0 1a		bne $a263	                bne L9DEA
3598						                .if version==400
3601						                .else
3602	.a249	c0 04		cpy #$04	                cpy #$04                     ; Exit if not TAPE/ROM
3603	.a24b	b0 42		bcs $a28f	                bcs L9E16
3604	.a24d	c0 00		cpy #$00	                cpy #$00                     ; Exit if Y=0, no FS
3605	.a24f	f0 3e		beq $a28f	                beq L9E16
3606	.a251	a2 03		ldx #$03	                ldx #$03                     ; X=ROMFS, A=FS number
3607	.a253	98		tya		                tya
3608	.a254	c9 02		cmp #$02	                cmp #$02                     ; If A=2, ROMFS, jump to select it
3609	.a256	b0 04		bcs $a25c	                bcs L9DE3
3610	.a258	a2 00		ldx #$00	                ldx #$00                     ; X=TAPE, A=speed+2
3611	.a25a	69 02		adc #$02	                adc #$02
3612	.a25c					L9DE3:
3613	.a25c	69 89		adc #$89	                adc #$89                     ; Convert to TAPE/ROM select value
3614						                .endif
3615	.a25e	20 46 ee	jsr $ee46	                jsr mos.selectROMOrTAPEByOSBYTE
3616	.a261	80 e0		bra $a243	                bra L9DCA                    ; Jump to claim and return

3618	.a263					L9DEA:
3619	.a263	c9 06		cmp #$06	                cmp #romServiceCallBreakInstruction
3620	.a265	d0 29		bne $a290	                bne L9E17
3621	.a267	ad dd df	lda $dfdd	                lda hazel.hasACCCONChanged ; Skip if ACCCON not changed
3622	.a26a	f0 09		beq $a275	                beq L9DFC
3623	.a26c	9c dd df	stz $dfdd	                stz hazel.hasACCCONChanged ; Clear ACCCON changed flag
3624	.a26f	ad dc df	lda $dfdc	                lda hazel.oldACCCON        ; Restore ACCCON
3625	.a272	8d 34 fe	sta $fe34	                sta ACCCON
3626	.a275					L9DFC:
3627	.a275	5a		phy		                phy
3628	.a276	ac d4 df	ldy $dfd4	                ldy hazel.moveSrcHandle
3629	.a279	f0 06		beq $a281	                beq L9E08
3630	.a27b	9c d4 df	stz $dfd4	                stz hazel.moveSrcHandle
3631	.a27e	20 dc 90	jsr $90dc	                jsr closeFile
3632	.a281					L9E08:
3633	.a281	ac d5 df	ldy $dfd5	                ldy hazel.moveDestHandle
3634	.a284	f0 06		beq $a28c	                beq L9E13
3635	.a286	9c d5 df	stz $dfd5	                stz hazel.moveDestHandle
3636	.a289	20 dc 90	jsr $90dc	                jsr closeFile
3637	.a28c					L9E13:
3638	.a28c	7a		ply		                ply
3639	.a28d	a9 06		lda #$06	                lda #$06
3640	.a28f					L9E16:
3641	.a28f	60		rts		                rts
3642	.a290					L9E17:
3643	.a290	c9 26		cmp #$26	                cmp #romServiceCallCloseAllOpenFiles
3644	.a292	d0 1d		bne $a2b1	                bne L9E38
3645						                .if version!=400
3646	.a294	a9 8d		lda #$8d	                lda #$8D
3647	.a296	20 a5 a2	jsr $a2a5	                jsr L9E2C
3648	.a299	a2 03		ldx #$03	                ldx #$03
3649	.a29b	a9 04		lda #$04	                lda #$04
3650	.a29d	24 c6		bit $c6		                bit $C6
3651	.a29f	f0 02		beq $a2a3	                beq L9E2A
3652	.a2a1	a2 00		ldx #$00	                ldx #$00
3653	.a2a3					L9E2A:
3654	.a2a3	a9 8c		lda #$8c	                lda #$8C
3655	.a2a5					L9E2C:
3656						                .endif
3657	.a2a5	20 46 ee	jsr $ee46	                jsr mos.selectROMOrTAPEByOSBYTE
3658	.a2a8	a9 00		lda #$00	                lda #$00
3659	.a2aa	a8		tay		                tay
3660	.a2ab	20 4c a6	jsr $a64c	                jsr osfindTapeOrROM
3661	.a2ae	a9 26		lda #$26	                lda #$26
3662	.a2b0	60		rts		                rts

3664	.a2b1					L9E38:
3665	.a2b1	c9 09		cmp #$09	                cmp #romServiceCallHelp
3666						                .if version<400
3668						                .elsif version>=400
3669	.a2b3	d0 4f		bne $a304	                bne LA304
3670						                .endif
3671	.a2b5	5a		phy		                phy
3672	.a2b6	b1 f2		lda ($f2),y	                lda ($F2),y
3673	.a2b8	c9 0d		cmp #$0d	                cmp #$0D
3674	.a2ba	d0 1b		bne $a2d7	                bne L9E61
3675	.a2bc	20 6f a3	jsr $a36f	                jsr L9EFC
3676	.a2bf	20 27 ad	jsr $ad27	                jsr alwaysPrintFollowingMessage
3677	>a2c2	20 20 4d 4f 53 0d		                .text "  MOS",13
3678						                .if version<400
3680						                .elsif version==500
3681	>a2c8	0d 55 54 49 4c 53 20 31		                .text 13,"UTILS 1.00",13
	>a2d0	2e 30 30 0d
3690						                .endif
3691	>a2d4	00				                .text 0
3692	.a2d5	80 2a		bra $a301	                bra L9E8B
3693	.a2d7					L9E61:
3694	.a2d7	a2 02		ldx #$02	                ldx #size(mosHelpSubject)-1
3695	.a2d9					L9E63:
3696	.a2d9	b1 f2		lda ($f2),y	                lda (stringInputBufferAddress),y
3697	.a2db	c9 2e		cmp #$2e	                cmp #'.'
3698	.a2dd	f0 29		beq $a308	                beq L9E95
3699	.a2df	29 df		and #$df	                and #$DF
3700	.a2e1	dd 05 a3	cmp $a305,x	                cmp mosHelpSubject,x
3701	.a2e4	d0 0b		bne $a2f1	                bne L9E7B
3702	.a2e6	c8		iny		                iny
3703	.a2e7	ca		dex		                dex
3704	.a2e8	10 ef		bpl $a2d9	                bpl L9E63
3705	.a2ea	b1 f2		lda ($f2),y	                lda (stringInputBufferAddress),y
3706	.a2ec	20 9c eb	jsr $eb9c	                jsr mos.isLetter
3707	.a2ef	b0 17		bcs $a308	                bcs L9E95
3708	.a2f1					L9E7B:
3709	.a2f1	b1 f2		lda ($f2),y	                lda (stringInputBufferAddress),y
3710	.a2f3	c9 0d		cmp #$0d	                cmp #13
3711	.a2f5	f0 0a		beq $a301	                beq L9E8B
3712	.a2f7	c8		iny		                iny
3713	.a2f8	c9 20		cmp #$20	                cmp #' '
3714	.a2fa	d0 f5		bne $a2f1	                bne L9E7B
3715	.a2fc	20 ad f3	jsr $f3ad	                jsr mos.skipSpacesAndCheckForCRInStringInput
3716	.a2ff	d0 d6		bne $a2d7	                bne L9E61
3717	.a301					L9E8B:
3718	.a301	7a		ply		                ply
3719	.a302	a9 09		lda #$09	                lda #romServiceCallHelp
3720	.a304					LA304:
3721	.a304	60		rts		                rts

3723						                .if version<400
3726						                .endif

3728	>a305	53 4f 4d			mosHelpSubject: .text "SOM"

3730	.a308					L9E95:
3731	.a308	20 6f a3	jsr $a36f	                jsr L9EFC
3732	.a30b	a9 83		lda #$83	                lda #<mosCommandTable
3733	.a30d	85 b0		sta $b0		                sta terminalHELPWorkspace.tablePtr+0
3734	.a30f	a9 83		lda #$83	                lda #>mosCommandTable
3735	.a311	85 b1		sta $b1		                sta terminalHELPWorkspace.tablePtr+1
3736	.a313					L9EA0:
3737	.a313	b2 b0		lda ($b0)	                lda (terminalHELPWorkspace.tablePtr)
3738	.a315	30 50		bmi $a367	                bmi L9EF4
3739						                .if version==400
3742						                .endif
3743	.a317	20 80 a3	jsr $a380	                jsr printSpace
3744	.a31a	20 80 a3	jsr $a380	                jsr printSpace
3745	.a31d	b2 b0		lda ($b0)	                lda (terminalHELPWorkspace.tablePtr)
3746	.a31f					L9EAC:
3747						                .if version==400
3750						                .endif
3751	.a31f	20 82 a3	jsr $a382	                jsr L9F0E
3752	.a322					LA711:
3753	.a322	e6 b0		inc $b0		                inc terminalHELPWorkspace.tablePtr+0
3754	.a324	d0 02		bne $a328	                bne L9EB5
3755	.a326	e6 b1		inc $b1		                inc terminalHELPWorkspace.tablePtr+1
3756	.a328					L9EB5:
3757	.a328	b2 b0		lda ($b0)	                lda (terminalHELPWorkspace.tablePtr)
3758	.a32a	10 f3		bpl $a31f	                bpl L9EAC

3760						                ; add 4 to tablePtr
3761	.a32c	a9 04		lda #$04	                lda #$04
3762	.a32e	18		clc		                clc
3763	.a32f	65 b0		adc $b0		                adc terminalHELPWorkspace.tablePtr+0
3764	.a331	85 b0		sta $b0		                sta terminalHELPWorkspace.tablePtr+0
3765	.a333	90 02		bcc $a337	                bcc +
3766	.a335	e6 b1		inc $b1		                inc terminalHELPWorkspace.tablePtr+1
3767	.a337					+
3768	.a337	20 6c e2	jsr $e26c	                jsr mos.LE25C
3769	.a33a	e0 13		cpx #$13	                cpx #19
3770	.a33c	f0 24		beq $a362	                beq L9EEF
3771	.a33e					L9ECB:
3772	.a33e	20 62 e2	jsr $e262	                jsr mos.getTextCursorPositionWithColumn81
3773	.a341	8a		txa		                txa
3774	.a342	f0 cf		beq $a313	                beq L9EA0
3775	.a344	e0 14		cpx #$14	                cpx #20
3776	.a346	f0 cb		beq $a313	                beq L9EA0
3777	.a348	90 0d		bcc $a357	                bcc L9EE4
3778	.a34a	e0 28		cpx #$28	                cpx #40
3779	.a34c	f0 c5		beq $a313	                beq L9EA0
3780	.a34e	b0 0c		bcs $a35c	                bcs L9EE9
3781	.a350	20 6c e2	jsr $e26c	                jsr mos.LE25C
3782	.a353	e0 27		cpx #$27	                cpx #39
3783	.a355	f0 0b		beq $a362	                beq L9EEF
3784	.a357					L9EE4:
3785	.a357	20 80 a3	jsr $a380	                jsr printSpace
3786	.a35a	80 e2		bra $a33e	                bra L9ECB

3788	.a35c					L9EE9:
3789	.a35c	e0 3c		cpx #$3c	                cpx #60
3790	.a35e	90 f7		bcc $a357	                bcc L9EE4
3791	.a360	f0 b1		beq $a313	                beq L9EA0
3792	.a362					L9EEF:
3793	.a362	20 92 a3	jsr $a392	                jsr printNewLine
3794	.a365	80 ac		bra $a313	                bra L9EA0

3796	.a367					L9EF4:
3797	.a367	20 62 e2	jsr $e262	                jsr mos.getTextCursorPositionWithColumn81
3798	.a36a	8a		txa		                txa
3799	.a36b	f0 94		beq $a301	                beq L9E8B
3800	.a36d	80 f3		bra $a362	                bra L9EEF

3802	.a36f					L9EFC:
3803	.a36f	5a		phy		                phy
3804	.a370	20 27 ad	jsr $ad27	                jsr alwaysPrintFollowingMessage
3805	>a373	0d				                .text 13
3806						                .if version==320
3818						                .elsif version==500
3819	>a374	4d 4f 53 20 35 2e 30 30		                .text "MOS 5.00"
3834						                .endif
3835	>a37c	0d 00				                .text 13,0
3836	.a37e	7a		ply		                ply
3837	.a37f	60		rts		                rts

3839						;-------------------------------------------------------------------------
3840						;
3841	.a380					printSpace:
3842	.a380	a9 20		lda #$20	                lda #$20
3843	.a382					L9F0E:
3844	.a382	da		phx		                phx
3845	.a383	a6 b0		ldx $b0		                ldx $B0
3846	.a385	da		phx		                phx
3847	.a386	a6 b1		ldx $b1		                ldx $B1
3848	.a388	20 ee ff	jsr $ffee	                jsr OSWRCH
3849	.a38b					restoreB1AndB0:
3850	.a38b	86 b1		stx $b1		                stx $B1
3851	.a38d	fa		plx		                plx
3852	.a38e	86 b0		stx $b0		                stx $B0
3853	.a390	fa		plx		                plx
3854	.a391	60		rts		                rts

3856						;-------------------------------------------------------------------------

3858	.a392					printNewLine:
3859	.a392	da		phx		                phx
3860	.a393	a6 b0		ldx $b0		                ldx $B0
3861	.a395	da		phx		                phx
3862	.a396	a6 b1		ldx $b1		                ldx $B1
3863	.a398	20 e7 ff	jsr $ffe7	                jsr OSNEWL
3864	.a39b	80 ee		bra $a38b	                bra restoreB1AndB0

3866						;-------------------------------------------------------------------------

3868						; TAPE/ROM OSARGS handler
3869						; =======================
3870	.a39d					osargsTapeOrROM:
3871	.a39d	c0 00		cpy #$00	                cpy #$00       ; Handle<>0 - read/write open file info
3872	.a39f	d0 0e		bne $a3af	                bne L9F3B
3873	.a3a1	09 00		ora #$00	                ora #$00 ; A<>0 - read/write filing system info - exit
3874	.a3a3	d0 09		bne $a3ae	                bne L9F3A

3876						; A=0, Y=0 - read current filing system
3877						; -------------------------------------
3878	.a3a5	a9 03		lda #$03	                lda #$03                     ; Prepare A=ROMFS
3879						                .if version!=400
3880	.a3a7	2c 47 02	bit $0247	                bit cfsRFSFSSwitch           ; If TAPE/ROM switch
3881	.a3aa	d0 02		bne $a3ae	                bne L9F3A
3882	.a3ac	25 c6		and $c6		                and $C6           ; Mask with speed to give A=2 or A=1
3883						                .endif

3885						; TAPE/ROM FSC 6 - shut down FS
3886						; TAPE/ROM FSC 8 - OS command
3887						; TAPE/ROM FSC 10 - *INFO
3888						; -----------------------------
3889	.a3ae					L9F3A:
3890	.a3ae	60		rts		                rts

3892						; OSARGS handle<>0 - red/write open file info
3893						; -------------------------------------------
3894	.a3af					L9F3B:
3895	.a3af	c9 00		cmp #$00	                cmp #$00                     ; Not =PTR, exit unsupported
3896	.a3b1	d0 fb		bne $a3ae	                bne L9F3A
3897	.a3b3	c0 02		cpy #$02	                cpy #$02                     ; =PTR#2 - read PTR on output handle
3898	.a3b5	f0 1d		beq $a3d4	                beq L9F60

3900						; Read PTR on CFS/RFS input file
3901						; ------------------------------
3902	.a3b7	a9 01		lda #$01	                lda #$01                     ; Check if this is input channel and is open
3903	.a3b9	20 2d ae	jsr $ae2d	                jsr LAA68
3904	.a3bc	ad 9e 03	lda $039e	                lda $039E
3905	.a3bf	95 00		sta $00,x	                sta $00,x
3906	.a3c1	5a		phy		                phy
3907	.a3c2	ad de 03	lda $03de	                lda $03DE
3908	.a3c5	ac dd 03	ldy $03dd	                ldy $03DD
3909	.a3c8	d0 01		bne $a3cb	                bne L9F57
3910	.a3ca	3a		dec a		                dec a
3911	.a3cb					L9F57:
3912	.a3cb	88		dey		                dey
3913	.a3cc	94 01		sty $01,x	                sty $01,x
3914	.a3ce	7a		ply		                ply
3915	.a3cf					L9F5B:
3916	.a3cf	95 02		sta $02,x	                sta $02,x
3917	.a3d1	74 03		stz $03,x	                stz $03,x
3918	.a3d3	60		rts		                rts

3920						; Read PTR on TAPE output file
3921						; ----------------------------
3922	.a3d4					L9F60:
3923	.a3d4	a9 02		lda #$02	                lda #$02                     ; Check if this is output channel and is open
3924	.a3d6	20 2d ae	jsr $ae2d	                jsr LAA68
3925	.a3d9	ad 9d 03	lda $039d	                lda $039D                    ; Copy PTR to control block
3926	.a3dc	95 00		sta $00,x	                sta $00,x
3927	.a3de	ad 94 03	lda $0394	                lda $0394
3928	.a3e1	95 01		sta $01,x	                sta $01,x
3929	.a3e3	ad 95 03	lda $0395	                lda $0395
3930	.a3e6	80 e7		bra $a3cf	                bra L9F5B

3932						; TAPE/ROM FSC dispatch table
3933						; ---------------------------

3935	=[]					_:=[]
3936	=[$a829]				_..=[LA422]          ;0 - *OPT
3937	=[$a829,$a8ed]				_..=[LA4F1]          ;1 - EOF
3938	=[$a829,$a8ed,$a57a]			_..=[LA110]          ;2 - */
3939	=[$a829,$a8ed,$a57a,$a593]		_..=[LA129]          ;3 - unknown * command
3940	=[$a829,$a8ed,$a57a,$a593,$a57a]	_..=[LA110]          ;4 - *RUN
3941	=[$a829,$a8ed,$a57a,$a593,$a57a,$a5bb]	_..=[LA168]          ;5 - *CAT
3942	=[$a829,$a8ed,$a57a,$a593,$a57a,$a5bb,$a3ae]
						_..=[L9F3A]          ;6 - shut down FS
3943	=[$a829,$a8ed,$a57a,$a593,$a57a,$a5bb,$a3ae,$a412]
						_..=[L9F9E]          ;7 - obtain file handle range
3944	=[$a829,$a8ed,$a57a,$a593,$a57a,$a5bb,$a3ae,$a412,$a3ae]
						_..=[L9F3A]          ;8 - OS command
3945	=[$a829,$a8ed,$a57a,$a593,$a57a,$a5bb,$a3ae,$a412,$a3ae,$a5a8]
						_..=[LA155]          ;9 - *EX
3946	=[$a829,$a8ed,$a57a,$a593,$a57a,$a5bb,$a3ae,$a412,$a3ae,$a5a8,$a3ae]
						_..=[L9F3A]          ;10 - *INFO
3947	=[$a829,$a8ed,$a57a,$a593,$a57a,$a5bb,$a3ae,$a412,$a3ae,$a5a8,$a3ae,$a57d]
						_..=[LA113]          ;11 - *RUN command for library
3948	=[$a829,$a8ed,$a57a,$a593,$a57a,$a5bb,$a3ae,$a412,$a3ae,$a5a8,$a3ae,$a57d]
						tape_and_rom_dispatch_fsc_routines=_

3950	.a3e8					L9F74:
3951	>a3e8	28 ec 79 92 79 ba ad 11		                .byte <tape_and_rom_dispatch_fsc_routines-1
	>a3f0	ad a7 ad 7c
3952	.a3f4					L9F80:
3953	>a3f4	a8 a8 a5 a5 a5 a5 a3 a4		                .byte >tape_and_rom_dispatch_fsc_routines-1
	>a3fc	a3 a5 a3 a5

3955						; TAPE/ROM FSC
3956						; ============
3957	.a400					fscTapeOrROM:
3958	.a400	c9 0c		cmp #$0c	                cmp #$0C                     ; function<12 - exit unchanged
3959	.a402	b0 aa		bcs $a3ae	                bcs L9F3A
3960	.a404	86 bc		stx $bc		                stx $BC                      ; Index into dispatch table
3961	.a406	aa		tax		                tax
3962	.a407	bd f4 a3	lda $a3f4,x	                lda L9F80,x
3963	.a40a	48		pha		                pha
3964	.a40b	bd e8 a3	lda $a3e8,x	                lda L9F74,x
3965	.a40e	48		pha		                pha
3966	.a40f	a6 bc		ldx $bc		                ldx $BC
3967	.a411	60		rts		                rts

3969						; TAPE/ROM FSC 7 - obtain file handle range
3970						; -----------------------------------------
3971	.a412					L9F9E:
3972	.a412	a2 03		ldx #$03	                ldx #$03
3973	.a414	a0 03		ldy #$03	                ldy #$03
3974						                .if version!=400
3975	.a416	ad 47 02	lda $0247	                lda cfsRFSFSSwitch
3976	.a419	d0 93		bne $a3ae	                bne L9F3A
3977	.a41b	88		dey		                dey
3978	.a41c	a2 01		ldx #$01	                ldx #$01
3979						                .endif
3980	.a41e	60		rts		                rts

3982	.a41f					L9FAB:
3983	.a41f	68		pla		                pla
3984	.a420	28		plp		                plp
3985	.a421	38		sec		                sec
3986	.a422	60		rts		                rts

3988	.a423					L9FAF:
3989	.a423	08		php		                php
3990	.a424	48		pha		                pha
3991	.a425	20 b8 ad	jsr $adb8	                jsr LA9F3
3992	.a428	ad c2 03	lda $03c2	                lda $03C2
3993	.a42b	48		pha		                pha
3994	.a42c	20 fe a8	jsr $a8fe	                jsr LA502
3995	.a42f	68		pla		                pla
3996	.a430	b0 ed		bcs $a41f	                bcs L9FAB
3997	.a432	f0 19		beq $a44d	                beq L9FD9
3998	.a434	a2 03		ldx #$03	                ldx #$03
3999	.a436	a9 ff		lda #$ff	                lda #$FF
4000	.a438					L9FC4:
4001	.a438	48		pha		                pha
4002	.a439	bd be 03	lda $03be,x	                lda $03BE,x
4003	.a43c	95 b0		sta $b0,x	                sta $B0,x
4004	.a43e	68		pla		                pla
4005	.a43f	35 b0		and $b0,x	                and $B0,x
4006	.a441	ca		dex		                dex
4007	.a442	10 f4		bpl $a438	                bpl L9FC4
4008	.a444	1a		inc a		                inc a
4009	.a445	d0 06		bne $a44d	                bne L9FD9
4010	.a447	20 80 ad	jsr $ad80	                jsr LA9B1
4011	.a44a	4c 27 95	jmp $9527	                jmp badAddressError

4013	.a44d					L9FD9:
4014	.a44d	ad ca 03	lda $03ca	                lda $03CA
4015	.a450	4a		lsr a		                lsr a
4016	.a451	68		pla		                pla
4017	.a452	48		pha		                pha
4018	.a453	f0 10		beq $a465	                beq L9FF1
4019	.a455	90 15		bcc $a46c	                bcc L9FF8
4020	.a457					L9FE3:
4021	.a457	20 8a ad	jsr $ad8a	                jsr LA9BB
4022	.a45a	20 8c ae	jsr $ae8c	                jsr doFollowingError
4023	>a45d	d5 4c 6f 63 6b 65 64 00		                .text $d5,"Locked",0
4024	.a465					L9FF1:
4025	.a465	90 05		bcc $a46c	                bcc L9FF8
4026	.a467	a9 03		lda #$03	                lda #$03
4027	.a469	8d 58 02	sta $0258	                sta breakAndESCAPEEffect
4028	.a46c					L9FF8:
4029	.a46c	a9 30		lda #$30	                lda #$30
4030	.a46e	25 bb		and $bb		                and $BB
4031	.a470	f0 04		beq $a476	                beq LA002
4032	.a472	a5 c1		lda $c1		                lda $C1
4033	.a474					LA000:
4034	.a474	d0 03		bne $a479	                bne LA00A
4035	.a476					LA002:
4036						                .if version<500
4040						                .endif
4041	.a476	20 ab aa	jsr $aaab	                jsr LA6D2
4042	.a479					LA00A:
4043	.a479	20 70 ac	jsr $ac70	                jsr LA8A1
4044	.a47c	d0 57		bne $a4d5	                bne LA066
4045	.a47e	20 fa ad	jsr $adfa	                jsr LAA35
4046	.a481	2c ca 03	bit $03ca	                bit $03CA
4047	.a484	30 08		bmi $a48e	                bmi LA01F
4048	.a486	20 2a ac	jsr $ac2a	                jsr LA85B
4049	.a489	20 74 aa	jsr $aa74	                jsr LA678
4050	.a48c	80 de		bra $a46c	                bra L9FF8

4052	.a48e					LA01F:
4053	.a48e	68		pla		                pla                          ; RUN, no control block to update
4054	.a48f	f0 33		beq $a4c4	                beq LA055
4055	.a491	a0 02		ldy #$02	                ldy #$02
4056	.a493					LA024:
4057	.a493	b9 bc 03	lda $03bc,y	                lda $03BC,y                  ; Copy load/exec to control block
4058	.a496	91 c8		sta ($c8),y	                sta ($C8),y
4059	.a498	c8		iny		                iny
4060	.a499	c0 0a		cpy #$0a	                cpy #$0A
4061	.a49b	d0 f6		bne $a493	                bne LA024
4062	.a49d	ad c8 03	lda $03c8	                lda $03C8                    ; Length b0-b7=Block Length b0-b7
4063	.a4a0	91 c8		sta ($c8),y	                sta ($C8),y
4064	.a4a2	c8		iny		                iny
4065	.a4a3	ad c9 03	lda $03c9	                lda $03C9
4066	.a4a6	18		clc		                clc
4067	.a4a7	6d c6 03	adc $03c6	                adc $03C6                    ; Length b8-b15=Block Number+Block Length b8-b15
4068	.a4aa	91 c8		sta ($c8),y	                sta ($C8),y
4069	.a4ac	c8		iny		                iny
4070	.a4ad	a9 00		lda #$00	                lda #$00
4071	.a4af	6d c7 03	adc $03c7	                adc $03C7                    ; Length b16-b23=overflow
4072	.a4b2	91 c8		sta ($c8),y	                sta ($C8),y
4073	.a4b4	c8		iny		                iny                          ; Length b24-b31=&00
4074	.a4b5	a9 00		lda #$00	                lda #$00
4075	.a4b7	91 c8		sta ($c8),y	                sta ($C8),y
4076	.a4b9	c8		iny		                iny
4077	.a4ba					LA04B:
4078	.a4ba	b9 bd 03	lda $03bd,y	                lda $03BD,y                  ; Attrs=&00000000
4079	.a4bd	91 c8		sta ($c8),y	                sta ($C8),y
4080	.a4bf	c8		iny		                iny
4081	.a4c0	c0 12		cpy #$12	                cpy #$12
4082	.a4c2	d0 f6		bne $a4ba	                bne LA04B
4083	.a4c4					LA055:
4084	.a4c4	28		plp		                plp
4085	.a4c5					LA056:
4086	.a4c5	20 80 ad	jsr $ad80	                jsr LA9B1
4087	.a4c8					LA059:
4088	.a4c8	24 ba		bit $ba		                bit $BA                      ; If flag set, skip printing newline
4089	.a4ca	30 07		bmi $a4d3	                bmi LA064
4090	.a4cc					LA05D:
4091	.a4cc	08		php		                php                          ; Print inline text
4092	.a4cd	20 f2 ac	jsr $acf2	                jsr LA923
4093	>a4d0	0d				                .byte 13                     ; Could just do JSR OSNEWL
4094	>a4d1	00				                .byte 0
4095	.a4d2	28		plp		                plp
4096	.a4d3					LA064:
4097	.a4d3	18		clc		                clc
4098	.a4d4	60		rts		                rts

4100	.a4d5					LA066:
4101	.a4d5	20 02 a9	jsr $a902	                jsr LA506
4102	.a4d8	d0 92		bne $a46c	                bne L9FF8
4103	.a4da					LA06B:
4104	.a4da	86 f2		stx $f2		                stx $F2
4105	.a4dc	84 f3		sty $f3		                sty $F3
4106	.a4de	a0 00		ldy #$00	                ldy #$00
4107	.a4e0	20 1b f3	jsr $f31b	                jsr mos.gsinitForFilenameParsing
4108	.a4e3	a2 00		ldx #$00	                ldx #$00
4109	.a4e5					LA076:
4110	.a4e5	20 2d f3	jsr $f32d	                jsr mos.gsreadEntryPoint
4111	.a4e8	b0 0d		bcs $a4f7	                bcs LA088
4112	.a4ea	f0 08		beq $a4f4	                beq LA085
4113	.a4ec	9d d2 03	sta $03d2,x	                sta $03D2,x
4114	.a4ef	e8		inx		                inx
4115	.a4f0	e0 0b		cpx #$0b	                cpx #$0B
4116	.a4f2	d0 f1		bne $a4e5	                bne LA076
4117	.a4f4					LA085:
4118	.a4f4	4c 3d f3	jmp $f33d	                jmp mos.badStringError

4120	.a4f7					LA088:
4121	.a4f7	9e d2 03	stz $03d2,x	                stz $03D2,x
4122	.a4fa	60		rts		                rts

4124						; CFS/RFS OSFILE
4125						; ==============
4126	.a4fb					osfileTapeOrROM:
4127	.a4fb	48		pha		                pha
4128	.a4fc	86 c8		stx $c8		                stx $C8                      ; C8/9=>control block
4129	.a4fe	84 c9		sty $c9		                sty $C9
4130	.a500	b2 c8		lda ($c8)	                lda ($C8)                    ; Get XY=>filename
4131	.a502	aa		tax		                tax
4132	.a503	a0 01		ldy #$01	                ldy #$01
4133	.a505	b1 c8		lda ($c8),y	                lda ($C8),y
4134	.a507	a8		tay		                tay
4135	.a508	20 da a4	jsr $a4da	                jsr LA06B                    ; Parse filename
4136	.a50b	a0 02		ldy #$02	                ldy #$02
4137	.a50d					LA09E:
4138	.a50d	b1 c8		lda ($c8),y	                lda ($C8),y
4139	.a50f	99 bc 03	sta $03bc,y	                sta $03BC,y
4140	.a512	99 ae 00	sta $00ae,y	                sta $00AE,y
4141	.a515	c8		iny		                iny
4142	.a516	c0 0a		cpy #$0a	                cpy #$0A
4143	.a518	d0 f3		bne $a50d	                bne LA09E
4144	.a51a	68		pla		                pla
4145	.a51b	f0 07		beq $a524	                beq LA0B5
4146	.a51d	c9 ff		cmp #$ff	                cmp #$FF
4147	.a51f	d0 b2		bne $a4d3	                bne LA064
4148	.a521	4c 23 a4	jmp $a423	                jmp L9FAF

4150	.a524					LA0B5:
4151						                .if version==400
4153						                .else
4154	.a524	8d c6 03	sta $03c6	                sta $03C6
4155	.a527	8d c7 03	sta $03c7	                sta $03C7
4156	.a52a					LA0BB:
4157	.a52a	b1 c8		lda ($c8),y	                lda ($C8),y
4158	.a52c	99 a6 00	sta $00a6,y	                sta $00A6,y
4159	.a52f	c8		iny		                iny
4160	.a530	c0 12		cpy #$12	                cpy #$12
4161	.a532	d0 f6		bne $a52a	                bne LA0BB
4162	.a534	8a		txa		                txa
4163	.a535	f0 bd		beq $a4f4	                beq LA085
4164	.a537	20 b8 ad	jsr $adb8	                jsr LA9F3
4165	.a53a	20 f1 ab	jsr $abf1	                jsr LA822
4166						                .if version<500
4169						                .endif
4170	.a53d					LA0D3:
4171	.a53d	38		sec		                sec
4172	.a53e	a2 fd		ldx #$fd	                ldx #$fd                     ;-3
4173	.a540					LA0D6:
4174	.a540	bd b7 ff	lda $ffb7,x	                lda ($b4-$fd)&$ffff,x
4175	.a543	fd b3 ff	sbc $ffb3,x	                sbc ($b0-$fd)&$ffff,x
4176	.a546	9d cb 02	sta $02cb,x	                sta $3c8-$fd,x
4177	.a549	e8		inx		                inx
4178	.a54a	d0 f4		bne $a540	                bne LA0D6
4179	.a54c	a8		tay		                tay
4180	.a54d	d0 0e		bne $a55d	                bne LA0F3
4181	.a54f	ec c8 03	cpx $03c8	                cpx $03C8
4182	.a552	a9 01		lda #$01	                lda #$01
4183	.a554	ed c9 03	sbc $03c9	                sbc $03C9
4184	.a557	90 04		bcc $a55d	                bcc LA0F3
4185	.a559	a2 80		ldx #$80	                ldx #$80
4186	.a55b	80 08		bra $a565	                bra LA0FB

4188	.a55d					LA0F3:
4189	.a55d	a9 01		lda #$01	                lda #$01
4190	.a55f	8d c9 03	sta $03c9	                sta $03C9
4191	.a562	8e c8 03	stx $03c8	                stx $03C8
4192	.a565					LA0FB:
4193	.a565	8e ca 03	stx $03ca	                stx $03CA
4194	.a568	20 c2 aa	jsr $aac2	                jsr LA6E9
4195	.a56b	30 61		bmi $a5ce	                bmi LA17B
4196	.a56d	20 2a ac	jsr $ac2a	                jsr LA85B
4197	.a570	ee c6 03	inc $03c6	                inc $03C6
4198	.a573	d0 c8		bne $a53d	                bne LA0D3
4199	.a575	ee c7 03	inc $03c7	                inc $03C7
4200	.a578	80 c3		bra $a53d	                bra LA0D3
4201						                .endif

4203						; TAPE/ROM FSC 2 - */
4204						; TAPE/ROM FSC 4 - *RUN
4205						; ---------------------
4206	.a57a					LA110:
4207	.a57a	38		sec		                sec
4208	.a57b	66 ce		ror $ce		                ror $CE
4209						; TAPE/ROM FSC 11 - *RUN command for library
4210						; ------------------------------------------
4211	.a57d					LA113:
4212	.a57d	da		phx		                phx
4213	.a57e	5a		phy		                phy
4214	.a57f	20 da a4	jsr $a4da	                jsr LA06B
4215	.a582	a9 00		lda #$00	                lda #$00
4216	.a584	a2 ff		ldx #$ff	                ldx #$FF
4217	.a586	8e c2 03	stx $03c2	                stx $03C2
4218	.a589	20 23 a4	jsr $a423	                jsr L9FAF
4219	.a58c	7a		ply		                ply
4220	.a58d	fa		plx		                plx
4221	.a58e	90 08		bcc $a598	                bcc LA12E
4222						                .if version!=400
4223	.a590	20 8f ad	jsr $ad8f	                jsr LA9CA
4224						                .endif

4226						; TAPE/ROM FSC 3 - unknown * command
4227						; ----------------------------------
4228	.a593					LA129:
4229	.a593	a9 0b		lda #$0b	                lda #$0B
4230	.a595	6c 1e 02	jmp ($021e)	                jmp (FSCV)

4232	.a598					LA12E:
4233						                .if version<500
4241						                .endif

4243	.a598	ae c2 03	ldx $03c2	                ldx $03C2
4244	.a59b	ac c3 03	ldy $03c3	                ldy $03C3
4245	.a59e	a9 a4		lda #$a4	                lda #$A4
4246	.a5a0	20 f4 ff	jsr $fff4	                jsr OSBYTE
4247	.a5a3	a9 01		lda #$01	                lda #$01
4248	.a5a5	6c c2 03	jmp ($03c2)	                jmp ($03C2)

4250						                .if version<500
4256						                .endif

4258						; TAPE/ROM FSC 9 - *EX
4259						; --------------------
4260	.a5a8					LA155:
4261	.a5a8	a9 08		lda #$08	                lda #$08
4262	.a5aa	04 e2		tsb $e2		                tsb $E2
4263	.a5ac	a5 e3		lda $e3		                lda $E3
4264	.a5ae	48		pha		                pha
4265	.a5af	09 cc		ora #$cc	                ora #$CC
4266	.a5b1	85 e3		sta $e3		                sta $E3
4267	.a5b3	20 b8 ad	jsr $adb8	                jsr LA9F3
4268	.a5b6	68		pla		                pla
4269	.a5b7	85 e3		sta $e3		                sta $E3
4270	.a5b9	80 07		bra $a5c2	                bra LA16F

4272						; TAPE/ROM FSC 5 - *CAT
4273						; ---------------------
4274	.a5bb					LA168:
4275	.a5bb	a9 08		lda #$08	                lda #$08
4276	.a5bd	04 e2		tsb $e2		                tsb $E2
4277	.a5bf	20 b8 ad	jsr $adb8	                jsr LA9F3
4278	.a5c2					LA16F:
4279	.a5c2	a9 00		lda #$00	                lda #$00
4280	.a5c4	20 cf a5	jsr $a5cf	                jsr LA17C
4281						                .if version!=400
4282	.a5c7	20 8f ad	jsr $ad8f	                jsr LA9CA
4283						                .endif
4284	.a5ca					LA177:
4285	.a5ca	a9 08		lda #$08	                lda #$08
4286	.a5cc	14 e2		trb $e2		                trb $E2
4287	.a5ce					LA17B:
4288	.a5ce	60		rts		                rts

4290	.a5cf					LA17C:
4291	.a5cf	48		pha		                pha
4292						                .if version!=400
4293	.a5d0	ad 47 02	lda $0247	                lda cfsRFSFSSwitch
4294	.a5d3	f0 09		beq $a5de	                beq LA18B
4295						                .endif
4296	.a5d5	20 f8 f4	jsr $f4f8	                jsr mos.LF6FC
4297	.a5d8	20 fd f4	jsr $f4fd	                jsr mos.LF701
4298	.a5db	b8		clv		                clv
4299	.a5dc	b0 50		bcs $a62e	                bcs LA1DB
4300	.a5de					LA18B:
4301	.a5de	20 74 aa	jsr $aa74	                jsr LA678
4302	.a5e1	ad c6 03	lda $03c6	                lda $03C6
4303	.a5e4	85 b4		sta $b4		                sta $B4
4304	.a5e6	ad c7 03	lda $03c7	                lda $03C7
4305	.a5e9	85 b5		sta $b5		                sta $B5
4306	.a5eb	a2 ff		ldx #$ff	                ldx #$FF
4307	.a5ed	8e df 03	stx $03df	                stx $03DF
4308	.a5f0	64 ba		stz $ba		                stz $BA
4309	.a5f2	80 16		bra $a60a	                bra LA1B7

4311	.a5f4					LA1A1:
4312						                .if version!=400
4313	.a5f4	ad 47 02	lda $0247	                lda cfsRFSFSSwitch
4314	.a5f7	f0 37		beq $a630	                beq LA1DD
4315						                .endif
4316	.a5f9					LA1A6:
4317	.a5f9	20 13 f5	jsr $f513	                jsr mos.LF717
4318	.a5fc					LA1A9:
4319	.a5fc	a9 ff		lda #$ff	                lda #$FF
4320	.a5fe	8d c6 03	sta $03c6	                sta $03C6
4321	.a601	8d c7 03	sta $03c7	                sta $03C7
4322	.a604					LA1B1:
4323	.a604	20 fa ad	jsr $adfa	                jsr LAA35
4324	.a607	20 74 aa	jsr $aa74	                jsr LA678
4325	.a60a					LA1B7:
4326						                .if version!=400
4327	.a60a	ad 47 02	lda $0247	                lda cfsRFSFSSwitch
4328	.a60d	f0 02		beq $a611	                beq LA1BE
4329						                .endif
4330	.a60f	50 1d		bvc $a62e	                bvc LA1DB
4331	.a611					LA1BE:
4332	.a611	68		pla		                pla
4333	.a612	48		pha		                pha
4334	.a613	f0 1b		beq $a630	                beq LA1DD
4335	.a615	20 2b ad	jsr $ad2b	                jsr LA95C
4336	.a618	d0 da		bne $a5f4	                bne LA1A1
4337	.a61a	a9 30		lda #$30	                lda #$30
4338	.a61c	25 bb		and $bb		                and $BB
4339	.a61e	f0 0e		beq $a62e	                beq LA1DB
4340	.a620	ad c6 03	lda $03c6	                lda $03C6
4341	.a623	c5 b6		cmp $b6		                cmp $B6
4342	.a625	d0 cd		bne $a5f4	                bne LA1A1
4343	.a627	ad c7 03	lda $03c7	                lda $03C7
4344	.a62a	c5 b7		cmp $b7		                cmp $B7
4345	.a62c	d0 c6		bne $a5f4	                bne LA1A1
4346	.a62e					LA1DB:
4347	.a62e	68		pla		                pla
4348	.a62f	60		rts		                rts

4350	.a630					LA1DD:
4351	.a630	50 05		bvc $a637	                bvc LA1E4
4352	.a632	a9 ff		lda #$ff	                lda #$FF
4353	.a634	20 ad aa	jsr $aaad	                jsr LA6D4
4354	.a637					LA1E4:
4355	.a637	a2 00		ldx #$00	                ldx #$00
4356	.a639	20 93 ac	jsr $ac93	                jsr LA8C4
4357						                .if version!=400
4358	.a63c	ad 47 02	lda $0247	                lda cfsRFSFSSwitch
4359	.a63f	f0 04		beq $a645	                beq LA1F2
4360						                .endif
4361	.a641	24 bb		bit $bb		                bit $BB
4362	.a643	50 b4		bvc $a5f9	                bvc LA1A6
4363	.a645					LA1F2:
4364	.a645	2c ca 03	bit $03ca	                bit $03CA
4365	.a648	30 b2		bmi $a5fc	                bmi LA1A9
4366	.a64a	80 b8		bra $a604	                bra LA1B1

4368						; CFS/RFS OSFIND HANDLER
4369						; ======================
4370	.a64c					osfindTapeOrROM:
4371	.a64c	85 bc		sta $bc		                sta $BC
4372	.a64e	da		phx		                phx
4373	.a64f	5a		phy		                phy
4374	.a650	09 00		ora #$00	                ora #$00
4375	.a652	d0 1f		bne $a673	                bne LA220
4376	.a654	98		tya		                tya
4377	.a655	d0 0e		bne $a665	                bne LA212
4378						                .if version!=400
4379	.a657	ad 47 02	lda $0247	                lda cfsRFSFSSwitch
4380	.a65a	d0 03		bne $a65f	                bne LA20C
4381	.a65c	20 ef a6	jsr $a6ef	                jsr LA29C
4382						                .endif
4383	.a65f					LA20C:
4384	.a65f	a9 01		lda #$01	                lda #$01
4385	.a661	14 e2		trb $e2		                trb $E2
4386						                .if version==400
4388						                .else
4389	.a663	80 0c		bra $a671	                bra LA21E
4390						                .endif
4391	.a665					LA212:
4392	.a665	4a		lsr a		                lsr a
4393	.a666	b0 f7		bcs $a65f	                bcs LA20C
4394						                .if version!=400
4395	.a668	4a		lsr a		                lsr a
4396	.a669	b0 03		bcs $a66e	                bcs LA21B
4397						                .endif
4398	.a66b	4c 46 ae	jmp $ae46	                jmp LAA81

4400						                .if version!=400
4401	.a66e					LA21B:
4402	.a66e	20 ef a6	jsr $a6ef	                jsr LA29C
4403	.a671					LA21E:
4404	.a671	80 77		bra $a6ea	                bra LA297
4405						                .endif

4407	.a673					LA220:
4408	.a673	20 da a4	jsr $a4da	                jsr LA06B
4409	.a676	24 bc		bit $bc		                bit $BC
4410	.a678	50 39		bvc $a6b3	                bvc LA260
4411	.a67a	9c 9e 03	stz $039e	                stz $039E
4412	.a67d	9c dd 03	stz $03dd	                stz $03DD
4413	.a680	9c de 03	stz $03de	                stz $03DE
4414	.a683	a9 c1		lda #$c1	                lda #$C1
4415	.a685	14 e2		trb $e2		                trb $E2
4416	.a687	20 ab ad	jsr $adab	                jsr LA9E6
4417	.a68a	08		php		                php
4418	.a68b	20 fe a8	jsr $a8fe	                jsr LA502
4419	.a68e	20 b3 a9	jsr $a9b3	                jsr LA5B7
4420	.a691	28		plp		                plp
4421	.a692	a2 ff		ldx #$ff	                ldx #$FF
4422	.a694					LA241:
4423	.a694	e8		inx		                inx
4424	.a695	bd b2 03	lda $03b2,x	                lda $03B2,x
4425	.a698	9d a7 03	sta $03a7,x	                sta $03A7,x
4426	.a69b	d0 f7		bne $a694	                bne LA241
4427	.a69d	1a		inc a		                inc a
4428	.a69e	04 e2		tsb $e2		                tsb $E2
4429	.a6a0	ad e9 02	lda $02e9	                lda tapeInputCurrentBlockSize+0
4430	.a6a3	0d ea 02	ora $02ea	                ora tapeInputCurrentBlockSize+1
4431	.a6a6	d0 04		bne $a6ac	                bne LA259
4432	.a6a8	a9 40		lda #$40	                lda #$40
4433	.a6aa	04 e2		tsb $e2		                tsb $E2
4434	.a6ac					LA259:
4435						                .if version==400
4440						                .else
4441	.a6ac	a9 01		lda #$01	                lda #$01
4442	.a6ae	0d 47 02	ora $0247	                ora cfsRFSFSSwitch
4443	.a6b1	d0 35		bne $a6e8	                bne LA295
4444	.a6b3					LA260:
4445	.a6b3	8a		txa		                txa
4446	.a6b4	d0 03		bne $a6b9	                bne LA266
4447	.a6b6	4c 3d f3	jmp $f33d	                jmp mos.badStringError

4449	.a6b9					LA266:
4450	.a6b9	a2 ff		ldx #$ff	                ldx #$FF
4451	.a6bb					LA268:
4452	.a6bb	e8		inx		                inx
4453	.a6bc	bd d2 03	lda $03d2,x	                lda $03D2,x
4454	.a6bf	9d 80 03	sta $0380,x	                sta $0380,x
4455	.a6c2	d0 f7		bne $a6bb	                bne LA268
4456	.a6c4	3a		dec a		                dec a
4457	.a6c5	a2 08		ldx #$08	                ldx #$08
4458	.a6c7					LA274:
4459	.a6c7	9d 8b 03	sta $038b,x	                sta $038B,x
4460	.a6ca	ca		dex		                dex
4461	.a6cb	d0 fa		bne $a6c7	                bne LA274
4462	.a6cd	8a		txa		                txa
4463	.a6ce	a2 14		ldx #$14	                ldx #$14
4464	.a6d0					LA27D:
4465	.a6d0	9d 80 03	sta $0380,x	                sta $0380,x
4466	.a6d3	e8		inx		                inx
4467	.a6d4	e0 1e		cpx #$1e	                cpx #$1E
4468	.a6d6	d0 f8		bne $a6d0	                bne LA27D
4469	.a6d8	2e 97 03	rol $0397	                rol $0397
4470	.a6db	20 b8 ad	jsr $adb8	                jsr LA9F3
4471	.a6de	20 f1 ab	jsr $abf1	                jsr LA822
4472	.a6e1	20 8a ad	jsr $ad8a	                jsr LA9BB
4473	.a6e4	a9 02		lda #$02	                lda #$02
4474	.a6e6	04 e2		tsb $e2		                tsb $E2
4475						                .endif
4476	.a6e8					LA295:
4477	.a6e8	85 bc		sta $bc		                sta $BC
4478	.a6ea					LA297:
4479	.a6ea	7a		ply		                ply
4480	.a6eb	fa		plx		                plx
4481	.a6ec	a5 bc		lda $bc		                lda $BC
4482	.a6ee					LA29B:
4483	.a6ee	60		rts		                rts

4485						                .if version!=400
4486	.a6ef					LA29C:
4487	.a6ef	a9 02		lda #$02	                lda #$02
4488	.a6f1	25 e2		and $e2		                and $E2
4489	.a6f3	f0 f9		beq $a6ee	                beq LA29B
4490	.a6f5	9c 97 03	stz $0397	                stz $0397
4491	.a6f8	a9 80		lda #$80	                lda #$80
4492	.a6fa	ae 9d 03	ldx $039d	                ldx $039D
4493	.a6fd	8e 96 03	stx $0396	                stx $0396
4494	.a700	8d 98 03	sta $0398	                sta $0398
4495	.a703	20 0b a7	jsr $a70b	                jsr LA2B8
4496	.a706	a9 02		lda #$02	                lda #$02
4497	.a708	14 e2		trb $e2		                trb $E2
4498	.a70a	60		rts		                rts

4500	.a70b					LA2B8:
4501	.a70b	20 ab ad	jsr $adab	                jsr LA9E6
4502	.a70e	a2 11		ldx #$11	                ldx #$11
4503	.a710					LA2BD:
4504	.a710	bd 8c 03	lda $038c,x	                lda $038C,x
4505	.a713	9d be 03	sta $03be,x	                sta $03BE,x
4506	.a716	ca		dex		                dex
4507	.a717	10 f7		bpl $a710	                bpl LA2BD
4508	.a719	86 b2		stx $b2		                stx $B2
4509	.a71b	86 b3		stx $b3		                stx $B3
4510	.a71d	64 b0		stz $b0		                stz $B0
4511	.a71f	a9 09		lda #$09	                lda #$09
4512	.a721	85 b1		sta $b1		                sta $B1
4513	.a723	a2 7f		ldx #$7f	                ldx #$7F
4514	.a725	20 12 ae	jsr $ae12	                jsr LAA4D
4515	.a728	8d df 03	sta $03df	                sta $03DF
4516	.a72b	20 1f ae	jsr $ae1f	                jsr LAA5A
4517	.a72e	20 65 ae	jsr $ae65	                jsr LAAA0
4518	.a731	20 c2 aa	jsr $aac2	                jsr LA6E9
4519	.a734	ee 94 03	inc $0394	                inc $0394
4520	.a737	d0 03		bne $a73c	                bne LA2E9
4521	.a739	ee 95 03	inc $0395	                inc $0395
4522	.a73c					LA2E9:
4523	.a73c	60		rts		                rts
4524						                .endif

4526	.a73d					bputTapeOrROM:
4527	.a73d	da		phx		                phx
4528	.a73e	5a		phy		                phy
4529	.a73f	a9 01		lda #$01	                lda #$01
4530	.a741					LA2EE:
4531	.a741	20 2d ae	jsr $ae2d	                jsr LAA68
4532	.a744	a5 e2		lda $e2		                lda $E2
4533	.a746	0a		asl a		                asl a
4534	.a747	b0 4d		bcs $a796	                bcs LA343
4535	.a749	0a		asl a		                asl a
4536	.a74a	90 08		bcc $a754	                bcc LA301
4537	.a74c	a9 80		lda #$80	                lda #$80
4538	.a74e	04 e2		tsb $e2		                tsb $E2
4539	.a750	a9 fe		lda #$fe	                lda #$FE
4540	.a752	b0 3a		bcs $a78e	                bcs LA33B
4541	.a754					LA301:
4542	.a754	ae 9e 03	ldx $039e	                ldx $039E
4543	.a757	e8		inx		                inx
4544	.a758	ec e9 02	cpx $02e9	                cpx tapeInputCurrentBlockSize+0
4545	.a75b	d0 2c		bne $a789	                bne LA336
4546	.a75d	2c eb 02	bit $02eb	                bit blockFlagOfCurrentlyResidentBlock
4547	.a760	30 23		bmi $a785	                bmi LA332
4548	.a762	ad ec 02	lda $02ec	                lda lastCharacterOfCurrentlyResidentBlock
4549	.a765	48		pha		                pha
4550	.a766	20 ab ad	jsr $adab	                jsr LA9E6
4551	.a769	08		php		                php
4552	.a76a	20 ab a9	jsr $a9ab	                jsr LA5AF
4553	.a76d	28		plp		                plp
4554	.a76e	68		pla		                pla
4555	.a76f	85 bc		sta $bc		                sta $BC
4556	.a771	18		clc		                clc
4557	.a772	2c eb 02	bit $02eb	                bit blockFlagOfCurrentlyResidentBlock
4558	.a775	10 19		bpl $a790	                bpl LA33D
4559	.a777	ad e9 02	lda $02e9	                lda tapeInputCurrentBlockSize+0
4560	.a77a	0d ea 02	ora $02ea	                ora tapeInputCurrentBlockSize+1
4561	.a77d	d0 11		bne $a790	                bne LA33D
4562	.a77f	a9 40		lda #$40	                lda #$40
4563	.a781	04 e2		tsb $e2		                tsb $E2
4564	.a783	80 0b		bra $a790	                bra LA33D

4566	.a785					LA332:
4567	.a785	a9 40		lda #$40	                lda #$40
4568	.a787	04 e2		tsb $e2		                tsb $E2
4569	.a789					LA336:
4570	.a789	ca		dex		                dex
4571	.a78a	18		clc		                clc
4572	.a78b	bd 00 0a	lda $0a00,x	                lda $0A00,x
4573	.a78e					LA33B:
4574	.a78e	85 bc		sta $bc		                sta $BC
4575	.a790					LA33D:
4576	.a790	ee 9e 03	inc $039e	                inc $039E
4577	.a793	4c ea a6	jmp $a6ea	                jmp LA297

4579	.a796					LA343:
4580	.a796	20 8c ae	jsr $ae8c	                jsr doFollowingError
4581	>a799	df 45 4f 46 00			                .text $df,"EOF",0

4583						                .if version==400
4591						                .endif

4593						                .if version!=400
4594	.a79e					bgetTapeOrROM:
4595	.a79e	85 c4		sta $c4		                sta $C4
4596	.a7a0	da		phx		                phx
4597	.a7a1	5a		phy		                phy
4598	.a7a2	a9 02		lda #$02	                lda #$02
4599	.a7a4	20 2d ae	jsr $ae2d	                jsr LAA68
4600	.a7a7	ae 9d 03	ldx $039d	                ldx $039D
4601	.a7aa	a5 c4		lda $c4		                lda $C4
4602	.a7ac	9d 00 09	sta $0900,x	                sta $0900,x
4603	.a7af	e8		inx		                inx
4604	.a7b0	d0 06		bne $a7b8	                bne LA365
4605	.a7b2	20 0b a7	jsr $a70b	                jsr LA2B8
4606	.a7b5	20 8a ad	jsr $ad8a	                jsr LA9BB
4607	.a7b8					LA365:
4608	.a7b8	ee 9d 03	inc $039d	                inc $039D
4609	.a7bb	a5 c4		lda $c4		                lda $C4
4610	.a7bd	4c e8 a6	jmp $a6e8	                jmp LA295
4611						                .endif

4613						                .if version!=400
4614						; TAPE/ROM OSGBPB handler
4615						; =======================
4616	.a7c0					osgbpbTapeOrROM:
4617	.a7c0	4a		lsr a		                lsr a                        ; Odd numbered calls - change PTR - exit with A=changed, SEC
4618	.a7c1	b0 06		bcs $a7c9	                bcs LA376
4619	.a7c3	f0 04		beq $a7c9	                beq LA376                    ; OSGBPB 0 - exit with A=unchanged, SEC
4620	.a7c5	c9 03		cmp #$03	                cmp #$03                     ; function/2<3 - function<6 - function 2 and 4 - jump to do
4621	.a7c7	90 02		bcc $a7cb	                bcc LA378
4622	.a7c9					LA376:
4623	.a7c9	38		sec		                sec
4624	.a7ca	60		rts		                rts
4625						                .endif

4627						; Call Return
4628						;  0    A=0   SEC                        - unsupported
4629						;  1    A=0   SEC  Write using new PTR   - unsupported
4630						;  2    A=         Write with current PTR
4631						;  3    A=1   SEC  Read with new PTR     - unsupported
4632						;  4    A=         Read with current PTR
4633						;  5+   A=A/2 SEC                        - unsupported

4635						; TAPE/ROM OSGBPB 2 and 4 - read/write with current PTR
4636						; -----------------------------------------------------
4637	.a7cb					LA378:
4638						                .if version!=400
4639	.a7cb	4a		lsr a		                lsr a
4640						                .endif
4641	.a7cc	86 cc		stx $cc		                stx $CC
4642	.a7ce	84 cd		sty $cd		                sty $CD
4643	.a7d0	a0 01		ldy #$01	                ldy #$01
4644	.a7d2	b1 cc		lda ($cc),y	                lda ($CC),y
4645	.a7d4	85 c8		sta $c8		                sta $C8
4646	.a7d6	c8		iny		                iny
4647	.a7d7	b1 cc		lda ($cc),y	                lda ($CC),y
4648	.a7d9	85 c9		sta $c9		                sta $C9
4649						                .if version<500
4680						                .endif
4681	.a7db	b2 cc		lda ($cc)	                lda ($CC)
4682	.a7dd	a8		tay		                tay
4683	.a7de	a9 01		lda #$01	                lda #$01
4684						                .if version!=400
4685						                .if version<500
4687						                .endif
4688	.a7e0	08		php		                php
4689	.a7e1	69 00		adc #$00	                adc #$00
4690						                .endif
4691	.a7e3	20 52 ae	jsr $ae52	                jsr LAA8D
4692	.a7e6	b0 04		bcs $a7ec	                bcs LA3C1
4693						                .if version!=400
4694	.a7e8	28		plp		                plp
4695						                .endif
4696						                .if version<500
4702						                .endif
4703	.a7e9	4c 46 ae	jmp $ae46	                jmp LAA81

4705	.a7ec					LA3C1:
4706						                .if version!=400
4707	.a7ec	28		plp		                plp
4708	.a7ed	b0 22		bcs $a811	                bcs LA401
4709						                .endif
4710	.a7ef	24 e2		bit $e2		                bit $E2
4711	.a7f1	10 03		bpl $a7f6	                bpl LA3D3
4712						                .if version<500
4718						                .endif
4719	.a7f3	4c 96 a7	jmp $a796	                jmp LA343

4721	.a7f6					LA3D3:
4722	.a7f6	20 7f ae	jsr $ae7f	                jsr LAAE0
4723	.a7f9	f0 15		beq $a810	                beq LA3F6
4724	.a7fb	b2 cc		lda ($cc)	                lda ($CC)
4725	.a7fd	a8		tay		                tay
4726	.a7fe	20 3d a7	jsr $a73d	                jsr bputTapeOrROM
4727	.a801	b0 0d		bcs $a810	                bcs LA3F6
4728						                .if version<500
4736						                .endif
4737	.a803	92 c8		sta ($c8)	                sta ($C8)
4738	.a805	e6 c8		inc $c8		                inc $C8
4739	.a807	d0 02		bne $a80b	                bne LA3F1
4740	.a809	e6 c9		inc $c9		                inc $C9
4741	.a80b					LA3F1:
4742	.a80b	20 69 ae	jsr $ae69	                jsr LAACA
4743	.a80e	80 e6		bra $a7f6	                bra LA3D3

4745	.a810					LA3F6:
4746						                .if version<500
4754						                .endif
4755	.a810	60		rts		                rts

4757						                .if version!=400
4758	.a811					LA401:
4759	.a811	20 7f ae	jsr $ae7f	                jsr LAAE0
4760	.a814	f0 fa		beq $a810	                beq LA3F6
4761	.a816	b2 cc		lda ($cc)	                lda ($CC)
4762	.a818	a8		tay		                tay
4763						                .if version<500
4770						                .endif

4772	.a819	b2 c8		lda ($c8)	                lda ($C8)
4773	.a81b	e6 c8		inc $c8		                inc $C8
4774	.a81d	d0 02		bne $a821	                bne LA41A
4775	.a81f	e6 c9		inc $c9		                inc $C9
4776	.a821					LA41A:
4777	.a821	20 9e a7	jsr $a79e	                jsr bgetTapeOrROM
4778	.a824	20 69 ae	jsr $ae69	                jsr LAACA
4779	.a827	80 e8		bra $a811	                bra LA401
4780						                .endif

4782						; TAPE/ROM FSC 0 - *OPT
4783						; ---------------------
4784	.a829					LA422:
4785	.a829	8a		txa		                txa                          ; *OPT 0
4786	.a82a	f0 2e		beq $a85a	                beq LA453
4787	.a82c	e0 03		cpx #$03	                cpx #$03                     ; *OPT 3
4788	.a82e	f0 1f		beq $a84f	                beq LA448
4789	.a830	c0 03		cpy #$03	                cpy #$03                     ; *OPT n,3+ - error Bad command (*BUG* should be Bad option)
4790	.a832	b0 06		bcs $a83a	                bcs LA433
4791	.a834	ca		dex		                dex                          ; *OPT 1
4792	.a835	f0 06		beq $a83d	                beq LA436
4793	.a837	ca		dex		                dex                          ; *OPT 2
4794	.a838	f0 0a		beq $a844	                beq LA43D
4795	.a83a					LA433:
4796	.a83a	4c 3d fb	jmp $fb3d	                jmp mos.badCommandError ; *OPT 4+ - error Bad command (*BUG* should be Bad option)

4798						; *OPT 1 - set message level
4799						; --------------------------
4800	.a83d					LA436:
4801	.a83d	a9 33		lda #$33	                lda #$33
4802	.a83f	c8		iny		                iny
4803	.a840	c8		iny		                iny
4804	.a841	c8		iny		                iny
4805	.a842	80 02		bra $a846	                bra LA43F

4807						; *OPT 2 - set error response level
4808						; ---------------------------------
4809	.a844					LA43D:
4810	.a844	a9 cc		lda #$cc	                lda #$CC
4811	.a846					LA43F:
4812	.a846	c8		iny		                iny
4813	.a847	25 e3		and $e3		                and $E3
4814	.a849					LA442:
4815	.a849	19 5d a8	ora $a85d,y	                ora LA456,y
4816	.a84c	85 e3		sta $e3		                sta $E3
4817	.a84e	60		rts		                rts

4819						; *OPT 3 - set interblock gap
4820						; ---------------------------
4821	.a84f					LA448:
4822	.a84f	98		tya		                tya                          ; *OPT 3,128+ - set to default
4823	.a850	30 02		bmi $a854	                bmi LA44D    ;
4824	.a852	d0 02		bne $a856	                bne LA44F                    ; *OPT 3,<>0 - use setting
4825	.a854					LA44D:
4826	.a854	a9 19		lda #$19	                lda #$19                     ; *OPT 3,0 or *OPT 3,128+ - use default of 2.5 sec
4827	.a856					LA44F:
4828	.a856	8d d1 03	sta $03d1	                sta $03D1                    ; Set inter-block gap
4829	.a859	60		rts		                rts

4831	.a85a					LA453:
4832	.a85a	a8		tay		                tay
4833	.a85b	80 ec		bra $a849	                bra LA442

4835	.a85d					LA456:
4836						                ; LDA ($00,x)
4837						                ; EQUB $22
4838						                ; ORA ($00),y
4839						                ; DEY
4840						                ; CPY LC0C6
4841	>a85d	a1				                .byte $A1
4842	>a85e	00				                .byte $00
4843	>a85f	22				                .byte $22
4844	>a860	11				                .byte $11
4845	>a861	00				                .byte $00
4846	>a862	88				                .byte $88
4847	>a863	cc				                .byte $CC

4849						                .if version!=400
4850	.a864					LA45D:
4851	.a864	c6 c0		dec $c0		                dec $C0
4852	.a866	ad 47 02	lda $0247	                lda cfsRFSFSSwitch
4853	.a869	f0 07		beq $a872	                beq LA46B
4854	.a86b	20 0c f5	jsr $f50c	                jsr mos.LF710
4855	.a86e	a8		tay		                tay
4856	.a86f	18		clc		                clc
4857	.a870	80 1a		bra $a88c	                bra LA485

4859	.a872					LA46B:
4860	.a872	ad 08 fe	lda $fe08	                lda ACIA+0
4861	.a875	48		pha		                pha
4862	.a876	29 02		and #$02	                and #$02
4863	.a878	f0 0b		beq $a885	                beq LA47E
4864	.a87a	a4 ca		ldy $ca		                ldy $CA
4865	.a87c	f0 07		beq $a885	                beq LA47E
4866	.a87e	68		pla		                pla
4867	.a87f	a5 bd		lda $bd		                lda $BD
4868	.a881	8d 09 fe	sta $fe09	                sta ACIA+1
4869	.a884	60		rts		                rts

4871	.a885					LA47E:
4872	.a885	ac 09 fe	ldy $fe09	                ldy ACIA+1
4873	.a888	68		pla		                pla
4874	.a889	4a		lsr a		                lsr a
4875	.a88a	4a		lsr a		                lsr a
4876	.a88b	4a		lsr a		                lsr a
4877	.a88c					LA485:
4878	.a88c	a6 c2		ldx $c2		                ldx $C2
4879	.a88e	f0 5c		beq $a8ec	                beq LA4F0
4880	.a890	ca		dex		                dex
4881	.a891	d0 06		bne $a899	                bne LA492
4882	.a893	90 57		bcc $a8ec	                bcc LA4F0
4883	.a895	a0 02		ldy #$02	                ldy #$02
4884	.a897	80 51		bra $a8ea	                bra LA4EE
4885						                .endif

4887	.a899					LA492:
4888						                .if version==400
4897						                .else
4898	.a899	ca		dex		                dex
4899	.a89a	d0 13		bne $a8af	                bne LA4A8
4900	.a89c	b0 4e		bcs $a8ec	                bcs LA4F0
4901						                .endif
4902	.a89e	98		tya		                tya
4903	.a89f	20 09 ae	jsr $ae09	                jsr LAA44
4904	.a8a2	a0 03		ldy #$03	                ldy #$03
4905	.a8a4	c9 2a		cmp #$2a	                cmp #$2A
4906	.a8a6	f0 42		beq $a8ea	                beq LA4EE
4907	.a8a8	20 e1 ad	jsr $ade1	                jsr LAA1C
4908	.a8ab	a0 01		ldy #$01	                ldy #$01
4909	.a8ad	80 3b		bra $a8ea	                bra LA4EE

4911	.a8af					LA4A8:
4912	.a8af	ca		dex		                dex
4913	.a8b0	d0 0a		bne $a8bc	                bne LA4B5
4914						                .if version!=400
4915	.a8b2	b0 03		bcs $a8b7	                bcs LA4B0
4916						                .endif
4917	.a8b4	84 bd		sty $bd		                sty $BD
4918	.a8b6	60		rts		                rts

4920						                .if version!=400
4921	.a8b7					LA4B0:
4922	.a8b7	a9 80		lda #$80	                lda #$80
4923	.a8b9	85 c0		sta $c0		                sta $C0
4924	.a8bb	60		rts		                rts
4925						                .endif

4927	.a8bc					LA4B5:
4928	.a8bc	ca		dex		                dex
4929	.a8bd	d0 1e		bne $a8dd	                bne LA4E1
4930						                .if version!=400
4931	.a8bf	b0 24		bcs $a8e5	                bcs LA4E9
4932						                .endif
4933	.a8c1	98		tya		                tya
4934	.a8c2	20 a5 aa	jsr $aaa5	                jsr LA6A9
4935	.a8c5	a4 bc		ldy $bc		                ldy $BC
4936	.a8c7	e6 bc		inc $bc		                inc $BC
4937	.a8c9	24 bd		bit $bd		                bit $BD
4938	.a8cb	30 02		bmi $a8cf	                bmi LA4D3
4939						                .if version<500
4947						                .endif
4948	.a8cd	91 b0		sta ($b0),y	                sta ($B0),y
4949	.a8cf					LA4D3:
4950	.a8cf	c8		iny		                iny
4951	.a8d0	cc c8 03	cpy $03c8	                cpy $03C8
4952	.a8d3	d0 17		bne $a8ec	                bne LA4F0
4953	.a8d5	a9 01		lda #$01	                lda #$01
4954	.a8d7	85 bc		sta $bc		                sta $BC
4955	.a8d9	a0 05		ldy #$05	                ldy #$05
4956	.a8db	80 0d		bra $a8ea	                bra LA4EE

4958	.a8dd					LA4E1:
4959	.a8dd	98		tya		                tya
4960	.a8de	20 a5 aa	jsr $aaa5	                jsr LA6A9
4961	.a8e1	c6 bc		dec $bc		                dec $BC
4962	.a8e3	10 07		bpl $a8ec	                bpl LA4F0
4963						                .if version!=400
4964	.a8e5					LA4E9:
4965	.a8e5	20 d7 ad	jsr $add7	                jsr resetACIA
4966						                .endif
4967	.a8e8	a0 00		ldy #$00	                ldy #$00
4968	.a8ea					LA4EE:
4969	.a8ea	84 c2		sty $c2		                sty $C2
4970	.a8ec					LA4F0:
4971	.a8ec	60		rts		                rts

4973						; TAPE/ROM FSC 1 - =EOF
4974						; ---------------------
4975	.a8ed					LA4F1:
4976	.a8ed	48		pha		                pha
4977	.a8ee	5a		phy		                phy
4978	.a8ef	8a		txa		                txa
4979	.a8f0	a8		tay		                tay
4980	.a8f1	a9 03		lda #$03	                lda #$03                     ; Check if this channel is open for anything
4981	.a8f3	20 2d ae	jsr $ae2d	                jsr LAA68
4982	.a8f6	a5 e2		lda $e2		                lda $E2                      ; Get EOF flag
4983	.a8f8	29 40		and #$40	                and #$40
4984	.a8fa	aa		tax		                tax                          ; Return in X
4985	.a8fb	7a		ply		                ply
4986	.a8fc	68		pla		                pla
4987	.a8fd	60		rts		                rts

4989	.a8fe					LA502:
4990	.a8fe	64 b4		stz $b4		                stz $B4
4991	.a900	64 b5		stz $b5		                stz $B5
4992	.a902					LA506:
4993	.a902	46 ce		lsr $ce		                lsr $CE
4994	.a904	a5 b4		lda $b4		                lda $B4
4995	.a906	48		pha		                pha
4996	.a907	85 b6		sta $b6		                sta $B6
4997	.a909	a5 b5		lda $b5		                lda $B5
4998	.a90b	48		pha		                pha
4999	.a90c	85 b7		sta $b7		                sta $B7
5000	.a90e	20 f2 ac	jsr $acf2	                jsr LA923
5001	>a911	53 65 61 72 63 68 69 6e		                .text "Searching",13,0
	>a919	67 0d 00
5002	.a91c	a9 ff		lda #$ff	                lda #$ff
5003	.a91e	20 cf a5	jsr $a5cf	                jsr LA17C
5004	.a921	68		pla		                pla
5005	.a922	85 b5		sta $b5		                sta $B5
5006	.a924	68		pla		                pla
5007	.a925	85 b4		sta $b4		                sta $B4
5008	.a927	a5 b6		lda $b6		                lda $B6
5009	.a929	05 b7		ora $b7		                ora $B7
5010	.a92b	d0 33		bne $a960	                bne LA564
5011	.a92d	64 b4		stz $b4		                stz $B4
5012	.a92f	64 b5		stz $b5		                stz $B5
5013						                .if version!=400
5014	.a931	ad 47 02	lda $0247	                lda cfsRFSFSSwitch
5015	.a934	f0 21		beq $a957	                beq LA55B
5016						                .endif
5017	.a936	70 1f		bvs $a957	                bvs LA55B
5018						                .if version!=400
5019	.a938	20 8f ad	jsr $ad8f	                jsr LA9CA
5020						                .endif
5021	.a93b	24 ce		bit $ce		                bit $CE
5022	.a93d	50 0a		bvc $a949	                bvc notFoundError
5023	.a93f	38		sec		                sec
5024	.a940					rtsA544:
5025	.a940	60		rts		                rts

5027						;-------------------------------------------------------------------------

5029	.a941					openFileForReading:
5030	.a941	a9 40		lda #$40	                lda #$40                     ;open for reading
5031	.a943	20 ce ff	jsr $ffce	                jsr OSFIND
5032	.a946	a8		tay		                tay
5033	.a947	d0 f7		bne $a940	                bne rtsA544
5034	.a949					notFoundError:
5035	.a949	20 8c ae	jsr $ae8c	                jsr doFollowingError
5036	>a94c	d6 4e 6f 74 20 66 6f 75		                .text $d6,"Not found",0
	>a954	6e 64 00

5038						;-------------------------------------------------------------------------

5040	.a957					LA55B:
5041	.a957	a5 c1		lda $c1		                lda $C1
5042	.a959	d0 05		bne $a960	                bne LA564
5043	.a95b	a2 b1		ldx #$b1	                ldx #$B1
5044	.a95d	20 12 ae	jsr $ae12	                jsr LAA4D
5045	.a960					LA564:
5046	.a960	a0 ff		ldy #$ff	                ldy #$FF
5047	.a962	8c df 03	sty $03df	                sty $03DF
5048	.a965	18		clc		                clc
5049	.a966	60		rts		                rts

5051	.a967					LA56B:
5052	.a967	f0 17		beq $a980	                beq LA584
5053	.a969	48		pha		                pha
5054	.a96a	a9 07		lda #$07	                lda #fscFileHandleRange
5055	.a96c	20 93 f2	jsr $f293	                jsr mos.callFSCV
5056	.a96f	68		pla		                pla
5057	.a970	18		clc		                clc
5058	.a971	08		php		                php
5059	.a972	78		sei		                sei
5060	.a973	85 fa		sta $fa		                sta $FA
5061	.a975	c4 fa		cpy $fa		                cpy $FA
5062	.a977	90 06		bcc $a97f	                bcc LA583
5063	.a979	e4 fa		cpx $fa		                cpx $FA
5064	.a97b	90 06		bcc $a983	                bcc LA587
5065	.a97d	f0 04		beq $a983	                beq LA587
5066	.a97f					LA583:
5067	.a97f	28		plp		                plp
5068	.a980					LA584:
5069	.a980	68		pla		                pla
5070	.a981	68		pla		                pla
5071	.a982	60		rts		                rts

5073	.a983					LA587:
5074	.a983	28		plp		                plp
5075	.a984	a9 00		lda #$00	                lda #$00
5076	.a986	60		rts		                rts

5078	.a987					LA58B:
5079	.a987	ad 56 02	lda $0256	                lda execFileHandle
5080	.a98a	20 67 a9	jsr $a967	                jsr LA56B
5081	.a98d					starEXEC:
5082	.a98d	08		php		                php
5083	.a98e	5a		phy		                phy
5084	.a98f	ac 56 02	ldy $0256	                ldy execFileHandle
5085	.a992	8d 56 02	sta $0256	                sta execFileHandle
5086	.a995	f0 03		beq $a99a	                beq LA59E
5087	.a997	20 ce ff	jsr $ffce	                jsr OSFIND
5088	.a99a					LA59E:
5089	.a99a	4e c6 df	lsr $dfc6	                lsr hazel.tempFSFlag
5090	.a99d	7a		ply		                ply
5091	.a99e	28		plp		                plp
5092	.a99f	f0 09		beq $a9aa	                beq LA5AE
5093	.a9a1	0e c6 df	asl $dfc6	                asl hazel.tempFSFlag
5094	.a9a4	20 41 a9	jsr $a941	                jsr openFileForReading
5095	.a9a7	8d 56 02	sta $0256	                sta execFileHandle
5096	.a9aa					LA5AE:
5097	.a9aa	60		rts		                rts

5099	.a9ab					LA5AF:
5100	.a9ab	a2 a6		ldx #$a6	                ldx #$A6
5101	.a9ad	20 12 ae	jsr $ae12	                jsr LAA4D
5102	.a9b0	20 74 aa	jsr $aa74	                jsr LA678
5103	.a9b3					LA5B7:
5104	.a9b3	ad ca 03	lda $03ca	                lda $03CA
5105	.a9b6	4a		lsr a		                lsr a
5106	.a9b7	90 03		bcc $a9bc	                bcc LA5C0
5107	.a9b9	4c 57 a4	jmp $a457	                jmp L9FE3

5109	.a9bc					LA5C0:
5110	.a9bc	ad dd 03	lda $03dd	                lda $03DD
5111	.a9bf	85 b4		sta $b4		                sta $B4
5112	.a9c1	ad de 03	lda $03de	                lda $03DE
5113	.a9c4	85 b5		sta $b5		                sta $B5
5114	.a9c6	64 b0		stz $b0		                stz $B0
5115	.a9c8	a9 0a		lda #$0a	                lda #$0A
5116	.a9ca	85 b1		sta $b1		                sta $B1
5117	.a9cc	a9 ff		lda #$ff	                lda #$FF
5118	.a9ce	85 b2		sta $b2		                sta $B2
5119	.a9d0	85 b3		sta $b3		                sta $B3
5120	.a9d2	20 ab aa	jsr $aaab	                jsr LA6D2
5121	.a9d5	20 70 ac	jsr $ac70	                jsr LA8A1
5122	.a9d8	d0 25		bne $a9ff	                bne LA603
5123	.a9da	ad ff 0a	lda $0aff	                lda $0AFF
5124	.a9dd	8d ec 02	sta $02ec	                sta lastCharacterOfCurrentlyResidentBlock
5125	.a9e0	20 fa ad	jsr $adfa	                jsr LAA35
5126	.a9e3	8e dd 03	stx $03dd	                stx $03DD
5127	.a9e6	8c de 03	sty $03de	                sty $03DE
5128	.a9e9	a2 02		ldx #$02	                ldx #$02
5129	.a9eb					LA5EF:
5130	.a9eb	bd c8 03	lda $03c8,x	                lda $03C8,x
5131	.a9ee	9d e9 02	sta $02e9,x	                sta tapeInputCurrentBlockSize+0,x
5132	.a9f1	ca		dex		                dex
5133	.a9f2	10 f7		bpl $a9eb	                bpl LA5EF
5134	.a9f4	2c eb 02	bit $02eb	                bit blockFlagOfCurrentlyResidentBlock
5135	.a9f7	10 03		bpl $a9fc	                bpl LA600
5136	.a9f9	20 c8 a4	jsr $a4c8	                jsr LA059
5137	.a9fc					LA600:
5138	.a9fc	4c 8a ad	jmp $ad8a	                jmp LA9C5

5140	.a9ff					LA603:
5141	.a9ff	20 02 a9	jsr $a902	                jsr LA506
5142	.aa02	80 af		bra $a9b3	                bra LA5B7

5144	.aa04					LA608:
5145	.aa04	c9 2a		cmp #$2a	                cmp #'*'
5146	.aa06	f0 37		beq $aa3f	                beq LA643
5147	.aa08	c9 23		cmp #$23	                cmp #'#'
5148	.aa0a	d0 0f		bne $aa1b	                bne LA61F
5149	.aa0c	ee c6 03	inc $03c6	                inc $03C6
5150	.aa0f	d0 03		bne $aa14	                bne LA618
5151	.aa11	ee c7 03	inc $03c7	                inc $03C7
5152	.aa14					LA618:
5153	.aa14	a2 ff		ldx #$ff	                ldx #$FF
5154	.aa16	2c 70 e3	bit $e370	                bit mos.valueFF
5155	.aa19	80 51		bra $aa6c	                bra LA670

5157	.aa1b					LA61F:
5158	.aa1b	20 ca a5	jsr $a5ca	                jsr LA177
5159	.aa1e	20 8c ae	jsr $ae8c	                jsr doFollowingError
5160	>aa21	d7				                .byte $D7
5161	>aa22	42 61 64 20 52 4f 4d		                .text "Bad ROM"
5162	>aa29	00				                .byte 0

5164	.aa2a					LA62E:
5165						                .if version!=400
5166	.aa2a	a0 ff		ldy #$ff	                ldy #$FF
5167	.aa2c	20 21 ae	jsr $ae21	                jsr LAA5C
5168	.aa2f	a9 01		lda #$01	                lda #$01
5169	.aa31	85 c2		sta $c2		                sta $C2
5170	.aa33	20 e1 ad	jsr $ade1	                jsr LAA1C
5171	.aa36					LA63A:
5172	.aa36	20 4f ac	jsr $ac4f	                jsr LA880
5173	.aa39	a9 03		lda #$03	                lda #$03
5174	.aa3b	c5 c2		cmp $c2		                cmp $C2
5175	.aa3d	d0 f7		bne $aa36	                bne LA63A
5176						                .endif
5177	.aa3f					LA643:
5178	.aa3f	20 0b ae	jsr $ae0b	                jsr LAA46
5179	.aa42					LA646:
5180	.aa42	20 90 aa	jsr $aa90	                jsr LA694
5181	.aa45	50 1a		bvc $aa61	                bvc LA665
5182	.aa47	99 b2 03	sta $03b2,y	                sta $03B2,y
5183	.aa4a	f0 06		beq $aa52	                beq LA656
5184	.aa4c	c8		iny		                iny
5185	.aa4d	c0 0b		cpy #$0b	                cpy #$0B
5186	.aa4f	d0 f1		bne $aa42	                bne LA646
5187	.aa51	88		dey		                dey
5188	.aa52					LA656:
5189	.aa52	a2 0c		ldx #$0c	                ldx #$0C
5190	.aa54					LA658:
5191	.aa54	20 90 aa	jsr $aa90	                jsr LA694
5192	.aa57	50 08		bvc $aa61	                bvc LA665
5193	.aa59	9d b2 03	sta $03b2,x	                sta $03B2,x
5194	.aa5c	e8		inx		                inx
5195	.aa5d	e0 1f		cpx #$1f	                cpx #$1F
5196	.aa5f	d0 f3		bne $aa54	                bne LA658
5197	.aa61					LA665:
5198	.aa61	98		tya		                tya
5199	.aa62	aa		tax		                tax
5200	.aa63	9e b2 03	stz $03b2,x	                stz $03B2,x
5201	.aa66	a5 be		lda $be		                lda $BE
5202	.aa68	05 bf		ora $bf		                ora $BF
5203	.aa6a	85 c1		sta $c1		                sta $C1
5204	.aa6c					LA670:
5205	.aa6c	20 09 ae	jsr $ae09	                jsr LAA44
5206	.aa6f	84 c2		sty $c2		                sty $C2
5207	.aa71	8a		txa		                txa
5208						                .if version<500
5210						                .elsif version>=500
5211	.aa72	d0 4d		bne $aac1	                bne rtsAAC1
5212						                .endif
5213	.aa74					LA678:
5214						                .if version!=400
5215	.aa74	ad 47 02	lda $0247	                lda cfsRFSFSSwitch
5216	.aa77	f0 b1		beq $aa2a	                beq LA62E
5217						                .endif
5218	.aa79					LA67D:
5219	.aa79	20 0c f5	jsr $f50c	                jsr mos.LF710
5220	.aa7c	c9 2b		cmp #$2b	                cmp #$2B
5221	.aa7e	d0 84		bne $aa04	                bne LA608
5222	.aa80	a9 08		lda #$08	                lda #$08
5223	.aa82	25 e2		and $e2		                and $E2
5224	.aa84	f0 03		beq $aa89	                beq LA68D
5225	.aa86	20 cc a4	jsr $a4cc	                jsr LA05D
5226	.aa89					LA68D:
5227	.aa89	20 fd f4	jsr $f4fd	                jsr mos.LF701
5228	.aa8c	90 eb		bcc $aa79	                bcc LA67D
5229	.aa8e	b8		clv		                clv
5230	.aa8f	60		rts		                rts

5232	.aa90					LA694:
5233						                .if version!=400
5234	.aa90	ad 47 02	lda $0247	                lda cfsRFSFSSwitch
5235	.aa93	f0 0d		beq $aaa2	                beq LA6A6
5236						                .endif
5237	.aa95	da		phx		                phx
5238	.aa96	5a		phy		                phy
5239	.aa97	20 0c f5	jsr $f50c	                jsr mos.LF710
5240	.aa9a	85 bd		sta $bd		                sta $BD
5241	.aa9c	a9 ff		lda #$ff	                lda #$FF
5242	.aa9e	85 c0		sta $c0		                sta $C0
5243	.aaa0	7a		ply		                ply
5244	.aaa1	fa		plx		                plx
5245	.aaa2					LA6A6:
5246	.aaa2	20 47 ab	jsr $ab47	                jsr LA778
5247	.aaa5					LA6A9:
5248						                .if version<500
5272						                .endif
5273	.aaa5					LA6CC:
5274	.aaa5	60		rts		                rts

5276						                .if version!=400
5277	.aaa6					LA6CD:                                       ;AAA6 in MOS 5.00
5278	.aaa6	20 45 ab	jsr $ab45	                jsr LA776
5279	.aaa9	80 fa		bra $aaa5	                bra LA6A9
5280						                .endif

5282	.aaab					LA6D2:                                       ;AAAB in MOS 5.00
5283	.aaab	a9 00		lda #$00	                lda #$00
5284	.aaad					LA6D4:
5285	.aaad	85 bd		sta $bd		                sta $BD
5286	.aaaf	a2 00		ldx #$00	                ldx #$00
5287	.aab1	64 bc		stz $bc		                stz $BC
5288	.aab3	50 0a		bvc $aabf	                bvc LA6E6
5289	.aab5	ad c8 03	lda $03c8	                lda $03C8
5290	.aab8	0d c9 03	ora $03c9	                ora $03C9
5291	.aabb	f0 02		beq $aabf	                beq LA6E6
5292	.aabd	a2 04		ldx #$04	                ldx #$04
5293	.aabf					LA6E6:
5294	.aabf	86 c2		stx $c2		                stx $C2
5295	.aac1					rtsAAC1:
5296	.aac1	60		rts		                rts

5298						                .if version!=400
5299	.aac2					LA6E9:                                       ;AAC2 in MOS 5.00
5300	.aac2	08		php		                php
5301	.aac3	a2 03		ldx #$03	                ldx #$03
5302	.aac5					LA6EC:
5303	.aac5	9e cb 03	stz $03cb,x	                stz $03CB,x
5304	.aac8	ca		dex		                dex
5305	.aac9	10 fa		bpl $aac5	                bpl LA6EC
5306	.aacb	ad c6 03	lda $03c6	                lda $03C6
5307	.aace	0d c7 03	ora $03c7	                ora $03C7
5308	.aad1	d0 05		bne $aad8	                bne LA6FF
5309	.aad3	20 53 ab	jsr $ab53	                jsr LA784
5310	.aad6	80 03		bra $aadb	                bra LA702

5312	.aad8					LA6FF:
5313	.aad8	20 57 ab	jsr $ab57	                jsr LA788
5314	.aadb					LA702:
5315	.aadb	a9 2a		lda #$2a	                lda #$2A
5316	.aadd	85 bd		sta $bd		                sta $BD
5317	.aadf	20 09 ae	jsr $ae09	                jsr LAA44
5318	.aae2	20 db ad	jsr $addb	                jsr LAA16
5319	.aae5	20 47 ab	jsr $ab47	                jsr LA778
5320	.aae8	88		dey		                dey
5321	.aae9					LA710:
5322	.aae9	c8		iny		                iny
5323	.aaea	b9 d2 03	lda $03d2,y	                lda $03D2,y
5324	.aaed	99 b2 03	sta $03b2,y	                sta $03B2,y
5325	.aaf0	20 a6 aa	jsr $aaa6	                jsr LA6CD
5326	.aaf3	d0 f4		bne $aae9	                bne LA710
5327	.aaf5	a2 0c		ldx #$0c	                ldx #$0C
5328	.aaf7					LA71E:
5329	.aaf7	bd b2 03	lda $03b2,x	                lda $03B2,x
5330	.aafa	20 a6 aa	jsr $aaa6	                jsr LA6CD
5331	.aafd	e8		inx		                inx
5332	.aafe	e0 1d		cpx #$1d	                cpx #$1D
5333	.ab00	d0 f5		bne $aaf7	                bne LA71E
5334	.ab02	20 3e ab	jsr $ab3e	                jsr LA76F
5335	.ab05	ad c8 03	lda $03c8	                lda $03C8
5336	.ab08	0d c9 03	ora $03c9	                ora $03C9
5337	.ab0b	f0 11		beq $ab1e	                beq LA74F
5338	.ab0d	20 0b ae	jsr $ae0b	                jsr LAA46
5339	.ab10					LA737:
5340						                .if version<500
5346						                .endif
5347	.ab10	b1 b0		lda ($b0),y	                lda ($B0),y
5348	.ab12					LA743:
5349	.ab12	20 a6 aa	jsr $aaa6	                jsr LA6CD
5350	.ab15	c8		iny		                iny
5351	.ab16	cc c8 03	cpy $03c8	                cpy $03C8
5352	.ab19	d0 f5		bne $ab10	                bne LA737
5353	.ab1b	20 3e ab	jsr $ab3e	                jsr LA76F
5354	.ab1e					LA74F:
5355	.ab1e	20 47 ab	jsr $ab47	                jsr LA778
5356	.ab21	20 47 ab	jsr $ab47	                jsr LA778
5357	.ab24	20 d7 ad	jsr $add7	                jsr resetACIA
5358	.ab27	a9 01		lda #$01	                lda #$01
5359	.ab29	20 59 ab	jsr $ab59	                jsr LA78A
5360	.ab2c	28		plp		                plp
5361	.ab2d	20 7a ab	jsr $ab7a	                jsr LA7AB
5362	.ab30	2c ca 03	bit $03ca	                bit $03CA
5363	.ab33	10 08		bpl $ab3d	                bpl LA76E
5364	.ab35	08		php		                php
5365	.ab36	20 53 ab	jsr $ab53	                jsr LA784
5366	.ab39	20 c5 a4	jsr $a4c5	                jsr LA056
5367	.ab3c	28		plp		                plp
5368	.ab3d					LA76E:
5369	.ab3d	60		rts		                rts

5371	.ab3e					LA76F:
5372						                .if version<500
5374						                .elsif version>=500
5375	.ab3e	a9 00		lda #$00	                lda #0
5376						                .endif
5377	.ab40	20 45 ab	jsr $ab45	                jsr LA776
5378						                .if version<500
5380						                .elsif version>=500
5381	.ab43	a9 00		lda #$00	                lda #0
5382						                .endif
5383	.ab45					LA776:
5384	.ab45	85 bd		sta $bd		                sta $BD
5385						                .endif

5387	.ab47					LA778:
5388	.ab47	20 4f ac	jsr $ac4f	                jsr LA880
5389	.ab4a	24 c0		bit $c0		                bit $C0
5390	.ab4c	10 f9		bpl $ab47	                bpl LA778
5391	.ab4e	64 c0		stz $c0		                stz $C0
5392	.ab50	a5 bd		lda $bd		                lda $BD
5393	.ab52	60		rts		                rts

5395						                .if version!=400
5396	.ab53					LA784:
5397	.ab53	a9 32		lda #$32	                lda #$32
5398	.ab55	80 02		bra $ab59	                bra LA78A

5400	.ab57					LA788:
5401	.ab57	a5 c7		lda $c7		                lda $C7
5402	.ab59					LA78A:
5403	.ab59	a2 05		ldx #$05	                ldx #$05
5404	.ab5b					LA78C:
5405	.ab5b	8d 40 02	sta $0240	                sta cfsTimeoutCounter
5406	.ab5e					LA78F:
5407	.ab5e	20 4f ac	jsr $ac4f	                jsr LA880
5408	.ab61	2c 40 02	bit $0240	                bit cfsTimeoutCounter
5409	.ab64	10 f8		bpl $ab5e	                bpl LA78F
5410	.ab66	ca		dex		                dex
5411	.ab67	d0 f2		bne $ab5b	                bne LA78C
5412	.ab69	60		rts		                rts
5413						                .endif

5415	.ab6a					LA79B:
5416	.ab6a	ad c6 03	lda $03c6	                lda $03C6
5417	.ab6d	0d c7 03	ora $03c7	                ora $03C7
5418	.ab70	f0 05		beq $ab77	                beq LA7A8
5419	.ab72	2c df 03	bit $03df	                bit $03DF
5420	.ab75	10 03		bpl $ab7a	                bpl LA7AB
5421	.ab77					LA7A8:
5422	.ab77	20 c8 a4	jsr $a4c8	                jsr LA059
5423	.ab7a					LA7AB:
5424	.ab7a	a0 00		ldy #$00	                ldy #$00
5425	.ab7c	64 ba		stz $ba		                stz $BA
5426	.ab7e	ad ca 03	lda $03ca	                lda $03CA
5427	.ab81	8d df 03	sta $03df	                sta $03DF
5428	.ab84	20 41 ef	jsr $ef41	                jsr mos.LEF1B
5429	.ab87	f0 67		beq $abf0	                beq LA821
5430	.ab89	a9 0d		lda #$0d	                lda #$0D
5431	.ab8b	20 ee ff	jsr $ffee	                jsr OSWRCH
5432	.ab8e					LA7BF:
5433	.ab8e	b9 b2 03	lda $03b2,y	                lda $03B2,y
5434	.ab91	f0 10		beq $aba3	                beq LA7D4
5435	.ab93	c9 20		cmp #$20	                cmp #$20
5436	.ab95	90 04		bcc $ab9b	                bcc LA7CC
5437	.ab97	c9 7f		cmp #$7f	                cmp #$7F
5438	.ab99	90 02		bcc $ab9d	                bcc LA7CE
5439	.ab9b					LA7CC:
5440	.ab9b	a9 3f		lda #$3f	                lda #$3F
5441	.ab9d					LA7CE:
5442	.ab9d	20 ee ff	jsr $ffee	                jsr OSWRCH
5443	.aba0	c8		iny		                iny
5444	.aba1	d0 eb		bne $ab8e	                bne LA7BF

5446	.aba3					LA7D4:
5447						                .if version!=400
5448	.aba3	ad 47 02	lda $0247	                lda cfsRFSFSSwitch
5449	.aba6	f0 04		beq $abac	                beq LA7DD
5450						                .endif
5451	.aba8	24 bb		bit $bb		                bit $BB
5452	.abaa	50 44		bvc $abf0	                bvc LA821
5453	.abac					LA7DD:
5454	.abac	20 80 a3	jsr $a380	                jsr printSpace
5455	.abaf	c8		iny		                iny
5456	.abb0	c0 0b		cpy #$0b	                cpy #$0B
5457	.abb2	90 ef		bcc $aba3	                bcc LA7D4
5458	.abb4	ad c6 03	lda $03c6	                lda $03C6
5459	.abb7	aa		tax		                tax
5460	.abb8	20 39 ac	jsr $ac39	                jsr printHexByte
5461	.abbb	2c ca 03	bit $03ca	                bit $03CA
5462	.abbe	10 30		bpl $abf0	                bpl LA821
5463	.abc0	8a		txa		                txa
5464	.abc1	18		clc		                clc
5465	.abc2	6d c9 03	adc $03c9	                adc $03C9
5466	.abc5	20 34 ac	jsr $ac34	                jsr printSpaceThenPrintHexByte
5467	.abc8					LA7F9:
5468	.abc8	ad c8 03	lda $03c8	                lda $03C8
5469	.abcb	20 39 ac	jsr $ac39	                jsr printHexByte
5470	.abce	24 bb		bit $bb		                bit $BB
5471	.abd0	50 1e		bvc $abf0	                bvc LA821
5472	.abd2	a2 04		ldx #$04	                ldx #$04
5473	.abd4					LA805:
5474	.abd4	20 80 a3	jsr $a380	                jsr printSpace
5475	.abd7	ca		dex		                dex
5476	.abd8	d0 fa		bne $abd4	                bne LA805
5477	.abda	a2 0f		ldx #$0f	                ldx #$0F
5478	.abdc	20 e4 ab	jsr $abe4	                jsr LA815
5479	.abdf	20 80 a3	jsr $a380	                jsr printSpace
5480	.abe2	a2 13		ldx #$13	                ldx #$13
5481	.abe4					LA815:
5482	.abe4	a0 04		ldy #$04	                ldy #$04
5483	.abe6					LA817:
5484	.abe6	bd b2 03	lda $03b2,x	                lda $03B2,x
5485	.abe9	20 39 ac	jsr $ac39	                jsr printHexByte
5486	.abec	ca		dex		                dex
5487	.abed	88		dey		                dey
5488	.abee	d0 f6		bne $abe6	                bne LA817
5489	.abf0					LA821:
5490	.abf0	60		rts		                rts

5492						                .if version!=400
5493	.abf1					LA822:
5494	.abf1	ad 47 02	lda $0247	                lda cfsRFSFSSwitch
5495	.abf4	f0 06		beq $abfc	                beq LA82D
5496	.abf6	20 8f ad	jsr $ad8f	                jsr LA9CA
5497	.abf9	4c 3d fb	jmp $fb3d	                jmp mos.badCommandError

5499	.abfc					LA82D:
5500	.abfc	20 1f ae	jsr $ae1f	                jsr LAA5A
5501	.abff	20 65 ae	jsr $ae65	                jsr LAAA0
5502	.ac02	20 41 ef	jsr $ef41	                jsr mos.LEF1B
5503	.ac05	f0 e9		beq $abf0	                beq LA821
5504	.ac07	20 f2 ac	jsr $acf2	                jsr LA923
5505	>ac0a	52 45 43 4f 52 44 20 74		                .text "RECORD then RETURN"
	>ac12	68 65 6e 20 52 45 54 55 52 4e
5506	>ac1c	00				                .byte $00

5508	.ac1d					LA84E:
5509	.ac1d	20 4f ac	jsr $ac4f	                jsr LA880
5510	.ac20	20 e0 ff	jsr $ffe0	                jsr OSRDCH
5511	.ac23	c9 0d		cmp #$0d	                cmp #$0D
5512	.ac25	d0 f6		bne $ac1d	                bne LA84E
5513	.ac27	4c e7 ff	jmp $ffe7	                jmp OSNEWL
5514						                .endif

5516						;-------------------------------------------------------------------------

5518						                .if version==350
5520						                .endif

5522						;-------------------------------------------------------------------------


5525	.ac2a					LA85B:
5526	.ac2a	a2 fd		ldx #$fd	                ldx #$FD
5527	.ac2c					LA85D:
5528	.ac2c	f6 b4		inc $b4,x	                inc $B4,x
5529	.ac2e	d0 03		bne $ac33	                bne LA864
5530	.ac30	e8		inx		                inx
5531	.ac31	d0 f9		bne $ac2c	                bne LA85D
5532	.ac33					LA864:
5533	.ac33	60		rts		                rts

5535						;-------------------------------------------------------------------------

5537	.ac34					printSpaceThenPrintHexByte:
5538	.ac34	48		pha		                pha
5539	.ac35	20 80 a3	jsr $a380	                jsr printSpace
5540	.ac38	68		pla		                pla
5541	.ac39					printHexByte:
5542	.ac39	48		pha		                pha
5543						                .if version==350
5545						                .else
5546	.ac3a	4a		lsr a		                lsr a
5547	.ac3b	4a		lsr a		                lsr a
5548	.ac3c	4a		lsr a		                lsr a
5549	.ac3d	4a		lsr a		                lsr a
5550						                .endif
5551	.ac3e	20 42 ac	jsr $ac42	                jsr printHexDigit
5552	.ac41	68		pla		                pla
5553	.ac42					printHexDigit:
5554	.ac42	29 0f		and #$0f	                and #$0F
5555	.ac44	09 30		ora #$30	                ora #'0'                     ;+'0'
5556	.ac46	c9 3a		cmp #$3a	                cmp #'9'+1
5557	.ac48	90 02		bcc $ac4c	                bcc LA87D                    ;taken if <='9'
5558	.ac4a	69 06		adc #$06	                adc #'A'-('9'+1)-1           ;adjust - -1 because C set
5559	.ac4c					LA87D:
5560	.ac4c	4c ee ff	jmp $ffee	                jmp OSWRCH

5562						;-------------------------------------------------------------------------

5564	.ac4f					LA880:
5565	.ac4f	08		php		                php
5566	.ac50	24 eb		bit $eb		                bit $EB
5567	.ac52	30 04		bmi $ac58	                bmi LA889
5568	.ac54	24 ff		bit $ff		                bit $FF
5569	.ac56	30 02		bmi $ac5a	                bmi LA88B
5570	.ac58					LA889:
5571	.ac58	28		plp		                plp
5572	.ac59	60		rts		                rts

5574	.ac5a					LA88B:
5575	.ac5a	20 ca a5	jsr $a5ca	                jsr LA177
5576	.ac5d	20 8a ad	jsr $ad8a	                jsr LA9BB
5577	.ac60					escapeError:
5578	.ac60	a9 7e		lda #$7e	                lda #$7E
5579	.ac62	20 f4 ff	jsr $fff4	                jsr OSBYTE
5580	.ac65	20 8c ae	jsr $ae8c	                jsr doFollowingError
5581	>ac68	11				                .byte $11
5582	>ac69	45 73 63 61 70 65		                .text "Escape"
5583	>ac6f	00				                .byte $00

5585						;-------------------------------------------------------------------------

5587	.ac70					LA8A1:
5588	.ac70	98		tya		                tya
5589	.ac71	f0 0d		beq $ac80	                beq LA8B1
5590	.ac73	20 f2 ac	jsr $acf2	                jsr LA923
5591	>ac76	0d				                .byte $0D
5592	>ac77	4c 6f 61 64 69 6e 67		                .text "Loading"
5593	>ac7e	0d				                .byte $0D
5594	>ac7f	00				                .byte $00
5595	.ac80					LA8B1:
5596	.ac80	64 ba		stz $ba		                stz $BA                      ; :
5597	.ac82	a2 ff		ldx #$ff	                ldx #$FF
5598	.ac84	a5 c1		lda $c1		                lda $C1
5599	.ac86	d0 0b		bne $ac93	                bne LA8C4
5600	.ac88	20 2b ad	jsr $ad2b	                jsr LA95C
5601	.ac8b	08		php		                php
5602	.ac8c	a2 ff		ldx #$ff	                ldx #$FF
5603	.ac8e	a0 b0		ldy #$b0	                ldy #<fileError
5604						                .cwarn (>fileError)!=(>dataError),"must be on same page"
5605	.ac90	28		plp		                plp
5606	.ac91	d0 16		bne $aca9	                bne LA8DA
5607	.ac93					LA8C4:
5608	.ac93	a0 a3		ldy #$a3	                ldy #<dataError
5609	.ac95	a5 c1		lda $c1		                lda $C1
5610	.ac97	d0 10		bne $aca9	                bne LA8DA
5611	.ac99	ad c6 03	lda $03c6	                lda $03C6
5612	.ac9c	c5 b4		cmp $b4		                cmp $B4
5613	.ac9e	d0 07		bne $aca7	                bne LA8D8
5614	.aca0	ad c7 03	lda $03c7	                lda $03C7
5615	.aca3	c5 b5		cmp $b5		                cmp $B5
5616	.aca5	f0 0b		beq $acb2	                beq LA8E3
5617	.aca7					LA8D8:
5618	.aca7	a0 bd		ldy #$bd	                ldy #<blockError
5619						                .cwarn (>blockError)!=(>dataError),"must be on same page"
5620	.aca9					LA8DA:
5621	.aca9	5a		phy		                phy
5622	.acaa	da		phx		                phx
5623	.acab	20 77 ab	jsr $ab77	                jsr LA7A8
5624	.acae	fa		plx		                plx
5625	.acaf	7a		ply		                ply
5626	.acb0	80 10		bra $acc2	                bra LA8F3

5628	.acb2					LA8E3:
5629	.acb2	da		phx		                phx
5630	.acb3	20 6a ab	jsr $ab6a	                jsr LA79B
5631	.acb6	20 6f ad	jsr $ad6f	                jsr LA9A0
5632	.acb9	fa		plx		                plx
5633	.acba	a5 be		lda $be		                lda $BE
5634	.acbc	05 bf		ora $bf		                ora $BF
5635	.acbe	f0 79		beq $ad39	                beq LA96A
5636	.acc0	a0 a3		ldy #$a3	                ldy #<dataError
5637	.acc2					LA8F3:
5638	.acc2	a9 ae		lda #$ae	                lda #>dataError
5639	.acc4	c6 ba		dec $ba		                dec $BA
5640	.acc6	48		pha		                pha
5641	.acc7	24 eb		bit $eb		                bit $EB
5642	.acc9	30 0d		bmi $acd8	                bmi LA909
5643	.accb	8a		txa		                txa
5644						                .if version!=400
5645	.accc	2d 47 02	and $0247	                and cfsRFSFSSwitch
5646	.accf					LA900:
5647						                .endif
5648	.accf	d0 07		bne $acd8	                bne LA909
5649	.acd1	8a		txa		                txa
5650	.acd2	29 11		and #$11	                and #$11
5651	.acd4	25 bb		and $bb		                and $BB
5652	.acd6	f0 0f		beq $ace7	                beq LA918
5653	.acd8					LA909:
5654	.acd8	68		pla		                pla
5655	.acd9	85 b9		sta $b9		                sta $B9
5656	.acdb	84 b8		sty $b8		                sty $B8
5657	.acdd	20 87 a9	jsr $a987	                jsr LA58B
5658	.ace0	46 eb		lsr $eb		                lsr $EB
5659	.ace2	20 80 ad	jsr $ad80	                jsr LA9B1
5660	.ace5	80 3d		bra $ad24	                bra LA955

5662	.ace7					LA918:
5663	.ace7	98		tya		                tya
5664	.ace8	18		clc		                clc
5665	.ace9	69 03		adc #$03	                adc #$03
5666	.aceb	a8		tay		                tay
5667	.acec	90 03		bcc $acf1	                bcc LA922
5668	.acee	68		pla		                pla
5669	.acef	1a		inc a		                inc a
5670	.acf0	48		pha		                pha
5671	.acf1					LA922:
5672	.acf1	5a		phy		                phy
5673	.acf2					LA923:
5674	.acf2	20 41 ef	jsr $ef41	                jsr mos.LEF1B
5675	.acf5	a8		tay		                tay

5677						;-------------------------------------------------------------------------
5678						;
5679						; Print 0-terminated message using address from stack.
5680						;
5681						; entry:
5682						;
5683						; S=[StrL; StrH] - where Str = (address of string)-1
5684						; Y = 0 to print message; otherwise, don't print message
5685						;
5686	.acf6					printFollowingMessage:                       ;
5687	.acf6	68		pla		                pla
5688	.acf7	85 b8		sta $b8		                sta printMessageAddress+0
5689	.acf9	68		pla		                pla
5690	.acfa	85 b9		sta $b9		                sta printMessageAddress+1
5691	.acfc	5a		phy		                phy                          ;save initial Y
5692	.acfd	98		tya		                tya                          ;Z=1 if Y=0
5693	.acfe	08		php		                php                          ;save Y=0 state
5694	.acff					fetchNextChar:
5695	.acff	e6 b8		inc $b8		                inc printMessageAddress+0
5696	.ad01	d0 02		bne $ad05	                bne +
5697	.ad03	e6 b9		inc $b9		                inc printMessageAddress+1
5698	.ad05					+
5699	.ad05	b2 b8		lda ($b8)	                lda (printMessageAddress)   ;fetch next char to print
5700	.ad07	f0 13		beq $ad1c	                beq printingFinished        ;branch taken if last char
5701	.ad09	28		plp		                plp                         ;restore Y=0 state
5702	.ad0a	08		php		                php                         ;save Y=0 state
5703	.ad0b	f0 f2		beq $acff	                beq fetchNextChar ;branch taken if Y=0 - i.e., skip the
5704						                                  ;printing

5706						                ; printMessageAddress is in the $b0-$bf area, so it
5707						                ; needs saving in case there's a *SPOOL going on.
5708	.ad0d	a4 b8		ldy $b8		                ldy printMessageAddress+0
5709	.ad0f	5a		phy		                phy
5710	.ad10	a4 b9		ldy $b9		                ldy printMessageAddress+1
5711	.ad12	20 e3 ff	jsr $ffe3	                jsr OSASCI
5712	.ad15	84 b9		sty $b9		                sty printMessageAddress+1
5713	.ad17	7a		ply		                ply
5714	.ad18	84 b8		sty $b8		                sty printMessageAddress+0

5716	.ad1a	80 e3		bra $acff	                bra fetchNextChar

5718	.ad1c					printingFinished:
5719	.ad1c	28		plp		                plp                          ;discard Y=0 state
5720	.ad1d	e6 b8		inc $b8		                inc printMessageAddress+0
5721	.ad1f	d0 02		bne $ad23	                bne +
5722	.ad21	e6 b9		inc $b9		                inc printMessageAddress+1
5723	.ad23					+
5724	.ad23	7a		ply		                ply                          ;restore initial Y
5725	.ad24					LA955:
5726	.ad24	6c b8 00	jmp ($00b8)	                jmp (printMessageAddress)

5728	.ad27					alwaysPrintFollowingMessage:
5729	.ad27	a0 01		ldy #$01	                ldy #$01
5730	.ad29	80 cb		bra $acf6	                bra printFollowingMessage

5732						;-------------------------------------------------------------------------

5734	.ad2b					LA95C:
5735	.ad2b	a2 ff		ldx #$ff	                ldx #$FF
5736	.ad2d					LA95E:
5737	.ad2d	e8		inx		                inx
5738	.ad2e	bd d2 03	lda $03d2,x	                lda $03D2,x
5739	.ad31	d0 07		bne $ad3a	                bne LA96B
5740	.ad33	8a		txa		                txa
5741	.ad34	f0 03		beq $ad39	                beq LA96A
5742	.ad36	bd b2 03	lda $03b2,x	                lda $03B2,x
5743	.ad39					LA96A:
5744	.ad39	60		rts		                rts

5746	.ad3a					LA96B:
5747	.ad3a	20 9c eb	jsr $eb9c	                jsr mos.isLetter
5748	.ad3d	5d b2 03	eor $03b2,x	                eor $03B2,x
5749	.ad40	b0 02		bcs $ad44	                bcs LA975
5750	.ad42	29 df		and #$df	                and #$DF
5751	.ad44					LA975:
5752	.ad44	f0 e7		beq $ad2d	                beq LA95E
5753	.ad46					LA977:
5754	.ad46	60		rts		                rts

5756	.ad47					LA978:
5757	.ad47	a5 ba		lda $ba		                lda $BA
5758	.ad49	f0 21		beq $ad6c	                beq LA99D
5759	.ad4b	8a		txa		                txa
5760	.ad4c	f0 1e		beq $ad6c	                beq LA99D
5761	.ad4e	a9 22		lda #$22	                lda #$22
5762	.ad50	24 bb		bit $bb		                bit $BB
5763	.ad52	f0 18		beq $ad6c	                beq LA99D
5764						                .if version!=400
5765	.ad54	20 d7 ad	jsr $add7	                jsr resetACIA
5766						                .endif
5767	.ad57	a8		tay		                tay
5768	.ad58	20 f6 ac	jsr $acf6	                jsr printFollowingMessage
5769	>ad5b	0d				                .byte $0D
5770	>ad5c	07				                .byte $07
5771	>ad5d	52 65 77 69 6e 64 20 74		                .text "Rewind tape"
	>ad65	61 70 65
5772	>ad68	0d				                .byte $0D
5773	>ad69	0d				                .byte $0D
5774	>ad6a	00				                .byte $00
5775	.ad6b	60		rts		                rts

5777	.ad6c					LA99D:
5778	.ad6c	20 cc a4	jsr $a4cc	                jsr LA05D
5779	.ad6f					LA9A0:
5780	.ad6f	a5 c2		lda $c2		                lda $C2
5781	.ad71	f0 d3		beq $ad46	                beq LA977
5782	.ad73	20 4f ac	jsr $ac4f	                jsr LA880
5783						                .if version!=400
5784	.ad76	ad 47 02	lda $0247	                lda cfsRFSFSSwitch
5785	.ad79	f0 f4		beq $ad6f	                beq LA9A0
5786						                .endif
5787						                .if version==400
5789						                .else
5790	.ad7b	20 64 a8	jsr $a864	                jsr LA45D
5791						                .endif
5792	.ad7e	80 ef		bra $ad6f	                bra LA9A0

5794	.ad80					LA9B1:
5795	.ad80	20 41 ef	jsr $ef41	                jsr mos.LEF1B
5796	.ad83	f0 05		beq $ad8a	                beq LA9BB
5797	.ad85					LA9B6:
5798	.ad85	a9 07		lda #$07	                lda #$07
5799	.ad87	20 ee ff	jsr $ffee	                jsr OSWRCH
5800	.ad8a					LA9BB:
5801						                .if version<500
5806						                .endif
5807	.ad8a					LA9C5:
5808						                .if version!=400
5809	.ad8a	a2 00		ldx #$00	                ldx #$00
5810	.ad8c	20 26 ae	jsr $ae26	                jsr LAA61
5811	.ad8f					LA9CA:
5812	.ad8f	08		php		                php
5813	.ad90	78		sei		                sei
5814	.ad91	ad 82 02	lda $0282	                lda serialULARegister
5815	.ad94	8d 10 fe	sta $fe10	                sta SERPROC+0
5816	.ad97	64 ea		stz $ea		                stz $EA
5817	.ad99	80 01		bra $ad9c	                bra LA9D7

5819						;-------------------------------------------------------------------------

5821	.ad9b					resetACIAThenRewriteControlRegister:
5822	.ad9b	08		php		                php
5823	.ad9c					LA9D7:
5824	.ad9c	20 d7 ad	jsr $add7	                jsr resetACIA
5825	.ad9f	ad 50 02	lda $0250	                lda aciaControlRegister
5826	.ada2	4c 4c ea	jmp $ea4c	                jmp mos.writeACIAControlRegister

5828						;-------------------------------------------------------------------------

5830	.ada5					LA9E0:
5831	.ada5	28		plp		                plp
5832	.ada6	24 ff		bit $ff		                bit $FF
5833	.ada8	10 18		bpl $adc2	                bpl LA9FD
5834						                .endif
5835	.adaa	60		rts		                rts

5837	.adab					LA9E6:
5838	.adab	a5 e3		lda $e3		                lda $E3
5839	.adad	0a		asl a		                asl a
5840	.adae	0a		asl a		                asl a
5841	.adaf	0a		asl a		                asl a
5842	.adb0	0a		asl a		                asl a
5843	.adb1	85 bb		sta $bb		                sta $BB
5844						                .if version==400
5846						                .else
5847	.adb3	ad d1 03	lda $03d1	                lda $03D1
5848	.adb6	80 08		bra $adc0	                bra LA9FB
5849						                .endif

5851	.adb8					LA9F3:
5852	.adb8	a5 e3		lda $e3		                lda $E3
5853	.adba	29 f0		and #$f0	                and #$F0
5854	.adbc	85 bb		sta $bb		                sta $BB
5855						                .if version!=400
5856	.adbe	a9 06		lda #$06	                lda #$06
5857	.adc0					LA9FB:
5858	.adc0	85 c7		sta $c7		                sta $C7
5859	.adc2					LA9FD:
5860	.adc2	58		cli		                cli
5861	.adc3					LA9FE:
5862	.adc3	08		php		                php
5863	.adc4	78		sei		                sei
5864	.adc5					LAA00:
5865	.adc5	2c 4f 02	bit $024f	                bit rs423Busy
5866	.adc8	10 db		bpl $ada5	                bpl LA9E0
5867	.adca	a5 ea		lda $ea		                lda $EA
5868	.adcc	30 d7		bmi $ada5	                bmi LA9E0
5869	.adce	a9 01		lda #$01	                lda #$01
5870	.add0	85 ea		sta $ea		                sta $EA
5871	.add2	20 d7 ad	jsr $add7	                jsr resetACIA
5872	.add5	28		plp		                plp
5873						                .endif
5874	.add6	60		rts		                rts

5876						;-------------------------------------------------------------------------

5878						                .if version!=400
5879	.add7					resetACIA:
5880	.add7	a9 03		lda #$03	                lda #ACIA.control.reset
5881	.add9	80 1b		bra $adf6	                bra writeACIAControlRegister
5882						                .endif

5884						;-------------------------------------------------------------------------

5886	.addb					LAA16:
5887						                .if version!=400
5888	.addb	a9 30		lda #$30	                lda #$30
5889	.addd	85 ca		sta $ca		                sta $CA
5890	.addf	80 13		bra $adf4	                bra LAA2F
5891						                .endif
5892	.ade1					LAA1C:
5893						                .if version!=400
5894	.ade1	a9 05		lda #$05	                lda #$05
5895	.ade3	8d 10 fe	sta $fe10	                sta SERPROC+0
5896	.ade6	a2 ff		ldx #$ff	                ldx #$FF
5897	.ade8					LAA23:
5898	.ade8	ca		dex		                dex
5899	.ade9	d0 fd		bne $ade8	                bne LAA23
5900						                .endif
5901	.adeb	64 ca		stz $ca		                stz $CA
5902						                .if version!=400
5903	.aded	a9 d0		lda #$d0	                lda #$D0
5904	.adef					LAA2A:
5905	.adef	a0 85		ldy #$85	                ldy #$85
5906	.adf1	8c 10 fe	sty $fe10	                sty SERPROC+0
5907	.adf4					LAA2F:
5908	.adf4	05 c6		ora $c6		                ora $C6
5909	.adf6					writeACIAControlRegister:
5910	.adf6	8d 08 fe	sta $fe08	                sta ACIA+0
5911						                .endif
5912	.adf9	60		rts		                rts

5914						;-------------------------------------------------------------------------

5916	.adfa					LAA35:
5917	.adfa	ae c6 03	ldx $03c6	                ldx $03C6
5918	.adfd	ac c7 03	ldy $03c7	                ldy $03C7
5919	.ae00	e8		inx		                inx
5920	.ae01	86 b4		stx $b4		                stx $B4
5921	.ae03	d0 01		bne $ae06	                bne LAA41
5922	.ae05	c8		iny		                iny
5923	.ae06					LAA41:
5924	.ae06	84 b5		sty $b5		                sty $B5
5925	.ae08	60		rts		                rts

5927	.ae09					LAA44:
5928	.ae09	64 c0		stz $c0		                stz $C0
5929	.ae0b					LAA46:
5930	.ae0b	a0 00		ldy #$00	                ldy #$00
5931	.ae0d	64 be		stz $be		                stz $BE
5932	.ae0f	64 bf		stz $bf		                stz $BF
5933	.ae11	60		rts		                rts

5935	.ae12					LAA4D:
5936	.ae12	a0 ff		ldy #$ff	                ldy #$FF
5937	.ae14					LAA4F:
5938	.ae14	c8		iny		                iny
5939	.ae15	e8		inx		                inx
5940	.ae16	bd 00 03	lda $0300,x	                lda $0300,x
5941	.ae19	99 d2 03	sta $03d2,y	                sta $03D2,y
5942	.ae1c	d0 f6		bne $ae14	                bne LAA4F
5943	.ae1e	60		rts		                rts

5945						                .if version!=400
5946	.ae1f					LAA5A:
5947	.ae1f	a0 00		ldy #$00	                ldy #$00
5948	.ae21					LAA5C:
5949	.ae21	58		cli		                cli
5950	.ae22	a2 01		ldx #$01	                ldx #$01
5951	.ae24	84 c3		sty $c3		                sty $C3
5952	.ae26					LAA61:
5953	.ae26	a9 89		lda #$89	                lda #$89
5954	.ae28	a4 c3		ldy $c3		                ldy $C3
5955	.ae2a	4c f4 ff	jmp $fff4	                jmp OSBYTE
5956						                .endif

5958						; Check if TAPE/ROM channel is open
5959						; ---------------------------------
5960						; Y=handle to check, A=status mask to use
5961	.ae2d					LAA68:
5962	.ae2d	5a		phy		                phy
5963	.ae2e	20 52 ae	jsr $ae52	                jsr LAA8D
5964	.ae31	7a		ply		                ply
5965						                .if version<500
5967						                .elsif version>=500
5968	.ae32	b0 30		bcs $ae64	                bcs LAA9F
5969						                .endif
5970	.ae34	cc 57 02	cpy $0257	                cpy spoolFileHandle                    ; Not SPOOL handle
5971	.ae37	d0 05		bne $ae3e	                bne LAA79
5972	.ae39	9c 57 02	stz $0257	                stz spoolFileHandle                    ; Clear the SPOOL handle
5973	.ae3c	80 08		bra $ae46	                bra LAA81
5974	.ae3e					LAA79:
5975	.ae3e	cc 56 02	cpy $0256	                cpy execFileHandle                    ; Not EXEC handle
5976	.ae41	d0 03		bne $ae46	                bne LAA81
5977	.ae43	9c 56 02	stz $0256	                stz execFileHandle                    ; Clear the EXEC handle
5978	.ae46					LAA81:
5979	.ae46	20 8c ae	jsr $ae8c	                jsr doFollowingError                    ; Generate error
5980	>ae49	de				                .byte $DE
5981	>ae4a	43 68 61 6e 6e 65 6c		                .text "Channel"
5982	.ae51	00		brk #		                brk

5984	.ae52					LAA8D:
5985	.ae52	48		pha		                pha                          ; Toggle channel with CFS/RFS switch
5986	.ae53	98		tya		                tya
5987						                .if version==400
5989						                .else
5990	.ae54	4d 47 02	eor $0247	                eor cfsRFSFSSwitch
5991						                .endif
5992	.ae57	a8		tay		                tay                          ; If CFS=unchanged, if RFS 1/2/3->3/0/1
5993	.ae58	68		pla		                pla
5994	.ae59	25 e2		and $e2		                and $E2                      ; Mask with open channels bitmask
5995	.ae5b	4a		lsr a		                lsr a                        ; Move 'input open if tested' into Carry
5996	.ae5c	88		dey		                dey                          ; Exit if testing CFS#1 or RFS#3
5997	.ae5d	f0 05		beq $ae64	                beq LAA9F
5998	.ae5f	4a		lsr a		                lsr a                        ; Move 'output open if tested' into Carry
5999	.ae60	88		dey		                dey                          ; Exit if testing CFS#2
6000	.ae61	f0 01		beq $ae64	                beq LAA9F
6001	.ae63	18		clc		                clc                          ; Otherwise, Carry=Not Open
6002	.ae64					LAA9F:
6003	.ae64	60		rts		                rts

6005						                .if version!=400
6006	.ae65					LAAA0:
6007	.ae65	a9 10		lda #$10	                lda #$10
6008	.ae67	80 86		bra $adef	                bra LAA2A
6009						                .endif

6011						                .if version<500
6039						                .endif

6041	.ae69					LAACA:
6042	.ae69	a0 05		ldy #$05	                ldy #$05
6043	.ae6b					LAACC:
6044	.ae6b	b1 cc		lda ($cc),y	                lda ($CC),y
6045	.ae6d	d0 07		bne $ae76	                bne LAAD7
6046	.ae6f	c8		iny		                iny
6047	.ae70	c0 08		cpy #$08	                cpy #$08
6048	.ae72	90 f7		bcc $ae6b	                bcc LAACC
6049	.ae74					LAAD5:
6050	.ae74	b1 cc		lda ($cc),y	                lda ($CC),y
6051	.ae76					LAAD7:
6052	.ae76	3a		dec a		                dec a
6053	.ae77	91 cc		sta ($cc),y	                sta ($CC),y
6054	.ae79	88		dey		                dey
6055	.ae7a	c0 05		cpy #$05	                cpy #$05
6056	.ae7c	b0 f6		bcs $ae74	                bcs LAAD5
6057	.ae7e	60		rts		                rts

6059	.ae7f					LAAE0:
6060	.ae7f	a0 08		ldy #$08	                ldy #$08
6061	.ae81	a9 00		lda #$00	                lda #$00
6062	.ae83					LAAE4:
6063	.ae83	11 cc		ora ($cc),y	                ora ($CC),y
6064	.ae85	88		dey		                dey
6065	.ae86	c0 05		cpy #$05	                cpy #$05
6066	.ae88	b0 f9		bcs $ae83	                bcs LAAE4
6067	.ae8a	aa		tax		                tax
6068	.ae8b	60		rts		                rts

6070	.ae8c					doFollowingError:
6071	.ae8c	78		sei		                sei
6072	.ae8d	68		pla		                pla
6073	.ae8e	85 fa		sta $fa		                sta SEIWKA+0
6074	.ae90	68		pla		                pla
6075	.ae91	85 fb		sta $fb		                sta SEIWKA+1
6076	.ae93	9c 00 01	stz $0100	                stz $0100
6077	.ae96	a0 00		ldy #$00	                ldy #$00
6078	.ae98					-
6079	.ae98	c8		iny		                iny
6080	.ae99	b1 fa		lda ($fa),y	                lda (SEIWKA),y
6081	.ae9b	99 00 01	sta $0100,y	                sta $0100,y
6082	.ae9e	d0 f8		bne $ae98	                bne -
6083	.aea0	4c 00 01	jmp $0100	                jmp $0100


6086						                .if version!=350
6087						                .include "cfs_errors.s65"

:13	;******  Processing file: src/cfs_errors.s65

1	.aea3					dataError:
2	.aea3	20 8c ae	jsr $ae8c	                jsr doFollowingError
3	>aea6	d8 0d 44 61 74 61 3f 00		                .text $d8,13,"Data?",0
4	.aeae	80 19		bra $aec9	                bra LAB2A

6	.aeb0					fileError:
7	.aeb0	20 8c ae	jsr $ae8c	                jsr doFollowingError
8	>aeb3	db 0d 46 69 6c 65 3f 00		                .text $db,13,"File?",0
9	.aebb	80 0c		bra $aec9	                bra LAB2A

11	.aebd					blockError:
12	.aebd	20 8c ae	jsr $ae8c	                jsr doFollowingError
13	>aec0	da 0d 42 6c 6f 63 6b 3f		                .text $da,13,"Block?",0
	>aec8	00
14	.aec9					LAB2A:
15	.aec9	4c 47 ad	jmp $ad47	                jmp LA978

:5	;******  Return to file: src/terminal.s65

6088						                .endif

6090						                .if version<500
6820						                .endif

6822						                .if version<400
6824						                .endif

6826						                .if version>=500
6827						                .include "ext.s65"

:14	;******  Processing file: src/ext.s65

1						; -*- comment-column:45; -*-

3	.aecc					ext: .block

5	.aecc					plotEllipseOutline:
6	.aecc	20 17 b0	jsr $b017	                jsr     LBB2F
7						                .if version<500
9						                .elsif version>=500
10	.aecf	4c d5 ae	jmp $aed5	                jmp LBA08
11						                .endif

13	.aed2					LBA05:
14	.aed2	20 d1 b0	jsr $b0d1	                jsr     LBBE9

16	.aed5					LBA08:
17	.aed5	a2 34		ldx #$34	                ldx     #VDUVariables.workspace._34
18	.aed7	a0 3c		ldy #$3c	                ldy     #VDUVariables.workspace._3C
19	.aed9	20 cc d5	jsr $d5cc	                jsr     mos.sortVDUVariableWords
20						                .if version!=350
21	.aedc	a2 38		ldx #$38	                ldx     #VDUVariables.workspace._38
22						                .endif
23						                .if version<500&&version!=350
25						                .else
26	.aede	ad 39 03	lda $0339	                lda vduv.workspace._39
27						                .endif
28	.aee1	8d 43 03	sta $0343	                sta     vduv.workspace._43
29						                .if version<500&&version!=350
32						                .else
33	.aee4	ae 38 03	ldx $0338	                ldx vduv.workspace._38
34						                .endif

36	.aee7					LBA1B:
37	.aee7	8e 42 03	stx $0342	                stx     vduv.workspace._42
38	.aeea	20 08 b2	jsr $b208	                jsr     LBD20
39	.aeed	e8		inx		                inx
40	.aeee	d0 03		bne $aef3	                bne     LBA27
41	.aef0	ee 43 03	inc $0343	                inc     vduv.workspace._43

43	.aef3					LBA27:
44	.aef3	8a		txa		                txa
45	.aef4	d9 00 03	cmp $0300,y	                cmp     vduv+0,y
46	.aef7	ad 43 03	lda $0343	                lda     vduv.workspace._43
47	.aefa	f9 01 03	sbc $0301,y	                sbc     vduv+1,y
48	.aefd	30 e8		bmi $aee7	                bmi     LBA1B
49						                .if version<500&&version!=350
78						                .else

80	.aeff	ac 43 03	ldy $0343	                ldy vduv.workspace._43
81	.af02	8a		txa		                txa
82	.af03	d0 01		bne $af06	                bne LAF06
83	.af05	88		dey		                dey
84	.af06					LAF06:
85	.af06	ca		dex		                dex
86	.af07	8e 34 03	stx $0334	                stx vduv.workspace._34
87	.af0a	8c 35 03	sty $0335	                sty vduv.workspace._35
88	.af0d	8a		txa		                txa
89	.af0e	cd 3a 03	cmp $033a	                cmp vduv.workspace._3A
90	.af11	98		tya		                tya
91	.af12	ed 3b 03	sbc $033b	                sbc vduv.workspace._3B
92	.af15	10 30		bpl $af47	                bpl LAF47
93	.af17	a2 36		ldx #$36	                ldx #VDUVariables.workspace._36
94	.af19	a0 3e		ldy #$3e	                ldy #VDUVariables.workspace._3E
95	.af1b	20 cc d5	jsr $d5cc	                jsr mos.sortVDUVariableWords
96	.af1e	a0 34		ldy #$34	                ldy #VDUVariables.workspace._34
97	.af20	20 cc d5	jsr $d5cc	                jsr mos.sortVDUVariableWords
98	.af23	ad 3b 03	lda $033b	                lda vduv.workspace._3B
99	.af26	8d 43 03	sta $0343	                sta vduv.workspace._43
100	.af29	ad 3a 03	lda $033a	                lda vduv.workspace._3A
101	.af2c	aa		tax		                tax
102	.af2d					LAF2D:
103	.af2d	8e 42 03	stx $0342	                stx vduv.workspace._42
104	.af30					LAF30:
105	.af30	20 08 b2	jsr $b208	                jsr LBD20
106	.af33	8a		txa		                txa
107	.af34	d0 03		bne $af39	                bne LAF39
108	.af36	ce 43 03	dec $0343	                dec vduv.workspace._43

110	.af39					LAF39:
111	.af39	ca		dex		                dex
112	.af3a	18		clc		                clc
113	.af3b	8a		txa		                txa
114	.af3c	f9 00 03	sbc $0300,y	                sbc vduv+0,y
115	.af3f	ad 43 03	lda $0343	                lda vduv.workspace._43
116	.af42	f9 01 03	sbc $0301,y	                sbc vduv+1,y
117	.af45	10 e6		bpl $af2d	                bpl LAF2D

119	.af47					LAF47:
120	.af47	ad 2f 03	lda $032f	                lda vduv.workspace._2F
121	.af4a	10 86		bpl $aed2	                bpl LBA05
122						                .if version==350
124						                .else
125	.af4c	4c 63 af	jmp $af63	                jmp LBA7B
126						                .endif

128						                .endif

130	.af4f					plotSolidEllipse:
131	.af4f	20 17 b0	jsr $b017	                jsr     LBB2F
132	.af52	80 03		bra $af57	                bra     LBA6F


135	.af54					LBA6C:
136	.af54	20 d1 b0	jsr $b0d1	                jsr     LBBE9

138	.af57					LBA6F:
139	.af57	a2 3a		ldx #$3a	                ldx     #VDUVariables.workspace._3A
140	.af59	a0 38		ldy #$38	                ldy     #VDUVariables.workspace._38
141	.af5b	20 6f af	jsr $af6f	                jsr     LBA87
142	.af5e	ad 2f 03	lda $032f	                lda     vduv.workspace._2F
143	.af61	10 f1		bpl $af54	                bpl     LBA6C

145	.af63					LBA7B:
146	.af63	ee 4d 88	inc $884d	                inc     L884D
147	.af66	d0 03		bne $af6b	                bne     LBA83
148	.af68	ee 4e 88	inc $884e	                inc     L884E

150	.af6b					LBA83:
151	.af6b	a2 3e		ldx #$3e	                ldx     #VDUVariables.workspace._3E
152	.af6d	a0 3c		ldy #$3c	                ldy     #VDUVariables.workspace._3C




157	.af6f					LBA87:



161	.af6f	da		phx		                phx
162	.af70	5a		phy		                phy
163	.af71	18		clc		                clc
164	.af72	ad 14 03	lda $0314	                lda     vduv.oldGraphicsCursorPixelsX+0
165	.af75	79 00 03	adc $0300,y	                adc     vduv+0,y
166	.af78	8d 40 03	sta $0340	                sta     vduv.workspace._40
167	.af7b	ad 15 03	lda $0315	                lda     vduv.oldGraphicsCursorPixelsX+1
168	.af7e	79 01 03	adc $0301,y	                adc     vduv+1,y
169	.af81	8d 41 03	sta $0341	                sta     vduv.workspace._41
170	.af84	18		clc		                clc
171	.af85	ad 14 03	lda $0314	                lda     vduv.oldGraphicsCursorPixelsX+0
172	.af88	7d 00 03	adc $0300,x	                adc     vduv+0,x
173	.af8b	8d 44 03	sta $0344	                sta     vduv.workspace._44
174	.af8e	ad 15 03	lda $0315	                lda     vduv.oldGraphicsCursorPixelsX+1
175	.af91	7d 01 03	adc $0301,x	                adc     vduv+1,x
176	.af94	8d 45 03	sta $0345	                sta     vduv.workspace._45
177	.af97	18		clc		                clc
178	.af98	ad 16 03	lda $0316	                lda     vduv.oldGraphicsCursorPixelsY+0
179	.af9b	6d 4d 88	adc $884d	                adc     L884D
180	.af9e	a8		tay		                tay
181	.af9f	ad 17 03	lda $0317	                lda     vduv.oldGraphicsCursorPixelsY+1
182	.afa2	6d 4e 88	adc $884e	                adc     L884E
183	.afa5	20 e6 af	jsr $afe6	                jsr     LBAFE
184	.afa8	7a		ply		                ply
185	.afa9	fa		plx		                plx
186	.afaa	ad 4d 88	lda $884d	                lda     L884D
187	.afad	0d 4e 88	ora $884e	                ora     L884E
188	.afb0	f0 47		beq $aff9	                beq     rtsBB11
189	.afb2	38		sec		                sec
190	.afb3	ad 14 03	lda $0314	                lda     vduv.oldGraphicsCursorPixelsX+0
191	.afb6	fd 00 03	sbc $0300,x	                sbc     vduv+0,x
192	.afb9	8d 40 03	sta $0340	                sta     vduv.workspace._40
193	.afbc	ad 15 03	lda $0315	                lda     vduv.oldGraphicsCursorPixelsX+1
194	.afbf	fd 01 03	sbc $0301,x	                sbc     vduv+1,x
195	.afc2	8d 41 03	sta $0341	                sta     vduv.workspace._41
196	.afc5	38		sec		                sec
197	.afc6	ad 14 03	lda $0314	                lda     vduv.oldGraphicsCursorPixelsX+0
198	.afc9	f9 00 03	sbc $0300,y	                sbc     vduv+0,y
199	.afcc	8d 44 03	sta $0344	                sta     vduv.workspace._44
200	.afcf	ad 15 03	lda $0315	                lda     vduv.oldGraphicsCursorPixelsX+1
201	.afd2	f9 01 03	sbc $0301,y	                sbc     vduv+1,y
202	.afd5	8d 45 03	sta $0345	                sta     vduv.workspace._45
203	.afd8	38		sec		                sec
204	.afd9	ad 16 03	lda $0316	                lda     vduv.oldGraphicsCursorPixelsY+0
205	.afdc	ed 4d 88	sbc $884d	                sbc     L884D
206	.afdf	a8		tay		                tay
207	.afe0	ad 17 03	lda $0317	                lda     vduv.oldGraphicsCursorPixelsY+1
208	.afe3	ed 4e 88	sbc $884e	                sbc     L884E






215	.afe6					LBAFE:
216	.afe6	8c 46 03	sty $0346	                sty     vduv.workspace._46
217	.afe9	8c 42 03	sty $0342	                sty     vduv.workspace._42
218	.afec	8d 47 03	sta $0347	                sta     vduv.workspace._47
219	.afef	8d 43 03	sta $0343	                sta     vduv.workspace._43
220	.aff2	a2 44		ldx #$44	                ldx     #VDUVariables.workspace._44
221	.aff4	a0 40		ldy #$40	                ldy     #VDUVariables.workspace._40
222	.aff6	4c e8 da	jmp $dae8	                jmp     mos.LDAE8





228	.aff9					rtsBB11:
229	.aff9	60		rts		                rts




234	.affa					LBB12:
235	.affa	68		pla		                pla
236	.affb	68		pla		                pla
237	.affc	9c 4d 88	stz $884d	                stz     L884D
238	.afff	9c 4e 88	stz $884e	                stz     L884E
239	.b002	a2 29		ldx #$29	                ldx     #VDUVariables.workspace._29
240	.b004	a0 40		ldy #$40	                ldy     #VDUVariables.workspace._40
241	.b006	20 e2 b2	jsr $b2e2	                jsr     LBDFA
242	.b009	a2 29		ldx #$29	                ldx     #VDUVariables.workspace._29
243	.b00b	a0 44		ldy #$44	                ldy     #VDUVariables.workspace._44
244	.b00d	20 0c c9	jsr $c90c	                jsr     mos.copyTwoBytesWithinVDUVariables
245	.b010	a2 44		ldx #$44	                ldx     #VDUVariables.workspace._44
246	.b012	a0 40		ldy #$40	                ldy     #VDUVariables.workspace._40
247	.b014	4c 6f af	jmp $af6f	                jmp     LBA87





253	.b017					LBB2F:



257	.b017	a0 24		ldy #$24	                ldy     #VDUVariables.graphicsCursorPixelsX
258	.b019	a2 14		ldx #$14	                ldx     #VDUVariables.oldGraphicsCursorPixelsX
259	.b01b	a9 29		lda #$29	                lda     #VDUVariables.workspace._29
260	.b01d	20 78 d6	jsr $d678	                jsr     mos.LD678
261	.b020	9c 28 03	stz $0328	                stz     vduv.workspace._28
262	.b023	a0 22		ldy #$22	                ldy     #VDUVariables.queueEnd-2
263	.b025	a2 16		ldx #$16	                ldx     #VDUVariables.oldGraphicsCursorPixelsY
264	.b027	a9 2e		lda #$2e	                lda     #VDUVariables.workspace._2E
265	.b029	20 78 d6	jsr $d678	                jsr     mos.LD678
266	.b02c	ad 2e 03	lda $032e	                lda     vduv.workspace._2E
267	.b02f	0d 2f 03	ora $032f	                ora     vduv.workspace._2F
268	.b032	f0 c6		beq $affa	                beq     LBB12
269	.b034	2a		rol a		                rol     a
270	.b035	8d 41 88	sta $8841	                sta     L8841
271	.b038	a0 20		ldy #$20	                ldy     #VDUVariables.queueEnd-4
272	.b03a	a2 14		ldx #$14	                ldx     #VDUVariables.oldGraphicsCursorPixelsX
273	.b03c	a9 2c		lda #$2c	                lda     #VDUVariables.workspace._2C
274	.b03e	20 78 d6	jsr $d678	                jsr     mos.LD678
275	.b041	9c 2b 03	stz $032b	                stz     vduv.workspace._2B
276	.b044	2a		rol a		                rol     a
277	.b045	4d 41 88	eor $8841	                eor     L8841
278	.b048	29 01		and #$01	                and     #1
279	.b04a	8d 41 88	sta $8841	                sta     L8841
280	.b04d	a2 28		ldx #$28	                ldx     #VDUVariables.workspace._28
281	.b04f	a0 2e		ldy #$2e	                ldy     #VDUVariables.workspace._2E
282	.b051	20 6b b2	jsr $b26b	                jsr     LBD83
283	.b054	a2 2b		ldx #$2b	                ldx     #VDUVariables.workspace._2B
284	.b056	a0 2e		ldy #$2e	                ldy     #VDUVariables.workspace._2E
285	.b058	20 6b b2	jsr $b26b	                jsr     LBD83
286	.b05b	ad 41 88	lda $8841	                lda     L8841
287	.b05e	f0 0e		beq $b06e	                beq     LBB86
288	.b060	38		sec		                sec
289	.b061	a0 fd		ldy #$fd	                ldy     #$fd

291	.b063					LBB7B:
292	.b063	a9 00		lda #$00	                lda     #0
293	.b065	f9 2e 02	sbc $022e,y	                sbc     vduv.workspace._2B-$fd,y
294	.b068	99 2e 02	sta $022e,y	                sta     vduv.workspace._2B-$fd,y
295	.b06b	c8		iny		                iny
296	.b06c	d0 f5		bne $b063	                bne     LBB7B

298	.b06e					LBB86:
299	.b06e	ad 2e 03	lda $032e	                lda     vduv.workspace._2E
300	.b071	8d 3c 88	sta $883c	                sta     L883C
301	.b074	ad 2f 03	lda $032f	                lda     vduv.workspace._2F
302	.b077	20 ce d4	jsr $d4ce	                jsr     mos.LD4CE
303	.b07a	a0 03		ldy #$03	                ldy     #3

305	.b07c					LBB94:
306	.b07c	b9 40 88	lda $8840,y	                lda     $8840,y
307	.b07f	99 30 03	sta $0330,y	                sta     vduv.workspace._30,y
308	.b082	88		dey		                dey
309	.b083	10 f7		bpl $b07c	                bpl     LBB94
310	.b085	a2 0a		ldx #$0a	                ldx     #$a

312	.b087					LBB9F:
313	.b087	9e 42 88	stz $8842,x	                stz     $8842,x
314	.b08a	ca		dex		                dex
315	.b08b	10 fa		bpl $b087	                bpl     LBB9F
316	.b08d	ee 45 88	inc $8845	                inc     L8845
317	.b090	20 00 b1	jsr $b100	                jsr     LBC18
318	.b093	20 00 b1	jsr $b100	                jsr     LBC18
319	.b096	9c 4d 88	stz $884d	                stz     L884D
320	.b099	9c 4e 88	stz $884e	                stz     L884E
321	.b09c	a2 3c		ldx #$3c	                ldx     #VDUVariables.workspace._3C
322	.b09e	a0 36		ldy #$36	                ldy     #VDUVariables.workspace._36
323	.b0a0	20 e2 b2	jsr $b2e2	                jsr     LBDFA
324	.b0a3	a2 3e		ldx #$3e	                ldx     #VDUVariables.workspace._3E
325	.b0a5	a0 34		ldy #$34	                ldy     #VDUVariables.workspace._34
326	.b0a7	20 e2 b2	jsr $b2e2	                jsr     LBDFA
327	.b0aa	a2 3c		ldx #$3c	                ldx     #VDUVariables.workspace._3C
328	.b0ac	a0 3a		ldy #$3a	                ldy     #VDUVariables.workspace._3A
329	.b0ae	20 d6 d5	jsr $d5d6	                jsr     mos.compareVDUVariableWords
330	.b0b1	10 07		bpl $b0ba	                bpl     LBBD2
331	.b0b3	20 0c c9	jsr $c90c	                jsr     mos.copyTwoBytesWithinVDUVariables
332	.b0b6	a2 36		ldx #$36	                ldx     #VDUVariables.workspace._36
333	.b0b8	80 12		bra $b0cc	                bra     LBBE4


336	.b0ba					LBBD2:
337	.b0ba	a2 38		ldx #$38	                ldx     #VDUVariables.workspace._38
338	.b0bc	a0 3e		ldy #$3e	                ldy     #VDUVariables.workspace._3E
339	.b0be	20 d6 d5	jsr $d5d6	                jsr     mos.compareVDUVariableWords
340	.b0c1	10 3c		bpl $b0ff	                bpl     rtsBC17
341	.b0c3	a2 34		ldx #$34	                ldx     #VDUVariables.workspace._34
342	.b0c5	a0 3a		ldy #$3a	                ldy     #VDUVariables.workspace._3A
343	.b0c7	20 0c c9	jsr $c90c	                jsr     mos.copyTwoBytesWithinVDUVariables
344	.b0ca	a2 3e		ldx #$3e	                ldx     #VDUVariables.workspace._3E

346	.b0cc					LBBE4:
347	.b0cc	a0 38		ldy #$38	                ldy     #VDUVariables.workspace._38
348	.b0ce	4c 0c c9	jmp $c90c	                jmp     mos.copyTwoBytesWithinVDUVariables






355	.b0d1					LBBE9:

357	.b0d1	20 00 b1	jsr $b100	                jsr     LBC18
358	.b0d4	a0 3a		ldy #$3a	                ldy     #VDUVariables.workspace._3A
359	.b0d6	a2 3c		ldx #$3c	                ldx     #VDUVariables.workspace._3C
360	.b0d8	20 d6 d5	jsr $d5d6	                jsr     mos.compareVDUVariableWords
361	.b0db	10 0d		bpl $b0ea	                bpl     LBC02
362	.b0dd	ad 3c 03	lda $033c	                lda     vduv.workspace._3C
363	.b0e0	8d 3a 03	sta $033a	                sta     vduv.workspace._3A
364	.b0e3	ad 3d 03	lda $033d	                lda     vduv.workspace._3D
365	.b0e6	8d 3b 03	sta $033b	                sta     vduv.workspace._3B
366	.b0e9	60		rts		                rts


369	.b0ea					LBC02:
370	.b0ea	a2 38		ldx #$38	                ldx     #VDUVariables.workspace._38
371	.b0ec	a0 3e		ldy #$3e	                ldy     #VDUVariables.workspace._3E
372	.b0ee	20 d6 d5	jsr $d5d6	                jsr     mos.compareVDUVariableWords
373	.b0f1	10 0c		bpl $b0ff	                bpl     rtsBC17
374	.b0f3	ad 3e 03	lda $033e	                lda     vduv.workspace._3E
375	.b0f6	8d 38 03	sta $0338	                sta     vduv.workspace._38
376	.b0f9	ad 3f 03	lda $033f	                lda     vduv.workspace._3F
377	.b0fc	8d 39 03	sta $0339	                sta     vduv.workspace._39

379	.b0ff					rtsBC17:
380	.b0ff	60		rts		                rts






387	.b100					LBC18:
388	.b100	a2 38		ldx #$38	                ldx     #VDUVariables.workspace._38
389	.b102	a0 34		ldy #$34	                ldy     #VDUVariables.workspace._34
390	.b104	20 1e c9	jsr $c91e	                jsr     mos.copyFourBytesWithinVDUVariables
391	.b107	a2 3c		ldx #$3c	                ldx     #VDUVariables.workspace._3C
392	.b109	a0 38		ldy #$38	                ldy     #VDUVariables.workspace._38
393	.b10b	20 1e c9	jsr $c91e	                jsr     mos.copyFourBytesWithinVDUVariables
394	.b10e	38		sec		                sec
395	.b10f	ad 30 03	lda $0330	                lda     vduv.workspace._30
396	.b112	ed 49 88	sbc $8849	                sbc     L8849
397	.b115	8d 36 88	sta $8836	                sta     L8836
398	.b118	ad 31 03	lda $0331	                lda     vduv.workspace._31
399	.b11b	ed 4a 88	sbc $884a	                sbc     L884A
400	.b11e	8d 37 88	sta $8837	                sta     L8837
401	.b121	ad 32 03	lda $0332	                lda     vduv.workspace._32
402	.b124	ed 4b 88	sbc $884b	                sbc     L884B
403	.b127	8d 38 88	sta $8838	                sta     L8838
404	.b12a	ad 33 03	lda $0333	                lda     vduv.workspace._33
405	.b12d	ed 4c 88	sbc $884c	                sbc     L884C
406	.b130	8d 39 88	sta $8839	                sta     L8839
407	.b133	9c 35 88	stz $8835	                stz     L8835
408	.b136	9c 34 88	stz $8834	                stz     L8834
409	.b139	20 33 b3	jsr $b333	                jsr     LBE4B
410	.b13c	ad 28 03	lda $0328	                lda     vduv.workspace._28
411	.b13f	8d 34 88	sta $8834	                sta     L8834
412	.b142	ad 29 03	lda $0329	                lda     vduv.workspace._29
413	.b145	8d 35 88	sta $8835	                sta     L8835
414	.b148	ad 2a 03	lda $032a	                lda     vduv.workspace._2A
415	.b14b	8d 36 88	sta $8836	                sta     L8836
416	.b14e	20 f4 b2	jsr $b2f4	                jsr     LBE0C
417	.b151	18		clc		                clc
418	.b152	ad 42 88	lda $8842	                lda     L8842
419	.b155	6d 35 88	adc $8835	                adc     L8835
420	.b158	08		php		                php
421	.b159	ad 43 88	lda $8843	                lda     L8843
422	.b15c	6d 36 88	adc $8836	                adc     L8836
423	.b15f	8d 3e 03	sta $033e	                sta     vduv.workspace._3E
424	.b162	ad 44 88	lda $8844	                lda     L8844
425	.b165	6d 37 88	adc $8837	                adc     L8837
426	.b168	8d 3f 03	sta $033f	                sta     vduv.workspace._3F
427	.b16b	28		plp		                plp
428	.b16c	10 08		bpl $b176	                bpl     LBC8E
429	.b16e	ee 3e 03	inc $033e	                inc     vduv.workspace._3E
430	.b171	d0 03		bne $b176	                bne     LBC8E
431	.b173	ee 3f 03	inc $033f	                inc     vduv.workspace._3F

433	.b176					LBC8E:
434	.b176	38		sec		                sec
435	.b177	ad 42 88	lda $8842	                lda     L8842
436	.b17a	ed 35 88	sbc $8835	                sbc     L8835
437	.b17d	08		php		                php
438	.b17e	ad 43 88	lda $8843	                lda     L8843
439	.b181	ed 36 88	sbc $8836	                sbc     L8836
440	.b184	8d 3c 03	sta $033c	                sta     vduv.workspace._3C
441	.b187	ad 44 88	lda $8844	                lda     L8844
442	.b18a	ed 37 88	sbc $8837	                sbc     L8837
443	.b18d	8d 3d 03	sta $033d	                sta     vduv.workspace._3D
444	.b190	28		plp		                plp
445	.b191	10 08		bpl $b19b	                bpl     LBCB3
446	.b193	ee 3c 03	inc $033c	                inc     vduv.workspace._3C
447	.b196	d0 03		bne $b19b	                bne     LBCB3
448	.b198	ee 3d 03	inc $033d	                inc     vduv.workspace._3D

450	.b19b					LBCB3:
451	.b19b	18		clc		                clc
452	.b19c	ad 45 88	lda $8845	                lda     L8845
453	.b19f	6d 49 88	adc $8849	                adc     L8849
454	.b1a2	8d 49 88	sta $8849	                sta     L8849
455	.b1a5	ad 46 88	lda $8846	                lda     L8846
456	.b1a8	6d 4a 88	adc $884a	                adc     L884A
457	.b1ab	8d 4a 88	sta $884a	                sta     L884A
458	.b1ae	ad 47 88	lda $8847	                lda     L8847
459	.b1b1	6d 4b 88	adc $884b	                adc     L884B
460	.b1b4	8d 4b 88	sta $884b	                sta     L884B
461	.b1b7	ad 48 88	lda $8848	                lda     L8848
462	.b1ba	6d 4c 88	adc $884c	                adc     L884C
463	.b1bd	8d 4c 88	sta $884c	                sta     L884C
464	.b1c0	18		clc		                clc
465	.b1c1	a9 02		lda #$02	                lda     #2
466	.b1c3	6d 45 88	adc $8845	                adc     L8845
467	.b1c6	8d 45 88	sta $8845	                sta     L8845
468	.b1c9	90 0d		bcc $b1d8	                bcc     LBCF0
469	.b1cb	ee 46 88	inc $8846	                inc     L8846
470	.b1ce	d0 08		bne $b1d8	                bne     LBCF0
471	.b1d0	ee 47 88	inc $8847	                inc     L8847
472	.b1d3	d0 03		bne $b1d8	                bne     LBCF0
473	.b1d5	ee 48 88	inc $8848	                inc     L8848

475	.b1d8					LBCF0:
476	.b1d8	18		clc		                clc
477	.b1d9	ad 42 88	lda $8842	                lda     L8842
478	.b1dc	6d 2b 03	adc $032b	                adc     vduv.workspace._2B
479	.b1df	8d 42 88	sta $8842	                sta     L8842
480	.b1e2	ad 43 88	lda $8843	                lda     L8843
481	.b1e5	6d 2c 03	adc $032c	                adc     vduv.workspace._2C
482	.b1e8	8d 43 88	sta $8843	                sta     L8843
483	.b1eb	ad 44 88	lda $8844	                lda     L8844
484	.b1ee	6d 2d 03	adc $032d	                adc     vduv.workspace._2D
485	.b1f1	8d 44 88	sta $8844	                sta     L8844
486	.b1f4	ee 4d 88	inc $884d	                inc     L884D
487	.b1f7	d0 03		bne $b1fc	                bne     LBD14
488	.b1f9	ee 4e 88	inc $884e	                inc     L884E

490	.b1fc					LBD14:
491	.b1fc	ad 2e 03	lda $032e	                lda     vduv.workspace._2E
492	.b1ff	d0 03		bne $b204	                bne     LBD1C
493	.b201	ce 2f 03	dec $032f	                dec     vduv.workspace._2F

495	.b204					LBD1C:
496	.b204	ce 2e 03	dec $032e	                dec     vduv.workspace._2E
497	.b207	60		rts		                rts






504	.b208					LBD20:
505	.b208	da		phx		                phx
506	.b209	5a		phy		                phy
507	.b20a	18		clc		                clc
508	.b20b	ad 14 03	lda $0314	                lda     vduv.oldGraphicsCursorPixelsX+0
509	.b20e	6d 42 03	adc $0342	                adc     vduv.workspace._42
510	.b211	8d 44 03	sta $0344	                sta     vduv.workspace._44
511	.b214	ad 15 03	lda $0315	                lda     vduv.oldGraphicsCursorPixelsX+1
512	.b217	6d 43 03	adc $0343	                adc     vduv.workspace._43
513	.b21a	8d 45 03	sta $0345	                sta     vduv.workspace._45
514	.b21d	18		clc		                clc
515	.b21e	ad 16 03	lda $0316	                lda     vduv.oldGraphicsCursorPixelsY+0
516	.b221	6d 4d 88	adc $884d	                adc     L884D
517	.b224	8d 46 03	sta $0346	                sta     vduv.workspace._46
518	.b227	ad 17 03	lda $0317	                lda     vduv.oldGraphicsCursorPixelsY+1
519	.b22a	6d 4e 88	adc $884e	                adc     L884E
520	.b22d	8d 47 03	sta $0347	                sta     vduv.workspace._47
521	.b230	a2 44		ldx #$44	                ldx     #VDUVariables.workspace._44
522	.b232	20 4c db	jsr $db4c	                jsr     mos.LDB4C
523	.b235	ad 4d 88	lda $884d	                lda     L884D
524	.b238	0d 4e 88	ora $884e	                ora     L884E
525	.b23b	f0 2b		beq $b268	                beq     LBD80
526	.b23d	38		sec		                sec
527	.b23e	ad 14 03	lda $0314	                lda     vduv.oldGraphicsCursorPixelsX+0
528	.b241	ed 42 03	sbc $0342	                sbc     vduv.workspace._42
529	.b244	8d 44 03	sta $0344	                sta     vduv.workspace._44
530	.b247	ad 15 03	lda $0315	                lda     vduv.oldGraphicsCursorPixelsX+1
531	.b24a	ed 43 03	sbc $0343	                sbc     vduv.workspace._43
532	.b24d	8d 45 03	sta $0345	                sta     vduv.workspace._45
533	.b250	38		sec		                sec
534	.b251	ad 16 03	lda $0316	                lda     vduv.oldGraphicsCursorPixelsY+0
535	.b254	ed 4d 88	sbc $884d	                sbc     L884D
536	.b257	8d 46 03	sta $0346	                sta     vduv.workspace._46
537	.b25a	ad 17 03	lda $0317	                lda     vduv.oldGraphicsCursorPixelsY+1
538	.b25d	ed 4e 88	sbc $884e	                sbc     L884E
539	.b260	8d 47 03	sta $0347	                sta     vduv.workspace._47
540	.b263	a2 44		ldx #$44	                ldx     #VDUVariables.workspace._44
541	.b265	20 4c db	jsr $db4c	                jsr     mos.LDB4C

543	.b268					LBD80:
544	.b268	7a		ply		                ply
545	.b269	fa		plx		                plx
546	.b26a	60		rts		                rts






553	.b26b					LBD83:
554	.b26b	da		phx		                phx
555	.b26c	b9 00 03	lda $0300,y	                lda     vduv+0,y
556	.b26f	8d 3f 88	sta $883f	                sta     L883F
557	.b272	b9 01 03	lda $0301,y	                lda     vduv+1,y
558	.b275	8d 40 88	sta $8840	                sta     L8840
559	.b278	a0 18		ldy #$18	                ldy     #$18 ;not VDUVariables.textCursorXPosition?
560	.b27a	bd 00 03	lda $0300,x	                lda     vduv+0,x
561	.b27d	8d 3a 88	sta $883a	                sta     L883A
562	.b280	bd 01 03	lda $0301,x	                lda     vduv+1,x
563	.b283	8d 3b 88	sta $883b	                sta     L883B
564	.b286	bd 02 03	lda $0302,x	                lda     vduv+2,x
565	.b289	30 0c		bmi $b297	                bmi     LBDAF

567	.b28b					LBDA3:
568	.b28b	88		dey		                dey
569	.b28c	f0 52		beq $b2e0	                beq     LBDF8
570	.b28e	0e 3a 88	asl $883a	                asl     L883A
571	.b291	2e 3b 88	rol $883b	                rol     L883B
572	.b294	2a		rol a		                rol     a
573	.b295	10 f4		bpl $b28b	                bpl     LBDA3

575	.b297					LBDAF:
576	.b297	8d 3c 88	sta $883c	                sta     L883C
577	.b29a	9c 3d 88	stz $883d	                stz     L883D
578	.b29d	9c 3e 88	stz $883e	                stz     L883E
579	.b2a0	18		clc		                clc

581	.b2a1					LBDB9:
582	.b2a1	2e 3a 88	rol $883a	                rol     L883A
583	.b2a4	2e 3b 88	rol $883b	                rol     L883B
584	.b2a7	2e 3c 88	rol $883c	                rol     L883C
585	.b2aa	2e 3d 88	rol $883d	                rol     L883D
586	.b2ad	2e 3e 88	rol $883e	                rol     L883E
587	.b2b0	38		sec		                sec
588	.b2b1	ad 3d 88	lda $883d	                lda     L883D
589	.b2b4	ed 3f 88	sbc $883f	                sbc     L883F
590	.b2b7	aa		tax		                tax
591	.b2b8	ad 3e 88	lda $883e	                lda     L883E
592	.b2bb	ed 40 88	sbc $8840	                sbc     L8840
593	.b2be	90 06		bcc $b2c6	                bcc     LBDDE
594	.b2c0	8e 3d 88	stx $883d	                stx     L883D
595	.b2c3	8d 3e 88	sta $883e	                sta     L883E

597	.b2c6					LBDDE:
598	.b2c6	88		dey		                dey
599	.b2c7	d0 d8		bne $b2a1	                bne     LBDB9
600	.b2c9	fa		plx		                plx
601	.b2ca	ad 3a 88	lda $883a	                lda     L883A
602	.b2cd	2a		rol a		                rol     a
603	.b2ce	9d 00 03	sta $0300,x	                sta     vduv+0,x
604	.b2d1	ad 3b 88	lda $883b	                lda     L883B
605	.b2d4	2a		rol a		                rol     a
606	.b2d5	9d 01 03	sta $0301,x	                sta     vduv+1,x
607	.b2d8	ad 3c 88	lda $883c	                lda     L883C
608	.b2db	2a		rol a		                rol     a
609	.b2dc	9d 02 03	sta $0302,x	                sta     vduv+2,x
610	.b2df	60		rts		                rts


613	.b2e0					LBDF8:
614	.b2e0	fa		plx		                plx
615	.b2e1	60		rts		                rts






622	.b2e2					LBDFA:
623	.b2e2	38		sec		                sec
624	.b2e3	a9 00		lda #$00	                lda     #0
625	.b2e5	fd 00 03	sbc $0300,x	                sbc     vduv+0,x
626	.b2e8	99 00 03	sta $0300,y	                sta     vduv+0,y
627	.b2eb	a9 00		lda #$00	                lda     #0
628	.b2ed	fd 01 03	sbc $0301,x	                sbc     vduv+1,x
629	.b2f0	99 01 03	sta $0301,y	                sta     vduv+1,y
630	.b2f3	60		rts		                rts






637	.b2f4					LBE0C:
638	.b2f4	a0 17		ldy #$17	                ldy     #$17
639	.b2f6	9c 39 88	stz $8839	                stz     L8839
640	.b2f9	9c 38 88	stz $8838	                stz     L8838
641	.b2fc	9c 37 88	stz $8837	                stz     L8837
642	.b2ff	4e 36 88	lsr $8836	                lsr     L8836
643	.b302	6e 35 88	ror $8835	                ror     L8835
644	.b305	6e 34 88	ror $8834	                ror     L8834

646	.b308					LBE20:
647	.b308	90 1c		bcc $b326	                bcc     LBE3E
648	.b30a	18		clc		                clc
649	.b30b	ad 30 88	lda $8830	                lda     L8830
650	.b30e	6d 37 88	adc $8837	                adc     L8837
651	.b311	8d 37 88	sta $8837	                sta     L8837
652	.b314	ad 31 88	lda $8831	                lda     L8831
653	.b317	6d 38 88	adc $8838	                adc     L8838
654	.b31a	8d 38 88	sta $8838	                sta     L8838
655	.b31d	ad 32 88	lda $8832	                lda     L8832
656	.b320	6d 39 88	adc $8839	                adc     L8839
657	.b323	8d 39 88	sta $8839	                sta     L8839

659	.b326					LBE3E:
660	.b326	18		clc		                clc
661	.b327	a2 05		ldx #$05	                ldx     #5

663	.b329					LBE41:
664	.b329	7e 34 88	ror $8834,x	                ror     $8834,x
665	.b32c	ca		dex		                dex
666	.b32d	10 fa		bpl $b329	                bpl     LBE41
667	.b32f	88		dey		                dey
668	.b330	10 d6		bpl $b308	                bpl     LBE20
669	.b332	60		rts		                rts






676	.b333					LBE4B:
677	.b333	a2 03		ldx #$03	                ldx     #3

679	.b335					LBE4D:
680	.b335	9e 30 88	stz $8830,x	                stz     $8830,x
681	.b338	74 dc		stz $dc,x	                stz     ZTEMPB,x
682	.b33a	ca		dex		                dex
683	.b33b	10 f8		bpl $b335	                bpl     LBE4D
684	.b33d	a0 05		ldy #$05	                ldy     #5

686	.b33f					LBE57:
687	.b33f	b9 34 88	lda $8834,y	                lda     $8834,y
688	.b342	85 da		sta $da		                sta     ZTEMP+0
689	.b344	5a		phy		                phy
690	.b345	a0 03		ldy #$03	                ldy     #3

692	.b347					LBE5F:
693	.b347	5a		phy		                phy
694	.b348	38		sec		                sec
695	.b349	2e 30 88	rol $8830	                rol     L8830
696	.b34c	2e 31 88	rol $8831	                rol     L8831
697	.b34f	2e 32 88	rol $8832	                rol     L8832
698	.b352	2e 33 88	rol $8833	                rol     L8833
699	.b355	a2 01		ldx #$01	                ldx     #1
700	.b357	a5 dc		lda $dc		                lda     ZTEMPB+0

702	.b359					LBE71:
703	.b359	06 da		asl $da		                asl     ZTEMP+0
704	.b35b	2a		rol a		                rol     a
705	.b35c	26 dd		rol $dd		                rol     ZTEMPB+1
706	.b35e	26 de		rol $de		                rol     ZTEMPC+0
707	.b360	26 df		rol $df		                rol     ZTEMPC+1
708	.b362	ca		dex		                dex
709	.b363	10 f4		bpl $b359	                bpl     LBE71
710	.b365	85 dc		sta $dc		                sta     ZTEMPB+0
711	.b367	38		sec		                sec
712	.b368	ed 30 88	sbc $8830	                sbc     L8830
713	.b36b	48		pha		                pha
714	.b36c	a5 dd		lda $dd		                lda     ZTEMPB+1
715	.b36e	ed 31 88	sbc $8831	                sbc     L8831
716	.b371	aa		tax		                tax
717	.b372	a5 de		lda $de		                lda     ZTEMPC+0
718	.b374	ed 32 88	sbc $8832	                sbc     L8832
719	.b377	a8		tay		                tay
720	.b378	a5 df		lda $df		                lda     ZTEMPC+1
721	.b37a	ed 33 88	sbc $8833	                sbc     L8833
722	.b37d	90 0e		bcc $b38d	                bcc     LBEA5
723	.b37f	85 df		sta $df		                sta     ZTEMPC+1
724	.b381	84 de		sty $de		                sty     ZTEMPC+0
725	.b383	86 dd		stx $dd		                stx     ZTEMPB+1
726	.b385	68		pla		                pla
727	.b386	85 dc		sta $dc		                sta     ZTEMPB+0
728	.b388	ee 30 88	inc $8830	                inc     L8830
729	.b38b	80 04		bra $b391	                bra     LBEA9


732	.b38d					LBEA5:
733	.b38d	68		pla		                pla
734	.b38e	ce 30 88	dec $8830	                dec     L8830

736	.b391					LBEA9:
737	.b391	7a		ply		                ply
738	.b392	88		dey		                dey
739	.b393	10 b2		bpl $b347	                bpl     LBE5F
740	.b395	7a		ply		                ply
741	.b396	88		dey		                dey
742	.b397	10 a6		bpl $b33f	                bpl     LBE57
743	.b399	4e 33 88	lsr $8833	                lsr     L8833
744	.b39c	6e 32 88	ror $8832	                ror     L8832
745	.b39f	6e 31 88	ror $8831	                ror     L8831
746	.b3a2	6e 30 88	ror $8830	                ror     L8830
747	.b3a5	60		rts		                rts

749						;-------------------------------------------------------------------------
750						;
751						; 184<80><93>191 = Move/copy rectangle [MasRef E.3-31]
752						;
753						; The normal interpretation of <p> does not apply in this group of
754						; plot codes and the meanings are as follows:
755						;
756						; 184, 185 - %1011100x - Move rectangle, relative
757						; 186, 187 - %1011101x - Copy rectangle, relative
758						; 188, 189 - %1011110x - Move rectangle, absolute
759						; 190, 191 - %1011111x - Copy rectangle, absolute
760						;
761	.b3a6					plotMoveOrCopyRectangle:
762	.b3a6	29 02		and #$02	                and     #2
763	.b3a8	8d 45 03	sta $0345	                sta     vduv.mocr.copy

765	.b3ab	20 51 c9	jsr $c951	                jsr     mos.prepareForPlotBackground

767	.b3ae	a2 14		ldx #$14	                ldx     #VDUVariables.oldGraphicsCursorPixels
768	.b3b0	20 e6 c8	jsr $c8e6	                jsr     mos.prepareAABB

770						                ; mocr.dest.min = PLOT coordinate
771	.b3b3	a0 34		ldy #$34	                ldy     #VDUVariables.mocr.dest.min
772	.b3b5	20 16 c9	jsr $c916	                jsr     mos.copyLastFourVDUQueueBytes
773	.b3b8	84 da		sty $da		                sty     ZTEMP+0              ;Y=VDUVariables.mocr.dest.max

775						                ; dest.max = dest.min + (src.max - src.min)
776	.b3ba	a2 34		ldx #$34	                ldx     #VDUVariables.mocr.dest.min
777	.b3bc	a0 2c		ldy #$2c	                ldy     #VDUVariables.mocr.src.max
778	.b3be	a9 28		lda #$28	                lda     #VDUVariables.mocr.src.min
779	.b3c0	20 80 d5	jsr $d580	                jsr     mos.addRegionDimensionsToVDUVariableCoordinates

781						                ;
782	.b3c3	a2 28		ldx #$28	                ldx     #VDUVariables.mocr.src.min
783	.b3c5	a0 34		ldy #$34	                ldy     #VDUVariables.mocr.dest
784	.b3c7	20 cc d5	jsr $d5cc	                jsr     mos.sortVDUVariableWords

786	.b3ca	5a		phy		                phy
787	.b3cb	da		phx		                phx
788	.b3cc	a0 00		ldy #$00	                ldy     #0                   ;get outcode for X axis
789	.b3ce	20 b7 d1	jsr $d1b7	                jsr     mos.getOutcodeForAxis
790	.b3d1	f0 08		beq $b3db	                beq     LBEF3                ;taken if
791	.b3d3	4a		lsr a		                lsr     a
792	.b3d4	f0 03		beq $b3d9	                beq     LBEF1
793	.b3d6	68		pla		                pla

795	.b3d7					LBEEF:
796	.b3d7	68		pla		                pla
797	.b3d8	60		rts		                rts


800	.b3d9					LBEF1:
801	.b3d9	a2 00		ldx #$00	                ldx     #0

803	.b3db					LBEF3:
804	.b3db	68		pla		                pla

806	.b3dc	a0 30		ldy #$30	                ldy     #VDUVariables.workspace._30
807	.b3de	84 da		sty $da		                sty     ZTEMP+0
808	.b3e0	a0 28		ldy #$28	                ldy     #VDUVariables.mocr.src.min
809	.b3e2	20 8d d5	jsr $d58d	                jsr     mos.addRegionDimensionToVDUVariableCoordinate

811	.b3e5	a0 3c		ldy #$3c	                ldy     #VDUVariables.workspace._3C
812	.b3e7	84 da		sty $da		                sty     ZTEMP+0

814	.b3e9	a0 34		ldy #$34	                ldy     #VDUVariables.mocr.dest.min
815	.b3eb	20 8d d5	jsr $d58d	                jsr     mos.addRegionDimensionToVDUVariableCoordinate

817	.b3ee	68		pla		                pla
818	.b3ef	18		clc		                clc
819	.b3f0	69 04		adc #$04	                adc     #4
820	.b3f2	aa		tax		                tax
821	.b3f3	da		phx		                phx
822	.b3f4	a0 00		ldy #$00	                ldy     #0
823	.b3f6	20 b7 d1	jsr $d1b7	                jsr     mos.getOutcodeForAxis
824	.b3f9	f0 05		beq $b400	                beq     LBF18
825	.b3fb	4a		lsr a		                lsr     a
826	.b3fc	f0 d9		beq $b3d7	                beq     LBEEF
827	.b3fe	a2 04		ldx #$04	                ldx     #4

829	.b400					LBF18:
830	.b400	68		pla		                pla
831	.b401	a0 40		ldy #$40	                ldy     #VDUVariables.workspace._40
832	.b403	84 da		sty $da		                sty     ZTEMP+0
833	.b405	a0 38		ldy #$38	                ldy     #VDUVariables.workspace._38
834	.b407	20 8d d5	jsr $d58d	                jsr     mos.addRegionDimensionToVDUVariableCoordinate
835	.b40a	ad 40 03	lda $0340	                lda     vduv.workspace._40
836	.b40d	cd 3c 03	cmp $033c	                cmp     vduv.workspace._3C
837	.b410	ad 41 03	lda $0341	                lda     vduv.workspace._41
838	.b413	ed 3d 03	sbc $033d	                sbc     vduv.workspace._3D
839	.b416	10 10		bpl $b428	                bpl     LBF40
840	.b418	ad 45 03	lda $0345	                lda     vduv.workspace._45
841	.b41b	d0 03		bne $b420	                bne     LBF38
842	.b41d	20 20 c4	jsr $c420	                jsr     mos.LC420

844	.b420					LBF38:
845	.b420	a2 34		ldx #$34	                ldx     #VDUVariables.mocr.dest
846	.b422	20 02 c9	jsr $c902	                jsr     mos.copyEightBytesToWorkspace28
847	.b425	4c 20 c4	jmp $c420	                jmp     mos.LC420


850	.b428					LBF40:
851	.b428	9c 47 03	stz $0347	                stz     vduv.workspace._47
852	.b42b	ad 30 03	lda $0330	                lda     vduv.workspace._30
853	.b42e	2d 61 03	and $0361	                and     vduv.pixelsPerByteMinusOne
854	.b431	85 da		sta $da		                sta     ZTEMP+0
855	.b433	ad 3c 03	lda $033c	                lda     vduv.workspace._3C
856	.b436	2d 61 03	and $0361	                and     vduv.pixelsPerByteMinusOne
857	.b439	38		sec		                sec
858	.b43a	e5 da		sbc $da		                sbc     ZTEMP+0
859	.b43c	10 06		bpl $b444	                bpl     LBF5C
860	.b43e	ce 47 03	dec $0347	                dec     vduv.workspace._47
861	.b441	2d 61 03	and $0361	                and     vduv.pixelsPerByteMinusOne

863	.b444					LBF5C:
864	.b444	8d 43 03	sta $0343	                sta     vduv.workspace._43
865	.b447	48		pha		                pha
866	.b448	49 ff		eor #$ff	                eor     #$ff
867	.b44a	1a		inc a		                inc     a
868	.b44b	2d 61 03	and $0361	                and     vduv.pixelsPerByteMinusOne
869	.b44e	8d 42 03	sta $0342	                sta     vduv.workspace._42
870	.b451	68		pla		                pla
871	.b452	18		clc		                clc
872	.b453	6d 61 03	adc $0361	                adc     vduv.pixelsPerByteMinusOne
873	.b456	aa		tax		                tax
874	.b457	bd 30 e1	lda $e130,x	                lda     mos.LE120,x
875	.b45a	85 e1		sta $e1		                sta     ZTEMPD+1
876	.b45c	a2 3c		ldx #$3c	                ldx     #VDUVariables.workspace._3C
877	.b45e	a0 40		ldy #$40	                ldy     #VDUVariables.workspace._40
878	.b460	20 9c da	jsr $da9c	                jsr     mos.LDA9C
879	.b463	8d 44 03	sta $0344	                sta     vduv.workspace._44
880	.b466	a5 d1		lda $d1		                lda     ZMASK
881	.b468	8d 46 03	sta $0346	                sta     vduv.workspace._46
882	.b46b	a5 dc		lda $dc		                lda     ZTEMPB+0
883	.b46d	85 e0		sta $e0		                sta     ZTEMPD+0
884	.b46f	a2 00		ldx #$00	                ldx     #0
885	.b471	20 ce b4	jsr $b4ce	                jsr     LBFE6
886	.b474	f0 40		beq $b4b6	                beq     LBFCE
887	.b476	ad 2a 03	lda $032a	                lda     vduv.workspace._2A
888	.b479	cd 36 03	cmp $0336	                cmp     vduv.workspace._36
889	.b47c	ad 2b 03	lda $032b	                lda     vduv.workspace._2B
890	.b47f	ed 37 03	sbc $0337	                sbc     vduv.workspace._37
891	.b482	50 02		bvc $b486	                bvc     LBF9E
892	.b484	49 80		eor #$80	                eor     #$80

894	.b486					LBF9E:
895	.b486	30 11		bmi $b499	                bmi     LBFB1

897	.b488					LBFA0:
898	.b488	20 62 db	jsr $db62	                jsr     mos.LDB62
899	.b48b	a2 00		ldx #$00	                ldx     #0
900	.b48d	20 b9 b4	jsr $b4b9	                jsr     LBFD1
901	.b490	a2 0c		ldx #$0c	                ldx     #$c
902	.b492	20 b9 b4	jsr $b4b9	                jsr     LBFD1
903	.b495	d0 f1		bne $b488	                bne     LBFA0
904	.b497	80 1d		bra $b4b6	                bra     LBFCE


907	.b499					LBFB1:
908	.b499	a2 2a		ldx #$2a	                ldx     #VDUVariables.mocr.src.min.y
909	.b49b	a0 2e		ldy #$2e	                ldy     #VDUVariables.mocr.src.max.y
910	.b49d	20 c2 e2	jsr $e2c2	                jsr     mos.exchangeTwoVDUBytes
911	.b4a0	a2 36		ldx #$36	                ldx     #VDUVariables.mocr.dest.min.y
912	.b4a2	a0 3a		ldy #$3a	                ldy     #VDUVariables.mocr.dest.max.y
913	.b4a4	20 c2 e2	jsr $e2c2	                jsr     mos.exchangeTwoVDUBytes

915	.b4a7					LBFBF:
916	.b4a7	20 62 db	jsr $db62	                jsr     mos.LDB62
917	.b4aa	a2 00		ldx #$00	                ldx     #0
918	.b4ac	20 c3 b4	jsr $b4c3	                jsr     LBFDB
919	.b4af	a2 0c		ldx #$0c	                ldx     #$c
920	.b4b1	20 c3 b4	jsr $b4c3	                jsr     LBFDB
921	.b4b4	d0 f1		bne $b4a7	                bne     LBFBF

923	.b4b6					LBFCE:
924	.b4b6	4c 62 db	jmp $db62	                jmp     mos.LDB62




929	.b4b9					LBFD1:
930	.b4b9	fe 2a 03	inc $032a,x	                inc     vduv.workspace._2A,x
931	.b4bc	d0 10		bne $b4ce	                bne     LBFE6
932	.b4be	fe 2b 03	inc $032b,x	                inc     vduv.workspace._2B,x
933	.b4c1	80 0b		bra $b4ce	                bra     LBFE6






940	.b4c3					LBFDB:
941	.b4c3	bd 2a 03	lda $032a,x	                lda     vduv.workspace._2A,x
942	.b4c6	d0 03		bne $b4cb	                bne     LBFE3
943	.b4c8	de 2b 03	dec $032b,x	                dec     vduv.workspace._2B,x

945	.b4cb					LBFE3:
946	.b4cb	de 2a 03	dec $032a,x	                dec     vduv.workspace._2A,x






953	.b4ce					LBFE6:
954	.b4ce	bd 2a 03	lda $032a,x	                lda     vduv.workspace._2A,x
955	.b4d1	dd 2e 03	cmp $032e,x	                cmp     vduv.workspace._2E,x
956	.b4d4	d0 06		bne $b4dc	                bne     rtsBFF4
957	.b4d6	bd 2b 03	lda $032b,x	                lda     vduv.workspace._2B,x
958	.b4d9	dd 2f 03	cmp $032f,x	                cmp     vduv.workspace._2F,x

960	.b4dc					rtsBFF4:
961	.b4dc	60		rts		                rts

963						                .if version!=400&&version!=350
964						; Hmm. What even is this???
965	>b4dd	ff				                .byte $ff
966	>b4de	ff				                .byte $ff
967	>b4df	ff				                .byte $ff
968	>b4e0	ff				                .byte $ff
969	>b4e1	ff				                .byte $ff
970	>b4e2	ff				                .byte $ff
971	>b4e3	ff				                .byte $ff
972	>b4e4	ff				                .byte $ff
973	>b4e5	ff				                .byte $ff
974	>b4e6	ff				                .byte $ff
975	>b4e7	ff				                .byte $ff
976						                .endif

978						                .endblock

:5	;******  Return to file: src/terminal.s65

6828						                .endif

6830						;-------------------------------------------------------------------------

6832						                .if version==320&&multios
6835						                .endif

6837						;-------------------------------------------------------------------------

6839						; Unused space
6840						; ============
6841	>b4e8	ff ff ff ff ff ff ff ff		                .fill $b900-*,$ff
	>b4f0	ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff
	>b500	ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff
	>b510	ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff
	>b520	ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff
	>b530	ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff
	>b540	ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff
	>b550	ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff
	>b560	ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff
	>b570	ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff
	>b580	ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff
	>b590	ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff
	>b5a0	ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff
	>b5b0	ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff
	>b5c0	ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff
	>b5d0	ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff
	>b5e0	ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff
	>b5f0	ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff
	>b600	ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff
	>b610	ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff
	>b620	ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff
	>b630	ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff
	>b640	ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff
	>b650	ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff
	>b660	ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff
	>b670	ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff
	>b680	ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff
	>b690	ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff
	>b6a0	ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff
	>b6b0	ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff
	>b6c0	ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff
	>b6d0	ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff
	>b6e0	ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff
	>b6f0	ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff
	>b700	ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff
	>b710	ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff
	>b720	ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff
	>b730	ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff
	>b740	ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff
	>b750	ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff
	>b760	ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff
	>b770	ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff
	>b780	ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff
	>b790	ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff
	>b7a0	ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff
	>b7b0	ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff
	>b7c0	ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff
	>b7d0	ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff
	>b7e0	ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff
	>b7f0	ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff
	>b800	ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff
	>b810	ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff
	>b820	ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff
	>b830	ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff
	>b840	ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff
	>b850	ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff
	>b860	ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff
	>b870	ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff
	>b880	ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff
	>b890	ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff
	>b8a0	ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff
	>b8b0	ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff
	>b8c0	ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff
	>b8d0	ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff
	>b8e0	ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff
	>b8f0	ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff

6843						; Default font
6844						; ============
6845	.b900					LB900:
6846						                .cerror (<LB900)!=0,"font data must be page aligned"
6847						                ; CHR$32 -
6848	>b900	00				                .byte %00000000
6849	>b901	00				                .byte %00000000
6850	>b902	00				                .byte %00000000
6851	>b903	00				                .byte %00000000
6852	>b904	00				                .byte %00000000
6853	>b905	00				                .byte %00000000
6854	>b906	00				                .byte %00000000
6855	>b907	00				                .byte %00000000

6857						                ; CHR$33 - !
6858	>b908	18				                .byte %00011000
6859	>b909	18				                .byte %00011000
6860	>b90a	18				                .byte %00011000
6861	>b90b	18				                .byte %00011000
6862	>b90c	18				                .byte %00011000
6863	>b90d	00				                .byte %00000000
6864	>b90e	18				                .byte %00011000
6865	>b90f	00				                .byte %00000000

6867						                ; CHR$34 - "
6868	>b910	6c				                .byte %01101100
6869	>b911	6c				                .byte %01101100
6870	>b912	6c				                .byte %01101100
6871	>b913	00				                .byte %00000000
6872	>b914	00				                .byte %00000000
6873	>b915	00				                .byte %00000000
6874	>b916	00				                .byte %00000000
6875	>b917	00				                .byte %00000000

6877						                ; CHR$35 - #
6878	>b918	36				                .byte %00110110
6879	>b919	36				                .byte %00110110
6880	>b91a	7f				                .byte %01111111
6881	>b91b	36				                .byte %00110110
6882	>b91c	7f				                .byte %01111111
6883	>b91d	36				                .byte %00110110
6884	>b91e	36				                .byte %00110110
6885	>b91f	00				                .byte %00000000

6887						                ; CHR$36 - $
6888	>b920	0c				                .byte %00001100
6889	>b921	3f				                .byte %00111111
6890	>b922	68				                .byte %01101000
6891	>b923	3e				                .byte %00111110
6892	>b924	0b				                .byte %00001011
6893	>b925	7e				                .byte %01111110
6894	>b926	18				                .byte %00011000
6895	>b927	00				                .byte %00000000

6897						                ; CHR$37 - %
6898	>b928	60				                .byte %01100000
6899	>b929	66				                .byte %01100110
6900	>b92a	0c				                .byte %00001100
6901	>b92b	18				                .byte %00011000
6902	>b92c	30				                .byte %00110000
6903	>b92d	66				                .byte %01100110
6904	>b92e	06				                .byte %00000110
6905	>b92f	00				                .byte %00000000

6907						                ; CHR$38 - &
6908	>b930	38				                .byte %00111000
6909	>b931	6c				                .byte %01101100
6910	>b932	6c				                .byte %01101100
6911	>b933	38				                .byte %00111000
6912	>b934	6d				                .byte %01101101
6913	>b935	66				                .byte %01100110
6914	>b936	3b				                .byte %00111011
6915	>b937	00				                .byte %00000000

6917						                ; CHR$39 - '
6918	>b938	0c				                .byte %00001100
6919	>b939	18				                .byte %00011000
6920	>b93a	30				                .byte %00110000
6921	>b93b	00				                .byte %00000000
6922	>b93c	00				                .byte %00000000
6923	>b93d	00				                .byte %00000000
6924	>b93e	00				                .byte %00000000
6925	>b93f	00				                .byte %00000000

6927						                ; CHR$40 - (
6928	>b940	0c				                .byte %00001100
6929	>b941	18				                .byte %00011000
6930	>b942	30				                .byte %00110000
6931	>b943	30				                .byte %00110000
6932	>b944	30				                .byte %00110000
6933	>b945	18				                .byte %00011000
6934	>b946	0c				                .byte %00001100
6935	>b947	00				                .byte %00000000

6937						                ; CHR$41 - )
6938	>b948	30				                .byte %00110000
6939	>b949	18				                .byte %00011000
6940	>b94a	0c				                .byte %00001100
6941	>b94b	0c				                .byte %00001100
6942	>b94c	0c				                .byte %00001100
6943	>b94d	18				                .byte %00011000
6944	>b94e	30				                .byte %00110000
6945	>b94f	00				                .byte %00000000

6947						                ; CHR$42 - *
6948	>b950	00				                .byte %00000000
6949	>b951	18				                .byte %00011000
6950	>b952	7e				                .byte %01111110
6951	>b953	3c				                .byte %00111100
6952	>b954	7e				                .byte %01111110
6953	>b955	18				                .byte %00011000
6954	>b956	00				                .byte %00000000
6955	>b957	00				                .byte %00000000

6957						                ; CHR$43 - +
6958	>b958	00				                .byte %00000000
6959	>b959	18				                .byte %00011000
6960	>b95a	18				                .byte %00011000
6961	>b95b	7e				                .byte %01111110
6962	>b95c	18				                .byte %00011000
6963	>b95d	18				                .byte %00011000
6964	>b95e	00				                .byte %00000000
6965	>b95f	00				                .byte %00000000

6967						                ; CHR$44 - ,
6968	>b960	00				                .byte %00000000
6969	>b961	00				                .byte %00000000
6970	>b962	00				                .byte %00000000
6971	>b963	00				                .byte %00000000
6972	>b964	00				                .byte %00000000
6973	>b965	18				                .byte %00011000
6974	>b966	18				                .byte %00011000
6975	>b967	30				                .byte %00110000

6977						                ; CHR$45 - -
6978	>b968	00				                .byte %00000000
6979	>b969	00				                .byte %00000000
6980	>b96a	00				                .byte %00000000
6981	>b96b	7e				                .byte %01111110
6982	>b96c	00				                .byte %00000000
6983	>b96d	00				                .byte %00000000
6984	>b96e	00				                .byte %00000000
6985	>b96f	00				                .byte %00000000

6987						                ; CHR$46 - .
6988	>b970	00				                .byte %00000000
6989	>b971	00				                .byte %00000000
6990	>b972	00				                .byte %00000000
6991	>b973	00				                .byte %00000000
6992	>b974	00				                .byte %00000000
6993	>b975	18				                .byte %00011000
6994	>b976	18				                .byte %00011000
6995	>b977	00				                .byte %00000000

6997						                ; CHR$47 - /
6998	>b978	00				                .byte %00000000
6999	>b979	06				                .byte %00000110
7000	>b97a	0c				                .byte %00001100
7001	>b97b	18				                .byte %00011000
7002	>b97c	30				                .byte %00110000
7003	>b97d	60				                .byte %01100000
7004	>b97e	00				                .byte %00000000
7005	>b97f	00				                .byte %00000000

7007						                ; CHR$48 - 0
7008	>b980	3c				                .byte %00111100
7009	>b981	66				                .byte %01100110
7010	>b982	6e				                .byte %01101110
7011	>b983	7e				                .byte %01111110
7012	>b984	76				                .byte %01110110
7013	>b985	66				                .byte %01100110
7014	>b986	3c				                .byte %00111100
7015	>b987	00				                .byte %00000000

7017						                ; CHR$49 - 1
7018	>b988	18				                .byte %00011000
7019	>b989	38				                .byte %00111000
7020	>b98a	18				                .byte %00011000
7021	>b98b	18				                .byte %00011000
7022	>b98c	18				                .byte %00011000
7023	>b98d	18				                .byte %00011000
7024	>b98e	7e				                .byte %01111110
7025	>b98f	00				                .byte %00000000

7027						                ; CHR$50 - 2
7028	>b990	3c				                .byte %00111100
7029	>b991	66				                .byte %01100110
7030	>b992	06				                .byte %00000110
7031	>b993	0c				                .byte %00001100
7032	>b994	18				                .byte %00011000
7033	>b995	30				                .byte %00110000
7034	>b996	7e				                .byte %01111110
7035	>b997	00				                .byte %00000000

7037						                ; CHR$51 - 3
7038	>b998	3c				                .byte %00111100
7039	>b999	66				                .byte %01100110
7040	>b99a	06				                .byte %00000110
7041	>b99b	1c				                .byte %00011100
7042	>b99c	06				                .byte %00000110
7043	>b99d	66				                .byte %01100110
7044	>b99e	3c				                .byte %00111100
7045	>b99f	00				                .byte %00000000

7047						                ; CHR$52 - 4
7048	>b9a0	0c				                .byte %00001100
7049	>b9a1	1c				                .byte %00011100
7050	>b9a2	3c				                .byte %00111100
7051	>b9a3	6c				                .byte %01101100
7052	>b9a4	7e				                .byte %01111110
7053	>b9a5	0c				                .byte %00001100
7054	>b9a6	0c				                .byte %00001100
7055	>b9a7	00				                .byte %00000000

7057						                ; CHR$53 - 5
7058	>b9a8	7e				                .byte %01111110
7059	>b9a9	60				                .byte %01100000
7060	>b9aa	7c				                .byte %01111100
7061	>b9ab	06				                .byte %00000110
7062	>b9ac	06				                .byte %00000110
7063	>b9ad	66				                .byte %01100110
7064	>b9ae	3c				                .byte %00111100
7065	>b9af	00				                .byte %00000000

7067						                ; CHR$54 - 6
7068	>b9b0	1c				                .byte %00011100
7069	>b9b1	30				                .byte %00110000
7070	>b9b2	60				                .byte %01100000
7071	>b9b3	7c				                .byte %01111100
7072	>b9b4	66				                .byte %01100110
7073	>b9b5	66				                .byte %01100110
7074	>b9b6	3c				                .byte %00111100
7075	>b9b7	00				                .byte %00000000

7077						                ; CHR$55 - 7
7078	>b9b8	7e				                .byte %01111110
7079	>b9b9	06				                .byte %00000110
7080	>b9ba	0c				                .byte %00001100
7081	>b9bb	18				                .byte %00011000
7082	>b9bc	30				                .byte %00110000
7083	>b9bd	30				                .byte %00110000
7084	>b9be	30				                .byte %00110000
7085	>b9bf	00				                .byte %00000000

7087						                ; CHR$56 - 8
7088	>b9c0	3c				                .byte %00111100
7089	>b9c1	66				                .byte %01100110
7090	>b9c2	66				                .byte %01100110
7091	>b9c3	3c				                .byte %00111100
7092	>b9c4	66				                .byte %01100110
7093	>b9c5	66				                .byte %01100110
7094	>b9c6	3c				                .byte %00111100
7095	>b9c7	00				                .byte %00000000

7097						                ; CHR$57 - 9
7098	>b9c8	3c				                .byte %00111100
7099	>b9c9	66				                .byte %01100110
7100	>b9ca	66				                .byte %01100110
7101	>b9cb	3e				                .byte %00111110
7102	>b9cc	06				                .byte %00000110
7103	>b9cd	0c				                .byte %00001100
7104	>b9ce	38				                .byte %00111000
7105	>b9cf	00				                .byte %00000000

7107						                ; CHR$58 - :
7108	>b9d0	00				                .byte %00000000
7109	>b9d1	00				                .byte %00000000
7110	>b9d2	18				                .byte %00011000
7111	>b9d3	18				                .byte %00011000
7112	>b9d4	00				                .byte %00000000
7113	>b9d5	18				                .byte %00011000
7114	>b9d6	18				                .byte %00011000
7115	>b9d7	00				                .byte %00000000

7117						                ; CHR$59 - ;
7118	>b9d8	00				                .byte %00000000
7119	>b9d9	00				                .byte %00000000
7120	>b9da	18				                .byte %00011000
7121	>b9db	18				                .byte %00011000
7122	>b9dc	00				                .byte %00000000
7123	>b9dd	18				                .byte %00011000
7124	>b9de	18				                .byte %00011000
7125	>b9df	30				                .byte %00110000

7127						                ; CHR$60 - <
7128	>b9e0	0c				                .byte %00001100
7129	>b9e1	18				                .byte %00011000
7130	>b9e2	30				                .byte %00110000
7131	>b9e3	60				                .byte %01100000
7132	>b9e4	30				                .byte %00110000
7133	>b9e5	18				                .byte %00011000
7134	>b9e6	0c				                .byte %00001100
7135	>b9e7	00				                .byte %00000000

7137						                ; CHR$61 - =
7138	>b9e8	00				                .byte %00000000
7139	>b9e9	00				                .byte %00000000
7140	>b9ea	7e				                .byte %01111110
7141	>b9eb	00				                .byte %00000000
7142	>b9ec	7e				                .byte %01111110
7143	>b9ed	00				                .byte %00000000
7144	>b9ee	00				                .byte %00000000
7145	>b9ef	00				                .byte %00000000

7147						                ; CHR$62 - >
7148	>b9f0	30				                .byte %00110000
7149	>b9f1	18				                .byte %00011000
7150	>b9f2	0c				                .byte %00001100
7151	>b9f3	06				                .byte %00000110
7152	>b9f4	0c				                .byte %00001100
7153	>b9f5	18				                .byte %00011000
7154	>b9f6	30				                .byte %00110000
7155	>b9f7	00				                .byte %00000000

7157						                ; CHR$63 - ?
7158	>b9f8	3c				                .byte %00111100
7159	>b9f9	66				                .byte %01100110
7160	>b9fa	0c				                .byte %00001100
7161	>b9fb	18				                .byte %00011000
7162	>b9fc	18				                .byte %00011000
7163	>b9fd	00				                .byte %00000000
7164	>b9fe	18				                .byte %00011000
7165	>b9ff	00				                .byte %00000000

7167						                ; CHR$64 - @
7168	>ba00	3c				                .byte %00111100
7169	>ba01	66				                .byte %01100110
7170	>ba02	6e				                .byte %01101110
7171	>ba03	6a				                .byte %01101010
7172	>ba04	6e				                .byte %01101110
7173	>ba05	60				                .byte %01100000
7174	>ba06	3c				                .byte %00111100
7175	>ba07	00				                .byte %00000000

7177						                ; CHR$65 - A
7178	>ba08	3c				                .byte %00111100
7179	>ba09	66				                .byte %01100110
7180	>ba0a	66				                .byte %01100110
7181	>ba0b	7e				                .byte %01111110
7182	>ba0c	66				                .byte %01100110
7183	>ba0d	66				                .byte %01100110
7184	>ba0e	66				                .byte %01100110
7185	>ba0f	00				                .byte %00000000

7187						                ; CHR$66 - B
7188	>ba10	7c				                .byte %01111100
7189	>ba11	66				                .byte %01100110
7190	>ba12	66				                .byte %01100110
7191	>ba13	7c				                .byte %01111100
7192	>ba14	66				                .byte %01100110
7193	>ba15	66				                .byte %01100110
7194	>ba16	7c				                .byte %01111100
7195	>ba17	00				                .byte %00000000

7197						                ; CHR$67 - C
7198	>ba18	3c				                .byte %00111100
7199	>ba19	66				                .byte %01100110
7200	>ba1a	60				                .byte %01100000
7201	>ba1b	60				                .byte %01100000
7202	>ba1c	60				                .byte %01100000
7203	>ba1d	66				                .byte %01100110
7204	>ba1e	3c				                .byte %00111100
7205	>ba1f	00				                .byte %00000000

7207						                ; CHR$68 - D
7208	>ba20	78				                .byte %01111000
7209	>ba21	6c				                .byte %01101100
7210	>ba22	66				                .byte %01100110
7211	>ba23	66				                .byte %01100110
7212	>ba24	66				                .byte %01100110
7213	>ba25	6c				                .byte %01101100
7214	>ba26	78				                .byte %01111000
7215	>ba27	00				                .byte %00000000

7217						                ; CHR$69 - E
7218	>ba28	7e				                .byte %01111110
7219	>ba29	60				                .byte %01100000
7220	>ba2a	60				                .byte %01100000
7221	>ba2b	7c				                .byte %01111100
7222	>ba2c	60				                .byte %01100000
7223	>ba2d	60				                .byte %01100000
7224	>ba2e	7e				                .byte %01111110
7225	>ba2f	00				                .byte %00000000

7227						                ; CHR$70 - F
7228	>ba30	7e				                .byte %01111110
7229	>ba31	60				                .byte %01100000
7230	>ba32	60				                .byte %01100000
7231	>ba33	7c				                .byte %01111100
7232	>ba34	60				                .byte %01100000
7233	>ba35	60				                .byte %01100000
7234	>ba36	60				                .byte %01100000
7235	>ba37	00				                .byte %00000000

7237						                ; CHR$71 - G
7238	>ba38	3c				                .byte %00111100
7239	>ba39	66				                .byte %01100110
7240	>ba3a	60				                .byte %01100000
7241	>ba3b	6e				                .byte %01101110
7242	>ba3c	66				                .byte %01100110
7243	>ba3d	66				                .byte %01100110
7244	>ba3e	3c				                .byte %00111100
7245	>ba3f	00				                .byte %00000000

7247						                ; CHR$72 - H
7248	>ba40	66				                .byte %01100110
7249	>ba41	66				                .byte %01100110
7250	>ba42	66				                .byte %01100110
7251	>ba43	7e				                .byte %01111110
7252	>ba44	66				                .byte %01100110
7253	>ba45	66				                .byte %01100110
7254	>ba46	66				                .byte %01100110
7255	>ba47	00				                .byte %00000000

7257						                ; CHR$73 - I
7258	>ba48	7e				                .byte %01111110
7259	>ba49	18				                .byte %00011000
7260	>ba4a	18				                .byte %00011000
7261	>ba4b	18				                .byte %00011000
7262	>ba4c	18				                .byte %00011000
7263	>ba4d	18				                .byte %00011000
7264	>ba4e	7e				                .byte %01111110
7265	>ba4f	00				                .byte %00000000

7267						                ; CHR$74 - J
7268	>ba50	3e				                .byte %00111110
7269	>ba51	0c				                .byte %00001100
7270	>ba52	0c				                .byte %00001100
7271	>ba53	0c				                .byte %00001100
7272	>ba54	0c				                .byte %00001100
7273	>ba55	6c				                .byte %01101100
7274	>ba56	38				                .byte %00111000
7275	>ba57	00				                .byte %00000000

7277						                ; CHR$75 - K
7278	>ba58	66				                .byte %01100110
7279	>ba59	6c				                .byte %01101100
7280	>ba5a	78				                .byte %01111000
7281	>ba5b	70				                .byte %01110000
7282	>ba5c	78				                .byte %01111000
7283	>ba5d	6c				                .byte %01101100
7284	>ba5e	66				                .byte %01100110
7285	>ba5f	00				                .byte %00000000

7287						                ; CHR$76 - L
7288	>ba60	60				                .byte %01100000
7289	>ba61	60				                .byte %01100000
7290	>ba62	60				                .byte %01100000
7291	>ba63	60				                .byte %01100000
7292	>ba64	60				                .byte %01100000
7293	>ba65	60				                .byte %01100000
7294	>ba66	7e				                .byte %01111110
7295	>ba67	00				                .byte %00000000

7297						                ; CHR$77 - M
7298	>ba68	63				                .byte %01100011
7299	>ba69	77				                .byte %01110111
7300	>ba6a	7f				                .byte %01111111
7301	>ba6b	6b				                .byte %01101011
7302	>ba6c	6b				                .byte %01101011
7303	>ba6d	63				                .byte %01100011
7304	>ba6e	63				                .byte %01100011
7305	>ba6f	00				                .byte %00000000

7307						                ; CHR$78 - N
7308	>ba70	66				                .byte %01100110
7309	>ba71	66				                .byte %01100110
7310	>ba72	76				                .byte %01110110
7311	>ba73	7e				                .byte %01111110
7312	>ba74	6e				                .byte %01101110
7313	>ba75	66				                .byte %01100110
7314	>ba76	66				                .byte %01100110
7315	>ba77	00				                .byte %00000000

7317						                ; CHR$79 - O
7318	>ba78	3c				                .byte %00111100
7319	>ba79	66				                .byte %01100110
7320	>ba7a	66				                .byte %01100110
7321	>ba7b	66				                .byte %01100110
7322	>ba7c	66				                .byte %01100110
7323	>ba7d	66				                .byte %01100110
7324	>ba7e	3c				                .byte %00111100
7325	>ba7f	00				                .byte %00000000

7327						                ; CHR$80 - P
7328	>ba80	7c				                .byte %01111100
7329	>ba81	66				                .byte %01100110
7330	>ba82	66				                .byte %01100110
7331	>ba83	7c				                .byte %01111100
7332	>ba84	60				                .byte %01100000
7333	>ba85	60				                .byte %01100000
7334	>ba86	60				                .byte %01100000
7335	>ba87	00				                .byte %00000000

7337						                ; CHR$81 - Q
7338	>ba88	3c				                .byte %00111100
7339	>ba89	66				                .byte %01100110
7340	>ba8a	66				                .byte %01100110
7341	>ba8b	66				                .byte %01100110
7342	>ba8c	6a				                .byte %01101010
7343	>ba8d	6c				                .byte %01101100
7344	>ba8e	36				                .byte %00110110
7345	>ba8f	00				                .byte %00000000

7347						                ; CHR$82 - R
7348	>ba90	7c				                .byte %01111100
7349	>ba91	66				                .byte %01100110
7350	>ba92	66				                .byte %01100110
7351	>ba93	7c				                .byte %01111100
7352	>ba94	6c				                .byte %01101100
7353	>ba95	66				                .byte %01100110
7354	>ba96	66				                .byte %01100110
7355	>ba97	00				                .byte %00000000

7357						                ; CHR$83 - S
7358	>ba98	3c				                .byte %00111100
7359	>ba99	66				                .byte %01100110
7360	>ba9a	60				                .byte %01100000
7361	>ba9b	3c				                .byte %00111100
7362	>ba9c	06				                .byte %00000110
7363	>ba9d	66				                .byte %01100110
7364	>ba9e	3c				                .byte %00111100
7365	>ba9f	00				                .byte %00000000

7367						                ; CHR$84 - T
7368	>baa0	7e				                .byte %01111110
7369	>baa1	18				                .byte %00011000
7370	>baa2	18				                .byte %00011000
7371	>baa3	18				                .byte %00011000
7372	>baa4	18				                .byte %00011000
7373	>baa5	18				                .byte %00011000
7374	>baa6	18				                .byte %00011000
7375	>baa7	00				                .byte %00000000

7377						                ; CHR$85 - U
7378	>baa8	66				                .byte %01100110
7379	>baa9	66				                .byte %01100110
7380	>baaa	66				                .byte %01100110
7381	>baab	66				                .byte %01100110
7382	>baac	66				                .byte %01100110
7383	>baad	66				                .byte %01100110
7384	>baae	3c				                .byte %00111100
7385	>baaf	00				                .byte %00000000

7387						                ; CHR$86 - V
7388	>bab0	66				                .byte %01100110
7389	>bab1	66				                .byte %01100110
7390	>bab2	66				                .byte %01100110
7391	>bab3	66				                .byte %01100110
7392	>bab4	66				                .byte %01100110
7393	>bab5	3c				                .byte %00111100
7394	>bab6	18				                .byte %00011000
7395	>bab7	00				                .byte %00000000

7397						                ; CHR$87 - W
7398	>bab8	63				                .byte %01100011
7399	>bab9	63				                .byte %01100011
7400	>baba	6b				                .byte %01101011
7401	>babb	6b				                .byte %01101011
7402	>babc	7f				                .byte %01111111
7403	>babd	77				                .byte %01110111
7404	>babe	63				                .byte %01100011
7405	>babf	00				                .byte %00000000

7407						                ; CHR$88 - X
7408	>bac0	66				                .byte %01100110
7409	>bac1	66				                .byte %01100110
7410	>bac2	3c				                .byte %00111100
7411	>bac3	18				                .byte %00011000
7412	>bac4	3c				                .byte %00111100
7413	>bac5	66				                .byte %01100110
7414	>bac6	66				                .byte %01100110
7415	>bac7	00				                .byte %00000000

7417						                ; CHR$89 - Y
7418	>bac8	66				                .byte %01100110
7419	>bac9	66				                .byte %01100110
7420	>baca	66				                .byte %01100110
7421	>bacb	3c				                .byte %00111100
7422	>bacc	18				                .byte %00011000
7423	>bacd	18				                .byte %00011000
7424	>bace	18				                .byte %00011000
7425	>bacf	00				                .byte %00000000

7427						                ; CHR$90 - Z
7428	>bad0	7e				                .byte %01111110
7429	>bad1	06				                .byte %00000110
7430	>bad2	0c				                .byte %00001100
7431	>bad3	18				                .byte %00011000
7432	>bad4	30				                .byte %00110000
7433	>bad5	60				                .byte %01100000
7434	>bad6	7e				                .byte %01111110
7435	>bad7	00				                .byte %00000000

7437						                ; CHR$91 - [
7438	>bad8	7c				                .byte %01111100
7439	>bad9	60				                .byte %01100000
7440	>bada	60				                .byte %01100000
7441	>badb	60				                .byte %01100000
7442	>badc	60				                .byte %01100000
7443	>badd	60				                .byte %01100000
7444	>bade	7c				                .byte %01111100
7445	>badf	00				                .byte %00000000

7447						                ; CHR$92 - \
7448	>bae0	00				                .byte %00000000
7449	>bae1	60				                .byte %01100000
7450	>bae2	30				                .byte %00110000
7451	>bae3	18				                .byte %00011000
7452	>bae4	0c				                .byte %00001100
7453	>bae5	06				                .byte %00000110
7454	>bae6	00				                .byte %00000000
7455	>bae7	00				                .byte %00000000

7457						                ; CHR$93 - ]
7458	>bae8	3e				                .byte %00111110
7459	>bae9	06				                .byte %00000110
7460	>baea	06				                .byte %00000110
7461	>baeb	06				                .byte %00000110
7462	>baec	06				                .byte %00000110
7463	>baed	06				                .byte %00000110
7464	>baee	3e				                .byte %00111110
7465	>baef	00				                .byte %00000000

7467						                ; CHR$94 - ^
7468	>baf0	18				                .byte %00011000
7469	>baf1	3c				                .byte %00111100
7470	>baf2	66				                .byte %01100110
7471	>baf3	42				                .byte %01000010
7472	>baf4	00				                .byte %00000000
7473	>baf5	00				                .byte %00000000
7474	>baf6	00				                .byte %00000000
7475	>baf7	00				                .byte %00000000

7477						                ; CHR$95 - _
7478	>baf8	00				                .byte %00000000
7479	>baf9	00				                .byte %00000000
7480	>bafa	00				                .byte %00000000
7481	>bafb	00				                .byte %00000000
7482	>bafc	00				                .byte %00000000
7483	>bafd	00				                .byte %00000000
7484	>bafe	00				                .byte %00000000
7485	>baff	ff				                .byte %11111111

7487						                ; CHR$96
7488	>bb00	1c				                .byte %00011100
7489	>bb01	36				                .byte %00110110
7490	>bb02	30				                .byte %00110000
7491	>bb03	7c				                .byte %01111100
7492	>bb04	30				                .byte %00110000
7493	>bb05	30				                .byte %00110000
7494	>bb06	7e				                .byte %01111110
7495	>bb07	00				                .byte %00000000

7497						                ; CHR$97 - a
7498	>bb08	00				                .byte %00000000
7499	>bb09	00				                .byte %00000000
7500	>bb0a	3c				                .byte %00111100
7501	>bb0b	06				                .byte %00000110
7502	>bb0c	3e				                .byte %00111110
7503	>bb0d	66				                .byte %01100110
7504	>bb0e	3e				                .byte %00111110
7505	>bb0f	00				                .byte %00000000

7507						                ; CHR$98 - b
7508	>bb10	60				                .byte %01100000
7509	>bb11	60				                .byte %01100000
7510	>bb12	7c				                .byte %01111100
7511	>bb13	66				                .byte %01100110
7512	>bb14	66				                .byte %01100110
7513	>bb15	66				                .byte %01100110
7514	>bb16	7c				                .byte %01111100
7515	>bb17	00				                .byte %00000000

7517						                ; CHR$99 - c
7518	>bb18	00				                .byte %00000000
7519	>bb19	00				                .byte %00000000
7520	>bb1a	3c				                .byte %00111100
7521	>bb1b	66				                .byte %01100110
7522	>bb1c	60				                .byte %01100000
7523	>bb1d	66				                .byte %01100110
7524	>bb1e	3c				                .byte %00111100
7525	>bb1f	00				                .byte %00000000

7527						                ; CHR$100 - d
7528	>bb20	06				                .byte %00000110
7529	>bb21	06				                .byte %00000110
7530	>bb22	3e				                .byte %00111110
7531	>bb23	66				                .byte %01100110
7532	>bb24	66				                .byte %01100110
7533	>bb25	66				                .byte %01100110
7534	>bb26	3e				                .byte %00111110
7535	>bb27	00				                .byte %00000000

7537						                ; CHR$101 - e
7538	>bb28	00				                .byte %00000000
7539	>bb29	00				                .byte %00000000
7540	>bb2a	3c				                .byte %00111100
7541	>bb2b	66				                .byte %01100110
7542	>bb2c	7e				                .byte %01111110
7543	>bb2d	60				                .byte %01100000
7544	>bb2e	3c				                .byte %00111100
7545	>bb2f	00				                .byte %00000000

7547						                ; CHR$102 - f
7548	>bb30	1c				                .byte %00011100
7549	>bb31	30				                .byte %00110000
7550	>bb32	30				                .byte %00110000
7551	>bb33	7c				                .byte %01111100
7552	>bb34	30				                .byte %00110000
7553	>bb35	30				                .byte %00110000
7554	>bb36	30				                .byte %00110000
7555	>bb37	00				                .byte %00000000

7557						                ; CHR$103 - g
7558	>bb38	00				                .byte %00000000
7559	>bb39	00				                .byte %00000000
7560	>bb3a	3e				                .byte %00111110
7561	>bb3b	66				                .byte %01100110
7562	>bb3c	66				                .byte %01100110
7563	>bb3d	3e				                .byte %00111110
7564	>bb3e	06				                .byte %00000110
7565	>bb3f	3c				                .byte %00111100

7567						                ; CHR$104 - h
7568	>bb40	60				                .byte %01100000
7569	>bb41	60				                .byte %01100000
7570	>bb42	7c				                .byte %01111100
7571	>bb43	66				                .byte %01100110
7572	>bb44	66				                .byte %01100110
7573	>bb45	66				                .byte %01100110
7574	>bb46	66				                .byte %01100110
7575	>bb47	00				                .byte %00000000

7577						                ; CHR$105 - i
7578	>bb48	18				                .byte %00011000
7579	>bb49	00				                .byte %00000000
7580	>bb4a	38				                .byte %00111000
7581	>bb4b	18				                .byte %00011000
7582	>bb4c	18				                .byte %00011000
7583	>bb4d	18				                .byte %00011000
7584	>bb4e	3c				                .byte %00111100
7585	>bb4f	00				                .byte %00000000

7587						                ; CHR$106 - j
7588	>bb50	18				                .byte %00011000
7589	>bb51	00				                .byte %00000000
7590	>bb52	38				                .byte %00111000
7591	>bb53	18				                .byte %00011000
7592	>bb54	18				                .byte %00011000
7593	>bb55	18				                .byte %00011000
7594	>bb56	18				                .byte %00011000
7595	>bb57	70				                .byte %01110000

7597						                ; CHR$107 - k
7598	>bb58	60				                .byte %01100000
7599	>bb59	60				                .byte %01100000
7600	>bb5a	66				                .byte %01100110
7601	>bb5b	6c				                .byte %01101100
7602	>bb5c	78				                .byte %01111000
7603	>bb5d	6c				                .byte %01101100
7604	>bb5e	66				                .byte %01100110
7605	>bb5f	00				                .byte %00000000

7607						                ; CHR$108 - l
7608	>bb60	38				                .byte %00111000
7609	>bb61	18				                .byte %00011000
7610	>bb62	18				                .byte %00011000
7611	>bb63	18				                .byte %00011000
7612	>bb64	18				                .byte %00011000
7613	>bb65	18				                .byte %00011000
7614	>bb66	3c				                .byte %00111100
7615	>bb67	00				                .byte %00000000

7617						                ; CHR$109 - m
7618	>bb68	00				                .byte %00000000
7619	>bb69	00				                .byte %00000000
7620	>bb6a	36				                .byte %00110110
7621	>bb6b	7f				                .byte %01111111
7622	>bb6c	6b				                .byte %01101011
7623	>bb6d	6b				                .byte %01101011
7624	>bb6e	63				                .byte %01100011
7625	>bb6f	00				                .byte %00000000

7627						                ; CHR$110 - n
7628	>bb70	00				                .byte %00000000
7629	>bb71	00				                .byte %00000000
7630	>bb72	7c				                .byte %01111100
7631	>bb73	66				                .byte %01100110
7632	>bb74	66				                .byte %01100110
7633	>bb75	66				                .byte %01100110
7634	>bb76	66				                .byte %01100110
7635	>bb77	00				                .byte %00000000

7637						                ; CHR$111 - o
7638	>bb78	00				                .byte %00000000
7639	>bb79	00				                .byte %00000000
7640	>bb7a	3c				                .byte %00111100
7641	>bb7b	66				                .byte %01100110
7642	>bb7c	66				                .byte %01100110
7643	>bb7d	66				                .byte %01100110
7644	>bb7e	3c				                .byte %00111100
7645	>bb7f	00				                .byte %00000000

7647						                ; CHR$112 - p
7648	>bb80	00				                .byte %00000000
7649	>bb81	00				                .byte %00000000
7650	>bb82	7c				                .byte %01111100
7651	>bb83	66				                .byte %01100110
7652	>bb84	66				                .byte %01100110
7653	>bb85	7c				                .byte %01111100
7654	>bb86	60				                .byte %01100000
7655	>bb87	60				                .byte %01100000

7657						                ; CHR$113 - q
7658	>bb88	00				                .byte %00000000
7659	>bb89	00				                .byte %00000000
7660	>bb8a	3e				                .byte %00111110
7661	>bb8b	66				                .byte %01100110
7662	>bb8c	66				                .byte %01100110
7663	>bb8d	3e				                .byte %00111110
7664	>bb8e	06				                .byte %00000110
7665	>bb8f	07				                .byte %00000111

7667						                ; CHR$114 - r
7668	>bb90	00				                .byte %00000000
7669	>bb91	00				                .byte %00000000
7670	>bb92	6c				                .byte %01101100
7671	>bb93	76				                .byte %01110110
7672	>bb94	60				                .byte %01100000
7673	>bb95	60				                .byte %01100000
7674	>bb96	60				                .byte %01100000
7675	>bb97	00				                .byte %00000000

7677						                ; CHR$115 - s
7678	>bb98	00				                .byte %00000000
7679	>bb99	00				                .byte %00000000
7680	>bb9a	3e				                .byte %00111110
7681	>bb9b	60				                .byte %01100000
7682	>bb9c	3c				                .byte %00111100
7683	>bb9d	06				                .byte %00000110
7684	>bb9e	7c				                .byte %01111100
7685	>bb9f	00				                .byte %00000000

7687						                ; CHR$116 - t
7688	>bba0	30				                .byte %00110000
7689	>bba1	30				                .byte %00110000
7690	>bba2	7c				                .byte %01111100
7691	>bba3	30				                .byte %00110000
7692	>bba4	30				                .byte %00110000
7693	>bba5	30				                .byte %00110000
7694	>bba6	1c				                .byte %00011100
7695	>bba7	00				                .byte %00000000

7697						                ; CHR$117 - u
7698	>bba8	00				                .byte %00000000
7699	>bba9	00				                .byte %00000000
7700	>bbaa	66				                .byte %01100110
7701	>bbab	66				                .byte %01100110
7702	>bbac	66				                .byte %01100110
7703	>bbad	66				                .byte %01100110
7704	>bbae	3e				                .byte %00111110
7705	>bbaf	00				                .byte %00000000

7707						                ; CHR$118 - v
7708	>bbb0	00				                .byte %00000000
7709	>bbb1	00				                .byte %00000000
7710	>bbb2	66				                .byte %01100110
7711	>bbb3	66				                .byte %01100110
7712	>bbb4	66				                .byte %01100110
7713	>bbb5	3c				                .byte %00111100
7714	>bbb6	18				                .byte %00011000
7715	>bbb7	00				                .byte %00000000

7717						                ; CHR$119 - w
7718	>bbb8	00				                .byte %00000000
7719	>bbb9	00				                .byte %00000000
7720	>bbba	63				                .byte %01100011
7721	>bbbb	6b				                .byte %01101011
7722	>bbbc	6b				                .byte %01101011
7723	>bbbd	7f				                .byte %01111111
7724	>bbbe	36				                .byte %00110110
7725	>bbbf	00				                .byte %00000000

7727						                ; CHR$120 - x
7728	>bbc0	00				                .byte %00000000
7729	>bbc1	00				                .byte %00000000
7730	>bbc2	66				                .byte %01100110
7731	>bbc3	3c				                .byte %00111100
7732	>bbc4	18				                .byte %00011000
7733	>bbc5	3c				                .byte %00111100
7734	>bbc6	66				                .byte %01100110
7735	>bbc7	00				                .byte %00000000

7737						                ; CHR$121 - y
7738	>bbc8	00				                .byte %00000000
7739	>bbc9	00				                .byte %00000000
7740	>bbca	66				                .byte %01100110
7741	>bbcb	66				                .byte %01100110
7742	>bbcc	66				                .byte %01100110
7743	>bbcd	3e				                .byte %00111110
7744	>bbce	06				                .byte %00000110
7745	>bbcf	3c				                .byte %00111100

7747						                ; CHR$122 - z
7748	>bbd0	00				                .byte %00000000
7749	>bbd1	00				                .byte %00000000
7750	>bbd2	7e				                .byte %01111110
7751	>bbd3	0c				                .byte %00001100
7752	>bbd4	18				                .byte %00011000
7753	>bbd5	30				                .byte %00110000
7754	>bbd6	7e				                .byte %01111110
7755	>bbd7	00				                .byte %00000000

7757						                ; CHR$123 - {
7758	>bbd8	0c				                .byte %00001100
7759	>bbd9	18				                .byte %00011000
7760	>bbda	18				                .byte %00011000
7761	>bbdb	70				                .byte %01110000
7762	>bbdc	18				                .byte %00011000
7763	>bbdd	18				                .byte %00011000
7764	>bbde	0c				                .byte %00001100
7765	>bbdf	00				                .byte %00000000

7767						                ; CHR$124 - |
7768	>bbe0	18				                .byte %00011000
7769	>bbe1	18				                .byte %00011000
7770	>bbe2	18				                .byte %00011000
7771	>bbe3	00				                .byte %00000000
7772	>bbe4	18				                .byte %00011000
7773	>bbe5	18				                .byte %00011000
7774	>bbe6	18				                .byte %00011000
7775	>bbe7	00				                .byte %00000000

7777						                ; CHR$125 - }
7778	>bbe8	30				                .byte %00110000
7779	>bbe9	18				                .byte %00011000
7780	>bbea	18				                .byte %00011000
7781	>bbeb	0e				                .byte %00001110
7782	>bbec	18				                .byte %00011000
7783	>bbed	18				                .byte %00011000
7784	>bbee	30				                .byte %00110000
7785	>bbef	00				                .byte %00000000

7787						                ; CHR$126 - ~
7788	>bbf0	31				                .byte %00110001
7789	>bbf1	6b				                .byte %01101011
7790	>bbf2	46				                .byte %01000110
7791	>bbf3	00				                .byte %00000000
7792	>bbf4	00				                .byte %00000000
7793	>bbf5	00				                .byte %00000000
7794	>bbf6	00				                .byte %00000000
7795	>bbf7	00				                .byte %00000000

7797						                ; CHR$127
7798	.bbf8					chr127:
7799	>bbf8	ff				                .byte %11111111
7800	>bbf9	ff				                .byte %11111111
7801	>bbfa	ff				                .byte %11111111
7802	>bbfb	ff				                .byte %11111111
7803	>bbfc	ff				                .byte %11111111
7804	>bbfd	ff				                .byte %11111111
7805	>bbfe	ff				                .byte %11111111
7806	>bbff	ff				                .byte %11111111

7808						                ; CHR$128
7809						                .if version==350
7818						                .else
7819	>bc00	66				                .byte %01100110
7820	>bc01	00				                .byte %00000000
7821	>bc02	3c				                .byte %00111100
7822	>bc03	66				                .byte %01100110
7823	>bc04	7e				                .byte %01111110
7824	>bc05	66				                .byte %01100110
7825	>bc06	66				                .byte %01100110
7826	>bc07	00				                .byte %00000000
7827						                .endif

7829						                ; CHR$129
7830						                .if version==350
7839						                .else
7840	>bc08	3c				                .byte %00111100
7841	>bc09	66				                .byte %01100110
7842	>bc0a	3c				                .byte %00111100
7843	>bc0b	66				                .byte %01100110
7844	>bc0c	7e				                .byte %01111110
7845	>bc0d	66				                .byte %01100110
7846	>bc0e	66				                .byte %01100110
7847	>bc0f	00				                .byte %00000000
7848						                .endif

7850						                ; CHR$130
7851	>bc10	3f				                .byte %00111111
7852	>bc11	66				                .byte %01100110
7853	>bc12	66				                .byte %01100110
7854	>bc13	7f				                .byte %01111111
7855	>bc14	66				                .byte %01100110
7856	>bc15	66				                .byte %01100110
7857	>bc16	67				                .byte %01100111
7858	>bc17	00				                .byte %00000000

7860						                ; CHR$131
7861						                .if version==350
7870						                .else
7871	>bc18	3c				                .byte %00111100
7872	>bc19	66				                .byte %01100110
7873	>bc1a	60				                .byte %01100000
7874	>bc1b	60				                .byte %01100000
7875	>bc1c	60				                .byte %01100000
7876	>bc1d	66				                .byte %01100110
7877	>bc1e	3c				                .byte %00111100
7878	>bc1f	60				                .byte %01100000
7879						                .endif

7881						                ; CHR$132
7882	>bc20	0c				                .byte %00001100
7883	>bc21	18				                .byte %00011000
7884	>bc22	7e				                .byte %01111110
7885	>bc23	60				                .byte %01100000
7886	>bc24	7c				                .byte %01111100
7887	>bc25	60				                .byte %01100000
7888	>bc26	7e				                .byte %01111110
7889	>bc27	00				                .byte %00000000

7891						                ; CHR$133
7892						                .if version==350
7901						                .else
7902	>bc28	66				                .byte %01100110
7903	>bc29	3c				                .byte %00111100
7904	>bc2a	66				                .byte %01100110
7905	>bc2b	66				                .byte %01100110
7906	>bc2c	66				                .byte %01100110
7907	>bc2d	66				                .byte %01100110
7908	>bc2e	3c				                .byte %00111100
7909	>bc2f	00				                .byte %00000000
7910						                .endif

7912						                ; CHR$134
7913	>bc30	66				                .byte %01100110
7914	>bc31	00				                .byte %00000000
7915	>bc32	66				                .byte %01100110
7916	>bc33	66				                .byte %01100110
7917	>bc34	66				                .byte %01100110
7918	>bc35	66				                .byte %01100110
7919	>bc36	3c				                .byte %00111100
7920	>bc37	00				                .byte %00000000

7922						                ; CHR$135
7923						                .if version==350
7932						                .else
7933	>bc38	7e				                .byte %01111110
7934	>bc39	c3				                .byte %11000011
7935	>bc3a	9d				                .byte %10011101
7936	>bc3b	b1				                .byte %10110001
7937	>bc3c	9d				                .byte %10011101
7938	>bc3d	c3				                .byte %11000011
7939	>bc3e	7e				                .byte %01111110
7940	>bc3f	00				                .byte %00000000
7941						                .endif

7943						                ; CHR$136
7944	>bc40	00				                .byte %00000000
7945	>bc41	18				                .byte %00011000
7946	>bc42	38				                .byte %00111000
7947	>bc43	7f				                .byte %01111111
7948	>bc44	38				                .byte %00111000
7949	>bc45	18				                .byte %00011000
7950	>bc46	00				                .byte %00000000
7951	>bc47	00				                .byte %00000000

7953						                ; CHR$137
7954	>bc48	00				                .byte %00000000
7955	>bc49	18				                .byte %00011000
7956	>bc4a	1c				                .byte %00011100
7957	>bc4b	fe				                .byte %11111110
7958	>bc4c	1c				                .byte %00011100
7959	>bc4d	18				                .byte %00011000
7960	>bc4e	00				                .byte %00000000
7961	>bc4f	00				                .byte %00000000

7963						                ; CHR$138
7964	>bc50	18				                .byte %00011000
7965	>bc51	18				                .byte %00011000
7966	>bc52	18				                .byte %00011000
7967	>bc53	18				                .byte %00011000
7968	>bc54	7e				                .byte %01111110
7969	>bc55	3c				                .byte %00111100
7970	>bc56	18				                .byte %00011000
7971	>bc57	00				                .byte %00000000

7973						                ; CHR$139
7974	>bc58	00				                .byte %00000000
7975	>bc59	18				                .byte %00011000
7976	>bc5a	3c				                .byte %00111100
7977	>bc5b	7e				                .byte %01111110
7978	>bc5c	18				                .byte %00011000
7979	>bc5d	18				                .byte %00011000
7980	>bc5e	18				                .byte %00011000
7981	>bc5f	18				                .byte %00011000

7983						                ; CHR$140
7984	>bc60	30				                .byte %00110000
7985	>bc61	18				                .byte %00011000
7986	>bc62	3c				                .byte %00111100
7987	>bc63	06				                .byte %00000110
7988	>bc64	3e				                .byte %00111110
7989	>bc65	66				                .byte %01100110
7990	>bc66	3e				                .byte %00111110
7991	>bc67	00				                .byte %00000000

7993						                ; CHR$141
7994	>bc68	30				                .byte %00110000
7995	>bc69	18				                .byte %00011000
7996	>bc6a	3c				                .byte %00111100
7997	>bc6b	66				                .byte %01100110
7998	>bc6c	7e				                .byte %01111110
7999	>bc6d	60				                .byte %01100000
8000	>bc6e	3c				                .byte %00111100
8001	>bc6f	00				                .byte %00000000

8003						                ; CHR$142
8004	>bc70	66				                .byte %01100110
8005	>bc71	00				                .byte %00000000
8006	>bc72	3c				                .byte %00111100
8007	>bc73	66				                .byte %01100110
8008	>bc74	7e				                .byte %01111110
8009	>bc75	60				                .byte %01100000
8010	>bc76	3c				                .byte %00111100
8011	>bc77	00				                .byte %00000000

8013						                ; CHR$143
8014	>bc78	3c				                .byte %00111100
8015	>bc79	66				                .byte %01100110
8016	>bc7a	3c				                .byte %00111100
8017	>bc7b	66				                .byte %01100110
8018	>bc7c	7e				                .byte %01111110
8019	>bc7d	60				                .byte %01100000
8020	>bc7e	3c				                .byte %00111100
8021	>bc7f	00				                .byte %00000000

8023						                ; CHR$144
8024	>bc80	66				                .byte %01100110
8025	>bc81	00				                .byte %00000000
8026	>bc82	3c				                .byte %00111100
8027	>bc83	06				                .byte %00000110
8028	>bc84	3e				                .byte %00111110
8029	>bc85	66				                .byte %01100110
8030	>bc86	3e				                .byte %00111110
8031	>bc87	00				                .byte %00000000

8033						                ; CHR$145
8034	>bc88	3c				                .byte %00111100
8035	>bc89	66				                .byte %01100110
8036	>bc8a	3c				                .byte %00111100
8037	>bc8b	06				                .byte %00000110
8038	>bc8c	3e				                .byte %00111110
8039	>bc8d	66				                .byte %01100110
8040	>bc8e	3e				                .byte %00111110
8041	>bc8f	00				                .byte %00000000

8043						                ; CHR$146
8044	>bc90	00				                .byte %00000000
8045	>bc91	00				                .byte %00000000
8046	>bc92	3f				                .byte %00111111
8047	>bc93	0d				                .byte %00001101
8048	>bc94	3f				                .byte %00111111
8049	>bc95	6c				                .byte %01101100
8050	>bc96	3f				                .byte %00111111
8051	>bc97	00				                .byte %00000000

8053						                ; CHR$147
8054	>bc98	00				                .byte %00000000
8055	>bc99	00				                .byte %00000000
8056	>bc9a	3c				                .byte %00111100
8057	>bc9b	66				                .byte %01100110
8058	>bc9c	60				                .byte %01100000
8059	>bc9d	66				                .byte %01100110
8060	>bc9e	3c				                .byte %00111100
8061	>bc9f	60				                .byte %01100000

8063						                ; CHR$148
8064	>bca0	0c				                .byte %00001100
8065	>bca1	18				                .byte %00011000
8066	>bca2	3c				                .byte %00111100
8067	>bca3	66				                .byte %01100110
8068	>bca4	7e				                .byte %01111110
8069	>bca5	60				                .byte %01100000
8070	>bca6	3c				                .byte %00111100
8071	>bca7	00				                .byte %00000000

8073						                ; CHR$149
8074						                .if version==350
8083						                .else
8084	>bca8	66				                .byte %01100110
8085	>bca9	00				                .byte %00000000
8086	>bcaa	3c				                .byte %00111100
8087	>bcab	66				                .byte %01100110
8088	>bcac	66				                .byte %01100110
8089	>bcad	66				                .byte %01100110
8090	>bcae	3c				                .byte %00111100
8091	>bcaf	00				                .byte %00000000
8092						                .endif

8094						                ; CHR$150
8095						                .if version==350
8104						                .else
8105	>bcb0	66				                .byte %01100110
8106	>bcb1	00				                .byte %00000000
8107	>bcb2	66				                .byte %01100110
8108	>bcb3	66				                .byte %01100110
8109	>bcb4	66				                .byte %01100110
8110	>bcb5	66				                .byte %01100110
8111	>bcb6	3e				                .byte %00111110
8112	>bcb7	00				                .byte %00000000
8113						                .endif

8115						                ; CHR$151
8116	>bcb8	30				                .byte %00110000
8117	>bcb9	18				                .byte %00011000
8118	>bcba	00				                .byte %00000000
8119	>bcbb	38				                .byte %00111000
8120	>bcbc	18				                .byte %00011000
8121	>bcbd	18				                .byte %00011000
8122	>bcbe	3c				                .byte %00111100
8123	>bcbf	00				                .byte %00000000

8125						                ; CHR$152
8126	>bcc0	3c				                .byte %00111100
8127	>bcc1	66				                .byte %01100110
8128	>bcc2	00				                .byte %00000000
8129	>bcc3	38				                .byte %00111000
8130	>bcc4	18				                .byte %00011000
8131	>bcc5	18				                .byte %00011000
8132	>bcc6	3c				                .byte %00111100
8133	>bcc7	00				                .byte %00000000

8135						                ; CHR$153
8136	>bcc8	30				                .byte %00110000
8137	>bcc9	18				                .byte %00011000
8138	>bcca	00				                .byte %00000000
8139	>bccb	3c				                .byte %00111100
8140	>bccc	66				                .byte %01100110
8141	>bccd	66				                .byte %01100110
8142	>bcce	3c				                .byte %00111100
8143	>bccf	00				                .byte %00000000

8145						                ; CHR$154
8146	>bcd0	3c				                .byte %00111100
8147	>bcd1	66				                .byte %01100110
8148	>bcd2	00				                .byte %00000000
8149	>bcd3	3c				                .byte %00111100
8150	>bcd4	66				                .byte %01100110
8151	>bcd5	66				                .byte %01100110
8152	>bcd6	3c				                .byte %00111100
8153	>bcd7	00				                .byte %00000000

8155						                ; CHR$155
8156	>bcd8	30				                .byte %00110000
8157	>bcd9	18				                .byte %00011000
8158	>bcda	00				                .byte %00000000
8159	>bcdb	66				                .byte %01100110
8160	>bcdc	66				                .byte %01100110
8161	>bcdd	66				                .byte %01100110
8162	>bcde	3e				                .byte %00111110
8163	>bcdf	00				                .byte %00000000

8165						                ; CHR$156
8166	>bce0	3c				                .byte %00111100
8167	>bce1	66				                .byte %01100110
8168	>bce2	00				                .byte %00000000
8169	>bce3	66				                .byte %01100110
8170	>bce4	66				                .byte %01100110
8171	>bce5	66				                .byte %01100110
8172	>bce6	3e				                .byte %00111110
8173	>bce7	00				                .byte %00000000

8175						                ; CHR$157
8176	>bce8	66				                .byte %01100110
8177	>bce9	00				                .byte %00000000
8178	>bcea	66				                .byte %01100110
8179	>bceb	66				                .byte %01100110
8180	>bcec	66				                .byte %01100110
8181	>bced	3e				                .byte %00111110
8182	>bcee	06				                .byte %00000110
8183	>bcef	3c				                .byte %00111100

8185						                ; CHR$158
8186	>bcf0	00				                .byte %00000000
8187	>bcf1	66				                .byte %01100110
8188	>bcf2	3c				                .byte %00111100
8189	>bcf3	66				                .byte %01100110
8190	>bcf4	66				                .byte %01100110
8191	>bcf5	3c				                .byte %00111100
8192	>bcf6	66				                .byte %01100110
8193	>bcf7	00				                .byte %00000000

8195						                ; CHR$159
8196	>bcf8	3c				                .byte %00111100
8197	>bcf9	60				                .byte %01100000
8198	>bcfa	3c				                .byte %00111100
8199	>bcfb	66				                .byte %01100110
8200	>bcfc	3c				                .byte %00111100
8201	>bcfd	06				                .byte %00000110
8202	>bcfe	3c				                .byte %00111100
8203	>bcff	00				                .byte %00000000

8205						                ; CHR$160
8206	>bd00	3c				                .byte %00111100
8207	>bd01	66				                .byte %01100110
8208	>bd02	3c				                .byte %00111100
8209	>bd03	00				                .byte %00000000
8210	>bd04	00				                .byte %00000000
8211	>bd05	00				                .byte %00000000
8212	>bd06	00				                .byte %00000000
8213	>bd07	00				                .byte %00000000

8215						                ; CHR$161
8216	>bd08	00				                .byte %00000000
8217	>bd09	00				                .byte %00000000
8218	>bd0a	00				                .byte %00000000
8219	>bd0b	18				                .byte %00011000
8220	>bd0c	18				                .byte %00011000
8221	>bd0d	18				                .byte %00011000
8222	>bd0e	18				                .byte %00011000
8223	>bd0f	18				                .byte %00011000

8225						                ; CHR$162
8226	>bd10	00				                .byte %00000000
8227	>bd11	00				                .byte %00000000
8228	>bd12	00				                .byte %00000000
8229	>bd13	1f				                .byte %00011111
8230	>bd14	00				                .byte %00000000
8231	>bd15	00				                .byte %00000000
8232	>bd16	00				                .byte %00000000
8233	>bd17	00				                .byte %00000000

8235						                ; CHR$163
8236	>bd18	00				                .byte %00000000
8237	>bd19	00				                .byte %00000000
8238	>bd1a	00				                .byte %00000000
8239	>bd1b	1f				                .byte %00011111
8240	>bd1c	18				                .byte %00011000
8241	>bd1d	18				                .byte %00011000
8242	>bd1e	18				                .byte %00011000
8243	>bd1f	18				                .byte %00011000

8245						                ; CHR$164
8246	>bd20	00				                .byte %00000000
8247	>bd21	00				                .byte %00000000
8248	>bd22	00				                .byte %00000000
8249	>bd23	f8				                .byte %11111000
8250	>bd24	00				                .byte %00000000
8251	>bd25	00				                .byte %00000000
8252	>bd26	00				                .byte %00000000
8253	>bd27	00				                .byte %00000000

8255						                ; CHR$165
8256	>bd28	00				                .byte %00000000
8257	>bd29	00				                .byte %00000000
8258	>bd2a	00				                .byte %00000000
8259	>bd2b	f8				                .byte %11111000
8260	>bd2c	18				                .byte %00011000
8261	>bd2d	18				                .byte %00011000
8262	>bd2e	18				                .byte %00011000
8263	>bd2f	18				                .byte %00011000

8265						                ; CHR$166
8266	>bd30	00				                .byte %00000000
8267	>bd31	00				                .byte %00000000
8268	>bd32	00				                .byte %00000000
8269	>bd33	ff				                .byte %11111111
8270	>bd34	00				                .byte %00000000
8271	>bd35	00				                .byte %00000000
8272	>bd36	00				                .byte %00000000
8273	>bd37	00				                .byte %00000000

8275						                ; CHR$167
8276	>bd38	00				                .byte %00000000
8277	>bd39	00				                .byte %00000000
8278	>bd3a	00				                .byte %00000000
8279	>bd3b	ff				                .byte %11111111
8280	>bd3c	18				                .byte %00011000
8281	>bd3d	18				                .byte %00011000
8282	>bd3e	18				                .byte %00011000
8283	>bd3f	18				                .byte %00011000

8285						                ; CHR$168
8286	>bd40	18				                .byte %00011000
8287	>bd41	18				                .byte %00011000
8288	>bd42	18				                .byte %00011000
8289	>bd43	18				                .byte %00011000
8290	>bd44	00				                .byte %00000000
8291	>bd45	00				                .byte %00000000
8292	>bd46	00				                .byte %00000000
8293	>bd47	00				                .byte %00000000

8295						                ; CHR$169
8296	>bd48	18				                .byte %00011000
8297	>bd49	18				                .byte %00011000
8298	>bd4a	18				                .byte %00011000
8299	>bd4b	18				                .byte %00011000
8300	>bd4c	18				                .byte %00011000
8301	>bd4d	18				                .byte %00011000
8302	>bd4e	18				                .byte %00011000
8303	>bd4f	18				                .byte %00011000

8305						                ; CHR$170
8306	>bd50	18				                .byte %00011000
8307	>bd51	18				                .byte %00011000
8308	>bd52	18				                .byte %00011000
8309	>bd53	1f				                .byte %00011111
8310	>bd54	00				                .byte %00000000
8311	>bd55	00				                .byte %00000000
8312	>bd56	00				                .byte %00000000
8313	>bd57	00				                .byte %00000000

8315						                ; CHR$171
8316	>bd58	18				                .byte %00011000
8317	>bd59	18				                .byte %00011000
8318	>bd5a	18				                .byte %00011000
8319	>bd5b	1f				                .byte %00011111
8320	>bd5c	18				                .byte %00011000
8321	>bd5d	18				                .byte %00011000
8322	>bd5e	18				                .byte %00011000
8323	>bd5f	18				                .byte %00011000

8325						                ; CHR$172
8326	>bd60	18				                .byte %00011000
8327	>bd61	18				                .byte %00011000
8328	>bd62	18				                .byte %00011000
8329	>bd63	f8				                .byte %11111000
8330	>bd64	00				                .byte %00000000
8331	>bd65	00				                .byte %00000000
8332	>bd66	00				                .byte %00000000
8333	>bd67	00				                .byte %00000000

8335						                ; CHR$173
8336	>bd68	18				                .byte %00011000
8337	>bd69	18				                .byte %00011000
8338	>bd6a	18				                .byte %00011000
8339	>bd6b	f8				                .byte %11111000
8340	>bd6c	18				                .byte %00011000
8341	>bd6d	18				                .byte %00011000
8342	>bd6e	18				                .byte %00011000
8343	>bd6f	18				                .byte %00011000

8345						                ; CHR$174
8346	>bd70	18				                .byte %00011000
8347	>bd71	18				                .byte %00011000
8348	>bd72	18				                .byte %00011000
8349	>bd73	ff				                .byte %11111111
8350	>bd74	00				                .byte %00000000
8351	>bd75	00				                .byte %00000000
8352	>bd76	00				                .byte %00000000
8353	>bd77	00				                .byte %00000000

8355						                ; CHR$175
8356	>bd78	18				                .byte %00011000
8357	>bd79	18				                .byte %00011000
8358	>bd7a	18				                .byte %00011000
8359	>bd7b	ff				                .byte %11111111
8360	>bd7c	18				                .byte %00011000
8361	>bd7d	18				                .byte %00011000
8362	>bd7e	18				                .byte %00011000
8363	>bd7f	18				                .byte %00011000

8365						                ; CHR$176
8366	>bd80	00				                .byte %00000000
8367	>bd81	00				                .byte %00000000
8368	>bd82	00				                .byte %00000000
8369	>bd83	07				                .byte %00000111
8370	>bd84	0c				                .byte %00001100
8371	>bd85	18				                .byte %00011000
8372	>bd86	18				                .byte %00011000
8373	>bd87	18				                .byte %00011000

8375						                ; CHR$177
8376	>bd88	00				                .byte %00000000
8377	>bd89	00				                .byte %00000000
8378	>bd8a	00				                .byte %00000000
8379	>bd8b	e0				                .byte %11100000
8380	>bd8c	30				                .byte %00110000
8381	>bd8d	18				                .byte %00011000
8382	>bd8e	18				                .byte %00011000
8383	>bd8f	18				                .byte %00011000

8385						                ; CHR$178
8386	>bd90	18				                .byte %00011000
8387	>bd91	18				                .byte %00011000
8388	>bd92	0c				                .byte %00001100
8389	>bd93	07				                .byte %00000111
8390	>bd94	00				                .byte %00000000
8391	>bd95	00				                .byte %00000000
8392	>bd96	00				                .byte %00000000
8393	>bd97	00				                .byte %00000000

8395						                ; CHR$179
8396	>bd98	18				                .byte %00011000
8397	>bd99	18				                .byte %00011000
8398	>bd9a	30				                .byte %00110000
8399	>bd9b	e0				                .byte %11100000
8400	>bd9c	00				                .byte %00000000
8401	>bd9d	00				                .byte %00000000
8402	>bd9e	00				                .byte %00000000
8403	>bd9f	00				                .byte %00000000

8405						                ; CHR$180
8406	>bda0	18				                .byte %00011000
8407	>bda1	00				                .byte %00000000
8408	>bda2	18				                .byte %00011000
8409	>bda3	18				                .byte %00011000
8410	>bda4	30				                .byte %00110000
8411	>bda5	66				                .byte %01100110
8412	>bda6	3c				                .byte %00111100
8413	>bda7	00				                .byte %00000000

8415						                ; CHR$181
8416	>bda8	18				                .byte %00011000
8417	>bda9	00				                .byte %00000000
8418	>bdaa	18				                .byte %00011000
8419	>bdab	18				                .byte %00011000
8420	>bdac	18				                .byte %00011000
8421	>bdad	18				                .byte %00011000
8422	>bdae	18				                .byte %00011000
8423	>bdaf	00				                .byte %00000000

8425						                ; CHR$182
8426	>bdb0	36				                .byte %00110110
8427	>bdb1	6c				                .byte %01101100
8428	>bdb2	00				                .byte %00000000
8429	>bdb3	66				                .byte %01100110
8430	>bdb4	76				                .byte %01110110
8431	>bdb5	6e				                .byte %01101110
8432	>bdb6	66				                .byte %01100110
8433	>bdb7	00				                .byte %00000000

8435						                ; CHR$183
8436	>bdb8	36				                .byte %00110110
8437	>bdb9	6c				                .byte %01101100
8438	>bdba	00				                .byte %00000000
8439	>bdbb	7c				                .byte %01111100
8440	>bdbc	66				                .byte %01100110
8441	>bdbd	66				                .byte %01100110
8442	>bdbe	66				                .byte %01100110
8443	>bdbf	00				                .byte %00000000

8445						                ; CHR$184
8446	>bdc0	18				                .byte %00011000
8447	>bdc1	7e				                .byte %01111110
8448	>bdc2	18				                .byte %00011000
8449	>bdc3	18				                .byte %00011000
8450	>bdc4	18				                .byte %00011000
8451	>bdc5	18				                .byte %00011000
8452	>bdc6	18				                .byte %00011000
8453	>bdc7	00				                .byte %00000000

8455						                ; CHR$185
8456	>bdc8	18				                .byte %00011000
8457	>bdc9	7e				                .byte %01111110
8458	>bdca	18				                .byte %00011000
8459	>bdcb	18				                .byte %00011000
8460	>bdcc	18				                .byte %00011000
8461	>bdcd	7e				                .byte %01111110
8462	>bdce	18				                .byte %00011000
8463	>bdcf	00				                .byte %00000000

8465						                ; CHR$186
8466						                .if version==350
8475						                .else
8476	>bdd0	18				                .byte %00011000
8477	>bdd1	18				                .byte %00011000
8478	>bdd2	18				                .byte %00011000
8479	>bdd3	00				                .byte %00000000
8480	>bdd4	00				                .byte %00000000
8481	>bdd5	00				                .byte %00000000
8482	>bdd6	00				                .byte %00000000
8483	>bdd7	00				                .byte %00000000
8484						                .endif

8486						                ; CHR$187
8487						                .if version==350
8496						                .else
8497	>bdd8	30				                .byte %00110000
8498	>bdd9	18				                .byte %00011000
8499	>bdda	0c				                .byte %00001100
8500	>bddb	00				                .byte %00000000
8501	>bddc	00				                .byte %00000000
8502	>bddd	00				                .byte %00000000
8503	>bdde	00				                .byte %00000000
8504	>bddf	00				                .byte %00000000
8505						                .endif

8507						                ; CHR$188
8508						                .if version==350
8517						                .else
8518	>bde0	3f				                .byte %00111111
8519	>bde1	7b				                .byte %01111011
8520	>bde2	7b				                .byte %01111011
8521	>bde3	3b				                .byte %00111011
8522	>bde4	1b				                .byte %00011011
8523	>bde5	1b				                .byte %00011011
8524	>bde6	1f				                .byte %00011111
8525	>bde7	00				                .byte %00000000
8526						                .endif

8528						                ; CHR$189
8529	>bde8	00				                .byte %00000000
8530	>bde9	00				                .byte %00000000
8531	>bdea	00				                .byte %00000000
8532	>bdeb	18				                .byte %00011000
8533	>bdec	18				                .byte %00011000
8534	>bded	00				                .byte %00000000
8535	>bdee	00				                .byte %00000000
8536	>bdef	00				                .byte %00000000

8538						                ; CHR$190
8539	>bdf0	03				                .byte %00000011
8540	>bdf1	03				                .byte %00000011
8541	>bdf2	06				                .byte %00000110
8542	>bdf3	06				                .byte %00000110
8543	>bdf4	76				                .byte %01110110
8544	>bdf5	1c				                .byte %00011100
8545	>bdf6	0c				                .byte %00001100
8546	>bdf7	00				                .byte %00000000

8548						                ; CHR$191
8549	>bdf8	aa				                .byte %10101010
8550	>bdf9	55				                .byte %01010101
8551	>bdfa	aa				                .byte %10101010
8552	>bdfb	55				                .byte %01010101
8553	>bdfc	aa				                .byte %10101010
8554	>bdfd	55				                .byte %01010101
8555	>bdfe	aa				                .byte %10101010
8556	>bdff	55				                .byte %01010101

8558						                ; CHR$192
8559	>be00	3e				                .byte %00111110
8560	>be01	63				                .byte %01100011
8561	>be02	67				                .byte %01100111
8562	>be03	6b				                .byte %01101011
8563	>be04	73				                .byte %01110011
8564	>be05	63				                .byte %01100011
8565	>be06	3e				                .byte %00111110
8566	>be07	00				                .byte %00000000

8568						                ; CHR$193
8569	>be08	1c				                .byte %00011100
8570	>be09	36				                .byte %00110110
8571	>be0a	63				                .byte %01100011
8572	>be0b	63				                .byte %01100011
8573	>be0c	7f				                .byte %01111111
8574	>be0d	63				                .byte %01100011
8575	>be0e	63				                .byte %01100011
8576	>be0f	00				                .byte %00000000

8578						                ; CHR$194
8579	>be10	7e				                .byte %01111110
8580	>be11	33				                .byte %00110011
8581	>be12	33				                .byte %00110011
8582	>be13	3e				                .byte %00111110
8583	>be14	33				                .byte %00110011
8584	>be15	33				                .byte %00110011
8585	>be16	7e				                .byte %01111110
8586	>be17	00				                .byte %00000000

8588						                ; CHR$195
8589	>be18	7f				                .byte %01111111
8590	>be19	63				                .byte %01100011
8591	>be1a	60				                .byte %01100000
8592	>be1b	60				                .byte %01100000
8593	>be1c	60				                .byte %01100000
8594	>be1d	60				                .byte %01100000
8595	>be1e	60				                .byte %01100000
8596	>be1f	00				                .byte %00000000

8598						                ; CHR$196
8599	>be20	1c				                .byte %00011100
8600	>be21	1c				                .byte %00011100
8601	>be22	36				                .byte %00110110
8602	>be23	36				                .byte %00110110
8603	>be24	63				                .byte %01100011
8604	>be25	63				                .byte %01100011
8605	>be26	7f				                .byte %01111111
8606	>be27	00				                .byte %00000000

8608						                ; CHR$197
8609	>be28	7f				                .byte %01111111
8610	>be29	33				                .byte %00110011
8611	>be2a	30				                .byte %00110000
8612	>be2b	3e				                .byte %00111110
8613	>be2c	30				                .byte %00110000
8614	>be2d	33				                .byte %00110011
8615	>be2e	7f				                .byte %01111111
8616	>be2f	00				                .byte %00000000

8618						                ; CHR$198
8619	>be30	7e				                .byte %01111110
8620	>be31	66				                .byte %01100110
8621	>be32	0c				                .byte %00001100
8622	>be33	18				                .byte %00011000
8623	>be34	30				                .byte %00110000
8624	>be35	66				                .byte %01100110
8625	>be36	7e				                .byte %01111110
8626	>be37	00				                .byte %00000000

8628						                ; CHR$199
8629	>be38	77				                .byte %01110111
8630	>be39	33				                .byte %00110011
8631	>be3a	33				                .byte %00110011
8632	>be3b	3f				                .byte %00111111
8633	>be3c	33				                .byte %00110011
8634	>be3d	33				                .byte %00110011
8635	>be3e	77				                .byte %01110111
8636	>be3f	00				                .byte %00000000

8638						                ; CHR$200
8639	>be40	3e				                .byte %00111110
8640	>be41	63				                .byte %01100011
8641	>be42	63				                .byte %01100011
8642	>be43	7f				                .byte %01111111
8643	>be44	63				                .byte %01100011
8644	>be45	63				                .byte %01100011
8645	>be46	3e				                .byte %00111110
8646	>be47	00				                .byte %00000000

8648						                ; CHR$201
8649	>be48	3c				                .byte %00111100
8650	>be49	18				                .byte %00011000
8651	>be4a	18				                .byte %00011000
8652	>be4b	18				                .byte %00011000
8653	>be4c	18				                .byte %00011000
8654	>be4d	18				                .byte %00011000
8655	>be4e	3c				                .byte %00111100
8656	>be4f	00				                .byte %00000000

8658						                ; CHR$202
8659	>be50	63				                .byte %01100011
8660	>be51	66				                .byte %01100110
8661	>be52	6c				                .byte %01101100
8662	>be53	78				                .byte %01111000
8663	>be54	6c				                .byte %01101100
8664	>be55	66				                .byte %01100110
8665	>be56	63				                .byte %01100011
8666	>be57	00				                .byte %00000000

8668						                ; CHR$203
8669	>be58	1c				                .byte %00011100
8670	>be59	1c				                .byte %00011100
8671	>be5a	36				                .byte %00110110
8672	>be5b	36				                .byte %00110110
8673	>be5c	63				                .byte %01100011
8674	>be5d	63				                .byte %01100011
8675	>be5e	63				                .byte %01100011
8676	>be5f	00				                .byte %00000000

8678						                ; CHR$204
8679	>be60	63				                .byte %01100011
8680	>be61	77				                .byte %01110111
8681	>be62	7f				                .byte %01111111
8682	>be63	6b				                .byte %01101011
8683	>be64	63				                .byte %01100011
8684	>be65	63				                .byte %01100011
8685	>be66	63				                .byte %01100011
8686	>be67	00				                .byte %00000000

8688						                ; CHR$205
8689	>be68	63				                .byte %01100011
8690	>be69	73				                .byte %01110011
8691	>be6a	7b				                .byte %01111011
8692	>be6b	6f				                .byte %01101111
8693	>be6c	67				                .byte %01100111
8694	>be6d	63				                .byte %01100011
8695	>be6e	63				                .byte %01100011
8696	>be6f	00				                .byte %00000000

8698						                ; CHR$206
8699	>be70	7e				                .byte %01111110
8700	>be71	00				                .byte %00000000
8701	>be72	00				                .byte %00000000
8702	>be73	3c				                .byte %00111100
8703	>be74	00				                .byte %00000000
8704	>be75	00				                .byte %00000000
8705	>be76	7e				                .byte %01111110
8706	>be77	00				                .byte %00000000

8708						                ; CHR$207
8709	>be78	3e				                .byte %00111110
8710	>be79	63				                .byte %01100011
8711	>be7a	63				                .byte %01100011
8712	>be7b	63				                .byte %01100011
8713	>be7c	63				                .byte %01100011
8714	>be7d	63				                .byte %01100011
8715	>be7e	3e				                .byte %00111110
8716	>be7f	00				                .byte %00000000

8718						                ; CHR$208
8719	>be80	7f				                .byte %01111111
8720	>be81	36				                .byte %00110110
8721	>be82	36				                .byte %00110110
8722	>be83	36				                .byte %00110110
8723	>be84	36				                .byte %00110110
8724	>be85	36				                .byte %00110110
8725	>be86	36				                .byte %00110110
8726	>be87	00				                .byte %00000000

8728						                ; CHR$209
8729	>be88	7e				                .byte %01111110
8730	>be89	33				                .byte %00110011
8731	>be8a	33				                .byte %00110011
8732	>be8b	3e				                .byte %00111110
8733	>be8c	30				                .byte %00110000
8734	>be8d	30				                .byte %00110000
8735	>be8e	78				                .byte %01111000
8736	>be8f	00				                .byte %00000000

8738						                ; CHR$210
8739	>be90	7f				                .byte %01111111
8740	>be91	63				                .byte %01100011
8741	>be92	30				                .byte %00110000
8742	>be93	18				                .byte %00011000
8743	>be94	30				                .byte %00110000
8744	>be95	63				                .byte %01100011
8745	>be96	7f				                .byte %01111111
8746	>be97	00				                .byte %00000000

8748						                ; CHR$211
8749	>be98	7e				                .byte %01111110
8750	>be99	5a				                .byte %01011010
8751	>be9a	18				                .byte %00011000
8752	>be9b	18				                .byte %00011000
8753	>be9c	18				                .byte %00011000
8754	>be9d	18				                .byte %00011000
8755	>be9e	18				                .byte %00011000
8756	>be9f	00				                .byte %00000000

8758						                ; CHR$212
8759	>bea0	66				                .byte %01100110
8760	>bea1	66				                .byte %01100110
8761	>bea2	66				                .byte %01100110
8762	>bea3	3c				                .byte %00111100
8763	>bea4	18				                .byte %00011000
8764	>bea5	18				                .byte %00011000
8765	>bea6	3c				                .byte %00111100
8766	>bea7	00				                .byte %00000000

8768						                ; CHR$213
8769	>bea8	3e				                .byte %00111110
8770	>bea9	08				                .byte %00001000
8771	>beaa	3e				                .byte %00111110
8772	>beab	6b				                .byte %01101011
8773	>beac	3e				                .byte %00111110
8774	>bead	08				                .byte %00001000
8775	>beae	3e				                .byte %00111110
8776	>beaf	00				                .byte %00000000

8778						                ; CHR$214
8779	>beb0	63				                .byte %01100011
8780	>beb1	63				                .byte %01100011
8781	>beb2	36				                .byte %00110110
8782	>beb3	1c				                .byte %00011100
8783	>beb4	36				                .byte %00110110
8784	>beb5	63				                .byte %01100011
8785	>beb6	63				                .byte %01100011
8786	>beb7	00				                .byte %00000000

8788						                ; CHR$215
8789	>beb8	3e				                .byte %00111110
8790	>beb9	08				                .byte %00001000
8791	>beba	6b				                .byte %01101011
8792	>bebb	6b				                .byte %01101011
8793	>bebc	3e				                .byte %00111110
8794	>bebd	08				                .byte %00001000
8795	>bebe	3e				                .byte %00111110
8796	>bebf	00				                .byte %00000000

8798						                ; CHR$216
8799	>bec0	3e				                .byte %00111110
8800	>bec1	63				                .byte %01100011
8801	>bec2	63				                .byte %01100011
8802	>bec3	63				                .byte %01100011
8803	>bec4	36				                .byte %00110110
8804	>bec5	36				                .byte %00110110
8805	>bec6	63				                .byte %01100011
8806	>bec7	00				                .byte %00000000

8808						                ; CHR$217
8809	>bec8	7f				                .byte %01111111
8810	>bec9	63				                .byte %01100011
8811	>beca	63				                .byte %01100011
8812	>becb	36				                .byte %00110110
8813	>becc	36				                .byte %00110110
8814	>becd	1c				                .byte %00011100
8815	>bece	1c				                .byte %00011100
8816	>becf	00				                .byte %00000000

8818						                ; CHR$218
8819	>bed0	18				                .byte %00011000
8820	>bed1	18				                .byte %00011000
8821	>bed2	7e				                .byte %01111110
8822	>bed3	18				                .byte %00011000
8823	>bed4	18				                .byte %00011000
8824	>bed5	00				                .byte %00000000
8825	>bed6	7e				                .byte %01111110
8826	>bed7	00				                .byte %00000000

8828						                ; CHR$219
8829	>bed8	00				                .byte %00000000
8830	>bed9	7e				                .byte %01111110
8831	>beda	00				                .byte %00000000
8832	>bedb	18				                .byte %00011000
8833	>bedc	18				                .byte %00011000
8834	>bedd	7e				                .byte %01111110
8835	>bede	18				                .byte %00011000
8836	>bedf	18				                .byte %00011000

8838						                ; CHR$220
8839	>bee0	18				                .byte %00011000
8840	>bee1	18				                .byte %00011000
8841	>bee2	18				                .byte %00011000
8842	>bee3	18				                .byte %00011000
8843	>bee4	18				                .byte %00011000
8844	>bee5	18				                .byte %00011000
8845	>bee6	18				                .byte %00011000
8846	>bee7	00				                .byte %00000000

8848						                ; CHR$221
8849	>bee8	36				                .byte %00110110
8850	>bee9	36				                .byte %00110110
8851	>beea	36				                .byte %00110110
8852	>beeb	36				                .byte %00110110
8853	>beec	36				                .byte %00110110
8854	>beed	36				                .byte %00110110
8855	>beee	36				                .byte %00110110
8856	>beef	00				                .byte %00000000

8858						                ; CHR$222
8859	>bef0	00				                .byte %00000000
8860	>bef1	66				                .byte %01100110
8861	>bef2	66				                .byte %01100110
8862	>bef3	66				                .byte %01100110
8863	>bef4	66				                .byte %01100110
8864	>bef5	66				                .byte %01100110
8865	>bef6	3c				                .byte %00111100
8866	>bef7	00				                .byte %00000000

8868						                ; CHR$223
8869	>bef8	00				                .byte %00000000
8870	>bef9	3c				                .byte %00111100
8871	>befa	66				                .byte %01100110
8872	>befb	66				                .byte %01100110
8873	>befc	66				                .byte %01100110
8874	>befd	66				                .byte %01100110
8875	>befe	66				                .byte %01100110
8876	>beff	00				                .byte %00000000

8878						                ; CHR$224
8879						                .if version==350
8888						                .else
8889	>bf00	00				                .byte %00000000
8890	>bf01	03				                .byte %00000011
8891	>bf02	3e				                .byte %00111110
8892	>bf03	67				                .byte %01100111
8893	>bf04	6b				                .byte %01101011
8894	>bf05	73				                .byte %01110011
8895	>bf06	3e				                .byte %00111110
8896	>bf07	60				                .byte %01100000
8897						                .endif

8899						                ; CHR$225
8900	>bf08	00				                .byte %00000000
8901	>bf09	00				                .byte %00000000
8902	>bf0a	3b				                .byte %00111011
8903	>bf0b	6e				                .byte %01101110
8904	>bf0c	66				                .byte %01100110
8905	>bf0d	6e				                .byte %01101110
8906	>bf0e	3b				                .byte %00111011
8907	>bf0f	00				                .byte %00000000

8909						                ; CHR$226
8910	>bf10	1e				                .byte %00011110
8911	>bf11	33				                .byte %00110011
8912	>bf12	33				                .byte %00110011
8913	>bf13	3e				                .byte %00111110
8914	>bf14	33				                .byte %00110011
8915	>bf15	33				                .byte %00110011
8916	>bf16	3e				                .byte %00111110
8917	>bf17	60				                .byte %01100000

8919						                ; CHR$227
8920	>bf18	00				                .byte %00000000
8921	>bf19	00				                .byte %00000000
8922	>bf1a	66				                .byte %01100110
8923	>bf1b	36				                .byte %00110110
8924	>bf1c	1c				                .byte %00011100
8925	>bf1d	18				                .byte %00011000
8926	>bf1e	30				                .byte %00110000
8927	>bf1f	30				                .byte %00110000

8929						                ; CHR$228
8930	>bf20	3c				                .byte %00111100
8931	>bf21	60				                .byte %01100000
8932	>bf22	30				                .byte %00110000
8933	>bf23	3c				                .byte %00111100
8934	>bf24	66				                .byte %01100110
8935	>bf25	66				                .byte %01100110
8936	>bf26	3c				                .byte %00111100
8937	>bf27	00				                .byte %00000000

8939						                ; CHR$229
8940	>bf28	00				                .byte %00000000
8941	>bf29	00				                .byte %00000000
8942	>bf2a	1e				                .byte %00011110
8943	>bf2b	30				                .byte %00110000
8944	>bf2c	1c				                .byte %00011100
8945	>bf2d	30				                .byte %00110000
8946	>bf2e	1e				                .byte %00011110
8947	>bf2f	00				                .byte %00000000

8949						                ; CHR$230
8950	>bf30	3e				                .byte %00111110
8951	>bf31	0c				                .byte %00001100
8952	>bf32	18				                .byte %00011000
8953	>bf33	30				                .byte %00110000
8954	>bf34	60				                .byte %01100000
8955	>bf35	60				                .byte %01100000
8956	>bf36	3e				                .byte %00111110
8957	>bf37	06				                .byte %00000110

8959						                ; CHR$231
8960	>bf38	00				                .byte %00000000
8961	>bf39	00				                .byte %00000000
8962	>bf3a	7c				                .byte %01111100
8963	>bf3b	66				                .byte %01100110
8964	>bf3c	66				                .byte %01100110
8965	>bf3d	66				                .byte %01100110
8966	>bf3e	06				                .byte %00000110
8967	>bf3f	06				                .byte %00000110

8969						                ; CHR$232
8970	>bf40	3c				                .byte %00111100
8971	>bf41	66				                .byte %01100110
8972	>bf42	66				                .byte %01100110
8973	>bf43	7e				                .byte %01111110
8974	>bf44	66				                .byte %01100110
8975	>bf45	66				                .byte %01100110
8976	>bf46	3c				                .byte %00111100
8977	>bf47	00				                .byte %00000000

8979						                ; CHR$233
8980	>bf48	00				                .byte %00000000
8981	>bf49	00				                .byte %00000000
8982	>bf4a	18				                .byte %00011000
8983	>bf4b	18				                .byte %00011000
8984	>bf4c	18				                .byte %00011000
8985	>bf4d	18				                .byte %00011000
8986	>bf4e	0c				                .byte %00001100
8987	>bf4f	00				                .byte %00000000

8989						                ; CHR$234
8990	>bf50	00				                .byte %00000000
8991	>bf51	00				                .byte %00000000
8992	>bf52	66				                .byte %01100110
8993	>bf53	6c				                .byte %01101100
8994	>bf54	78				                .byte %01111000
8995	>bf55	6c				                .byte %01101100
8996	>bf56	66				                .byte %01100110
8997	>bf57	00				                .byte %00000000

8999						                ; CHR$235
9000	>bf58	60				                .byte %01100000
9001	>bf59	30				                .byte %00110000
9002	>bf5a	18				                .byte %00011000
9003	>bf5b	1c				                .byte %00011100
9004	>bf5c	36				                .byte %00110110
9005	>bf5d	63				                .byte %01100011
9006	>bf5e	63				                .byte %01100011
9007	>bf5f	00				                .byte %00000000

9009						                ; CHR$236
9010	>bf60	00				                .byte %00000000
9011	>bf61	00				                .byte %00000000
9012	>bf62	33				                .byte %00110011
9013	>bf63	33				                .byte %00110011
9014	>bf64	33				                .byte %00110011
9015	>bf65	33				                .byte %00110011
9016	>bf66	3e				                .byte %00111110
9017	>bf67	60				                .byte %01100000

9019						                ; CHR$237
9020	>bf68	00				                .byte %00000000
9021	>bf69	00				                .byte %00000000
9022	>bf6a	63				                .byte %01100011
9023	>bf6b	33				                .byte %00110011
9024	>bf6c	1b				                .byte %00011011
9025	>bf6d	1e				                .byte %00011110
9026	>bf6e	1c				                .byte %00011100
9027	>bf6f	00				                .byte %00000000

9029						                ; CHR$238
9030						                .if version==350
9039						                .else
9040	>bf70	3c				                .byte %00111100
9041	>bf71	60				                .byte %01100000
9042	>bf72	60				                .byte %01100000
9043	>bf73	3c				                .byte %00111100
9044	>bf74	60				                .byte %01100000
9045	>bf75	60				                .byte %01100000
9046	>bf76	3e				                .byte %00111110
9047	>bf77	06				                .byte %00000110
9048						                .endif

9050						                ; CHR$239
9051	>bf78	00				                .byte %00000000
9052	>bf79	00				                .byte %00000000
9053	>bf7a	3e				                .byte %00111110
9054	>bf7b	63				                .byte %01100011
9055	>bf7c	63				                .byte %01100011
9056	>bf7d	63				                .byte %01100011
9057	>bf7e	3e				                .byte %00111110
9058	>bf7f	00				                .byte %00000000

9060						                ; CHR$240
9061	>bf80	00				                .byte %00000000
9062	>bf81	00				                .byte %00000000
9063	>bf82	7f				                .byte %01111111
9064	>bf83	36				                .byte %00110110
9065	>bf84	36				                .byte %00110110
9066	>bf85	36				                .byte %00110110
9067	>bf86	36				                .byte %00110110
9068	>bf87	00				                .byte %00000000

9070						                ; CHR$241
9071	>bf88	00				                .byte %00000000
9072	>bf89	00				                .byte %00000000
9073	>bf8a	3c				                .byte %00111100
9074	>bf8b	66				                .byte %01100110
9075	>bf8c	66				                .byte %01100110
9076	>bf8d	7c				                .byte %01111100
9077	>bf8e	60				                .byte %01100000
9078	>bf8f	60				                .byte %01100000

9080						                ; CHR$242
9081	>bf90	00				                .byte %00000000
9082	>bf91	00				                .byte %00000000
9083	>bf92	3f				                .byte %00111111
9084	>bf93	66				                .byte %01100110
9085	>bf94	66				                .byte %01100110
9086	>bf95	66				                .byte %01100110
9087	>bf96	3c				                .byte %00111100
9088	>bf97	00				                .byte %00000000

9090						                ; CHR$243
9091	>bf98	00				                .byte %00000000
9092	>bf99	00				                .byte %00000000
9093	>bf9a	7e				                .byte %01111110
9094	>bf9b	18				                .byte %00011000
9095	>bf9c	18				                .byte %00011000
9096	>bf9d	18				                .byte %00011000
9097	>bf9e	0c				                .byte %00001100
9098	>bf9f	00				                .byte %00000000

9100						                ; CHR$244
9101	>bfa0	00				                .byte %00000000
9102	>bfa1	00				                .byte %00000000
9103	>bfa2	73				                .byte %01110011
9104	>bfa3	33				                .byte %00110011
9105	>bfa4	33				                .byte %00110011
9106	>bfa5	33				                .byte %00110011
9107	>bfa6	1e				                .byte %00011110
9108	>bfa7	00				                .byte %00000000

9110						                ; CHR$245
9111	>bfa8	00				                .byte %00000000
9112	>bfa9	00				                .byte %00000000
9113	>bfaa	3e				                .byte %00111110
9114	>bfab	6b				                .byte %01101011
9115	>bfac	6b				                .byte %01101011
9116	>bfad	3e				                .byte %00111110
9117	>bfae	18				                .byte %00011000
9118	>bfaf	18				                .byte %00011000

9120						                ; CHR$246
9121	>bfb0	00				                .byte %00000000
9122	>bfb1	00				                .byte %00000000
9123	>bfb2	66				                .byte %01100110
9124	>bfb3	36				                .byte %00110110
9125	>bfb4	1c				                .byte %00011100
9126	>bfb5	1c				                .byte %00011100
9127	>bfb6	36				                .byte %00110110
9128	>bfb7	33				                .byte %00110011

9130						                ; CHR$247
9131	>bfb8	00				                .byte %00000000
9132	>bfb9	00				                .byte %00000000
9133	>bfba	63				                .byte %01100011
9134	>bfbb	6b				                .byte %01101011
9135	>bfbc	6b				                .byte %01101011
9136	>bfbd	3e				                .byte %00111110
9137	>bfbe	18				                .byte %00011000
9138	>bfbf	18				                .byte %00011000

9140						                ; CHR$248
9141						                .if version==350
9150						                .else
9151	>bfc0	00				                .byte %00000000
9152	>bfc1	00				                .byte %00000000
9153	>bfc2	36				                .byte %00110110
9154	>bfc3	63				                .byte %01100011
9155	>bfc4	6b				                .byte %01101011
9156	>bfc5	7f				                .byte %01111111
9157	>bfc6	36				                .byte %00110110
9158	>bfc7	00				                .byte %00000000
9159						                .endif

9161						                ; CHR$249
9162	>bfc8	38				                .byte %00111000
9163	>bfc9	0c				                .byte %00001100
9164	>bfca	06				                .byte %00000110
9165	>bfcb	3e				                .byte %00111110
9166	>bfcc	66				                .byte %01100110
9167	>bfcd	66				                .byte %01100110
9168	>bfce	3c				                .byte %00111100
9169	>bfcf	00				                .byte %00000000

9171						                ; CHR$250
9172	>bfd0	00				                .byte %00000000
9173	>bfd1	31				                .byte %00110001
9174	>bfd2	6b				                .byte %01101011
9175	>bfd3	46				                .byte %01000110
9176	>bfd4	00				                .byte %00000000
9177	>bfd5	7f				                .byte %01111111
9178	>bfd6	00				                .byte %00000000
9179	>bfd7	00				                .byte %00000000

9181						                ; CHR$251
9182	>bfd8	00				                .byte %00000000
9183	>bfd9	7e				                .byte %01111110
9184	>bfda	00				                .byte %00000000
9185	>bfdb	7e				                .byte %01111110
9186	>bfdc	00				                .byte %00000000
9187	>bfdd	7e				                .byte %01111110
9188	>bfde	00				                .byte %00000000
9189	>bfdf	00				                .byte %00000000

9191						                ; CHR$252
9192	>bfe0	07				                .byte %00000111
9193	>bfe1	1c				                .byte %00011100
9194	>bfe2	70				                .byte %01110000
9195	>bfe3	1c				                .byte %00011100
9196	>bfe4	07				                .byte %00000111
9197	>bfe5	00				                .byte %00000000
9198	>bfe6	7f				                .byte %01111111
9199	>bfe7	00				                .byte %00000000

9201						                ; CHR$253
9202	>bfe8	06				                .byte %00000110
9203	>bfe9	0c				                .byte %00001100
9204	>bfea	7e				                .byte %01111110
9205	>bfeb	18				                .byte %00011000
9206	>bfec	7e				                .byte %01111110
9207	>bfed	30				                .byte %00110000
9208	>bfee	60				                .byte %01100000
9209	>bfef	00				                .byte %00000000

9211						                ; CHR$254
9212	>bff0	70				                .byte %01110000
9213	>bff1	1c				                .byte %00011100
9214	>bff2	07				                .byte %00000111
9215	>bff3	1c				                .byte %00011100
9216	>bff4	70				                .byte %01110000
9217	>bff5	00				                .byte %00000000
9218	>bff6	7f				                .byte %01111111
9219	>bff7	00				                .byte %00000000

9221						                ; CHR$255
9222	>bff8	ff				                .byte %11111111
9223	>bff9	ff				                .byte %11111111
9224	>bffa	ff				                .byte %11111111
9225	>bffb	ff				                .byte %11111111
9226	>bffc	ff				                .byte %11111111
9227	>bffd	ff				                .byte %11111111
9228	>bffe	ff				                .byte %11111111
9229	>bfff	ff				                .byte %11111111

9231						                .endblock



:1	;******  Return to file: mos500.s65

28						                .endsection

30						                .section mos
31						                .include "src/mos.s65"

:15	;******  Processing file: src/mos.s65

1						; -*- comment-column:45; -*-

3	.c000					mos: .block

5						; VDU driver entry block
6						; ======================
7	.c000					LC000:                                       ; Read from VDU memory
8	.c000	b1 d6		lda ($d6),y	                lda (ZMEMG),y
9	.c002	60		rts		                rts
10	.c003					LC003:                                       ; Write to VDU memory
11	.c003	91 d6		sta ($d6),y	                sta (ZMEMG),y
12	.c005	60		rts		                rts

14						; MasRef E.4-6
15						;
16						; JSR PLBYTE plots the mask held in ZMASK into the byte pointed to by
17						; (ZMEMG),y, using ZGORA and ZGEOR as colour masks. See GADDR below
18						; for an example of its use.
19						;
20						; PLBYTE uses ZTEMP as workspace and preserves X, Y, V and C.
21	.c006					PLBYTE:
22	.c006	4c 51 db	jmp $db51	                jmp plbyteEntryPoint

24						; MasRef E.4-6
25						;
26						; JSR HPLOT plots a fast horizontal line in the current graphics
27						; colour or ECF and the current graphics mode (all as set by VDU 18)
28						; between two specified points. It is the low level primitive used by
29						; all the MOS area fill commands.
30						;
31						; On entry, two 4 byte areas at &300+X and &300+Y contain the
32						; coordinates of the two endpoints, in the standard
33						; lowX,highX,lowY,highY order. Should the Y coordinates differ, the Y
34						; coordinate of the line plotted is taken from the leftmost of the two
35						; points specified.
36						;
37						; Only portions of the line inside the graphics window are plotted.
38						; Subject to this, both endpoints of the line are plotted.
39						;
40						; HPLOT uses ZGORA, ZGEOR, ZMASK, ZMEMG, ZTEMP (but not ZTEMP+1),
41						; ZTEMPB, ZTEMPB+1, ZTEMPC and ZTEMPC+1 as workspace. No registers or
42						; flags are preserved.
43	.c009					HPLOT:
44	.c009	4c e8 da	jmp $dae8	                jmp LDAE8

46						; MasRef E.4-6
47						;
48						; JSR EIGABS converts the 4 byte pair of external coordinates at
49						; &300+X where X>=2 (in standard lowX,highX,lowY,highY order) into the
50						; corresponding pair of pixel coordinates by offsetting by the
51						; graphics origin, then dividing by an appropriate power of 2.
52						;
53						; EIGABS uses ZTEMP as workspace, and corrupts all registers and
54						; flags.
55	.c00c					EIGABS:
56	.c00c	4c de d1	jmp $d1de	                jmp eigabsEntryPoint

58						; MasRef E.4-7
59						;
60						; JSR WIND windows the 4 byte pair of pixel coordinates (in standard
61						; lowX,highX,lowY,highY order) at &300+X, and returns a result in A
62						; according to its position with respect to the window:

64						; 9 | 8 | 10
65						; --+---+---
66						; 1 | 0 | 2
67						; --+---+---
68						; 5 | 4 | 6

70						; WIND uses ZTEMP as workspace, preserves X and sets N and Z according
71						; to A.
72	.c00f					WIND:
73	.c00f	4c a8 d1	jmp $d1a8	                jmp windEntryPoint

75						; MasRef E.4-7
76						;
77						; JSR GADDR addresses the pixel whose 4 byte pair of pixel coordinates
78						; (in standard lowX,highX,lowY,highY order) is at &300+X. GADDR should
79						; not be called without first ensuring (typically by means of WIND)
80						; that the point concerned does lie within the screen.
81						;
82						; GADDR initialises the following variables:
83						;
84						; . ZMEMG to the start of the page of memory containing the pixel.
85						;
86						; . Y and VDU variable &1A (i.e. location &31A) to contain the offset
87						; of the byte containing the pixel within this page <80><93> i.e. (ZMEMG),y
88						; points to the byte containing the pixel.
89						;
90						; . ZMASK to a mask indicating which bits of this byte constitute the
91						; pixel.
92						;
93						; . ZGORA and ZGEOR to the correct colour masks for the current
94						; graphics plot mode (found in VDU variable &5A) and colour/ECF
95						;
96						; . X to Y MOD 7, i.e. the scan line within a character row of the
97						; pixel.
98						;
99						; Additionally, GADDR uses ZTEMP as workspace and returns A=0, Z=1.
100						;
101						; An example of the use of PLBYTE, WIND and GADDR is the following
102						; code, which effectively re-implements the VDU 25 64<80><93>71 (plot a
103						; point) calls. It assumes that the routine addresses have been
104						; previously defined and that the graphics plot mode, etc. were set up
105						; by the VDU 25 code before the unknown PLOT codes vector was entered:

107						; .POINT
108						;  LDX #&20   ;Addresses new point within VDU queue, as
109						;             ;left on entry to the unknown PLOT codes
110						;             ;vector.
111						;  JSR WIND   ;Is the point inside the window?
112						;  BNE END    ;Return if not.
113						;  JSR GADDR  ;Address the point now we know it's on
114						;             ;screen.
115						;  JSR PLBYTE ;And plot the point.
116						; .END
117						;  RTS
118	.c012					GADDR:
119	.c012	4c c8 de	jmp $dec8	                jmp gaddrEntryPoint

121						; MasRef E.4-8
122						;
123						; JSR IEG takes the internal pixel coordinates of the graphics cursor
124						; (in VDU variables &24<80><93>&27), converts it back to external coordinates
125						; and stores the result in VDU variables &10<80><93>&13.
126						;
127						; It should be called whenever the graphics code generates a new
128						; graphics cursor position (e.g. in the VDU drivers, it is called
129						; after a character is printed in VDU 5 mode). Its purpose is to make
130						; the two versions of the graphics cursor agree again, and thus
131						; prevent errors occurring with relative plots.
132						;
133						; IEG uses no page zero locations and corrupts all registers and
134						; flags.
135	.c015					IEG:
136	.c015	4c df c4	jmp $c4df	                jmp LC4DF

138						;-------------------------------------------------------------------------

140	.c018					LC018:                                       ; Fetch byte from ROM Y
141	.c018	a6 f4		ldx $f4		                ldx $F4                      ; Get current ROM
142	.c01a	84 f4		sty $f4		                sty $F4                      ; Select ROM in Y
143	.c01c	8c 30 fe	sty $fe30	                sty ROMSEL
144	.c01f	b2 f6		lda ($f6)	                lda ($F6)                    ; Get byte with ROM Y paged in
145	.c021	4c 9a e5	jmp $e59a	                jmp selectROMX                    ; Page in ROM X and return

147	.c024					LC024:
148	.c024	6c 5d 03	jmp ($035d)	                jmp ($035D)

150						;-------------------------------------------------------------------------
151						;
152						; VDU driver entry point
153						;
154						; Output to VDU.
155						;
156	.c027					outputToVDU:
157	.c027	ae 6a 02	ldx $026a	                ldx vduQueueNegativeLength  ;get VDU queue length
158	.c02a	f0 2d		beq $c059	                beq outputCharToVDU         ;taken if empty
159	.c02c	9d 24 02	sta $0224,x	                sta vduv.queueEnd-1-255,x   ;add to queue
160	.c02f	ee 6a 02	inc $026a	                inc vduQueueNegativeLength  ;one more in the queue...
161	.c032	f0 02		beq $c036	                beq outputQueueToVDU        ;taken if queue now filled
162	.c034					clc_rts_c034:
163	.c034	18		clc		                clc

165						;-------------------------------------------------------------------------
166						;
167						; VDU 0 (&00) Null [MasRef E.3-1]
168						; VDU 6 (&06) Enable VDU driver [MasRef E.3-3]
169						; VDU 27 (&1B) Null [MasRef E.3-34]
170						;
171	.c035					vdu0EntryPoint:
172	.c035					vdu6EntryPoint:
173	.c035					vdu27EntryPoint:
174	.c035					rtsC035:
175	.c035	60		rts		                rts

177						;-------------------------------------------------------------------------

179	.c036					outputQueueToVDU:
180	.c036	24 d0		bit $d0		                bit STATE
181	.c038	10 19		bpl $c053	                bpl LC053              ;branch taken if not VDU21 mode

183						                ; ????
184	.c03a	ac 5e 03	ldy $035e	                ldy vduv.jumpVector+1
185	.c03d	c0 c0		cpy #$c0	                cpy #>vdu1EntryPoint
186	.c03f	d0 f3		bne $c034	                bne clc_rts_c034
187	.c041	ac 5d 03	ldy $035d	                ldy vduv.jumpVector+0
188	.c044	c0 e2		cpy #$e2	                cpy #<vdu1EntryPoint
189	.c046	d0 ec		bne $c034	                bne clc_rts_c034

191	.c048					outputCharToPrinter:
192	.c048	aa		tax		                tax                          ;save char to print
193	.c049	a5 d0		lda $d0		                lda STATE
194	.c04b	4a		lsr a		                lsr a                       ;C set if isPrinterEnabled
195	.c04c	90 e7		bcc $c035	                bcc rtsC035 ;taken if printer disabled - VDU 1 then a no-op
196	.c04e	8a		txa		                txa                          ;restore char to print
197	.c04f	18		clc		                clc
198						                .if version<350
200						                .else
201	.c050	4c ed e2	jmp $e2ed	                jmp LE2ED
202						                .endif

204	.c053					LC053:
205	.c053	20 fa c0	jsr $c0fa	                jsr stopCursorEditing
206	.c056	18		clc		                clc
207	.c057	80 67		bra $c0c0	                bra LC0C0

209	.c059					outputCharToVDU:
210	.c059	20 fa c0	jsr $c0fa	                jsr stopCursorEditing
211	.c05c	50 0f		bvc $c06d	                bvc LC06D             ;taken if not previously editing
212	.c05e	30 0d		bmi $c06d	                bmi LC06D             ;taken if VDU 21
213	.c060	c9 0d		cmp #$0d	                cmp #$0D
214	.c062	d0 09		bne $c06d	                bne LC06D                  ;taken if not printing a CR
215	.c064	48		pha		                pha                        ;save char to print
216	.c065	a9 42		lda #$42	                lda #STATE.isCursorEditing|STATE.isScrollingDisabled
217	.c067	14 d0		trb $d0		                trb STATE
218	.c069	20 50 cf	jsr $cf50	                jsr showCursor
219	.c06c	68		pla		                pla                          ;restore char to print
220	.c06d					LC06D:
221	.c06d	c9 20		cmp #$20	                cmp #$20
222	.c06f	90 06		bcc $c077	                bcc handleControlChar
223	.c071	c9 7f		cmp #$7f	                cmp #$7F
224	.c073	d0 21		bne $c096	                bne LC096                    ;taken if not backspace
225	.c075	a9 20		lda #$20	                lda #$20 ;backspace is entry 32 in the VDU routines table
226	.c077					handleControlChar:
227	.c077	a8		tay		                tay                          ;Y=index in table
228	.c078	b9 37 e0	lda $e037,y	                lda vduRoutinesLSBTable,y
229	.c07b	8d 5d 03	sta $035d	                sta vduv.jumpVector+0 ; Store jump address LSB (see MasRef E.4-3)
230	.c07e	b9 58 e0	lda $e058,y	                lda vduRoutinesMSBTable,y
231	.c081	30 30		bmi $c0b3	                bmi LC0B3           ;branch taken if MSB directly
232	.c083	aa		tax		                tax                          ; Save original MSB value
233	.c084	09 f0		ora #$f0	                ora #$F0
234	.c086	8d 6a 02	sta $026a	                sta vduQueueNegativeLength ;initialise initial VDU queue length
235	.c089	8a		txa		                txa                          ; Restore original MSB value
236						                .if version==350
238						                .else
239	.c08a	4a		lsr a		                lsr a                        ;
240	.c08b	4a		lsr a		                lsr a                        ;
241	.c08c	4a		lsr a		                lsr a                        ;
242	.c08d	4a		lsr a		                lsr a                        ; Extract value in top 4 bits
243						                .endif
244	.c08e	18		clc		                clc                          ;
245	.c08f	69 c0		adc #$c0	                adc #vduRoutinesPage         ; form MSB
246	.c091	8d 5e 03	sta $035e	                sta vduv.jumpVector+1
247	.c094	80 34		bra $c0ca	                bra reinstateCursorEditing                    ; Continue

249	.c096					LC096:
250	.c096	24 d0		bit $d0		                bit STATE
251	.c098	30 2d		bmi $c0c7	                bmi LC0C7                    ;taken if VDU21
252	.c09a	20 0c ce	jsr $ce0c	                jsr LCE0C
253	.c09d	a9 20		lda #$20	                lda #$20
254	.c09f	2c 66 03	bit $0366	                bit $0366
255	.c0a2	d0 23		bne $c0c7	                bne LC0C7
256	.c0a4	20 76 c2	jsr $c276	                jsr LC276
257	.c0a7	80 1e		bra $c0c7	                bra LC0C7

259	.c0a9					LC0A9:
260	.c0a9	49 06		eor #$06	                eor #$06
261	.c0ab	d0 18		bne $c0c5	                bne LC0C5
262	.c0ad	a9 80		lda #$80	                lda #STATE.isVDU21
263	.c0af	14 d0		trb $d0		                trb STATE
264	.c0b1	80 17		bra $c0ca	                bra reinstateCursorEditing

266	.c0b3					LC0B3:
267	.c0b3	8d 5e 03	sta $035e	                sta vduv.jumpVector+1
268	.c0b6	98		tya		                tya
269	.c0b7	49 f7		eor #$f7	                eor #$F7
270	.c0b9	c9 fa		cmp #$fa	                cmp #$FA
271	.c0bb	98		tya		                tya
272	.c0bc	24 d0		bit $d0		                bit STATE
273	.c0be	30 e9		bmi $c0a9	                bmi LC0A9             ;branch taken if VDU21 in effect
274	.c0c0					LC0C0:
275	.c0c0	08		php		                php
276	.c0c1	20 24 c0	jsr $c024	                jsr LC024
277	.c0c4	28		plp		                plp
278	.c0c5					LC0C5:
279	.c0c5	90 03		bcc $c0ca	                bcc reinstateCursorEditing
280	.c0c7					LC0C7:
281	.c0c7	a5 d0		lda $d0		                lda STATE
282	.c0c9	4a		lsr a		                lsr a                          ;C=1 if printer enabled
283	.c0ca					reinstateCursorEditing:
284	.c0ca	24 d0		bit $d0		                bit STATE
285	.c0cc	50 13		bvc $c0e1	                bvc rtsC0E1               ;taken if not cursor editing
286	.c0ce	20 05 c1	jsr $c105	                jsr activateEditCursor
287	.c0d1					exchangeCursors:
288	.c0d1	08		php		                php
289	.c0d2	48		pha		                pha
290	.c0d3	a5 d0		lda $d0		                lda STATE
291	.c0d5	49 02		eor #$02	                eor #STATE.isScrollingDisabled
292	.c0d7	85 d0		sta $d0		                sta STATE
293	.c0d9	20 be e2	jsr $e2be	                jsr exchangeEditCursorPositionAndTextCursorPosition
294	.c0dc	20 d8 c6	jsr $c6d8	                jsr updateCRTCTextCursor
295	.c0df	68		pla		                pla
296	.c0e0	28		plp		                plp
297	.c0e1					rtsC0E1:
298	.c0e1	60		rts		                rts

300						;-------------------------------------------------------------------------
301						;
302						; VDU 1 (&01) Send next character to printer only [MasRef E.3-2]
303						;
304	.c0e2					vdu1EntryPoint:
305	.c0e2	20 ca c0	jsr $c0ca	                jsr reinstateCursorEditing
306	.c0e5	20 48 c0	jsr $c048	                jsr outputCharToPrinter
307	.c0e8	80 10		bra $c0fa	                bra stopCursorEditing

309						;-------------------------------------------------------------------------
310						;
311						; VDU 2 (&02) Enable printer [MasRef E.3-2]
312						; VDU 3 (&03) Disable printer [MasRef E.3-3]
313						;
314	.c0ea					vdu2EntryPoint:
315	.c0ea					vdu3EntryPoint:
316	.c0ea	48		pha		                pha                          ;
317	.c0eb	20 ca c0	jsr $c0ca	                jsr reinstateCursorEditing
318						                .if version<350
320						                .else
321	.c0ee	20 e7 e2	jsr $e2e7	                jsr LE2E7
322						                .endif
323	.c0f1	a9 01		lda #$01	                lda #STATE.isPrinterEnabled  ;
324	.c0f3	04 d0		tsb $d0		                tsb STATE
325	.c0f5	68		pla		                pla
326	.c0f6	29 01		and #$01	                and #STATE.isPrinterEnabled
327	.c0f8	14 d0		trb $d0		                trb STATE

329						;-------------------------------------------------------------------------
330						;
331						; Stop cursor editing, if it's on.
332						;
333						; exit:
334						;
335						; V=1 if cursor editing previous on
336						; N=1 if VDU 21 on
337						;
338	.c0fa					stopCursorEditing:
339	.c0fa	24 d0		bit $d0		                bit STATE
340	.c0fc	50 e3		bvc $c0e1	                bvc rtsC0E1                    ;taken if not cursor editing
341	.c0fe	20 d1 c0	jsr $c0d1	                jsr exchangeCursors
342	.c101	08		php		                php
343	.c102					deactivateEditCursor:
344	.c102	38		sec		                sec
345	.c103	80 02		bra $c107	                bra updateEditCursorState

347						;-------------------------------------------------------------------------

349	.c105					activateEditCursor:
350	.c105	08		php		                php
351	.c106	18		clc		                clc

353						;-------------------------------------------------------------------------
354						;
355						; Handle cursor editing on/off.
356						;
357						; entry:
358						;
359						; C=0 - cursor editing on; add fake cursor
360						;
361						; C=1 = cursor editing off; remove fake cursor and restore screen
362						;
363	.c107					updateEditCursorState: .proc
364	.c107	48		pha		                pha
365	.c108	a5 d8		lda $d8		                lda ZMEMT+0
366	.c10a	85 e0		sta $e0		                sta ZTEMPD+0
367	.c10c	a5 d9		lda $d9		                lda ZMEMT+1
368	.c10e	85 e1		sta $e1		                sta ZTEMPD+1
369	.c110	ac 4f 03	ldy $034f	                ldy vduv.bytesPerCharacter
370	.c113	88		dey		                dey
371	.c114	d0 0e		bne $c124	                bne bitmap

373	.c116					teletext:
374	.c116	ad 38 03	lda $0338	                lda vduv.workspace._38 ;get old byte under fake cursor (may be bogus)
375	.c119	b0 17		bcs $c132	                bcs storeToScreen      ;taken if switching off
376	.c11b	b2 d8		lda ($d8)	                lda (ZMEMT)            ;get screen byte
377	.c11d	8d 38 03	sta $0338	                sta vduv.workspace._38 ;store old byte
378	.c120	a9 7f		lda #$7f	                lda #$7F               ;store solid block to screen
379	.c122	80 0e		bra $c132	                bra storeToScreen

381	.c124					bitmap:
382	.c124	a9 ff		lda #$ff	                lda #%11111111          ;invert all bits
383	.c126	c0 1f		cpy #$1f	                cpy #$1F      ;check for 32 chars/byte - i.e., MODE 2
384	.c128	d0 02		bne $c12c	                bne +         ;taken if not MODE 2
385	.c12a	a9 3f		lda #$3f	                lda #%00111111       ;avoid flashing colours in MODE 2
386	.c12c					+
387	.c12c	85 da		sta $da		                sta ZTEMP
388	.c12e					loop:
389	.c12e	b2 e0		lda ($e0)	                lda (ZTEMPD)
390	.c130	45 da		eor $da		                eor ZTEMP
391	.c132					storeToScreen:
392	.c132	92 e0		sta ($e0)	                sta (ZTEMPD)
393	.c134	e6 e0		inc $e0		                inc ZTEMPD+0
394	.c136	d0 09		bne $c141	                bne +                    ;taken if no carry out of LSB
395	.c138	e6 e1		inc $e1		                inc ZTEMPD+1
396	.c13a	10 05		bpl $c141	                bpl +                 ;taken if no screen address wrap
397	.c13c	ad 4e 03	lda $034e	                lda vduv.startScreenAddressHighByte
398	.c13f	85 e1		sta $e1		                sta ZTEMPD+1
399	.c141					+
400	.c141	88		dey		                dey               ;Y=$ff after 1 iteration in teletext
401	.c142	10 ea		bpl $c12e	                bpl loop
402	.c144	68		pla		                pla
403	.c145	28		plp		                plp
404	.c146	60		rts		                rts
405						                .endproc

407						;-------------------------------------------------------------------------

409	.c147					LC147:
410	>c147	be c1				                .word LC1BE
411	>c149	b1 c1				                .word LC1B1
412	>c14b	be c1				                .word LC1BE
413	>c14d	b1 c1				                .word LC1B1
414	>c14f	95 c1				                .word LC195
415	>c151	95 c1				                .word LC195
416	>c153	a2 c1				                .word LC1A2
417	>c155	a2 c1				                .word LC1A2

419						;-------------------------------------------------------------------------

421	.c157					LC157:
422	>c157	01 c2				                .word LC201
423	>c159	ee c1				                .word LC1EE
424	>c15b	01 c2				                .word LC201
425	>c15d	ee c1				                .word LC1EE
426	>c15f	21 c2				                .word LC221
427	>c161	21 c2				                .word LC221
428	>c163	10 c2				                .word LC210
429	>c165	10 c2				                .word LC210

431						;-------------------------------------------------------------------------
432						;
433						; Indexed by the swapAxes, invertVertical and invertHorizontal cursor
434						; flags bits.
435						;
436	.c167					setTextCursorXPositionRoutinesTable:
437	>c167	d3 c2				                .word setTextCursorXPosition           ;0
438	>c169	cb c2				                .word setTextCursorXPositionInvertHorizontal ;invertHorizontal
439	>c16b	d3 c2				                .word setTextCursorXPosition ;invertVertical
440	>c16d	cb c2				                .word setTextCursorXPositionInvertHorizontal ;invertVertical|invertHorizontal
441	>c16f	e2 c2				                .word setTextCursorXPositionSwapAxes         ;swapAxes
442	>c171	e2 c2				                .word setTextCursorXPositionSwapAxes ;swapAxes|invertHorizontal
443	>c173	da c2				                .word setTextCursorXPositionSwapAxesInvertVertical ;swapAxes|invertVertical
444	>c175	da c2				                .word setTextCursorXPositionSwapAxesInvertVertical ;swapAxes|invertVertical|invertHorizontal

446						;-------------------------------------------------------------------------

448	.c177					LC177:
449	>c177	10 c3				                .word LC310
450	>c179	f2 c2				                .word LC2F2
451	>c17b	10 c3				                .word LC310
452	>c17d	f2 c2				                .word LC2F2
453	>c17f	5a c3				                .word LC35A
454	>c181	5a c3				                .word LC35A
455	>c183	38 c3				                .word LC338
456	>c185	38 c3				                .word LC338

458						;-------------------------------------------------------------------------

460	.c187					LC187:
461	.c187	4d 66 03	eor $0366	                eor $0366
462	.c18a	29 0e		and #$0e	                and #$0E
463	.c18c	48		pha		                pha
464	.c18d	20 a6 d1	jsr $d1a6	                jsr LD1A6
465	.c190	fa		plx		                plx
466	.c191	38		sec		                sec
467	.c192	7c 47 c1	jmp ($c147,x)	                jmp (LC147,x)

469	.c195					LC195:
470	.c195	ad 26 03	lda $0326	                lda $0326
471	.c198	e9 08		sbc #$08	                sbc #$08
472	.c19a	8d 26 03	sta $0326	                sta $0326
473	.c19d	ce 27 03	dec $0327	                dec $0327
474	.c1a0	80 08		bra $c1aa	                bra LC1AA

476	.c1a2					LC1A2:
477	.c1a2	ad 26 03	lda $0326	                lda $0326
478	.c1a5	69 07		adc #$07	                adc #$07
479	.c1a7	8d 26 03	sta $0326	                sta $0326
480	.c1aa					LC1AA:
481	.c1aa	90 1f		bcc $c1cb	                bcc LC1CB
482	.c1ac	ee 27 03	inc $0327	                inc $0327
483	.c1af	80 1a		bra $c1cb	                bra LC1CB

485	.c1b1					LC1B1:
486	.c1b1	ad 24 03	lda $0324	                lda $0324
487	.c1b4	e9 08		sbc #$08	                sbc #$08
488	.c1b6	8d 24 03	sta $0324	                sta $0324
489	.c1b9	ce 25 03	dec $0325	                dec $0325
490	.c1bc	80 08		bra $c1c6	                bra LC1C6

492	.c1be					LC1BE:
493	.c1be	ad 24 03	lda $0324	                lda $0324
494	.c1c1	69 07		adc #$07	                adc #$07
495	.c1c3	8d 24 03	sta $0324	                sta $0324
496	.c1c6					LC1C6:
497	.c1c6	90 03		bcc $c1cb	                bcc LC1CB
498	.c1c8	ee 25 03	inc $0325	                inc $0325
499	.c1cb					LC1CB:
500	.c1cb	a5 da		lda $da		                lda $DA
501	.c1cd	d0 0c		bne $c1db	                bne LC1DB
502	.c1cf	2c 66 03	bit $0366	                bit $0366
503	.c1d2	70 07		bvs $c1db	                bvs LC1DB
504	.c1d4	da		phx		                phx
505	.c1d5	20 a6 d1	jsr $d1a6	                jsr LD1A6
506	.c1d8	fa		plx		                plx
507	.c1d9	a8		tay		                tay
508	.c1da	60		rts		                rts

510	.c1db					LC1DB:
511	.c1db	a9 00		lda #$00	                lda #$00
512	.c1dd	60		rts		                rts

514	.c1de					LC1DE:
515	.c1de	a9 00		lda #$00	                lda #$00
516	.c1e0					LC1E0:
517	.c1e0	64 da		stz $da		                stz $DA
518	.c1e2	0a		asl a		                asl a
519	.c1e3	26 da		rol $da		                rol $DA
520	.c1e5	0a		asl a		                asl a
521	.c1e6	26 da		rol $da		                rol $DA
522	.c1e8	0a		asl a		                asl a
523	.c1e9	26 da		rol $da		                rol $DA
524	.c1eb	7c 57 c1	jmp ($c157,x)	                jmp (LC157,x)

526	.c1ee					LC1EE:
527	.c1ee	49 f9		eor #$f9	                eor #$F9
528	.c1f0	6d 04 03	adc $0304	                adc $0304
529	.c1f3	8d 24 03	sta $0324	                sta $0324
530	.c1f6	a5 da		lda $da		                lda $DA
531	.c1f8	49 ff		eor #$ff	                eor #$FF
532	.c1fa	6d 05 03	adc $0305	                adc $0305
533	.c1fd	8d 25 03	sta $0325	                sta $0325
534	.c200	60		rts		                rts

536	.c201					LC201:
537	.c201	6d 00 03	adc $0300	                adc $0300
538	.c204	8d 24 03	sta $0324	                sta $0324
539	.c207	a5 da		lda $da		                lda $DA
540	.c209	6d 01 03	adc $0301	                adc $0301
541	.c20c	8d 25 03	sta $0325	                sta $0325
542	.c20f	60		rts		                rts

544	.c210					LC210:
545	.c210	49 07		eor #$07	                eor #$07
546	.c212	6d 02 03	adc $0302	                adc $0302
547	.c215	8d 26 03	sta $0326	                sta $0326
548	.c218	a5 da		lda $da		                lda $DA
549	.c21a	6d 03 03	adc $0303	                adc $0303
550	.c21d	8d 27 03	sta $0327	                sta $0327
551	.c220	60		rts		                rts

553	.c221					LC221:
554	.c221	38		sec		                sec
555	.c222	49 ff		eor #$ff	                eor #$FF
556	.c224	6d 06 03	adc $0306	                adc $0306
557	.c227	8d 26 03	sta $0326	                sta $0326
558	.c22a	a5 da		lda $da		                lda $DA
559	.c22c	49 ff		eor #$ff	                eor #$FF
560	.c22e	6d 07 03	adc $0307	                adc $0307
561	.c231	8d 27 03	sta $0327	                sta $0327
562	.c234	60		rts		                rts

564	.c235					LC235:
565	.c235	a9 00		lda #$00	                lda #$00
566	.c237	20 87 c1	jsr $c187	                jsr LC187
567	.c23a	f0 0d		beq $c249	                beq LC249
568	.c23c	20 de c1	jsr $c1de	                jsr LC1DE
569	.c23f					LC23F:
570	.c23f	a9 08		lda #$08	                lda #$08
571	.c241					LC241:
572	.c241	20 87 c1	jsr $c187	                jsr LC187
573	.c244	f0 03		beq $c249	                beq LC249
574	.c246	20 de c1	jsr $c1de	                jsr LC1DE
575	.c249					LC249:
576	.c249	4c df c4	jmp $c4df	                jmp LC4DF

578	.c24c					vdu9EntryPoint:
579	.c24c	20 2d d1	jsr $d12d	                jsr handleColumn81
580	.c24f	b0 e4		bcs $c235	                bcs LC235
581	.c251	a9 00		lda #$00	                lda #$00
582	.c253	20 e9 c2	jsr $c2e9	                jsr LC2E9
583	.c256	90 1b		bcc $c273	                bcc LC273
584	.c258					LC258:
585	.c258	20 8f c3	jsr $c38f	                jsr LC38F
586	.c25b					vdu10EntryPoint:
587	.c25b	20 e2 e2	jsr $e2e2	                jsr testVDU5State
588	.c25e	d0 df		bne $c23f	                bne LC23F
589	.c260	18		clc		                clc
590	.c261	20 8e c8	jsr $c88e	                jsr LC88E
591	.c264	a9 08		lda #$08	                lda #$08
592	.c266	20 e9 c2	jsr $c2e9	                jsr LC2E9
593	.c269					LC269:
594	.c269	90 08		bcc $c273	                bcc LC273
595	.c26b	20 7b c3	jsr $c37b	                jsr LC37B
596	.c26e	90 03		bcc $c273	                bcc LC273
597	.c270	4c 51 d0	jmp $d051	                jmp LD051

599	.c273					LC273:
600	.c273	4c ed c6	jmp $c6ed	                jmp updateCRTCCursorAddress

602	.c276					LC276:
603	.c276	20 e2 e2	jsr $e2e2	                jsr testVDU5State
604	.c279	d0 ba		bne $c235	                bne LC235
605	.c27b	20 e9 c2	jsr $c2e9	                jsr LC2E9
606	.c27e	90 f3		bcc $c273	                bcc LC273
607	.c280	a9 01		lda #$01	                lda #$01
608	.c282	2c 66 03	bit $0366	                bit $0366
609	.c285	f0 d1		beq $c258	                beq LC258
610	.c287	38		sec		                sec
611	.c288	6e 6c 03	ror $036c	                ror $036C
612	.c28b					LC28B:
613	.c28b	60		rts		                rts

615	.c28c					LC28C:
616	.c28c	a9 06		lda #$06	                lda #$06
617	.c28e	20 87 c1	jsr $c187	                jsr LC187
618	.c291	f0 b6		beq $c249	                beq LC249
619	.c293	20 de c1	jsr $c1de	                jsr LC1DE
620	.c296					LC296:
621	.c296	a9 0e		lda #$0e	                lda #$0E
622	.c298	80 a7		bra $c241	                bra LC241

624	.c29a					vdu8EntryPoint:
625	.c29a	20 e2 e2	jsr $e2e2	                jsr testVDU5State
626	.c29d	d0 ed		bne $c28c	                bne LC28C
627	.c29f	4e 6c 03	lsr $036c	                lsr $036C
628	.c2a2	2c 6c 03	bit $036c	                bit $036C
629	.c2a5	70 e4		bvs $c28b	                bvs LC28B
630	.c2a7	a9 06		lda #$06	                lda #$06
631	.c2a9	20 e9 c2	jsr $c2e9	                jsr LC2E9
632	.c2ac	90 c5		bcc $c273	                bcc LC273
633	.c2ae	20 8f c3	jsr $c38f	                jsr LC38F
634	.c2b1					vdu11EntryPoint:
635	.c2b1	20 e2 e2	jsr $e2e2	                jsr testVDU5State
636	.c2b4	d0 e0		bne $c296	                bne LC296
637	.c2b6	ce 69 02	dec $0269	                dec pagedModeCounter
638	.c2b9	10 03		bpl $c2be	                bpl LC2BE
639	.c2bb	ee 69 02	inc $0269	                inc pagedModeCounter
640	.c2be					LC2BE:
641	.c2be	a9 0e		lda #$0e	                lda #$0E
642	.c2c0	20 e9 c2	jsr $c2e9	                jsr LC2E9
643	.c2c3	80 a4		bra $c269	                bra LC269

645						;-------------------------------------------------------------------------
646						;
647						; Set/reset cursor position, taking cursor flags into account.
648						;
649						; entry:
650						;
651						; (set only) A = cursor position
652						;
653						; X = cursorFlags bits: swapAxes, invertVertical, invertHorizontal
654						;
655	.c2c5					resetTextCursorXPositionWithCursorFlags:
656	.c2c5	a9 00		lda #$00	                lda #$00
657	.c2c7					setTextCursorXPositionWithCursorFlags:
658	.c2c7	18		clc		                clc
659	.c2c8	7c 67 c1	jmp ($c167,x)	                jmp (setTextCursorXPositionRoutinesTable,x)

661						;-------------------------------------------------------------------------

663	.c2cb					setTextCursorXPositionInvertHorizontal:
664	.c2cb	38		sec		                sec                          ;+1
665	.c2cc	49 ff		eor #$ff	                eor #$FF          ;^$ff+1 (i.e., adc will add the -ve)
666	.c2ce	6d 0a 03	adc $030a	                adc vduv.textWindowRight
667	.c2d1	80 03		bra $c2d6	                bra staTextCursorXPosition

669						;-------------------------------------------------------------------------

671	.c2d3					setTextCursorXPosition:
672	.c2d3	6d 08 03	adc $0308	                adc vduv.textWindowLeft
673	.c2d6					staTextCursorXPosition:
674	.c2d6	8d 18 03	sta $0318	                sta vduv.textCursorXPosition
675	.c2d9	60		rts		                rts

677						;-------------------------------------------------------------------------

679	.c2da					setTextCursorXPositionSwapAxesInvertVertical:
680	.c2da	38		sec		                sec
681	.c2db	49 ff		eor #$ff	                eor #$FF
682	.c2dd	6d 09 03	adc $0309	                adc vduv.textWindowBottom
683	.c2e0	80 03		bra $c2e5	                bra staTextCursorYPosition

685	.c2e2					setTextCursorXPositionSwapAxes:
686	.c2e2	6d 0b 03	adc $030b	                adc vduv.textWindowTop
687	.c2e5					staTextCursorYPosition:
688	.c2e5	8d 19 03	sta $0319	                sta vduv.textCursorYPosition
689	.c2e8	60		rts		                rts

691						;-------------------------------------------------------------------------

693	.c2e9					LC2E9:
694	.c2e9	4d 66 03	eor $0366	                eor $0366
695	.c2ec	29 0e		and #$0e	                and #$0E
696	.c2ee	aa		tax		                tax
697	.c2ef					LC2EF:
698	.c2ef	7c 77 c1	jmp ($c177,x)	                jmp (LC177,x)

700	.c2f2					LC2F2:
701	.c2f2	ad 08 03	lda $0308	                lda $0308
702	.c2f5	cd 18 03	cmp $0318	                cmp $0318
703	.c2f8	b0 3d		bcs $c337	                bcs LC337
704	.c2fa	ce 18 03	dec $0318	                dec $0318
705	.c2fd	38		sec		                sec
706	.c2fe	ad 4a 03	lda $034a	                lda $034A
707	.c301	ed 4f 03	sbc $034f	                sbc $034F
708	.c304	8d 4a 03	sta $034a	                sta $034A
709	.c307	85 d8		sta $d8		                sta ZMEMT+0
710	.c309	b0 2b		bcs $c336	                bcs LC336
711	.c30b	ce 4b 03	dec $034b	                dec $034B
712	.c30e	80 1b		bra $c32b	                bra LC32B

714	.c310					LC310:
715	.c310	ad 18 03	lda $0318	                lda $0318
716	.c313	cd 0a 03	cmp $030a	                cmp $030A
717	.c316	b0 1f		bcs $c337	                bcs LC337
718	.c318	ee 18 03	inc $0318	                inc $0318
719	.c31b	ad 4a 03	lda $034a	                lda $034A
720	.c31e	6d 4f 03	adc $034f	                adc $034F
721	.c321	8d 4a 03	sta $034a	                sta $034A
722	.c324	85 d8		sta $d8		                sta ZMEMT+0
723	.c326	90 0f		bcc $c337	                bcc LC337
724	.c328	ee 4b 03	inc $034b	                inc $034B
725	.c32b					LC32B:
726	.c32b	ad 4b 03	lda $034b	                lda $034B
727	.c32e					LC32E:
728	.c32e	10 04		bpl $c334	                bpl LC334
729	.c330	38		sec		                sec
730	.c331	ed 54 03	sbc $0354	                sbc $0354
731	.c334					LC334:
732	.c334	85 d9		sta $d9		                sta ZMEMT+1
733	.c336					LC336:
734	.c336	18		clc		                clc
735	.c337					LC337:
736	.c337	60		rts		                rts

738	.c338					LC338:
739	.c338	ad 0b 03	lda $030b	                lda $030B
740	.c33b	cd 19 03	cmp $0319	                cmp $0319
741	.c33e	b0 f7		bcs $c337	                bcs LC337
742	.c340	ce 19 03	dec $0319	                dec $0319
743	.c343	38		sec		                sec
744	.c344	ad 4a 03	lda $034a	                lda $034A
745	.c347	ed 52 03	sbc $0352	                sbc $0352
746	.c34a	8d 4a 03	sta $034a	                sta $034A
747	.c34d	85 d8		sta $d8		                sta ZMEMT+0
748	.c34f	ad 4b 03	lda $034b	                lda $034B
749	.c352	ed 53 03	sbc $0353	                sbc $0353
750	.c355	8d 4b 03	sta $034b	                sta $034B
751	.c358	80 d4		bra $c32e	                bra LC32E

753	.c35a					LC35A:
754	.c35a	ad 19 03	lda $0319	                lda $0319
755	.c35d	cd 09 03	cmp $0309	                cmp $0309
756	.c360	b0 d5		bcs $c337	                bcs LC337
757	.c362	ee 19 03	inc $0319	                inc $0319
758	.c365	ad 4a 03	lda $034a	                lda $034A
759	.c368	6d 52 03	adc $0352	                adc $0352
760	.c36b	8d 4a 03	sta $034a	                sta $034A
761	.c36e	85 d8		sta $d8		                sta ZMEMT+0
762	.c370	ad 4b 03	lda $034b	                lda $034B
763	.c373	6d 53 03	adc $0353	                adc $0353
764	.c376	8d 4b 03	sta $034b	                sta $034B
765	.c379	80 b3		bra $c32e	                bra LC32E

767	.c37b					LC37B:
768	.c37b	a9 10		lda #$10	                lda #$10
769	.c37d	2c 66 03	bit $0366	                bit $0366
770	.c380	d0 0d		bne $c38f	                bne LC38F
771	.c382	8a		txa		                txa
772	.c383	49 06		eor #$06	                eor #$06
773	.c385	48		pha		                pha
774	.c386	a9 42		lda #$42	                lda #$42
775	.c388	24 d0		bit $d0		                bit STATE
776	.c38a	f0 16		beq $c3a2	                beq LC3A2
777	.c38c	70 09		bvs $c397	                bvs LC397
778	.c38e	68		pla		                pla
779	.c38f					LC38F:
780	.c38f	20 c5 c2	jsr $c2c5	                jsr resetTextCursorXPositionWithCursorFlags
781	.c392	20 fa cc	jsr $ccfa	                jsr updateZMEMTWithTextCursorPosition
782	.c395	18		clc		                clc
783	.c396	60		rts		                rts

785	.c397					LC397:
786	.c397	20 be e2	jsr $e2be	                jsr exchangeEditCursorPositionAndTextCursorPosition
787	.c39a	fa		plx		                plx
788	.c39b	da		phx		                phx
789	.c39c	20 ef c2	jsr $c2ef	                jsr LC2EF
790	.c39f	20 be e2	jsr $e2be	                jsr exchangeEditCursorPositionAndTextCursorPosition
791	.c3a2					LC3A2:
792	.c3a2	fa		plx		                plx
793	.c3a3	38		sec		                sec
794	.c3a4					LC3A4:
795	.c3a4	60		rts		                rts

797	.c3a5					vdu28EntryPoint:
798	.c3a5	ae 55 03	ldx $0355	                ldx $0355
799	.c3a8	ad 21 03	lda $0321	                lda $0321
800	.c3ab	cd 23 03	cmp $0323	                cmp $0323
801	.c3ae	90 f4		bcc $c3a4	                bcc LC3A4
802	.c3b0	dd 11 e1	cmp $e111,x	                cmp modeMaxRow,x
803	.c3b3	f0 02		beq $c3b7	                beq LC3B7
804	.c3b5	b0 ed		bcs $c3a4	                bcs LC3A4
805	.c3b7					LC3B7:
806	.c3b7	ad 22 03	lda $0322	                lda $0322
807	.c3ba	dd 19 e1	cmp $e119,x	                cmp modeMaxColumn,x
808	.c3bd	f0 03		beq $c3c2	                beq LC3C2
809	.c3bf	b0 e3		bcs $c3a4	                bcs LC3A4
810	.c3c1	38		sec		                sec
811	.c3c2					LC3C2:
812	.c3c2	ed 20 03	sbc $0320	                sbc $0320
813	.c3c5	90 dd		bcc $c3a4	                bcc LC3A4
814	.c3c7	20 80 c7	jsr $c780	                jsr setTextWindowWidthInBytes
815	.c3ca	a9 08		lda #$08	                lda #$08
816	.c3cc	04 d0		tsb $d0		                tsb STATE
817	.c3ce	a2 20		ldx #$20	                ldx #VDUVariables.queueEnd-4
818	.c3d0	a0 08		ldy #$08	                ldy #VDUVariables.textWindowLeft
819	.c3d2	20 1e c9	jsr $c91e	                jsr copyFourBytesWithinVDUVariables
820	.c3d5	20 be e2	jsr $e2be	                jsr exchangeEditCursorPositionAndTextCursorPosition
821	.c3d8	20 da cc	jsr $ccda	                jsr LCCDA
822	.c3db	90 03		bcc $c3e0	                bcc LC3E0
823	.c3dd	20 e8 c3	jsr $c3e8	                jsr LC3E8
824	.c3e0					LC3E0:
825	.c3e0	20 be e2	jsr $e2be	                jsr exchangeEditCursorPositionAndTextCursorPosition
826	.c3e3	20 da cc	jsr $ccda	                jsr LCCDA
827	.c3e6	90 1f		bcc $c407	                bcc LC407
828	.c3e8					LC3E8:
829	.c3e8	a5 d0		lda $d0		                lda STATE
830	.c3ea	48		pha		                pha
831	.c3eb	29 df		and #$df	                and #$DF
832	.c3ed	85 d0		sta $d0		                sta STATE
833	.c3ef	20 7c c4	jsr $c47c	                jsr vdu30EntryPoint
834	.c3f2	68		pla		                pla
835	.c3f3	85 d0		sta $d0		                sta STATE
836	.c3f5	60		rts		                rts

838	.c3f6					vdu13EntryPoint:
839	.c3f6	ad 66 03	lda $0366	                lda $0366
840	.c3f9	29 0e		and #$0e	                and #$0E
841	.c3fb	aa		tax		                tax
842	.c3fc	20 e2 e2	jsr $e2e2	                jsr testVDU5State
843	.c3ff	d0 09		bne $c40a	                bne LC40A
844	.c401	4e 6c 03	lsr $036c	                lsr $036C
845	.c404	20 8f c3	jsr $c38f	                jsr LC38F
846	.c407					LC407:
847	.c407	4c ed c6	jmp $c6ed	                jmp updateCRTCCursorAddress

849	.c40a					LC40A:
850	.c40a	20 de c1	jsr $c1de	                jsr LC1DE
851	.c40d	4c df c4	jmp $c4df	                jmp LC4DF

853	.c410					LC410:
854	.c410	20 7c c4	jsr $c47c	                jsr vdu30EntryPoint

856						;-------------------------------------------------------------------------
857						;
858						; VDU 16 (&10) Clear graphics window [MasRef E.3-7]
859						;
860	.c413					vdu16EntryPoint:
861	.c413	ad 61 03	lda $0361	                lda vduv.pixelsPerByteMinusOne
862	.c416	f0 8c		beq $c3a4	                beq LC3A4                    ;taken if MODE 7
863	.c418	a2 00		ldx #$00	                ldx #VDUVariables.graphicsWindowPixelsLeft
864	.c41a	20 02 c9	jsr $c902	                jsr copyEightBytesToWorkspace28
865	.c41d	20 51 c9	jsr $c951	                jsr prepareForPlotBackground
866	.c420					LC420:
867	.c420	a2 2a		ldx #$2a	                ldx #$2A
868	.c422	a0 2e		ldy #$2e	                ldy #$2E
869	.c424	20 c2 e2	jsr $e2c2	                jsr exchangeTwoVDUBytes
870	.c427					LC427:
871	.c427	a2 28		ldx #$28	                ldx #$28
872	.c429	a0 2c		ldy #$2c	                ldy #$2C
873	.c42b	20 e8 da	jsr $dae8	                jsr LDAE8
874	.c42e	ad 2a 03	lda $032a	                lda $032A
875	.c431	d0 03		bne $c436	                bne LC436
876	.c433	ce 2b 03	dec $032b	                dec $032B
877	.c436					LC436:
878	.c436	ce 2a 03	dec $032a	                dec $032A
879	.c439	ad 2a 03	lda $032a	                lda $032A
880	.c43c	cd 2e 03	cmp $032e	                cmp $032E
881	.c43f	ad 2b 03	lda $032b	                lda $032B
882	.c442	ed 2f 03	sbc $032f	                sbc $032F
883	.c445	10 e0		bpl $c427	                bpl LC427
884	.c447	60		rts		                rts

886	.c448					LC448:
887	.c448	a2 20		ldx #$20	                ldx #VDUVariables.queueEnd-4
888	.c44a	20 e6 c8	jsr $c8e6	                jsr prepareAABB
889	.c44d	80 d1		bra $c420	                bra LC420

891						;-------------------------------------------------------------------------
892						;
893						; VDU 12 (&0C) Clear text window [MasRef E.3-5]
894						;
895	.c44f					vdu12EntryPoint:
896	.c44f	a9 20		lda #$20	                lda #STATE.isVDU5
897	.c451	24 d0		bit $d0		                bit STATE
898	.c453	d0 bb		bne $c410	                bne LC410                    ;taken if VDU 5 mode
899	.c455	a9 08		lda #$08	                lda #STATE.isTextWindow
900	.c457	24 d0		bit $d0		                bit STATE
901	.c459	d0 03		bne $c45e	                bne clearTextWindow                    ;taken if text window
902	.c45b	4c 66 c8	jmp $c866	                jmp clsFastPath

904						                ; Clear screen within text window
905						                ; -------------------------------
906	.c45e					clearTextWindow:
907	.c45e	20 08 c9	jsr $c908	                jsr copyTextWindowWidthInBytesToWorkspace28
908	.c461	ae 08 03	ldx $0308	                ldx vduv.textWindowLeft
909	.c464	8e 18 03	stx $0318	                stx vduv.textCursorXPosition
910	.c467	ae 0b 03	ldx $030b	                ldx vduv.textWindowTop
911	.c46a					clearTextWindowRowsLoop:
912	.c46a	8e 19 03	stx $0319	                stx vduv.textCursorYPosition
913	.c46d	20 fa cc	jsr $ccfa	                jsr updateZMEMTWithTextCursorPosition
914	.c470	20 e8 ca	jsr $cae8	                jsr LCAE8
915	.c473	ae 19 03	ldx $0319	                ldx vduv.textCursorYPosition
916	.c476	ec 09 03	cpx $0309	                cpx vduv.textWindowBottom
917	.c479	e8		inx		                inx
918	.c47a	90 ee		bcc $c46a	                bcc clearTextWindowRowsLoop

920						;-------------------------------------------------------------------------
921						;
922						; VDU 30 (&1E) Home cursor [MasRef E.3-36]
923						;
924	.c47c					vdu30EntryPoint:
925						                ; pretend it's VDU 31,0,0
926	.c47c	9c 23 03	stz $0323	                stz vduv.queueEnd-1
927	.c47f	9c 22 03	stz $0322	                stz vduv.queueEnd-2

929						;-------------------------------------------------------------------------
930						;
931						; VDU 31 (&1F) Tab cursor [MasRef E.3-36]
932						;
933	.c482					vdu31EntryPoint:
934	.c482	ad 66 03	lda $0366	                lda vduv.cursorFlags
935	.c485	29 0e		and #$0e	                and #vduv.cursorFlags.swapAxes|vduv.cursorFlags.invertVertical|vduv.cursorFlags.invertHorizontal
936	.c487	aa		tax		                tax
937	.c488					LC488:
938	.c488	20 e2 e2	jsr $e2e2	                jsr testVDU5State
939	.c48b	d0 42		bne $c4cf	                bne LC4CF                    ;taken if VDU 5
940	.c48d	ad 18 03	lda $0318	                lda vduv.textCursorXPosition
941	.c490	48		pha		                pha                          ;save old X pos
942	.c491	ad 19 03	lda $0319	                lda vduv.textCursorYPosition
943	.c494	48		pha		                pha                          ;save old Y pos
944	.c495	ad 22 03	lda $0322	                lda vduv.queueEnd-2          ;X coordinate
945	.c498	20 c7 c2	jsr $c2c7	                jsr setTextCursorXPositionWithCursorFlags
946	.c49b	da		phx		                phx                          ;save true cursorFlags bits
947	.c49c	8a		txa		                txa
948	.c49d	49 08		eor #$08	                eor #vduv.cursorFlags.swapAxes ;cheekily do the other axis by just changing the cursor flags
949	.c49f	aa		tax		                tax
950	.c4a0	ad 23 03	lda $0323	                lda vduv.queueEnd-1          ;Y coordinate
951	.c4a3	20 d7 cc	jsr $ccd7	                jsr LCCD7
952	.c4a6	fa		plx		                plx                    ;restore true cursorFlags bits
953	.c4a7	90 11		bcc $c4ba	                bcc LC4BA              ;taken if no scrolling required
954	.c4a9	a9 01		lda #$01	                lda #vduv.cursorFlags.scrollProtect
955	.c4ab	2c 66 03	bit $0366	                bit $0366
956	.c4ae	f0 11		beq $c4c1	                beq LC4C1                 ;taken if scroll protect off

958						                ; Wrap text cursor X.
959	.c4b0	ad 22 03	lda $0322	                lda vduv.queueEnd-2       ;X coordinate
960	.c4b3	3a		dec a		                dec a
961	.c4b4	20 d7 cc	jsr $ccd7	                jsr LCCD7
962	.c4b7	b0 08		bcs $c4c1	                bcs LC4C1
963	.c4b9	38		sec		                sec
964	.c4ba					LC4BA:
965	.c4ba	6e 6c 03	ror $036c	                ror vduv.column81
966	.c4bd	68		pla		                pla                          ;discard old Y pos
967	.c4be	68		pla		                pla                          ;discard old X pos
968	.c4bf	80 0b		bra $c4cc	                bra LC4CC

970	.c4c1					LC4C1:
971	.c4c1	68		pla		                pla
972	.c4c2	8d 19 03	sta $0319	                sta vduv.textCursorYPosition ;restore old Y pos
973	.c4c5	68		pla		                pla
974	.c4c6	8d 18 03	sta $0318	                sta vduv.textCursorXPosition ;restore old X pos
975	.c4c9	20 fa cc	jsr $ccfa	                jsr updateZMEMTWithTextCursorPosition
976	.c4cc					LC4CC:
977	.c4cc	4c ed c6	jmp $c6ed	                jmp updateCRTCCursorAddress

979	.c4cf					LC4CF:
980	.c4cf	ad 22 03	lda $0322	                lda $0322
981	.c4d2	20 e0 c1	jsr $c1e0	                jsr LC1E0
982	.c4d5	8a		txa		                txa
983	.c4d6	49 08		eor #$08	                eor #$08
984	.c4d8	aa		tax		                tax
985	.c4d9	ad 23 03	lda $0323	                lda $0323
986	.c4dc	20 e0 c1	jsr $c1e0	                jsr LC1E0
987	.c4df					LC4DF:
988	.c4df	a0 10		ldy #$10	                ldy #$10
989	.c4e1	20 1c c9	jsr $c91c	                jsr copyGraphicsCursorPixels
990	.c4e4	a2 02		ldx #$02	                ldx #$02
991	.c4e6	a0 02		ldy #$02	                ldy #$02
992	.c4e8	20 fc c4	jsr $c4fc	                jsr LC4FC
993	.c4eb	a2 00		ldx #$00	                ldx #$00
994	.c4ed	a0 04		ldy #$04	                ldy #$04
995	.c4ef	ad 61 03	lda $0361	                lda $0361
996	.c4f2					LC4F2:
997	.c4f2	88		dey		                dey
998	.c4f3	4a		lsr a		                lsr a
999	.c4f4	d0 fc		bne $c4f2	                bne LC4F2
1000	.c4f6	ad 56 03	lda $0356	                lda $0356
1001	.c4f9	f0 01		beq $c4fc	                beq LC4FC
1002	.c4fb	c8		iny		                iny
1003	.c4fc					LC4FC:
1004	.c4fc	1e 10 03	asl $0310,x	                asl $0310,x
1005	.c4ff	3e 11 03	rol $0311,x	                rol $0311,x
1006	.c502	88		dey		                dey
1007	.c503	d0 f7		bne $c4fc	                bne LC4FC
1008	.c505	38		sec		                sec
1009	.c506	20 0a c5	jsr $c50a	                jsr LC50A
1010	.c509	e8		inx		                inx
1011	.c50a					LC50A:
1012	.c50a	bd 10 03	lda $0310,x	                lda $0310,x
1013	.c50d	fd 0c 03	sbc $030c,x	                sbc $030C,x
1014	.c510	9d 10 03	sta $0310,x	                sta $0310,x
1015	.c513	60		rts		                rts

1017						;-------------------------------------------------------------------------
1018						;
1019						; VDU 14 (&0E) Page mode on [MasRef E.3-6]
1020						;
1021	.c514					vdu14EntryPoint:
1022	.c514	9c 69 02	stz $0269	                stz pagedModeCounter
1023	.c517	a9 91		lda #$91	                lda #$91

1025						;-------------------------------------------------------------------------
1026						;
1027						; VDU 21 (&15) Disable VDU driver [MasRef E.3-11]
1028						;
1029	.c519					vdu21EntryPoint:
1030	.c519	49 95		eor #$95	                eor #$95
1031	.c51b					LC51B:
1032	.c51b	04 d0		tsb $d0		                tsb STATE
1033	.c51d	60		rts		                rts

1035						;-------------------------------------------------------------------------
1036						;
1037						; VDU 4 (&04) Print at text cursor [MasRef E.3-2]
1038						;
1039	.c51e					vdu4EntryPoint:
1040	.c51e	ad 61 03	lda $0361	                lda $0361
1041	.c521	f0 09		beq $c52c	                beq LC52C
1042	.c523	20 50 cf	jsr $cf50	                jsr showCursor
1043	.c526	a9 2b		lda #$2b	                lda #$2B

1045						                ; fall through to vdu15EntryPoint

1047						;-------------------------------------------------------------------------
1048						;
1049						; VDU 15 (&0F) Page mode off [MasRef E.3-6]
1050						;
1051	.c528					vdu15EntryPoint:
1052	.c528	49 0b		eor #$0b	                eor #$0B
1053	.c52a	14 d0		trb $d0		                trb STATE
1054	.c52c					LC52C:
1055	.c52c	60		rts		                rts

1057						;-------------------------------------------------------------------------
1058						;
1059						; VDU 5 (&05) Print text at graphics cursor [MasRef E.3-3]
1060						;
1061	.c52d					vdu5EntryPoint:
1062	.c52d	ad 61 03	lda $0361	                lda $0361
1063	.c530	f0 fa		beq $c52c	                beq LC52C
1064	.c532	a9 20		lda #$20	                lda #$20
1065	.c534	20 53 cf	jsr $cf53	                jsr setCRTCRegister10
1066	.c537	80 e2		bra $c51b	                bra LC51B

1068						;-------------------------------------------------------------------------
1069						;
1070						; VDU 17 (&11) Define text colour [MasRef E.3-7]
1071						;
1072	.c539					vdu17EntryPoint:
1073	.c539	a0 00		ldy #$00	                ldy #$00
1074	.c53b	ad 23 03	lda $0323	                lda $0323
1075	.c53e	10 01		bpl $c541	                bpl LC541
1076	.c540	c8		iny		                iny
1077	.c541					LC541:
1078	.c541	2d 60 03	and $0360	                and $0360
1079	.c544	85 da		sta $da		                sta $DA
1080	.c546	ad 60 03	lda $0360	                lda $0360
1081	.c549	f0 18		beq $c563	                beq LC563
1082	.c54b	29 07		and #$07	                and #$07
1083	.c54d	18		clc		                clc
1084	.c54e	65 da		adc $da		                adc $DA
1085	.c550	aa		tax		                tax
1086	.c551	bd 5b e1	lda $e15b,x	                lda solidColoursTable-1,x
1087	.c554	99 57 03	sta $0357,y	                sta $0357,y
1088	.c557	ad 57 03	lda $0357	                lda $0357
1089	.c55a	49 ff		eor #$ff	                eor #$FF
1090	.c55c	85 d3		sta $d3		                sta ZEOR
1091	.c55e	4d 58 03	eor $0358	                eor $0358
1092	.c561	85 d2		sta $d2		                sta ZORA
1093	.c563					LC563:
1094	.c563	60		rts		                rts

1096						;-------------------------------------------------------------------------
1097						;
1098						; VDU 18 (&12) Define graphics colour [MasRef E.3-7]
1099						;
1100	.c564					vdu18EntryPoint:
1101	.c564	a0 00		ldy #$00	                ldy #$00                    ;assume setting foreground
1102	.c566	ad 23 03	lda $0323	                lda vduv.queueEnd-1         ;get colour
1103	.c569	10 01		bpl $c56c	                bpl +                     ;taken if setting foreground
1104	.c56b	c8		iny		                iny                       ;setting background
1105	.c56c					+
1106	.c56c	2d 60 03	and $0360	                and vduv.numberOfLogicalColoursMinusOne
1107	.c56f	99 6d 03	sta $036d,y	                sta vduv.foregroundGraphicsColour,y
1108	.c572	ad 22 03	lda $0322	                lda vduv.queueEnd-2          ;get GCOL mode
1109	.c575	99 5b 03	sta $035b,y	                sta vduv.foregroundGCOLMode,y
1110	.c578	29 f0		and #$f0	                and #$F0                     ;non-zero if ECF
1111	.c57a	99 6a 03	sta $036a,y	                sta vduv.isForegroundECF,y
1112	.c57d					initializeCurrentECFPatterns:
1113	.c57d	ad 5b 03	lda $035b	                lda vduv.foregroundGCOLMode
1114	.c580	ae 6d 03	ldx $036d	                ldx vduv.foregroundGraphicsColour
1115	.c583	a0 00		ldy #$00	                ldy #andy.fgECFPattern-andy.currentECFPatterns
1116	.c585	20 90 c5	jsr $c590	                jsr initializeCurrentECFPattern
1117	.c588	ad 5c 03	lda $035c	                lda vduv.backgroundGCOLMode
1118	.c58b	ae 6e 03	ldx $036e	                ldx vduv.backgroundGraphicsColour
1119	.c58e	a0 08		ldy #$08	                ldy #andy.bgECFPattern-andy.currentECFPatterns
1120	.c590					initializeCurrentECFPattern:
1121	.c590	29 f0		and #$f0	                and #$F0                     ;GCOL mode ECF bits
1122	.c592	d0 18		bne $c5ac	                bne initializeECFPatternFromPattern

1124	.c594					initializeECFPatternFromColour:
1125	.c594	86 da		stx $da		                stx ZTEMP+0                  ;colour low bits
1126	.c596	ad 60 03	lda $0360	                lda vduv.numberOfLogicalColoursMinusOne
1127	.c599	29 07		and #$07	                and #$07
1128	.c59b	18		clc		                clc
1129	.c59c	65 da		adc $da		                adc ZTEMP+0
1130	.c59e	aa		tax		                tax
1131						                ; use solid colour as ECF "pattern".
1132	.c59f	bd 5b e1	lda $e15b,x	                lda solidColoursTable-1,x
1133	.c5a2	a2 07		ldx #$07	                ldx #$07
1134	.c5a4					-
1135	.c5a4	99 20 88	sta $8820,y	                sta andy.fgECFPattern,y
1136	.c5a7	c8		iny		                iny
1137	.c5a8	ca		dex		                dex
1138	.c5a9	10 f9		bpl $c5a4	                bpl -
1139	.c5ab	60		rts		                rts

1141	.c5ac					initializeECFPatternFromPattern:
1142	.c5ac	4a		lsr a		                lsr a                        ;(index+1)*8
1143	.c5ad	aa		tax		                tax
1144	.c5ae	a9 07		lda #$07	                lda #$07
1145	.c5b0	85 da		sta $da		                sta ZTEMP+0
1146	.c5b2					-
1147	.c5b2	bd f8 87	lda $87f8,x	                lda andy.ecfPatterns-8,x     ;-8 due to index+1 above
1148	.c5b5	99 20 88	sta $8820,y	                sta andy.fgECFPattern,y
1149	.c5b8	e8		inx		                inx
1150	.c5b9	c8		iny		                iny
1151	.c5ba	c6 da		dec $da		                dec ZTEMP+0
1152	.c5bc	10 f4		bpl $c5b2	                bpl -
1153	.c5be	60		rts		                rts

1155						;-------------------------------------------------------------------------
1156						;
1157						; VDU 20 (&14) Restore default logical colours [MasRef E.3-10]
1158						;
1159	.c5bf					setBackgroundTextColourForTeletext:
1160	.c5bf	a9 20		lda #$20	                lda #' '
1161	.c5c1	8d 58 03	sta $0358	                sta vduv.backgroundTextColour
1162	.c5c4	60		rts		                rts

1164	.c5c5					vdu20EntryPoint:
1165	.c5c5	a2 05		ldx #$05	                ldx #$05
1166	.c5c7					-
1167	.c5c7	9e 57 03	stz $0357,x	                stz vduv.foregroundTextColour,x
1168	.c5ca	ca		dex		                dex
1169	.c5cb	10 fa		bpl $c5c7	                bpl -
1170	.c5cd	9c 6e 03	stz $036e	                stz vduv.backgroundGraphicsColour
1171	.c5d0	9c 6b 03	stz $036b	                stz vduv.isBackgroundECF
1172	.c5d3	a9 ff		lda #$ff	                lda #%11111111
1173	.c5d5	ae 60 03	ldx $0360	                ldx vduv.numberOfLogicalColoursMinusOne
1174	.c5d8	f0 e5		beq $c5bf	                beq setBackgroundTextColourForTeletext
1175	.c5da	e0 0f		cpx #$0f	                cpx #$0F
1176	.c5dc	d0 02		bne $c5e0	                bne +                        ;taken unless MODE 2
1177	.c5de	a9 3f		lda #$3f	                lda #%00111111               ;MODE 2 default foreground colour is 7
1178	.c5e0					+
1179	.c5e0	8d 57 03	sta $0357	                sta vduv.foregroundTextColour
1180	.c5e3	49 ff		eor #$ff	                eor #$FF
1181	.c5e5	85 d2		sta $d2		                sta ZORA
1182	.c5e7	85 d3		sta $d3		                sta ZEOR
1183	.c5e9	8a		txa		                txa
1184	.c5ea	29 07		and #$07	                and #$07
1185	.c5ec	8d 6d 03	sta $036d	                sta vduv.foregroundGraphicsColour
1186	.c5ef	9c 6a 03	stz $036a	                stz vduv.isForegroundECF
1187	.c5f2	da		phx		                phx                          ;save numberOfLogicalColoursMinusOne
1188	.c5f3	20 7d c5	jsr $c57d	                jsr initializeCurrentECFPatterns
1189	.c5f6	fa		plx		                plx                          ;restore numberOfLogicalColoursMinusOne
1190	.c5f7	8e 1f 03	stx $031f	                stx vduv.queueEnd-5          ;Prepare VDU19,<max logical colour>
1191	.c5fa	e0 03		cpx #$03	                cpx #$03
1192	.c5fc	f0 11		beq $c60f	                beq reset4Colours            ;taken if MODE 1/5
1193	.c5fe	90 20		bcc $c620	                bcc reset2Colours            ;taken if MODE 0/3/4/6
1194	.c600					reset16Colours:
1195	.c600	8e 20 03	stx $0320	                stx vduv.queueEnd-4          ;start with VDU19,15,15,_,_,_
1196	.c603					-
1197	.c603	20 2d c6	jsr $c62d	                jsr vdu19EntryPoint
1198	.c606	ce 20 03	dec $0320	                dec vduv.queueEnd-4
1199	.c609	ce 1f 03	dec $031f	                dec vduv.queueEnd-5
1200	.c60c	10 f5		bpl $c603	                bpl -
1201	.c60e	60		rts		                rts

1203	.c60f					reset4Colours:
1204	.c60f	a2 07		ldx #$07	                ldx #$07
1205	.c611	8e 20 03	stx $0320	                stx vduv.queueEnd-4          ;start with VDU19,3,7,_,_,_
1206	.c614					-
1207	.c614	20 2d c6	jsr $c62d	                jsr vdu19EntryPoint          ;2,3, then 1,1, then 0,0
1208	.c617	4e 20 03	lsr $0320	                lsr vduv.queueEnd-4
1209	.c61a	ce 1f 03	dec $031f	                dec vduv.queueEnd-5
1210	.c61d	10 f5		bpl $c614	                bpl -
1211	.c61f	60		rts		                rts

1213	.c620					reset2Colours:
1214	.c620	a2 07		ldx #$07	                ldx #$07
1215	.c622	20 2a c6	jsr $c62a	                jsr +                        ;VDU19,1,7,_,_,_
1216	.c625	a2 00		ldx #$00	                ldx #$00
1217	.c627	9c 1f 03	stz $031f	                stz vduv.queueEnd-5          ;VDU19,0,0,_,_,_
1218	.c62a					+
1219	.c62a	8e 20 03	stx $0320	                stx vduv.queueEnd-4          ;VDU19,N,X,_,_,_

1221						                ; fall through to VDU19

1223						;-------------------------------------------------------------------------
1224						;
1225						; VDU 19 (&13) Define logical colour [MasRef E.3-9]
1226						;
1227	.c62d					vdu19EntryPoint:
1228	.c62d	08		php		                php
1229	.c62e	78		sei		                sei
1230	.c62f	ad 1f 03	lda $031f	                lda vduv.queueEnd-5          ;get logical colour
1231	.c632	2d 60 03	and $0360	                and vduv.numberOfLogicalColoursMinusOne ;apply logical colour limit
1232	.c635	aa		tax		                tax                        ;X = clamped logical colour
1233	.c636	ad 20 03	lda $0320	                lda vduv.queueEnd-4        ;get physical colour
1234	.c639					LC639:
1235	.c639	29 0f		and #$0f	                and #$0F                     ;apply physical colour limit
1236	.c63b	9d 6f 03	sta $036f,x	                sta vduv.currentPalette,x    ;update palette
1237	.c63e	a8		tay		                tay                          ;Y = physical colour
1238	.c63f	ad 60 03	lda $0360	                lda vduv.numberOfLogicalColoursMinusOne
1239	.c642	85 fa		sta $fa		                sta SEIWKA
1240	.c644	c9 03		cmp #$03	                cmp #$03 ;Z=1 C=1 if 4 colour; Z=0 C=1 if 16 colour; Z=0 C=0 if 2 colour
1241	.c646	08		php		                php      ;save flags
1242	.c647	8a		txa		                txa                          ;A = logical colour

1244						                ;put the logical colour value in the top 1, 2 or 4
1245						                ;bits of SEIWKA, depending on the colour depth.
1246						                ;
1247						                ; 2 colours: turn %0000000a into %a0000000
1248						                ; 4 colours: turn %000000ab into %ab000000
1249						                ;16 colours: turn %0000abcd into %abcd0000
1250	.c648					-
1251	.c648	4a		lsr a		                lsr a
1252	.c649	66 fa		ror $fa		                ror SEIWKA
1253	.c64b	b0 fb		bcs $c648	                bcs -
1254	.c64d	06 fa		asl $fa		                asl SEIWKA

1256	.c64f	98		tya		                tya                          ;A = physical colour
1257	.c650	05 fa		ora $fa		                ora SEIWKA                   ;mix in logical colour
1258	.c652	aa		tax		                tax                          ;X = VPALETTE value
1259	.c653	a0 f0		ldy #$f0	                ldy #$F0 ;counts up to zero - counter for setting
1260						                         ;multiple logical colours [AUG p380]
1261	.c655					LC655:
1262	.c655	28		plp		                plp                          ;restore flags
1263	.c656	08		php		                php                          ;save flags
1264	.c657	d0 03		bne $c65c	                bne +                     ;taken if 2 colour/16 colour
1265	.c659	20 6f c6	jsr $c66f	                jsr fixUpVPALETTEFor4Colours
1266	.c65c					+
1267	.c65c	20 0f f3	jsr $f30f	                jsr writeVPALETTE
1268	.c65f	18		clc		                clc
1269	.c660	98		tya		                tya
1270	.c661	6d 60 03	adc $0360	                adc vduv.numberOfLogicalColoursMinusOne
1271	.c664	a8		tay		                tay
1272	.c665	8a		txa		                txa
1273	.c666	69 10		adc #$10	                adc #$10                     ;next logical colour
1274	.c668	aa		tax		                tax
1275	.c669	c8		iny		                iny                          ;Y+=numberOfLogicalColours
1276	.c66a	d0 e9		bne $c655	                bne LC655                    ;all logical colours set once zero
1277	.c66c	28		plp		                plp
1278	.c66d	28		plp		                plp
1279	.c66e	60		rts		                rts

1281	.c66f					fixUpVPALETTEFor4Colours:
1282	.c66f	2a		rol a		                rol a                        ;A BCDabcd1
1283	.c670	85 da		sta $da		                sta ZTEMP+0                  ;  BCDabcd1
1284	.c672	2a		rol a		                rol a                        ;B CDabcd1A
1285	.c673	2a		rol a		                rol a                        ;C Dabcd1AB
1286	.c674	08		php		                php                          ;C
1287	.c675	26 da		rol $da		                rol ZTEMP+0                  ;B CDabcd1C
1288	.c677	6a		ror a		                ror a                        ;B BDabcd1A
1289	.c678	28		plp		                plp                          ;C BDabcd1A
1290	.c679	6a		ror a		                ror a                        ;A CBDabcd1
1291	.c67a	6a		ror a		                ror a                        ;1 ACBDabcd
1292	.c67b	60		rts		                rts                          ;

1294						;-------------------------------------------------------------------------
1295						;
1296						; VDU 23 (&17) Various functions [MasRef E.3-12]
1297						;
1298	.c67c					vdu23EntryPoint:
1299	.c67c	ad 1b 03	lda $031b	                lda vduv.queueEnd-9           ;get VDU 23 code
1300	.c67f	c9 20		cmp #$20	                cmp #$20
1301	.c681	90 0e		bcc $c691	                bcc LC691         ;branch taken if <32 - i.e., special

1303						                ; copy the 8 bytes of character definition to the
1304						                ; appropriate place.
1305	.c683	20 3c e2	jsr $e23c	                jsr getSoftCharacterDefinitionAddress
1306	.c686	a0 07		ldy #$07	                ldy #$07
1307	.c688					LC688:
1308	.c688	b9 1c 03	lda $031c,y	                lda vduv.queueEnd-8,y
1309	.c68b	91 de		sta ($de),y	                sta ($DE),y
1310	.c68d	88		dey		                dey
1311	.c68e	10 f8		bpl $c688	                bpl LC688
1312	.c690	60		rts		                rts

1314	.c691					LC691:
1315	.c691	0a		asl a		                asl a
1316	.c692	aa		tax		                tax
1317	.c693	4a		lsr a		                lsr a
1318	.c694	c9 11		cmp #$11	                cmp #$11
1319	.c696	b0 0f		bcs $c6a7	                bcs callVDUV    ;call with C=1 - invalid code [MasRef
1320						                                ;E.3-19]
1321	.c698	7c 79 e0	jmp ($e079,x)	                jmp (vdu23EntryPointTable,x)

1323						;-------------------------------------------------------------------------
1324						;
1325						; VDU 25 (&19) PLOT commands [MasRef E.3-21]
1326						;
1327	.c69b					vdu25EntryPoint:
1328	.c69b	ae 61 03	ldx $0361	                ldx vduv.pixelsPerByteMinusOne
1329	.c69e	f0 03		beq $c6a3	                beq callVDUVForPLOT          ;non-graphics PLOT
1330	.c6a0	4c 46 d1	jmp $d146	                jmp handlePLOT

1332						;-------------------------------------------------------------------------
1333						;
1334						; Call VDUV for a PLOT call, either to handle non-graphics PLOT
1335						; [MasRef E.3-21] or PLOT 240-255 [MasRef E.3-34].
1336						;
1337	.c6a3					callVDUVForPLOT:
1338	.c6a3	ad 1f 03	lda $031f	                lda vduv.queueEnd-5          ;get PLOT code
1339	.c6a6	18		clc		                clc ;call with C=0 - non-graphics PLOT [MasRef E.3-21]

1341						;-------------------------------------------------------------------------
1342						;
1343						; Call VDUV.
1344						;
1345	.c6a7					callVDUV:
1346						                .if version<350
1348						                .else
1349	.c6a7	4c f3 e2	jmp $e2f3	                jmp LE2F3
1350						                .endif

1352						;-------------------------------------------------------------------------
1353						;
1354						; VDU 26 (&1A) Restore default windows [MasRef E.3-34]
1355						;
1356	.c6aa					vdu26EntryPoint:
1357	.c6aa	a2 2c		ldx #$2c	                ldx #VDUVariables.workspace._2C
1358	.c6ac					-
1359	.c6ac	9e 00 03	stz $0300,x	                stz vduv,x                    ;reset workspace
1360	.c6af	ca		dex		                dex
1361	.c6b0	10 fa		bpl $c6ac	                bpl -

1363	.c6b2	20 b2 e2	jsr $e2b2	                jsr getDefaultBoundsForCurrentScreenMODE
1364	.c6b5	8e 0a 03	stx $030a	                stx vduv.textWindowRight
1365	.c6b8	8c 09 03	sty $0309	                sty vduv.textWindowBottom

1367	.c6bb	8a		txa		                txa
1368	.c6bc	20 80 c7	jsr $c780	                jsr setTextWindowWidthInBytes

1370						                ; Set up the VDU queue as if VDU 24,0;0;1279;1023;,
1371						                ; then call the VDU 24 entry point.

1373						                ; 1c - ll - $00
1374						                ; 1d - lh - $00
1375						                ; 1e - tl - $00
1376						                ; 1f - th - $00
1377						                ; 20 - rl - $ff
1378						                ; 21 - rh - $04
1379						                ; 22 - tl - $ff
1380						                ; 23 - th - $03

1382	.c6bf	a0 03		ldy #$03	                ldy #$03
1383	.c6c1	8c 23 03	sty $0323	                sty $0323
1384	.c6c4	c8		iny		                iny
1385	.c6c5	8c 21 03	sty $0321	                sty $0321
1386	.c6c8	ce 22 03	dec $0322	                dec $0322
1387	.c6cb	ce 20 03	dec $0320	                dec $0320
1388	.c6ce	20 1f c7	jsr $c71f	                jsr vdu24EntryPoint

1390	.c6d1	a9 08		lda #$08	                lda #STATE.isTextWindow
1391	.c6d3	14 d0		trb $d0		                trb STATE                    ;reset isTextWindow

1393	.c6d5	4c 7c c4	jmp $c47c	                jmp vdu30EntryPoint          ;reset text cursor

1395						;-------------------------------------------------------------------------
1396						;
1397						; Update CRTC cursor address to reflect text cursor position.
1398						;
1399	.c6d8					updateCRTCTextCursor:
1400	.c6d8	20 fa cc	jsr $ccfa	                jsr updateZMEMTWithTextCursorPosition
1401	.c6db	80 10		bra $c6ed	                bra updateCRTCCursorAddress

1403						;-------------------------------------------------------------------------

1405	.c6dd					setCRTCCursorAddress:
1406	.c6dd	8e 4a 03	stx $034a	                stx vduv.textCursorCRTCAddress+0
1407	.c6e0	8d 4b 03	sta $034b	                sta vduv.textCursorCRTCAddress+1
1408	.c6e3	10 04		bpl $c6e9	                bpl +
1409	.c6e5	38		sec		                sec
1410	.c6e6	ed 54 03	sbc $0354	                sbc vduv.screenSizeHighByte
1411	.c6e9					+
1412	.c6e9	86 d8		stx $d8		                stx ZMEMT+0
1413	.c6eb	85 d9		sta $d9		                sta ZMEMT+1

1415						;-------------------------------------------------------------------------
1416						;
1417						;
1418	.c6ed					updateCRTCCursorAddress:
1419	.c6ed	ae 4a 03	ldx $034a	                ldx vduv.textCursorCRTCAddress+0
1420	.c6f0	ad 4b 03	lda $034b	                lda vduv.textCursorCRTCAddress+1
1421	.c6f3	a0 0e		ldy #$0e	                ldy #$0E

1423						;-------------------------------------------------------------------------
1424						;
1425						; Set CRTC address - cursor, or screen start.
1426						;
1427						; entry:
1428						;
1429						; A (msb), X (msb) = 6502 address to set
1430						;
1431						; Y = first CRTC register to set
1432						;
1433	.c6f5					setCRTCAddress:
1434	.c6f5	48		pha		                pha                          ;save screen address MSB
1435	.c6f6	ad 55 03	lda $0355	                lda vduv.currentScreenMODE
1436	.c6f9	c9 07		cmp #$07	                cmp #$07
1437	.c6fb	68		pla		                pla                        ;restore screen address MSB
1438	.c6fc	b0 0f		bcs $c70d	                bcs adjustAddressForMODE7
1439	.c6fe	86 da		stx $da		                stx ZTEMP+0
1440	.c700	4a		lsr a		                lsr a
1441	.c701	66 da		ror $da		                ror ZTEMP+0                  ;/2
1442	.c703	4a		lsr a		                lsr a
1443	.c704	66 da		ror $da		                ror ZTEMP+0                  ;/4
1444	.c706	4a		lsr a		                lsr a
1445	.c707	66 da		ror $da		                ror ZTEMP+0                  ;/8
1446	.c709	a6 da		ldx $da		                ldx ZTEMP+0
1447	.c70b	80 04		bra $c711	                bra setCRTCAddressRegisters

1449	.c70d					adjustAddressForMODE7:
1450						                ; C=1
1451	.c70d	e9 74		sbc #$74	                sbc #$74                 ;adjust for Mode 7 addressing
1452	.c70f	49 20		eor #$20	                eor #$20                 ;adjust for Mode 7 addressing
1453	.c711					setCRTCAddressRegisters:
1454	.c711	8c 00 fe	sty $fe00	                sty CRTC+0
1455	.c714	8d 01 fe	sta $fe01	                sta CRTC+1
1456	.c717	c8		iny		                iny
1457	.c718	8c 00 fe	sty $fe00	                sty CRTC+0
1458	.c71b	8e 01 fe	stx $fe01	                stx CRTC+1
1459	.c71e	60		rts		                rts

1461						;-------------------------------------------------------------------------
1462						;
1463						; VDU 24 (&18) Define graphics window [MasRef E.3-21]
1464						;
1465						; VDU queue:
1466						;
1467						; -8 = <left
1468						; -7 = >left
1469						; -6 = <bottom
1470						; -5 = >bottom
1471						; -4 = <right
1472						; -3 = >right
1473						; -2 = <top
1474						; -1 = >top
1475						;
1476	.c71f					vdu24EntryPoint:
1477	.c71f	20 79 c7	jsr $c779	                jsr LC779

1479	.c722	a2 02		ldx #$02	                ldx #2
1480	.c724					-
1481	.c724	38		sec		                sec

1483						                ; <height when X=2, then <width when X=0
1484	.c725	bd 20 03	lda $0320,x	                lda vduv.queueEnd-4+0,x
1485	.c728	fd 1c 03	sbc $031c,x	                sbc vduv.queueEnd-8+0,x
1486	.c72b	9d 2c 03	sta $032c,x	                sta vduv.workspace._2C+0,x

1488						                ; >height when X=2, then >width when X=0
1489	.c72e	bd 21 03	lda $0321,x	                lda vduv.queueEnd-4+1,x
1490	.c731	fd 1d 03	sbc $031d,x	                sbc vduv.queueEnd-8+1,x
1491	.c734	9d 2d 03	sta $032d,x	                sta vduv.workspace._2C+1,x

1493	.c737	ca		dex		                dex
1494	.c738	ca		dex		                dex
1495	.c739	10 e9		bpl $c724	                bpl -

1497	.c73b	0d 2f 03	ora $032f	                ora vduv.workspace._2C+3     ;A=>width|>height
1498	.c73e	30 39		bmi $c779	                bmi LC779 ;taken if either dimension negative - window invalid
1499	.c740	a2 20		ldx #$20	                ldx #VDUVariables.queueEnd-4 ;left bottom
1500	.c742	20 de d1	jsr $d1de	                jsr eigabsEntryPoint         ;convert to pixels
1501	.c745	a2 1c		ldx #$1c	                ldx #VDUVariables.queueEnd-8 ;right top
1502	.c747	20 de d1	jsr $d1de	                jsr eigabsEntryPoint         ;convert to pixels
1503	.c74a	ad 1f 03	lda $031f	                lda vduv.queueEnd-5          ;>bottom
1504	.c74d	0d 1d 03	ora $031d	                ora vduv.queueEnd-7          ;>left
1505	.c750	30 27		bmi $c779	                bmi LC779 ;taken if either bottom or left negative - window invalid
1506	.c752	ad 23 03	lda $0323	                lda vduv.queueEnd-1          ;>top
1507	.c755	d0 22		bne $c779	                bne LC779          ;taken if top>=256 - window invalid
1508	.c757	ae 55 03	ldx $0355	                ldx vduv.currentScreenMODE
1509	.c75a	ad 21 03	lda $0321	                lda vduv.queueEnd-3          ;>right
1510	.c75d	85 da		sta $da		                sta ZTEMP+0
1511	.c75f	ad 20 03	lda $0320	                lda vduv.queueEnd-4          ;<right
1512	.c762	46 da		lsr $da		                lsr ZTEMP+0                  ;>(right/2)
1513	.c764	6a		ror a		                ror a                        ;<(right/2)
1514	.c765	46 da		lsr $da		                lsr ZTEMP+0                  ;>(right/4)

1516						                ; 639>>2=159 - so any valid pixel X in any mode will
1517						                ; have an MSB of 0 after being shifted right 2.
1518	.c767	d0 10		bne $c779	                bne LC779 ;taken if right edge definitely off screen - window invalid
1519	.c769	6a		ror a		                ror a     ;<(right/4)
1520	.c76a	4a		lsr a		                lsr a     ;<(right/8)
1521	.c76b	dd 19 e1	cmp $e119,x	                cmp modeMaxColumn,x
1522	.c76e	f0 02		beq $c772	                beq LC772                    ;taken if right edge just on screen
1523	.c770	10 07		bpl $c779	                bpl LC779 ;taken if right edge off screen - window definitely invalid
1524	.c772					LC772:
1525	.c772	a0 00		ldy #$00	                ldy #VDUVariables.graphicsWindowPixelsLeft
1526	.c774	a2 1c		ldx #$1c	                ldx #VDUVariables.queueEnd-8
1527	.c776	20 04 c9	jsr $c904	                jsr copyEightBytesWithinVDUVariables
1528	.c779					LC779:
1529	.c779	a2 10		ldx #$10	                ldx #VDUVariables.graphicsCursorPositionX
1530	.c77b	a0 28		ldy #$28	                ldy #VDUVariables.workspace._28
1531	.c77d	4c ca e2	jmp $e2ca	                jmp exchangeFourVDUBytes

1533						;-------------------------------------------------------------------------
1534						;
1535						; Call getBytesPerInclusiveTextRow, and store the result in the
1536						; textWindowWidthInBytes VDU variable.
1537						;
1538	.c780					setTextWindowWidthInBytes:
1539	.c780	20 3b c9	jsr $c93b	                jsr getBytesPerInclusiveTextRow
1540	.c783	8d 4c 03	sta $034c	                sta vduv.textWindowWidthInBytes+0
1541	.c786	8e 4d 03	stx $034d	                stx vduv.textWindowWidthInBytes+1
1542	.c789	60		rts		                rts

1544						;-------------------------------------------------------------------------
1545						;
1546						; VDU 29 (&1D) Define graphics origin [MasRef E.3-35]
1547						;
1548	.c78a					vdu29EntryPoint:
1549	.c78a	a2 20		ldx #$20	                ldx #VDUVariables.queueEnd-4
1550	.c78c	a0 0c		ldy #$0c	                ldy #VDUVariables.graphicsWindowOriginX
1551	.c78e	20 1e c9	jsr $c91e	                jsr copyFourBytesWithinVDUVariables
1552	.c791	4c df c4	jmp $c4df	                jmp LC4DF

1554						;-------------------------------------------------------------------------
1555						;
1556						; VDU 22 (&16) Select screen mode [MasRef E.3-11]
1557						;
1558	.c794					vdu22EntryPoint:
1559	.c794	ad 23 03	lda $0323	                lda vduv.queueEnd-1          ;get MODE number
1560	.c797	80 23		bra $c7bc	                bra setMODE

1562						;-------------------------------------------------------------------------
1563						;
1564	.c799					setStartupMODE:
1565						                .if version==350
1567						                .endif
1568	.c799	85 da		sta $da		                sta ZTEMP+0                  ;save MODE
1569	.c79b	a5 f4		lda $f4		                lda $F4
1570	.c79d	48		pha		                pha
1571	.c79e	09 80		ora #$80	                ora #$80                     ;page in ANDY
1572	.c7a0	20 ab e5	jsr $e5ab	                jsr selectROMA
1573	.c7a3	20 aa c7	jsr $c7aa	                jsr +
1574	.c7a6	68		pla		                pla
1575	.c7a7	4c ab e5	jmp $e5ab	                jmp selectROMA               ;restore old ROM

1577	.c7aa					+
1578						                ; TODO but what of the reserved byte here?
1579	.c7aa	a2 7f		ldx #$7f	                ldx #size(VDUVariables)-1
1580	.c7ac	64 d0		stz $d0		                stz STATE
1581	.c7ae	ad 66 03	lda $0366	                lda vduv.cursorFlags
1582	.c7b1					-
1583	.c7b1	9e ff 02	stz $02ff,x	                stz vduv-1,x
1584	.c7b4	ca		dex		                dex
1585	.c7b5	d0 fa		bne $c7b1	                bne -
1586	.c7b7	8d 66 03	sta $0366	                sta vduv.cursorFlags
1587	.c7ba	a5 da		lda $da		                lda ZTEMP                    ;restore MODE

1589						                ; fall through to setMODE

1591						;-------------------------------------------------------------------------
1592						;
1593						;
1594						;
1595	.c7bc					setMODE:
1596	.c7bc	9c 8a 02	stz $028a	                stz vduDriverMemory
1597	.c7bf	9c 8b 02	stz $028b	                stz displayMemory
1598	.c7c2	a8		tay		                tay                          ;Y=mode
1599	.c7c3	30 10		bmi $c7d5	                bmi setShadowMODE
1600	.c7c5	ae 7f 02	ldx $027f	                ldx shadowRAMState
1601	.c7c8	f0 0b		beq $c7d5	                beq setShadowMODE
1602	.c7ca	a9 10		lda #$10	                lda #STATE.isShadowMode
1603	.c7cc	14 d0		trb $d0		                trb STATE
1604	.c7ce	a9 03		lda #$03	                lda #ACCCON.D|ACCCON.E
1605	.c7d0	1c 34 fe	trb $fe34	                trb ACCCON ;display main RAM, VDU code accesses main RAM
1606	.c7d3	80 09		bra $c7de	                bra +

1608	.c7d5					setShadowMODE:
1609	.c7d5	a9 10		lda #$10	                lda #STATE.isShadowMode
1610	.c7d7	04 d0		tsb $d0		                tsb STATE
1611	.c7d9	a9 03		lda #$03	                lda #ACCCON.D|ACCCON.E
1612	.c7db	0c 34 fe	tsb $fe34	                tsb ACCCON ;display shadow RAM, VDU code accesses shadow RAM
1613	.c7de					+
1614	.c7de	98		tya		                tya                          ;A=mode
1615	.c7df	29 07		and #$07	                and #$07                     ;get MODE 0-7
1616	.c7e1	aa		tax		                tax                          ;X=MODE 0-7
1617	.c7e2	8e 55 03	stx $0355	                stx vduv.currentScreenMODE
1618	.c7e5	bd 4c e1	lda $e14c,x	                lda numberOfLogicalColoursMinusOneForMODE,x
1619	.c7e8	8d 60 03	sta $0360	                sta vduv.numberOfLogicalColoursMinusOne
1620	.c7eb	bd 29 e1	lda $e129,x	                lda bytesPerCharacterForMODE,x
1621	.c7ee	8d 4f 03	sta $034f	                sta vduv.bytesPerCharacter
1622	.c7f1	bd 72 e1	lda $e172,x	                lda pixelsPerByteMinusOneForMODE,x
1623	.c7f4	8d 61 03	sta $0361	                sta vduv.pixelsPerByteMinusOne
1624	.c7f7	d0 02		bne $c7fb	                bne +                        ;taken if graphics mode
1625	.c7f9	a9 07		lda #$07	                lda #$07                     ;assume 8 px/byte for non-graphics modes
1626	.c7fb					+
1627	.c7fb	0a		asl a		                asl a            ;convert to pixelMasks index for rightmost pixel
1628	.c7fc	a8		tay		                tay
1629	.c7fd	b9 3e e1	lda $e13e,y	                lda pixelMasks-1,y
1630	.c800	8d 63 03	sta $0363	                sta vduv.colourMaskRight
1631	.c803					-
1632	.c803	0a		asl a		                asl a
1633	.c804	10 fd		bpl $c803	                bpl -   ;keep shifting until leftmost pixel mask found
1634	.c806	8d 62 03	sta $0362	                sta vduv.colourMaskLeft
1635	.c809	bc 78 e1	ldy $e178,x	                ldy screenMODEGroupForMODE,x
1636	.c80c	8c 56 03	sty $0356	                sty vduv.currentScreenMODEGroup
1637	.c80f	b9 84 e1	lda $e184,y	                lda latchBit4ForScreenMODEGroup,y
1638	.c812	08		php		                php
1639	.c813	78		sei		                sei
1640	.c814	8d 40 fe	sta $fe40	                sta systemVIA.orb
1641	.c817	b9 80 e1	lda $e180,y	                lda latchBit5ForScreenMODEGroup,y
1642	.c81a	8d 40 fe	sta $fe40	                sta systemVIA.orb
1643	.c81d	28		plp		                plp
1644	.c81e	b9 89 e1	lda $e189,y	                lda screenSizeHighByteForScreenMODEGroup,y
1645	.c821	8d 54 03	sta $0354	                sta vduv.screenSizeHighByte
1646	.c824	b9 8e e1	lda $e18e,y	                lda startScreenAddressHighByteForScreenMODEGroup,y
1647	.c827	8d 4e 03	sta $034e	                sta vduv.startScreenAddressHighByte
1648	.c82a	a9 ee		lda #$ee	                lda #STATE.isVDU21|STATE.isCursorEditing|STATE.isVDU5|STATE.isTextWindow|STATE.isPagedScrolling|STATE.isScrollingDisabled
1649	.c82c	14 d0		trb $d0		                trb STATE
1650	.c82e	ae 55 03	ldx $0355	                ldx vduv.currentScreenMODE
1651	.c831	bd 21 e1	lda $e121,x	                lda vcontrolForScreenMODE,x
1652	.c834	20 fe f2	jsr $f2fe	                jsr setVCONTROL
1653	.c837	08		php		                php
1654	.c838	78		sei		                sei
1655	.c839	be 93 e1	ldx $e193,y	                ldx crtcRegisterLastIndexForScreenMODEGroup,y
1656	.c83c	a0 0b		ldy #$0b	                ldy #$0B
1657	.c83e					-
1658	.c83e	bd 98 e1	lda $e198,x	                lda crtcRegisterValues,x
1659	.c841	20 01 cf	jsr $cf01	                jsr setCRTCRegister
1660	.c844	ca		dex		                dex
1661	.c845	88		dey		                dey
1662	.c846	10 f6		bpl $c83e	                bpl -
1663	.c848	28		plp		                plp
1664	.c849	20 c5 c5	jsr $c5c5	                jsr vdu20EntryPoint
1665	.c84c	20 6d cf	jsr $cf6d	                jsr vdu23_11_EntryPoint
1666	.c84f	a9 aa		lda #$aa	                lda #%10101010
1667	.c851	8d 67 03	sta $0367	                sta vduv.dotPattern
1668	.c854	8d 68 03	sta $0368	                sta vduv.dotPatternState
1669	.c857	20 aa c6	jsr $c6aa	                jsr vdu26EntryPoint
1670	.c85a	ad 4c 03	lda $034c	                lda vduv.textWindowWidthInBytes+0
1671	.c85d	ae 4d 03	ldx $034d	                ldx vduv.textWindowWidthInBytes+1
1672	.c860	8d 52 03	sta $0352	                sta vduv.bytesPerCharacterRow+0
1673	.c863	8e 53 03	stx $0353	                stx vduv.bytesPerCharacterRow+1

1675						                ; Do a fast hardware CLS of the whole screen
1676						                ; ------------------------------------------
1677	.c866					clsFastPath:
1678	.c866	a2 00		ldx #$00	                ldx #$00
1679	.c868	ad 4e 03	lda $034e	                lda vduv.startScreenAddressHighByte
1680	.c86b	9c 50 03	stz $0350	                stz vduv.screenTopLeftAddress+0
1681	.c86e	8d 51 03	sta $0351	                sta vduv.screenTopLeftAddress+1
1682	.c871	20 dd c6	jsr $c6dd	                jsr setCRTCCursorAddress
1683	.c874	a0 0c		ldy #$0c	                ldy #$0C
1684	.c876	20 11 c7	jsr $c711	                jsr setCRTCAddressRegisters
1685	.c879	9c 69 02	stz $0269	                stz pagedModeCounter
1686	.c87c	38		sec		                sec
1687	.c87d	a9 80		lda #$80	                lda #$80
1688	.c87f	ed 4e 03	sbc $034e	                sbc vduv.startScreenAddressHighByte
1689	.c882	aa		tax		                tax
1690	.c883	a0 00		ldy #$00	                ldy #$00
1691	.c885	20 84 cb	jsr $cb84	                jsr clearTextMemory
1692	.c888	4c 7c c4	jmp $c47c	                jmp vdu30EntryPoint

1694	.c88b					LC88B:
1695	.c88b	20 cf c8	jsr $c8cf	                jsr LC8CF                    ; Clear paged mode counter
1696	.c88e					LC88E:
1697	.c88e	20 de f2	jsr $f2de	                jsr osbyte76    ; Call KEYV to test Shift & Ctrl keys
1698	.c891	90 02		bcc $c895	                bcc LC895                    ; Ctrl not pressed, exit loop
1699	.c893	30 f6		bmi $c88b	                bmi LC88B                    ; Shift pressed, loop back
1700	.c895					LC895:
1701	.c895	a5 d0		lda $d0		                lda STATE
1702	.c897	49 04		eor #$04	                eor #STATE.isPagedScrolling
1703	.c899	29 46		and #$46	                and #STATE.isCursorEditing|STATE.isPagedScrolling|STATE.isScrollingDisabled;
1704	.c89b	d0 39		bne $c8d6	                bne LC8D6
1705	.c89d	20 d7 c8	jsr $c8d7	                jsr LC8D7
1706	.c8a0	b9 18 03	lda $0318,y	                lda vduv.textCursorXPosition,y
1707	.c8a3	dd 08 03	cmp $0308,x	                cmp vduv.textWindowLeft,x
1708	.c8a6	d0 2b		bne $c8d3	                bne LC8D3
1709						                .if version==400||version==350
1711						                .else
1712	.c8a8	38		sec		                sec
1713	.c8a9	c8		iny		                iny
1714	.c8aa	88		dey		                dey
1715						                .endif
1716	.c8ab	d0 08		bne $c8b5	                bne LC8B5
1717	.c8ad	ad 0a 03	lda $030a	                lda vduv.textWindowRight
1718	.c8b0	ed 08 03	sbc $0308	                sbc vduv.textWindowLeft
1719	.c8b3	80 06		bra $c8bb	                bra LC8BB

1721	.c8b5					LC8B5:
1722	.c8b5	ad 09 03	lda $0309	                lda vduv.textWindowBottom
1723	.c8b8	ed 0b 03	sbc $030b	                sbc vduv.textWindowTop
1724	.c8bb					LC8BB:
1725	.c8bb	48		pha		                pha
1726	.c8bc	4a		lsr a		                lsr a
1727	.c8bd	4a		lsr a		                lsr a
1728	.c8be	85 da		sta $da		                sta ZTEMP+0
1729	.c8c0	38		sec		                sec
1730	.c8c1	68		pla		                pla
1731	.c8c2	e5 da		sbc $da		                sbc ZTEMP+0
1732	.c8c4	cd 69 02	cmp $0269	                cmp pagedModeCounter
1733	.c8c7	b0 0a		bcs $c8d3	                bcs LC8D3
1734	.c8c9					LC8C9:
1735	.c8c9	20 de f2	jsr $f2de	                jsr osbyte76
1736	.c8cc	38		sec		                sec
1737	.c8cd	10 fa		bpl $c8c9	                bpl LC8C9

1739	.c8cf					LC8CF:
1740	.c8cf	9c 69 02	stz $0269	                stz pagedModeCounter        ; Clear paged mode counter
1741						                .if version!=400&&version!=350
1742	.c8d2	ea		nop		                nop
1743						                .endif
1744	.c8d3					LC8D3:
1745	.c8d3	ee 69 02	inc $0269	                inc pagedModeCounter
1746	.c8d6					LC8D6:
1747	.c8d6	60		rts		                rts

1749	.c8d7					LC8D7:
1750	.c8d7	ad 66 03	lda $0366	                lda vduv.cursorFlags
1751	.c8da	29 0e		and #$0e	                and #vduv.cursorFlags.swapAxes|vduv.cursorFlags.invertVertical|vduv.cursorFlags.invertHorizontal
1752	.c8dc	4a		lsr a		                lsr a                        ;xvh
1753	.c8dd	aa		tax		                tax
1754	.c8de	bd 14 e2	lda $e214,x	                lda LE204,x
1755	.c8e1	aa		tax		                tax
1756	.c8e2	29 01		and #$01	                and #$01
1757	.c8e4	a8		tay		                tay
1758	.c8e5	60		rts		                rts

1760						;-------------------------------------------------------------------------
1761						;
1762						; Prepare AABB based on the current graphics cursor and some other
1763						; coordinate.
1764						;
1765						; entry:
1766						;
1767						; X = VDU variable offset of other coordinate (4 bytes: X;Y;)
1768						;
1769						; exit:
1770						;
1771						; vduv.workspace._28 = minimum
1772						;
1773						; vduv.workspace._2c = maximum
1774						;
1775	.c8e6					prepareAABB:
1776	.c8e6	a0 24		ldy #$24	                ldy #VDUVariables.graphicsCursorPixels
1777	.c8e8	20 b7 d5	jsr $d5b7	                jsr sortVDUVariableCoordinates
1778	.c8eb	5a		phy		                phy                          ;save greater Y
1779	.c8ec	da		phx		                phx                          ;save lesser Y
1780	.c8ed	20 cc d5	jsr $d5cc	                jsr sortVDUVariableWords     ;X=lesser X, Y=greater X
1781	.c8f0	68		pla		                pla                          ;A=lesser Y
1782	.c8f1	5a		phy		                phy                          ;save greater X
1783	.c8f2	a0 28		ldy #$28	                ldy #VDUVariables.workspace._28
1784	.c8f4	20 f9 c8	jsr $c8f9	                jsr +
1785	.c8f7	fa		plx		                plx                          ;X=greater X
1786	.c8f8	68		pla		                pla                          ;A=greater Y
1787	.c8f9					+
1788						                ; Copy VDU variable word +X to VDU variable word+Y.
1789						                ; Then cropy VDU variable word +A+2 to VDU variable
1790						                ; word+Y+2. Return with updated Y.
1791	.c8f9	48		pha		                pha
1792	.c8fa	20 0c c9	jsr $c90c	                jsr copyTwoBytesWithinVDUVariables
1793	.c8fd	fa		plx		                plx
1794	.c8fe	e8		inx		                inx
1795	.c8ff	e8		inx		                inx
1796	.c900	80 0a		bra $c90c	                bra copyTwoBytesWithinVDUVariables

1798						;-------------------------------------------------------------------------
1799						;
1800						; Copy 8 bytes to workspace 28 in the VDU variables.
1801						;
1802						; entry:
1803						;
1804						; X = source offset
1805						;
1806	.c902					copyEightBytesToWorkspace28:
1807	.c902	a0 28		ldy #$28	                ldy #VDUVariables.workspace._28

1809						;-------------------------------------------------------------------------
1810						;
1811						; Copy 8 bytes in the VDU variables.
1812						;
1813						; entry:
1814						;
1815						; X = source offset
1816						;
1817						; Y = dest offset
1818						;
1819	.c904					copyEightBytesWithinVDUVariables:
1820	.c904	a9 08		lda #$08	                lda #$08
1821	.c906	80 18		bra $c920	                bra copyABytesWithinVDUVariables

1823						;-------------------------------------------------------------------------
1824						;
1825						; copyTextWindowWidthInBytesToWorkspace28
1826	.c908					copyTextWindowWidthInBytesToWorkspace28:
1827	.c908	a2 4c		ldx #$4c	                ldx #VDUVariables.textWindowWidthInBytes
1828	.c90a	a0 28		ldy #$28	                ldy #VDUVariables.workspace._28

1830						;-------------------------------------------------------------------------
1831						;
1832						;
1833	.c90c					copyTwoBytesWithinVDUVariables:
1834	.c90c	a9 02		lda #$02	                lda #$02
1835	.c90e	80 10		bra $c920	                bra copyABytesWithinVDUVariables

1837						;-------------------------------------------------------------------------
1838						;
1839						; Copy text window info to workspace2C.
1840						;
1841	.c910					copyTextWindowToWorkspace2C:
1842	.c910	a2 08		ldx #$08	                ldx #VDUVariables.textWindowLeft
1843	.c912	a0 2c		ldy #$2c	                ldy #VDUVariables.workspace._2C
1844	.c914	80 08		bra $c91e	                bra copyFourBytesWithinVDUVariables

1846						;-------------------------------------------------------------------------
1847						;
1848						; Copy last 4 bytes of VDU queue somewhere.
1849						;
1850	.c916					copyLastFourVDUQueueBytes:
1851	.c916	a2 20		ldx #$20	                ldx #VDUVariables.queueEnd-4
1852	.c918	80 04		bra $c91e	                bra copyFourBytesWithinVDUVariables

1854						;-------------------------------------------------------------------------
1855						;
1856						; Copy old graphics cursor position to current graphics cursor position.
1857						;
1858	.c91a					copyGraphicsCursorPixelsToOldGraphicsCursorPixels:
1859	.c91a	a0 14		ldy #$14	                ldy #VDUVariables.oldGraphicsCursorPixelsX

1861						;-------------------------------------------------------------------------
1862						;
1863						; Copy the graphics cursor position somewhere.
1864						;
1865	.c91c					copyGraphicsCursorPixels:
1866	.c91c	a2 24		ldx #$24	                ldx #VDUVariables.graphicsCursorPixelsX

1868						;-------------------------------------------------------------------------
1869						;
1870						; Copy 4 bytes in the VDU variables.
1871						;
1872						; entry:
1873						;
1874						; X = source offset
1875						;
1876						; Y = dest offset
1877						;
1878	.c91e					copyFourBytesWithinVDUVariables:
1879	.c91e	a9 04		lda #$04	                lda #$04

1881						                ; fall through to copyABytesWithinVDUVariables

1883						;-------------------------------------------------------------------------
1884						;
1885						; Copy some bytes in the VDU variables.
1886						;
1887						; entry:
1888						;
1889						; A = number of bytes
1890						;
1891						; X = source offset
1892						;
1893						; Y = dest offset
1894						;
1895						; exit:
1896						;
1897						; X = updated source offset
1898						;
1899						; Y = updated dest offset
1900						;
1901	.c920					copyABytesWithinVDUVariables:
1902	.c920	48		pha		                pha
1903	.c921	bd 00 03	lda $0300,x	                lda vduv,x
1904	.c924	99 00 03	sta $0300,y	                sta vduv,y
1905	.c927	e8		inx		                inx
1906	.c928	c8		iny		                iny
1907	.c929	68		pla		                pla
1908	.c92a	3a		dec a		                dec a
1909	.c92b	d0 f3		bne $c920	                bne copyABytesWithinVDUVariables
1910	.c92d	60		rts		                rts

1912						;-------------------------------------------------------------------------
1913						;
1914						; Negate a 16-bit value stored in Y/A
1915						;
1916						; entry:
1917						;
1918						; Y (LSB), A (MSB) = value
1919						;
1920						; exit:
1921						;
1922						; Y (LSB), A (MSB) = -value
1923						;
1924	.c92e					negateAY:
1925	.c92e	48		pha		                pha
1926	.c92f	98		tya		                tya
1927	.c930	49 ff		eor #$ff	                eor #$FF
1928	.c932	a8		tay		                tay
1929	.c933	68		pla		                pla
1930	.c934	49 ff		eor #$ff	                eor #$FF
1931	.c936	c8		iny		                iny
1932	.c937	d0 01		bne $c93a	                bne +
1933	.c939	1a		inc a		                inc a
1934	.c93a					+
1935	.c93a	60		rts		                rts

1937						;-------------------------------------------------------------------------
1938						;
1939						; Multiply a text window width by the number of bytes per char. There
1940						; are inclusive and exclusive versions, depending on how the width was
1941						; calculated.
1942						;
1943						; entry:
1944						;
1945						; A = value-1 to multiply (inclusive), value to multiply (exclusive)
1946						;
1947						; exit:
1948						;
1949						; A (lsb), X (msb) = value*vduv.bytesPerCharacter
1950						;
1951	.c93b					getBytesPerInclusiveTextRow:
1952	.c93b	1a		inc a		                inc a
1953	.c93c					getBytesPerExclusiveTextRow:
1954	.c93c	85 da		sta $da		                sta $DA
1955	.c93e	64 db		stz $db		                stz $DB
1956	.c940	ad 4f 03	lda $034f	                lda vduv.bytesPerCharacter    ;A=1/8/16/32
1957	.c943					-
1958	.c943	4a		lsr a		                lsr a
1959	.c944	b0 06		bcs $c94c	                bcs +                     ;taken when multiply is done
1960	.c946	06 da		asl $da		                asl $DA              ;shift size LSB
1961	.c948	26 db		rol $db		                rol $DB              ;carry into size MSB
1962	.c94a	80 f7		bra $c943	                bra -

1964	.c94c					+
1965	.c94c	a5 da		lda $da		                lda $DA
1966	.c94e	a6 db		ldx $db		                ldx $DB
1967	.c950	60		rts		                rts

1969						;-------------------------------------------------------------------------
1970						;
1971						;
1972	.c951					prepareForPlotBackground:
1973	.c951	a2 08		ldx #$08	                ldx #$08                     ;plot background
1974	.c953	8e 59 03	stx $0359	                stx vduv.graphicsPlotState
1975	.c956	ad 5c 03	lda $035c	                lda vduv.backgroundGCOLMode
1976	.c959	29 0f		and #$0f	                and #$0F
1977	.c95b	8d 5a 03	sta $035a	                sta vduv.graphicsPlotMode
1978	.c95e	60		rts		                rts

1980						;-------------------------------------------------------------------------

1982	.c95f					LC95F:
1983	.c95f	a9 00		lda #$00	                lda #$00
1984	.c961	48		pha		                pha
1985	.c962	48		pha		                pha
1986	.c963	ae 2a 03	ldx $032a	                ldx $032A
1987	.c966	20 7d cc	jsr $cc7d	                jsr LCC7D
1988	.c969	80 14		bra $c97f	                bra LC97F

1990	.c96b					LC96B:
1991	.c96b	38		sec		                sec
1992	.c96c	ad 4f 03	lda $034f	                lda $034F
1993	.c96f	ed 2a 03	sbc $032a	                sbc $032A
1994	.c972	48		pha		                pha
1995	.c973	20 b2 e2	jsr $e2b2	                jsr getDefaultBoundsForCurrentScreenMODE
1996	.c976	da		phx		                phx
1997	.c977	a9 00		lda #$00	                lda #$00
1998	.c979	ae 2a 03	ldx $032a	                ldx $032A
1999	.c97c	20 5d cc	jsr $cc5d	                jsr LCC5D
2000	.c97f					LC97F:
2001						                ; scroll left/right
2002	.c97f	8e 50 03	stx $0350	                stx vduv.screenTopLeftAddress+0
2003	.c982	8d 51 03	sta $0351	                sta vduv.screenTopLeftAddress+1
2004	.c985	fa		plx		                plx
2005	.c986	a0 00		ldy #$00	                ldy #$00
2006	.c988	20 b0 cc	jsr $ccb0	                jsr getAddressForTextPosition
2007	.c98b	fa		plx		                plx
2008	.c98c	a9 00		lda #$00	                lda #$00
2009	.c98e	20 5d cc	jsr $cc5d	                jsr LCC5D
2010	.c991	86 d8		stx $d8		                stx ZMEMT+0
2011	.c993	85 d9		sta $d9		                sta ZMEMT+1
2012	.c995	20 b2 e2	jsr $e2b2	                jsr getDefaultBoundsForCurrentScreenMODE
2013	.c998	20 ae ca	jsr $caae	                jsr LCAAE
2014	.c99b	80 1b		bra $c9b8	                bra LC9B8

2016	.c99d					LC99D:
2017	.c99d	a0 00		ldy #$00	                ldy #$00
2018	.c99f	20 77 cc	jsr $cc77	                jsr LCC77
2019	.c9a2	80 06		bra $c9aa	                bra LC9AA

2021	.c9a4					LC9A4:
2022	.c9a4	20 b2 e2	jsr $e2b2	                jsr getDefaultBoundsForCurrentScreenMODE
2023	.c9a7	20 57 cc	jsr $cc57	                jsr LCC57
2024	.c9aa					LC9AA:
2025	.c9aa	8e 50 03	stx $0350	                stx vduv.screenTopLeftAddress+0
2026	.c9ad	8d 51 03	sta $0351	                sta vduv.screenTopLeftAddress+1
2027	.c9b0	a2 00		ldx #$00	                ldx #$00
2028	.c9b2	20 b0 cc	jsr $ccb0	                jsr getAddressForTextPosition
2029	.c9b5	20 e8 ca	jsr $cae8	                jsr LCAE8
2030	.c9b8					LC9B8:
2031	.c9b8	a0 0c		ldy #$0c	                ldy #$0C
2032	.c9ba	ad 51 03	lda $0351	                lda vduv.screenTopLeftAddress+1
2033	.c9bd	ae 50 03	ldx $0350	                ldx vduv.screenTopLeftAddress+0
2034	.c9c0	4c f5 c6	jmp $c6f5	                jmp setCRTCAddress

2036	.c9c3					LC9C3:
2037	.c9c3	20 a0 cc	jsr $cca0	                jsr LCCA0
2038	.c9c6					LC9C6:
2039	.c9c6	85 dd		sta $dd		                sta $DD
2040	.c9c8	86 dc		stx $dc		                stx $DC
2041	.c9ca	20 2c cc	jsr $cc2c	                jsr LCC2C
2042	.c9cd	ad 29 03	lda $0329	                lda $0329
2043	.c9d0	ae 28 03	ldx $0328	                ldx $0328
2044	.c9d3	20 5d cc	jsr $cc5d	                jsr LCC5D
2045	.c9d6	20 88 cc	jsr $cc88	                jsr LCC88
2046	.c9d9	86 d8		stx $d8		                stx ZMEMT+0
2047	.c9db	85 d9		sta $d9		                sta ZMEMT+1
2048	.c9dd	a9 00		lda #$00	                lda #$00
2049	.c9df	ae 2a 03	ldx $032a	                ldx $032A
2050	.c9e2	20 7d cc	jsr $cc7d	                jsr LCC7D
2051	.c9e5	20 88 cc	jsr $cc88	                jsr LCC88
2052	.c9e8	86 da		stx $da		                stx $DA
2053	.c9ea	85 db		sta $db		                sta $DB
2054	.c9ec	ac 28 03	ldy $0328	                ldy $0328
2055	.c9ef	ae 29 03	ldx $0329	                ldx $0329
2056	.c9f2	50 23		bvc $ca17	                bvc LCA17
2057	.c9f4	a4 e0		ldy $e0		                ldy $E0
2058	.c9f6	a6 e1		ldx $e1		                ldx $E1
2059	.c9f8	20 e7 cb	jsr $cbe7	                jsr LCBE7
2060	.c9fb	a4 e0		ldy $e0		                ldy $E0
2061	.c9fd	90 09		bcc $ca08	                bcc LCA08
2062	.c9ff	a2 80		ldx #$80	                ldx #$80
2063	.ca01	86 db		stx $db		                stx $DB
2064	.ca03	64 da		stz $da		                stz $DA
2065	.ca05	ac 2a 03	ldy $032a	                ldy $032A
2066	.ca08					LCA08:
2067	.ca08	a2 00		ldx #$00	                ldx #$00
2068	.ca0a	20 f3 cb	jsr $cbf3	                jsr LCBF3
2069	.ca0d	a2 80		ldx #$80	                ldx #$80
2070	.ca0f	86 d9		stx $d9		                stx ZMEMT+1
2071	.ca11	64 d8		stz $d8		                stz ZMEMT+0
2072	.ca13	a4 de		ldy $de		                ldy $DE
2073	.ca15	a6 df		ldx $df		                ldx $DF
2074	.ca17					LCA17:
2075	.ca17	20 e7 cb	jsr $cbe7	                jsr LCBE7
2076	.ca1a	20 97 cc	jsr $cc97	                jsr LCC97
2077	.ca1d	20 94 cc	jsr $cc94	                jsr LCC94
2078	.ca20	20 57 cc	jsr $cc57	                jsr LCC57
2079	.ca23	86 d8		stx $d8		                stx ZMEMT+0
2080	.ca25	85 d9		sta $d9		                sta ZMEMT+1
2081	.ca27	ce 2b 03	dec $032b	                dec $032B
2082	.ca2a	10 9a		bpl $c9c6	                bpl LC9C6
2083	.ca2c	60		rts		                rts

2085	.ca2d					LCA2D:
2086	.ca2d	20 a0 cc	jsr $cca0	                jsr LCCA0
2087	.ca30					LCA30:
2088	.ca30	20 2c cc	jsr $cc2c	                jsr LCC2C
2089	.ca33	a9 00		lda #$00	                lda #$00
2090	.ca35	ae 2a 03	ldx $032a	                ldx $032A
2091	.ca38	20 5d cc	jsr $cc5d	                jsr LCC5D
2092	.ca3b	86 da		stx $da		                stx $DA
2093	.ca3d	85 db		sta $db		                sta $DB
2094	.ca3f	20 57 cc	jsr $cc57	                jsr LCC57
2095	.ca42	86 dc		stx $dc		                stx $DC
2096	.ca44	85 dd		sta $dd		                sta $DD
2097	.ca46	ac 28 03	ldy $0328	                ldy $0328
2098	.ca49	ae 29 03	ldx $0329	                ldx $0329
2099	.ca4c	50 25		bvc $ca73	                bvc LCA73
2100	.ca4e	a4 de		ldy $de		                ldy $DE
2101	.ca50	a6 df		ldx $df		                ldx $DF
2102	.ca52	20 a8 cb	jsr $cba8	                jsr LCBA8
2103	.ca55	a4 de		ldy $de		                ldy $DE
2104	.ca57	90 0a		bcc $ca63	                bcc LCA63
2105	.ca59	ae 4e 03	ldx $034e	                ldx $034E
2106	.ca5c	86 db		stx $db		                stx $DB
2107	.ca5e	64 da		stz $da		                stz $DA
2108	.ca60	ac 2a 03	ldy $032a	                ldy $032A
2109	.ca63					LCA63:
2110	.ca63	a2 00		ldx #$00	                ldx #$00
2111	.ca65	20 b4 cb	jsr $cbb4	                jsr LCBB4
2112	.ca68	ae 4e 03	ldx $034e	                ldx $034E
2113	.ca6b	86 d9		stx $d9		                stx ZMEMT+1
2114	.ca6d	64 d8		stz $d8		                stz ZMEMT+0
2115	.ca6f	a4 e0		ldy $e0		                ldy $E0
2116	.ca71	a6 e1		ldx $e1		                ldx $E1
2117	.ca73					LCA73:
2118	.ca73	20 a8 cb	jsr $cba8	                jsr LCBA8
2119	.ca76	20 94 cc	jsr $cc94	                jsr LCC94
2120	.ca79	ce 2b 03	dec $032b	                dec $032B
2121	.ca7c	10 b2		bpl $ca30	                bpl LCA30
2122	.ca7e					LCA7E:
2123	.ca7e	60		rts		                rts

2125	.ca7f					LCA7F:
2126	.ca7f	86 dc		stx $dc		                stx $DC
2127	.ca81	aa		tax		                tax
2128	.ca82	38		sec		                sec
2129	.ca83	e5 dc		sbc $dc		                sbc $DC
2130	.ca85	f0 f7		beq $ca7e	                beq LCA7E
2131	.ca87	85 dd		sta $dd		                sta $DD
2132	.ca89	da		phx		                phx
2133	.ca8a	20 3c c9	jsr $c93c	                jsr getBytesPerExclusiveTextRow
2134	.ca8d	fa		plx		                plx
2135	.ca8e	ad 66 03	lda $0366	                lda $0366
2136	.ca91	89 08		bit #$08	                bit #$08
2137	.ca93	d0 0b		bne $caa0	                bne LCAA0
2138	.ca95	89 02		bit #$02	                bit #$02
2139	.ca97	20 ca cc	jsr $ccca	                jsr LCCCA
2140	.ca9a	a4 da		ldy $da		                ldy $DA
2141	.ca9c	a6 db		ldx $db		                ldx $DB
2142	.ca9e	80 2e		bra $cace	                bra LCACE

2144	.caa0					LCAA0:
2145	.caa0	89 04		bit #$04	                bit #$04
2146	.caa2	20 ca cc	jsr $ccca	                jsr LCCCA
2147	.caa5	ad 4f 03	lda $034f	                lda $034F
2148	.caa8	8d 2a 03	sta $032a	                sta $032A
2149	.caab	a4 dd		ldy $dd		                ldy $DD
2150	.caad	88		dey		                dey
2151	.caae					LCAAE:
2152	.caae	98		tya		                tya
2153	.caaf	f0 18		beq $cac9	                beq LCAC9
2154	.cab1	84 dc		sty $dc		                sty $DC
2155	.cab3					LCAB3:
2156	.cab3	20 57 cc	jsr $cc57	                jsr LCC57
2157	.cab6	86 da		stx $da		                stx $DA
2158	.cab8	85 db		sta $db		                sta $DB
2159	.caba	20 c9 ca	jsr $cac9	                jsr LCAC9
2160	.cabd	a6 da		ldx $da		                ldx $DA
2161	.cabf	86 d8		stx $d8		                stx ZMEMT+0
2162	.cac1	a5 db		lda $db		                lda $DB
2163	.cac3	85 d9		sta $d9		                sta ZMEMT+1
2164	.cac5	c6 dc		dec $dc		                dec $DC
2165	.cac7	d0 ea		bne $cab3	                bne LCAB3
2166	.cac9					LCAC9:
2167	.cac9	a2 00		ldx #$00	                ldx #$00
2168	.cacb	ac 2a 03	ldy $032a	                ldy $032A
2169	.cace					LCACE:
2170	.cace	ad 28 03	lda $0328	                lda $0328
2171	.cad1	48		pha		                pha
2172	.cad2	ad 29 03	lda $0329	                lda $0329
2173	.cad5	48		pha		                pha
2174	.cad6	8c 28 03	sty $0328	                sty $0328
2175	.cad9	8e 29 03	stx $0329	                stx $0329
2176	.cadc	20 e8 ca	jsr $cae8	                jsr LCAE8
2177	.cadf	68		pla		                pla
2178	.cae0	8d 29 03	sta $0329	                sta $0329
2179	.cae3	68		pla		                pla
2180	.cae4	8d 28 03	sta $0328	                sta $0328
2181	.cae7	60		rts		                rts

2183						;-------------------------------------------------------------------------

2185	.cae8					LCAE8:
2186	.cae8	a6 d8		ldx $d8		                ldx ZMEMT+0
2187	.caea	a5 d9		lda $d9		                lda ZMEMT+1
2188	.caec	20 2c cc	jsr $cc2c	                jsr LCC2C
2189	.caef	80 79		bra $cb6a	                bra LCB6A

2191						;-------------------------------------------------------------------------

2193	.caf1					LCAF1:
2194	.caf1	a2 77		ldx #$77	                ldx #<LCC77
2195	.caf3	a9 cc		lda #$cc	                lda #>LCC77
2196	.caf5	ac 2d 03	ldy $032d	                ldy $032D
2197	.caf8	80 07		bra $cb01	                bra LCB01

2199	.cafa					LCAFA:
2200	.cafa	a2 57		ldx #$57	                ldx #<LCC57
2201	.cafc	a9 cc		lda #$cc	                lda #>LCC57
2202	.cafe	ac 2f 03	ldy $032f	                ldy $032F
2203	.cb01					LCB01:
2204	.cb01	8e 5d 03	stx $035d	                stx $035D
2205	.cb04	8d 5e 03	sta $035e	                sta $035E
2206	.cb07	38		sec		                sec
2207	.cb08	ad 2d 03	lda $032d	                lda $032D
2208	.cb0b	ed 2f 03	sbc $032f	                sbc $032F
2209	.cb0e	8d 2b 03	sta $032b	                sta $032B
2210	.cb11	ae 2c 03	ldx $032c	                ldx $032C
2211	.cb14	20 b0 cc	jsr $ccb0	                jsr getAddressForTextPosition
2212	.cb17	85 dd		sta $dd		                sta $DD
2213	.cb19	86 dc		stx $dc		                stx $DC
2214	.cb1b	20 2c cc	jsr $cc2c	                jsr LCC2C
2215	.cb1e	ad 2b 03	lda $032b	                lda $032B
2216	.cb21	f0 47		beq $cb6a	                beq LCB6A
2217	.cb23					LCB23:
2218	.cb23	08		php		                php
2219	.cb24	20 24 c0	jsr $c024	                jsr LC024
2220	.cb27	86 da		stx $da		                stx $DA
2221	.cb29	85 db		sta $db		                sta $DB
2222	.cb2b	86 dc		stx $dc		                stx $DC
2223	.cb2d	85 dd		sta $dd		                sta $DD
2224	.cb2f	28		plp		                plp
2225	.cb30	50 1d		bvc $cb4f	                bvc LCB4F
2226	.cb32	b8		clv		                clv
2227	.cb33					LCB33:
2228	.cb33	a6 df		ldx $df		                ldx $DF
2229	.cb35	a4 de		ldy $de		                ldy $DE
2230	.cb37	20 b4 cb	jsr $cbb4	                jsr LCBB4
2231	.cb3a	ad 4e 03	lda $034e	                lda $034E
2232	.cb3d	70 06		bvs $cb45	                bvs LCB45
2233	.cb3f	85 d9		sta $d9		                sta ZMEMT+1
2234	.cb41	64 d8		stz $d8		                stz ZMEMT+0
2235	.cb43	80 04		bra $cb49	                bra LCB49

2237	.cb45					LCB45:
2238	.cb45	85 db		sta $db		                sta $DB
2239	.cb47	64 da		stz $da		                stz $DA
2240	.cb49					LCB49:
2241	.cb49	a6 e1		ldx $e1		                ldx $E1
2242	.cb4b	a4 e0		ldy $e0		                ldy $E0
2243	.cb4d	80 0b		bra $cb5a	                bra LCB5A

2245	.cb4f					LCB4F:
2246	.cb4f	20 2c cc	jsr $cc2c	                jsr LCC2C
2247	.cb52	70 df		bvs $cb33	                bvs LCB33
2248	.cb54	ae 29 03	ldx $0329	                ldx $0329
2249	.cb57	ac 28 03	ldy $0328	                ldy $0328
2250	.cb5a					LCB5A:
2251	.cb5a	20 b4 cb	jsr $cbb4	                jsr LCBB4
2252	.cb5d	a6 dc		ldx $dc		                ldx $DC
2253	.cb5f	86 d8		stx $d8		                stx ZMEMT+0
2254	.cb61	a5 dd		lda $dd		                lda $DD
2255	.cb63	85 d9		sta $d9		                sta ZMEMT+1
2256	.cb65	ce 2b 03	dec $032b	                dec $032B
2257	.cb68	d0 b9		bne $cb23	                bne LCB23
2258	.cb6a					LCB6A:
2259	.cb6a	ae 29 03	ldx $0329	                ldx $0329
2260	.cb6d	ac 28 03	ldy $0328	                ldy $0328
2261	.cb70	50 12		bvc $cb84	                bvc clearTextMemory
2262	.cb72	a6 df		ldx $df		                ldx $DF
2263	.cb74	a4 de		ldy $de		                ldy $DE
2264	.cb76	20 84 cb	jsr $cb84	                jsr clearTextMemory
2265	.cb79	ad 4e 03	lda $034e	                lda $034E
2266	.cb7c	85 d9		sta $d9		                sta ZMEMT+1
2267	.cb7e	64 d8		stz $d8		                stz ZMEMT+0
2268	.cb80	a6 e1		ldx $e1		                ldx $E1
2269	.cb82	a4 e0		ldy $e0		                ldy $E0

2271						;-------------------------------------------------------------------------
2272						;
2273						; Clear a block of text screen memory.
2274						;
2275						; entry:
2276						;
2277						; (ZMEMT),y - first byte to clear
2278						;
2279						; X = number of pages (including first, possibly partial page) to clear
2280						;
2281	.cb84					clearTextMemory:
2282						                ; align memory so that Y=0 on each page boundary
2283						                ; crossing.
2284						                ;
2285						                ; e.g., on entry ZMEMT=$30f8, Y=$08 - then after,
2286						                ; ZMEMT=$3000, Y=$F7; or, ZMEMT=$30f0, Y=$08 -> ZMEMT=$2ff8, Y=$F7.
2287	.cb84	98		tya		                tya                          ;A=initial offset
2288	.cb85	18		clc		                clc
2289	.cb86	65 d8		adc $d8		                adc ZMEMT+0                  ;add to dest address
2290	.cb88	85 d8		sta $d8		                sta ZMEMT+0
2291	.cb8a	b0 02		bcs $cb8e	                bcs +
2292	.cb8c	c6 d9		dec $d9		                dec ZMEMT+1
2293	.cb8e					+
2294	.cb8e	98		tya		                tya
2295	.cb8f	49 ff		eor #$ff	                eor #$FF
2296	.cb91	a8		tay		                tay
2297	.cb92	4a		lsr a		                lsr a                        ;C set if odd
2298	.cb93	ad 58 03	lda $0358	                lda vduv.backgroundTextColour
2299	.cb96	b0 07		bcs $cb9f	                bcs nextByte                    ;taken if odd - slightly different loop
2300	.cb98	80 02		bra $cb9c	                bra clearTextMemoryByte

2302	.cb9a					clearTextMemoryLoop:
2303	.cb9a	91 d8		sta ($d8),y	                sta (ZMEMT),y
2304	.cb9c					clearTextMemoryByte:
2305	.cb9c	c8		iny		                iny
2306	.cb9d	91 d8		sta ($d8),y	                sta (ZMEMT),y
2307	.cb9f					nextByte:
2308	.cb9f	c8		iny		                iny
2309	.cba0	d0 f8		bne $cb9a	                bne clearTextMemoryLoop
2310	.cba2	e6 d9		inc $d9		                inc ZMEMT+1
2311	.cba4	ca		dex		                dex
2312	.cba5	10 f3		bpl $cb9a	                bpl clearTextMemoryLoop
2313	.cba7	60		rts		                rts

2315						;-------------------------------------------------------------------------

2317	.cba8					LCBA8:
2318	.cba8	38		sec		                sec
2319	.cba9	98		tya		                tya
2320	.cbaa	ed 2a 03	sbc $032a	                sbc $032A
2321	.cbad	a8		tay		                tay
2322	.cbae	b0 04		bcs $cbb4	                bcs LCBB4
2323	.cbb0	ca		dex		                dex
2324	.cbb1	30 33		bmi $cbe6	                bmi LCBE6
2325	.cbb3	38		sec		                sec
2326	.cbb4					LCBB4:
2327	.cbb4	08		php		                php
2328	.cbb5	98		tya		                tya
2329	.cbb6	18		clc		                clc
2330	.cbb7	65 da		adc $da		                adc ZTEMP+0
2331	.cbb9	85 da		sta $da		                sta ZTEMP+0
2332	.cbbb	b0 02		bcs $cbbf	                bcs LCBBF
2333	.cbbd	c6 db		dec $db		                dec ZTEMP+1
2334	.cbbf					LCBBF:
2335	.cbbf	98		tya		                tya
2336	.cbc0	18		clc		                clc
2337	.cbc1	65 d8		adc $d8		                adc ZMEMT+0
2338	.cbc3	85 d8		sta $d8		                sta ZMEMT+0
2339	.cbc5	b0 02		bcs $cbc9	                bcs LCBC9
2340	.cbc7	c6 d9		dec $d9		                dec ZMEMT+1
2341	.cbc9					LCBC9:
2342	.cbc9	98		tya		                tya
2343	.cbca	49 ff		eor #$ff	                eor #$FF
2344	.cbcc	a8		tay		                tay
2345	.cbcd	4a		lsr a		                lsr a
2346	.cbce	b0 0b		bcs $cbdb	                bcs LCBDB
2347	.cbd0	80 04		bra $cbd6	                bra LCBD6

2349	.cbd2					LCBD2:
2350	.cbd2	b1 da		lda ($da),y	                lda ($DA),y
2351	.cbd4	91 d8		sta ($d8),y	                sta (ZMEMT),y
2352	.cbd6					LCBD6:
2353	.cbd6	c8		iny		                iny
2354	.cbd7	b1 da		lda ($da),y	                lda ($DA),y
2355	.cbd9	91 d8		sta ($d8),y	                sta (ZMEMT),y
2356	.cbdb					LCBDB:
2357	.cbdb	c8		iny		                iny
2358	.cbdc	d0 f4		bne $cbd2	                bne LCBD2
2359	.cbde	e6 db		inc $db		                inc $DB
2360	.cbe0	e6 d9		inc $d9		                inc ZMEMT+1
2361	.cbe2	ca		dex		                dex
2362	.cbe3	10 ed		bpl $cbd2	                bpl LCBD2
2363	.cbe5					LCBE5:
2364	.cbe5	28		plp		                plp
2365	.cbe6					LCBE6:
2366	.cbe6	60		rts		                rts

2368	.cbe7					LCBE7:
2369	.cbe7	38		sec		                sec
2370	.cbe8	98		tya		                tya
2371	.cbe9	ed 2a 03	sbc $032a	                sbc $032A
2372	.cbec	a8		tay		                tay
2373	.cbed	b0 04		bcs $cbf3	                bcs LCBF3
2374	.cbef	ca		dex		                dex
2375	.cbf0	30 f4		bmi $cbe6	                bmi LCBE6
2376	.cbf2	38		sec		                sec
2377	.cbf3					LCBF3:
2378	.cbf3	08		php		                php
2379	.cbf4	98		tya		                tya
2380	.cbf5	49 ff		eor #$ff	                eor #$FF
2381	.cbf7	48		pha		                pha
2382	.cbf8	38		sec		                sec
2383	.cbf9	65 da		adc $da		                adc $DA
2384	.cbfb	85 da		sta $da		                sta $DA
2385	.cbfd	b0 02		bcs $cc01	                bcs LCC01
2386	.cbff	c6 db		dec $db		                dec $DB
2387	.cc01					LCC01:
2388	.cc01	68		pla		                pla
2389	.cc02	38		sec		                sec
2390	.cc03	65 d8		adc $d8		                adc ZMEMT+0
2391	.cc05	85 d8		sta $d8		                sta ZMEMT+0
2392	.cc07	b0 02		bcs $cc0b	                bcs LCC0B
2393	.cc09	c6 d9		dec $d9		                dec ZMEMT+1
2394	.cc0b					LCC0B:
2395	.cc0b	98		tya		                tya
2396	.cc0c	4a		lsr a		                lsr a
2397	.cc0d	b0 14		bcs $cc23	                bcs LCC23
2398	.cc0f	d0 0d		bne $cc1e	                bne LCC1E
2399	.cc11					LCC11:
2400	.cc11	ca		dex		                dex
2401	.cc12	30 d1		bmi $cbe5	                bmi LCBE5
2402	.cc14	c6 db		dec $db		                dec $DB
2403	.cc16	c6 d9		dec $d9		                dec ZMEMT+1
2404	.cc18	80 04		bra $cc1e	                bra LCC1E

2406	.cc1a					LCC1A:
2407	.cc1a	b1 da		lda ($da),y	                lda ($DA),y
2408	.cc1c	91 d8		sta ($d8),y	                sta (ZMEMT),y
2409	.cc1e					LCC1E:
2410	.cc1e	88		dey		                dey
2411	.cc1f	b1 da		lda ($da),y	                lda ($DA),y
2412	.cc21	91 d8		sta ($d8),y	                sta (ZMEMT),y
2413	.cc23					LCC23:
2414	.cc23	88		dey		                dey
2415	.cc24	d0 f4		bne $cc1a	                bne LCC1A
2416	.cc26	b2 da		lda ($da)	                lda ($DA)
2417	.cc28	92 d8		sta ($d8)	                sta (ZMEMT)
2418	.cc2a	80 e5		bra $cc11	                bra LCC11

2420						;-------------------------------------------------------------------------
2421						;
2422						; Get pointers for a text window row.
2423						;
2424						; entry:
2425						;
2426						; vduv.workspace._28; = text window stride, in bytes
2427						;
2428						; >A, <X = address
2429						;
2430						; exit:
2431						;
2432						; V=0: >A, <X = new address
2433						;
2434						; V=1: (ZTEMPC) =

2436	.cc2c					LCC2C:
2437	.cc2c	48		pha		                pha                          ;save >address
2438	.cc2d	8a		txa		                txa                          ;A=<address
2439	.cc2e	18		clc		                clc
2440	.cc2f	6d 28 03	adc $0328	                adc vduv.workspace._28       ;A=<(new address)
2441	.cc32	aa		tax		                tax                          ;X=<(new address)
2442	.cc33	68		pla		                pla                          ;restore >addcess
2443	.cc34	6d 29 03	adc $0329	                adc vduv.workspace._29       ;A=>(new address)
2444	.cc37	50 1d		bvc $cc56	                bvc rtsCC56                  ;taken if no address wrap
2445	.cc39	86 e0		stx $e0		                stx ZTEMPD+0
2446	.cc3b	29 7f		and #$7f	                and #$7F                     ;
2447	.cc3d	85 e1		sta $e1		                sta ZTEMPD+1
2448	.cc3f	05 e0		ora $e0		                ora ZTEMPD+0
2449	.cc41	f0 12		beq $cc55	                beq clv_rts
2450	.cc43	08		php		                php
2451	.cc44	38		sec		                sec
2452	.cc45	ad 28 03	lda $0328	                lda vduv.workspace._28
2453	.cc48	e5 e0		sbc $e0		                sbc ZTEMPD+0
2454	.cc4a	85 de		sta $de		                sta ZTEMPC+0
2455	.cc4c	ad 29 03	lda $0329	                lda vduv.workspace._29
2456	.cc4f	e5 e1		sbc $e1		                sbc ZTEMPD+1
2457	.cc51	85 df		sta $df		                sta ZTEMPC+1
2458	.cc53	28		plp		                plp
2459	.cc54	60		rts		                rts

2461						;-------------------------------------------------------------------------

2463	.cc55					clv_rts:
2464	.cc55	b8		clv		                clv
2465	.cc56					rtsCC56:
2466	.cc56	60		rts		                rts

2468	.cc57					LCC57:
2469	.cc57	ad 53 03	lda $0353	                lda vduv.bytesPerCharacterRow+1
2470	.cc5a	ae 52 03	ldx $0352	                ldx vduv.bytesPerCharacterRow+0
2471	.cc5d					LCC5D:
2472	.cc5d	18		clc		                clc
2473	.cc5e					LCC5E:
2474	.cc5e	08		php		                php
2475	.cc5f	48		pha		                pha
2476	.cc60	8a		txa		                txa
2477	.cc61	65 d8		adc $d8		                adc ZMEMT+0
2478	.cc63	aa		tax		                tax
2479	.cc64	68		pla		                pla
2480	.cc65	65 d9		adc $d9		                adc ZMEMT+1
2481	.cc67	10 04		bpl $cc6d	                bpl +
2482	.cc69	38		sec		                sec
2483	.cc6a	ed 54 03	sbc $0354	                sbc vduv.screenSizeHighByte ;handle wraparound at end
2484	.cc6d					+
2485	.cc6d	cd 4e 03	cmp $034e	                cmp vduv.startScreenAddressHighByte
2486	.cc70	b0 03		bcs $cc75	                bcs +
2487	.cc72	6d 54 03	adc $0354	                adc vduv.screenSizeHighByte ;handle wraparound at start
2488	.cc75					+
2489	.cc75	28		plp		                plp
2490	.cc76	60		rts		                rts

2492	.cc77					LCC77:
2493	.cc77	ad 53 03	lda $0353	                lda $0353
2494	.cc7a	ae 52 03	ldx $0352	                ldx $0352
2495	.cc7d					LCC7D:
2496	.cc7d	48		pha		                pha
2497	.cc7e	8a		txa		                txa
2498	.cc7f	49 ff		eor #$ff	                eor #$FF
2499	.cc81	aa		tax		                tax
2500	.cc82	68		pla		                pla
2501	.cc83	49 ff		eor #$ff	                eor #$FF
2502	.cc85	38		sec		                sec
2503	.cc86	80 d6		bra $cc5e	                bra LCC5E

2505	.cc88					LCC88:
2506	.cc88	cd 4e 03	cmp $034e	                cmp $034E
2507	.cc8b	d0 06		bne $cc93	                bne LCC93
2508	.cc8d	e0 00		cpx #$00	                cpx #$00
2509	.cc8f	d0 02		bne $cc93	                bne LCC93
2510	.cc91	a9 80		lda #$80	                lda #$80
2511	.cc93					LCC93:
2512	.cc93	60		rts		                rts

2514	.cc94					LCC94:
2515	.cc94	20 c9 ca	jsr $cac9	                jsr LCAC9
2516	.cc97					LCC97:
2517	.cc97	a6 dc		ldx $dc		                ldx $DC
2518	.cc99	86 d8		stx $d8		                stx ZMEMT+0
2519	.cc9b	a5 dd		lda $dd		                lda $DD
2520	.cc9d	85 d9		sta $d9		                sta ZMEMT+1
2521	.cc9f	60		rts		                rts

2523	.cca0					LCCA0:
2524	.cca0	38		sec		                sec
2525	.cca1	ad 2d 03	lda $032d	                lda $032D
2526	.cca4	ed 2f 03	sbc $032f	                sbc $032F
2527	.cca7	8d 2b 03	sta $032b	                sta $032B
2528	.ccaa	ae 2c 03	ldx $032c	                ldx $032C
2529	.ccad	ac 2f 03	ldy $032f	                ldy $032F

2531						;-------------------------------------------------------------------------
2532						;
2533						; Get display address for a text position.
2534						;
2535	.ccb0					getAddressForTextPosition:
2536	.ccb0	ad 18 03	lda $0318	                lda vduv.textCursorXPosition
2537	.ccb3	48		pha		                pha
2538	.ccb4	ad 19 03	lda $0319	                lda vduv.textCursorYPosition
2539	.ccb7	48		pha		                pha
2540	.ccb8	8e 18 03	stx $0318	                stx vduv.textCursorXPosition
2541	.ccbb	8c 19 03	sty $0319	                sty vduv.textCursorYPosition
2542	.ccbe	20 fa cc	jsr $ccfa	                jsr updateZMEMTWithTextCursorPosition
2543	.ccc1	7a		ply		                ply
2544	.ccc2	8c 19 03	sty $0319	                sty vduv.textCursorYPosition
2545	.ccc5	7a		ply		                ply
2546	.ccc6	8c 18 03	sty $0318	                sty vduv.textCursorXPosition
2547	.ccc9	60		rts		                rts

2549						;-------------------------------------------------------------------------

2551	.ccca					LCCCA:
2552	.ccca	f0 03		beq $cccf	                beq LCCCF
2553	.cccc	ca		dex		                dex
2554	.cccd	86 dc		stx $dc		                stx ZTEMPB+0
2555	.cccf					LCCCF:
2556	.cccf	ad 66 03	lda $0366	                lda vduv.cursorFlags
2557	.ccd2	29 0e		and #$0e	                and #vduv.cursorFlags.swapAxes|vduv.cursorFlags.invertVertical|vduv.cursorFlags.invertHorizontal
2558	.ccd4	aa		tax		                tax
2559	.ccd5	a5 dc		lda $dc		                lda ZTEMPB+0
2560	.ccd7					LCCD7:
2561	.ccd7	20 c7 c2	jsr $c2c7	                jsr setTextCursorXPositionWithCursorFlags
2562	.ccda					LCCDA:
2563	.ccda	ae 18 03	ldx $0318	                ldx vduv.textCursorXPosition
2564	.ccdd	ec 08 03	cpx $0308	                cpx vduv.textWindowLeft
2565	.cce0	30 16		bmi $ccf8	                bmi LCCF8            ;taken if off left edge of window
2566	.cce2	ec 0a 03	cpx $030a	                cpx vduv.textWindowRight
2567	.cce5	f0 02		beq $cce9	                beq LCCE9            ;taken if at right edge of window
2568	.cce7	10 0f		bpl $ccf8	                bpl LCCF8            ;taken if off right edge of window
2569	.cce9					LCCE9:
2570	.cce9	ae 19 03	ldx $0319	                ldx vduv.textCursorYPosition
2571	.ccec	ec 0b 03	cpx $030b	                cpx vduv.textWindowTop
2572	.ccef	30 07		bmi $ccf8	                bmi LCCF8
2573	.ccf1	ec 09 03	cpx $0309	                cpx vduv.textWindowBottom
2574	.ccf4	30 04		bmi $ccfa	                bmi updateZMEMTWithTextCursorPosition
2575	.ccf6	f0 02		beq $ccfa	                beq updateZMEMTWithTextCursorPosition
2576	.ccf8					LCCF8:
2577	.ccf8	38		sec		                sec
2578	.ccf9	60		rts		                rts

2580						;-------------------------------------------------------------------------
2581						;
2582						; Get display address for current text cursor position.
2583						;
2584						; Set up display address without using BBC lookup table at &E0/1
2585						;
2586	.ccfa					updateZMEMTWithTextCursorPosition:
2587	.ccfa	ad 56 03	lda $0356	                lda vduv.currentScreenMODEGroup
2588	.ccfd	29 fe		and #$fe	                and #$fe                     ; Reduce to 0,0,2,2,4
2589	.ccff	aa		tax		                tax                          ; Index into jump table
2590	.cd00	ac 19 03	ldy $0319	                ldy vduv.textCursorYPosition  ; Get current line
2591	.cd03	7c 06 cd	jmp ($cd06,x)	                jmp (multiplyRoutinesTable,x) ; Jump to calculation setup

2593	.cd06					multiplyRoutinesTable:
2594	>cd06	21 cd				                .word multiplyBy640     ; Memory map 0,1  MODE 0,1,2,3
2595	>cd08	15 cd				                .word multiplyBy320       ; Memory map 2,3  MODE 4,5,6
2596	>cd0a	0c cd				                .word multiplyBy40        ; Memory map 4    MODE 7

2598	.cd0c					multiplyBy40:
2599	.cd0c	be bf e0	ldx $e0bf,y	                ldx multiplyBy40TableHigh,y ; Get offset high byte for start of this line
2600	.cd0f	b9 d8 e0	lda $e0d8,y	                lda multiplyBy40TableLow,y ; Get offset low byte for start of this line
2601	.cd12	18		clc		                clc
2602	.cd13	80 14		bra $cd29	                bra LCD29

2604	.cd15					multiplyBy320:
2605	.cd15	b9 f1 e0	lda $e0f1,y	                lda multiplyBy640TableHigh,y
2606	.cd18	4a		lsr a		                lsr a
2607	.cd19	aa		tax		                tax
2608	.cd1a	98		tya		                tya
2609	.cd1b	29 03		and #$03	                and #$03
2610	.cd1d	4a		lsr a		                lsr a
2611	.cd1e	6a		ror a		                ror a
2612	.cd1f	80 07		bra $cd28	                bra LCD28

2614	.cd21					multiplyBy640:
2615	.cd21	be f1 e0	ldx $e0f1,y	                ldx multiplyBy640TableHigh,y
2616	.cd24	98		tya		                tya
2617	.cd25	29 01		and #$01	                and #$01
2618	.cd27	4a		lsr a		                lsr a
2619	.cd28					LCD28:
2620	.cd28	6a		ror a		                ror a                        ; A=A/2 +(128*carry)

2622	.cd29					LCD29:
2623	.cd29	6d 50 03	adc $0350	                adc vduv.screenTopLeftAddress+0
2624	.cd2c	85 d8		sta $d8		                sta ZMEMT+0                      ; store it
2625	.cd2e	8a		txa		                txa
2626	.cd2f	6d 51 03	adc $0351	                adc vduv.screenTopLeftAddress+1 ; window start address hi
2627	.cd32	a8		tay		                tay
2628	.cd33	ad 18 03	lda $0318	                lda vduv.textCursorXPosition  ; text column
2629	.cd36	ae 4f 03	ldx $034f	                ldx vduv.bytesPerCharacter    ; bytes per character
2630	.cd39	ca		dex		                dex
2631	.cd3a	f0 12		beq $cd4e	                beq LCD4E                    ; 1 colour, MODE 7
2632	.cd3c	e0 0f		cpx #$0f	                cpx #$0F
2633	.cd3e	f0 03		beq $cd43	                beq LCD43                    ; 4 colours, MODE 1 or MODE 5
2634	.cd40	90 02		bcc $cd44	                bcc LCD44                    ; 2 colours, MODE 0,3,4,6
2635	.cd42	0a		asl a		                asl a                        ; 16 colours, MODE 2
2636	.cd43					LCD43:
2637	.cd43	0a		asl a		                asl a
2638	.cd44					LCD44:
2639	.cd44	0a		asl a		                asl a
2640	.cd45	0a		asl a		                asl a
2641	.cd46	90 02		bcc $cd4a	                bcc LCD4A
2642	.cd48	c8		iny		                iny
2643	.cd49	c8		iny		                iny
2644	.cd4a					LCD4A:
2645	.cd4a	0a		asl a		                asl a
2646	.cd4b	90 02		bcc $cd4f	                bcc LCD4F
2647	.cd4d	c8		iny		                iny
2648	.cd4e					LCD4E:
2649	.cd4e	18		clc		                clc
2650	.cd4f					LCD4F:
2651	.cd4f	65 d8		adc $d8		                adc ZMEMT+0
2652	.cd51	85 d8		sta $d8		                sta ZMEMT+0
2653	.cd53	8d 4a 03	sta $034a	                sta vduv.textCursorCRTCAddress+0
2654	.cd56	aa		tax		                tax
2655	.cd57	98		tya		                tya
2656	.cd58	69 00		adc #$00	                adc #$00
2657	.cd5a	8d 4b 03	sta $034b	                sta vduv.textCursorCRTCAddress+1
2658	.cd5d	10 04		bpl $cd63	                bpl LCD63
2659	.cd5f	38		sec		                sec
2660	.cd60	ed 54 03	sbc $0354	                sbc vduv.screenSizeHighByte
2661	.cd63					LCD63:
2662	.cd63	85 d9		sta $d9		                sta ZMEMT+1
2663	.cd65	18		clc		                clc
2664	.cd66	60		rts		                rts

2666						;-------------------------------------------------------------------------

2668	.cd67					nextMaskedCharColumn
2669	.cd67	ee 24 03	inc $0324	                inc vduv.graphicsCursorPixelsX+0
2670	.cd6a	d0 03		bne $cd6f	                bne +
2671	.cd6c	ee 25 03	inc $0325	                inc vduv.graphicsCursorPixelsX+1
2672	.cd6f					+
2673	.cd6f	0a		asl a		                asl a
2674	.cd70					plotMaskedCharRow:
2675						                ; find next pixel to plot, updating graphics cursor X
2676						                ; as it goes. A is non-zero, so this loop will finish
2677						                ; eventually.
2678	.cd70	10 f5		bpl $cd67	                bpl nextMaskedCharColumn
2679	.cd72	5a		phy		                phy
2680	.cd73	85 dd		sta $dd		                sta ZTEMPB+1                 ;
2681	.cd75	a2 24		ldx #$24	                ldx #VDUVariables.graphicsCursorPixels
2682	.cd77	20 c8 de	jsr $dec8	                jsr gaddrEntryPoint
2683	.cd7a	80 02		bra $cd7e	                bra plotMaskedCharPixel

2685	.cd7c					plotMaskedCharPixelsLoop:
2686	.cd7c	10 03		bpl $cd81	                bpl nextMaskedCharPixel
2687	.cd7e					plotMaskedCharPixel:
2688	.cd7e	20 51 db	jsr $db51	                jsr plbyteEntryPoint
2689	.cd81					nextMaskedCharPixel
2690	.cd81	46 d1		lsr $d1		                lsr ZMASK
2691	.cd83	90 03		bcc $cd88	                bcc +
2692	.cd85	20 67 da	jsr $da67	                jsr nextColumnAndResetMask
2693	.cd88					+
2694	.cd88	06 dd		asl $dd		                asl ZTEMPB+1
2695	.cd8a	d0 f0		bne $cd7c	                bne plotMaskedCharPixelsLoop
2696	.cd8c	a2 28		ldx #$28	                ldx #VDUVariables.workspace._28
2697	.cd8e	a0 24		ldy #$24	                ldy #VDUVariables.graphicsCursorPixelsX
2698	.cd90	20 0c c9	jsr $c90c	                jsr copyTwoBytesWithinVDUVariables
2699	.cd93	7a		ply		                ply
2700	.cd94	80 50		bra $cde6	                bra nextMaskedCharY

2702	.cd96					plotCharAtGraphicsCursor:
2703	.cd96	20 3c e2	jsr $e23c	                jsr getSoftCharacterDefinitionAddress
2704	.cd99	9c 59 03	stz $0359	                stz vduv.graphicsPlotState   ;plot in foreground colour
2705	.cd9c	ad 5b 03	lda $035b	                lda vduv.foregroundGCOLMode
2706	.cd9f	29 0f		and #$0f	                and #$0F
2707	.cda1					plotFontDataAtGraphicsCursorWithPlotMode:
2708	.cda1	8d 5a 03	sta $035a	                sta vduv.graphicsPlotMode
2709	.cda4	a0 28		ldy #$28	                ldy #VDUVariables.workspace._28
2710	.cda6	20 1c c9	jsr $c91c	                jsr copyGraphicsCursorPixels
2711	.cda9	a0 24		ldy #$24	                ldy #VDUVariables.graphicsCursorPixelsX
2712	.cdab	a2 00		ldx #$00	                ldx #VDUVariables.graphicsWindowPixelsLeft
2713	.cdad	20 b4 ce	jsr $ceb4	                jsr getDistanceMask
2714	.cdb0	85 dc		sta $dc		                sta ZTEMPB+0
2715	.cdb2	a2 04		ldx #$04	                ldx #VDUVariables.graphicsWindowPixelsRight
2716	.cdb4	20 b4 ce	jsr $ceb4	                jsr getDistanceMask
2717	.cdb7	6a		ror a		                ror a
2718	.cdb8	14 dc		trb $dc		                trb ZTEMPB+0
2719	.cdba	a2 26		ldx #$26	                ldx #VDUVariables.graphicsCursorPixelsY
2720	.cdbc	a0 06		ldy #$06	                ldy #VDUVariables.graphicsWindowPixelsTop
2721	.cdbe	20 b4 ce	jsr $ceb4	                jsr getDistanceMask
2722	.cdc1	85 dd		sta $dd		                sta ZTEMPB+1
2723	.cdc3	a2 26		ldx #$26	                ldx #VDUVariables.graphicsCursorPixelsY
2724	.cdc5	a0 02		ldy #$02	                ldy #VDUVariables.graphicsWindowPixelsBottom
2725	.cdc7	20 b4 ce	jsr $ceb4	                jsr getDistanceMask
2726	.cdca	6a		ror a		                ror a
2727	.cdcb	14 dd		trb $dd		                trb ZTEMPB+1
2728	.cdcd	a0 07		ldy #$07	                ldy #$07
2729	.cdcf					copyMaskedCharLoop:
2730	.cdcf	b1 de		lda ($de),y	                lda (ZTEMPC),y               ;get font byte
2731	.cdd1	25 dc		and $dc		                and ZTEMPB+0                 ;mask out columns
2732	.cdd3	46 dd		lsr $dd		                lsr ZTEMPB+1                 ;test row
2733	.cdd5	b0 02		bcs $cdd9	                bcs +
2734	.cdd7	a9 00		lda #$00	                lda #$00                     ;mask out this row
2735	.cdd9					+
2736	.cdd9	99 2c 03	sta $032c,y	                sta vduv.workspace._2C,y
2737	.cddc	88		dey		                dey
2738	.cddd	10 f0		bpl $cdcf	                bpl copyMaskedCharLoop
2739	.cddf	a0 f8		ldy #$f8	                ldy #$F8
2740	.cde1					plotMaskedCharLoop:
2741	.cde1	b9 34 02	lda $0234,y	                lda vduv.workspace._2C-$f8,y ;get masked byte
2742	.cde4	d0 8a		bne $cd70	                bne plotMaskedCharRow        ;taken if data to write
2743	.cde6					nextMaskedCharY:
2744	.cde6	ae 26 03	ldx $0326	                ldx vduv.graphicsCursorPixelsY+0
2745	.cde9	d0 03		bne $cdee	                bne +
2746	.cdeb	ce 27 03	dec $0327	                dec vduv.graphicsCursorPixelsY+1
2747	.cdee					+
2748	.cdee	ce 26 03	dec $0326	                dec vduv.graphicsCursorPixelsY+0
2749	.cdf1	c8		iny		                iny
2750	.cdf2	d0 ed		bne $cde1	                bne plotMaskedCharLoop
2751	.cdf4	a2 2a		ldx #$2a	                ldx #VDUVariables.workspace._2A
2752	.cdf6	a0 26		ldy #$26	                ldy #VDUVariables.graphicsCursorPixelsY
2753	.cdf8	4c 0c c9	jmp $c90c	                jmp copyTwoBytesWithinVDUVariables

2755	.cdfb					vdu127AtGraphicsCursor:
2756						                ; CHR$127 is a solid block, not a backspace.
2757	.cdfb	a9 f8		lda #$f8	                lda #<terminal.chr127
2758	.cdfd	85 de		sta $de		                sta ZTEMPC+0
2759	.cdff	a9 bb		lda #$bb	                lda #>terminal.chr127
2760	.ce01	85 df		sta $df		                sta ZTEMPC+1
2761	.ce03	a2 08		ldx #$08	                ldx #$08
2762	.ce05	8e 59 03	stx $0359	                stx vduv.graphicsPlotState   ;plot in background colour
2763	.ce08	a9 00		lda #$00	                lda #$00
2764	.ce0a	80 95		bra $cda1	                bra plotFontDataAtGraphicsCursorWithPlotMode

2766	.ce0c					LCE0C:
2767	.ce0c	20 2d d1	jsr $d12d	                jsr handleColumn81
2768	.ce0f	b0 85		bcs $cd96	                bcs plotCharAtGraphicsCursor          ;taken if VDU5
2769	.ce11	ae 60 03	ldx $0360	                ldx vduv.numberOfLogicalColoursMinusOne
2770	.ce14	f0 37		beq $ce4d	                beq writeTeletextChar
2771	.ce16	20 3c e2	jsr $e23c	                jsr getSoftCharacterDefinitionAddress
2772	.ce19					writeBitmapChar:
2773	.ce19	a0 07		ldy #$07	                ldy #$07
2774	.ce1b	e0 03		cpx #$03	                cpx #$03
2775	.ce1d	f0 34		beq $ce53	                beq write2bppChar            ;taken if MODE 1/5
2776	.ce1f	b0 5b		bcs $ce7c	                bcs write4bppChar                    ;taken if MODE 2
2777	.ce21					write1bppChar:
2778	.ce21	b1 de		lda ($de),y	                lda (ZTEMPC),y
2779	.ce23	05 d2		ora $d2		                ora ZORA
2780	.ce25	45 d3		eor $d3		                eor ZEOR
2781	.ce27	91 d8		sta ($d8),y	                sta (ZMEMT),y
2782	.ce29	88		dey		                dey
2783	.ce2a	10 f5		bpl $ce21	                bpl write1bppChar
2784	.ce2c	60		rts		                rts

2786	.ce2d					vdu127EntryPoint:
2787	.ce2d	a9 20		lda #$20	                lda #$20
2788	.ce2f	2c 66 03	bit $0366	                bit $0366
2789	.ce32	d0 03		bne $ce37	                bne LCE37
2790	.ce34	20 9a c2	jsr $c29a	                jsr vdu8EntryPoint
2791	.ce37					LCE37:
2792	.ce37	20 e2 e2	jsr $e2e2	                jsr testVDU5State
2793	.ce3a	d0 bf		bne $cdfb	                bne vdu127AtGraphicsCursor
2794	.ce3c	ae 60 03	ldx $0360	                ldx vduv.numberOfLogicalColoursMinusOne
2795	.ce3f	f0 0a		beq $ce4b	                beq writeTeletextSpaceChar   ;taken if teletext mode

2797						                ; Address of space char is known.
2798	.ce41	a9 00		lda #$00	                lda #<terminal.LB900
2799	.ce43	85 de		sta $de		                sta ZTEMPC+0
2800	.ce45	a9 b9		lda #$b9	                lda #>terminal.LB900
2801	.ce47	85 df		sta $df		                sta ZTEMPC+1
2802	.ce49	80 ce		bra $ce19	                bra writeBitmapChar

2804	.ce4b					writeTeletextSpaceChar:
2805	.ce4b	a9 20		lda #$20	                lda #$20
2806	.ce4d					writeTeletextChar:
2807	.ce4d	20 e5 dd	jsr $dde5	                jsr getSAA5050FromASCII
2808	.ce50	92 d8		sta ($d8)	                sta (ZMEMT)
2809	.ce52	60		rts		                rts

2811	.ce53					write2bppChar:
2812	.ce53	a5 d9		lda $d9		                lda ZMEMT+1
2813	.ce55	a6 d8		ldx $d8		                ldx ZMEMT+0
2814	.ce57	20 e7 ce	jsr $cee7	                jsr getNextColumnAddress
2815	.ce5a					-
2816	.ce5a	b1 de		lda ($de),y	                lda (ZTEMPC),y               ;get font byte
2817	.ce5c	29 0f		and #$0f	                and #$0F                     ;get data for right 4 pixels
2818	.ce5e	aa		tax		                tax
2819	.ce5f	bd 23 e0	lda $e023,x	                lda LE013,x                  ;form byte
2820	.ce62	05 d2		ora $d2		                ora ZORA
2821	.ce64	45 d3		eor $d3		                eor ZEOR
2822	.ce66	91 e0		sta ($e0),y	                sta (ZTEMPD),y               ;write to right column
2823	.ce68	b1 de		lda ($de),y	                lda (ZTEMPC),y               ;get font byte
2824						                .if version==350
2826						                .else
2827	.ce6a	4a		lsr a		                lsr a                        ;
2828	.ce6b	4a		lsr a		                lsr a                        ;
2829	.ce6c	4a		lsr a		                lsr a                        ;
2830	.ce6d	4a		lsr a		                lsr a                        ;get data for left 4 pixels
2831						                .endif
2832	.ce6e	aa		tax		                tax                          ;
2833	.ce6f	bd 23 e0	lda $e023,x	                lda LE013,x                  ;form byte
2834	.ce72	05 d2		ora $d2		                ora ZORA
2835	.ce74	45 d3		eor $d3		                eor ZEOR
2836	.ce76	91 d8		sta ($d8),y	                sta (ZMEMT),y                ;write to left column
2837	.ce78	88		dey		                dey
2838	.ce79	10 df		bpl $ce5a	                bpl -
2839	.ce7b	60		rts		                rts

2841	.ce7c					write4bppChar:
2842	.ce7c	a5 d9		lda $d9		                lda ZMEMT+1
2843	.ce7e	a6 d8		ldx $d8		                ldx ZMEMT+0
2844	.ce80	20 d9 ce	jsr $ced9	                jsr getNext3ColumnAddresses
2845	.ce83					-
2846	.ce83	b1 de		lda ($de),y	                lda (ZTEMPC),y               ;get font byte - %abcdefgh
2847	.ce85	20 a9 ce	jsr $cea9	                jsr get4bppScreenByteFor2Pixels ;pixels g and h
2848	.ce88	91 e0		sta ($e0),y	                sta ($E0),y
2849	.ce8a	b1 de		lda ($de),y	                lda (ZTEMPC),y               ;get font byte - %abcdefgh
2850	.ce8c	4a		lsr a		                lsr a                        ;%0abcdefg
2851	.ce8d	4a		lsr a		                lsr a                        ;%00abcdef
2852	.ce8e	48		pha		                pha                          ;save %00abcdef
2853	.ce8f	20 a9 ce	jsr $cea9	                jsr get4bppScreenByteFor2Pixels ;pixels e and f
2854	.ce92	91 dc		sta ($dc),y	                sta (ZTEMPB),y
2855	.ce94	68		pla		                pla                          ;restore %00abcdef
2856	.ce95	4a		lsr a		                lsr a                        ;%000abcde
2857	.ce96	4a		lsr a		                lsr a                        ;%0000abcd
2858	.ce97	48		pha		                pha                          ;save %0000abcd
2859	.ce98	20 a9 ce	jsr $cea9	                jsr get4bppScreenByteFor2Pixels ;pixels c and d
2860	.ce9b	91 da		sta ($da),y	                sta (ZTEMP),y
2861	.ce9d	68		pla		                pla                          ;restore %0000abcd
2862	.ce9e	4a		lsr a		                lsr a                        ;%00000abc
2863	.ce9f	4a		lsr a		                lsr a                        ;%000000ab
2864	.cea0	20 a9 ce	jsr $cea9	                jsr get4bppScreenByteFor2Pixels ;pixels a and b
2865	.cea3	91 d8		sta ($d8),y	                sta (ZMEMT),y
2866	.cea5	88		dey		                dey
2867	.cea6	10 db		bpl $ce83	                bpl -
2868	.cea8	60		rts		                rts

2870	.cea9					get4bppScreenByteFor2Pixels:
2871	.cea9	29 03		and #$03	                and #$03                     ;mask out 2 pixels
2872	.ceab	aa		tax		                tax
2873	.ceac	bd 33 e0	lda $e033,x	                lda LE023,x                  ;form byte
2874	.ceaf	05 d2		ora $d2		                ora ZORA
2875	.ceb1	45 d3		eor $d3		                eor ZEOR
2876	.ceb3	60		rts		                rts

2878						;-------------------------------------------------------------------------
2879						;
2880						; Get mask indicating the distance between two 16-bit VDU variable
2881						; values - >=8, or some amount less than that.
2882						;
2883						; (These can be used for masking pixels, or counting loops, or
2884						; whatever.)
2885						;
2886						; entry:
2887						;
2888						; X = offset of value A in VDU variables
2889						;
2890						; Y = offset of value B in VDU variables
2891						;
2892						; exit:
2893						;
2894						; if distance<=0, A=255, C=1
2895						;
2896						; if distance>=8, A=0, C=0
2897						;
2898						; otherwise, A=255>>distance, C=0
2899						;
2900	.ceb4					getDistanceMask:
2901	.ceb4	38		sec		                sec
2902	.ceb5	bd 00 03	lda $0300,x	                lda vduv+0,x
2903	.ceb8	f9 00 03	sbc $0300,y	                sbc vduv+0,y
2904	.cebb	85 da		sta $da		                sta ZTEMP                    ;get result LSB
2905	.cebd	bd 01 03	lda $0301,x	                lda vduv+1,x
2906	.cec0	f9 01 03	sbc $0301,y	                sbc vduv+1,y
2907	.cec3	30 0c		bmi $ced1	                bmi distanceMask255                  ;taken if result -ve
2908	.cec5	d0 0e		bne $ced5	                bne distanceMask0                  ;taken if result >=256
2909	.cec7	a6 da		ldx $da		                ldx ZTEMP
2910	.cec9	e0 08		cpx #$08	                cpx #$08
2911	.cecb	b0 08		bcs $ced5	                bcs distanceMask0                    ;taken if result>=8
2912	.cecd	bd 37 e1	lda $e137,x	                lda distanceMasksTable,x             ;get mask for <8 items
2913	.ced0	60		rts		                rts

2915	.ced1					distanceMask255:
2916	.ced1	a9 ff		lda #$ff	                lda #%11111111
2917	.ced3	38		sec		                sec
2918	.ced4	60		rts		                rts

2920	.ced5					distanceMask0:
2921	.ced5	a9 00		lda #$00	                lda #$00
2922	.ced7	18		clc		                clc
2923	.ced8	60		rts		                rts

2925						;-------------------------------------------------------------------------
2926						;
2927						; Get addresses of next 3 columns on screen.
2928						;
2929						; entry:
2930						;
2931						; A (MSB)/X (LSB) = address
2932						;
2933						; exit:
2934						;
2935						; (ZTEMP) = column N+1
2936						; (ZTEMPB) = column N+2
2937						; (ZTEMPC) = column N+3
2938						;
2939	.ced9					getNext3ColumnAddresses:
2940	.ced9	20 e7 ce	jsr $cee7	                jsr getNextColumnAddress
2941	.cedc	86 da		stx $da		                stx ZTEMP+0
2942	.cede	85 db		sta $db		                sta ZTEMP+1
2943	.cee0	20 e7 ce	jsr $cee7	                jsr getNextColumnAddress
2944	.cee3	86 dc		stx $dc		                stx ZTEMPB+0
2945	.cee5	85 dd		sta $dd		                sta ZTEMPB+1

2947						;-------------------------------------------------------------------------
2948						;
2949						; Get address of next column on screen.
2950						;
2951						; entry:
2952						;
2953						; A (MSB)/X (LSB) = address
2954						;
2955						; exit:
2956						;
2957						; A (MSB)/X (LSB) = address of next column
2958						; (ZTEMPD) = address of next column
2959						;
2960	.cee7					getNextColumnAddress:
2961	.cee7	48		pha		                pha
2962	.cee8	8a		txa		                txa
2963	.cee9	18		clc		                clc
2964	.ceea	69 08		adc #$08	                adc #$08                     ;next column...
2965	.ceec	aa		tax		                tax
2966	.ceed	68		pla		                pla
2967	.ceee	90 06		bcc $cef6	                bcc +                        ;taken if no carry
2968	.cef0	1a		inc a		                inc a
2969	.cef1	10 03		bpl $cef6	                bpl +           ;taken if no screen address wraparound
2970	.cef3	ad 4e 03	lda $034e	                lda vduv.startScreenAddressHighByte
2971	.cef6					+
2972	.cef6	86 e0		stx $e0		                stx ZTEMPD+0
2973	.cef8	85 e1		sta $e1		                sta ZTEMPD+1
2974	.cefa	60		rts		                rts

2976						;-------------------------------------------------------------------------
2977						;
2978						; VDU 23 0 Control 6845 CRTC directly [MasRef E.3-12]
2979						;
2980	.cefb					vdu23_0_EntryPoint:
2981	.cefb	ad 1d 03	lda $031d	                lda vduv.queueEnd-7           ;get value
2982	.cefe	ac 1c 03	ldy $031c	                ldy vduv.queueEnd-8           ;get register

2984						                ; fall through to setCRTCRegister

2986						;-------------------------------------------------------------------------
2987						;
2988						; Set a CRTC register, adjusting and/or noting values if appropriate.
2989						;
2990						; entry:
2991						;
2992						; Y = register to set
2993						;
2994						; A = value

2996	.cf01					setCRTCRegister:
2997	.cf01	c0 07		cpy #$07	                cpy #$07
2998	.cf03	90 1f		bcc $cf24	                bcc setCRTCRegisterRaw
2999	.cf05	d0 03		bne $cf0a	                bne +        ;taken if not setting R7

3001						                ; Setting R7 (vsync position), so apply the *TV offset.
3002	.cf07	6d 90 02	adc $0290	                adc tvOffset
3003	.cf0a					+
3004	.cf0a	c0 08		cpy #$08	                cpy #$08
3005	.cf0c	d0 07		bne $cf15	                bne +                    ;taken if not setting R8

3007						                ; Setting R8 (interlace/delay register), so apply the
3008						                ; *TV interlace setting.
3009	.cf0e	09 00		ora #$00	                ora #$00
3010	.cf10	30 03		bmi $cf15	                bmi +       ;branch taken if bit 7 set - this is taken
3011						                            ;to imply the mode being set is Mode 7
3012	.cf12	4d 91 02	eor $0291	                eor tvInterlace ;apply *TV interlace setting
3013	.cf15					+
3014	.cf15	c0 0a		cpy #$0a	                cpy #$0A
3015	.cf17	d0 0b		bne $cf24	                bne setCRTCRegisterRaw

3017						                ; Setting R10 (cursor start register). Note the new
3018						                ; setting in the VDU variable. If in VDU5 mode, reuse
3019						                ; the result of testVDU5State - i.e., 32 - as the
3020						                ; setting, hiding the cursor.
3021	.cf19	8d 5f 03	sta $035f	                sta vduv.lastCursorStartRegisterValue
3022	.cf1c	20 e2 e2	jsr $e2e2	                jsr testVDU5State
3023	.cf1f	d0 09		bne $cf2a	                bne rtsCF2A
3024	.cf21	ad 5f 03	lda $035f	                lda vduv.lastCursorStartRegisterValue

3026						                ; fall through to setCRTCRegisterRaw

3028						;-------------------------------------------------------------------------
3029						;
3030						; Set a CRTC register.
3031						;
3032	.cf24					setCRTCRegisterRaw:
3033	.cf24	8c 00 fe	sty $fe00	                sty CRTC+0
3034	.cf27	8d 01 fe	sta $fe01	                sta CRTC+1
3035	.cf2a					rtsCF2A:
3036	.cf2a	60		rts		                rts

3038						;-------------------------------------------------------------------------
3039						;
3040						; VDU 23 1 Turn cursor on/off [MasRef E.3-12]
3041						;
3042	.cf2b					vdu23_1_EntryPoint:
3043	.cf2b	20 e2 e2	jsr $e2e2	                jsr testVDU5State
3044	.cf2e	d0 fa		bne $cf2a	                bne rtsCF2A                  ;taken if VDU5
3045	.cf30	ad 1c 03	lda $031c	                lda vduv.queueEnd-8           ;get new cursor state
3046	.cf33	29 03		and #$03	                and #$03                     ;mask off bits of interest
3047	.cf35	0a		asl a		                asl a
3048	.cf36	aa		tax		                tax
3049	.cf37	a9 20		lda #$20	                lda #$20 ;R10 value for hiding the cursor - save a few
3050						                         ;bytes by loading this here
3051	.cf39	7c 3c cf	jmp ($cf3c,x)	                jmp (LCF3C,x)

3053	.cf3c					LCF3C:
3054	>cf3c	53 cf				                .word setCRTCRegister10            ; 23,1,0... - hide
3055	>cf3e	50 cf				                .word showCursor            ; 23,1,1... - show
3056	>cf40	44 cf				                .word steadyCursor          ; 23,1,2... - steady
3057	>cf42	4b cf				                .word slowFlashCursor       ; 23,1,3... - flash slowly

3059	.cf44					steadyCursor:
3060	.cf44	a9 60		lda #$60	                lda #%01100000
3061	.cf46	1c 5f 03	trb $035f	                trb vduv.lastCursorStartRegisterValue ;steady cursor
3062	.cf49	80 05		bra $cf50	                bra showCursor

3064	.cf4b					slowFlashCursor:
3065	.cf4b	a9 60		lda #$60	                lda #%01100000
3066	.cf4d	0c 5f 03	tsb $035f	                tsb vduv.lastCursorStartRegisterValue ;slow blink cursor
3067	.cf50					showCursor:
3068	.cf50	ad 5f 03	lda $035f	                lda vduv.lastCursorStartRegisterValue
3069	.cf53					setCRTCRegister10:
3070	.cf53	a0 0a		ldy #$0a	                ldy #$0A
3071	.cf55	80 cd		bra $cf24	                bra setCRTCRegisterRaw

3073						;-------------------------------------------------------------------------
3074						;
3075						; VDU 23 2<80><93>5 Set ECF patterns [MasRef E.3-13]
3076						;
3077	.cf57					vdu23_2_EntryPoint:
3078	.cf57					vdu23_3_EntryPoint:
3079	.cf57					vdu23_4_EntryPoint:
3080	.cf57					vdu23_5_EntryPoint:
3081	.cf57	e9 01		sbc #$01	                sbc #$01  ;subtract 2 (C=0 on entry...) to get pattern
3082						                          ;index
3083	.cf59	0a		asl a		                asl a
3084	.cf5a	0a		asl a		                asl a
3085	.cf5b	0a		asl a		                asl a                        ;index*8
3086	.cf5c	69 07		adc #$07	                adc #$07                     ;index*8+7
3087	.cf5e	a8		tay		                tay
3088	.cf5f	a2 07		ldx #$07	                ldx #$07
3089	.cf61					-
3090	.cf61	bd 1c 03	lda $031c,x	                lda vduv.queueEnd-8,x
3091	.cf64	99 00 88	sta $8800,y	                sta andy.ecfPatterns,y
3092	.cf67	88		dey		                dey
3093	.cf68	ca		dex		                dex
3094	.cf69	10 f6		bpl $cf61	                bpl -
3095	.cf6b	80 26		bra $cf93	                bra LCF93

3097						;-------------------------------------------------------------------------

3099	.cf6d					vdu23_11_EntryPoint:
3100	.cf6d	ad 55 03	lda $0355	                lda vduv.currentScreenMODE
3101	.cf70	d0 01		bne $cf73	                bne +
3102						                ; Use a different table for MODE 0 - see MasRef E.3-16.
3103	.cf72	3a		dec a		                dec a                        ;
3104	.cf73					+
3105	.cf73	29 03		and #$03	                and #$03 ;index=0 (mode 4); 1 (mode 1/5); 2 (mode 2);
3106						                         ;3 (mode 0)
3107	.cf75	1a		inc a		                inc a
3108	.cf76	0a		asl a		                asl a
3109	.cf77	0a		asl a		                asl a
3110	.cf78	0a		asl a		                asl a
3111	.cf79	0a		asl a		                asl a                        ;(index+1)*16
3112	.cf7a	aa		tax		                tax
3113	.cf7b	a0 1c		ldy #$1c	                ldy #32-4
3114	.cf7d					setDefaultECFPatterns:
3115	.cf7d	bd d3 e1	lda $e1d3,x	                lda defaultECFPatterns-1,x
3116	.cf80	99 ff 87	sta $87ff,y	                sta andy.ecfPatterns-1,y     ;copy first repeat
3117	.cf83	99 03 88	sta $8803,y	                sta andy.ecfPatterns+4-1,y   ;copy second repeat
3118	.cf86	ca		dex		                dex                          ;next byte in defaults table
3119	.cf87	88		dey		                dey
3120	.cf88	98		tya		                tya
3121	.cf89	89 07		bit #$07	                bit #$07
3122	.cf8b	d0 f0		bne $cf7d	                bne setDefaultECFPatterns ;taken if pattern not filled
3123						                ; skip to start of previous pattern
3124	.cf8d	88		dey		                dey
3125	.cf8e	88		dey		                dey
3126	.cf8f	88		dey		                dey
3127	.cf90	88		dey		                dey
3128	.cf91	10 ea		bpl $cf7d	                bpl setDefaultECFPatterns
3129	.cf93					LCF93:
3130	.cf93	4c 7d c5	jmp $c57d	                jmp initializeCurrentECFPatterns

3132						;-------------------------------------------------------------------------
3133						;
3134						; VDU 23 12<80><93>15 Set simple ECF pattern [MasRef E.3-17]
3135						;
3136	.cf96					vdu23_12_EntryPoint:
3137	.cf96					vdu23_13_EntryPoint:
3138	.cf96					vdu23_14_EntryPoint:
3139	.cf96					vdu23_15_EntryPoint:
3140	.cf96	e9 0b		sbc #$0b	                sbc #$0B                     ;-12 to get pattern index
3141	.cf98	0a		asl a		                asl a                        ;index*2
3142	.cf99	0a		asl a		                asl a                        ;index*4
3143	.cf9a	0a		asl a		                asl a                        ;index*8, C=0
3144	.cf9b	69 03		adc #$03	                adc #$03                     ;index*8+3, C=0
3145	.cf9d	48		pha		                pha                          ;save offset
3146	.cf9e	a2 07		ldx #$07	                ldx #$07                     ;
3147	.cfa0					LCFA0:
3148	.cfa0	bd 1c 03	lda $031c,x	                lda vduv.queueEnd-8,x        ;get simple pattern byte
3149	.cfa3	2d 60 03	and $0360	                and vduv.numberOfLogicalColoursMinusOne ;apply logical colour limit
3150	.cfa6	85 da		sta $da		                sta ZTEMP+0
3151	.cfa8	ad 60 03	lda $0360	                lda vduv.numberOfLogicalColoursMinusOne
3152	.cfab	29 07		and #$07	                and #$07                     ;1/3/7
3153	.cfad	65 da		adc $da		                adc ZTEMP+0                  ;select 2/4/16 colour table
3154	.cfaf	a8		tay		                tay
3155	.cfb0	b9 5b e1	lda $e15b,y	                lda solidColoursTable-1,y
3156	.cfb3	9d 1c 03	sta $031c,x	                sta vduv.queueEnd-8,x
3157	.cfb6	ca		dex		                dex
3158	.cfb7	10 e7		bpl $cfa0	                bpl LCFA0
3159	.cfb9	a9 55		lda #$55	                lda #%01010101
3160	.cfbb	ae 55 03	ldx $0355	                ldx vduv.currentScreenMODE
3161	.cfbe	d0 02		bne $cfc2	                bne +                 ;taken if not MODE 0
3162	.cfc0	a9 33		lda #$33	                lda #%00110011        ;double-width pattern for MODE 0
3163	.cfc2					+
3164	.cfc2	85 da		sta $da		                sta ZTEMP+0
3165	.cfc4	7a		ply		                ply
3166	.cfc5	a2 07		ldx #$07	                ldx #$07
3167	.cfc7					LCFC7:
3168	.cfc7	bd 1c 03	lda $031c,x	                lda vduv.queueEnd-8,x
3169	.cfca	ca		dex		                dex
3170	.cfcb	5d 1c 03	eor $031c,x	                eor vduv.queueEnd-8,x
3171	.cfce	25 da		and $da		                and ZTEMP+0
3172	.cfd0	5d 1c 03	eor $031c,x	                eor vduv.queueEnd-8,x
3173	.cfd3	99 00 88	sta $8800,y	                sta andy.ecfPatterns+0,y
3174	.cfd6	99 04 88	sta $8804,y	                sta andy.ecfPatterns+4,y
3175	.cfd9	88		dey		                dey
3176	.cfda	ca		dex		                dex
3177	.cfdb	10 ea		bpl $cfc7	                bpl LCFC7
3178	.cfdd	80 b4		bra $cf93	                bra LCF93

3180						;-------------------------------------------------------------------------
3181						;
3182						; VDU 23 6 Set dotted lines pattern [MasRef E.3-13]
3183						;
3184	.cfdf					vdu23_6_EntryPoint:
3185	.cfdf	ad 1c 03	lda $031c	                lda vduv.queueEnd-8
3186	.cfe2	8d 67 03	sta $0367	                sta vduv.dotPattern
3187	.cfe5	60		rts		                rts

3189						;-------------------------------------------------------------------------
3190						;
3191						; VDU 23 7 Scroll window directly [MasRef E.3-14]
3192						;
3193	.cfe6					vdu23_7_EntryPoint:
3194	.cfe6	ad 1c 03	lda $031c	                lda vduv.queueEnd-8           ;get <m>
3195	.cfe9	d0 0a		bne $cff5	                bne scrollEntireScreen
3196	.cfeb	20 10 c9	jsr $c910	                jsr copyTextWindowToWorkspace2C
3197	.cfee	a5 d0		lda $d0		                lda STATE
3198	.cff0	29 08		and #$08	                and #STATE.isTextWindow
3199	.cff2	0a		asl a		                asl a ;A=$10 (text window active) or $00 (no text window)
3200	.cff3	80 11		bra $d006	                bra +

3202	.cff5					scrollEntireScreen:
3203	.cff5	a9 00		lda #$00	                lda #$00
3204	.cff7	8d 2c 03	sta $032c	                sta vduv.workspace._2C          ;left
3205	.cffa	8d 2f 03	sta $032f	                sta vduv.workspace._2F          ;top
3206	.cffd	20 b2 e2	jsr $e2b2	                jsr getDefaultBoundsForCurrentScreenMODE
3207	.d000	8e 2e 03	stx $032e	                stx vduv.workspace._2E          ;right
3208	.d003	8c 2d 03	sty $032d	                sty vduv.workspace._2D          ;bottom
3209	.d006					+
3210	.d006	85 dc		sta $dc		                sta ZTEMPB+0
3211	.d008	38		sec		                sec
3212	.d009	ad 2e 03	lda $032e	                lda vduv.workspace._2E          ;right
3213	.d00c	ed 2c 03	sbc $032c	                sbc vduv.workspace._2C          ;right-left
3214	.d00f	20 3b c9	jsr $c93b	                jsr getBytesPerInclusiveTextRow
3215	.d012	8d 28 03	sta $0328	                sta vduv.workspace._28+0        ;bytes per row LSB
3216	.d015	8e 29 03	stx $0329	                stx vduv.workspace._28+1        ;bytes per row MSB
3217	.d018	ae 4f 03	ldx $034f	                ldx vduv.bytesPerCharacter
3218	.d01b	e0 01		cpx #$01	                cpx #$01
3219	.d01d	f0 07		beq $d026	                beq +  ;when 1 byte/char, no cell/byte distinction
3220	.d01f	ad 1e 03	lda $031e	                lda vduv.queueEnd-6       ;get <z>
3221	.d022	f0 02		beq $d026	                beq +                ;taken if scrolling by 1 cell
3222	.d024	a2 08		ldx #$08	                ldx #$08                 ;scroll by 1 horizontal byte
3223	.d026					+
3224	.d026	8e 2a 03	stx $032a	                stx vduv.workspace._2A

3226						; <d> is a bitmask - %00000AVN.
3227						;
3228						; A is set if scrolling by axis (controlled by the VDU cursor flags)
3229						; rather than by direction.
3230						;
3231						; V is set to scroll vertically/in Y rather than horizontally/in X.
3232						;
3233						; N is set to scroll in the negative direction.

3235	.d029	ad 1d 03	lda $031d	                lda vduv.queueEnd-7           ;00000avn C=?
3236	.d02c	4a		lsr a		                lsr a                        ;000000av C=n
3237	.d02d	08		php		                php
3238	.d02e	2a		rol a		                rol a                        ;00000avn C=0
3239	.d02f	28		plp		                plp                          ;00000avn C=n
3240	.d030	2a		rol a		                rol a                        ;0000avnn C=0
3241	.d031	0a		asl a		                asl a                        ;000avnn0 C=0
3242	.d032	c9 10		cmp #$10	                cmp #$10                     ;$10 = 000a0000
3243	.d034	90 03		bcc $d039	                bcc LD039                 ;taken if scrolling by direction
3244	.d036	4d 66 03	eor $0366	                eor vduv.cursorFlags       ;adjust axes
3245	.d039					LD039:
3246	.d039	29 0e		and #$0e	                and #vduv.cursorFlags.swapAxes|vduv.cursorFlags.invertVertical|vduv.cursorFlags.invertHorizontal
3247	.d03b	05 dc		ora $dc		                ora ZTEMPB+0
3248	.d03d					LD03D:
3249	.d03d	aa		tax		                tax
3250	.d03e	ad 50 03	lda $0350	                lda vduv.screenTopLeftAddress+0
3251	.d041	85 d8		sta $d8		                sta ZMEMT+0
3252	.d043	ad 51 03	lda $0351	                lda vduv.screenTopLeftAddress+1
3253	.d046	85 d9		sta $d9		                sta ZMEMT+1
3254	.d048	20 4e d0	jsr $d04e	                jsr callScrollRoutine
3255	.d04b	4c d8 c6	jmp $c6d8	                jmp updateCRTCTextCursor

3257	.d04e					callScrollRoutine:
3258	.d04e	7c 1c e2	jmp ($e21c,x)	                jmp (scrollRoutinesTable,x)

3260	.d051					LD051:
3261	.d051	da		phx		                phx
3262	.d052	20 10 c9	jsr $c910	                jsr copyTextWindowToWorkspace2C
3263	.d055	20 08 c9	jsr $c908	                jsr copyTextWindowWidthInBytesToWorkspace28
3264	.d058	ae 4f 03	ldx $034f	                ldx $034F
3265	.d05b	8e 2a 03	stx $032a	                stx $032A
3266	.d05e	68		pla		                pla
3267	.d05f	4a		lsr a		                lsr a
3268	.d060	45 d0		eor $d0		                eor STATE
3269	.d062	29 f7		and #$f7	                and #(~STATE.isTextWindow)&$ff
3270	.d064	45 d0		eor $d0		                eor STATE
3271	.d066	0a		asl a		                asl a
3272	.d067	80 d4		bra $d03d	                bra LD03D

3274						;-------------------------------------------------------------------------
3275						;
3276						; VDU 23 8 Clear block [MasRef E.3-15]
3277						;
3278	.d069					vdu23_8_EntryPoint:
3279	.d069	9c 34 03	stz $0334	                stz $0334
3280	.d06c	9c 35 03	stz $0335	                stz $0335
3281	.d06f	20 62 e2	jsr $e262	                jsr getTextCursorPositionWithColumn81
3282	.d072	8e 36 03	stx $0336	                stx $0336
3283	.d075	8c 37 03	sty $0337	                sty $0337
3284	.d078	20 6c e2	jsr $e26c	                jsr LE25C
3285	.d07b	e8		inx		                inx
3286	.d07c	8e 38 03	stx $0338	                stx $0338
3287	.d07f	8c 39 03	sty $0339	                sty $0339
3288	.d082	a0 00		ldy #$00	                ldy #$00
3289	.d084	ad 1c 03	lda $031c	                lda $031C
3290	.d087	20 e5 d0	jsr $d0e5	                jsr LD0E5
3291	.d08a	ad 1d 03	lda $031d	                lda $031D
3292	.d08d	20 e5 d0	jsr $d0e5	                jsr LD0E5
3293	.d090	ad 33 03	lda $0333	                lda $0333
3294	.d093	cd 31 03	cmp $0331	                cmp $0331
3295	.d096	90 76		bcc $d10e	                bcc LD10E
3296	.d098	d0 08		bne $d0a2	                bne LD0A2
3297	.d09a	ad 30 03	lda $0330	                lda $0330
3298	.d09d	cd 32 03	cmp $0332	                cmp $0332
3299	.d0a0	b0 6c		bcs $d10e	                bcs LD10E
3300	.d0a2					LD0A2:
3301	.d0a2	ad 18 03	lda $0318	                lda $0318
3302	.d0a5	48		pha		                pha
3303	.d0a6	ad 19 03	lda $0319	                lda $0319
3304	.d0a9	48		pha		                pha
3305	.d0aa	ac 31 03	ldy $0331	                ldy $0331
3306	.d0ad					LD0AD:
3307	.d0ad	5a		phy		                phy
3308	.d0ae	ad 66 03	lda $0366	                lda $0366
3309	.d0b1	49 08		eor #$08	                eor #$08
3310	.d0b3	29 0e		and #$0e	                and #$0E
3311	.d0b5	aa		tax		                tax
3312	.d0b6	98		tya		                tya
3313	.d0b7	20 c7 c2	jsr $c2c7	                jsr setTextCursorXPositionWithCursorFlags
3314	.d0ba	a2 00		ldx #$00	                ldx #$00
3315	.d0bc	ad 38 03	lda $0338	                lda $0338
3316	.d0bf	cc 31 03	cpy $0331	                cpy $0331
3317	.d0c2	d0 03		bne $d0c7	                bne LD0C7
3318	.d0c4	ae 30 03	ldx $0330	                ldx $0330
3319	.d0c7					LD0C7:
3320	.d0c7	cc 33 03	cpy $0333	                cpy $0333
3321	.d0ca	f0 07		beq $d0d3	                beq LD0D3
3322	.d0cc	20 7f ca	jsr $ca7f	                jsr LCA7F
3323	.d0cf	7a		ply		                ply
3324	.d0d0	c8		iny		                iny
3325	.d0d1	80 da		bra $d0ad	                bra LD0AD

3327	.d0d3					LD0D3:
3328	.d0d3	ad 32 03	lda $0332	                lda $0332
3329	.d0d6	20 7f ca	jsr $ca7f	                jsr LCA7F
3330	.d0d9	7a		ply		                ply
3331	.d0da	68		pla		                pla
3332	.d0db	8d 19 03	sta $0319	                sta $0319
3333	.d0de	68		pla		                pla
3334	.d0df	8d 18 03	sta $0318	                sta $0318
3335	.d0e2	4c fa cc	jmp $ccfa	                jmp updateZMEMTWithTextCursorPosition

3337	.d0e5					LD0E5:
3338	.d0e5	48		pha		                pha
3339	.d0e6	29 03		and #$03	                and #$03
3340	.d0e8	0a		asl a		                asl a
3341	.d0e9	20 f0 d0	jsr $d0f0	                jsr LD0F0
3342	.d0ec	68		pla		                pla
3343	.d0ed	4a		lsr a		                lsr a
3344	.d0ee	09 01		ora #$01	                ora #$01
3345	.d0f0					LD0F0:
3346	.d0f0	aa		tax		                tax
3347	.d0f1	29 01		and #$01	                and #$01
3348	.d0f3	48		pha		                pha
3349	.d0f4	bd 34 03	lda $0334,x	                lda $0334,x
3350	.d0f7	fa		plx		                plx
3351	.d0f8	18		clc		                clc
3352	.d0f9	c8		iny		                iny
3353	.d0fa	79 1d 03	adc $031d,y	                adc $031D,y
3354	.d0fd	30 0a		bmi $d109	                bmi LD109
3355	.d0ff	dd 38 03	cmp $0338,x	                cmp $0338,x
3356	.d102	90 07		bcc $d10b	                bcc LD10B
3357	.d104	bd 38 03	lda $0338,x	                lda $0338,x
3358	.d107	80 02		bra $d10b	                bra LD10B

3360	.d109					LD109:
3361	.d109	a9 00		lda #$00	                lda #$00
3362	.d10b					LD10B:
3363	.d10b	99 2f 03	sta $032f,y	                sta $032F,y
3364	.d10e					LD10E:
3365	.d10e	60		rts		                rts

3367						;-------------------------------------------------------------------------
3368						;
3369						; VDU 23 9 Set 1st flash time [MasRef E.3-16]
3370						;
3371	.d10f					vdu23_9_EntryPoint:
3372	.d10f	38		sec		                sec

3374						;-------------------------------------------------------------------------
3375						;
3376						; VDU 23 10 Set 2nd flash time [MasRef E.3-16]
3377						;
3378	.d110					vdu23_10_EntryPoint:
3379	.d110	ae 1c 03	ldx $031c	                ldx vduv.queueEnd-8          ;get flash value
3380	.d113	a0 00		ldy #$00	                ldy #$00                     ;Y=0 for OSBYTE call
3381	.d115	90 03		bcc $d11a	                bcc doOSBYTE0A               ;taken if VDU23,10
3382	.d117	4c 27 ed	jmp $ed27	                jmp osbyte09
3383	.d11a					doOSBYTE0A:
3384	.d11a	38		sec		                sec
3385	.d11b	4c 29 ed	jmp $ed29	                jmp osbyte0A

3387						;-------------------------------------------------------------------------
3388						;
3389						; VDU 23 16 Cursor movement control [MasRef E.3-17]
3390						;
3391	.d11e					vdu23_16_EntryPoint:
3392	.d11e	ad 66 03	lda $0366	                lda vduv.cursorFlags
3393	.d121	2d 1d 03	and $031d	                and vduv.queueEnd-7          ;value AND <y>
3394	.d124	4d 1c 03	eor $031c	                eor vduv.queueEnd-8          ;(value AND <y>) EOR <x>
3395	.d127	8d 66 03	sta $0366	                sta vduv.cursorFlags
3396	.d12a	4a		lsr a		                lsr a
3397	.d12b	b0 18		bcs $d145	                bcs rtsD145            ;taken if scrollProtect flag on
3398						                ; scroll protect flag is off, so handle column 81 if
3399						                ; necessary.

3401						;-------------------------------------------------------------------------
3402						;
3403						; Handle column 81, if necessary.
3404						;
3405						; TODO - probably misnamed due to the return value
3406						;
3407						; exit:
3408						;
3409						; C=0 if not VDU 5
3410						;
3411						; C=1 if VDU 5
3412						;
3413	.d12d					handleColumn81:
3414	.d12d	48		pha		                pha
3415	.d12e	da		phx		                phx
3416	.d12f	20 e2 e2	jsr $e2e2	                jsr testVDU5State
3417	.d132	38		sec		                sec
3418	.d133	d0 0e		bne $d143	                bne plx_pla_rts        ;taken if VDU5
3419	.d135	18		clc		                clc
3420	.d136	2c 6c 03	bit $036c	                bit vduv.column81
3421	.d139	10 08		bpl $d143	                bpl plx_pla_rts        ;taken if not column 81
3422	.d13b	08		php		                php
3423	.d13c	20 f6 c3	jsr $c3f6	                jsr vdu13EntryPoint          ;CR
3424	.d13f	20 5b c2	jsr $c25b	                jsr vdu10EntryPoint          ;LF
3425	.d142	28		plp		                plp
3426	.d143					plx_pla_rts:
3427	.d143	fa		plx		                plx
3428	.d144	68		pla		                pla
3429	.d145					rtsD145:
3430	.d145	60		rts		                rts

3432						;-------------------------------------------------------------------------
3433						;
3434						; Handle PLOT. [MasRef E.3-21]
3435						;
3436						; PLOT numbers are of the form %pppppamm, where %ppppp is the PLOT
3437						; type, %a the absolute flag and %mm the PLOT mode.
3438						;
3439						; Absolute flag and mode are clear enough from [MasRef E.3-22]. The
3440						; %ppppp part isn't documented as such, so here's a list:
3441						;
3442						; %00000 =  0 = 0-7 = Plot solid line (both endpoints included) [MasRef E.3-23]
3443						; %00001 =  1 = 8-15 = Plot solid line (final point omitted) [MasRef E.3-23]
3444						; %00010 =  2 = 16-23 = Plot solid line (final point omitted) [MasRef E.3-23]
3445						; %00011 =  3 = 24-31 = Plot dotted line (final point omitted) [MasRef E.3-23]
3446						; %00100 =  4 = 32-39 = Plot solid line (initial point omitted) [MasRef E.3-24]
3447						; %00101 =  5 = 40-47 = Plot solid line (both endpoints omitted) [MasRef E.3-24]
3448						; %00110 =  6 = 48-55 = Plot dotted line (initial point omitted) [MasRef E.3-24]
3449						; %00111 =  7 = 56<80><93>63 = Plot dotted line (both endpoints omitted) [MasRef E.3-24]
3450						; %01000 =  8 = 64<80><93>71 = Plot point [MasRef E.3-24]
3451						; %01001 =  9 = 72<80><93>79 = Horizontal line fill (left and right to non-background) [MasRef E.3-24]
3452						; %01010 = 10 = 80<80><93>87 = Plot triangle [MasRef E.3-25]
3453						; %01011 = 11 = 88<80><93>95 = Horizontal line fill (right to background) [MasRef E.3-25]
3454						; %01100 = 12 = 96<80><93>103 = Plot rectangle [MasRef E.3-26]
3455						; %01101 = 13 = 104<80><93>111 = Horizontal line fill (left and right to foreground) [MasRef E.3-26]
3456						; %01110 = 14 = 112<80><93>119 = Plot parallelogram [MasRef E.3-27]
3457						; %01111 = 15 = 120<80><93>127 = Horizontal line fill (right to non-foreground) [MasRef E.3-27]
3458						; %10000 = 16 = 128<80><93>135 = Flood fill to non-background [MasRef E.3-28]
3459						; %10001 = 17 = 136<80><93>143 = Flood fill to foreground [MasRef E.3-28]
3460						; %10010 = 18 = 144<80><93>151 = Plot circle outline [MasRef E.3-28]
3461						; %10011 = 19 = 152<80><93>159 = Plot filled circle [MasRef E.3-29]
3462						; %10100 = 20 = 160<80><93>167 = Plot circular arc [MasRef E.3-29]
3463						; %10101 = 21 = 168<80><93>175 = Plot filled chord segment [MasRef E.3-30]
3464						; %10110 = 22 = 176<80><93>183 = Plot filled sector [MasRef E.3-30]
3465						; %10111 = 23 = 184<80><93>191 = Move/copy rectangle [MasRef E.3-31]
3466						; %11000 = 24 = 192<80><93>199 = Plot ellipse outline [MasRef E.3-32]
3467						; %11001 = 25 = 200<80><93>207 = Plot solid ellipse [MasRef E.3-32]
3468						; %11010 = 26 = 208-215 = Reserved [MasRef E.3-34]
3469						; %11011 = 27 = 215-223 = Reserved [MasRef E.3-34]
3470						; %11100 = 28 = 224-231 = Reserved [MasRef E.3-34]
3471						; %11101 = 29 = 232-239 = Reserved for Acornsoft sprites [MasRef E.3-34]
3472						; %11110 = 30 = 240-247 = User program calls [MasRef E.3-34]
3473						; %11111 = 31 = 248-255 = User program calls [MasRef E.3-34]
3474						;
3475						; entry:
3476						;
3477						; vduQueueEnd-5 = PLOT number
3478						;
3479						; vduQueueEnd-3 = X coordinate
3480						;
3481						; vduQueueEnd-1 = Y coordinate
3482						;;

3484	.d146					handlePLOT:
3485	.d146	a2 20		ldx #$20	                ldx #VDUVariables.queueEnd-4
3486	.d148	20 e2 d1	jsr $d1e2	                jsr eigabsForPLOT
3487	.d14b	ad 1f 03	lda $031f	                lda vduv.queueEnd-5          ;get PLOT number
3488	.d14e	a0 05		ldy #$05	                ldy #gcolModeLeave                     ;
3489	.d150	29 03		and #$03	                and #$03                     ;mask out colour/plot mode [MasRef E.3-22]
3490	.d152	f0 0c		beq $d160	                beq LD160 ;taken if <p> MOD 4=0 - early out
3491	.d154	4a		lsr a		                lsr a                        ;C=1 if using VDU18 settings
3492	.d155	88		dey		                dey                          ;Y=gcolModeInvert
3493	.d156	90 08		bcc $d160	                bcc LD160                    ;taken if invert mode
3494	.d158	aa		tax		                tax              ;X=0 if fg settings, 1 if bg settings
3495	.d159	bc 5b 03	ldy $035b,x	                ldy vduv.foregroundGCOLMode,x
3496	.d15c	0a		asl a		                asl a
3497	.d15d	0a		asl a		                asl a
3498	.d15e	0a		asl a		                asl a
3499	.d15f	aa		tax		                tax              ;X=0 if fg settings, 8 if bg settings
3500	.d160					LD160:
3501	.d160	8e 59 03	stx $0359	                stx vduv.graphicsPlotState
3502	.d163	98		tya		                tya
3503	.d164	29 0f		and #$0f	                and #$0F
3504	.d166	8d 5a 03	sta $035a	                sta vduv.graphicsPlotMode
3505	.d169	ad 1f 03	lda $031f	                lda vduv.queueEnd-5          ;get PLOT number pppppmmm
3506	.d16c	4a		lsr a		                lsr a                        ;0pppppmm
3507	.d16d	4a		lsr a		                lsr a                        ;00pppppm
3508	.d16e	29 fe		and #$fe	                and #$fe                     ;00ppppp0
3509	.d170	aa		tax		                tax
3510	.d171	c9 34		cmp #$34	                cmp #208/4
3511	.d173	b0 1b		bcs $d190	                bcs LD190                    ;taken if reserved PLOT
3512	.d175	29 f3		and #$f3	                and #$F3                     ;00pp00p0
3513	.d177	c9 12		cmp #$12	                cmp #$12                     ;
3514	.d179	08		php		                php                          ;
3515	.d17a	f0 08		beq $d184	                beq LD184                ;taken if horizonal line fill
3516	.d17c	e0 2e		cpx #$2e	                cpx #184/4
3517	.d17e	f0 04		beq $d184	                beq LD184                ;taken if move/copy rectangle
3518	.d180	c0 05		cpy #$05	                cpy #gcolModeLeave
3519	.d182	f0 19		beq $d19d	                beq LD19D
3520	.d184					LD184:
3521	.d184	ad 1f 03	lda $031f	                lda vduv.queueEnd-5          ;get PLOT number
3522	.d187	20 93 d1	jsr $d193	                jsr LD193
3523	.d18a	28		plp		                plp
3524	.d18b	d0 11		bne $d19e	                bne LD19E
3525	.d18d	4c df c4	jmp $c4df	                jmp LC4DF

3527	.d190					LD190:
3528	.d190	4c a3 c6	jmp $c6a3	                jmp callVDUVForPLOT

3530	.d193					LD193:
3531	.d193	e0 10		cpx #$10	                cpx #64/4
3532	.d195	b0 03		bcs $d19a	                bcs LD19A                     ;taken if PLOT >=64
3533	.d197	4c a9 d8	jmp $d8a9	                jmp LD8A9                    ;handle line PLOTs

3535	.d19a					LD19A:
3536	.d19a	7c 8b e0	jmp ($e08b,x)	                jmp (plotEntryPointTable-8*2,x)

3538	.d19d					LD19D:
3539	.d19d	68		pla		                pla
3540	.d19e					LD19E:
3541	.d19e	20 1a c9	jsr $c91a	                jsr copyGraphicsCursorPixelsToOldGraphicsCursorPixels
3542	.d1a1	a0 24		ldy #$24	                ldy #$24
3543	.d1a3	4c 16 c9	jmp $c916	                jmp copyLastFourVDUQueueBytes

3545	.d1a6					LD1A6:
3546	.d1a6	a2 24		ldx #$24	                ldx #VDUVariables.graphicsCursorPixelsX

3548						;-------------------------------------------------------------------------
3549						;
3550						; WIND [MasRef E.4-7]. The result is a bit field, %vvhh, where %vv is
3551						; the outcode for the vertical axis and %hh the outcode for the
3552						; horizontal axis. Each outcode is %xn, where x is set if point above
3553						; maximum and n set if point below minimum. (Of course, %11 is then
3554						; not possible.)
3555						;
3556						; See https://en.wikipedia.org/wiki/Cohen%E2%80%93Sutherland_algorithm
3557						;
3558						; So the possible results, in binary, are:
3559						;
3560						; %1001 | %1000 | %1010
3561						; ------+-------+------
3562						; %0001 | %0000 | %0010
3563						; ------+-------+------
3564						; %0101 | %0100 | %0110
3565						;
3566	.d1a8					windEntryPoint:
3567	.d1a8	e8		inx		                inx
3568	.d1a9	e8		inx		                inx                          ;point to Y coordinate
3569	.d1aa	20 b5 d1	jsr $d1b5	                jsr getOutcodeForYAxis                    ;process Y coordinate
3570	.d1ad	ca		dex		                dex
3571	.d1ae	ca		dex		                dex                          ;point to X coordinate
3572	.d1af	0a		asl a		                asl a
3573	.d1b0	0a		asl a		                asl a                        ;shift Y outcode into bits 2/3
3574	.d1b1	a0 00		ldy #$00	                ldy #$00                     ;doing Y axis
3575	.d1b3	80 04		bra $d1b9	                bra updateOutcodeForAxis

3577						;-------------------------------------------------------------------------
3578						;
3579	.d1b5					getOutcodeForYAxis:
3580	.d1b5	a0 02		ldy #$02	                ldy #$02                     ;Y=2 for Y coordinate
3581						;-------------------------------------------------------------------------
3582						;
3583						; Get outcode for X or Y axis.
3584						;
3585						; entry:
3586						;
3587						; X = offset in VDU variables of coordinate
3588						;
3589						; Y = 0 if X axis, 2 if Y axis
3590						;
3591						; exit:
3592						;
3593						; ZTEMP?0 = outcode - 0, 1 or 2
3594						;
3595						; A = outcode
3596						;
3597						; N/Z set as per outcode
3598						;
3599	.d1b7					getOutcodeForAxis:
3600	.d1b7	a9 00		lda #$00	                lda #$00                     ;initialize result

3602						;-------------------------------------------------------------------------
3603						;
3604						; Update outcode for X or Y axis
3605						;
3606						; entry: as per getOutcodeForAxis
3607						;
3608						; exit:
3609						;
3610						; ZTEMP?0 = updated; outcode is added to its existing value
3611						;
3612	.d1b9					updateOutcodeForAxis:
3613	.d1b9	85 da		sta $da		                sta ZTEMP+0                  ;save current result
3614						                ; set flags for coordinate-minimum
3615	.d1bb	bd 00 03	lda $0300,x	                lda vduv+0,x
3616	.d1be	d9 00 03	cmp $0300,y	                cmp vduv.graphicsWindowPixelsLeft+0,y
3617	.d1c1	bd 01 03	lda $0301,x	                lda vduv+1,x
3618	.d1c4	f9 01 03	sbc $0301,y	                sbc vduv.graphicsWindowPixelsLeft+1,y
3619	.d1c7	30 10		bmi $d1d9	                bmi add1ToOutcode ;taken if point below minimum - outcode is 1

3621						                ; set flags for maximum-coordinate
3622	.d1c9	b9 04 03	lda $0304,y	                lda vduv.graphicsWindowPixelsRight+0,y
3623	.d1cc	dd 00 03	cmp $0300,x	                cmp vduv+0,x
3624	.d1cf	b9 05 03	lda $0305,y	                lda vduv.graphicsWindowPixelsRight+1,y
3625	.d1d2	fd 01 03	sbc $0301,x	                sbc vduv+1,x
3626	.d1d5	10 04		bpl $d1db	                bpl gotOutcode ;taken if point below maximum - axis outcode is 0
3627						                ; point is above maximum - axis outcode is 2
3628	.d1d7					add2ToOutcode:
3629	.d1d7	e6 da		inc $da		                inc ZTEMP+0
3630	.d1d9					add1ToOutcode:
3631	.d1d9	e6 da		inc $da		                inc ZTEMP+0
3632	.d1db					gotOutcode:
3633	.d1db	a5 da		lda $da		                lda ZTEMP+0
3634	.d1dd	60		rts		                rts

3636						;-------------------------------------------------------------------------
3637						;
3638						; EIGABS entry point.
3639						;
3640	.d1de					eigabsEntryPoint:
3641	.d1de	a9 ff		lda #$ff	                lda #$FF ;pretend it's PLOT 255 (as that would be absolute coordinates)
3642	.d1e0	80 03		bra $d1e5	                bra eigabsCommon

3644						;-------------------------------------------------------------------------
3645						;
3646						; EIGABS, but for a VDU 25. Handles relative/absolute addressing,
3647						; based on the PLOT number in the VDU queue.
3648						;
3649	.d1e2					eigabsForPLOT:
3650	.d1e2	ad 1f 03	lda $031f	                lda vduv.queueEnd-5          ;get PLOT number

3652						;-------------------------------------------------------------------------
3653						;
3654						; EIGABS shared code.
3655						;
3656	.d1e5					eigabsCommon:
3657	.d1e5	85 da		sta $da		                sta ZTEMP+0                  ;save PLOT number
3658	.d1e7	a0 02		ldy #$02	                ldy #$02                     ;process Y
3659	.d1e9	20 0b d2	jsr $d20b	                jsr handleExternalCoordinate
3660	.d1ec	20 42 d2	jsr $d242	                jsr divideCoordinatesBy2     ;divide Y by 4 - convert 0-1023 to 0-255
3661	.d1ef	a0 00		ldy #$00	                ldy #$00                     ;process X
3662	.d1f1	ca		dex		                dex                          ;...
3663	.d1f2	ca		dex		                dex                          ;...
3664	.d1f3	20 0b d2	jsr $d20b	                jsr handleExternalCoordinate
3665	.d1f6	ac 61 03	ldy $0361	                ldy vduv.pixelsPerByteMinusOne
3666	.d1f9	c0 03		cpy #$03	                cpy #$03  ;
3667	.d1fb	f0 05		beq $d202	                beq +     ;branch taken if mode 1/5 - divide by 4 or 8
3668	.d1fd	b0 06		bcs $d205	                bcs ++    ;branch taken if mode 0/4 - divide by 2 or 4
3669	.d1ff	20 42 d2	jsr $d242	                jsr divideCoordinatesBy2     ;mode 2 - divide by 8
3670	.d202					+
3671	.d202	20 42 d2	jsr $d242	                jsr divideCoordinatesBy2
3672	.d205					+
3673	.d205	ad 56 03	lda $0356	                lda vduv.currentScreenMODEGroup
3674	.d208	d0 38		bne $d242	                bne divideCoordinatesBy2     ;branch taken if MODE 4/5
3675	.d20a	60		rts		                rts

3677						;-------------------------------------------------------------------------
3678						;
3679						; Handle external coordinate.
3680						;
3681						; 1. Deal with absolute or relative PLOTting
3682						;
3683						; 2. Update graphics cursor position
3684						;
3685						; 3. Handle window origin
3686						;
3687						; 4. Update input coordinate
3688						;
3689						; 5. Divide result by 2 (as this always needs doing at least once)
3690						;
3691						; entry:
3692						;
3693						; ZTEMP?0 = PLOT number
3694						;
3695						; X = offset-2 of external coordinates
3696						;
3697						; Y = 0 to process X coordinate, 2 to process Y coordinate
3698						;
3699	.d20b					handleExternalCoordinate:
3700	.d20b	18		clc		                clc
3701	.d20c	a5 da		lda $da		                lda ZTEMP+0                  ;get PLOT number
3702	.d20e	29 04		and #$04	                and #$04                     ;get absolute/relative flag
3703	.d210	f0 09		beq $d21b	                beq relativePLOT             ;branch taken if relative
3704	.d212					absolutePLOT:
3705	.d212	bd 02 03	lda $0302,x	                lda vduv+2,x                 ;get coordinate LSB
3706	.d215	48		pha		                pha                          ;save coordinate LSB
3707	.d216	bd 03 03	lda $0303,x	                lda vduv+3,x                 ;get coordinate MSB
3708	.d219	80 0e		bra $d229	                bra LD229                    ;

3710	.d21b					relativePLOT:
3711	.d21b	bd 02 03	lda $0302,x	                lda vduv+2,x                 ;get coordinate LSB
3712	.d21e	79 10 03	adc $0310,y	                adc vduv.graphicsCursorPositionX+0,y ;add current position LSB
3713	.d221	48		pha		                pha                                  ;save coordinate LSB
3714	.d222	bd 03 03	lda $0303,x	                lda vduv+3,x                 ;get coordinate MSB
3715	.d225	79 11 03	adc $0311,y	                adc vduv.graphicsCursorPositionX+1,y ;add current position MSB
3716	.d228	18		clc		                clc
3717	.d229					LD229:
3718	.d229	99 11 03	sta $0311,y	                sta vduv.graphicsCursorPositionX+1,y ;update current position MSB
3719	.d22c	79 0d 03	adc $030d,y	                adc vduv.graphicsWindowOriginX+1,y   ;add window origin MSB
3720	.d22f	9d 03 03	sta $0303,x	                sta vduv+3,x                  ;update coordinate MSB
3721	.d232	68		pla		                pla                          ;restore coordinate LSB
3722	.d233	99 10 03	sta $0310,y	                sta vduv.graphicsCursorPositionX+0,y ;update current position LSB
3723	.d236	18		clc		                clc
3724	.d237	79 0c 03	adc $030c,y	                adc vduv.graphicsWindowOriginX+0,y ;add window origin LSB
3725	.d23a	9d 02 03	sta $0302,x	                sta vduv+2,x                       ;update coordinate LSB
3726	.d23d	90 03		bcc $d242	                bcc +
3727	.d23f	fe 03 03	inc $0303,x	                inc vduv+3,x       ;handle carry, ignored earlier
3728	.d242					+

3730	.d242					divideCoordinatesBy2:
3731	.d242	bd 03 03	lda $0303,x	                lda vduv+3,x
3732	.d245	0a		asl a		                asl a                        ;C=bit 7
3733	.d246	7e 03 03	ror $0303,x	                ror vduv+3,x                  ;signed divide by 2
3734	.d249	7e 02 03	ror $0302,x	                ror vduv+2,x                  ;signed divide by 2
3735	.d24c	60		rts		                rts

3737						;-------------------------------------------------------------------------

3739	.d24d					LD24D:
3740	.d24d	da		phx		                phx
3741	.d24e	5a		phy		                phy
3742	.d24f	5a		phy		                phy
3743	.d250	da		phx		                phx
3744	.d251	5a		phy		                phy
3745	.d252	20 80 d2	jsr $d280	                jsr LD280
3746	.d255	fa		plx		                plx
3747	.d256	20 80 d2	jsr $d280	                jsr LD280
3748	.d259	fa		plx		                plx
3749	.d25a	7a		ply		                ply
3750	.d25b	20 e8 da	jsr $dae8	                jsr LDAE8
3751	.d25e	fa		plx		                plx
3752	.d25f	20 68 d2	jsr $d268	                jsr LD268
3753	.d262	fa		plx		                plx
3754	.d263	80 03		bra $d268	                bra LD268

3756	.d265					LD265:
3757	.d265	20 39 9b	jsr $9b39	                jsr terminal.L9B09
3758	.d268					LD268:
3759	.d268	a0 00		ldy #$00	                ldy #$00
3760	.d26a	20 70 d2	jsr $d270	                jsr LD270
3761	.d26d	e8		inx		                inx
3762	.d26e	a0 02		ldy #$02	                ldy #$02
3763	.d270					LD270:
3764	.d270	38		sec		                sec
3765	.d271	20 76 d2	jsr $d276	                jsr LD276
3766	.d274	e8		inx		                inx
3767	.d275	c8		iny		                iny
3768	.d276					LD276:
3769	.d276	bd 00 03	lda $0300,x	                lda $0300,x
3770	.d279	f9 14 03	sbc $0314,y	                sbc $0314,y
3771	.d27c	9d 00 03	sta $0300,x	                sta $0300,x
3772	.d27f					LD27F:
3773	.d27f	60		rts		                rts

3775	.d280					LD280:
3776	.d280	a0 00		ldy #$00	                ldy #$00
3777	.d282	20 88 d2	jsr $d288	                jsr LD288
3778	.d285	e8		inx		                inx
3779	.d286	a0 02		ldy #$02	                ldy #$02
3780	.d288					LD288:
3781	.d288	18		clc		                clc
3782	.d289	20 8e d2	jsr $d28e	                jsr LD28E
3783	.d28c	e8		inx		                inx
3784	.d28d	c8		iny		                iny
3785	.d28e					LD28E:
3786	.d28e	bd 00 03	lda $0300,x	                lda $0300,x
3787	.d291	79 14 03	adc $0314,y	                adc $0314,y
3788	.d294	9d 00 03	sta $0300,x	                sta $0300,x
3789	.d297	60		rts		                rts

3791	.d298					LD298:
3792	.d298	85 e1		sta $e1		                sta $E1
3793	.d29a	20 25 d4	jsr $d425	                jsr LD425
3794	.d29d	f0 e0		beq $d27f	                beq LD27F
3795	.d29f	a0 14		ldy #$14	                ldy #$14
3796	.d2a1	a9 20		lda #$20	                lda #$20
3797	.d2a3	a2 2c		ldx #$2c	                ldx #$2C
3798	.d2a5	20 65 d2	jsr $d265	                jsr LD265
3799	.d2a8	20 aa d3	jsr $d3aa	                jsr LD3AA
3800	.d2ab	a9 01		lda #$01	                lda #$01
3801	.d2ad					LD2AD:
3802	.d2ad	84 e0		sty $e0		                sty $E0
3803	.d2af	04 e0		tsb $e0		                tsb $E0
3804	.d2b1	a2 2c		ldx #$2c	                ldx #VDUVariables.workspace._2C
3805	.d2b3	a0 28		ldy #$28	                ldy #VDUVariables.workspace._28
3806	.d2b5	20 1e c9	jsr $c91e	                jsr copyFourBytesWithinVDUVariables
3807	.d2b8	2c 35 03	bit $0335	                bit $0335
3808	.d2bb	08		php		                php
3809	.d2bc	a2 2c		ldx #$2c	                ldx #$2C
3810	.d2be	20 26 d7	jsr $d726	                jsr LD726
3811	.d2c1	28		plp		                plp
3812	.d2c2	10 03		bpl $d2c7	                bpl LD2C7
3813	.d2c4	20 aa d3	jsr $d3aa	                jsr LD3AA
3814	.d2c7					LD2C7:
3815	.d2c7	ac 2c 03	ldy $032c	                ldy $032C
3816	.d2ca	ad 2d 03	lda $032d	                lda $032D
3817	.d2cd	30 03		bmi $d2d2	                bmi LD2D2
3818	.d2cf	20 2e c9	jsr $c92e	                jsr negateAY
3819	.d2d2					LD2D2:
3820	.d2d2	48		pha		                pha
3821	.d2d3	18		clc		                clc
3822	.d2d4	98		tya		                tya
3823	.d2d5	6d 30 88	adc $8830	                adc L8830
3824	.d2d8	a8		tay		                tay
3825	.d2d9	68		pla		                pla
3826	.d2da	6d 31 88	adc $8831	                adc L8831
3827	.d2dd	10 ce		bpl $d2ad	                bpl LD2AD
3828	.d2df	1a		inc a		                inc a
3829	.d2e0	d0 23		bne $d305	                bne LD305
3830	.d2e2	c8		iny		                iny
3831	.d2e3	d0 20		bne $d305	                bne LD305
3832	.d2e5	a5 e0		lda $e0		                lda $E0
3833	.d2e7	f0 1c		beq $d305	                beq LD305
3834	.d2e9	ad 2c 03	lda $032c	                lda $032C
3835	.d2ec	cd 28 03	cmp $0328	                cmp $0328
3836	.d2ef	f0 14		beq $d305	                beq LD305
3837	.d2f1	a2 2c		ldx #$2c	                ldx #$2C
3838	.d2f3	a0 28		ldy #$28	                ldy #$28
3839	.d2f5	ad 36 03	lda $0336	                lda $0336
3840	.d2f8	0a		asl a		                asl a
3841	.d2f9	4d 36 03	eor $0336	                eor $0336
3842	.d2fc	10 04		bpl $d302	                bpl LD302
3843	.d2fe	e8		inx		                inx
3844	.d2ff	e8		inx		                inx
3845	.d300	c8		iny		                iny
3846	.d301	c8		iny		                iny
3847	.d302					LD302:
3848	.d302	20 0c c9	jsr $c90c	                jsr copyTwoBytesWithinVDUVariables
3849	.d305					LD305:
3850	.d305	20 25 d4	jsr $d425	                jsr LD425
3851	.d308	ad 29 03	lda $0329	                lda $0329
3852	.d30b	aa		tax		                tax
3853	.d30c	4d 1c 03	eor $031c	                eor $031C
3854	.d30f	30 18		bmi $d329	                bmi LD329
3855	.d311	a0 02		ldy #$02	                ldy #$02
3856	.d313	20 6f d4	jsr $d46f	                jsr LD46F
3857	.d316	d0 0c		bne $d324	                bne LD324
3858	.d318	ae 2b 03	ldx $032b	                ldx $032B
3859	.d31b	a0 00		ldy #$00	                ldy #$00
3860	.d31d	20 6f d4	jsr $d46f	                jsr LD46F
3861	.d320	f0 11		beq $d333	                beq LD333
3862	.d322	49 80		eor #$80	                eor #$80
3863	.d324					LD324:
3864	.d324	86 da		stx $da		                stx $DA
3865	.d326	45 da		eor $da		                eor $DA
3866	.d328	aa		tax		                tax
3867	.d329					LD329:
3868	.d329	8a		txa		                txa
3869	.d32a	29 80		and #$80	                and #$80
3870	.d32c	f0 02		beq $d330	                beq LD330
3871	.d32e	a9 c0		lda #$c0	                lda #$C0
3872	.d330					LD330:
3873	.d330	04 e1		tsb $e1		                tsb $E1
3874	.d332	18		clc		                clc
3875	.d333					LD333:
3876	.d333	60		rts		                rts

3878	.d334					LD334:
3879	.d334	a5 e1		lda $e1		                lda $E1
3880	.d336	8d 48 88	sta $8848	                sta L8848
3881	.d339	89 03		bit #$03	                bit #$03
3882	.d33b	f0 f6		beq $d333	                beq LD333
3883	.d33d	a9 10		lda #$10	                lda #$10
3884	.d33f	85 dc		sta $dc		                sta $DC
3885	.d341	0a		asl a		                asl a
3886	.d342	85 dd		sta $dd		                sta $DD
3887	.d344	a2 1b		ldx #$1b	                ldx #$1B
3888	.d346	20 4f d3	jsr $d34f	                jsr LD34F
3889	.d349	06 dc		asl $dc		                asl $DC
3890	.d34b	46 dd		lsr $dd		                lsr $DD
3891	.d34d	a2 28		ldx #$28	                ldx #$28
3892	.d34f					LD34F:
3893	.d34f	a9 80		lda #$80	                lda #$80
3894	.d351	85 da		sta $da		                sta $DA
3895	.d353	bd 02 03	lda $0302,x	                lda $0302,x
3896	.d356	cd 32 88	cmp $8832	                cmp L8832
3897	.d359	d0 d8		bne $d333	                bne LD333
3898	.d35b	bd 03 03	lda $0303,x	                lda $0303,x
3899	.d35e	cd 33 88	cmp $8833	                cmp L8833
3900	.d361	d0 d0		bne $d333	                bne LD333
3901	.d363	bc 00 03	ldy $0300,x	                ldy $0300,x
3902	.d366	bd 01 03	lda $0301,x	                lda $0301,x
3903	.d369	10 05		bpl $d370	                bpl LD370
3904	.d36b	46 da		lsr $da		                lsr $DA
3905	.d36d	20 2e c9	jsr $c92e	                jsr negateAY
3906	.d370					LD370:
3907	.d370	cc 30 88	cpy $8830	                cpy L8830
3908	.d373	d0 be		bne $d333	                bne LD333
3909	.d375	cd 31 88	cmp $8831	                cmp L8831
3910	.d378	d0 b9		bne $d333	                bne LD333
3911	.d37a	a5 e1		lda $e1		                lda $E1
3912	.d37c	89 02		bit #$02	                bit #$02
3913	.d37e	f0 19		beq $d399	                beq LD399
3914	.d380	a0 30		ldy #$30	                ldy #$30
3915	.d382	89 01		bit #$01	                bit #$01
3916	.d384	f0 02		beq $d388	                beq LD388
3917	.d386	a4 dc		ldy $dc		                ldy $DC
3918	.d388					LD388:
3919	.d388	98		tya		                tya
3920	.d389	4a		lsr a		                lsr a
3921	.d38a	4a		lsr a		                lsr a
3922	.d38b	24 e1		bit $e1		                bit $E1
3923	.d38d	d0 06		bne $d395	                bne LD395
3924	.d38f	05 dc		ora $dc		                ora $DC
3925	.d391	04 e1		tsb $e1		                tsb $E1
3926	.d393	80 04		bra $d399	                bra LD399

3928	.d395					LD395:
3929	.d395	05 dd		ora $dd		                ora $DD
3930	.d397	14 e1		trb $e1		                trb $E1
3931	.d399					LD399:
3932	.d399	a5 da		lda $da		                lda $DA
3933	.d39b	24 e1		bit $e1		                bit $E1
3934	.d39d	f0 91		beq $d330	                beq LD330
3935	.d39f	14 e1		trb $e1		                trb $E1
3936	.d3a1	a5 e1		lda $e1		                lda $E1
3937	.d3a3	8d 48 88	sta $8848	                sta L8848
3938	.d3a6	8d 49 88	sta $8849	                sta L8849
3939	.d3a9	60		rts		                rts

3941	.d3aa					LD3AA:
3942	.d3aa	ad 2e 03	lda $032e	                lda $032E
3943	.d3ad	8d 32 88	sta $8832	                sta L8832
3944	.d3b0	ad 2f 03	lda $032f	                lda $032F
3945	.d3b3	8d 33 88	sta $8833	                sta L8833
3946	.d3b6	20 fc d3	jsr $d3fc	                jsr LD3FC
3947	.d3b9	20 13 d5	jsr $d513	                jsr LD513
3948	.d3bc	8c 30 88	sty $8830	                sty L8830
3949	.d3bf	ad 46 88	lda $8846	                lda L8846
3950	.d3c2	4a		lsr a		                lsr a
3951	.d3c3	ad 3d 88	lda $883d	                lda L883D
3952	.d3c6	90 06		bcc $d3ce	                bcc LD3CE
3953	.d3c8	c9 80		cmp #$80	                cmp #$80
3954	.d3ca	6a		ror a		                ror a
3955	.d3cb	6e 30 88	ror $8830	                ror L8830
3956	.d3ce					LD3CE:
3957	.d3ce	8d 31 88	sta $8831	                sta L8831
3958	.d3d1	60		rts		                rts

3960	.d3d2					LD3D2:
3961	.d3d2	9c 47 88	stz $8847	                stz L8847
3962	.d3d5	9c 30 88	stz $8830	                stz L8830
3963	.d3d8	9c 31 88	stz $8831	                stz L8831
3964	.d3db	9c 34 88	stz $8834	                stz L8834
3965	.d3de	9c 35 88	stz $8835	                stz L8835
3966	.d3e1	ad 32 88	lda $8832	                lda L8832
3967	.d3e4	0a		asl a		                asl a
3968	.d3e5	8d 36 88	sta $8836	                sta L8836
3969	.d3e8	ad 33 88	lda $8833	                lda L8833
3970	.d3eb	2a		rol a		                rol a
3971	.d3ec	8d 37 88	sta $8837	                sta L8837
3972	.d3ef	ad 46 88	lda $8846	                lda L8846
3973	.d3f2	89 02		bit #$02	                bit #$02
3974	.d3f4	f0 06		beq $d3fc	                beq LD3FC
3975	.d3f6	0e 36 88	asl $8836	                asl L8836
3976	.d3f9	2e 37 88	rol $8837	                rol L8837
3977	.d3fc					LD3FC:
3978	.d3fc	ad 46 88	lda $8846	                lda L8846
3979	.d3ff	4a		lsr a		                lsr a
3980	.d400	4a		lsr a		                lsr a
3981	.d401	ac 32 88	ldy $8832	                ldy L8832
3982	.d404	ad 33 88	lda $8833	                lda L8833
3983	.d407	20 c5 d4	jsr $d4c5	                jsr LD4C5
3984	.d40a	38		sec		                sec
3985	.d40b	a2 fc		ldx #$fc	                ldx #$FC
3986	.d40d					LD40D:
3987	.d40d	bd 3c 87	lda $873c,x	                lda L873C,x
3988	.d410	fd 44 87	sbc $8744,x	                sbc L8744,x
3989	.d413	9d 44 87	sta $8744,x	                sta L8744,x
3990	.d416	e8		inx		                inx
3991	.d417	d0 f4		bne $d40d	                bne LD40D
3992	.d419	60		rts		                rts

3994	.d41a					LD41A:
3995	.d41a	20 1a c9	jsr $c91a	                jsr copyGraphicsCursorPixelsToOldGraphicsCursorPixels
3996	.d41d	64 e1		stz $e1		                stz $E1
3997	.d41f	a2 20		ldx #$20	                ldx #$20
3998	.d421	20 27 d4	jsr $d427	                jsr LD427
3999	.d424	60		rts		                rts

4001	.d425					LD425:
4002	.d425	a2 24		ldx #$24	                ldx #VDUVariables.graphicsCursorPixelsX
4003	.d427					LD427:
4004	.d427	a0 1b		ldy #$1b	                ldy #VDUVariables.queueEnd-9
4005	.d429	20 1e c9	jsr $c91e	                jsr copyFourBytesWithinVDUVariables
4006	.d42c	a2 1b		ldx #$1b	                ldx #$1B
4007	.d42e	20 68 d2	jsr $d268	                jsr LD268
4008	.d431	20 86 d4	jsr $d486	                jsr LD486
4009	.d434	20 13 d5	jsr $d513	                jsr LD513
4010	.d437	a0 0c		ldy #$0c	                ldy #$0C
4011	.d439	20 ab d4	jsr $d4ab	                jsr LD4AB
4012	.d43c	20 13 d5	jsr $d513	                jsr LD513
4013	.d43f	c9 20		cmp #$20	                cmp #$20
4014	.d441	90 05		bcc $d448	                bcc LD448
4015	.d443	68		pla		                pla
4016	.d444	68		pla		                pla
4017	.d445	68		pla		                pla
4018	.d446	68		pla		                pla
4019	.d447	60		rts		                rts

4021	.d448					LD448:
4022	.d448	8c 44 88	sty $8844	                sty L8844
4023	.d44b	8d 45 88	sta $8845	                sta L8845
4024	.d44e	ad 46 88	lda $8846	                lda L8846
4025	.d451	89 02		bit #$02	                bit #$02
4026	.d453	f0 06		beq $d45b	                beq LD45B
4027	.d455	4e 45 88	lsr $8845	                lsr L8845
4028	.d458	6e 44 88	ror $8844	                ror L8844
4029	.d45b					LD45B:
4030	.d45b	ac 44 88	ldy $8844	                ldy L8844
4031	.d45e	ad 45 88	lda $8845	                lda L8845
4032	.d461	20 2e c9	jsr $c92e	                jsr negateAY
4033	.d464	8c 32 88	sty $8832	                sty L8832
4034	.d467	8d 33 88	sta $8833	                sta L8833
4035	.d46a	0d 32 88	ora $8832	                ora L8832
4036	.d46d	38		sec		                sec
4037	.d46e	60		rts		                rts

4039	.d46f					LD46F:
4040	.d46f	64 da		stz $da		                stz $DA
4041	.d471	b9 1b 03	lda $031b,y	                lda $031B,y
4042	.d474	d9 28 03	cmp $0328,y	                cmp $0328,y
4043	.d477	f0 02		beq $d47b	                beq LD47B
4044	.d479	e6 da		inc $da		                inc $DA
4045	.d47b					LD47B:
4046	.d47b	b9 1c 03	lda $031c,y	                lda $031C,y
4047	.d47e	f9 29 03	sbc $0329,y	                sbc $0329,y
4048	.d481	d0 02		bne $d485	                bne LD485
4049	.d483	a5 da		lda $da		                lda $DA
4050	.d485					LD485:
4051	.d485	60		rts		                rts

4053	.d486					LD486:
4054	.d486	ae 55 03	ldx $0355	                ldx $0355
4055	.d489	bd bf d4	lda $d4bf,x	                lda LD4BF,x
4056	.d48c	8d 46 88	sta $8846	                sta L8846
4057	.d48f	4a		lsr a		                lsr a
4058	.d490	48		pha		                pha
4059	.d491	a2 04		ldx #$04	                ldx #$04
4060	.d493					LD493:
4061	.d493	9e 37 88	stz $8837,x	                stz L8837,x
4062	.d496	ca		dex		                dex
4063	.d497	d0 fa		bne $d493	                bne LD493
4064	.d499	20 a0 d4	jsr $d4a0	                jsr LD4A0
4065	.d49c	68		pla		                pla
4066	.d49d	4a		lsr a		                lsr a
4067	.d49e	a2 02		ldx #$02	                ldx #$02
4068	.d4a0					LD4A0:
4069	.d4a0	bc 1b 03	ldy $031b,x	                ldy $031B,x
4070	.d4a3	bd 1c 03	lda $031c,x	                lda $031C,x
4071	.d4a6	20 c5 d4	jsr $d4c5	                jsr LD4C5
4072	.d4a9	a0 10		ldy #$10	                ldy #$10
4073	.d4ab					LD4AB:
4074	.d4ab	18		clc		                clc
4075	.d4ac	a2 fc		ldx #$fc	                ldx #$FC
4076	.d4ae					LD4AE:
4077	.d4ae	bd 3c 87	lda $873c,x	                lda L873C,x
4078	.d4b1	79 30 88	adc $8830,y	                adc L8830,y
4079	.d4b4	9d 3c 87	sta $873c,x	                sta L873C,x
4080	.d4b7	9d 44 87	sta $8744,x	                sta L8744,x
4081	.d4ba	c8		iny		                iny
4082	.d4bb	e8		inx		                inx
4083	.d4bc	d0 f0		bne $d4ae	                bne LD4AE
4084	.d4be	60		rts		                rts

4086	.d4bf					LD4BF:
4087	>d4bf	02				                .byte $02
4088	.d4c0	00		brk #		                brk
4089	.d4c1	01 ff		ora ($ff,x)	                ora ($FF,x)
4090	.d4c3	00		brk #		                brk
4091						;ORA (&8C,x)      :\ D4C4= 01       ..
4092	>d4c4	01				                .byte $01
4093	.d4c5					LD4C5:
4094	.d4c5	8c 3c 88	sty $883c	                sty L883C
4095	.d4c8	90 04		bcc $d4ce	                bcc LD4CE
4096	.d4ca	0e 3c 88	asl $883c	                asl L883C
4097	.d4cd	2a		rol a		                rol a
4098	.d4ce					LD4CE:
4099	.d4ce	8d 3d 88	sta $883d	                sta L883D
4100	.d4d1	ac 3c 88	ldy $883c	                ldy L883C
4101	.d4d4	aa		tax		                tax
4102	.d4d5	10 03		bpl $d4da	                bpl LD4DA
4103	.d4d7	20 2e c9	jsr $c92e	                jsr negateAY
4104	.d4da					LD4DA:
4105	.d4da	8c 3c 88	sty $883c	                sty L883C
4106	.d4dd	8d 3d 88	sta $883d	                sta L883D
4107	.d4e0	8c 40 88	sty $8840	                sty L8840
4108	.d4e3	9c 42 88	stz $8842	                stz L8842
4109	.d4e6	9c 43 88	stz $8843	                stz L8843
4110	.d4e9	a0 0f		ldy #$0f	                ldy #$0F
4111	.d4eb	4a		lsr a		                lsr a
4112	.d4ec	8d 41 88	sta $8841	                sta L8841
4113	.d4ef	6e 40 88	ror $8840	                ror L8840
4114	.d4f2					LD4F2:
4115	.d4f2	90 13		bcc $d507	                bcc LD507
4116	.d4f4	18		clc		                clc
4117	.d4f5	ad 3c 88	lda $883c	                lda L883C
4118	.d4f8	6d 42 88	adc $8842	                adc L8842
4119	.d4fb	8d 42 88	sta $8842	                sta L8842
4120	.d4fe	ad 3d 88	lda $883d	                lda L883D
4121	.d501	6d 43 88	adc $8843	                adc L8843
4122	.d504	8d 43 88	sta $8843	                sta L8843
4123	.d507					LD507:
4124	.d507	a2 03		ldx #$03	                ldx #$03
4125	.d509					LD509:
4126	.d509	7e 40 88	ror $8840,x	                ror L8840,x
4127	.d50c	ca		dex		                dex
4128	.d50d	10 fa		bpl $d509	                bpl LD509
4129	.d50f	88		dey		                dey
4130	.d510	10 e0		bpl $d4f2	                bpl LD4F2
4131	.d512	60		rts		                rts

4133	.d513					LD513:
4134	.d513	a2 02		ldx #$02	                ldx #$02
4135	.d515					LD515:
4136	.d515	9e 3c 88	stz $883c,x	                stz L883C,x
4137	.d518	74 db		stz $db,x	                stz $DB,x
4138	.d51a	ca		dex		                dex
4139	.d51b	10 f8		bpl $d515	                bpl LD515
4140	.d51d	a0 03		ldy #$03	                ldy #$03
4141	.d51f					LD51F:
4142	.d51f	b9 40 88	lda $8840,y	                lda L8840,y
4143	.d522	85 da		sta $da		                sta $DA
4144	.d524	5a		phy		                phy
4145	.d525	a0 03		ldy #$03	                ldy #$03
4146	.d527					LD527:
4147	.d527	5a		phy		                phy
4148	.d528	38		sec		                sec
4149	.d529	2e 3c 88	rol $883c	                rol L883C
4150	.d52c	2e 3d 88	rol $883d	                rol L883D
4151	.d52f	2e 3e 88	rol $883e	                rol L883E
4152	.d532	a2 01		ldx #$01	                ldx #$01
4153	.d534	a5 db		lda $db		                lda $DB
4154	.d536					LD536:
4155	.d536	06 da		asl $da		                asl $DA
4156	.d538	2a		rol a		                rol a
4157	.d539	26 dc		rol $dc		                rol $DC
4158	.d53b	26 dd		rol $dd		                rol $DD
4159	.d53d	ca		dex		                dex
4160	.d53e	10 f6		bpl $d536	                bpl LD536
4161	.d540	85 db		sta $db		                sta $DB
4162	.d542	38		sec		                sec
4163	.d543	ed 3c 88	sbc $883c	                sbc L883C
4164	.d546	aa		tax		                tax
4165	.d547	a5 dc		lda $dc		                lda $DC
4166	.d549	ed 3d 88	sbc $883d	                sbc L883D
4167	.d54c	a8		tay		                tay
4168	.d54d	a5 dd		lda $dd		                lda $DD
4169	.d54f	ed 3e 88	sbc $883e	                sbc L883E
4170	.d552	90 0b		bcc $d55f	                bcc LD55F
4171	.d554	85 dd		sta $dd		                sta $DD
4172	.d556	84 dc		sty $dc		                sty $DC
4173	.d558	86 db		stx $db		                stx $DB
4174	.d55a	ee 3c 88	inc $883c	                inc L883C
4175	.d55d	80 03		bra $d562	                bra LD562

4177	.d55f					LD55F:
4178	.d55f	ce 3c 88	dec $883c	                dec L883C
4179	.d562					LD562:
4180	.d562	7a		ply		                ply
4181	.d563	88		dey		                dey
4182	.d564	10 c1		bpl $d527	                bpl LD527
4183	.d566	7a		ply		                ply
4184	.d567	88		dey		                dey
4185	.d568	10 b5		bpl $d51f	                bpl LD51F
4186	.d56a	4e 3e 88	lsr $883e	                lsr L883E
4187	.d56d	6e 3d 88	ror $883d	                ror L883D
4188	.d570	6e 3c 88	ror $883c	                ror L883C
4189	.d573	9c 3e 88	stz $883e	                stz L883E
4190	.d576	9c 3f 88	stz $883f	                stz L883F
4191	.d579	ac 3c 88	ldy $883c	                ldy L883C
4192	.d57c	ad 3d 88	lda $883d	                lda L883D
4193	.d57f	60		rts		                rts

4195						;-------------------------------------------------------------------------
4196						;
4197						; Add dimension of region to a coordinate.
4198						;
4199						; entry:
4200						;
4201						; X = VDU variable offset of coordinate
4202						;
4203						; A = VDU variable offset of minimum coordinate of region
4204						;
4205						; Y = VDU variable offset of maximum coordinate of region
4206						;
4207						; ZTEMP?0 = VDU variable offset for result
4208						;
4209						; exit:
4210						;
4211						; result variable = coordinate+(min-max)
4212						;
4213	.d580					addRegionDimensionsToVDUVariableCoordinates:
4214	.d580	20 8d d5	jsr $d58d	                jsr addRegionDimensionToVDUVariableCoordinate ;do X

4216						                ; bump offsets to do Y.
4217	.d583	c8		iny		                iny
4218	.d584	c8		iny		                iny
4219	.d585	e8		inx		                inx
4220	.d586	e8		inx		                inx
4221	.d587	1a		inc a		                inc a
4222	.d588	1a		inc a		                inc a
4223	.d589	e6 da		inc $da		                inc ZTEMP+0
4224	.d58b	e6 da		inc $da		                inc ZTEMP+0

4226						                ; TODO - not a great name. Could probably just be
4227						                ; addDifference, or something.
4228	.d58d					addRegionDimensionToVDUVariableCoordinate:
4229	.d58d	da		phx		                phx                          ;save VX
4230	.d58e	5a		phy		                phy                          ;save VY
4231	.d58f	48		pha		                pha                          ;save VA
4232	.d590	18		clc		                clc
4233	.d591	bd 00 03	lda $0300,x	                lda vduv+0,x                 ;<VX
4234	.d594	79 00 03	adc $0300,y	                adc vduv+0,y                 ;<(VX+VY)
4235	.d597	85 de		sta $de		                sta ZTEMPC+0                 ;ZTEMPC?0=<(VX+VY)
4236	.d599	bd 01 03	lda $0301,x	                lda vduv+1,x                 ;>VX
4237	.d59c	79 01 03	adc $0301,y	                adc vduv+1,y                 ;>(VX+VY)
4238	.d59f	fa		plx		                plx                          ;X=VA
4239	.d5a0	48		pha		                pha                          ;save >(VX+VY)
4240	.d5a1	a4 da		ldy $da		                ldy ZTEMP+0                  ;Y=VT
4241	.d5a3	38		sec		                sec
4242	.d5a4	a5 de		lda $de		                lda ZTEMPC+0                 ;<(VX+VY)
4243	.d5a6	fd 00 03	sbc $0300,x	                sbc vduv+0,x                 ;<(VX+VY-VA)
4244	.d5a9	99 00 03	sta $0300,y	                sta vduv+0,y                 ;<VT=<(VX+VY-VA)
4245	.d5ac	68		pla		                pla                          ;>(VX+VY)
4246	.d5ad	fd 01 03	sbc $0301,x	                sbc vduv+1,x                 ;>(VX+VY-VA)
4247	.d5b0	99 01 03	sta $0301,y	                sta vduv+1,y                 ;>VT=<(VX+VY-VA)
4248	.d5b3	8a		txa		                txa                          ;restore old A
4249	.d5b4	7a		ply		                ply                          ;restore old Y
4250	.d5b5	fa		plx		                plx                          ;restore old X
4251	.d5b6	60		rts		                rts

4253						;-------------------------------------------------------------------------
4254						;
4255						; Sort points by Y coordinate, then X.
4256						;
4257						; entry:
4258						;
4259						; X = VDU variable offset of point A (4 bytes: X;Y;)
4260						;
4261						; Y = VDU variable offset of point B (4 bytes: X;Y;)
4262						;
4263						; exit:
4264						;
4265						; X = offset of point with lesser Y (or lesser X, if same Y)
4266						;
4267						; Y = offset of point with greater Y (or greater X, if same Y)
4268						;
4269	.d5b7					sortVDUVariableCoordinates:
4270	.d5b7	38		sec		                sec
4271	.d5b8	b9 02 03	lda $0302,y	                lda vduv+2,y
4272	.d5bb	fd 02 03	sbc $0302,x	                sbc vduv+2,x
4273	.d5be	85 de		sta $de		                sta ZTEMPC
4274	.d5c0	b9 03 03	lda $0303,y	                lda vduv+3,y
4275	.d5c3	fd 03 03	sbc $0303,x	                sbc vduv+3,x
4276	.d5c6	30 09		bmi $d5d1	                bmi exchangeXAndY           ;taken if PX.y>PY.y
4277	.d5c8	05 de		ora $de		                ora ZTEMPC
4278	.d5ca	d0 09		bne $d5d5	                bne rtsD5D5                  ;taken if PX.y<PY.y

4280						;-------------------------------------------------------------------------
4281						;
4282						; Sort words by value.
4283						;
4284						; entry:
4285						;
4286						; X = VDU variable offset of word A
4287						;
4288						; Y = VDU variable offset of word B
4289						;
4290						; exit:
4291						;
4292						; X = offset of lesser value
4293						;
4294						; Y = offset of greater value
4295						;
4296	.d5cc					sortVDUVariableWords:
4297	.d5cc	20 d6 d5	jsr $d5d6	                jsr compareVDUVariableWords
4298	.d5cf	10 04		bpl $d5d5	                bpl rtsD5D5
4299	.d5d1					exchangeXAndY:
4300	.d5d1	8a		txa		                txa
4301	.d5d2	5a		phy		                phy
4302	.d5d3	fa		plx		                plx
4303	.d5d4	a8		tay		                tay
4304	.d5d5					rtsD5D5:
4305	.d5d5	60		rts		                rts

4307						;-------------------------------------------------------------------------
4308						;
4309						; Compare 2 16-bit VDU variable values.
4310						;
4311						; entry:
4312						;
4313						; X = offset of one variable
4314						;
4315						; Y = offset of the other variable
4316						;
4317						; exit:
4318						;
4319						; N=1 if X>Y
4320						;
4321	.d5d6					compareVDUVariableWords:
4322	.d5d6	b9 00 03	lda $0300,y	                lda vduv+0,y
4323	.d5d9	dd 00 03	cmp $0300,x	                cmp vduv+0,x
4324	.d5dc	b9 01 03	lda $0301,y	                lda vduv+1,y
4325	.d5df	fd 01 03	sbc $0301,x	                sbc vduv+1,x
4326	.d5e2	60		rts		                rts

4328						;-------------------------------------------------------------------------

4330	.d5e3					LD5E3:
4331	.d5e3	ee 47 88	inc $8847	                inc L8847
4332	.d5e6					LD5E6:
4333	.d5e6	ad 47 88	lda $8847	                lda L8847
4334	.d5e9	d0 0f		bne $d5fa	                bne LD5FA
4335	.d5eb	ad 32 88	lda $8832	                lda L8832
4336	.d5ee	0d 33 88	ora $8833	                ora L8833
4337	.d5f1	f0 f0		beq $d5e3	                beq LD5E3
4338	.d5f3	a2 00		ldx #$00	                ldx #$00
4339	.d5f5	20 44 d6	jsr $d644	                jsr LD644
4340	.d5f8	10 49		bpl $d643	                bpl LD643
4341	.d5fa					LD5FA:
4342	.d5fa	a2 02		ldx #$02	                ldx #$02
4343	.d5fc	20 44 d6	jsr $d644	                jsr LD644
4344	.d5ff	10 42		bpl $d643	                bpl LD643
4345	.d601	a2 00		ldx #$00	                ldx #$00
4346	.d603	20 0a d6	jsr $d60a	                jsr LD60A
4347	.d606	10 3b		bpl $d643	                bpl LD643
4348	.d608	a2 02		ldx #$02	                ldx #$02
4349	.d60a					LD60A:
4350	.d60a	bd 30 88	lda $8830,x	                lda L8830,x
4351	.d60d	d0 03		bne $d612	                bne LD612
4352	.d60f	de 31 88	dec $8831,x	                dec L8831,x
4353	.d612					LD612:
4354	.d612	de 30 88	dec $8830,x	                dec L8830,x
4355	.d615	8a		txa		                txa
4356	.d616	4a		lsr a		                lsr a
4357	.d617	1a		inc a		                inc a
4358	.d618	2c 46 88	bit $8846	                bit L8846
4359	.d61b	f0 03		beq $d620	                beq LD620
4360	.d61d	20 20 d6	jsr $d620	                jsr LD620
4361	.d620					LD620:
4362	.d620	20 36 d6	jsr $d636	                jsr LD636
4363	.d623	18		clc		                clc
4364	.d624	ad 40 88	lda $8840	                lda L8840
4365	.d627	7d 34 88	adc $8834,x	                adc L8834,x
4366	.d62a	8d 40 88	sta $8840	                sta L8840
4367	.d62d	ad 41 88	lda $8841	                lda L8841
4368	.d630	7d 35 88	adc $8835,x	                adc L8835,x
4369	.d633	8d 41 88	sta $8841	                sta L8841
4370	.d636					LD636:
4371	.d636	08		php		                php
4372	.d637	bd 34 88	lda $8834,x	                lda L8834,x
4373	.d63a	d0 03		bne $d63f	                bne LD63F
4374	.d63c	de 35 88	dec $8835,x	                dec L8835,x
4375	.d63f					LD63F:
4376	.d63f	de 34 88	dec $8834,x	                dec L8834,x
4377	.d642	28		plp		                plp
4378	.d643					LD643:
4379	.d643	60		rts		                rts

4381	.d644					LD644:
4382	.d644	fe 30 88	inc $8830,x	                inc L8830,x
4383	.d647	d0 03		bne $d64c	                bne LD64C
4384	.d649	fe 31 88	inc $8831,x	                inc L8831,x
4385	.d64c					LD64C:
4386	.d64c	8a		txa		                txa
4387	.d64d	4a		lsr a		                lsr a
4388	.d64e	1a		inc a		                inc a
4389	.d64f	2c 46 88	bit $8846	                bit L8846
4390	.d652	f0 03		beq $d657	                beq LD657
4391	.d654	20 57 d6	jsr $d657	                jsr LD657
4392	.d657					LD657:
4393	.d657	20 6d d6	jsr $d66d	                jsr LD66D
4394	.d65a	38		sec		                sec
4395	.d65b	ad 40 88	lda $8840	                lda L8840
4396	.d65e	fd 34 88	sbc $8834,x	                sbc L8834,x
4397	.d661	8d 40 88	sta $8840	                sta L8840
4398	.d664	ad 41 88	lda $8841	                lda L8841
4399	.d667	fd 35 88	sbc $8835,x	                sbc L8835,x
4400	.d66a	8d 41 88	sta $8841	                sta L8841
4401	.d66d					LD66D:
4402	.d66d	08		php		                php
4403	.d66e	fe 34 88	inc $8834,x	                inc L8834,x
4404	.d671	d0 03		bne $d676	                bne LD676
4405	.d673	fe 35 88	inc $8835,x	                inc L8835,x
4406	.d676					LD676:
4407	.d676	28		plp		                plp
4408	.d677	60		rts		                rts

4410	.d678					LD678:
4411	.d678	48		pha		                pha
4412	.d679	38		sec		                sec
4413	.d67a	b9 00 03	lda $0300,y	                lda $0300,y
4414	.d67d	fd 00 03	sbc $0300,x	                sbc $0300,x
4415	.d680	48		pha		                pha
4416	.d681	b9 01 03	lda $0301,y	                lda $0301,y
4417	.d684	fd 01 03	sbc $0301,x	                sbc $0301,x
4418	.d687	7a		ply		                ply
4419	.d688	c9 80		cmp #$80	                cmp #$80
4420	.d68a	90 03		bcc $d68f	                bcc LD68F
4421	.d68c	20 2e c9	jsr $c92e	                jsr negateAY
4422	.d68f					LD68F:
4423	.d68f	fa		plx		                plx
4424	.d690	9d 01 03	sta $0301,x	                sta $0301,x
4425	.d693	98		tya		                tya
4426	.d694	9d 00 03	sta $0300,x	                sta $0300,x
4427	.d697	60		rts		                rts

4429	.d698					LD698:
4430	.d698	a2 37		ldx #$37	                ldx #$37
4431	.d69a	20 23 d7	jsr $d723	                jsr LD723
4432	.d69d					LD69D:
4433	.d69d	3c 0a 03	bit $030a,x	                bit $030A,x
4434	.d6a0	70 10		bvs $d6b2	                bvs LD6B2
4435	.d6a2	60		rts		                rts

4437	.d6a3					LD6A3:
4438	.d6a3	a2 2c		ldx #$2c	                ldx #$2C
4439	.d6a5	20 23 d7	jsr $d723	                jsr LD723
4440	.d6a8					LD6A8:
4441	.d6a8	3c 0a 03	bit $030a,x	                bit $030A,x
4442	.d6ab	50 05		bvc $d6b2	                bvc LD6B2
4443	.d6ad	60		rts		                rts

4445	.d6ae					LD6AE:
4446	.d6ae	fa		plx		                plx
4447	.d6af	20 26 d7	jsr $d726	                jsr LD726
4448	.d6b2					LD6B2:
4449	.d6b2	bd 09 03	lda $0309,x	                lda $0309,x
4450	.d6b5	30 10		bmi $d6c7	                bmi LD6C7
4451	.d6b7	a0 03		ldy #$03	                ldy #$03
4452	.d6b9	da		phx		                phx
4453	.d6ba					LD6BA:
4454	.d6ba	bd 00 03	lda $0300,x	                lda $0300,x
4455	.d6bd	dd 1e 88	cmp $881e,x	                cmp L881E,x
4456	.d6c0	d0 ec		bne $d6ae	                bne LD6AE
4457	.d6c2	e8		inx		                inx
4458	.d6c3	88		dey		                dey
4459	.d6c4	10 f4		bpl $d6ba	                bpl LD6BA
4460	.d6c6	fa		plx		                plx
4461	.d6c7					LD6C7:
4462	.d6c7	60		rts		                rts

4464	.d6c8					LD6C8:
4465	.d6c8	20 fd d6	jsr $d6fd	                jsr LD6FD
4466	.d6cb	bd 0a 03	lda $030a,x	                lda $030A,x
4467	.d6ce	0a		asl a		                asl a
4468	.d6cf	0a		asl a		                asl a
4469	.d6d0	bd 0a 03	lda $030a,x	                lda $030A,x
4470	.d6d3	6a		ror a		                ror a
4471	.d6d4	85 da		sta $da		                sta $DA
4472	.d6d6	18		clc		                clc
4473	.d6d7	10 0f		bpl $d6e8	                bpl LD6E8
4474	.d6d9	bd 02 03	lda $0302,x	                lda $0302,x
4475	.d6dc	ed 04 03	sbc $0304	                sbc $0304
4476	.d6df	a8		tay		                tay
4477	.d6e0	bd 03 03	lda $0303,x	                lda $0303,x
4478	.d6e3	ed 05 03	sbc $0305	                sbc $0305
4479	.d6e6	80 0d		bra $d6f5	                bra LD6F5

4481	.d6e8					LD6E8:
4482	.d6e8	ad 00 03	lda $0300	                lda $0300
4483	.d6eb	fd 02 03	sbc $0302,x	                sbc $0302,x
4484	.d6ee	a8		tay		                tay
4485	.d6ef	ad 01 03	lda $0301	                lda $0301
4486	.d6f2	fd 03 03	sbc $0303,x	                sbc $0303,x
4487	.d6f5					LD6F5:
4488	.d6f5	20 a4 d7	jsr $d7a4	                jsr LD7A4
4489	.d6f8	20 fd d6	jsr $d6fd	                jsr LD6FD
4490	.d6fb	80 58		bra $d755	                bra LD755

4492	.d6fd					LD6FD:
4493	.d6fd	8a		txa		                txa
4494	.d6fe	1a		inc a		                inc a
4495	.d6ff	48		pha		                pha
4496	.d700	1a		inc a		                inc a
4497	.d701	a8		tay		                tay
4498	.d702	20 c2 e2	jsr $e2c2	                jsr exchangeTwoVDUBytes
4499	.d705	e8		inx		                inx
4500	.d706	e8		inx		                inx
4501	.d707	c8		iny		                iny
4502	.d708	c8		iny		                iny
4503	.d709	20 c2 e2	jsr $e2c2	                jsr exchangeTwoVDUBytes
4504	.d70c	fa		plx		                plx
4505	.d70d	20 11 d7	jsr $d711	                jsr LD711
4506	.d710	ca		dex		                dex
4507	.d711					LD711:
4508	.d711	bd 08 03	lda $0308,x	                lda $0308,x
4509	.d714	49 ff		eor #$ff	                eor #$FF
4510	.d716	9d 08 03	sta $0308,x	                sta $0308,x
4511	.d719	60		rts		                rts

4513	.d71a					LD71A:
4514	.d71a	20 26 d7	jsr $d726	                jsr LD726
4515	.d71d					LD71D:
4516	.d71d	bd 09 03	lda $0309,x	                lda $0309,x
4517	.d720	10 f8		bpl $d71a	                bpl LD71A
4518	.d722	60		rts		                rts

4520	.d723					LD723:
4521	.d723	20 1d d7	jsr $d71d	                jsr LD71D
4522	.d726					LD726:
4523	.d726	bd 09 03	lda $0309,x	                lda $0309,x
4524	.d729	10 2a		bpl $d755	                bpl LD755
4525	.d72b					LD72B:
4526	.d72b	18		clc		                clc
4527	.d72c	bd 08 03	lda $0308,x	                lda $0308,x
4528	.d72f	7d 04 03	adc $0304,x	                adc $0304,x
4529	.d732	9d 08 03	sta $0308,x	                sta $0308,x
4530	.d735	bd 09 03	lda $0309,x	                lda $0309,x
4531	.d738	7d 05 03	adc $0305,x	                adc $0305,x
4532	.d73b	9d 09 03	sta $0309,x	                sta $0309,x
4533	.d73e	30 03		bmi $d743	                bmi LD743
4534	.d740	20 55 d7	jsr $d755	                jsr LD755
4535	.d743					LD743:
4536	.d743	da		phx		                phx
4537	.d744	e8		inx		                inx
4538	.d745	e8		inx		                inx
4539	.d746	3c 08 03	bit $0308,x	                bit $0308,x
4540	.d749	30 23		bmi $d76e	                bmi LD76E
4541	.d74b					LD74B:
4542	.d74b	fe 00 03	inc $0300,x	                inc $0300,x
4543	.d74e	d0 03		bne $d753	                bne LD753
4544	.d750	fe 01 03	inc $0301,x	                inc $0301,x
4545	.d753					LD753:
4546	.d753	fa		plx		                plx
4547	.d754	60		rts		                rts

4549	.d755					LD755:
4550	.d755	38		sec		                sec
4551	.d756	bd 08 03	lda $0308,x	                lda $0308,x
4552	.d759	fd 06 03	sbc $0306,x	                sbc $0306,x
4553	.d75c	9d 08 03	sta $0308,x	                sta $0308,x
4554	.d75f	bd 09 03	lda $0309,x	                lda $0309,x
4555	.d762	fd 07 03	sbc $0307,x	                sbc $0307,x
4556	.d765	9d 09 03	sta $0309,x	                sta $0309,x
4557	.d768	da		phx		                phx
4558	.d769	3c 0a 03	bit $030a,x	                bit $030A,x
4559	.d76c	50 dd		bvc $d74b	                bvc LD74B
4560	.d76e					LD76E:
4561	.d76e	bd 00 03	lda $0300,x	                lda $0300,x
4562	.d771	d0 03		bne $d776	                bne LD776
4563	.d773	de 01 03	dec $0301,x	                dec $0301,x
4564	.d776					LD776:
4565	.d776	de 00 03	dec $0300,x	                dec $0300,x
4566	.d779	fa		plx		                plx
4567	.d77a	60		rts		                rts

4569	.d77b					LD77B:
4570	.d77b	18		clc		                clc
4571	.d77c	bd 0a 03	lda $030a,x	                lda $030A,x
4572	.d77f	85 da		sta $da		                sta $DA
4573	.d781	10 0f		bpl $d792	                bpl LD792
4574	.d783	bd 02 03	lda $0302,x	                lda $0302,x
4575	.d786	ed 06 03	sbc $0306	                sbc $0306
4576	.d789	a8		tay		                tay
4577	.d78a	bd 03 03	lda $0303,x	                lda $0303,x
4578	.d78d	ed 07 03	sbc $0307	                sbc $0307
4579	.d790	80 0d		bra $d79f	                bra LD79F

4581	.d792					LD792:
4582	.d792	ad 02 03	lda $0302	                lda $0302
4583	.d795	fd 02 03	sbc $0302,x	                sbc $0302,x
4584	.d798	a8		tay		                tay
4585	.d799	ad 03 03	lda $0303	                lda $0303
4586	.d79c	fd 03 03	sbc $0303,x	                sbc $0303,x
4587	.d79f					LD79F:
4588	.d79f	20 a4 d7	jsr $d7a4	                jsr LD7A4
4589	.d7a2	80 87		bra $d72b	                bra LD72B

4591	.d7a4					LD7A4:
4592	.d7a4	84 de		sty $de		                sty $DE
4593	.d7a6	85 df		sta $df		                sta $DF
4594	.d7a8	bd 02 03	lda $0302,x	                lda $0302,x
4595	.d7ab	bc 03 03	ldy $0303,x	                ldy $0303,x
4596	.d7ae	06 da		asl $da		                asl $DA
4597	.d7b0	b0 0a		bcs $d7bc	                bcs LD7BC
4598	.d7b2	65 de		adc $de		                adc $DE
4599	.d7b4	9d 02 03	sta $0302,x	                sta $0302,x
4600	.d7b7	98		tya		                tya
4601	.d7b8	65 df		adc $df		                adc $DF
4602	.d7ba	80 08		bra $d7c4	                bra LD7C4

4604	.d7bc					LD7BC:
4605	.d7bc	e5 de		sbc $de		                sbc $DE
4606	.d7be	9d 02 03	sta $0302,x	                sta $0302,x
4607	.d7c1	98		tya		                tya
4608	.d7c2	e5 df		sbc $df		                sbc $DF
4609	.d7c4					LD7C4:
4610	.d7c4	9d 03 03	sta $0303,x	                sta $0303,x
4611	.d7c7	a9 00		lda #$00	                lda #$00
4612	.d7c9	3c 09 03	bit $0309,x	                bit $0309,x
4613	.d7cc	10 01		bpl $d7cf	                bpl LD7CF
4614	.d7ce	3a		dec a		                dec a
4615	.d7cf					LD7CF:
4616	.d7cf	85 dc		sta $dc		                sta $DC
4617	.d7d1	4a		lsr a		                lsr a
4618	.d7d2	85 dd		sta $dd		                sta $DD
4619	.d7d4	a0 10		ldy #$10	                ldy #$10
4620	.d7d6					LD7D6:
4621	.d7d6	a5 dd		lda $dd		                lda $DD
4622	.d7d8	0a		asl a		                asl a
4623	.d7d9	3e 08 03	rol $0308,x	                rol $0308,x
4624	.d7dc	3e 09 03	rol $0309,x	                rol $0309,x
4625	.d7df	26 dc		rol $dc		                rol $DC
4626	.d7e1	26 dd		rol $dd		                rol $DD
4627	.d7e3	06 de		asl $de		                asl $DE
4628	.d7e5	26 df		rol $df		                rol $DF
4629	.d7e7	90 19		bcc $d802	                bcc LD802
4630	.d7e9	18		clc		                clc
4631	.d7ea	a5 dc		lda $dc		                lda $DC
4632	.d7ec	7d 04 03	adc $0304,x	                adc $0304,x
4633	.d7ef	85 dc		sta $dc		                sta $DC
4634	.d7f1	a5 dd		lda $dd		                lda $DD
4635	.d7f3	7d 05 03	adc $0305,x	                adc $0305,x
4636	.d7f6	85 dd		sta $dd		                sta $DD
4637	.d7f8	90 08		bcc $d802	                bcc LD802
4638	.d7fa	fe 08 03	inc $0308,x	                inc $0308,x
4639	.d7fd	d0 03		bne $d802	                bne LD802
4640	.d7ff	fe 09 03	inc $0309,x	                inc $0309,x
4641	.d802					LD802:
4642	.d802	88		dey		                dey
4643	.d803	d0 d1		bne $d7d6	                bne LD7D6
4644	.d805	3c 09 03	bit $0309,x	                bit $0309,x
4645	.d808	50 0b		bvc $d815	                bvc LD815
4646	.d80a	a5 dc		lda $dc		                lda $DC
4647	.d80c	9d 08 03	sta $0308,x	                sta $0308,x
4648	.d80f	a5 dd		lda $dd		                lda $DD
4649	.d811	9d 09 03	sta $0309,x	                sta $0309,x
4650	.d814	60		rts		                rts

4652	.d815					LD815:
4653	.d815	a0 10		ldy #$10	                ldy #$10
4654	.d817					LD817:
4655	.d817	26 dc		rol $dc		                rol $DC
4656	.d819	26 dd		rol $dd		                rol $DD
4657	.d81b	3e 08 03	rol $0308,x	                rol $0308,x
4658	.d81e	3e 09 03	rol $0309,x	                rol $0309,x
4659	.d821	38		sec		                sec
4660	.d822	bd 08 03	lda $0308,x	                lda $0308,x
4661	.d825	fd 06 03	sbc $0306,x	                sbc $0306,x
4662	.d828	85 de		sta $de		                sta $DE
4663	.d82a	bd 09 03	lda $0309,x	                lda $0309,x
4664	.d82d	fd 07 03	sbc $0307,x	                sbc $0307,x
4665	.d830	90 08		bcc $d83a	                bcc LD83A
4666	.d832	9d 09 03	sta $0309,x	                sta $0309,x
4667	.d835	a5 de		lda $de		                lda $DE
4668	.d837	9d 08 03	sta $0308,x	                sta $0308,x
4669	.d83a					LD83A:
4670	.d83a	88		dey		                dey
4671	.d83b	d0 da		bne $d817	                bne LD817
4672	.d83d	26 dc		rol $dc		                rol $DC
4673	.d83f	26 dd		rol $dd		                rol $DD
4674	.d841	38		sec		                sec
4675	.d842	bd 08 03	lda $0308,x	                lda $0308,x
4676	.d845	fd 06 03	sbc $0306,x	                sbc $0306,x
4677	.d848	9d 08 03	sta $0308,x	                sta $0308,x
4678	.d84b	bd 09 03	lda $0309,x	                lda $0309,x
4679	.d84e	fd 07 03	sbc $0307,x	                sbc $0307,x
4680	.d851	9d 09 03	sta $0309,x	                sta $0309,x
4681	.d854	bd 00 03	lda $0300,x	                lda $0300,x
4682	.d857	bc 01 03	ldy $0301,x	                ldy $0301,x
4683	.d85a	06 da		asl $da		                asl $DA
4684	.d85c	b0 0b		bcs $d869	                bcs LD869
4685	.d85e	38		sec		                sec
4686	.d85f	65 dc		adc $dc		                adc $DC
4687	.d861	9d 00 03	sta $0300,x	                sta $0300,x
4688	.d864	98		tya		                tya
4689	.d865	65 dd		adc $dd		                adc $DD
4690	.d867	80 09		bra $d872	                bra LD872

4692	.d869					LD869:
4693	.d869	18		clc		                clc
4694	.d86a	e5 dc		sbc $dc		                sbc $DC
4695	.d86c	9d 00 03	sta $0300,x	                sta $0300,x
4696	.d86f	98		tya		                tya
4697	.d870	e5 dd		sbc $dd		                sbc $DD
4698	.d872					LD872:
4699	.d872	9d 01 03	sta $0301,x	                sta $0301,x
4700	.d875					LD875:
4701	.d875	60		rts		                rts

4703	.d876					LD876:
4704	.d876	0e 32 03	asl $0332	                asl $0332
4705	.d879	a0 2c		ldy #$2c	                ldy #$2C
4706	.d87b	20 16 c9	jsr $c916	                jsr copyLastFourVDUQueueBytes
4707	.d87e	06 db		asl $db		                asl $DB
4708	.d880	90 0d		bcc $d88f	                bcc LD88F
4709	.d882	20 26 da	jsr $da26	                jsr LDA26
4710	.d885	f0 ee		beq $d875	                beq LD875
4711	.d887	a2 00		ldx #$00	                ldx #$00
4712	.d889	ad 32 03	lda $0332	                lda $0332
4713	.d88c	20 0f da	jsr $da0f	                jsr LDA0F
4714	.d88f					LD88F:
4715	.d88f	24 db		bit $db		                bit $DB
4716	.d891	50 0f		bvc $d8a2	                bvc LD8A2
4717	.d893	20 26 da	jsr $da26	                jsr LDA26
4718	.d896	f0 dd		beq $d875	                beq LD875
4719	.d898	a2 04		ldx #$04	                ldx #$04
4720	.d89a	ad 32 03	lda $0332	                lda $0332
4721	.d89d	49 80		eor #$80	                eor #$80
4722	.d89f	20 0f da	jsr $da0f	                jsr LDA0F
4723	.d8a2					LD8A2:
4724	.d8a2	a2 28		ldx #$28	                ldx #$28
4725	.d8a4	a0 2c		ldy #$2c	                ldy #$2C
4726	.d8a6	4c e8 da	jmp $dae8	                jmp LDAE8

4728	.d8a9					LD8A9:
4729	.d8a9	0a		asl a		                asl a
4730	.d8aa	0a		asl a		                asl a
4731	.d8ab	85 db		sta $db		                sta $DB
4732	.d8ad	29 c0		and #$c0	                and #$C0
4733	.d8af	49 40		eor #$40	                eor #$40
4734	.d8b1	d0 06		bne $d8b9	                bne LD8B9
4735	.d8b3	ad 67 03	lda $0367	                lda $0367
4736	.d8b6	8d 68 03	sta $0368	                sta $0368
4737	.d8b9					LD8B9:
4738	.d8b9	20 a6 d1	jsr $d1a6	                jsr LD1A6
4739	.d8bc	85 dc		sta $dc		                sta $DC
4740	.d8be	f0 04		beq $d8c4	                beq LD8C4
4741	.d8c0	a9 80		lda #$80	                lda #$80
4742	.d8c2	14 db		trb $db		                trb $DB
4743	.d8c4					LD8C4:
4744	.d8c4	a2 20		ldx #$20	                ldx #$20
4745	.d8c6	20 a8 d1	jsr $d1a8	                jsr windEntryPoint
4746	.d8c9	85 e0		sta $e0		                sta $E0
4747	.d8cb	f0 0a		beq $d8d7	                beq LD8D7
4748	.d8cd	aa		tax		                tax
4749	.d8ce	a9 20		lda #$20	                lda #$20
4750	.d8d0	14 db		trb $db		                trb $DB
4751	.d8d2	8a		txa		                txa
4752	.d8d3	24 dc		bit $dc		                bit $DC
4753	.d8d5					LD8D5:
4754	.d8d5	d0 9e		bne $d875	                bne LD875
4755	.d8d7					LD8D7:
4756	.d8d7	a0 24		ldy #$24	                ldy #$24
4757	.d8d9	a9 20		lda #$20	                lda #$20
4758	.d8db	a2 28		ldx #$28	                ldx #$28
4759	.d8dd	20 39 9b	jsr $9b39	                jsr terminal.L9B09
4760	.d8e0	24 db		bit $db		                bit $DB
4761	.d8e2	70 08		bvs $d8ec	                bvs LD8EC
4762	.d8e4	ad 2e 03	lda $032e	                lda $032E
4763	.d8e7	0d 2f 03	ora $032f	                ora $032F
4764	.d8ea	f0 8a		beq $d876	                beq LD876
4765	.d8ec					LD8EC:
4766	.d8ec	a5 dc		lda $dc		                lda $DC
4767	.d8ee	89 0c		bit #$0c	                bit #$0C
4768	.d8f0	f0 0e		beq $d900	                beq LD900
4769	.d8f2	a2 28		ldx #$28	                ldx #$28
4770	.d8f4	20 7b d7	jsr $d77b	                jsr LD77B
4771	.d8f7	a2 28		ldx #$28	                ldx #$28
4772	.d8f9	20 a8 d1	jsr $d1a8	                jsr windEntryPoint
4773	.d8fc	24 e0		bit $e0		                bit $E0
4774	.d8fe	d0 d5		bne $d8d5	                bne LD8D5
4775	.d900					LD900:
4776	.d900	89 03		bit #$03	                bit #$03
4777	.d902	f0 0a		beq $d90e	                beq LD90E
4778	.d904	a2 28		ldx #$28	                ldx #$28
4779	.d906	20 c8 d6	jsr $d6c8	                jsr LD6C8
4780	.d909	a2 28		ldx #$28	                ldx #$28
4781	.d90b	20 a8 d1	jsr $d1a8	                jsr windEntryPoint
4782	.d90e					LD90E:
4783	.d90e	a8		tay		                tay
4784	.d90f	d0 c4		bne $d8d5	                bne LD8D5
4785	.d911	a0 20		ldy #$20	                ldy #$20
4786	.d913	a2 22		ldx #$22	                ldx #$22
4787	.d915	a5 e0		lda $e0		                lda $E0
4788	.d917	f0 0f		beq $d928	                beq LD928
4789	.d919	a0 04		ldy #$04	                ldy #$04
4790	.d91b	a2 06		ldx #$06	                ldx #$06
4791	.d91d	2c 32 03	bit $0332	                bit $0332
4792	.d920	10 02		bpl $d924	                bpl LD924
4793	.d922	a2 02		ldx #$02	                ldx #$02
4794	.d924					LD924:
4795	.d924	50 02		bvc $d928	                bvc LD928
4796	.d926	a0 00		ldy #$00	                ldy #$00
4797	.d928					LD928:
4798	.d928	18		clc		                clc
4799	.d929	bd 00 03	lda $0300,x	                lda $0300,x
4800	.d92c	ed 2a 03	sbc $032a	                sbc $032A
4801	.d92f	90 03		bcc $d934	                bcc LD934
4802	.d931	1a		inc a		                inc a
4803	.d932	49 ff		eor #$ff	                eor #$FF
4804	.d934					LD934:
4805	.d934	85 dc		sta $dc		                sta $DC
4806	.d936	18		clc		                clc
4807	.d937	b9 00 03	lda $0300,y	                lda $0300,y
4808	.d93a	ed 28 03	sbc $0328	                sbc $0328
4809	.d93d	aa		tax		                tax
4810	.d93e	b9 01 03	lda $0301,y	                lda $0301,y
4811	.d941	ed 29 03	sbc $0329	                sbc $0329
4812	.d944	30 0c		bmi $d952	                bmi LD952
4813	.d946	e8		inx		                inx
4814	.d947	d0 01		bne $d94a	                bne LD94A
4815	.d949	1a		inc a		                inc a
4816	.d94a					LD94A:
4817	.d94a	49 ff		eor #$ff	                eor #$FF
4818	.d94c	a8		tay		                tay
4819	.d94d	8a		txa		                txa
4820	.d94e	49 ff		eor #$ff	                eor #$FF
4821	.d950	aa		tax		                tax
4822	.d951	98		tya		                tya
4823	.d952					LD952:
4824	.d952	85 dd		sta $dd		                sta $DD
4825	.d954	86 e0		stx $e0		                stx $E0
4826	.d956	a2 28		ldx #$28	                ldx #$28
4827	.d958	20 41 df	jsr $df41	                jsr LDF41
4828	.d95b	06 db		asl $db		                asl $DB
4829	.d95d	b0 2a		bcs $d989	                bcs LD989
4830	.d95f					LD95F:
4831	.d95f	24 db		bit $db		                bit $DB
4832	.d961	50 0b		bvc $d96e	                bvc LD96E
4833	.d963	a5 e0		lda $e0		                lda $E0
4834	.d965	25 dc		and $dc		                and $DC
4835	.d967	25 dd		and $dd		                and $DD
4836	.d969	1a		inc a		                inc a
4837	.d96a	f0 34		beq $d9a0	                beq LD9A0
4838	.d96c	24 db		bit $db		                bit $DB
4839	.d96e					LD96E:
4840	.d96e	10 09		bpl $d979	                bpl LD979
4841	.d970	ad 68 03	lda $0368	                lda $0368
4842	.d973	0a		asl a		                asl a
4843	.d974	2e 68 03	rol $0368	                rol $0368
4844	.d977	90 10		bcc $d989	                bcc LD989
4845	.d979					LD979:
4846	.d979	a5 d1		lda $d1		                lda ZMASK
4847	.d97b	25 d4		and $d4		                and ZGORA
4848	.d97d	11 d6		ora ($d6),y	                ora (ZMEMG),y
4849	.d97f	85 da		sta $da		                sta $DA
4850	.d981	a5 d1		lda $d1		                lda ZMASK
4851	.d983	25 d5		and $d5		                and ZGEOR
4852	.d985	45 da		eor $da		                eor $DA
4853	.d987	91 d6		sta ($d6),y	                sta (ZMEMG),y
4854	.d989					LD989:
4855	.d989	ad 31 03	lda $0331	                lda $0331
4856	.d98c	10 4e		bpl $d9dc	                bpl LD9DC
4857	.d98e	e6 dc		inc $dc		                inc $DC
4858	.d990	f0 0e		beq $d9a0	                beq LD9A0
4859	.d992	2c 32 03	bit $0332	                bit $0332
4860	.d995	30 0a		bmi $d9a1	                bmi LD9A1
4861	.d997	88		dey		                dey
4862	.d998	ca		dex		                dex
4863	.d999	10 24		bpl $d9bf	                bpl LD9BF
4864	.d99b	20 4c da	jsr $da4c	                jsr LDA4C
4865	.d99e	80 1f		bra $d9bf	                bra LD9BF

4867	.d9a0					LD9A0:
4868	.d9a0	60		rts		                rts

4870	.d9a1					LD9A1:
4871	.d9a1	c8		iny		                iny
4872	.d9a2	e8		inx		                inx
4873	.d9a3	e0 08		cpx #$08	                cpx #$08
4874	.d9a5	d0 18		bne $d9bf	                bne LD9BF
4875	.d9a7	38		sec		                sec
4876	.d9a8	98		tya		                tya
4877	.d9a9	e9 08		sbc #$08	                sbc #$08
4878	.d9ab	18		clc		                clc
4879	.d9ac	6d 52 03	adc $0352	                adc $0352
4880	.d9af	a8		tay		                tay
4881	.d9b0	a5 d7		lda $d7		                lda ZMEMG+1
4882	.d9b2	6d 53 03	adc $0353	                adc $0353
4883	.d9b5	10 04		bpl $d9bb	                bpl LD9BB
4884	.d9b7	38		sec		                sec
4885	.d9b8	ed 54 03	sbc $0354	                sbc $0354
4886	.d9bb					LD9BB:
4887	.d9bb	85 d7		sta $d7		                sta ZMEMG+1
4888	.d9bd	a2 00		ldx #$00	                ldx #$00
4889	.d9bf					LD9BF:
4890	.d9bf	ad 69 03	lda $0369	                lda $0369
4891	.d9c2	f0 03		beq $d9c7	                beq LD9C7
4892	.d9c4	20 7c da	jsr $da7c	                jsr setupColourMasks
4893	.d9c7					LD9C7:
4894	.d9c7	18		clc		                clc
4895	.d9c8	ad 30 03	lda $0330	                lda $0330
4896	.d9cb	6d 2c 03	adc $032c	                adc $032C
4897	.d9ce	8d 30 03	sta $0330	                sta $0330
4898	.d9d1	ad 31 03	lda $0331	                lda $0331
4899	.d9d4	6d 2d 03	adc $032d	                adc $032D
4900	.d9d7	8d 31 03	sta $0331	                sta $0331
4901	.d9da	30 83		bmi $d95f	                bmi LD95F
4902	.d9dc					LD9DC:
4903	.d9dc	e6 e0		inc $e0		                inc $E0
4904	.d9de	d0 04		bne $d9e4	                bne LD9E4
4905	.d9e0	e6 dd		inc $dd		                inc $DD
4906	.d9e2	f0 bc		beq $d9a0	                beq LD9A0
4907	.d9e4					LD9E4:
4908	.d9e4	2c 32 03	bit $0332	                bit $0332
4909	.d9e7	70 09		bvs $d9f2	                bvs LD9F2
4910	.d9e9	46 d1		lsr $d1		                lsr ZMASK
4911	.d9eb	90 0c		bcc $d9f9	                bcc LD9F9
4912	.d9ed	20 67 da	jsr $da67	                jsr nextColumnAndResetMask
4913	.d9f0	80 07		bra $d9f9	                bra LD9F9

4915	.d9f2					LD9F2:
4916	.d9f2	06 d1		asl $d1		                asl ZMASK
4917	.d9f4	90 03		bcc $d9f9	                bcc LD9F9
4918	.d9f6	20 34 da	jsr $da34	                jsr previousColumnAndResetMask
4919	.d9f9					LD9F9:
4920	.d9f9	38		sec		                sec
4921	.d9fa	ad 30 03	lda $0330	                lda $0330
4922	.d9fd	ed 2e 03	sbc $032e	                sbc $032E
4923	.da00	8d 30 03	sta $0330	                sta $0330
4924	.da03	ad 31 03	lda $0331	                lda $0331
4925	.da06	ed 2f 03	sbc $032f	                sbc $032F
4926	.da09	8d 31 03	sta $0331	                sta $0331
4927	.da0c	4c 5f d9	jmp $d95f	                jmp LD95F

4929	.da0f					LDA0F:
4930	.da0f	30 09		bmi $da1a	                bmi LDA1A
4931	.da11	fe 28 03	inc $0328,x	                inc $0328,x
4932	.da14	d0 0f		bne $da25	                bne LDA25
4933	.da16	fe 29 03	inc $0329,x	                inc $0329,x
4934	.da19	60		rts		                rts

4936	.da1a					LDA1A:
4937	.da1a	bd 28 03	lda $0328,x	                lda $0328,x
4938	.da1d	d0 03		bne $da22	                bne LDA22
4939	.da1f	de 29 03	dec $0329,x	                dec $0329,x
4940	.da22					LDA22:
4941	.da22	de 28 03	dec $0328,x	                dec $0328,x
4942	.da25					LDA25:
4943	.da25	60		rts		                rts

4945	.da26					LDA26:
4946	.da26	a0 04		ldy #$04	                ldy #$04
4947	.da28					LDA28:
4948	.da28	b9 27 03	lda $0327,y	                lda $0327,y
4949	.da2b	d9 2b 03	cmp $032b,y	                cmp $032B,y
4950	.da2e	d0 03		bne $da33	                bne LDA33
4951	.da30	88		dey		                dey
4952	.da31	d0 f5		bne $da28	                bne LDA28
4953	.da33					LDA33:
4954	.da33	60		rts		                rts

4956						;-------------------------------------------------------------------------

4958	.da34					previousColumnAndResetMask:
4959	.da34	ad 63 03	lda $0363	                lda vduv.colourMaskRight
4960	.da37	85 d1		sta $d1		                sta ZMASK
4961	.da39	98		tya		                tya
4962	.da3a	e9 08		sbc #$08	                sbc #$08
4963	.da3c	a8		tay		                tay
4964	.da3d	b0 0c		bcs $da4b	                bcs rtsDA4B
4965	.da3f	a5 d7		lda $d7		                lda ZMEMG+1
4966	.da41	3a		dec a		                dec a
4967	.da42	cd 4e 03	cmp $034e	                cmp vduv.startScreenAddressHighByte
4968	.da45	b0 02		bcs $da49	                bcs +
4969	.da47	a9 7f		lda #$7f	                lda #$7F
4970	.da49					+
4971	.da49	85 d7		sta $d7		                sta ZMEMG+1
4972	.da4b					rtsDA4B:
4973	.da4b	60		rts		                rts

4975						;-------------------------------------------------------------------------

4977	.da4c					LDA4C:
4978	.da4c	18		clc		                clc
4979	.da4d	98		tya		                tya
4980	.da4e	69 08		adc #$08	                adc #$08
4981	.da50	38		sec		                sec
4982	.da51	ed 52 03	sbc $0352	                sbc $0352
4983	.da54	a8		tay		                tay
4984	.da55	a5 d7		lda $d7		                lda ZMEMG+1
4985	.da57	ed 53 03	sbc $0353	                sbc $0353
4986	.da5a	cd 4e 03	cmp $034e	                cmp $034E
4987	.da5d	b0 03		bcs $da62	                bcs LDA62
4988	.da5f	6d 54 03	adc $0354	                adc $0354
4989	.da62					LDA62:
4990	.da62	85 d7		sta $d7		                sta ZMEMG+1
4991	.da64	a2 07		ldx #$07	                ldx #$07
4992	.da66	60		rts		                rts

4994						;-------------------------------------------------------------------------
4995						;
4996	.da67					nextColumnAndResetMask:
4997	.da67	ad 62 03	lda $0362	                lda vduv.colourMaskLeft
4998	.da6a	85 d1		sta $d1		                sta ZMASK

5000						;-------------------------------------------------------------------------
5001						;
5002						; Add 8 to (ZMEMG),Y, taking into account screen wrap.
5003						;
5004						; entry:
5005						;
5006						; C=1
5007						;
5008						; (ZMEMG),Y = screen address
5009						;
5010						; exit:
5011						;
5012						; (ZMEMG),Y = new screen address
5013						;
5014	.da6c					nextColumn:
5015	.da6c	98		tya		                tya
5016	.da6d	69 07		adc #$07	                adc #$07
5017	.da6f	a8		tay		                tay
5018	.da70	90 09		bcc $da7b	                bcc +
5019	.da72	e6 d7		inc $d7		                inc ZMEMG+1
5020	.da74	10 05		bpl $da7b	                bpl +
5021	.da76	ad 4e 03	lda $034e	                lda vduv.startScreenAddressHighByte
5022	.da79	85 d7		sta $d7		                sta ZMEMG+1
5023	.da7b					+
5024	.da7b	60		rts		                rts

5026						;-------------------------------------------------------------------------
5027						;
5028						; Set up colour masks, taking into account ECF pattern.
5029						;
5030						; entry:
5031						;
5032						; X = scanline in row, 0-7
5033						;
5034	.da7c					setupColourMasks:
5035	.da7c	da		phx		                phx                          ;save scanline
5036	.da7d	8a		txa		                txa                          ;A=scanline
5037	.da7e	0d 59 03	ora $0359	                ora vduv.graphicsPlotState   ;0-7 if fg, 8-15 if bg
5038	.da81	aa		tax		                tax
5039	.da82	bd 20 88	lda $8820,x	                lda andy.fgECFPattern,x      ;get appropriate ECF byte
5040	.da85	ae 5a 03	ldx $035a	                ldx vduv.graphicsPlotMode
5041	.da88	48		pha		                pha
5042	.da89	1d 54 e1	ora $e154,x	                ora zgoraORTable,x
5043	.da8c	5d 55 e1	eor $e155,x	                eor zgoraEORTable,x
5044	.da8f	85 d4		sta $d4		                sta ZGORA
5045	.da91	68		pla		                pla
5046	.da92	1d 53 e1	ora $e153,x	                ora zgeorORTable,x
5047	.da95	5d 58 e1	eor $e158,x	                eor zgeorEORTable,x
5048	.da98	85 d5		sta $d5		                sta ZGEOR
5049	.da9a	fa		plx		                plx
5050	.da9b	60		rts		                rts

5052						;-------------------------------------------------------------------------

5054	.da9c					LDA9C:
5055	.da9c	b9 01 03	lda $0301,y	                lda $0301,y
5056	.da9f	48		pha		                pha
5057	.daa0	b9 00 03	lda $0300,y	                lda $0300,y
5058	.daa3	48		pha		                pha
5059	.daa4	2d 61 03	and $0361	                and $0361
5060	.daa7	18		clc		                clc
5061	.daa8	6d 61 03	adc $0361	                adc $0361
5062	.daab	a8		tay		                tay
5063	.daac	b9 3e e1	lda $e13e,y	                lda pixelMasks-1,y
5064	.daaf	59 30 e1	eor $e130,y	                eor LE120,y
5065	.dab2	85 dc		sta $dc		                sta $DC
5066	.dab4	bd 00 03	lda $0300,x	                lda $0300,x
5067	.dab7	2d 61 03	and $0361	                and $0361
5068	.daba	6d 61 03	adc $0361	                adc $0361
5069	.dabd	a8		tay		                tay
5070	.dabe	b9 30 e1	lda $e130,y	                lda LE120,y
5071	.dac1	85 d1		sta $d1		                sta ZMASK
5072	.dac3	38		sec		                sec
5073	.dac4	68		pla		                pla
5074	.dac5	0d 61 03	ora $0361	                ora $0361
5075	.dac8	fd 00 03	sbc $0300,x	                sbc $0300,x
5076	.dacb	a8		tay		                tay
5077	.dacc	68		pla		                pla
5078	.dacd	fd 01 03	sbc $0301,x	                sbc $0301,x
5079	.dad0	85 dd		sta $dd		                sta $DD
5080	.dad2	98		tya		                tya
5081	.dad3	ac 61 03	ldy $0361	                ldy $0361
5082	.dad6	c0 03		cpy #$03	                cpy #$03
5083	.dad8	f0 05		beq $dadf	                beq LDADF
5084	.dada	90 06		bcc $dae2	                bcc LDAE2
5085	.dadc	46 dd		lsr $dd		                lsr $DD
5086	.dade	6a		ror a		                ror a
5087	.dadf					LDADF:
5088	.dadf	46 dd		lsr $dd		                lsr $DD
5089	.dae1	6a		ror a		                ror a
5090	.dae2					LDAE2:
5091	.dae2	4a		lsr a		                lsr a
5092	.dae3					LDAE3:
5093	.dae3	60		rts		                rts

5095	.dae4					LDAE4:
5096	.dae4	a2 42		ldx #$42	                ldx #$42
5097	.dae6	a0 46		ldy #$46	                ldy #$46
5098	.dae8					LDAE8:
5099	.dae8	20 cc d5	jsr $d5cc	                jsr sortVDUVariableWords
5100	.daeb	86 de		stx $de		                stx $DE
5101	.daed	84 df		sty $df		                sty $DF
5102	.daef	a6 df		ldx $df		                ldx $DF
5103	.daf1	a0 00		ldy #$00	                ldy #$00
5104	.daf3	20 b7 d1	jsr $d1b7	                jsr getOutcodeForAxis
5105	.daf6	f0 07		beq $daff	                beq LDAFF
5106	.daf8	4a		lsr a		                lsr a
5107	.daf9	f0 e8		beq $dae3	                beq LDAE3
5108	.dafb	a2 04		ldx #$04	                ldx #$04
5109	.dafd	86 df		stx $df		                stx $DF
5110	.daff					LDAFF:
5111	.daff	a6 de		ldx $de		                ldx $DE
5112	.db01	20 a8 d1	jsr $d1a8	                jsr windEntryPoint
5113	.db04	4a		lsr a		                lsr a
5114	.db05	d0 dc		bne $dae3	                bne LDAE3
5115	.db07	bd 02 03	lda $0302,x	                lda $0302,x
5116	.db0a	90 04		bcc $db10	                bcc LDB10
5117	.db0c	a2 00		ldx #$00	                ldx #$00
5118	.db0e	86 de		stx $de		                stx $DE
5119	.db10					LDB10:
5120	.db10	20 cb de	jsr $decb	                jsr LDECB
5121	.db13	a6 de		ldx $de		                ldx $DE
5122	.db15	a4 df		ldy $df		                ldy $DF
5123	.db17	20 9c da	jsr $da9c	                jsr LDA9C
5124	.db1a	aa		tax		                tax
5125	.db1b	ac 1a 03	ldy $031a	                ldy $031A
5126	.db1e	8a		txa		                txa
5127	.db1f	f0 23		beq $db44	                beq LDB44
5128	.db21	20 51 db	jsr $db51	                jsr plbyteEntryPoint
5129	.db24	80 08		bra $db2e	                bra LDB2E

5131	.db26					LDB26:
5132	.db26	b1 d6		lda ($d6),y	                lda (ZMEMG),y
5133	.db28	05 d4		ora $d4		                ora ZGORA
5134	.db2a	45 d5		eor $d5		                eor ZGEOR
5135	.db2c	91 d6		sta ($d6),y	                sta (ZMEMG),y
5136	.db2e					LDB2E:
5137	.db2e	98		tya		                tya
5138	.db2f	18		clc		                clc
5139	.db30	69 08		adc #$08	                adc #$08
5140	.db32	a8		tay		                tay
5141	.db33	90 09		bcc $db3e	                bcc LDB3E
5142	.db35	e6 d7		inc $d7		                inc ZMEMG+1
5143	.db37	10 05		bpl $db3e	                bpl LDB3E
5144	.db39	ad 4e 03	lda $034e	                lda $034E
5145	.db3c	85 d7		sta $d7		                sta ZMEMG+1
5146	.db3e					LDB3E:
5147	.db3e	ca		dex		                dex
5148	.db3f	d0 e5		bne $db26	                bne LDB26
5149	.db41	ca		dex		                dex
5150	.db42	86 d1		stx $d1		                stx ZMASK
5151	.db44					LDB44:
5152	.db44	a5 dc		lda $dc		                lda $DC
5153	.db46	14 d1		trb $d1		                trb ZMASK
5154	.db48	80 07		bra $db51	                bra plbyteEntryPoint

5156						;-------------------------------------------------------------------------
5157						;
5158						; mem mask ora eor | result
5159						; --- ---- --- --- | ------
5160						;  0    0   0   0  |   0
5161						;  0    0   0   1  |   0
5162						;  0    0   1   0  |   0
5163						;  0    0   1   1  |   0
5164						;  0    1   0   0  |   0
5165						;  0    1   0   1  |   1
5166						;  0    1   1   0  |   1
5167						;  0    1   1   1  |   0
5168						;  1    0   0   0  |   1
5169						;  1    0   0   1  |   1
5170						;  1    0   1   0  |   1
5171						;  1    0   1   1  |   1
5172						;  1    1   0   0  |   1
5173						;  1    1   0   1  |   0
5174						;  1    1   1   0  |   1
5175						;  1    1   1   1  |   0
5176						;
5177	.db4a					plotPoint:
5178	.db4a	a2 20		ldx #$20	                ldx #VDUVariables.queueEnd-4
5179	.db4c					LDB4C:
5180	.db4c	20 c3 de	jsr $dec3	                jsr windGADDR
5181	.db4f	d0 10		bne $db61	                bne rtsDB61                  ;taken if point outside window
5182	.db51					plbyteEntryPoint:
5183	.db51	a5 d1		lda $d1		                lda ZMASK
5184	.db53	25 d4		and $d4		                and ZGORA
5185	.db55	11 d6		ora ($d6),y	                ora (ZMEMG),y
5186	.db57	85 da		sta $da		                sta ZTEMP+0
5187	.db59	a5 d5		lda $d5		                lda ZGEOR
5188	.db5b	25 d1		and $d1		                and ZMASK
5189	.db5d	45 da		eor $da		                eor ZTEMP+0
5190	.db5f					oswrscCode:
5191	.db5f	91 d6		sta ($d6),y	                sta (ZMEMG),y
5192	.db61					rtsDB61:
5193	.db61	60		rts		                rts

5195						;-------------------------------------------------------------------------

5197	.db62					LDB62:
5198	.db62	a2 2a		ldx #$2a	                ldx #VDUVariables.workspace._2A
5199	.db64	a0 32		ldy #$32	                ldy #VDUVariables.workspace._32
5200	.db66	20 0c c9	jsr $c90c	                jsr copyTwoBytesWithinVDUVariables
5201	.db69	a2 36		ldx #$36	                ldx #VDUVariables.workspace._36
5202	.db6b	a0 3e		ldy #$3e	                ldy #VDUVariables.workspace._3E
5203	.db6d	20 0c c9	jsr $c90c	                jsr copyTwoBytesWithinVDUVariables
5204	.db70	a2 2a		ldx #$2a	                ldx #$2A
5205	.db72	20 b5 d1	jsr $d1b5	                jsr getOutcodeForYAxis
5206	.db75	48		pha		                pha
5207	.db76	a2 36		ldx #$36	                ldx #$36
5208	.db78	20 b5 d1	jsr $d1b5	                jsr getOutcodeForYAxis
5209	.db7b	f0 0f		beq $db8c	                beq LDB8C
5210	.db7d	68		pla		                pla
5211	.db7e	d0 05		bne $db85	                bne LDB85
5212	.db80	ad 45 03	lda $0345	                lda $0345
5213	.db83	f0 01		beq $db86	                beq LDB86
5214	.db85					LDB85:
5215	.db85	60		rts		                rts

5217	.db86					LDB86:
5218	.db86	a2 28		ldx #$28	                ldx #$28
5219	.db88	a0 2c		ldy #$2c	                ldy #$2C
5220	.db8a	80 07		bra $db93	                bra LDB93

5222	.db8c					LDB8C:
5223	.db8c	68		pla		                pla
5224	.db8d	f0 07		beq $db96	                beq LDB96
5225	.db8f	a2 34		ldx #$34	                ldx #$34
5226	.db91	a0 38		ldy #$38	                ldy #$38
5227	.db93					LDB93:
5228	.db93	4c e8 da	jmp $dae8	                jmp LDAE8

5230	.db96					LDB96:
5231	.db96	a2 30		ldx #$30	                ldx #$30
5232	.db98	20 c8 de	jsr $dec8	                jsr gaddrEntryPoint
5233	.db9b	2c 47 03	bit $0347	                bit $0347
5234	.db9e	30 09		bmi $dba9	                bmi LDBA9
5235	.dba0	98		tya		                tya
5236	.dba1	38		sec		                sec
5237	.dba2	e9 08		sbc #$08	                sbc #$08
5238	.dba4	a8		tay		                tay
5239	.dba5	b0 02		bcs $dba9	                bcs LDBA9
5240	.dba7	c6 d7		dec $d7		                dec ZMEMG+1
5241	.dba9					LDBA9:
5242	.dba9	ad 44 03	lda $0344	                lda $0344
5243	.dbac	85 dd		sta $dd		                sta $DD
5244	.dbae					LDBAE:
5245	.dbae	b1 d6		lda ($d6),y	                lda (ZMEMG),y
5246	.dbb0	ae 42 03	ldx $0342	                ldx $0342
5247	.dbb3	f0 04		beq $dbb9	                beq LDBB9
5248	.dbb5					LDBB5:
5249	.dbb5	0a		asl a		                asl a
5250	.dbb6	ca		dex		                dex
5251	.dbb7	d0 fc		bne $dbb5	                bne LDBB5
5252	.dbb9					LDBB9:
5253	.dbb9	85 da		sta $da		                sta $DA
5254	.dbbb	38		sec		                sec
5255	.dbbc	20 6c da	jsr $da6c	                jsr nextColumn
5256	.dbbf	b1 d6		lda ($d6),y	                lda (ZMEMG),y
5257	.dbc1	ae 43 03	ldx $0343	                ldx $0343
5258	.dbc4	f0 04		beq $dbca	                beq LDBCA
5259	.dbc6					LDBC6:
5260	.dbc6	4a		lsr a		                lsr a
5261	.dbc7	ca		dex		                dex
5262	.dbc8	d0 fc		bne $dbc6	                bne LDBC6
5263	.dbca					LDBCA:
5264	.dbca	45 da		eor $da		                eor $DA
5265	.dbcc	25 e1		and $e1		                and $E1
5266	.dbce	45 da		eor $da		                eor $DA
5267	.dbd0	a6 dd		ldx $dd		                ldx $DD
5268	.dbd2	9d 30 88	sta $8830,x	                sta L8830,x
5269	.dbd5	c6 dd		dec $dd		                dec $DD
5270	.dbd7	10 d5		bpl $dbae	                bpl LDBAE
5271	.dbd9	a2 34		ldx #$34	                ldx #$34
5272	.dbdb	a0 38		ldy #$38	                ldy #$38
5273	.dbdd	20 e8 da	jsr $dae8	                jsr LDAE8
5274	.dbe0	ad 45 03	lda $0345	                lda $0345
5275	.dbe3	d0 03		bne $dbe8	                bne LDBE8
5276	.dbe5	20 86 db	jsr $db86	                jsr LDB86
5277	.dbe8					LDBE8:
5278	.dbe8	a2 3c		ldx #$3c	                ldx #$3C
5279	.dbea	20 c8 de	jsr $dec8	                jsr gaddrEntryPoint
5280	.dbed	ad 46 03	lda $0346	                lda $0346
5281	.dbf0	85 da		sta $da		                sta $DA
5282	.dbf2	ae 44 03	ldx $0344	                ldx $0344
5283	.dbf5	f0 15		beq $dc0c	                beq LDC0C
5284	.dbf7	20 10 dc	jsr $dc10	                jsr LDC10
5285	.dbfa	a9 ff		lda #$ff	                lda #$FF
5286	.dbfc	85 da		sta $da		                sta $DA
5287	.dbfe	80 05		bra $dc05	                bra LDC05

5289	.dc00					LDC00_code:
5290	.dc00	bd 30 88	lda $8830,x	                lda L8830,x
5291	.dc03	91 d6		sta ($d6),y	                sta (ZMEMG),y
5292	.dc05					LDC05:
5293	.dc05	38		sec		                sec
5294	.dc06	20 6c da	jsr $da6c	                jsr nextColumn
5295	.dc09	ca		dex		                dex
5296	.dc0a	d0 f4		bne $dc00	                bne LDC00_code
5297	.dc0c					LDC0C:
5298	.dc0c	a5 e0		lda $e0		                lda $E0
5299	.dc0e	14 da		trb $da		                trb $DA
5300	.dc10					LDC10:
5301	.dc10	bd 30 88	lda $8830,x	                lda L8830,x
5302	.dc13	51 d6		eor ($d6),y	                eor (ZMEMG),y
5303	.dc15	25 da		and $da		                and $DA
5304	.dc17	51 d6		eor ($d6),y	                eor (ZMEMG),y
5305	.dc19	91 d6		sta ($d6),y	                sta (ZMEMG),y
5306	.dc1b	60		rts		                rts

5308	.dc1c					LDC1C:
5309	.dc1c	ad 37 03	lda $0337	                lda $0337
5310	.dc1f	1a		inc a		                inc a
5311	.dc20	cd 36 03	cmp $0336	                cmp $0336
5312	.dc23	f0 22		beq $dc47	                beq LDC47
5313	.dc25	8d 37 03	sta $0337	                sta $0337
5314	.dc28	aa		tax		                tax
5315	.dc29	ad 2e 03	lda $032e	                lda $032E
5316	.dc2c	9d 00 84	sta $8400,x	                sta L8400,x
5317	.dc2f	ad 32 03	lda $0332	                lda $0332
5318	.dc32	9d 00 85	sta $8500,x	                sta L8500,x
5319	.dc35	ad 2f 03	lda $032f	                lda $032F
5320	.dc38	0a		asl a		                asl a
5321	.dc39	0a		asl a		                asl a
5322	.dc3a	0d 33 03	ora $0333	                ora $0333
5323	.dc3d	9d 00 86	sta $8600,x	                sta L8600,x
5324	.dc40	ad 30 03	lda $0330	                lda $0330
5325	.dc43	9d 00 87	sta $8700,x	                sta L8700,x
5326	.dc46					LDC46:
5327	.dc46	18		clc		                clc
5328	.dc47					LDC47:
5329	.dc47	60		rts		                rts

5331	.dc48					LDC48:
5332	.dc48	8d 2a 03	sta $032a	                sta $032A
5333	.dc4b	a2 28		ldx #$28	                ldx #$28
5334	.dc4d	20 b0 dc	jsr $dcb0	                jsr LDCB0
5335	.dc50	d0 0a		bne $dc5c	                bne LDC5C
5336	.dc52					LDC52:
5337	.dc52	20 1c dc	jsr $dc1c	                jsr LDC1C
5338	.dc55	b0 f0		bcs $dc47	                bcs LDC47
5339	.dc57	20 87 9d	jsr $9d87	                jsr terminal.L9D57
5340	.dc5a	b0 ea		bcs $dc46	                bcs LDC46
5341	.dc5c					LDC5C:
5342	.dc5c	20 c1 dc	jsr $dcc1	                jsr LDCC1
5343	.dc5f	20 87 9d	jsr $9d87	                jsr terminal.L9D57
5344	.dc62	b0 e2		bcs $dc46	                bcs LDC46
5345	.dc64	20 d7 dc	jsr $dcd7	                jsr LDCD7
5346	.dc67	20 b8 dc	jsr $dcb8	                jsr LDCB8
5347	.dc6a	80 e6		bra $dc52	                bra LDC52

5349						;-------------------------------------------------------------------------
5350						;
5351						; 72<80><93>79 = Horizontal line fill (left and right to non-background) [MasRef E.3-24]
5352						; 88<80><93>95 = Horizontal line fill (right to background) [MasRef E.3-25]
5353						; 104<80><93>111 = Horizontal line fill (left and right to foreground) [MasRef E.3-26]
5354						; 120<80><93>127 = Horizontal line fill (right to non-foreground) [MasRef E.3-27]
5355						;
5356	.dc6c					plotHorizontalLineFill:
5357	.dc6c	20 9f dd	jsr $dd9f	                jsr copyECFPatternForLineFill
5358	.dc6f	20 b0 dc	jsr $dcb0	                jsr LDCB0
5359	.dc72	18		clc		                clc
5360	.dc73	80 0e		bra $dc83	                bra LDC83

5362	.dc75					plotHorizontalLineFillRight:
5363	.dc75	20 9f dd	jsr $dd9f	                jsr copyECFPatternForLineFill
5364	.dc78	20 c9 dc	jsr $dcc9	                jsr LDCC9
5365	.dc7b	20 d2 dc	jsr $dcd2	                jsr LDCD2
5366	.dc7e	d0 03		bne $dc83	                bne LDC83
5367	.dc80	20 b8 dc	jsr $dcb8	                jsr LDCB8
5368	.dc83					LDC83:
5369	.dc83	08		php		                php
5370	.dc84	a2 2e		ldx #$2e	                ldx #VDUVariables.hlfw.pixelsX
5371	.dc86	a0 14		ldy #$14	                ldy #VDUVariables.oldGraphicsCursorPixelsX
5372	.dc88	20 1e c9	jsr $c91e	                jsr copyFourBytesWithinVDUVariables
5373	.dc8b	28		plp		                plp
5374	.dc8c	08		php		                php
5375	.dc8d	f0 02		beq $dc91	                beq LDC91
5376	.dc8f	a2 2e		ldx #$2e	                ldx #VDUVariables.hlfw.pixelsX
5377	.dc91					LDC91:
5378	.dc91	a0 24		ldy #$24	                ldy #VDUVariables.graphicsCursorPixelsX
5379	.dc93	20 0c c9	jsr $c90c	                jsr copyTwoBytesWithinVDUVariables
5380	.dc96	a2 30		ldx #$30	                ldx #VDUVariables.hlfw.pixelsY
5381	.dc98	20 0c c9	jsr $c90c	                jsr copyTwoBytesWithinVDUVariables
5382	.dc9b	28		plp		                plp
5383	.dc9c	f0 05		beq $dca3	                beq LDCA3
5384	.dc9e	b0 04		bcs $dca4	                bcs LDCA4
5385	.dca0	ee 16 03	inc $0316	                inc $0316
5386	.dca3					LDCA3:
5387	.dca3	60		rts		                rts

5389	.dca4					LDCA4:
5390	.dca4	ad 24 03	lda $0324	                lda $0324
5391	.dca7	d0 03		bne $dcac	                bne LDCAC
5392	.dca9	ce 25 03	dec $0325	                dec $0325
5393	.dcac					LDCAC:
5394	.dcac	ce 24 03	dec $0324	                dec $0324
5395	.dcaf	60		rts		                rts

5397						;-------------------------------------------------------------------------

5399	.dcb0					LDCB0:
5400	.dcb0	20 d2 dc	jsr $dcd2	                jsr LDCD2
5401	.dcb3	d0 55		bne $dd0a	                bne rtsDD0A
5402	.dcb5	20 0b dd	jsr $dd0b	                jsr LDD0B
5403	.dcb8					LDCB8:
5404	.dcb8	a2 2e		ldx #$2e	                ldx #$2E
5405	.dcba	a0 32		ldy #$32	                ldy #$32
5406	.dcbc	20 e8 da	jsr $dae8	                jsr LDAE8
5407	.dcbf	80 46		bra $dd07	                bra LDD07

5409	.dcc1					LDCC1:
5410	.dcc1	20 c9 dc	jsr $dcc9	                jsr LDCC9
5411	.dcc4	a2 2c		ldx #$2c	                ldx #$2C
5412	.dcc6	20 d9 dc	jsr $dcd9	                jsr LDCD9
5413	.dcc9					LDCC9:
5414	.dcc9	08		php		                php
5415	.dcca	a5 e1		lda $e1		                lda $E1
5416	.dccc	49 08		eor #$08	                eor #$08
5417	.dcce	85 e1		sta $e1		                sta $E1
5418	.dcd0	28		plp		                plp
5419	.dcd1	60		rts		                rts

5421						;-------------------------------------------------------------------------

5423	.dcd2					LDCD2:
5424	.dcd2	a0 2e		ldy #$2e	                ldy #VDUVariables.hlfw.pixelsX
5425	.dcd4	20 1e c9	jsr $c91e	                jsr copyFourBytesWithinVDUVariables
5426	.dcd7					LDCD7:
5427	.dcd7	a2 04		ldx #$04	                ldx #VDUVariables.graphicsWindowPixelsRight
5428	.dcd9					LDCD9:
5429	.dcd9	a0 34		ldy #$34	                ldy #VDUVariables.hlfw.pixelsLimitX
5430	.dcdb	20 0c c9	jsr $c90c	                jsr copyTwoBytesWithinVDUVariables
5431	.dcde	a2 34		ldx #$34	                ldx #VDUVariables.hlfw.pixelsLimitX
5432	.dce0	20 35 dd	jsr $dd35	                jsr shouldFillPixel
5433	.dce3	d0 25		bne $dd0a	                bne rtsDD0A  ;taken if pixel not to be filled, so done
5434	.dce5					LDCE5:
5435	.dce5	46 d1		lsr $d1		                lsr ZMASK                    ;next pixel
5436	.dce7	90 08		bcc $dcf1	                bcc LDCF1                    ;taken if still in same byte
5437	.dce9					LDCE9:
5438	.dce9	20 67 da	jsr $da67	                jsr nextColumnAndResetMask
5439	.dcec	20 65 dd	jsr $dd65	                jsr shouldFillByte
5440	.dcef	b0 f8		bcs $dce9	                bcs LDCE9
5441	.dcf1					LDCF1:
5442	.dcf1	20 85 dd	jsr $dd85	                jsr LDD85
5443	.dcf4	b0 ef		bcs $dce5	                bcs LDCE5
5444	.dcf6	38		sec		                sec
5445	.dcf7	ad 34 03	lda $0334	                lda vduv.hlfw.pixelsLimitX+0
5446	.dcfa	e5 de		sbc $de		                sbc zhlfw.pixelsX+0
5447	.dcfc	8d 32 03	sta $0332	                sta vduv.hlfw.pixelsRightEndX+0
5448	.dcff	ad 35 03	lda $0335	                lda vduv.hlfw.pixelsLimitX+1
5449	.dd02	e5 df		sbc $df		                sbc zhlfw.pixelsX+1
5450	.dd04	8d 33 03	sta $0333	                sta vduv.hlfw.pixelsRightEndX+1
5451	.dd07					LDD07:
5452	.dd07	a9 00		lda #$00	                lda #$00
5453	.dd09	38		sec		                sec
5454	.dd0a					rtsDD0A:
5455	.dd0a	60		rts		                rts

5457	.dd0b					LDD0B:
5458	.dd0b	a2 00		ldx #$00	                ldx #VDUVariables.graphicsWindowPixelsLeft
5459	.dd0d	20 35 dd	jsr $dd35	                jsr shouldFillPixel
5460	.dd10	d0 f8		bne $dd0a	                bne rtsDD0A                    ;taken if pixel not to be filled, so done
5461	.dd12					LDD12:
5462	.dd12	06 d1		asl $d1		                asl ZMASK                      ;next pixel
5463	.dd14	90 08		bcc $dd1e	                bcc LDD1E                    ;taken if still in same byte
5464	.dd16					LDD16:
5465	.dd16	20 34 da	jsr $da34	                jsr previousColumnAndResetMask
5466	.dd19	20 65 dd	jsr $dd65	                jsr shouldFillByte
5467	.dd1c	b0 f8		bcs $dd16	                bcs LDD16
5468	.dd1e					LDD1E:
5469	.dd1e	20 85 dd	jsr $dd85	                jsr LDD85
5470	.dd21	b0 ef		bcs $dd12	                bcs LDD12
5471	.dd23	ad 00 03	lda $0300	                lda vduv.graphicsWindowPixelsLeft+0
5472	.dd26	65 de		adc $de		                adc zhlfw.pixelsX+0
5473	.dd28	8d 2e 03	sta $032e	                sta vduv.hlfw.pixelsX+0
5474	.dd2b	ad 01 03	lda $0301	                lda vduv.graphicsWindowPixelsLeft+1
5475	.dd2e	65 df		adc $df		                adc zhlfw.pixelsX+1
5476	.dd30	8d 2f 03	sta $032f	                sta vduv.hlfw.pixelsX+1
5477	.dd33	80 d2		bra $dd07	                bra LDD07

5479						;-------------------------------------------------------------------------
5480						;
5481						; Check whether line fill should fill a pixel.
5482						;
5483						; entry:
5484						;
5485						; X = VDU variable offset of edge of window
5486						;
5487						; vduv.workspace._2E - pixel X, Y coordinates
5488						;
5489						; exit:
5490						;
5491						; Z=1 if pixel should be filled
5492						;
5493						; ZTEMPC = ???
5494						;
5495	.dd35					shouldFillPixel:
5496	.dd35	38		sec		                sec
5497	.dd36	ad 2e 03	lda $032e	                lda vduv.workspace._2E+0
5498	.dd39	fd 00 03	sbc $0300,x	                sbc vduv+0,x
5499	.dd3c	a8		tay		                tay
5500	.dd3d	ad 2f 03	lda $032f	                lda vduv.workspace._2E+1
5501	.dd40	fd 01 03	sbc $0301,x	                sbc vduv+1,x
5502	.dd43	10 03		bpl $dd48	                bpl +
5503	.dd45	20 2e c9	jsr $c92e	                jsr negateAY
5504	.dd48					+
5505	.dd48	84 de		sty $de		                sty zhlfw.pixelsX+0
5506	.dd4a	85 df		sta $df		                sta zhlfw.pixelsX+1
5507	.dd4c	a2 2e		ldx #$2e	                ldx #VDUVariables.workspace._2E
5508	.dd4e	20 c3 de	jsr $dec3	                jsr windGADDR
5509	.dd51	18		clc		                clc
5510	.dd52	d0 10		bne $dd64	                bne rtsDD64                    ;taken if point outside window
5511	.dd54	b1 d6		lda ($d6),y	                lda (ZMEMG),y                  ;get screen byte
5512	.dd56	5d 30 88	eor $8830,x	                eor andy.hlfw.ecfPattern,x     ;EOR with appropriate pattern
5513	.dd59	85 da		sta $da		                sta zhlfw.notByteMatch ;0 if whole byte matches
5514	.dd5b	25 d1		and $d1		                and ZMASK                      ;0 if masked byte matches
5515	.dd5d	f0 02		beq $dd61	                beq +              ;taken if masked byte matches - A=0
5516	.dd5f	a9 08		lda #$08	                lda #$08              ;masked byte doesn't match - A=8
5517	.dd61					+
5518	.dd61	45 e1		eor $e1		                eor zhlfw.resultEOR ;maybe invert result
5519	.dd63	38		sec		                sec
5520	.dd64					rtsDD64:
5521	.dd64	60		rts		                rts

5523						;-------------------------------------------------------------------------

5525	.dd65					shouldFillByte:
5526	.dd65	b1 d6		lda ($d6),y	                lda (ZMEMG),y
5527	.dd67	5d 30 88	eor $8830,x	                eor andy.hlfw.ecfPattern,x
5528	.dd6a	85 da		sta $da		                sta zhlfw.notByteMatch
5529	.dd6c	05 e1		ora $e1		                ora zhlfw.resultEOR
5530	.dd6e	18		clc		                clc
5531	.dd6f	d0 13		bne $dd84	                bne rtsDD84
5532	.dd71	a5 de		lda $de		                lda zhlfw.pixelsX+0
5533	.dd73	ed 61 03	sbc $0361	                sbc vduv.pixelsPerByteMinusOne
5534	.dd76	48		pha		                pha
5535	.dd77	a5 df		lda $df		                lda zhlfw.pixelsX+1
5536	.dd79	e9 00		sbc #$00	                sbc #$00
5537	.dd7b	90 06		bcc $dd83	                bcc pla_rts_DD83             ;taken if past X=0
5538	.dd7d	85 df		sta $df		                sta zhlfw.pixelsX+1
5539	.dd7f	68		pla		                pla
5540	.dd80	85 de		sta $de		                sta zhlfw.pixelsX+0
5541	.dd82	60		rts		                rts

5543	.dd83					pla_rts_DD83:
5544	.dd83	68		pla		                pla
5545	.dd84					rtsDD84:
5546	.dd84	60		rts		                rts

5548						;-------------------------------------------------------------------------

5550	.dd85					LDD85:
5551	.dd85	a5 da		lda $da		                lda zhlfw.notByteMatch
5552	.dd87	25 d1		and $d1		                and ZMASK
5553	.dd89	f0 02		beq $dd8d	                beq +
5554	.dd8b	a9 08		lda #$08	                lda #$08
5555	.dd8d					+
5556	.dd8d	45 e1		eor $e1		                eor zhlfw.resultEOR
5557	.dd8f	d0 0d		bne $dd9e	                bne rtsDD9E

5559						                ; pixelsX -= 1
5560	.dd91	a5 de		lda $de		                lda zhlfw.pixelsX+0
5561	.dd93	d0 06		bne $dd9b	                bne +
5562	.dd95	a5 df		lda $df		                lda zhlfw.pixelsX+1
5563	.dd97	f0 05		beq $dd9e	                beq rtsDD9E
5564	.dd99	c6 df		dec $df		                dec zhlfw.pixelsX+1
5565	.dd9b					+
5566	.dd9b	c6 de		dec $de		                dec zhlfw.pixelsX+0
5567	.dd9d	38		sec		                sec
5568	.dd9e					rtsDD9E:
5569	.dd9e	60		rts		                rts

5571						;-------------------------------------------------------------------------
5572						;
5573						; Copy appropriate ECF pattern for line fill.
5574						;
5575						; entry:
5576						;
5577						; A = horizontal line fill PLOT code
5578						;
5579						; exit:
5580						;
5581						; andy.hlfw.ecfPattern = holds bg/fg ECF pattern as required
5582						;
5583						; ZTEMPD?1 = 0 for fill to matching, 8 to fill to non-matching
5584						;
5585	.dd9f					copyECFPatternForLineFill:
5586	.dd9f	4a		lsr a		                lsr a                        ;36-39; 44-47; 52-55; 60-63
5587	.dda0	4a		lsr a		                lsr a                        ;18-19; 42-43; 26-27; 30-31
5588	.dda1					LDDA1:
5589	.dda1	29 08		and #$08	                and #$08                     ;8 if PLOT >= 104
5590	.dda3	85 e1		sta $e1		                sta zhlfw.resultEOR
5591	.dda5	49 0f		eor #$0f	                eor #$0F                     ;
5592	.dda7	aa		tax		                tax
5593	.dda8	a0 07		ldy #$07	                ldy #$07
5594	.ddaa					-
5595	.ddaa	bd 20 88	lda $8820,x	                lda andy.currentECFPatterns,x
5596	.ddad	99 30 88	sta $8830,y	                sta andy.hlfw.ecfPattern,y
5597	.ddb0	ca		dex		                dex
5598	.ddb1	88		dey		                dey
5599	.ddb2	10 f6		bpl $ddaa	                bpl -
5600	.ddb4	a2 20		ldx #$20	                ldx #VDUVariables.queueEnd-4
5601	.ddb6	60		rts		                rts

5603						;-------------------------------------------------------------------------
5604						;
5605						;
5606						; entry:
5607						;
5608						; A = offset into VDU variables of coordinates
5609						;
5610						; exit:
5611						;
5612						; A = colour, or $ff if off screen/teletext (as per OSWORD $09)
5613						;
5614	.ddb7					readPixelColour: .proc
5615	.ddb7	20 fa c0	jsr $c0fa	                jsr stopCursorEditing
5616	.ddba	ae 61 03	ldx $0361	                ldx vduv.pixelsPerByteMinusOne
5617	.ddbd	f0 21		beq $dde0	                beq invalid             ;taken if teletext
5618	.ddbf	48		pha		                pha
5619	.ddc0	aa		tax		                tax
5620	.ddc1	20 de d1	jsr $d1de	                jsr eigabsEntryPoint
5621	.ddc4	fa		plx		                plx
5622	.ddc5	20 c3 de	jsr $dec3	                jsr windGADDR
5623	.ddc8	d0 16		bne $dde0	                bne invalid             ;taken if off screen
5624	.ddca	b1 d6		lda ($d6),y	                lda (ZMEMG),y
5625	.ddcc	64 da		stz $da		                stz ZTEMP+0
5626	.ddce	80 01		bra $ddd1	                bra shiftMask

5628						                ; Keep shifting the byte and the mask. When a 1 bit is
5629						                ; shifted out of the mask, shift the corresponding
5630						                ; byte bit bit into ZTEMP+0, building up the pixel
5631						                ; colour a bit at a time.
5632						                ;
5633						                ; When the mask becomes 0, done.
5634	.ddd0					shiftByteAndMask:
5635	.ddd0	0a		asl a		                asl a
5636	.ddd1					shiftMask:
5637	.ddd1	06 d1		asl $d1		                asl ZMASK
5638	.ddd3	90 fb		bcc $ddd0	                bcc shiftByteAndMask
5639	.ddd5	0a		asl a		                asl a
5640	.ddd6	26 da		rol $da		                rol ZTEMP+0
5641	.ddd8	a6 d1		ldx $d1		                ldx ZMASK
5642	.ddda	d0 f5		bne $ddd1	                bne shiftMask
5643	.dddc	a5 da		lda $da		                lda ZTEMP+0
5644	.ddde	80 02		bra $dde2	                bra done

5646	.dde0					invalid:
5647	.dde0	a9 ff		lda #$ff	                lda #$FF
5648	.dde2					done:
5649	.dde2	4c ca c0	jmp $c0ca	                jmp reinstateCursorEditing
5650						                .endproc

5652						;-------------------------------------------------------------------------
5653						;
5654						; Translate ASCII char to the SAA5050 character set.
5655						;
5656						; # ($23) becomes $5f
5657						; _ ($5f) becomes $60
5658						; GBP ($60) becomes $23
5659						;
5660						; Because the mapping is a kind of cycle, you can call this routine
5661						; twice to translate from SAA5050 to ASCII.
5662						;
5663						; entry:
5664						;
5665						; A = ASCII char
5666						;
5667						; exit:
5668						;
5669						; A = SAA550 char
5670						;
5671	.dde5					getSAA5050FromASCII:
5672	.dde5	c9 23		cmp #$23	                cmp #$23
5673	.dde7	f0 0a		beq $ddf3	                beq translateHash
5674	.dde9	c9 5f		cmp #$5f	                cmp #$5F
5675	.ddeb	f0 08		beq $ddf5	                beq translateUnderscore
5676	.dded	c9 60		cmp #$60	                cmp #$60
5677	.ddef	d0 06		bne $ddf7	                bne rtsDDF7
5678	.ddf1					translateGBP:
5679	.ddf1	49 3f		eor #$3f	                eor #$3F                     ;0x60->0x5f
5680	.ddf3					translateHash:
5681	.ddf3	49 43		eor #$43	                eor #$43                     ;0x23->0x5f or 0x5f->0x1c
5682	.ddf5					translateUnderscore:
5683	.ddf5	49 3f		eor #$3f	                eor #$3F                     ;0x5f->0x60 or 0x1c->0x23
5684	.ddf7					rtsDDF7:
5685	.ddf7	60		rts		                rts

5687						;-------------------------------------------------------------------------

5689	.ddf8					readCharacterAtTextCursor: .proc
5690	.ddf8	58		cli		                cli
5691	.ddf9	24 d0		bit $d0		                bit STATE
5692	.ddfb	50 06		bvc $de03	                bvc +                      ;taken if not cursor editing
5693	.ddfd	20 fa c0	jsr $c0fa	                jsr stopCursorEditing
5694	.de00	20 d1 c0	jsr $c0d1	                jsr exchangeCursors
5695	.de03					+
5696	.de03	ac 60 03	ldy $0360	                ldy vduv.numberOfLogicalColoursMinusOne
5697	.de06	d0 17		bne $de1f	                bne bitmapMode
5698	.de08					readTeletextChar:
5699	.de08	b2 d8		lda ($d8)	                lda (ZMEMT)                  ;read character from screen
5700	.de0a	20 e5 dd	jsr $dde5	                jsr getSAA5050FromASCII      ;call 2x to convert to ASCII
5701	.de0d	20 e5 dd	jsr $dde5	                jsr getSAA5050FromASCII      ;call 2x to convert to ASCII
5702	.de10					done:
5703	.de10	24 d0		bit $d0		                bit STATE
5704	.de12	50 06		bvc $de1a	                bvc +                     ;taken if not cursor editing
5705	.de14	20 d1 c0	jsr $c0d1	                jsr exchangeCursors
5706	.de17	20 ca c0	jsr $c0ca	                jsr reinstateCursorEditing
5707	.de1a					+
5708	.de1a	ac 55 03	ldy $0355	                ldy vduv.currentScreenMODE
5709	.de1d	aa		tax		                tax
5710	.de1e	60		rts		                rts

5712	.de1f					bitmapMode:
5713	.de1f	20 56 de	jsr $de56	                jsr LDE56
5714	.de22	a5 f4		lda $f4		                lda $F4
5715	.de24	48		pha		                pha
5716	.de25	20 98 e5	jsr $e598	                jsr selectTerminalROMAndANDY
5717	.de28	a9 20		lda #$20	                lda #$20
5718	.de2a	aa		tax		                tax                          ;X = ASCII code for char
5719	.de2b	20 3c e2	jsr $e23c	                jsr getSoftCharacterDefinitionAddress
5720	.de2e					compare:
5721	.de2e	a0 07		ldy #$07	                ldy #$07
5722	.de30					-
5723	.de30	b9 28 03	lda $0328,y	                lda vduv.workspace._28,y
5724	.de33	51 de		eor ($de),y	                eor (ZTEMPC),y
5725	.de35	d0 0a		bne $de41	                bne nextFontChar ;taken if no match - can't be this char
5726	.de37	88		dey		                dey
5727	.de38	10 f6		bpl $de30	                bpl -

5729	.de3a	8a		txa		                txa                          ;A = char found
5730						                .if version==350
5733						                .endif
5734	.de3b					bitmapModeDone:
5735	.de3b	fa		plx		                plx
5736	.de3c	20 9a e5	jsr $e59a	                jsr selectROMX
5737	.de3f	80 cf		bra $de10	                bra done

5739	.de41					nextFontChar:
5740	.de41	e8		inx		                inx                          ;next ASCII code
5741						                .if version==350
5747						                .else
5748	.de42	18		clc		                clc
5749	.de43	a5 de		lda $de		                lda ZTEMPC+0
5750	.de45	69 08		adc #$08	                adc #$08                     ;8 bytes/font char
5751	.de47	85 de		sta $de		                sta ZTEMPC+0
5752	.de49	90 02		bcc $de4d	                bcc gotCharAddress
5753	.de4b	e6 df		inc $df		                inc ZTEMPC+1
5754						                .endif
5755	.de4d					gotCharAddress:
5756	.de4d	e0 7f		cpx #$7f	                cpx #$7F
5757	.de4f	f0 f0		beq $de41	                beq nextFontChar                 ;skip CHR$127
5758	.de51	8a		txa		                txa
5759	.de52	d0 da		bne $de2e	                bne compare           ;taken if more chars to consider
5760	.de54	80 e5		bra $de3b	                bra bitmapModeDone ;finish with A=0 - i.e., no match found
5761						                .endproc

5763						;-------------------------------------------------------------------------
5764						;
5765						; Copy character out of screen memory, and store as a 1 bpp bitmap in
5766						; VDU variables workspace.
5767						;
5768	.de56					LDE56: .proc
5769	.de56	a6 d8		ldx $d8		                ldx ZMEMT+0
5770	.de58	a5 d9		lda $d9		                lda ZMEMT+1
5771	.de5a	20 d9 ce	jsr $ced9	                jsr getNext3ColumnAddresses
5772	.de5d	a0 07		ldy #$07	                ldy #$07
5773	.de5f					loop:
5774	.de5f	ae 60 03	ldx $0360	                ldx vduv.numberOfLogicalColoursMinusOne
5775	.de62	e0 03		cpx #$03	                cpx #$03
5776	.de64	f0 09		beq $de6f	                beq read2bppChar
5777	.de66	b0 13		bcs $de7b	                bcs read4bppChar
5778	.de68					read1bppChar:
5779	.de68	b1 d8		lda ($d8),y	                lda (ZMEMT),y
5780	.de6a	4d 58 03	eor $0358	                eor vduv.backgroundTextColour
5781	.de6d	80 22		bra $de91	                bra next

5783	.de6f					read2bppChar:
5784	.de6f	b1 d8		lda ($d8),y	                lda (ZMEMT),y                ;get pixels 0-3
5785	.de71	20 a2 de	jsr $dea2	                jsr get4Pixels
5786	.de74	b1 da		lda ($da),y	                lda (ZTEMP),y                  ;get pixels 4-7
5787	.de76	20 a2 de	jsr $dea2	                jsr get4Pixels
5788	.de79	80 14		bra $de8f	                bra LDE8F

5790	.de7b					read4bppChar:
5791	.de7b	b1 d8		lda ($d8),y	                lda (ZMEMT),y                ;get pixels 0/1
5792	.de7d	20 98 de	jsr $de98	                jsr get2Pixels
5793	.de80	b1 da		lda ($da),y	                lda (ZTEMP),y                ;get pixels 2/3
5794	.de82	20 98 de	jsr $de98	                jsr get2Pixels
5795	.de85	b1 dc		lda ($dc),y	                lda (ZTEMPB),y               ;get pixels 4/5
5796	.de87	20 98 de	jsr $de98	                jsr get2Pixels
5797	.de8a	b1 e0		lda ($e0),y	                lda (ZTEMPD),y               ;get pixels 6/7
5798	.de8c	20 98 de	jsr $de98	                jsr get2Pixels
5799	.de8f					LDE8F:
5800	.de8f	a5 df		lda $df		                lda ZTEMPC+1
5801	.de91					next:
5802	.de91	99 28 03	sta $0328,y	                sta vduv.workspace._28,y
5803	.de94	88		dey		                dey
5804	.de95	10 c8		bpl $de5f	                bpl loop
5805	.de97	60		rts		                rts

5807	.de98					get2Pixels:
5808	.de98	4d 58 03	eor $0358	                eor vduv.backgroundTextColour ;reset background pixel bits
5809	.de9b	20 b5 de	jsr $deb5	                jsr or2Pixels
5810	.de9e	29 03		and #$03	                and #%00000011               ;2 pixels/byte
5811	.dea0	80 0c		bra $deae	                bra shiftIn2

5813	.dea2					get4Pixels:
5814	.dea2	4d 58 03	eor $0358	                eor vduv.backgroundTextColour ;
5815	.dea5	20 ba de	jsr $deba	                jsr or4Pixels
5816	.dea8	29 0f		and #$0f	                and #%00001111               ;4 pixels/byte

5818						                ; Build up the 1bpp char row in ZTEMPC?1, 2 or 4 bits
5819						                ; at a time.
5820	.deaa	06 df		asl $df		                asl ZTEMPC+1
5821	.deac	06 df		asl $df		                asl ZTEMPC+1
5822	.deae					shiftIn2:
5823	.deae	06 df		asl $df		                asl ZTEMPC+1
5824	.deb0	06 df		asl $df		                asl ZTEMPC+1
5825	.deb2	04 df		tsb $df		                tsb ZTEMPC+1
5826	.deb4	60		rts		                rts

5828						                ; OR together all the N bits for each pixel, making a
5829						                ; byte in which the bottom N bits have a bit set for
5830						                ; each non-0 pixel in the byte.
5831	.deb5					or2Pixels:
5832	.deb5	85 de		sta $de		                sta ZTEMPC+0
5833	.deb7	20 be de	jsr $debe	                jsr shiftOut2
5834	.deba					or4Pixels:
5835	.deba	85 de		sta $de		                sta ZTEMPC+0                 ;%abcdABCD
5836	.debc	4a		lsr a		                lsr a                        ;%0abcdABC
5837	.debd	4a		lsr a		                lsr a                        ;%00abcdAB
5838	.debe					shiftOut2:
5839	.debe	4a		lsr a		                lsr a                        ;%000abcdA
5840	.debf	4a		lsr a		                lsr a                        ;%0000abcd
5841	.dec0	05 de		ora $de		                ora ZTEMPC+0                 ;%0000abcd|%abcdABCD
5842						                .endproc
5843	.dec2					rtsDEC2:
5844	.dec2	60		rts		                rts

5846						;-------------------------------------------------------------------------
5847						;
5848						; Do WIND. If point not in window, return with Z=0. Otherwise, call
5849						; GADDR and return with Z=1.
5850						;
5851	.dec3					windGADDR:
5852	.dec3	20 a8 d1	jsr $d1a8	                jsr windEntryPoint
5853	.dec6	d0 fa		bne $dec2	                bne rtsDEC2                  ;taken if point outside window
5854	.dec8					gaddrEntryPoint:
5855	.dec8	bd 02 03	lda $0302,x	                lda vduv+2,x                 ;get Y coordinate
5856	.decb					LDECB:
5857	.decb	49 ff		eor #$ff	                eor #$FF                     ;invert Y coordinate
5858	.decd	a8		tay		                tay                          ;Y=Y coordinate
5859	.dece	29 07		and #$07	                and #$07                ;get scanline in character row
5860	.ded0	85 da		sta $da		                sta ZTEMP+0             ;save scanline
5861	.ded2	98		tya		                tya                          ;A=Y coordinate
5862	.ded3	29 f8		and #$f8	                and #$F8                     ;row*8
5863	.ded5	4a		lsr a		                lsr a                        ;row*4
5864	.ded6	85 d7		sta $d7		                sta ZMEMG+1                  ;>(row*1024)
5865	.ded8	4a		lsr a		                lsr a                        ;>(row*512)
5866	.ded9	4a		lsr a		                lsr a                        ;>(row*256)
5867	.deda	65 d7		adc $d7		                adc ZMEMG+1                  ;>(row*1280)
5868	.dedc	4a		lsr a		                lsr a                        ;>(row*640)
5869	.dedd	85 d7		sta $d7		                sta ZMEMG+1                  ;
5870	.dedf	a9 00		lda #$00	                lda #$00                     ;
5871	.dee1	6a		ror a		                ror a                        ;<(row*640) - $00/$80
5872	.dee2	ac 56 03	ldy $0356	                ldy vduv.currentScreenMODEGroup
5873	.dee5	f0 03		beq $deea	                beq +                      ;taken if 640 bytes per row
5874	.dee7	46 d7		lsr $d7		                lsr ZMEMG+1                ;>(row*320)
5875	.dee9	6a		ror a		                ror a                    ;<(row*320) - $00/$40/$80/$c0
5876	.deea					+
5877	.deea	05 da		ora $da		                ora ZTEMP+0               ;include the scanline offset
5878	.deec	6d 50 03	adc $0350	                adc vduv.screenTopLeftAddress+0 ;include LSB of screen base
5879	.deef	8d 1a 03	sta $031a	                sta vduv.graphicsAddressOffset

5881						                ; add MSB of screen base to ZMEMG+1
5882	.def2	a5 d7		lda $d7		                lda ZMEMG+1
5883	.def4	6d 51 03	adc $0351	                adc vduv.screenTopLeftAddress+1
5884	.def7	85 d7		sta $d7		                sta ZMEMG+1

5886	.def9	bd 01 03	lda $0301,x	                lda vduv+1,x                 ;get >X
5887	.defc	85 d6		sta $d6		                sta ZMEMG+0                  ;save >X
5888	.defe	bd 00 03	lda $0300,x	                lda vduv+0,x                 ;get <X
5889	.df01	2d 61 03	and $0361	                and vduv.pixelsPerByteMinusOne ;index for pixel
5890	.df04	6d 61 03	adc $0361	                adc vduv.pixelsPerByteMinusOne ;offset into pixel mask table
5891	.df07	a8		tay		                tay
5892	.df08	b9 3e e1	lda $e13e,y	                lda pixelMasks-1,y
5893	.df0b	85 d1		sta $d1		                sta ZMASK

5895						                ; Form 16-bit column address offset (LSB in A, MSB in
5896						                ; ZMEMG+0), assuming 8 bits/pixel. No adjustment
5897						                ; needed if MODE 0/4, but scale up by 2 if MODE 1/5 or
5898						                ; 4 if MODE 2.

5900	.df0d	bd 00 03	lda $0300,x	                lda vduv+0,x                 ;A = <X
5901	.df10	ac 61 03	ldy $0361	                ldy vduv.pixelsPerByteMinusOne
5902	.df13	c0 03		cpy #$03	                cpy #$03
5903	.df15	f0 05		beq $df1c	                beq LDF1C         ;taken if 4 px/byte - i.e., MODE 1/5
5904	.df17	b0 06		bcs $df1f	                bcs LDF1F        ;taken if >4 px/byte - i.e., MODE 0/4
5905	.df19	0a		asl a		                asl a
5906	.df1a	26 d6		rol $d6		                rol ZMEMG+0
5907	.df1c					LDF1C:
5908	.df1c	0a		asl a		                asl a
5909	.df1d	26 d6		rol $d6		                rol ZMEMG+0
5910	.df1f					LDF1F:
5911	.df1f	29 f8		and #$f8	                and #$F8                     ;<column offset
5912	.df21	18		clc		                clc
5913	.df22	6d 1a 03	adc $031a	                adc vduv.graphicsAddressOffset
5914	.df25	8d 1a 03	sta $031a	                sta vduv.graphicsAddressOffset
5915	.df28	a5 d6		lda $d6		                lda ZMEMG+0                  ;>column offset
5916	.df2a	65 d7		adc $d7		                adc ZMEMG+1                  ;add to address MSB
5917	.df2c	10 04		bpl $df32	                bpl +                        ;taken if no wrap
5918	.df2e	38		sec		                sec
5919	.df2f	ed 54 03	sbc $0354	                sbc vduv.screenSizeHighByte ;handle wrap at end of screen
5920	.df32					+
5921	.df32	85 d7		sta $d7		                sta ZMEMG+1                  ;got MSB
5922	.df34	64 d6		stz $d6		                stz ZMEMG+0 ;LSB always 0 - the offset takes care of this
5923	.df36	a6 da		ldx $da		                ldx ZTEMP+0 ;get scanline in row
5924	.df38	20 7c da	jsr $da7c	                jsr setupColourMasks
5925	.df3b	ac 1a 03	ldy $031a	                ldy vduv.graphicsAddressOffset
5926	.df3e					ldaim00_rts_DF3E:
5927	.df3e	a9 00		lda #$00	                lda #$00                     ;return with Z=1, as per WIND
5928	.df40	60		rts		                rts

5930						;-------------------------------------------------------------------------

5932	.df41					LDF41:
5933	.df41	20 c8 de	jsr $dec8	                jsr gaddrEntryPoint
5934	.df44	da		phx		                phx
5935	.df45	a2 00		ldx #$00	                ldx #$00
5936	.df47	ad 5a 03	lda $035a	                lda $035A
5937	.df4a	c9 04		cmp #$04	                cmp #$04
5938	.df4c	b0 0b		bcs $df59	                bcs LDF59
5939	.df4e	ae 6a 03	ldx $036a	                ldx $036A
5940	.df51	ad 59 03	lda $0359	                lda $0359
5941	.df54	f0 03		beq $df59	                beq LDF59
5942	.df56	ae 6b 03	ldx $036b	                ldx $036B
5943	.df59					LDF59:
5944	.df59	8e 69 03	stx $0369	                stx $0369
5945	.df5c	fa		plx		                plx
5946	.df5d	60		rts		                rts

5948						;-------------------------------------------------------------------------

5950	.df5e					handleCopyKey:
5951	.df5e	a9 20		lda #$20	                lda #STATE.isVDU5
5952	.df60	24 d0		bit $d0		                bit STATE
5953	.df62	50 da		bvc $df3e	                bvc ldaim00_rts_DF3E      ;taken if not cursor editing
5954	.df64	d0 d8		bne $df3e	                bne ldaim00_rts_DF3E      ;taken if VDU5
5955						                .if version==350&&!finmos329
5957						                .elsif (version<511||autocue)&&!finmos329
5958	.df66	20 f8 dd	jsr $ddf8	                jsr readCharacterAtTextCursor
5963						                .endif
5964	.df69	f0 0c		beq $df77	                beq rtsDF77              ;taken if char not recognised
5965	.df6b	48		pha		                pha                      ;save char recognised
5966	.df6c	20 d5 df	jsr $dfd5	                jsr isCursorEditingPossible
5967	.df6f	d0 05		bne $df76	                bne pla_rts_DF76
5968	.df71	a9 09		lda #$09	                lda #$09
5969	.df73	20 bc df	jsr $dfbc	                jsr moveEditCursor
5970	.df76					pla_rts_DF76:
5971	.df76	68		pla		                pla
5972	.df77					rtsDF77:
5973	.df77	60		rts		                rts

5975						;-------------------------------------------------------------------------
5976						;
5977						; Handle cursor key press.
5978						;
5979						; Entry: A = one of the cursor key codes:
5980						;            $88 = left
5981						;            $89 = right
5982						;            $8a = down
5983						;            $8b = up

5985	.df78					handleCursorKey:
5986	.df78	48		pha		                pha                          ;save cursor key code
5987	.df79	20 d5 df	jsr $dfd5	                jsr isCursorEditingPossible
5988	.df7c	d0 f8		bne $df76	                bne pla_rts_DF76             ;bail if editing not possible
5989	.df7e	70 16		bvs $df96	                bvs editing                  ;taken if already editing
5990	.df80					beginEditing:
5991	.df80	ad 5f 03	lda $035f	                lda vduv.lastCursorStartRegisterValue
5992	.df83	29 df		and #$df	                and #%11011111
5993	.df85	20 53 cf	jsr $cf53	                jsr setCRTCRegister10        ;hide cursor
5994	.df88	a2 18		ldx #$18	                ldx #VDUVariables.textCursorXPosition
5995	.df8a	a0 64		ldy #$64	                ldy #VDUVariables.editCursorXPosition
5996	.df8c	20 0c c9	jsr $c90c	                jsr copyTwoBytesWithinVDUVariables ;edit cursor pos =
5997						                                                   ;text cursor pos
5998	.df8f	20 05 c1	jsr $c105	                jsr activateEditCursor
5999	.df92	a9 02		lda #$02	                lda #STATE.isScrollingDisabled
6000	.df94	04 d0		tsb $d0		                tsb STATE
6001	.df96					editing:
6002	.df96	68		pla		                pla                          ;restore cursor key code

6004						                ; Form appropriate VDU command (8/9/10/11) for the
6005						                ; key, assuming no VDU axis rearrangement.
6006	.df97	29 7f		and #$7f	                and #$7F
6007	.df99	85 da		sta $da		                sta ZTEMP                    ;save VDU command

6009						                ; Adjust VDU command based on axis swap/inversion.
6010	.df9b	c9 0a		cmp #$0a	                cmp #$0A
6011	.df9d	b0 0e		bcs $dfad	                bcs handleCursorUpOrDown     ;taken if up/down
6012	.df9f					handleCursorLeftOrRightOrCopy:
6013	.df9f	ad 66 03	lda $0366	                lda vduv.cursorFlags
6014	.dfa2	4a		lsr a		                lsr a
6015	.dfa3	29 05		and #$05	                and #(vduv.cursorFlags.swapAxes|vduv.cursorFlags.invertHorizontal)>>1
6016	.dfa5	89 04		bit #$04	                bit #vduv.cursorFlags.swapAxes>>1
6017	.dfa7	f0 11		beq $dfba	                beq gotActualMoveCommand

6019	.dfa9	49 07		eor #$07	                eor #(vduv.cursorFlags.swapAxes|vduv.cursorFlags.invertVertical|vduv.cursorFlags.invertHorizontal)>>1
6020	.dfab	80 0d		bra $dfba	                bra gotActualMoveCommand

6022	.dfad					handleCursorUpOrDown:
6023	.dfad	ad 66 03	lda $0366	                lda vduv.cursorFlags
6024	.dfb0	4a		lsr a		                lsr a
6025	.dfb1	4a		lsr a		                lsr a
6026	.dfb2	29 03		and #$03	                and #(vduv.cursorFlags.swapAxes|vduv.cursorFlags.invertVertical)>>2 ;000000SV
6027	.dfb4	89 02		bit #$02	                bit #vduv.cursorFlags.swapAxes>>2
6028	.dfb6	f0 02		beq $dfba	                beq gotActualMoveCommand

6030	.dfb8	49 01		eor #$01	                eor #vduv.cursorFlags.invertVertical>>2
6031	.dfba					gotActualMoveCommand:
6032	.dfba	45 da		eor $da		                eor ZTEMP
6033	.dfbc					moveEditCursor:
6034	.dfbc	a8		tay		                tay                          ;save command
6035	.dfbd	a9 40		lda #$40	                lda #STATE.isCursorEditing
6036	.dfbf	14 d0		trb $d0		                trb STATE            ;temporarily disable edit mode
6037	.dfc1	98		tya		                tya                  ;restore command
6038	.dfc2	ae 6c 03	ldx $036c	                ldx vduv.column81
6039	.dfc5	da		phx		                phx                  ;save old column 81 flag
6040	.dfc6	4e 6c 03	lsr $036c	                lsr vduv.column81    ;temporarily reset column 81 flag
6041	.dfc9	20 27 c0	jsr $c027	                jsr outputToVDU      ;print the cursor movement command
6042	.dfcc	68		pla		                pla
6043	.dfcd	8d 6c 03	sta $036c	                sta vduv.column81            ;restore column 81 flag
6044	.dfd0	a9 40		lda #$40	                lda #STATE.isCursorEditing
6045	.dfd2	04 d0		tsb $d0		                tsb STATE                    ;reinstate edit mode
6046	.dfd4	60		rts		                rts

6048						; Check if cursor editing is possible.
6049						;
6050						; Exit: Z=1 - editing is possible
6051						;             V reflects current STATE.isCursorEditing bit
6052						;       Z=0 - editing not possible
6053	.dfd5					isCursorEditingPossible:
6054	.dfd5	ae 6a 02	ldx $026a	                ldx vduQueueNegativeLength
6055	.dfd8	d0 04		bne $dfde	                bne +                        ;return with Z=0 if VDU
6056						                                             ;queue not empty
6057	.dfda	a9 a0		lda #$a0	                lda #STATE.isVDU21|STATE.isVDU5
6058	.dfdc	24 d0		bit $d0		                bit STATE   ;return with Z=0 if neither VDU21 nor VDU5
6059	.dfde					+
6060	.dfde	60		rts		                rts

6062						;-------------------------------------------------------------------------
6063						;
6064						; 184<80><93>191 = Move/copy rectangle [MasRef E.3-31]
6065						;
6066						                .if version!=400
6067	.dfdf					plotMoveOrCopyRectangle:
6068	.dfdf	a2 8f		ldx #$8f	                ldx #$80|extROM   ; select VIEW+ANDY
6069	.dfe1	20 9a e5	jsr $e59a	                jsr selectROMX
6070	.dfe4	20 a6 b3	jsr $b3a6	                jsr ext.plotMoveOrCopyRectangle
6071	.dfe7	80 08		bra $dff1	                bra LDFF1
6072						                .endif

6074						;-------------------------------------------------------------------------
6075						;
6076						; 192<80><93>199 = Plot ellipse outline [MasRef E.3-32]
6077						;
6078						                .if version!=400
6079	.dfe9					plotEllipseOutline:
6080	.dfe9	a2 8f		ldx #$8f	                ldx #$80|extROM
6081	.dfeb	20 9a e5	jsr $e59a	                jsr selectROMX
6082	.dfee	20 cc ae	jsr $aecc	                jsr ext.plotEllipseOutline
6083	.dff1					LDFF1:
6084	.dff1	4c 98 e5	jmp $e598	                jmp selectTerminalROMAndANDY
6085						                .endif

6087						;-------------------------------------------------------------------------
6088						;
6089						; 200<80><93>207 = Plot solid ellipse [MasRef E.3-32]
6090						;
6091						                .if version!=400
6092	.dff4					plotSolidEllipse:
6093	.dff4	a2 8f		ldx #$8f	                ldx #$80|extROM
6094	.dff6	20 9a e5	jsr $e59a	                jsr selectROMX
6095	.dff9	20 4f af	jsr $af4f	                jsr ext.plotSolidEllipse
6096	.dffc	80 f3		bra $dff1	                bra LDFF1
6097						                .endif

6099						                .if version==400
6101						                .endif

6103						;-------------------------------------------------------------------------

6105						; Pretty sure I have the logic for this all wrong...

6107						                .if !finmos329
6108	>dffe					                .align 16
6109						                .endif
6110	.e000					startupMessages: .block
6111						                .if version==500||version==510||autocue
6112	>e000	00 00 00 00 00 00 00 00		                .fill 16,0
	>e008	00 00 00 00 00 00 00 00
6113						                .endif

6115						                .if version>=511&&!autocue
6117						                .endif
6118	.e010					acornMOS:
6119	>e010	0d				                .text 13
6120						                .if olivetti
6130						                .else
6131	>e011	41 63 6f 72 6e 20 4d 4f		                .text "Acorn MOS"
	>e019	53
6132						                .endif
6133						                .if version==400||version==350
6135						                .endif
6136	>e01a	00				                .byte 0
6137	.e01b					beep:
6138	>e01b	07				                .byte 7
6139	>e01c	00				                .byte 0
6140						                .if version!=400&&version!=350
6141	>e01d	00 00 00			                .byte 0,0,0   ;space for "xxK"
6142						                .endif

6144	.e020					twoNewlines:
6145	>e020	08				                .byte 8
6146	>e021	0d				                .byte $0D
6147	>e022	0d				                .byte $0D
6148						                ; terminating 0 comes from following table!
6149						                .cerror *!=LE013,"startupMessages needs a terminating 0"
6150						                .endblock
6151	.e023					LE013:
6152	>e023	00				                .byte %00000000;$00
6153	>e024	11				                .byte %00010001;$11
6154	>e025	22				                .byte %00100010;$22
6155	>e026	33				                .byte %00110011;$33
6156	>e027	44				                .byte %01000100;$44
6157	>e028	55				                .byte %01010101;$55
6158	>e029	66				                .byte %01100110;$66
6159	>e02a	77				                .byte %01110111;$77
6160	>e02b	88				                .byte %10001000;$88
6161	>e02c	99				                .byte %10011001;$99
6162	>e02d	aa				                .byte %10101010;$AA
6163	>e02e	bb				                .byte %10111011;$BB
6164	>e02f	cc				                .byte %11001100;$CC
6165	>e030	dd				                .byte %11011101;$DD
6166	>e031	ee				                .byte %11101110;$EE
6167	>e032	ff				                .byte %11111111;$FF
6168	.e033					LE023:
6169	>e033	00				                .byte %00000000;$00
6170	>e034	55				                .byte %01010101;$55
6171	>e035	aa				                .byte %10101010;$AA
6172	>e036	ff				                .byte %11111111;$FF

6174						; VDU control code dispatch tables
6175						; ================================
6176						;
6177						; entry:
6178						;
6179						;

6181						; each routine is (address, number of additional VDU bytes)
6182	=[($c035,0)]				_:=[(vdu0EntryPoint,0)] ; VDU0
6183	=[($c035,0),($c0e2,1)]			_..=[(vdu1EntryPoint,1)] ; VDU1
6184	=[($c035,0),($c0e2,1),($c0ea,0)]	_..=[(vdu2EntryPoint,0)] ; VDU2
6185	=[($c035,0),($c0e2,1),($c0ea,0),($c0ea,0)]
						_..=[(vdu3EntryPoint,0)] ; VDU3
6186	=[($c035,0),($c0e2,1),($c0ea,0),($c0ea,0),($c51e,0)]
						_..=[(vdu4EntryPoint,0)] ; VDU4
6187	=[($c035,0),($c0e2,1),($c0ea,0),($c0ea,0),($c51e,0),($c52d,0)]
						_..=[(vdu5EntryPoint,0)] ; VDU5
6188	=[($c035,0),($c0e2,1),($c0ea,0),($c0ea,0),($c51e,0),($c52d,0),($c035,0)]
						_..=[(vdu6EntryPoint,0)] ; VDU6
6189	=[($c035,0),($c0e2,1),($c0ea,0),($c0ea,0),($c51e,0),($c52d,0),($c035,0),($f05f,0)]
						_..=[(vdu7EntryPoint,0)] ; VDU7
6190	=[($c035,0),($c0e2,1),($c0ea,0),($c0ea,0),($c51e,0),($c52d,0),($c035,0),($f05f,0),($c29a,0)]
						_..=[(vdu8EntryPoint,0)] ; VDU8
6191	=[($c035,0),($c0e2,1),($c0ea,0),($c0ea,0),($c51e,0),($c52d,0),($c035,0),($f05f,0),($c29a,0),($c24c,0)]
						_..=[(vdu9EntryPoint,0)] ; VDU9
6192	=[($c035,0),($c0e2,1),($c0ea,0),($c0ea,0),($c51e,0),($c52d,0),($c035,0),($f05f,0),($c29a,0),($c24c,0),($c25b,0)]
						_..=[(vdu10EntryPoint,0)] ; VDU10
6193	=[($c035,0),($c0e2,1),($c0ea,0),($c0ea,0),($c51e,0),($c52d,0),($c035,0),($f05f,0),($c29a,0),($c24c,0),($c25b,0),($c2b1,0)]
						_..=[(vdu11EntryPoint,0)] ; VDU11
6194	=[($c035,0),($c0e2,1),($c0ea,0),($c0ea,0),($c51e,0),($c52d,0),($c035,0),($f05f,0),($c29a,0),($c24c,0),($c25b,0),($c2b1,0),($c44f,0)]
						_..=[(vdu12EntryPoint,0)] ; VDU12
6195	=[($c035,0),($c0e2,1),($c0ea,0),($c0ea,0),($c51e,0),($c52d,0),($c035,0),($f05f,0),($c29a,0),($c24c,0),($c25b,0),($c2b1,0),($c44f,0),($c3f6,0)]
						_..=[(vdu13EntryPoint,0)] ; VDU13
6196	=[($c035,0),($c0e2,1),($c0ea,0),($c0ea,0),($c51e,0),($c52d,0),($c035,0),($f05f,0),($c29a,0),($c24c,0),($c25b,0),($c2b1,0),($c44f,0),($c3f6,0),($c514,0)]
						_..=[(vdu14EntryPoint,0)] ; VDU14
6197	=[($c035,0),($c0e2,1),($c0ea,0),($c0ea,0),($c51e,0),($c52d,0),($c035,0),($f05f,0),($c29a,0),($c24c,0),($c25b,0),($c2b1,0),($c44f,0),($c3f6,0),($c514,0),($c528,0)]
						_..=[(vdu15EntryPoint,0)] ; VDU15
6198	=[($c035,0),($c0e2,1),($c0ea,0),($c0ea,0),($c51e,0),($c52d,0),($c035,0),($f05f,0),($c29a,0),($c24c,0),($c25b,0),($c2b1,0),($c44f,0),($c3f6,0),($c514,0),($c528,0),($c413,0)]
						_..=[(vdu16EntryPoint,0)] ; VDU16
6199	=[($c035,0),($c0e2,1),($c0ea,0),($c0ea,0),($c51e,0),($c52d,0),($c035,0),($f05f,0),($c29a,0),($c24c,0),($c25b,0),($c2b1,0),($c44f,0),($c3f6,0),($c514,0),($c528,0),($c413,0),($c539,1)]
						_..=[(vdu17EntryPoint,1)] ; VDU17
6200	=[($c035,0),($c0e2,1),($c0ea,0),($c0ea,0),($c51e,0),($c52d,0),($c035,0),($f05f,0),($c29a,0),($c24c,0),($c25b,0),($c2b1,0),($c44f,0),($c3f6,0),($c514,0),($c528,0),($c413,0),($c539,1),($c564,2)]
						_..=[(vdu18EntryPoint,2)] ; VDU18
6201	=[($c035,0),($c0e2,1),($c0ea,0),($c0ea,0),($c51e,0),($c52d,0),($c035,0),($f05f,0),($c29a,0),($c24c,0),($c25b,0),($c2b1,0),($c44f,0),($c3f6,0),($c514,0),($c528,0),($c413,0),($c539,1),($c564,2),($c62d,5)]
						_..=[(vdu19EntryPoint,5)] ; VDU19
6202	=[($c035,0),($c0e2,1),($c0ea,0),($c0ea,0),($c51e,0),($c52d,0),($c035,0),($f05f,0),($c29a,0),($c24c,0),($c25b,0),($c2b1,0),($c44f,0),($c3f6,0),($c514,0),($c528,0),($c413,0),($c539,1),($c564,2),($c62d,5),($c5c5,0)]
						_..=[(vdu20EntryPoint,0)] ; VDU20
6203	=[($c035,0),($c0e2,1),($c0ea,0),($c0ea,0),($c51e,0),($c52d,0),($c035,0),($f05f,0),($c29a,0),($c24c,0),($c25b,0),($c2b1,0),($c44f,0),($c3f6,0),($c514,0),($c528,0),($c413,0),($c539,1),($c564,2),($c62d,5),($c5c5,0),($c519,0)]
						_..=[(vdu21EntryPoint,0)] ; VDU21
6204	=[($c035,0),($c0e2,1),($c0ea,0),($c0ea,0),($c51e,0),($c52d,0),($c035,0),($f05f,0),($c29a,0),($c24c,0),($c25b,0),($c2b1,0),($c44f,0),($c3f6,0),($c514,0),($c528,0),($c413,0),($c539,1),($c564,2),($c62d,5),($c5c5,0),($c519,0),($c794,1)]
						_..=[(vdu22EntryPoint,1)] ; VDU22
6205	=[($c035,0),($c0e2,1),($c0ea,0),($c0ea,0),($c51e,0),($c52d,0),($c035,0),($f05f,0),($c29a,0),($c24c,0),($c25b,0),($c2b1,0),($c44f,0),($c3f6,0),($c514,0),($c528,0),($c413,0),($c539,1),($c564,2),($c62d,5),($c5c5,0),($c519,0),($c794,1),($c67c,9)]
						_..=[(vdu23EntryPoint,9)] ; VDU23
6206	=[($c035,0),($c0e2,1),($c0ea,0),($c0ea,0),($c51e,0),($c52d,0),($c035,0),($f05f,0),($c29a,0),($c24c,0),($c25b,0),($c2b1,0),($c44f,0),($c3f6,0),($c514,0),($c528,0),($c413,0),($c539,1),($c564,2),($c62d,5),($c5c5,0),($c519,0),($c794,1),($c67c,9),($c71f,8)]
						_..=[(vdu24EntryPoint,8)] ; VDU24
6207	=[($c035,0),($c0e2,1),($c0ea,0),($c0ea,0),($c51e,0),($c52d,0),($c035,0),($f05f,0),($c29a,0),($c24c,0),($c25b,0),($c2b1,0),($c44f,0),($c3f6,0),($c514,0),($c528,0),($c413,0),($c539,1),($c564,2),($c62d,5),($c5c5,0),($c519,0),($c794,1),($c67c,9),($c71f,8),($c69b,5)]
						_..=[(vdu25EntryPoint,5)] ; VDU25
6208	=[($c035,0),($c0e2,1),($c0ea,0),($c0ea,0),($c51e,0),($c52d,0),($c035,0),($f05f,0),($c29a,0),($c24c,0),($c25b,0),($c2b1,0),($c44f,0),($c3f6,0),($c514,0),($c528,0),($c413,0),($c539,1),($c564,2),($c62d,5),($c5c5,0),($c519,0),($c794,1),($c67c,9),($c71f,8),($c69b,5),($c6aa,0)]
						_..=[(vdu26EntryPoint,0)] ; VDU26
6209	=[($c035,0),($c0e2,1),($c0ea,0),($c0ea,0),($c51e,0),($c52d,0),($c035,0),($f05f,0),($c29a,0),($c24c,0),($c25b,0),($c2b1,0),($c44f,0),($c3f6,0),($c514,0),($c528,0),($c413,0),($c539,1),($c564,2),($c62d,5),($c5c5,0),($c519,0),($c794,1),($c67c,9),($c71f,8),($c69b,5),($c6aa,0),($c035,0)]
						_..=[(vdu27EntryPoint,0)] ; VDU27
6210	=[($c035,0),($c0e2,1),($c0ea,0),($c0ea,0),($c51e,0),($c52d,0),($c035,0),($f05f,0),($c29a,0),($c24c,0),($c25b,0),($c2b1,0),($c44f,0),($c3f6,0),($c514,0),($c528,0),($c413,0),($c539,1),($c564,2),($c62d,5),($c5c5,0),($c519,0),($c794,1),($c67c,9),($c71f,8),($c69b,5),($c6aa,0),($c035,0),($c3a5,4)]
						_..=[(vdu28EntryPoint,4)] ; VDU28
6211	=[($c035,0),($c0e2,1),($c0ea,0),($c0ea,0),($c51e,0),($c52d,0),($c035,0),($f05f,0),($c29a,0),($c24c,0),($c25b,0),($c2b1,0),($c44f,0),($c3f6,0),($c514,0),($c528,0),($c413,0),($c539,1),($c564,2),($c62d,5),($c5c5,0),($c519,0),($c794,1),($c67c,9),($c71f,8),($c69b,5),($c6aa,0),($c035,0),($c3a5,4),($c78a,4)]
						_..=[(vdu29EntryPoint,4)] ; VDU29
6212	=[($c035,0),($c0e2,1),($c0ea,0),($c0ea,0),($c51e,0),($c52d,0),($c035,0),($f05f,0),($c29a,0),($c24c,0),($c25b,0),($c2b1,0),($c44f,0),($c3f6,0),($c514,0),($c528,0),($c413,0),($c539,1),($c564,2),($c62d,5),($c5c5,0),($c519,0),($c794,1),($c67c,9),($c71f,8),($c69b,5),($c6aa,0),($c035,0),($c3a5,4),($c78a,4),($c47c,0)]
						_..=[(vdu30EntryPoint,0)] ; VDU30
6213	=[($c035,0),($c0e2,1),($c0ea,0),($c0ea,0),($c51e,0),($c52d,0),($c035,0),($f05f,0),($c29a,0),($c24c,0),($c25b,0),($c2b1,0),($c44f,0),($c3f6,0),($c514,0),($c528,0),($c413,0),($c539,1),($c564,2),($c62d,5),($c5c5,0),($c519,0),($c794,1),($c67c,9),($c71f,8),($c69b,5),($c6aa,0),($c035,0),($c3a5,4),($c78a,4),($c47c,0),($c482,2)]
						_..=[(vdu31EntryPoint,2)] ; VDU31
6214	=[($c035,0),($c0e2,1),($c0ea,0),($c0ea,0),($c51e,0),($c52d,0),($c035,0),($f05f,0),($c29a,0),($c24c,0),($c25b,0),($c2b1,0),($c44f,0),($c3f6,0),($c514,0),($c528,0),($c413,0),($c539,1),($c564,2),($c62d,5),($c5c5,0),($c519,0),($c794,1),($c67c,9),($c71f,8),($c69b,5),($c6aa,0),($c035,0),($c3a5,4),($c78a,4),($c47c,0),($c482,2),($ce2d,0)]
						_..=[(vdu127EntryPoint,0)] ; VDU127
6215	=[($c035,0),($c0e2,1),($c0ea,0),($c0ea,0),($c51e,0),($c52d,0),($c035,0),($f05f,0),($c29a,0),($c24c,0),($c25b,0),($c2b1,0),($c44f,0),($c3f6,0),($c514,0),($c528,0),($c413,0),($c539,1),($c564,2),($c62d,5),($c5c5,0),($c519,0),($c794,1),($c67c,9),($c71f,8),($c69b,5),($c6aa,0),($c035,0),($c3a5,4),($c78a,4),($c47c,0),($c482,2),($ce2d,0)]
						vdu_routines=_

6217						; LSB of routine address
6218	.e037					vduRoutinesLSBTable:
6219						                .for i=0,i<len(vdu_routines),i+=1
6220	>e037	35				                .byte <vdu_routines[i][0]
6220	>e038	e2				                .byte <vdu_routines[i][0]
6220	>e039	ea				                .byte <vdu_routines[i][0]
6220	>e03a	ea				                .byte <vdu_routines[i][0]
6220	>e03b	1e				                .byte <vdu_routines[i][0]
6220	>e03c	2d				                .byte <vdu_routines[i][0]
6220	>e03d	35				                .byte <vdu_routines[i][0]
6220	>e03e	5f				                .byte <vdu_routines[i][0]
6220	>e03f	9a				                .byte <vdu_routines[i][0]
6220	>e040	4c				                .byte <vdu_routines[i][0]
6220	>e041	5b				                .byte <vdu_routines[i][0]
6220	>e042	b1				                .byte <vdu_routines[i][0]
6220	>e043	4f				                .byte <vdu_routines[i][0]
6220	>e044	f6				                .byte <vdu_routines[i][0]
6220	>e045	14				                .byte <vdu_routines[i][0]
6220	>e046	28				                .byte <vdu_routines[i][0]
6220	>e047	13				                .byte <vdu_routines[i][0]
6220	>e048	39				                .byte <vdu_routines[i][0]
6220	>e049	64				                .byte <vdu_routines[i][0]
6220	>e04a	2d				                .byte <vdu_routines[i][0]
6220	>e04b	c5				                .byte <vdu_routines[i][0]
6220	>e04c	19				                .byte <vdu_routines[i][0]
6220	>e04d	94				                .byte <vdu_routines[i][0]
6220	>e04e	7c				                .byte <vdu_routines[i][0]
6220	>e04f	1f				                .byte <vdu_routines[i][0]
6220	>e050	9b				                .byte <vdu_routines[i][0]
6220	>e051	aa				                .byte <vdu_routines[i][0]
6220	>e052	35				                .byte <vdu_routines[i][0]
6220	>e053	a5				                .byte <vdu_routines[i][0]
6220	>e054	8a				                .byte <vdu_routines[i][0]
6220	>e055	7c				                .byte <vdu_routines[i][0]
6220	>e056	82				                .byte <vdu_routines[i][0]
6220	>e057	2d				                .byte <vdu_routines[i][0]
6221						                .next

6223						; If bit 7 set: MSB of routine address
6224						;
6225						; If bit 7 clear:
6226						;
6227						; Top 4 bits are bits 8-11 of routine address (bits 12-15 are %1010,
6228						; so address is $C0xx to $C7xx)
6229						;
6230						; Bottom 4 bits are ORed with $f0 and stored in $26a - -ve bytes left
6231						; in VDU queue.
6232	.e058					vduRoutinesMSBTable:
6233						                .for i=0,i<len(vdu_routines),i+=1
6234						                .if vdu_routines[i][1]==0
6235	>e058	c0				                .byte >vdu_routines[i][0]
6240						                .endif
6234						                .if vdu_routines[i][1]==0
6236						                .else
6237						                .cerror vdu_routines[i][0]<(vduRoutinesPage<<8) || vdu_routines[i][0]>(vduRoutinesPage<<8)+$7ff,format("illegal VDU routine address for VDU %d: $%04x",i,vdu_routines[i][0])
6238						                .cerror vdu_routines[i][1]<0 || vdu_routines[i][1]>15,format("illegal VDU parameter count for VDU %d: %d",i,vdu_routines[i][1])
6239	>e059	0f				                .byte (16-vdu_routines[i][1])|(((>vdu_routines[i][0])&$0f)<<4)
6240						                .endif
6234						                .if vdu_routines[i][1]==0
6235	>e05a	c0				                .byte >vdu_routines[i][0]
6240						                .endif
6234						                .if vdu_routines[i][1]==0
6235	>e05b	c0				                .byte >vdu_routines[i][0]
6240						                .endif
6234						                .if vdu_routines[i][1]==0
6235	>e05c	c5				                .byte >vdu_routines[i][0]
6240						                .endif
6234						                .if vdu_routines[i][1]==0
6235	>e05d	c5				                .byte >vdu_routines[i][0]
6240						                .endif
6234						                .if vdu_routines[i][1]==0
6235	>e05e	c0				                .byte >vdu_routines[i][0]
6240						                .endif
6234						                .if vdu_routines[i][1]==0
6235	>e05f	f0				                .byte >vdu_routines[i][0]
6240						                .endif
6234						                .if vdu_routines[i][1]==0
6235	>e060	c2				                .byte >vdu_routines[i][0]
6240						                .endif
6234						                .if vdu_routines[i][1]==0
6235	>e061	c2				                .byte >vdu_routines[i][0]
6240						                .endif
6234						                .if vdu_routines[i][1]==0
6235	>e062	c2				                .byte >vdu_routines[i][0]
6240						                .endif
6234						                .if vdu_routines[i][1]==0
6235	>e063	c2				                .byte >vdu_routines[i][0]
6240						                .endif
6234						                .if vdu_routines[i][1]==0
6235	>e064	c4				                .byte >vdu_routines[i][0]
6240						                .endif
6234						                .if vdu_routines[i][1]==0
6235	>e065	c3				                .byte >vdu_routines[i][0]
6240						                .endif
6234						                .if vdu_routines[i][1]==0
6235	>e066	c5				                .byte >vdu_routines[i][0]
6240						                .endif
6234						                .if vdu_routines[i][1]==0
6235	>e067	c5				                .byte >vdu_routines[i][0]
6240						                .endif
6234						                .if vdu_routines[i][1]==0
6235	>e068	c4				                .byte >vdu_routines[i][0]
6240						                .endif
6234						                .if vdu_routines[i][1]==0
6236						                .else
6237						                .cerror vdu_routines[i][0]<(vduRoutinesPage<<8) || vdu_routines[i][0]>(vduRoutinesPage<<8)+$7ff,format("illegal VDU routine address for VDU %d: $%04x",i,vdu_routines[i][0])
6238						                .cerror vdu_routines[i][1]<0 || vdu_routines[i][1]>15,format("illegal VDU parameter count for VDU %d: %d",i,vdu_routines[i][1])
6239	>e069	5f				                .byte (16-vdu_routines[i][1])|(((>vdu_routines[i][0])&$0f)<<4)
6240						                .endif
6234						                .if vdu_routines[i][1]==0
6236						                .else
6237						                .cerror vdu_routines[i][0]<(vduRoutinesPage<<8) || vdu_routines[i][0]>(vduRoutinesPage<<8)+$7ff,format("illegal VDU routine address for VDU %d: $%04x",i,vdu_routines[i][0])
6238						                .cerror vdu_routines[i][1]<0 || vdu_routines[i][1]>15,format("illegal VDU parameter count for VDU %d: %d",i,vdu_routines[i][1])
6239	>e06a	5e				                .byte (16-vdu_routines[i][1])|(((>vdu_routines[i][0])&$0f)<<4)
6240						                .endif
6234						                .if vdu_routines[i][1]==0
6236						                .else
6237						                .cerror vdu_routines[i][0]<(vduRoutinesPage<<8) || vdu_routines[i][0]>(vduRoutinesPage<<8)+$7ff,format("illegal VDU routine address for VDU %d: $%04x",i,vdu_routines[i][0])
6238						                .cerror vdu_routines[i][1]<0 || vdu_routines[i][1]>15,format("illegal VDU parameter count for VDU %d: %d",i,vdu_routines[i][1])
6239	>e06b	6b				                .byte (16-vdu_routines[i][1])|(((>vdu_routines[i][0])&$0f)<<4)
6240						                .endif
6234						                .if vdu_routines[i][1]==0
6235	>e06c	c5				                .byte >vdu_routines[i][0]
6240						                .endif
6234						                .if vdu_routines[i][1]==0
6235	>e06d	c5				                .byte >vdu_routines[i][0]
6240						                .endif
6234						                .if vdu_routines[i][1]==0
6236						                .else
6237						                .cerror vdu_routines[i][0]<(vduRoutinesPage<<8) || vdu_routines[i][0]>(vduRoutinesPage<<8)+$7ff,format("illegal VDU routine address for VDU %d: $%04x",i,vdu_routines[i][0])
6238						                .cerror vdu_routines[i][1]<0 || vdu_routines[i][1]>15,format("illegal VDU parameter count for VDU %d: %d",i,vdu_routines[i][1])
6239	>e06e	7f				                .byte (16-vdu_routines[i][1])|(((>vdu_routines[i][0])&$0f)<<4)
6240						                .endif
6234						                .if vdu_routines[i][1]==0
6236						                .else
6237						                .cerror vdu_routines[i][0]<(vduRoutinesPage<<8) || vdu_routines[i][0]>(vduRoutinesPage<<8)+$7ff,format("illegal VDU routine address for VDU %d: $%04x",i,vdu_routines[i][0])
6238						                .cerror vdu_routines[i][1]<0 || vdu_routines[i][1]>15,format("illegal VDU parameter count for VDU %d: %d",i,vdu_routines[i][1])
6239	>e06f	67				                .byte (16-vdu_routines[i][1])|(((>vdu_routines[i][0])&$0f)<<4)
6240						                .endif
6234						                .if vdu_routines[i][1]==0
6236						                .else
6237						                .cerror vdu_routines[i][0]<(vduRoutinesPage<<8) || vdu_routines[i][0]>(vduRoutinesPage<<8)+$7ff,format("illegal VDU routine address for VDU %d: $%04x",i,vdu_routines[i][0])
6238						                .cerror vdu_routines[i][1]<0 || vdu_routines[i][1]>15,format("illegal VDU parameter count for VDU %d: %d",i,vdu_routines[i][1])
6239	>e070	78				                .byte (16-vdu_routines[i][1])|(((>vdu_routines[i][0])&$0f)<<4)
6240						                .endif
6234						                .if vdu_routines[i][1]==0
6236						                .else
6237						                .cerror vdu_routines[i][0]<(vduRoutinesPage<<8) || vdu_routines[i][0]>(vduRoutinesPage<<8)+$7ff,format("illegal VDU routine address for VDU %d: $%04x",i,vdu_routines[i][0])
6238						                .cerror vdu_routines[i][1]<0 || vdu_routines[i][1]>15,format("illegal VDU parameter count for VDU %d: %d",i,vdu_routines[i][1])
6239	>e071	6b				                .byte (16-vdu_routines[i][1])|(((>vdu_routines[i][0])&$0f)<<4)
6240						                .endif
6234						                .if vdu_routines[i][1]==0
6235	>e072	c6				                .byte >vdu_routines[i][0]
6240						                .endif
6234						                .if vdu_routines[i][1]==0
6235	>e073	c0				                .byte >vdu_routines[i][0]
6240						                .endif
6234						                .if vdu_routines[i][1]==0
6236						                .else
6237						                .cerror vdu_routines[i][0]<(vduRoutinesPage<<8) || vdu_routines[i][0]>(vduRoutinesPage<<8)+$7ff,format("illegal VDU routine address for VDU %d: $%04x",i,vdu_routines[i][0])
6238						                .cerror vdu_routines[i][1]<0 || vdu_routines[i][1]>15,format("illegal VDU parameter count for VDU %d: %d",i,vdu_routines[i][1])
6239	>e074	3c				                .byte (16-vdu_routines[i][1])|(((>vdu_routines[i][0])&$0f)<<4)
6240						                .endif
6234						                .if vdu_routines[i][1]==0
6236						                .else
6237						                .cerror vdu_routines[i][0]<(vduRoutinesPage<<8) || vdu_routines[i][0]>(vduRoutinesPage<<8)+$7ff,format("illegal VDU routine address for VDU %d: $%04x",i,vdu_routines[i][0])
6238						                .cerror vdu_routines[i][1]<0 || vdu_routines[i][1]>15,format("illegal VDU parameter count for VDU %d: %d",i,vdu_routines[i][1])
6239	>e075	7c				                .byte (16-vdu_routines[i][1])|(((>vdu_routines[i][0])&$0f)<<4)
6240						                .endif
6234						                .if vdu_routines[i][1]==0
6235	>e076	c4				                .byte >vdu_routines[i][0]
6240						                .endif
6234						                .if vdu_routines[i][1]==0
6236						                .else
6237						                .cerror vdu_routines[i][0]<(vduRoutinesPage<<8) || vdu_routines[i][0]>(vduRoutinesPage<<8)+$7ff,format("illegal VDU routine address for VDU %d: $%04x",i,vdu_routines[i][0])
6238						                .cerror vdu_routines[i][1]<0 || vdu_routines[i][1]>15,format("illegal VDU parameter count for VDU %d: %d",i,vdu_routines[i][1])
6239	>e077	4e				                .byte (16-vdu_routines[i][1])|(((>vdu_routines[i][0])&$0f)<<4)
6240						                .endif
6234						                .if vdu_routines[i][1]==0
6235	>e078	ce				                .byte >vdu_routines[i][0]
6240						                .endif
6241						                .next

6243						;-------------------------------------------------------------------------
6244						;
6245						; entry:
6246						;
6247						; C=0
6248						;
6249						; A = vdu 23 code
6250						;
6251						; VDU queue = the full 9 bytes of the VDU 23
6252						;
6253	.e079					vdu23EntryPointTable:
6254	>e079	fb ce				                .word vdu23_0_EntryPoint
6255	>e07b	2b cf				                .word vdu23_1_EntryPoint
6256	>e07d	57 cf				                .word vdu23_2_EntryPoint
6257	>e07f	57 cf				                .word vdu23_3_EntryPoint
6258	>e081	57 cf				                .word vdu23_4_EntryPoint
6259	>e083	57 cf				                .word vdu23_5_EntryPoint
6260	>e085	df cf				                .word vdu23_6_EntryPoint
6261	>e087	e6 cf				                .word vdu23_7_EntryPoint
6262	>e089	69 d0				                .word vdu23_8_EntryPoint
6263	>e08b	0f d1				                .word vdu23_9_EntryPoint
6264	>e08d	10 d1				                .word vdu23_10_EntryPoint
6265	>e08f	6d cf				                .word vdu23_11_EntryPoint
6266	>e091	96 cf				                .word vdu23_12_EntryPoint
6267	>e093	96 cf				                .word vdu23_13_EntryPoint
6268	>e095	96 cf				                .word vdu23_14_EntryPoint
6269	>e097	96 cf				                .word vdu23_15_EntryPoint
6270	>e099	1e d1				                .word vdu23_16_EntryPoint

6272						;-------------------------------------------------------------------------
6273						;
6274						; entry:
6275						;
6276						; A = plot number
6277						;
6278	.e09b					plotEntryPointTable:
6279	>e09b	4a db				                .word plotPoint    ;64<80><93>71 = Plot point [MasRef E.3-24]
6280	>e09d	6c dc				                .word plotHorizontalLineFill ;72<80><93>79 = Horizontal line fill (left and right to non-background) [MasRef E.3-24]
6281	>e09f	27 9c				                .word terminal.L9BF7 ;80<80><93>87 = Plot triangle [MasRef E.3-25]
6282	>e0a1	75 dc				                .word plotHorizontalLineFillRight ;88<80><93>95 = Horizontal line fill (right to background) [MasRef E.3-25]
6283	>e0a3	48 c4				                .word LC448 ;96<80><93>103 = Plot rectangle [MasRef E.3-26]
6284	>e0a5	6c dc				                .word plotHorizontalLineFill ;104<80><93>111 = Horizontal line fill (left and right to foreground) [MasRef E.3-26]
6285	>e0a7	d3 9b				                .word terminal.plotParallelogram ;112<80><93>119 = Plot parallelogram [MasRef E.3-27]
6286	>e0a9	75 dc				                .word plotHorizontalLineFillRight ;120<80><93>127 = Horizontal line fill (right to non-foreground) [MasRef E.3-27]
6287	>e0ab	29 9d				                .word terminal.L9CF9 ;128<80><93>135 = Flood fill to non-background [MasRef E.3-28]
6288	>e0ad	29 9d				                .word terminal.L9CF9 ;136<80><93>143 = Flood fill to foreground [MasRef E.3-28]
6289	>e0af	d4 99				                .word terminal.L99A4 ;144<80><93>151 = Plot circle outline [MasRef E.3-28]
6290	>e0b1	74 99				                .word terminal.L9944 ;152<80><93>159 = Plot filled circle [MasRef E.3-29]
6291	>e0b3	c9 99				                .word terminal.L9999 ;160<80><93>167 = Plot circular arc [MasRef E.3-29]
6292	>e0b5	65 99				                .word terminal.L9935 ;168<80><93>175 = Plot filled chord segment [MasRef E.3-30]
6293	>e0b7	53 99				                .word terminal.L9923 ;176<80><93>183 = Plot filled sector [MasRef E.3-30]
6294	>e0b9	df df				                .word plotMoveOrCopyRectangle ;184<80><93>191 = Move/copy rectangle [MasRef E.3-31]
6295	>e0bb	e9 df				                .word plotEllipseOutline ;192<80><93>199 = Plot ellipse outline [MasRef E.3-32]
6296	>e0bd	f4 df				                .word plotSolidEllipse ;200<80><93>207 = Plot solid ellipse [MasRef E.3-32]

6298						; Times 40 lookup table, high bytes
6299	.e0bf					multiplyBy40TableHigh:
6300						                .for i=0,i<25,i+=1
6301	>e0bf	00				                .byte >i*40
6301	>e0c0	00				                .byte >i*40
6301	>e0c1	00				                .byte >i*40
6301	>e0c2	00				                .byte >i*40
6301	>e0c3	00				                .byte >i*40
6301	>e0c4	00				                .byte >i*40
6301	>e0c5	00				                .byte >i*40
6301	>e0c6	01				                .byte >i*40
6301	>e0c7	01				                .byte >i*40
6301	>e0c8	01				                .byte >i*40
6301	>e0c9	01				                .byte >i*40
6301	>e0ca	01				                .byte >i*40
6301	>e0cb	01				                .byte >i*40
6301	>e0cc	02				                .byte >i*40
6301	>e0cd	02				                .byte >i*40
6301	>e0ce	02				                .byte >i*40
6301	>e0cf	02				                .byte >i*40
6301	>e0d0	02				                .byte >i*40
6301	>e0d1	02				                .byte >i*40
6301	>e0d2	02				                .byte >i*40
6301	>e0d3	03				                .byte >i*40
6301	>e0d4	03				                .byte >i*40
6301	>e0d5	03				                .byte >i*40
6301	>e0d6	03				                .byte >i*40
6301	>e0d7	03				                .byte >i*40
6302						                .next

6304						; Times 40 lookup table, low bytes
6305	.e0d8					multiplyBy40TableLow:
6306						                .for i=0,i<25,i+=1
6307	>e0d8	00				                .byte <i*40
6307	>e0d9	28				                .byte <i*40
6307	>e0da	50				                .byte <i*40
6307	>e0db	78				                .byte <i*40
6307	>e0dc	a0				                .byte <i*40
6307	>e0dd	c8				                .byte <i*40
6307	>e0de	f0				                .byte <i*40
6307	>e0df	18				                .byte <i*40
6307	>e0e0	40				                .byte <i*40
6307	>e0e1	68				                .byte <i*40
6307	>e0e2	90				                .byte <i*40
6307	>e0e3	b8				                .byte <i*40
6307	>e0e4	e0				                .byte <i*40
6307	>e0e5	08				                .byte <i*40
6307	>e0e6	30				                .byte <i*40
6307	>e0e7	58				                .byte <i*40
6307	>e0e8	80				                .byte <i*40
6307	>e0e9	a8				                .byte <i*40
6307	>e0ea	d0				                .byte <i*40
6307	>e0eb	f8				                .byte <i*40
6307	>e0ec	20				                .byte <i*40
6307	>e0ed	48				                .byte <i*40
6307	>e0ee	70				                .byte <i*40
6307	>e0ef	98				                .byte <i*40
6307	>e0f0	c0				                .byte <i*40
6308						                .next

6310						; Times 640 lookup table, high bytes
6311	.e0f1					multiplyBy640TableHigh:
6312						                .for i=0,i<32,i+=1
6313	>e0f1	00				                .byte >i*640
6313	>e0f2	02				                .byte >i*640
6313	>e0f3	05				                .byte >i*640
6313	>e0f4	07				                .byte >i*640
6313	>e0f5	0a				                .byte >i*640
6313	>e0f6	0c				                .byte >i*640
6313	>e0f7	0f				                .byte >i*640
6313	>e0f8	11				                .byte >i*640
6313	>e0f9	14				                .byte >i*640
6313	>e0fa	16				                .byte >i*640
6313	>e0fb	19				                .byte >i*640
6313	>e0fc	1b				                .byte >i*640
6313	>e0fd	1e				                .byte >i*640
6313	>e0fe	20				                .byte >i*640
6313	>e0ff	23				                .byte >i*640
6313	>e100	25				                .byte >i*640
6313	>e101	28				                .byte >i*640
6313	>e102	2a				                .byte >i*640
6313	>e103	2d				                .byte >i*640
6313	>e104	2f				                .byte >i*640
6313	>e105	32				                .byte >i*640
6313	>e106	34				                .byte >i*640
6313	>e107	37				                .byte >i*640
6313	>e108	39				                .byte >i*640
6313	>e109	3c				                .byte >i*640
6313	>e10a	3e				                .byte >i*640
6313	>e10b	41				                .byte >i*640
6313	>e10c	43				                .byte >i*640
6313	>e10d	46				                .byte >i*640
6313	>e10e	48				                .byte >i*640
6313	>e10f	4b				                .byte >i*640
6313	>e110	4d				                .byte >i*640
6314						                .next

6316						;-------------------------------------------------------------------------

6318	.e111					modeMaxRow:
6319	>e111	1f				                .byte 31                     ;MODE 0 = 32 rows
6320	>e112	1f				                .byte 31                     ;MODE 1 = 32 rows
6321	>e113	1f				                .byte 31                     ;MODE 2 = 32 rows
6322	>e114	18				                .byte 24                     ;MODE 3 = 25 rows
6323	>e115	1f				                .byte 31                     ;MODE 4 = 32 rows
6324	>e116	1f				                .byte 31                     ;MODE 5 = 32 rows
6325	>e117	18				                .byte 24                     ;MODE 6 = 25 rows
6326	>e118	18				                .byte 24                     ;MODE 7 = 25 rows

6328						;-------------------------------------------------------------------------

6330	.e119					modeMaxColumn:
6331	>e119	4f				                .byte 79                     ;MODE 0 = 80 columns
6332	>e11a	27				                .byte 39                     ;MODE 1 = 40 columns
6333	>e11b	13				                .byte 19                     ;MODE 2 = 20 columns
6334	>e11c	4f				                .byte 79                     ;MODE 3 = 80 columns
6335	>e11d	27				                .byte 39                     ;MODE 4 = 40 columns
6336	>e11e	13				                .byte 19                     ;MODE 5 = 20 columns
6337	>e11f	27				                .byte 39                     ;MODE 6 = 40 columns
6338	>e120	27				                .byte 39                     ;MODE 7 = 40 columns

6340						;-------------------------------------------------------------------------

6342	.e121					vcontrolForScreenMODE:
6343	>e121	9c				                .byte VCONTROL.cursorX___|VCONTROL.crtc2MHz|VCONTROL.shift16MHz ; $9C - MODE 0
6344	>e122	d8				                .byte VCONTROL.cursorXX__|VCONTROL.crtc2MHz|VCONTROL.shift8MHz ; $d8 - MODE 1
6345	>e123	f4				                .byte VCONTROL.cursorXXXX|VCONTROL.crtc2MHz|VCONTROL.shift4MHz ; $F4 - MODE 2
6346	>e124	9c				                .byte VCONTROL.cursorX___|VCONTROL.crtc2MHz|VCONTROL.shift16MHz ; $9C - MODE 3
6347	>e125	88				                .byte VCONTROL.cursorX___|VCONTROL.crtc1MHz|VCONTROL.shift8MHz ; $88 - MODE 4
6348	>e126	c4				                .byte VCONTROL.cursorXX__|VCONTROL.crtc1MHz|VCONTROL.shift4MHz ; $C4 - MODE 5
6349	>e127	88				                .byte VCONTROL.cursorX___|VCONTROL.crtc1MHz|VCONTROL.shift8MHz ; $88 - MODE 6
6350	>e128	4b				                .byte VCONTROL.cursor_X__|VCONTROL.crtc1MHz|VCONTROL.shift8MHz|VCONTROL.isTeletext|VCONTROL.flash ; $4B - MODE 7

6352						;-------------------------------------------------------------------------

6354	.e129					bytesPerCharacterForMODE:
6355	>e129	08				                .byte 8                      ;MODE 0
6356	>e12a	10				                .byte 16                     ;MODE 1
6357	>e12b	20				                .byte 32                     ;MODE 2
6358	>e12c	08				                .byte 8                      ;MODE 3
6359	>e12d	08				                .byte 8                      ;MODE 4
6360	>e12e	10				                .byte 16                     ;MODE 5
6361	>e12f	08				                .byte 8                      ;MODE 6
6362	.e130					LE120:
6363	>e130	01				                .byte %00000001              ;MODE 7
6364	>e131	ff				                .byte %11111111
6365	>e132	55				                .byte %01010101
6366	>e133	ff				                .byte %11111111
6367	>e134	77				                .byte %01110111
6368	>e135	33				                .byte %00110011
6369	>e136	11				                .byte %00010001

6371						;-------------------------------------------------------------------------

6373	.e137					distanceMasksTable:
6374	>e137	ff				                .byte %11111111
6375	>e138	7f				                .byte %01111111
6376	>e139	3f				                .byte %00111111
6377	>e13a	1f				                .byte %00011111
6378	>e13b	0f				                .byte %00001111
6379	>e13c	07				                .byte %00000111
6380	>e13d	03				                .byte %00000011
6381	>e13e	01				                .byte %00000001

6383						;-------------------------------------------------------------------------
6384						;
6385						; These graphics tables often overlap. I haven't always bothered
6386						; commenting the MODEs for the MODE-indexed tables, as even those
6387						; sometimes overlap.
6388						;
6389						;------------------------------------------------------------------------

6391						;-------------------------------------------------------------------------
6392						;
6393						; This is 3 tables in one. Use the numberOfLogicalColoursMinusOne VDU
6394						; variable to access it:
6395						; pixelMasks[(numberOfLogicalColoursMinusOne&7)-1+colour&numberOfLogicalColoursMinusOne=
6396						;
6397	.e13f					pixelMasks:
6398	>e13f	aa				                .byte %10101010
6399	>e140	55				                .byte %01010101

6401	>e141	88				                .byte %10001000
6402	>e142	44				                .byte %01000100
6403	>e143	22				                .byte %00100010
6404	>e144	11				                .byte %00010001

6406	>e145	80				                .byte %10000000
6407	>e146	40				                .byte %01000000
6408	>e147	20				                .byte %00100000
6409	>e148	10				                .byte %00010000
6410	>e149	08				                .byte %00001000
6411	>e14a	04				                .byte %00000100
6412	>e14b	02				                .byte %00000010
6413	.e14c					numberOfLogicalColoursMinusOneForMODE:
6414	>e14c	01				                .byte %00000001              ;MODE 0 (also part of pixelMasks)
6415	>e14d	03				                .byte 3                      ;MODE 1
6416	>e14e	0f				                .byte 15                     ;MODE 2
6417	>e14f	01				                .byte 1                      ;MODE 3
6418	>e150	01				                .byte 1                      ;MODE 4
6419	>e151	03				                .byte 3                      ;MODE 5
6420	>e152	01				                .byte 1                      ;MODE 6
6421						                ; MODE 7 value (0) is in next table

6423						;-------------------------------------------------------------------------
6424						;
6425						; Overwrite: ZGORA=$ff, ZGEOR=$ff
6426						; OR: ZGORA=value, ZGEOR=$00
6427						; AND: ZGORA=~value, ZGEOR=$00
6428						; EOR: ZGORA=$00, ZGEOR=value
6429						; Invert: ZGORA=$00, ZGEOR=$ff
6430						; Leave: ZGORA=$00, ZGEOR=$ff
6431						;
6432	.e153					zgeorORTable:
6433	>e153	00				                .byte $00
6434	.e154					zgoraORTable:
6435	>e154	ff				                .byte $FF
6436	.e155					zgoraEORTable:
6437	>e155	00				                .byte $00
6438	>e156	00				                .byte $00
6439	>e157	ff				                .byte $FF
6440	.e158					zgeorEORTable:
6441	>e158	ff				                .byte $FF
6442	>e159	ff				                .byte $FF
6443	>e15a	ff				                .byte $FF
6444	>e15b	00				                .byte $00

6446						;-------------------------------------------------------------------------
6447						;
6448						; Index using logical colour value to get a byte with that colour
6449						; value in every pixel.
6450						;
6451						; This is 3 tables in one. Use the numberOfLogicalColoursMinusOne VDU
6452						; variable to access it:
6453						; solidColoursTable[(numberOfLogicalColoursMinusOne&7)-1+colour&numberOfLogicalColoursMinusOne=
6454						;
6455	.e15c					solidColoursTable:

6457						                ; 1 bpp
6458	>e15c	00				                .byte %00000000
6459	>e15d	ff				                .byte %11111111

6461						                ; 2 bpp
6462	>e15e	00				                .byte %00000000
6463	>e15f	0f				                .byte %00001111
6464	>e160	f0				                .byte %11110000
6465	>e161	ff				                .byte %11111111

6467						                ; 4 bpp
6468	>e162	00				                .byte %00000000
6469	>e163	03				                .byte %00000011
6470	>e164	0c				                .byte %00001100
6471	>e165	0f				                .byte %00001111
6472	>e166	30				                .byte %00110000
6473	>e167	33				                .byte %00110011
6474	>e168	3c				                .byte %00111100
6475	>e169	3f				                .byte %00111111
6476	>e16a	c0				                .byte %11000000
6477	>e16b	c3				                .byte %11000011
6478	>e16c	cc				                .byte %11001100
6479	>e16d	cf				                .byte %11001111
6480	>e16e	f0				                .byte %11110000
6481	>e16f	f3				                .byte %11110011
6482	>e170	fc				                .byte %11111100
6483	>e171	ff				                .byte %11111111

6485	.e172					pixelsPerByteMinusOneForMODE:
6486	>e172	07				                .byte 7
6487	>e173	03				                .byte 3
6488	>e174	01				                .byte 1
6489	.e175					LE165:
6490	>e175	00				                .byte 0
6491	>e176	07				                .byte 7
6492	>e177	03				                .byte 3
6493	.e178					screenMODEGroupForMODE:
6494	>e178	00				                .byte 0
6495	>e179	00				                .byte 0
6496	.e17a	00		brk #		                brk
6497	.e17b	01 02		ora ($02,x)	                ora ($02,x)
6498	>e17d	02				                .byte $02
6499	>e17e	03				                .byte $03
6500						;TSB &0D          :\ E16F= 04 0D       ..
6501	>e17f	04				                .byte $04

6503						;-------------------------------------------------------------------------
6504						;
6505						; Hardware scrolling wraparound size settings for screen mode group.
6506						;
6507						; The values for group 4 (1 KB) are bogus - the Mode 7 addressing
6508						; wraparound is handled differently.
6509						;
6510	.e180					latchBit5ForScreenMODEGroup:
6511	>e180	0d				                .byte 5|8                    ;20 KB
6512	>e181	05				                .byte 5|0                    ;16 KB
6513	>e182	0d				                .byte 5|8                    ;10 KB
6514	>e183	05				                .byte 5|0                    ; 8 KB
6515	.e184					latchBit4ForScreenMODEGroup:
6516	>e184	04				                .byte 4|0                    ;20 KB (also benign value for 1 KB)
6517	>e185	04				                .byte 4|0                    ;16 KB
6518	>e186	0c				                .byte 4|8                    ;10 KB
6519	>e187	0c				                .byte 4|8                    ; 8 KB
6520	>e188	04				                .byte 4|0                    ;(benign value for 1 KB)

6522						;-------------------------------------------------------------------------

6524	.e189					screenSizeHighByteForScreenMODEGroup:
6525	>e189	50				                .byte $50
6526	>e18a	40				                .byte $40
6527	>e18b	28				                .byte $28
6528	>e18c	20				                .byte $20
6529	>e18d	04				                .byte $04
6530	.e18e					startScreenAddressHighByteForScreenMODEGroup:
6531	>e18e	30				                .byte $30
6532	>e18f	40				                .byte $40
6533	>e190	58				                .byte $58
6534	>e191	60				                .byte $60
6535	>e192	7c				                .byte $7c
6536	.e193					crtcRegisterLastIndexForScreenMODEGroup:
6537	>e193	0b				                .byte (crtcRegisterValues20KB-crtcRegisterValues)+$0B
6538	>e194	17				                .byte (crtcRegisterValues16KB-crtcRegisterValues)+$0B
6539	>e195	23				                .byte (crtcRegisterValues10KB-crtcRegisterValues)+$0B
6540	>e196	2f				                .byte (crtcRegisterValues8KB-crtcRegisterValues)+$0B
6541	>e197	3b				                .byte (crtcRegisterValues1KB-crtcRegisterValues)+$0B
6542	.e198					crtcRegisterValues:
6543	.e198					crtcRegisterValues20KB:                   ;MODEs 0/1/2
6544	>e198	7f				                .byte $7F            ;R0 - Horizontal Total
6545	>e199	50				                .byte $50            ;R1 - Horizontal Displayed
6546	>e19a	62				                .byte $62            ;R2 - Horizontal Sync
6547	>e19b	28				                .byte $28            ;R3 - Sync Width (%vvvvhhhh)
6548	>e19c	26				                .byte $26            ;R4 - Vertical Total
6549	>e19d	00				                .byte $00            ;R5 - Vertical Total Adjust
6550	>e19e	20				                .byte $20            ;R6 - Vertical Displayed
6551	>e19f	22				                .byte $22            ;R7 - Vertical Sync Position
6552	>e1a0	01				                .byte CRTC.R8.cursorDelay0|CRTC.R8.displayDelay0|CRTC.R8.interlaceSync ;R8 - Interlace/Delay
6553	>e1a1	07				                .byte $07               ;R9 - Scan lines per character
6554	>e1a2	67				                .byte CRTC.R10.blink|CRTC.R10.slowBlink|7 ;R10 - Cursor blink/start
6555	>e1a3	08				                .byte 8                    ;R11 - Cursor End
6556	.e1a4					crtcRegisterValues16KB:                    ;MODE 3
6557	>e1a4	7f				                .byte $7F                 ;R0 - Horizontal Total
6558	>e1a5	50				                .byte $50                 ;R1 - Horizontal Displayed
6559	>e1a6	62				                .byte $62                 ;R2 - Horizontal Sync
6560	>e1a7	28				                .byte $28                 ;R3 - Sync Width (%vvvvhhhh)
6561	>e1a8	1e				                .byte $1e                 ;R4 - Vertical Total
6562	>e1a9	02				                .byte $02                 ;R5 - Vertical Total Adjust
6563	>e1aa	19				                .byte $19                 ;R6 - Vertical Displayed
6564	>e1ab	1b				                .byte $1B                 ;R7 - Vertical Sync Position
6565	>e1ac	01				                .byte CRTC.R8.cursorDelay0|CRTC.R8.displayDelay0|CRTC.R8.interlaceSync ;R8 - Interlace/Delay
6566	>e1ad	09				                .byte $09               ;R9 - Scan lines per character
6567	>e1ae	67				                .byte CRTC.R10.blink|CRTC.R10.slowBlink|7 ;R10 - Cursor blink/start
6568	>e1af	09				                .byte 9                      ;R11 - Cursor End
6569	.e1b0					crtcRegisterValues10KB:                      ;MODEs 4/5
6570	>e1b0	3f				                .byte $3f                 ;R0 - Horizontal Total
6571	>e1b1	28				                .byte $28                 ;R1 - Horizontal Displayed
6572	>e1b2	31				                .byte $31                 ;R2 - Horizontal Sync
6573	>e1b3	24				                .byte $24                 ;R3 - Sync Width (%vvvvhhhh)
6574	>e1b4	26				                .byte $26                 ;R4 - Vertical Total
6575	>e1b5	00				                .byte $00                 ;R5 - Vertical Total Adjust
6576	>e1b6	20				                .byte $20                 ;R6 - Vertical Displayed
6577	>e1b7	22				                .byte $22                 ;R7 - Vertical Sync Position
6578	>e1b8	01				                .byte CRTC.R8.cursorDelay0|CRTC.R8.displayDelay0|CRTC.R8.interlaceSync ;R8 - Interlace/Delay
6579	>e1b9	07				                .byte $07               ;R9 - Scan lines per character
6580	>e1ba	67				                .byte CRTC.R10.blink|CRTC.R10.slowBlink|7 ;R10 - Cursor blink/start
6581	>e1bb	08				                .byte 8                      ;R11 - Cursor End
6582	.e1bc					crtcRegisterValues8KB:                       ;MODE 6
6583	>e1bc	3f				                .byte $3F                 ;R0 - Horizontal Total
6584	>e1bd	28				                .byte $28                 ;R1 - Horizontal Displayed
6585	>e1be	31				                .byte $31                 ;R2 - Horizontal Sync
6586	>e1bf	24				                .byte $24                 ;R3 - Sync Width (%vvvvhhhh)
6587	>e1c0	1e				                .byte $1e                 ;R4 - Vertical Total
6588	>e1c1	02				                .byte $02                 ;R5 - Vertical Total Adjust
6589	>e1c2	19				                .byte $19                 ;R6 - Vertical Displayed
6590	>e1c3	1b				                .byte $1B                 ;R7 - Vertical Sync Position
6591	>e1c4	01				                .byte CRTC.R8.cursorDelay0|CRTC.R8.displayDelay0|CRTC.R8.interlaceSync ;R8 - Interlace/Delay
6592	>e1c5	09				                .byte $09               ;R9 - Scan lines per character
6593	>e1c6	67				                .byte CRTC.R10.blink|CRTC.R10.slowBlink|7 ;R10 - Cursor blink/start
6594	>e1c7	09				                .byte 9                      ;R11 - Cursor End
6595	.e1c8					crtcRegisterValues1KB:                       ;MODE 7
6596	>e1c8	3f				                .byte $3f                 ;R0 - Horizontal Total
6597	>e1c9	28				                .byte $28                 ;R1 - Horizontal Displayed
6598	>e1ca	33				                .byte $33                 ;R2 - Horizontal Sync
6599	>e1cb	24				                .byte $24                 ;R3 - Sync Width (%vvvvhhhh)
6600	>e1cc	1e				                .byte $1e                 ;R4 - Vertical Total
6601	>e1cd	02				                .byte $02                 ;R5 - Vertical Total Adjust
6602	>e1ce	19				                .byte $19                 ;R6 - Vertical Displayed
6603	>e1cf	1b				                .byte $1b                 ;R7 - Vertical Sync Position
6604	>e1d0	93				                .byte CRTC.R8.cursorDelay2|CRTC.R8.displayDelay1|CRTC.R8.interlaceSyncAndVideo ;R8 - Interlace/Delay
6605	>e1d1	12				                .byte $12               ;R9 - Scan lines per character
6606	>e1d2	72				                .byte CRTC.R10.blink|CRTC.R10.slowBlink|18 ;R10 - Cursor blink/start
6607	>e1d3	13				                .byte 19                     ;R11 - Cursor End

6609						;-------------------------------------------------------------------------
6610						;
6611						; Default ECF patterns [MasRef E.3-16]
6612						;
6613						; Only half the pattern is stored. Each pattern repeats every 4
6614						; scanlines.
6615						;
6616	.e1d4					defaultECFPatterns:
6617						                ; MODE 4
6618	>e1d4	aa 00 aa 00			                .byte $aa,$00,$aa,$00        ;1 - Dark grey
6619	>e1d8	aa 55 aa 55			                .byte $aa,$55,$aa,$55        ;2 - Grey
6620	>e1dc	ff 55 ff 55			                .byte $ff,$55,$ff,$55        ;3 - Light grey
6621	>e1e0	11 22 44 88			                .byte $11,$22,$44,$88        ;4 - Hatching

6623						                ; MODE 1/5
6624	>e1e4	a5 0f a5 0f			                .byte $a5,$0f,$a5,$0f        ;1 - Red-orange
6625	>e1e8	a5 5a a5 5a			                .byte $a5,$5a,$a5,$5a        ;2 - Orange
6626	>e1ec	f0 5a f0 5a			                .byte $f0,$5a,$f0,$5a        ;3 - Yellow-orange
6627	>e1f0	f5 fa f5 fa			                .byte $f5,$fa,$f5,$fa        ;4 - Cream

6629						                ; MODE 2
6630	>e1f4	0b 07 0b 07			                .byte $0b,$07,$0b,$07        ;1 - Orange
6631	>e1f8	23 13 23 13			                .byte $23,$13,$23,$13        ;2 - Pink
6632	>e1fc	0e 0d 0e 0d			                .byte $0e,$0d,$0e,$0d        ;3 - Yellow-green
6633	>e200	1f 2f 1f 2f			                .byte $1f,$2f,$1f,$2f        ;4 - Cream

6635						                ; MODE 0
6636	>e204	cc 00 cc 00			                .byte $cc,$00,$cc,$00        ;0 - Dark grey
6637	>e208	cc 33 cc 33			                .byte $cc,$33,$cc,$33        ;1 - Grey
6638	>e20c	ff 33 ff 33			                .byte $ff,$33,$ff,$33        ;2 - Light grey
6639	>e210	03 0c 30 c0			                .byte $03,$0c,$30,$c0        ;4 - Hatching

6641	.e214					LE204:
6642	>e214	01				                .byte $01                    ;---
6643	>e215	01				                .byte $01                    ;--h
6644	>e216	03				                .byte $03                    ;-v-
6645	>e217	03				                .byte $03                    ;-vh
6646	>e218	02				                .byte $02                    ;x--
6647	>e219	00				                .byte $00                    ;x-h
6648	>e21a	02				                .byte $02                    ;xv-
6649	>e21b	00				                .byte $00                    ;xvh

6651	.e21c					scrollRoutinesTable:
6652	>e21c	5f c9				                .word LC95F
6653	>e21e	6b c9				                .word LC96B
6654	>e220	5f c9				                .word LC95F
6655	>e222	6b c9				                .word LC96B
6656	>e224	9d c9				                .word LC99D
6657	>e226	9d c9				                .word LC99D
6658	>e228	a4 c9				                .word LC9A4
6659	>e22a	a4 c9				                .word LC9A4
6660	>e22c	c3 c9				                .word LC9C3
6661	>e22e	2d ca				                .word LCA2D
6662	>e230	c3 c9				                .word LC9C3
6663	>e232	2d ca				                .word LCA2D
6664	>e234	f1 ca				                .word LCAF1
6665	>e236	f1 ca				                .word LCAF1
6666	>e238	fa ca				                .word LCAFA
6667	>e23a	fa ca				                .word LCAFA

6669						;-------------------------------------------------------------------------
6670						;
6671						; Get address of soft character definition.
6672						;
6673						; entry:
6674						;
6675						; A = character (32-255)
6676						;
6677						; exit:
6678						;
6679						; (ZTEMPC) = address
6680						;
6681	.e23c					getSoftCharacterDefinitionAddress:
6682	.e23c	0a		asl a		                asl a                        ;a bcdefgh0
6683	.e23d	2a		rol a		                rol a                        ;b cdefgh0a
6684	.e23e	2a		rol a		                rol a                        ;c defgh0ab
6685	.e23f	a8		tay		                tay
6686	.e240	29 03		and #$03	                and #$03                     ;c 000000ab
6687	.e242	2a		rol a		                rol a                        ;0 00000abc
6688	.e243	69 88		adc #$88	                adc #(>andy.softCharacterDefinitions)-1
6689	.e245	85 df		sta $df		                sta ZTEMPC+1
6690	.e247	98		tya		                tya                          ;0 defgh0ab
6691	.e248	29 f8		and #$f8	                and #$F8                     ;0 defgh000
6692	.e24a	85 de		sta $de		                sta ZTEMPC+0
6693	.e24c	60		rts		                rts                          ;

6695						;-------------------------------------------------------------------------
6696						;
6697						; OSBYTE 165 (&A5) Read output cursor position [MasRef D.2-50]
6698						;
6699	.e24d					osbyteA5:
6700	.e24d	20 77 f4	jsr $f477	                jsr withMOSROM
6701	.e250	24 d0		bit $d0		                bit STATE
6702	.e252	50 0e		bvc $e262	                bvc getTextCursorPositionWithColumn81                    ;taken if cursor editing
6703	.e254	20 be e2	jsr $e2be	                jsr exchangeEditCursorPositionAndTextCursorPosition
6704	.e257	20 62 e2	jsr $e262	                jsr getTextCursorPositionWithColumn81
6705	.e25a	da		phx		                phx
6706	.e25b	5a		phy		                phy
6707	.e25c	20 be e2	jsr $e2be	                jsr exchangeEditCursorPositionAndTextCursorPosition
6708	.e25f	7a		ply		                ply
6709	.e260	fa		plx		                plx
6710	.e261	60		rts		                rts

6712						;-------------------------------------------------------------------------
6713						;
6714						; Get text cursor position, taking the column 81 flag into account and
6715						; reporting the X coordinate as N+1 in that case.
6716						;
6717	.e262					getTextCursorPositionWithColumn81:
6718	.e262	20 7d e2	jsr $e27d	                jsr getTextCursorPosition
6719	.e265	2c 6c 03	bit $036c	                bit vduv.column81
6720	.e268	10 01		bpl $e26b	                bpl +                       ;taken if not at column 81
6721	.e26a	e8		inx		                inx                         ;X=81
6722	.e26b					+
6723	.e26b	60		rts		                rts

6725						;-------------------------------------------------------------------------

6727	.e26c					LE25C:
6728	.e26c	38		sec		                sec
6729	.e26d	ad 0a 03	lda $030a	                lda vduv.textWindowRight
6730	.e270	ed 08 03	sbc $0308	                sbc vduv.textWindowLeft
6731	.e273	48		pha		                pha
6732	.e274	a9 00		lda #$00	                lda #$00
6733	.e276	a8		tay		                tay
6734	.e277	80 10		bra $e289	                bra LE279

6736						;-------------------------------------------------------------------------
6737						;
6738						; OSBYTE 134 (&86) Read text cursor position [MasRef D.2-41]
6739						;
6740	.e279					osbyte86:
6741	.e279	24 d0		bit $d0		                bit STATE
6742	.e27b	50 d0		bvc $e24d	                bvc osbyteA5       ;taken if not cursor editing
6743	.e27d					getTextCursorPosition:
6744	.e27d	a9 02		lda #$02	                lda #VDUVariables.cursorFlags.invertHorizontal
6745	.e27f	a0 10		ldy #$10	                ldy #VDUVariables.textCursorXPosition-VDUVariables.textWindow
6746	.e281	a2 00		ldx #$00	                ldx #VDUVariables.textWindowLeft-VDUVariables.textWindow
6747	.e283	20 9a e2	jsr $e29a	                jsr getTextWindowRelativePosition
6748	.e286	48		pha		                pha                          ;save X position
6749	.e287	a9 04		lda #$04	                lda #VDUVariables.cursorFlags.invertVertical
6750	.e289					LE279:
6751	.e289	c8		iny		                iny               ;i.e., offset of textCursorYPosition
6752	.e28a	a2 03		ldx #$03	                ldx #VDUVariables.textWindowTop-VDUVariables.textWindow
6753	.e28c	20 9a e2	jsr $e29a	                jsr getTextWindowRelativePosition
6754	.e28f	aa		tax		                tax                          ;X = Y position
6755	.e290	a8		tay		                tay                          ;Y = Y position
6756	.e291	a9 08		lda #$08	                lda #vduv.cursorFlags.swapAxes
6757	.e293	2c 66 03	bit $0366	                bit vduv.cursorFlags
6758	.e296	f0 24		beq $e2bc	                beq plx_rts ;taken if axes unswapped - so X = X position, Y = Y position
6759	.e298	7a		ply		                ply                          ;Y = Y position, X = X position
6760	.e299	60		rts		                rts

6762						;-------------------------------------------------------------------------
6763						;
6764						; Get text window-relative cursor position, taking into account cursor
6765						; flags.
6766						;
6767						; entry:
6768						;
6769						; A = cursorFlags bit for axis of interest - invertHorizontal or invertVertical
6770						;
6771						; X = offset in VDU variables of text window minimum for axis of interest
6772						;
6773						; Y = offset in VDU variables of cursor position for axis of interest
6774						;
6775						; exit:
6776						;
6777						; A = text window-relative coordinate
6778						;
6779	.e29a					getTextWindowRelativePosition:
6780	.e29a	38		sec		                sec                     ;C=1 ready for the subtraction
6781	.e29b	2c 66 03	bit $0366	                bit vduv.cursorFlags ;test cursor flags inversion bit of interest
6782	.e29e	f0 0b		beq $e2ab	                beq axisNotInverted
6783	.e2a0					axisInverted:
6784	.e2a0	8a		txa		                txa
6785	.e2a1	49 02		eor #$02	                eor #$02                     ;swap min and max
6786	.e2a3	aa		tax		                tax
6787	.e2a4	bd 08 03	lda $0308,x	                lda vduv.textWindow,x
6788	.e2a7	f9 08 03	sbc $0308,y	                sbc vduv.textWindow,y
6789	.e2aa	60		rts		                rts

6791	.e2ab					axisNotInverted:
6792	.e2ab	b9 08 03	lda $0308,y	                lda vduv.textWindow,y
6793	.e2ae	fd 08 03	sbc $0308,x	                sbc vduv.textWindow,x
6794	.e2b1	60		rts		                rts

6796						;-------------------------------------------------------------------------
6797						;
6798						; Get default bounds for current mode.
6799						;
6800						; exit:
6801						;
6802						; X = max column (19, 39 or 79)
6803						;
6804						; Y = max row (24 or 31)
6805						;
6806						; preserves: A, C
6807						;
6808	.e2b2					getDefaultBoundsForCurrentScreenMODE:
6809	.e2b2	ae 55 03	ldx $0355	                ldx vduv.currentScreenMODE
6810	.e2b5	bc 19 e1	ldy $e119,x	                ldy modeMaxColumn,x          ;Y = max column
6811	.e2b8	5a		phy		                phy                          ;save max column
6812	.e2b9	bc 11 e1	ldy $e111,x	                ldy modeMaxRow,x             ;Y = max row
6813	.e2bc					plx_rts:
6814	.e2bc	fa		plx		                plx                          ;X = max column
6815	.e2bd	60		rts		                rts

6817						;-------------------------------------------------------------------------
6818						;
6819						; Swap edit cursor position and text cursor position.
6820						;
6821	.e2be					exchangeEditCursorPositionAndTextCursorPosition:
6822	.e2be	a2 18		ldx #$18	                ldx #VDUVariables.textCursorXPosition
6823	.e2c0	a0 64		ldy #$64	                ldy #VDUVariables.editCursorXPosition

6825						;-------------------------------------------------------------------------
6826						;
6827						; Swap 2 bytes in the VDU variables.
6828						;
6829						; entry:
6830						;
6831						; X = offset of one set of 2 bytes
6832						;
6833						; Y = offset of the other set of 2 bytes
6834						;
6835	.e2c2					exchangeTwoVDUBytes:
6836	.e2c2	a9 02		lda #$02	                lda #$02
6837	.e2c4	80 06		bra $e2cc	                bra exchangeVDUVariables

6839						;-------------------------------------------------------------------------
6840						;
6841						; Swap graphics cursor and old graphics cursor.
6842						;
6843	.e2c6					LE2B6:
6844	.e2c6	a2 24		ldx #$24	                ldx #VDUVariables.graphicsCursorPixelsX
6845	.e2c8					LE2B8:
6846	.e2c8	a0 14		ldy #$14	                ldy #VDUVariables.oldGraphicsCursorPixelsX

6848						;-------------------------------------------------------------------------
6849						;
6850						; Swap 4 bytes in the VDU variables.
6851						;
6852						; entry:
6853						;
6854						; X = offset of one set of 4 bytes
6855						;
6856						; Y = offset of the other set of 4 bytes
6857						;
6858	.e2ca					exchangeFourVDUBytes:
6859	.e2ca	a9 04		lda #$04	                lda #$04

6861						;-------------------------------------------------------------------------
6862						;
6863						; Swap bytes in the VDU variables.
6864						;
6865						; entry:
6866						;
6867						; A = number of bytes to swap
6868						;
6869						; X = offset of one set of bytes
6870						;
6871						; Y = offset of the other set of bytes
6872						;
6873	.e2cc					exchangeVDUVariables:
6874	.e2cc	48		pha		                pha                          ;save count remaining
6875	.e2cd	bd 00 03	lda $0300,x	                lda vduv,x
6876	.e2d0	48		pha		                pha
6877	.e2d1	b9 00 03	lda $0300,y	                lda vduv,y
6878	.e2d4	9d 00 03	sta $0300,x	                sta vduv,x
6879	.e2d7	68		pla		                pla
6880	.e2d8	99 00 03	sta $0300,y	                sta vduv,y
6881	.e2db	e8		inx		                inx
6882	.e2dc	c8		iny		                iny
6883	.e2dd	68		pla		                pla
6884	.e2de	3a		dec a		                dec a
6885	.e2df	d0 eb		bne $e2cc	                bne exchangeVDUVariables
6886	.e2e1	60		rts		                rts

6888						;-------------------------------------------------------------------------
6889						;
6890						; Test current VDU4/VDU5 status.
6891						;
6892						; exit:
6893						;
6894						; Z=0 if VDU5 mode
6895	.e2e2					testVDU5State:
6896	.e2e2	a5 d0		lda $d0		                lda STATE
6897	.e2e4	29 20		and #$20	                and #STATE.isVDU5
6898	.e2e6	60		rts		                rts

6900						;-------------------------------------------------------------------------

6902						                .if version>=350
6903	.e2e7					LE2E7:
6904	.e2e7	20 77 f4	jsr $f477	                jsr withMOSROM
6905	.e2ea	4c 65 ea	jmp $ea65	                jmp callPrinterDriverWithPrinterBuffer
6906						                .endif

6908						;-------------------------------------------------------------------------

6910						                .if version>=350
6911	.e2ed					LE2ED:
6912	.e2ed	20 77 f4	jsr $f477	                jsr withMOSROM
6913	.e2f0	4c e4 e9	jmp $e9e4	                jmp LE8B9
6914						                .endif

6916						;-------------------------------------------------------------------------

6918						                .if version>=350
6919	.e2f3					LE2F3:
6920	.e2f3	20 77 f4	jsr $f477	                jsr withMOSROM
6921	.e2f6	6c 26 02	jmp ($0226)	                jmp (VDUV)
6922						                .endif

6924						;-------------------------------------------------------------------------

6926						; Default vector table
6927						; ====================
6928	.e2f9					defaultVectorTable: .block
6929	>e2f9	3d fb				                .word badCommandError        ; USERV=$200
6930	>e2fb	7e e5				                .word defaultBRKHandler      ; BRKV=$202
6931	>e2fd	18 e6				                .word irq1EntryPoint         ; IRQ1V=$204
6932	>e2ff	25 e6				                .word irq2EntryPoint         ; IRQ2V=$206
6933	>e301	2d e9				                .word oscliEntryPoint        ; CLIV=$208
6934	>e303	8b ef				                .word osbyteEntryPoint       ; BYTEV=$20a
6935	>e305	55 ef				                .word oswordEntryPoint       ; WORDV=$20c
6936	>e307	4d e9				                .word oswrchEntryPoint       ; WRCHV=$20e
6937	>e309	ec e8				                .word osrdchEntryPoint       ; RDCHV=$210
6938	.e30b					fsVectors: .block
6939	>e30b	1b ff				                .word E_FILEV                ; FILEV=$212
6940	>e30d	1e ff				                .word E_ARGSV                ; ARGSV=$214
6941	>e30f	21 ff				                .word E_BGETV                ; BGETV=$216
6942	>e311	24 ff				                .word E_BPUTV                ; BPUTV=$218
6943	>e313	27 ff				                .word E_GBPBV                ; GBPBV=$21a
6944	>e315	2a ff				                .word E_FINDV                ; FINDV=$21c
6945	>e317	2d ff				                .word E_FSCV                 ; FSCV=$21e
6946	.e319					end:
6947						                .bend
6948	>e319	aa ff				                .word rtsFFAA                ; EVENTV=$220
6949	>e31b	aa ff				                .word rtsFFAA                ; UPTV=$222
6950	>e31d	aa ff				                .word rtsFFAA                ; NETV=$224
6951	>e31f	aa ff				                .word rtsFFAA                ; VDUV=$226
6952	>e321	48 f5				                .word keyEntryPoint          ; KEYV=$228
6953	>e323	6e eb				                .word insEntryPoint          ; INSV=$22a
6954	>e325	23 eb				                .word remEntryPoint          ; REMV=$22c
6955	>e327	a6 ea				                .word cnpEntryPoint          ; CNPV=$22e
6956	>e329	aa ff				                .word rtsFFAA                ; IND1V=$230
6957	>e32b	aa ff				                .word rtsFFAA                ; IND2V=$232
6958	>e32d	aa ff				                .word rtsFFAA                ; IND3V=$234
6959	.e32f					end:
6960						                .bend

6962						                ; valueFF is a (presumably arbitrary) byte with the
6963						                ; value 255, that's BIT'd in a few places to set the V
6964						                ; flag.
6965	.e32f					defaultMOSVariables:
6966	>e32f	90 01				                .word mosVariables-166       ;mosVariablesAddress
6967	>e331	9f 0d				                .word extendedVectorSpace    ;extendedVectorSpaceAddress
6968	>e333	a1 02				                .word romInformationTable  ;romInformationTableAddress
6969	>e335	fb f6				                .word keyTranslationTable-16 ;keyboardTranslationTableAddress
6970	>e337	00 03				                .word vduv                   ;vduVariablesAddress
6971	>e339	00				                .byte $00                    ;cfsTimeoutCounter
6972	>e33a	00				                .byte $00                    ;inputSource
6973	>e33b	ff				                .byte $FF                    ;keyboardSemaphore
6974	>e33c	00				                .byte $00                    ;romPollingSemaphore
6975	>e33d	00				                .byte $00                    ;oshwm
6976	>e33e	01				                .byte $01                    ;rs423InputInterpretationStatus
6977	>e33f	00				                .byte $00                    ;noignoreState
6978	>e340	00				                .byte $00                    ;cfsRFSFSSwitch
6979	>e341	00				                .byte $00                    ;vcontrolRegister
6980	>e342	00				                .byte $00                    ;vpaletteRegister
6981	>e343	00				                .byte $00                    ;romActiveAtLastBRK
6982	>e344	ff				                .byte $FF                    ;basicROMNumber
6983						                .if version<500
6986						                .elsif version>=500
6987	>e345	02				                .byte $02                    ;currentADCChannel
6988	>e346	02				                .byte $02                    ;maximumADCChannel
6989						                .endif
6990	>e347	00				                .byte $00                    ;adcConversionType
6991	>e348	ff				                .byte $FF                    ;rs423Busy
6992						                .if version==400
6994						                .else
6995	>e349	42				                .byte $42                    ;aciaControlRegister
6996						                .endif
6997	>e34a	19				                .byte $19                    ;flashCounter
6998	>e34b	19				                .byte $19                    ;firstFlashColourDuration
6999	>e34c	19				                .byte $19                    ;secondFlashColourDuration
7000	>e34d	32				                .byte $32                    ;keyboardAutoRepeatDelay
7001	>e34e	08				                .byte $08                    ;keyboardAutoRepeatRate
7002	>e34f	00				                .byte $00                    ;execFileHandle
7003	>e350	00				                .byte $00                    ;spoolFileHandle
7004	>e351	00				                .byte $00                    ;breakAndESCAPEEffect
7005	>e352	00				                .byte $00                    ;keyboardStatus
7006	>e353	20				                .byte $20                    ;keyboardStatusByte
7007	>e354	09				                .byte $09                    ;rs423InputBufferMinimumSpace
7008	>e355	00				                .byte $00                    ;rs423Ignore
7009	>e356	00				                .byte $00                    ;rs423Destination
7010	>e357	00				                .byte $00                    ;econetInterceptionStatus
7011	>e358	00				                .byte $00                    ;econetInputInterpretationStatus
7012	>e359	00				                .byte $00                    ;econetOutputInterpretationStatus
7013	>e35a	00				                .byte $00                    ;speechSystemByte1
7014	>e35b	00				                .byte $00                    ;soundSuppressionStatus
7015	>e35c	03				                .byte $03                    ;bellChannel
7016	>e35d	90				                .byte $90                    ;bellSound
7017	>e35e	64				                .byte $64                    ;bellFrequency
7018	>e35f	06				                .byte $06                    ;bellDuration
7019	>e360	81				                .byte $81                    ;startupMessageSuppressionStatus
7020	>e361	00				                .byte $00                    ;softKeyStringLength
7021	>e362	00				                .byte $00                    ;pagedModeCounter
7022	>e363	00				                .byte $00                    ;vduQueueNegativeLength
7023	>e364	09				                .byte $09                    ;tabKeyCode
7024	>e365	1b				                .byte $1B                    ;escapeCharacter
7025	>e366	01				                .byte $01                    ;input192To207Interpretation
7026	>e367	d0				                .byte $D0                    ;input208To223Interpretation
7027	>e368	e0				                .byte $E0                    ;input224To239Interpretation
7028	>e369	f0				                .byte $F0                    ;input240To255Interpretation
7029	>e36a	01				                .byte $01                    ;softKeyInterpretation
7030	>e36b	80				                .byte $80                    ;shiftSoftKeyInterpretation
7031	>e36c	90				                .byte $90                    ;ctrlSoftKeyInterpretation
7032	>e36d	00				                .byte $00                    ;shiftCtrlSoftKeyInterpretation
7033	>e36e	00				                .byte $00                    ;escapeKeyStatus
7034	>e36f	00				                .byte $00                    ;escapeEffects
7035	>e370	ff				valueFF:        .byte $FF                    ;userVIAInterruptMask
7036	>e371	ff				                .byte $FF                    ;rs423InterruptMask
7037	>e372	ff				                .byte $FF                    ;systemVIAInterruptMask
7038	>e373	00				                .byte $00                    ;tubePresence
7039	>e374	00				                .byte $00                    ;speechSystemByte2
7040	>e375	00				                .byte $00                    ;characterDestinationStatus
7041	>e376	00				                .byte editKeysMode.editKeys  ;editKeysMode
7042	>e377	30				                .byte $30                    ;numericKeypadInterpretation
7043	>e378	01				                .byte $01                    ;shadowRAMState
7044	>e379	00				                .byte $00                    ;countryFlag
7045	>e37a	00				                .byte $00                    ;userFlag
7046						                .if version==400
7048						                .else
7049	>e37b	64				                .byte $64                    ;serialULARegister
7050						                .endif
7051	>e37c	05				                .byte initialTimerSwitchState ;timerSwitchState
7052	>e37d	ff				                .byte $FF                    ;softKeyConsistencyFlag
7053						                .if version==400
7055						                .else
7056	>e37e	01				                .byte $01                    ;printerDriverType
7057						                .endif
7058	>e37f	0a				                .byte $0a                    ;printerIgnoreChar
7059	>e380	00				                .byte $00                    ;breakVectorByte0
7060	>e381	00				                .byte $00                    ;breakVectorByte1
7061	>e382	00				                .byte $00                    ;breakVectorByte2
7062	>e383	00				                .byte $00                    ;vduDriverMemory
7063	>e384	00				                .byte $00                    ;displayMemory
7064	>e385	ff				                .byte $FF                    ;currentLanguageROM

7066						;-------------------------------------------------------------------------
7067						;
7068						; STARTUP
7069						; =======
7070						;
7071	.e386					resetEntryPoint:                ;e364
7072	.e386	a9 40		lda #$40	                lda #$40        ; $40 = RTI
7073	.e388	8d 00 0d	sta $0d00	                sta nmiEntryPoint ; make NMI routine a no-op
7074	.e38b	78		sei		                sei
7075	.e38c	a9 53		lda #$53	                lda #$53                 ; ???
7076	.e38e	8d 8e fe	sta $fe8e	                sta LFE8E                ; ???
7077						                .if version==350
7083						                .endif
7084						                .if version==350
7087						                .else
7088	.e391	20 a9 e5	jsr $e5a9	                jsr selectTerminalROM ; Page in ROM 15 and continue
7089	.e394	4c 1d 80	jmp $801d	                jmp terminal.reset
7090						                .endif

7092						;-------------------------------------------------------------------------

7094						                .if version==350
7101						                .endif

7103						;-------------------------------------------------------------------------
7104						;
7105						; Check if a coprocessor is attached to the Tube
7106						;
7107						; exit:
7108						;
7109						; C=0 = no Tube
7110						;
7111						; C=1 = Tube
7112						;
7113						                .if version!=350
7114	.e397					LE375:
7115	.e397	a2 01		ldx #$01	                ldx #$01
7116	.e399	8e e0 fe	stx $fee0	                stx tube.status1
7117	.e39c	ad e0 fe	lda $fee0	                lda tube.status1
7118	.e39f	49 01		eor #$01	                eor #$01
7119	.e3a1	a2 81		ldx #$81	                ldx #$81
7120	.e3a3	8e e0 fe	stx $fee0	                stx tube.status1
7121	.e3a6	2d e0 fe	and $fee0	                and tube.status1       ; Cy=0 if no Tube, Cy=1 if Tube
7122	.e3a9	6a		ror a		                ror a
7123	.e3aa	60		rts		                rts
7124						                .endif

7126						;-------------------------------------------------------------------------
7127						;
7128						;
7129						;
7130						                .if version==350
7133						                .endif

7135	.e3ab					LE389:
7136	.e3ab	5a		phy		                phy
7137	.e3ac	da		phx		                phx
7138						                .if version==350
7148						                .elsif version>=500
7149	.e3ad	20 a9 e5	jsr $e5a9	                jsr selectTerminalROM
7150	.e3b0	20 3f 87	jsr $873f	                jsr terminal.L873F
7151						                .endif
7152	.e3b3	c9 01		cmp #$01	                cmp #$01                     ;C set if ROM is inserted
7153	.e3b5	fa		plx		                plx
7154	.e3b6	7a		ply		                ply
7155	.e3b7	4c 9a e5	jmp $e59a	                jmp selectROMX

7157						;-------------------------------------------------------------------------
7158						;
7159						; Scan ROMs and fill in the rom information table.
7160						;
7161						; entry:
7162						;
7163						; X = first ROM to scan
7164						;
7165						                .if version!=350
7166	.e3ba					scanROMs: .proc
7167						                .include "scan_roms.s65"

:16	;******  Processing file: src/scan_roms.s65

1	.e3ba	8a		txa		                txa               ;A = ROM of interest
2	.e3bb	a8		tay		                tay               ;Y = ROM of interest
3						                .if version<500&&version!=350
6						                .endif
7	.e3bc	20 1e e4	jsr $e41e	                jsr isROMValid
8	.e3bf	90 35		bcc $e3f6	                bcc currentROMInvalid        ;taken if ROM invalid
9	.e3c1	a6 f4		ldx $f4		                ldx $F4                      ;start from current ROM
10	.e3c3	a4 f4		ldy $f4		                ldy $F4                      ;start from current ROM
11	.e3c5					nextOtherROM:
12	.e3c5	c8		iny		                iny                          ;next other ROM
13	.e3c6	c0 10		cpy #$10	                cpy #$10                     ;out of other ROMs?
14	.e3c8	b0 30		bcs $e3fa	                bcs currentROMValid       ;taken if no more other ROMs
15						                .if version<500&&version!=350
18						                .endif
19						                .if version==350
23						                .else
24						                ; Start address is $8000-Y, so that there's no need to
25						                ; save Y.
26	.e3ca	98		tya		                tya
27	.e3cb	49 ff		eor #$ff	                eor #$FF
28	.e3cd	85 fa		sta $fa		                sta SEIWKA+0
29	.e3cf	a9 7f		lda #$7f	                lda #$7F
30	.e3d1	85 fb		sta $fb		                sta SEIWKA+1
31						                .endif
32	.e3d3					compareLoop:
33	.e3d3	8c 30 fe	sty $fe30	                sty ROMSEL                   ;select other ROM
34						                .if version==350
36						                .else
37	.e3d6	b1 fa		lda ($fa),y	                lda (SEIWKA),y               ;get byte from other ROM
38						                .endif
39	.e3d8	8e 30 fe	stx $fe30	                stx ROMSEL                   ;select ROM
40						                .if version==350
42						                .else
43	.e3db	d1 fa		cmp ($fa),y	                cmp (SEIWKA),y               ;same as other ROM?
44						                .endif
45	.e3dd	d0 e6		bne $e3c5	                bne nextOtherROM             ;taken if other ROM is good
46	.e3df	e6 fa		inc $fa		                inc SEIWKA+0
47	.e3e1	d0 f0		bne $e3d3	                bne compareLoop
48	.e3e3	e6 fb		inc $fb		                inc SEIWKA+1
49	.e3e5	a5 fb		lda $fb		                lda SEIWKA+1
50						                .if version>=500
51	.e3e7	e0 08		cpx #$08	                cpx #8
52	.e3e9	90 02		bcc $e3ed	                bcc +
53	.e3eb	69 02		adc #$02	                adc #2
54	.e3ed					+
55						                .endif
56	.e3ed	c9 84		cmp #$84	                cmp #$84                  ;compare only the first 1 KB
57	.e3ef	90 e2		bcc $e3d3	                bcc compareLoop
58						                ; The first 1 KB of the current ROM matches the first
59						                ; 1 KB of some higher-priority ROM, so the current ROM
60						                ; is invalid.
61						                .if version>=500||version==350
62	.e3f1	a9 01		lda #$01	                lda #1
63	.e3f3	9d a1 02	sta $02a1,x	                sta romInformationTable,x
64						                .endif

66	.e3f6					currentROMInvalid:
67	.e3f6	a6 f4		ldx $f4		                ldx $F4
68	.e3f8	80 19		bra $e413	                bra nextROM

70	.e3fa					currentROMValid:
71						                .if version>=500||version==350
72	.e3fa	8a		txa		                txa
73	.e3fb	a8		tay		                tay
74						                .if version==350
76						                .else
77	.e3fc	20 ab e3	jsr $e3ab	                jsr LE389
78						                .endif
79	.e3ff	90 12		bcc $e413	                bcc nextROM
80						                .endif
81	.e401	ad 06 80	lda $8006	                lda $8006
82	.e404	9d a1 02	sta $02a1,x	                sta romInformationTable,x
83	.e407	29 8f		and #$8f	                and #$8F
84	.e409	d0 08		bne $e413	                bne nextROM       ;taken if any mandatory bits are set

86						                ; A bogus ROM type means this ROM is the BASIC ROM.
87						                .if version>=500&&version!=350
88	.e40b	2c 4b 02	bit $024b	                bit basicROMNumber
89	.e40e	10 03		bpl $e413	                bpl nextROM
90						                .endif

92	.e410	8e 4b 02	stx $024b	                stx basicROMNumber

94	.e413					nextROM:
95	.e413	e8		inx		                inx
96	.e414	e0 10		cpx #$10	                cpx #$10
97	.e416	90 a2		bcc $e3ba	                bcc scanROMs
98	.e418	20 a9 e5	jsr $e5a9	                jsr selectTerminalROM


:15	;******  Return to file: src/mos.s65

7168	.e41b	4c 55 82	jmp $8255	                jmp terminal.romsScanned     ;not sure why not RTS.
7169						                .endproc
7170						                .endif

7172						;-------------------------------------------------------------------------
7173						;
7174						; Checks a ROM is valid - i.e., has a valid-looking copyright string.
7175						;
7176						; Entry:
7177						;
7178						; X = ROM to check
7179						;
7180						; Exit:
7181						;
7182						; C=0 if ROM invalid; C=1 if ROM valid
7183						;
7184						; ROM of interest is selected
7185						;
7186	.e41e					isROMValid: .proc ;e3f7
7187	.e41e	20 9a e5	jsr $e59a	                jsr selectROMX
7188	.e421	a2 03		ldx #$03	                ldx #$03
7189	.e423	ac 07 80	ldy $8007	                ldy $8007       ; fetch ROM copyright offset pointer
7190	.e426	18		clc		                clc             ; assume no match
7191	.e427					-
7192	.e427	b9 00 80	lda $8000,y	                lda $8000,y     ; fetch possible ROM copyright char
7193	.e42a	5d 2c e5	eor $e52c,x	                eor sidewaysROMCopyrightPrefix,x     ; Z=1 if it matches "\x0(C)"
7194	.e42d	d0 05		bne $e434	                bne +           ; branch taken if no match
7195	.e42f	c8		iny		                iny             ; next copyright byte
7196	.e430	ca		dex		                dex             ; count 4 chars
7197	.e431	10 f4		bpl $e427	                bpl -
7198	.e433	38		sec		                sec             ; C=1 means a match
7199	.e434					+
7200	.e434	60		rts		                rts
7201						                .pend

7203						;-------------------------------------------------------------------------

7205						; End of STARTUP code
7206						; ===================
7207	.e435					LE40E:
7208	.e435	38		sec		                sec                      ; Call Break Intercept Vector
7209						                .if version==350
7211						                .else
7212	.e436	20 0e f4	jsr $f40e	                jsr osbyte247EntryPoint
7213						                .endif
7214	.e439	a2 27		ldx #$27	                ldx #romServiceCallInformReset
7215	.e43b	20 f8 ee	jsr $eef8	                jsr makeROMServiceCall
7216	.e43e	ac 56 02	ldy $0256	                ldy execFileHandle ; Get Exec handle, skip past if closed
7217	.e441	f0 08		beq $e44b	                beq LE424
7218	.e443	9c 56 02	stz $0256	                stz execFileHandle           ; Clear Exec handle
7219	.e446	a9 00		lda #$00	                lda #$00                     ; Close Exec channel
7220	.e448	20 ce ff	jsr $ffce	                jsr OSFIND
7221	.e44b					LE424:
7222	.e44b	38		sec		                sec                          ;
7223	.e44c	6e 00 df	ror $df00	                ror hazel.currentFS
7224	.e44f	ad 8d 02	lda $028d	                lda lastBREAKType            ; Soft Break
7225	.e452	f0 04		beq $e458	                beq LE431
7226	.e454	38		sec		                sec                          ;
7227	.e455	6e 02 df	ror $df02	                ror hazel.libFS
7228	.e458					LE431:
7229	.e458	20 ea ee	jsr $eeea	                jsr LEE64                    ; Set default ROMFS/TAPEFS settings
7230	.e45b	20 de f2	jsr $f2de	                jsr osbyte76                    ; Test Shift and Ctrl keys
7231						                .if version==350
7233						                .else
7234	.e45e	4a		lsr a		                lsr a                        ; Move SHIFT status from b7 to b3
7235	.e45f	4a		lsr a		                lsr a
7236	.e460	4a		lsr a		                lsr a
7237	.e461	4a		lsr a		                lsr a
7238						                .endif
7239	.e462	4d 8f 02	eor $028f	                eor startupOptions ; Toggle with OSBYTE 255 boot status
7240	.e465	29 08		and #$08	                and #$08
7241	.e467	a8		tay		                tay
7242	.e468	ae 03 df	ldx $df03	                ldx hazel.currentFSROM
7243	.e46b	ad 8d 02	lda $028d	                lda lastBREAKType ; Soft Break, use current filing system
7244	.e46e	f0 09		beq $e479	                beq LE454
7245	.e470	20 a9 e5	jsr $e5a9	                jsr selectTerminalROM
7246						                .if version<500&&version!=350
7251						                .else
7252	.e473	a2 33		ldx #$33	                ldx #terminal.configureTable.file.metadata-terminal.configureTable
7253	.e475	20 64 8a	jsr $8a64	                jsr terminal.readConfigurationByte
7254						                .endif

7256	.e478	aa		tax		                tax
7257	.e479					LE454:
7258	.e479	3c a1 02	bit $02a1,x	                bit romInformationTable,x
7259	.e47c	10 1f		bpl $e49d	                bpl LE478
7260	.e47e	20 9a e5	jsr $e59a	                jsr selectROMX
7261	.e481	e0 0f		cpx #$0f	                cpx #terminalROM
7262	.e483	d0 0c		bne $e491	                bne LE46C
7263	.e485	20 89 f7	jsr $f789	                jsr osbyte7A
7264	.e488	e8		inx		                inx
7265	.e489	f0 19		beq $e4a4	                beq LE47F
7266	.e48b	e0 63		cpx #$63	                cpx #$63
7267	.e48d	f0 15		beq $e4a4	                beq LE47F
7268	.e48f	80 0c		bra $e49d	                bra LE478

7270	.e491					LE46C:
7271	.e491	a9 03		lda #$03	                lda #romServiceCallAutoBoot  ; Filing System selection
7272	.e493	20 03 80	jsr $8003	                jsr $8003
7273	.e496	aa		tax		                tax
7274	.e497	20 a9 e5	jsr $e5a9	                jsr selectTerminalROM
7275	.e49a	8a		txa		                txa
7276	.e49b	f0 2a		beq $e4c7	                beq LE4A3
7277	.e49d					LE478:
7278	.e49d	a2 03		ldx #$03	                ldx #romServiceCallAutoBoot
7279	.e49f	20 f8 ee	jsr $eef8	                jsr makeROMServiceCall
7280	.e4a2	f0 23		beq $e4c7	                beq LE4A3
7281	.e4a4					LE47F:
7282	.e4a4	98		tya		                tya
7283	.e4a5	d0 17		bne $e4be	                bne LE499
7284	.e4a7	a9 8d		lda #$8d	                lda #$8D
7285	.e4a9	20 20 ee	jsr $ee20	                jsr osbyte8C8D
7286	.e4ac	a2 d4		ldx #$d4	                ldx #<starRunBOOT
7287	.e4ae	a0 f4		ldy #$f4	                ldy #>starRunBOOT
7288	.e4b0	ce 67 02	dec $0267	                dec startupMessageSuppressionStatus
7289	.e4b3	20 f7 ff	jsr $fff7	                jsr OSCLI
7290	.e4b6	ee 67 02	inc $0267	                inc startupMessageSuppressionStatus
7291	.e4b9	80 0c		bra $e4c7	                bra LE4A3

7293						;-------------------------------------------------------------------------

7295	.e4bb					LE496:
7296	.e4bb	ee 67 02	inc $0267	                inc startupMessageSuppressionStatus ;set bit 0
7297	.e4be					LE499:
7298	.e4be	38		sec		                sec
7299	.e4bf	6e 00 df	ror $df00	                ror hazel.currentFS
7300						                .if version<400
7306						                .elsif version>=500
7307	.e4c2	a9 8d		lda #$8d	                lda #$8d
7308	.e4c4	20 20 ee	jsr $ee20	                jsr osbyte8C8D
7309						                .endif
7310	.e4c7					LE4A3:
7311	.e4c7	a9 05		lda #$05	                lda #$05                     ;
7312	.e4c9	ae 85 02	ldx $0285	                ldx printerDriverType        ; *FX5,<current printer>
7313	.e4cc	20 8b ef	jsr $ef8b	                jsr osbyteEntryPoint
7314	.e4cf	ad 8d 02	lda $028d	                lda lastBREAKType ; If not Soft Break, select default language
7315	.e4d2	d0 0b		bne $e4df	                bne LE4BB
7316	.e4d4	ae 8c 02	ldx $028c	                ldx currentLanguageROM      ; Get current language ROM
7317						                .if version==350&&!finmos329
7321						                .else
7322	.e4d7	e0 10		cpx #$10	                cpx #$10                     ; <16, normal ROM number, use it
7323						                .endif
7324	.e4d9	90 0d		bcc $e4e8	                bcc LE4C2
7325						                .if version==350&&!finmos329
7327						                .else
7328	.e4db	e0 1f		cpx #$1f	                cpx #$1F                     ; 16+UTILS ROM, re-enter Supervisor or Tube CLI
7329						                .endif
7330	.e4dd	f0 49		beq $e528	                beq LE509
7331	.e4df					LE4BB:
7332	.e4df	20 a9 e5	jsr $e5a9	                jsr selectTerminalROM     ; Page in ROM 15 - UTILS ROM
7333						                .if version<500&&version!=350
7335						                .else
7336	.e4e2	a2 41		ldx #$41	                ldx #terminal.configureTable.lang.metadata-terminal.configureTable
7337	.e4e4	20 64 8a	jsr $8a64	                jsr terminal.readConfigurationByte
7338						                .endif
7339	.e4e7	aa		tax		                tax
7340	.e4e8					LE4C2:
7341	.e4e8	18		clc		                clc

7343						;-------------------------------------------------------------------------
7344						;
7345						; OSBYTE 142 (&8E) Enter language ROM [MasRef D.2-44]
7346						;
7347	.e4e9					osbyte8E:
7348						                .if version==350
7353						                .endif
7354	.e4e9	3c a1 02	bit $02a1,x	                bit romInformationTable,x ; b6=0, error Not a language
7355						                .if version==350
7357						                .endif
7358	.e4ec	50 41		bvc $e52f	                bvc thisIsNotALanguageError
7359	.e4ee	08		php		                php
7360	.e4ef	90 16		bcc $e507	                bcc LE4E1 ;taken if not OSBYTE 142 - so skip ROM check
7361	.e4f1	20 9a e5	jsr $e59a	                jsr selectROMX
7362	.e4f4	ad 06 80	lda $8006	                lda sidewaysROMType
7363	.e4f7	29 0d		and #$0d	                and #%00001101
7364	.e4f9	f0 05		beq $e500	                beq is6502ROM ;taken if low nybble is 0 (6502 BASIC) or 2 (other 6502 ROM)
7365	.e4fb	2c 7a 02	bit $027a	                bit tubePresence
7366	.e4fe	10 47		bpl $e547	                bpl iCannotRunThisCodeError  ;taken if no Tube - assume impossible to run
7367	.e500					is6502ROM:
7368	.e500	da		phx		                phx                          ;save ROM slot
7369	.e501	a2 2a		ldx #$2a	                ldx #romServiceCallLanguageChange
7370	.e503	20 f8 ee	jsr $eef8	                jsr makeROMServiceCall
7371	.e506	fa		plx		                plx                          ;restore ROM slot
7372	.e507					LE4E1:
7373	.e507	8e 8c 02	stx $028c	                stx currentLanguageROM
7374	.e50a	20 9a e5	jsr $e59a	                jsr selectROMX
7375	.e50d	a9 80		lda #$80	                lda #>sidewaysROMName
7376	.e50f	a0 08		ldy #$08	                ldy #(<sidewaysROMName)-1
7377	.e511	20 7d e7	jsr $e77d	                jsr print0TerminatedString
7378	.e514	84 fd		sty $fd		                sty errPtr+0
7379	.e516	20 e7 ff	jsr $ffe7	                jsr OSNEWL
7380	.e519	20 e7 ff	jsr $ffe7	                jsr OSNEWL
7381	.e51c	28		plp		                plp
7382						                .if version<500
7386						                .endif
7387	.e51d	ad 06 80	lda $8006	                lda sidewaysROMType
7388	.e520	29 0d		and #$0d	                and #%00001101
7389	.e522	d0 23		bne $e547	                bne iCannotRunThisCodeError ;taken if low nybble isn't 0 (6502 BASIC) or 2 (other 6502 ROM)
7390	.e524	1a		inc a		                inc a                       ;
7391	.e525	4c 00 80	jmp $8000	                jmp sidewaysROMLanguageEntry

7393	.e528					LE509:
7394	.e528	a9 00		lda #$00	                lda #$00
7395						                .if version<500
7400						                .elsif version>=500
7401	.e52a	80 66		bra $e592	                bra startCommandLineUI
7402						                .endif

7404						;-------------------------------------------------------------------------

7406	.e52c					sidewaysROMCopyrightPrefix: .block
7407	>e52c	29 43 28			                .text ")C("
7408	.e52f					end:
7409						                .endblock

7411						;-------------------------------------------------------------------------

7413	.e52f					thisIsNotALanguageError:
7414	.e52f	00		brk #		                brk
7415	>e530	00 54 68 69 73 20 69 73		                .text 0,"This is not a language"
	>e538	20 6e 6f 74 20 61 20 6c 61 6e 67 75 61 67 65

7417						;-------------------------------------------------------------------------

7419	.e547					iCannotRunThisCodeError:
7420	.e547	00		brk #		                brk
7421	>e548	00 49 20 63 61 6e 6e 6f		                .text 0,"I cannot run this code",0
	>e550	74 20 72 75 6e 20 74 68 69 73 20 63 6f 64 65 00

7423						;-------------------------------------------------------------------------
7424						;
7425						; OSBYTE 164 (&A4) Check processor type [MasRef D.2-50]
7426						;
7427	.e560					osbyteA4:
7428	.e560	a2 03		ldx #$03	                ldx #sidewaysROMCopyrightPrefix.end-sidewaysROMCopyrightPrefix
7429	.e562	a0 07		ldy #$07	                ldy #<sidewaysROMCopyrightOffset
7430	.e564	b1 f0		lda ($f0),y	                lda (originalX),y
7431	.e566	a8		tay		                tay
7432	.e567					-
7433	.e567	b1 f0		lda ($f0),y	                lda (originalX),y
7434	.e569	dd 2c e5	cmp $e52c,x	                cmp sidewaysROMCopyrightPrefix,x
7435	.e56c	d0 0f		bne $e57d	                bne rtsE564 ;taken if (C) not found - must be OK, if it's not a ROM?
7436	.e56e	c8		iny		                iny
7437	.e56f	ca		dex		                dex
7438	.e570	10 f5		bpl $e567	                bpl -
7439	.e572	a0 06		ldy #$06	                ldy #<sidewaysROMType
7440	.e574	b1 f0		lda ($f0),y	                lda (originalX),y
7441	.e576	0a		asl a		                asl a
7442	.e577	10 b6		bpl $e52f	                bpl thisIsNotALanguageError ;taken if no language entry point
7443	.e579	29 1a		and #$1a	                and #%00001101<<1
7444	.e57b	d0 ca		bne $e547	                bne iCannotRunThisCodeError ;taken if low nybble wasn't 0 (6502 BASIC) or 2 (other 6502 ROM)
7445	.e57d					rtsE564:
7446	.e57d	60		rts		                rts

7448						;-------------------------------------------------------------------------

7450						                .if version==350
7457						                .endif

7459						;-------------------------------------------------------------------------

7461						                .if version==350
7467						                .endif

7469						;-------------------------------------------------------------------------

7471	.e57e					defaultBRKHandler:
7472	.e57e	a0 00		ldy #$00	                ldy #$00
7473	.e580	20 81 e7	jsr $e781	                jsr printBRKMessage
7474	.e583	20 e7 ff	jsr $ffe7	                jsr OSNEWL
7475	.e586	ad 67 02	lda $0267	                lda startupMessageSuppressionStatus
7476	.e589	6a		ror a		                ror a
7477	.e58a	b0 06		bcs $e592	                bcs startCommandLineUI                   ;taken if bit 0 was set
7478	.e58c	20 e7 ff	jsr $ffe7	                jsr OSNEWL
7479	.e58f	4c bb e4	jmp $e4bb	                jmp LE496

7481						;-------------------------------------------------------------------------

7483	.e592					startCommandLineUI:
7484	.e592	20 a9 e5	jsr $e5a9	                jsr selectTerminalROM
7485	.e595	4c 74 86	jmp $8674	                jmp terminal.commandLineUI

7487						;-------------------------------------------------------------------------
7488						;
7489						; Select paged ROM bank 15 - TERMINAL - with ANDY paged in,
7490						;
7491						; Preserves A/Y
7492	.e598					selectTerminalROMAndANDY:   ;e57f
7493	.e598	a2 8f		ldx #$8f	                ldx #$80|terminalROM
7494						                ; fall through into selectROMX

7496						;-------------------------------------------------------------------------
7497						;-------------------------------------------------------------------------
7498						;
7499						; Select paged ROM bank.
7500						;
7501						; Entry:
7502						;
7503						; X = bank to select.
7504						;
7505						; Preserves A/X/Y/P
7506	.e59a					selectROMX:   ;e581
7507	.e59a	86 f4		stx $f4		                stx $F4
7508	.e59c	8e 30 fe	stx $fe30	                stx ROMSEL
7509	.e59f	60		rts		                rts

7511						;-------------------------------------------------------------------------
7512						;
7513	.e5a0					isROMValidThenSelectTerminalROM:
7514	.e5a0	5a		phy		                phy
7515	.e5a1	20 1e e4	jsr $e41e	                jsr isROMValid
7516	.e5a4	20 a9 e5	jsr $e5a9	                jsr selectTerminalROM
7517	.e5a7	7a		ply		                ply
7518	.e5a8	60		rts		                rts

7520						;-------------------------------------------------------------------------
7521						;
7522						; Select paged ROM bank 15 - TERMINAL.
7523						;
7524						; Preserves X/Y
7525	.e5a9					selectTerminalROM:            ;e590
7526	.e5a9	a9 0f		lda #$0f	                lda #terminalROM
7527						                ; fall through into selectROMA

7529						;-------------------------------------------------------------------------
7530						;
7531						; Select paged ROM bank.
7532						;
7533						; A = bank to select.
7534						;
7535						; Preserves A/X/Y/P
7536	.e5ab					selectROMA:                   ;e592
7537	.e5ab	85 f4		sta $f4		                sta $F4         ;update ROMSEL copy
7538	.e5ad	8d 30 fe	sta $fe30	                sta ROMSEL
7539	.e5b0	60		rts		                rts

7541						;-------------------------------------------------------------------------
7542						;
7543						; Select paged ROM bank 15 - TERMINAL - with ANDY paged in,
7544						;
7545						; Preserves A/X/Y

7547	.e5b1					selectTerminalROMAndANDY2:
7548	.e5b1	da		phx		                phx
7549	.e5b2	20 98 e5	jsr $e598	                jsr selectTerminalROMAndANDY
7550	.e5b5	fa		plx		                plx
7551	.e5b6	60		rts		                rts

7553						;-------------------------------------------------------------------------

7555	.e5b7					irqEntryPoint:
7556	.e5b7	85 fc		sta $fc		                sta irqTempA
7557	.e5b9	68		pla		                pla                          ;restore P
7558	.e5ba	48		pha		                pha                          ;save P
7559	.e5bb	29 10		and #$10	                and #$10
7560	.e5bd	d0 03		bne $e5c2	                bne brkEntryPoint
7561	.e5bf	6c 04 02	jmp ($0204)	                jmp (IRQ1V)

7563	.e5c2					brkEntryPoint:
7564	.e5c2	da		phx		                phx
7565	.e5c3	ba		tsx		                tsx
7566	.e5c4	bd 03 01	lda $0103,x	                lda $0103,x                  ;get BRK address+1 LSB
7567	.e5c7	d8		cld		                cld                          ;
7568	.e5c8	38		sec		                sec                          ;
7569	.e5c9	e9 01		sbc #$01	                sbc #$01                     ;get BRK address LSB
7570	.e5cb	85 fd		sta $fd		                sta errPtr+0
7571	.e5cd	bd 04 01	lda $0104,x	                lda $0104,x                  ;get BRK address+1 MSB
7572	.e5d0	e9 00		sbc #$00	                sbc #$00                     ;get BRK address MSB
7573	.e5d2	85 fe		sta $fe		                sta errPtr+1
7574	.e5d4	a5 f4		lda $f4		                lda $F4
7575	.e5d6	8d 4a 02	sta $024a	                sta romActiveAtLastBRK
7576	.e5d9	86 f0		stx $f0		                stx originalX
7577	.e5db	a2 06		ldx #$06	                ldx #romServiceCallBreakInstruction
7578	.e5dd	20 f8 ee	jsr $eef8	                jsr makeROMServiceCall
7579	.e5e0	ae 8c 02	ldx $028c	                ldx currentLanguageROM
7580	.e5e3	20 9a e5	jsr $e59a	                jsr selectROMX
7581	.e5e6	fa		plx		                plx
7582	.e5e7	a5 fc		lda $fc		                lda irqTempA
7583	.e5e9	58		cli		                cli
7584	.e5ea	6c 02 02	jmp ($0202)	                jmp (BRKV)

7586						;-------------------------------------------------------------------------

7588						                .if version!=400
7589	.e5ed					LE5D4:
7590	.e5ed	38		sec		                sec
7591	.e5ee	6e 4f 02	ror $024f	                ror rs423Busy
7592	.e5f1	2c 50 02	bit $0250	                bit aciaControlRegister
7593	.e5f4	10 07		bpl $e5fd	                bpl LE5E4
7594	.e5f6	20 b7 ed	jsr $edb7	                jsr getRS423InputBufferFreeBytes
7595	.e5f9	a2 00		ldx #$00	                ldx #$00
7596	.e5fb	b0 02		bcs $e5ff	                bcs LE5E6
7597	.e5fd					LE5E4:
7598	.e5fd	a2 40		ldx #$40	                ldx #$40
7599	.e5ff					LE5E6:
7600	.e5ff	4c 3d ea	jmp $ea3d	                jmp resetACIA

7602	.e602					LE5E9:
7603	.e602	ac 09 fe	ldy $fe09	                ldy ACIA+1
7604	.e605	29 3a		and #$3a	                and #$3A
7605	.e607	d0 3b		bne $e644	                bne LE628
7606	.e609	ae 5c 02	ldx $025c	                ldx rs423Ignore
7607	.e60c	d0 09		bne $e617	                bne LE5FE
7608	.e60e	e8		inx		                inx
7609	.e60f	20 ab eb	jsr $ebab	                jsr osbyte99
7610	.e612	20 b7 ed	jsr $edb7	                jsr getRS423InputBufferFreeBytes
7611	.e615	90 e6		bcc $e5fd	                bcc LE5E4
7612	.e617					LE5FE:
7613	.e617	60		rts		                rts
7614						                .endif

7616						;-------------------------------------------------------------------------

7618	.e618					irq1EntryPoint:
7619	.e618	a5 fc		lda $fc		                lda irqTempA
7620	.e61a	48		pha		                pha
7621	.e61b	da		phx		                phx
7622	.e61c	5a		phy		                phy
7623						                .if version!=400
7624	.e61d	b8		clv		                clv
7625						                .endif
7626	.e61e	20 28 e6	jsr $e628	                jsr irq1Handler
7627	.e621	7a		ply		                ply
7628	.e622	fa		plx		                plx
7629	.e623	68		pla		                pla
7630	.e624	40		rti		                rti

7632						;-------------------------------------------------------------------------

7634	.e625					irq2EntryPoint:
7635	.e625	a5 fc		lda $fc		                lda irqTempA
7636	.e627	40		rti		                rti

7638						;-------------------------------------------------------------------------

7640						                .if version==400
7643						                .else
7644	.e628					irq1Handler:
7645	.e628	ad 08 fe	lda $fe08	                lda ACIA+0
7646						                .if version>=500
7647	.e62b	2d 78 02	and $0278	                and rs423InterruptMask
7648						                .endif
7649	.e62e	70 02		bvs $e632	                bvs LE616
7650	.e630	10 59		bpl $e68b	                bpl checkForSystemVIAInterrupt
7651	.e632					LE616:
7652	.e632	a6 ea		ldx $ea		                ldx $EA
7653	.e634	ca		dex		                dex
7654	.e635	30 33		bmi $e66a	                bmi LE64E
7655	.e637	70 30		bvs $e669	                bvs rtsE64D
7656	.e639	20 50 f4	jsr $f450	                jsr withTerminalROM
7657	.e63c	4c 64 a8	jmp $a864	                jmp terminal.LA45D

7659	.e63f					LE623:
7660	.e63f	ac 09 fe	ldy $fe09	                ldy ACIA+1
7661	.e642	2a		rol a		                rol a
7662	.e643	0a		asl a		                asl a
7663	.e644					LE628:
7664	.e644	aa		tax		                tax
7665	.e645	98		tya		                tya
7666	.e646	a0 07		ldy #$07	                ldy #$07
7667	.e648	4c 53 eb	jmp $eb53	                jmp eventEntryPoint

7669	.e64b					LE62F:
7670	.e64b	a2 02		ldx #$02	                ldx #$02
7671	.e64d	20 1f eb	jsr $eb1f	                jsr osbyte91
7672	.e650	90 10		bcc $e662	                bcc LE646
7673	.e652	ad 85 02	lda $0285	                lda printerDriverType
7674	.e655	c9 02		cmp #$02	                cmp #$02
7675	.e657	d0 94		bne $e5ed	                bne LE5D4
7676	.e659	e8		inx		                inx
7677	.e65a	20 1f eb	jsr $eb1f	                jsr osbyte91
7678	.e65d	6e d1 02	ror $02d1	                ror bufferEmptyFlags+bufferPrinter
7679	.e660	30 8b		bmi $e5ed	                bmi LE5D4
7680	.e662					LE646:
7681	.e662	8d 09 fe	sta $fe09	                sta ACIA+1
7682	.e665	a9 e7		lda #$e7	                lda #$E7
7683	.e667	85 ea		sta $ea		                sta $EA
7684	.e669					rtsE64D:
7685	.e669	60		rts		                rts

7687	.e66a					LE64E:
7688						                .if version<500
7690						                .endif
7691	.e66a	4a		lsr a		                lsr a
7692	.e66b	90 07		bcc $e674	                bcc LE65B
7693	.e66d	70 05		bvs $e674	                bvs LE65B
7694	.e66f	ac 50 02	ldy $0250	                ldy aciaControlRegister
7695	.e672	30 8e		bmi $e602	                bmi LE5E9
7696	.e674					LE65B:
7697	.e674	4a		lsr a		                lsr a
7698	.e675	6a		ror a		                ror a
7699	.e676	b0 c7		bcs $e63f	                bcs LE623
7700	.e678	30 d1		bmi $e64b	                bmi LE62F
7701	.e67a	70 ed		bvs $e669	                bvs rtsE64D
7702						                .endif

7704						;-------------------------------------------------------------------------

7706	.e67c					handleUnrecogisedInterrupt:
7707	.e67c	a2 05		ldx #$05	                ldx #romServiceCallUnrecognisedInterrupt
7708	.e67e	20 f8 ee	jsr $eef8	                jsr makeROMServiceCall
7709	.e681	f0 e6		beq $e669	                beq rtsE64D                  ;taken if handled

7711						                ; Pass unrecognised, unhandled interrupts to IRQ2V.
7712	.e683	68		pla		                pla
7713	.e684	68		pla		                pla
7714	.e685	7a		ply		                ply
7715	.e686	fa		plx		                plx
7716	.e687	68		pla		                pla
7717						                .if version==350
7719						                .endif
7720	.e688	6c 06 02	jmp ($0206)	                jmp (IRQ2V)

7722						;-------------------------------------------------------------------------

7724						                .if version==400
7726						                .else
7727	.e68b					checkForSystemVIAInterrupt:
7728						                .endif
7729	.e68b	ad 4d fe	lda $fe4d	                lda systemVIA.ifr
7730						                .if version==400
7732						                .else
7733	.e68e	10 3c		bpl $e6cc	                bpl checkForUserVIAInterrupt
7734						                .endif
7735	.e690	2d 79 02	and $0279	                and systemVIAInterruptMask
7736	.e693	2d 4e fe	and $fe4e	                and systemVIA.ier
7737	.e696	89 02		bit #$02	                bit #VIA.irq.ca1
7738	.e698	f0 54		beq $e6ee	                beq checkForSystemVIAT1Interrupt

7740						                ; Handle CA1 interrupt - CRTC vsync.

7742	.e69a	ce 40 02	dec $0240	                dec cfsTimeoutCounter
7743						                .if version!=400
7744	.e69d	a5 ea		lda $ea		                lda $EA
7745	.e69f	10 02		bpl $e6a3	                bpl +
7746	.e6a1	e6 ea		inc $ea		                inc $EA
7747	.e6a3					+
7748						                .endif
7749	.e6a3	ad 51 02	lda $0251	                lda flashCounter
7750	.e6a6	f0 1a		beq $e6c2	                beq flashDone                    ;taken if no flash
7751	.e6a8	ce 51 02	dec $0251	                dec flashCounter             ;count down
7752	.e6ab	d0 15		bne $e6c2	                bne flashDone
7753	.e6ad	ae 52 02	ldx $0252	                ldx firstFlashColourDuration ;assume first flash colour is next
7754	.e6b0	ad 48 02	lda $0248	                lda vcontrolRegister
7755	.e6b3	4a		lsr a		                lsr a                        ;C=flash bit
7756	.e6b4	90 03		bcc $e6b9	                bcc +                        ;taken if first flash colour is next
7757	.e6b6	ae 53 02	ldx $0253	                ldx secondFlashColourDuration ;actually, second flash colour is next
7758	.e6b9					+
7759	.e6b9	2a		rol a		                rol a                        ;reinstate old register value
7760	.e6ba	49 01		eor #$01	                eor #VCONTROL.flash          ;toggle flash bit
7761	.e6bc	20 fe f2	jsr $f2fe	                jsr setVCONTROL
7762	.e6bf	8e 51 02	stx $0251	                stx flashCounter
7763	.e6c2					flashDone:
7764	.e6c2	a0 04		ldy #$04	                ldy #eventStartOfVerticalSync
7765	.e6c4	20 53 eb	jsr $eb53	                jsr eventEntryPoint
7766	.e6c7	a9 02		lda #$02	                lda #VIA.irq.ca1
7767						                .if version==400
7769						                .else
7770	.e6c9	4c 6f e7	jmp $e76f	                jmp staSystemVIAIFR          ;acknowledge CA1
7771						                .endif

7773						                .if version!=400
7774	.e6cc					checkForUserVIAInterrupt:
7775	.e6cc	ad 6d fe	lda $fe6d	                lda userVIA.ifr
7776	.e6cf	10 ab		bpl $e67c	                bpl handleUnrecogisedInterrupt
7777	.e6d1	2d 77 02	and $0277	                and userVIAInterruptMask
7778	.e6d4	2d 6e fe	and $fe6e	                and userVIA.ier
7779	.e6d7	6a		ror a		                ror a                        ;C=CA2
7780	.e6d8	6a		ror a		                ror a                        ;C=CA1
7781	.e6d9	90 a1		bcc $e67c	                bcc handleUnrecogisedInterrupt
7782	.e6db	ac 85 02	ldy $0285	                ldy printerDriverType
7783	.e6de	88		dey		                dey
7784	.e6df	d0 9b		bne $e67c	                bne handleUnrecogisedInterrupt ;taken if printerDriverType not 1
7785	.e6e1	a9 02		lda #$02	                lda #VIA.irq.ca1
7786	.e6e3	8d 6d fe	sta $fe6d	                sta userVIA.ifr              ;acknowledge CA1
7787	.e6e6	8d 6e fe	sta $fe6e	                sta userVIA.ier              ;inhibit CA1
7788	.e6e9	a2 03		ldx #$03	                ldx #bufferPrinter
7789	.e6eb	4c 00 ea	jmp $ea00	                jmp LE8D5
7790						                .endif

7792	.e6ee					checkForSystemVIAT1Interrupt:
7793	.e6ee	89 40		bit #$40	                bit #VIA.irq.t1
7794						                .if version<400
7796						                .else
7797	.e6f0	f0 74		beq $e766	                beq checkForSystemVIACA2Interrupt
7798						                .endif

7800						                ; Handle T1 interrupt - 100 Hz timer.

7802	.e6f2	a9 40		lda #$40	                lda #VIA.irq.t1
7803	.e6f4	8d 4d fe	sta $fe4d	                sta systemVIA.ifr            ;acknowledge T1 interrupt
7804	.e6f7	ad 83 02	lda $0283	                lda timerSwitchState
7805	.e6fa	aa		tax		                tax                          ;X=old timerSwitchState
7806	.e6fb	49 0f		eor #$0f	                eor #$0F
7807	.e6fd	48		pha		                pha                          ;save new timerSwitchState
7808	.e6fe	a8		tay		                tay                          ;Y=new timerSwitchState
7809	.e6ff	38		sec		                sec                          ;C=1 - increment
7810	.e700					updateTIMELoop:
7811	.e700	bd 91 02	lda $0291,x	                lda timer0-1,x
7812	.e703	69 00		adc #$00	                adc #$00
7813	.e705	99 91 02	sta $0291,y	                sta timer0-1,y

7815						                ; one of X or Y will get to 0 to indicate the end of
7816						                ; the loop.
7817	.e708	ca		dex		                dex
7818	.e709	f0 03		beq $e70e	                beq updateTIMEDone
7819	.e70b	88		dey		                dey
7820	.e70c	d0 f2		bne $e700	                bne updateTIMELoop
7821	.e70e					updateTIMEDone:
7822	.e70e	68		pla		                pla                          ;restore new timerSwitchState
7823	.e70f	8d 83 02	sta $0283	                sta timerSwitchState
7824	.e712	a2 05		ldx #$05	                ldx #$05
7825	.e714					incrementIntervalTimer:
7826	.e714	fe 9b 02	inc $029b,x	                inc intervalTimer-1,x
7827	.e717	d0 08		bne $e721	                bne intervalTimerDone
7828	.e719	ca		dex		                dex
7829	.e71a	d0 f8		bne $e714	                bne incrementIntervalTimer
7830	.e71c	a0 05		ldy #$05	                ldy #eventIntervalTimerCrossingZero
7831	.e71e	20 53 eb	jsr $eb53	                jsr eventEntryPoint
7832	.e721					intervalTimerDone:
7833	.e721	ad b1 02	lda $02b1	                lda inkeyTimeoutCounter+0
7834	.e724	d0 08		bne $e72e	                bne LE715
7835	.e726	ad b2 02	lda $02b2	                lda inkeyTimeoutCounter+1
7836	.e729	f0 06		beq $e731	                beq LE718
7837	.e72b	ce b2 02	dec $02b2	                dec inkeyTimeoutCounter+1
7838	.e72e					LE715:
7839	.e72e	ce b1 02	dec $02b1	                dec inkeyTimeoutCounter+0
7840	.e731					LE718:
7841	.e731	2c cd 02	bit $02cd	                bit previousKeyPressedWhenReadingOSBYTE
7842	.e734	10 0b		bpl $e741	                bpl LE728
7843	.e736	ee cd 02	inc $02cd	                inc previousKeyPressedWhenReadingOSBYTE
7844	.e739	58		cli		                cli
7845						                .if version==350
7847						                .else
7848	.e73a	20 db f4	jsr $f4db	                jsr LF416                    ;update sound???
7849						                .endif
7850	.e73d	78		sei		                sei
7851	.e73e	ce cd 02	dec $02cd	                dec previousKeyPressedWhenReadingOSBYTE
7852	.e741					LE728:
7853	.e741	2c 70 e3	bit $e370	                bit valueFF                  ;V=1
7854						                .if version!=400
7855	.e744	20 28 e6	jsr $e628	                jsr irq1Handler
7856						                .endif
7857	.e747	a5 ec		lda $ec		                lda lastKeyPressedInternal
7858	.e749	05 ed		ora $ed		                ora firstKeyPressedInternal
7859	.e74b	2d 42 02	and $0242	                and keyboardSemaphore
7860	.e74e	f0 04		beq $e754	                beq +
7861	.e750	38		sec		                sec
7862	.e751	20 78 f7	jsr $f778	                jsr LF8FF
7863	.e754					+
7864						                .if version>=500
7865	.e754	20 99 e7	jsr $e799	                jsr handleDigitalJoystick
7866						                .endif
7867	.e757	20 5e ea	jsr $ea5e	                jsr pollPrinterDriver
7868	.e75a	ac 43 02	ldy $0243	                ldy romPollingSemaphore
7869						                .if version==400
7871						                .else
7872	.e75d	f0 05		beq $e764	                beq LE748
7873						                .endif
7874	.e75f	a2 15		ldx #$15	                ldx #romServiceCallPollingInterrupt
7875						                .if version==400
7877						                .else
7878	.e761	20 f8 ee	jsr $eef8	                jsr makeROMServiceCall
7879	.e764					LE748:
7880						                .if version<500
7883						                .endif
7884	.e764	60		rts		                rts
7885						                .endif

7887						                .if version!=400
7888	.e765					checkForSystemVIACB1Interrupt:
7889						                .if version<500
7925						                .elsif version>=500
7926	.e765					initiateADCConversion:
7927	.e765	60		rts		                rts
7928						                .endif
7929						                .endif

7931	.e766					checkForSystemVIACA2Interrupt:
7932	.e766	4a		lsr a		                lsr a                        ;C = CA2
7933	.e767	90 0a		bcc $e773	                bcc handleUnrecognisedInterruptE799

7935						                ; Handle CA2 interrupt - keyboard.

7937	.e769	18		clc		                clc
7938	.e76a	20 78 f7	jsr $f778	                jsr LF8FF
7939	.e76d	a9 01		lda #$01	                lda #VIA.irq.ca2
7940						                .if version<400
7942						                .else
7943	.e76f					staSystemVIAIFR:
7944	.e76f	8d 4d fe	sta $fe4d	                sta systemVIA.ifr
7945	.e772					rtsE6B6:
7946	.e772	60		rts		                rts
7947						                .endif

7949	.e773					handleUnrecognisedInterruptE799:
7950	.e773	4c 7c e6	jmp $e67c	                jmp handleUnrecogisedInterrupt

7952						;-------------------------------------------------------------------------
7953						;
7954						; OSBYTE 17 (&11) Write next ADC channel to be sampled [MasRef D.2-25]
7955						;
7956	.e776					osbyte11:
7957						                .if version!=400
7958						                .if version<500
7960						                .elsif version>=500
7961	.e776	8c 4c 02	sty $024c	                sty currentADCChannel
7962						                .endif
7963	.e779	80 ea		bra $e765	                bra initiateADCConversion
7964						                .endif

7966						;-------------------------------------------------------------------------
7967						;
7968						; Print a 0-terminated string at some offset from startupMessages.
7969						;
7970						; entry:
7971						;
7972						; Y = offset-1 of message
7973						;
7974	.e77b					printStartupMessage:
7975	.e77b	a9 e0		lda #$e0	                lda #>startupMessages
7976						                ; .cerror (<startupMessages)!=0,"startupMessages must be page-aligned" ;it's more flexible than this, but this'll do for now

7978						;-------------------------------------------------------------------------
7979						;
7980						; Print a 0-terminated string.
7981						;
7982						; entry:
7983						;
7984						; A = address MSB
7985						;
7986						; Y = (address LSB)-1
7987						;
7988	.e77d					print0TerminatedString:
7989	.e77d	85 fe		sta $fe		                sta errPtr+1
7990	.e77f	64 fd		stz $fd		                stz errPtr+0

7992						;-------------------------------------------------------------------------
7993						;
7994						; Print the BRK message.
7995						;
7996						; entry:
7997						;
7998						; (errPtr) = pointer to the error number (as will be the case after a
7999						; BRK)
8000						;
8001						; Y=0
8002						;
8003	.e781					printBRKMessage:
8004	.e781	c8		iny		                iny
8005	.e782	b1 fd		lda ($fd),y	                lda (errPtr),y
8006	.e784	20 e3 ff	jsr $ffe3	                jsr OSASCI
8007	.e787	aa		tax		                tax
8008	.e788	d0 f7		bne $e781	                bne printBRKMessage
8009	.e78a					rtsE7B0:
8010	.e78a	60		rts		                rts

8012						;-------------------------------------------------------------------------

8014						                .if version>=500
8015						;-------------------------------------------------------------------------

8017	>e78b	00				unk_E78B:       .byte 0
8018	>e78c	8d				                .byte $8D       ;
8019	>e78d	8f				                .byte $8F       ;
8020	>e78e	8e				                .byte $8E       ;
8021	>e78f	8c				                .byte $8C       ;
8022	>e790	7f				                .byte $7F       ;
8023	>e791	0d				                .byte $D
8024	>e792	8b				                .byte $8B       ;
8025	>e793	8b				                .byte $8B       ;
8026	>e794	96				unk_E794:       .byte $96
8027	>e795	e6				                .byte $E6       ;
8028	>e796	d6				                .byte $D6       ;
8029	>e797	c6				                .byte $C6       ;
8030	>e798	86				                .byte $86       ;

8032						;-------------------------------------------------------------------------

8034	.e799					handleDigitalJoystick:.block
8035	.e799	ad 4d 02	lda $024d	                lda maximumADCChannel
8036	.e79c	f0 ec		beq $e78a	                beq rtsE7B0
8037	.e79e	2c 4e 02	bit $024e	                bit adcConversionType
8038	.e7a1	50 3b		bvc $e7de	                bvc LE7DE
8039	.e7a3	ad b6 02	lda $02b6	                lda adcResultLSBs
8040	.e7a6	a2 00		ldx #$00	                ldx #0

8042	.e7a8					LE7A8:
8043	.e7a8	e8		inx		                inx
8044	.e7a9	0a		asl a		                asl a
8045	.e7aa	b0 03		bcs $e7af	                bcs LE7AF
8046	.e7ac	d0 fa		bne $e7a8	                bne LE7A8
8047	.e7ae	aa		tax		                tax

8049	.e7af					LE7AF:
8050	.e7af	bc 8b e7	ldy $e78b,x	                ldy unk_E78B,x
8051	.e7b2	cc be 02	cpy $02be	                cpy adcLastChannelRead
8052	.e7b5	8c be 02	sty $02be	                sty adcLastChannelRead
8053	.e7b8	f0 0c		beq $e7c6	                beq LE7C6
8054	.e7ba	98		tya		                tya
8055	.e7bb	f0 09		beq $e7c6	                beq LE7C6
8056	.e7bd	20 a9 eb	jsr $eba9	                jsr insertCharacterIntoKeyboardBuffer
8057	.e7c0	ad 54 02	lda $0254	                lda keyboardAutoRepeatDelay
8058	.e7c3	8d bd 02	sta $02bd	                sta adcResultMSBs+3

8060	.e7c6					LE7C6:
8061	.e7c6	ad bd 02	lda $02bd	                lda adcResultMSBs+3
8062	.e7c9	f0 13		beq $e7de	                beq LE7DE
8063	.e7cb	ce bd 02	dec $02bd	                dec adcResultMSBs+3
8064	.e7ce	d0 0e		bne $e7de	                bne LE7DE
8065	.e7d0	ad 55 02	lda $0255	                lda keyboardAutoRepeatRate
8066	.e7d3	8d bd 02	sta $02bd	                sta adcResultMSBs+3
8067	.e7d6	ac be 02	ldy $02be	                ldy adcLastChannelRead
8068	.e7d9	f0 03		beq $e7de	                beq LE7DE
8069	.e7db	20 a9 eb	jsr $eba9	                jsr insertCharacterIntoKeyboardBuffer

8071	.e7de					LE7DE:
8072	.e7de	2c 4e 02	bit $024e	                bit adcConversionType
8073	.e7e1	10 07		bpl $e7ea	                bpl LE7EA
8074	.e7e3	a0 b6		ldy #$b6	                ldy #$B6
8075	.e7e5	a2 2c		ldx #$2c	                ldx #$2C        ; Master Compact joystick call
8076	.e7e7	4c f8 ee	jmp $eef8	                jmp makeROMServiceCall

8078						;-------------------------------------------------------------------------

8080	.e7ea					LE7EA:
8081	.e7ea	a9 ff		lda #$ff	                lda #$FF
8082	.e7ec	ae 7d 02	ldx $027d	                ldx editKeysMode
8083	.e7ef	e0 03		cpx #$03	                cpx #3
8084	.e7f1	d0 14		bne $e807	                bne LE807
8085	.e7f3	e8		inx		                inx

8087	.e7f4					LE7F4:
8088	.e7f4	48		pha		                pha
8089	.e7f5	da		phx		                phx
8090	.e7f6	bd 94 e7	lda $e794,x	                lda unk_E794,x
8091	.e7f9	aa		tax		                tax
8092	.e7fa	38		sec		                sec
8093	.e7fb	b8		clv		                clv
8094	.e7fc	20 91 ed	jsr $ed91	                jsr LED01
8095	.e7ff	fa		plx		                plx
8096	.e800	68		pla		                pla
8097	.e801	2a		rol a		                rol a
8098	.e802	ca		dex		                dex
8099	.e803	10 ef		bpl $e7f4	                bpl LE7F4
8100	.e805	49 ff		eor #$ff	                eor #$FF

8102	.e807					LE807:
8103	.e807	2d 60 fe	and $fe60	                and userVIA.irb
8104	.e80a	49 1f		eor #$1f	                eor #$1F
8105	.e80c	4a		lsr a		                lsr a
8106	.e80d	08		php		                php
8107	.e80e	0a		asl a		                asl a
8108	.e80f	0a		asl a		                asl a
8109	.e810	0a		asl a		                asl a
8110	.e811	28		plp		                plp
8111	.e812	2a		rol a		                rol a
8112	.e813	aa		tax		                tax
8113	.e814	4d b6 02	eor $02b6	                eor adcResultLSBs
8114	.e817	2c 4e 02	bit $024e	                bit adcConversionType
8115	.e81a	29 f0		and #$f0	                and #$F0
8116	.e81c	8e b6 02	stx $02b6	                stx adcResultLSBs
8117	.e81f	70 05		bvs $e826	                bvs locret_E826
8118	.e821	f0 04		beq $e827	                beq LE827
8119	.e823	9c bd 02	stz $02bd	                stz adcResultMSBs+3

8121	.e826					locret_E826:
8122	.e826	60		rts		                rts

8124						;-------------------------------------------------------------------------

8126	.e827					LE827:
8127	.e827	ad 4e 02	lda $024e	                lda adcConversionType
8128	.e82a	f0 06		beq $e832	                beq LE832
8129	.e82c	c9 08		cmp #$08	                cmp #8
8130	.e82e	90 04		bcc $e834	                bcc LE834
8131	.e830	a9 04		lda #$04	                lda #4

8133	.e832					LE832:
8134	.e832	49 03		eor #$03	                eor #3

8136	.e834					LE834:
8137	.e834	a8		tay		                tay
8138	.e835	3a		dec a		                dec a
8139	.e836	aa		tax		                tax
8140	.e837	ad bd 02	lda $02bd	                lda adcResultMSBs+3
8141	.e83a	9c bc 02	stz $02bc	                stz adcResultMSBs+2

8143	.e83d					LE83D:
8144	.e83d	ca		dex		                dex
8145	.e83e	30 06		bmi $e846	                bmi LE846
8146	.e840	0a		asl a		                asl a
8147	.e841	2e bc 02	rol $02bc	                rol adcResultMSBs+2
8148	.e844	80 f7		bra $e83d	                bra LE83D

8150						;-------------------------------------------------------------------------

8152	.e846					LE846:
8153	.e846	8d bb 02	sta $02bb	                sta adcResultMSBs+1
8154	.e849	cc bc 02	cpy $02bc	                cpy adcResultMSBs+2
8155	.e84c	b0 06		bcs $e854	                bcs LE854
8156	.e84e	8c bb 02	sty $02bb	                sty adcResultMSBs+1
8157	.e851	8c bc 02	sty $02bc	                sty adcResultMSBs+2

8159	.e854					LE854:
8160	.e854	ad 4e 02	lda $024e	                lda adcConversionType
8161	.e857	29 20		and #$20	                and #$20
8162	.e859	f0 0f		beq $e86a	                beq LE86A
8163	.e85b	a9 ff		lda #$ff	                lda #$FF
8164	.e85d	8d b7 02	sta $02b7	                sta adcResultLSBs+1
8165	.e860	8d b9 02	sta $02b9	                sta adcResultLSBs+3
8166	.e863	4a		lsr a		                lsr a
8167	.e864	8d b8 02	sta $02b8	                sta adcResultLSBs+2
8168	.e867	8d ba 02	sta $02ba	                sta adcResultMSBs

8170	.e86a					LE86A:
8171	.e86a	a2 09		ldx #$09	                ldx #9

8173	.e86c					LE86C:
8174	.e86c	ad b6 02	lda $02b6	                lda adcResultLSBs
8175	.e86f	3c d5 e8	bit $e8d5,x	                bit unk_E8D5,x
8176	.e872	f0 3e		beq $e8b2	                beq LE8B2
8177	.e874	bd d6 e8	lda $e8d6,x	                lda unk_E8D5+1,x
8178	.e877	0a		asl a		                asl a
8179	.e878	a8		tay		                tay
8180	.e879	ad 4e 02	lda $024e	                lda adcConversionType
8181	.e87c	29 20		and #$20	                and #$20        ; ' '
8182	.e87e	f0 05		beq $e885	                beq LE885
8183	.e880	bd d7 e8	lda $e8d7,x	                lda unk_E8D5+2,x
8184	.e883	80 27		bra $e8ac	                bra LE8AC

8186						;-------------------------------------------------------------------------

8188	.e885					LE885:
8189	.e885	b9 b7 02	lda $02b7,y	                lda adcResultLSBs+1,y
8190	.e888	b0 12		bcs $e89c	                bcs LE89C
8191	.e88a	6d bb 02	adc $02bb	                adc adcResultMSBs+1
8192	.e88d	99 b7 02	sta $02b7,y	                sta adcResultLSBs+1,y
8193	.e890	b9 b8 02	lda $02b8,y	                lda adcResultLSBs+2,y
8194	.e893	6d bc 02	adc $02bc	                adc adcResultMSBs+2
8195	.e896	90 17		bcc $e8af	                bcc LE8AF
8196	.e898	a9 ff		lda #$ff	                lda #$FF
8197	.e89a	80 10		bra $e8ac	                bra LE8AC

8199						;-------------------------------------------------------------------------

8201	.e89c					LE89C:
8202	.e89c	ed bb 02	sbc $02bb	                sbc adcResultMSBs+1
8203	.e89f	99 b7 02	sta $02b7,y	                sta adcResultLSBs+1,y
8204	.e8a2	b9 b8 02	lda $02b8,y	                lda adcResultLSBs+2,y
8205	.e8a5	ed bc 02	sbc $02bc	                sbc adcResultMSBs+2
8206	.e8a8	b0 05		bcs $e8af	                bcs LE8AF
8207	.e8aa	a9 00		lda #$00	                lda #0

8209	.e8ac					LE8AC:
8210	.e8ac	99 b7 02	sta $02b7,y	                sta adcResultLSBs+1,y

8212	.e8af					LE8AF:
8213	.e8af	99 b8 02	sta $02b8,y	                sta adcResultLSBs+2,y

8215	.e8b2					LE8B2:
8216	.e8b2	ca		dex		                dex
8217	.e8b3	ca		dex		                dex
8218	.e8b4	ca		dex		                dex
8219	.e8b5	10 b5		bpl $e86c	                bpl LE86C
8220	.e8b7	ee bd 02	inc $02bd	                inc adcResultMSBs+3
8221	.e8ba	d0 03		bne $e8bf	                bne LE8BF
8222	.e8bc	ce bd 02	dec $02bd	                dec adcResultMSBs+3

8224	.e8bf					LE8BF:
8225	.e8bf	ae 4c 02	ldx $024c	                ldx currentADCChannel
8226	.e8c2	a0 03		ldy #$03	                ldy #3
8227	.e8c4	20 53 eb	jsr $eb53	                jsr eventEntryPoint
8228	.e8c7	ce 4c 02	dec $024c	                dec currentADCChannel
8229	.e8ca	f0 02		beq $e8ce	                beq LE8CE
8230	.e8cc	10 06		bpl $e8d4	                bpl locret_E8D4

8232	.e8ce					LE8CE:
8233	.e8ce	ad 4d 02	lda $024d	                lda maximumADCChannel
8234	.e8d1	8d 4c 02	sta $024c	                sta currentADCChannel

8236	.e8d4					locret_E8D4:
8237	.e8d4	60		rts		                rts
8238						                .endblock

8240						;-------------------------------------------------------------------------

8242	>e8d5	40				unk_E8D5:       .byte $40; @
8243	>e8d6	01				                .byte 1
8244	>e8d7	ff				                .byte $FF
8245	>e8d8	20				                .byte $20
8246	>e8d9	81				                .byte $81       ;
8247	>e8da	00				                .byte 0
8248	>e8db	80				                .byte $80       ;
8249	>e8dc	80				                .byte $80       ;
8250	>e8dd	00				                .byte 0
8251	>e8de	10				                .byte $10
8252	>e8df	00				                .byte 0
8253	>e8e0	ff				                .byte $FF
8254						                .endif

8256						;-------------------------------------------------------------------------

8258	.e8e1					osbyte81Timed:
8259	.e8e1	8e b1 02	stx $02b1	                stx inkeyTimeoutCounter+0
8260	.e8e4	8c b2 02	sty $02b2	                sty inkeyTimeoutCounter+1
8261	.e8e7	66 e6		ror $e6		                ror readCharacterTimedFlag   ;set the timed flag
8262	.e8e9	58		cli		                cli
8263	.e8ea	80 02		bra $e8ee	                bra osrdchWithTimeout

8265						;-------------------------------------------------------------------------

8267	.e8ec					osrdchEntryPoint:
8268	.e8ec	64 e6		stz $e6		                stz readCharacterTimedFlag   ;clear the timed flag
8269	.e8ee					osrdchWithTimeout:
8270	.e8ee	da		phx		                phx
8271	.e8ef	5a		phy		                phy
8272	.e8f0	ac 56 02	ldy $0256	                ldy execFileHandle
8273	.e8f3	f0 12		beq $e907	                beq osrdchLoop               ;taken if not *EXEC'ing
8274	.e8f5	38		sec		                sec
8275	.e8f6	66 eb		ror $eb		                ror tapeCritical
8276	.e8f8	20 d7 ff	jsr $ffd7	                jsr OSBGET             ;get 1 byte from the *EXEC file
8277	.e8fb	64 eb		stz $eb		                stz tapeCritical
8278	.e8fd	90 24		bcc $e923	                bcc osrdchDone                    ;taken if byte valid
8279	.e8ff	a9 00		lda #$00	                lda #$00                     ;OSFIND close file
8280	.e901	9c 56 02	stz $0256	                stz execFileHandle           ;reset *EXEC handle
8281	.e904	20 ce ff	jsr $ffce	                jsr OSFIND                   ;close *EXEC file
8282	.e907					osrdchLoop:
8283	.e907	a5 ff		lda $ff		                lda escapeFlag               ;b7 set if ESCAPE pressed
8284	.e909	0a		asl a		                asl a                        ;C=1 if ESCAPE pressed
8285	.e90a	a9 1b		lda #$1b	                lda #27                      ;ASCII for ESCAPE
8286	.e90c	b0 15		bcs $e923	                bcs osrdchDone               ;exit with C=1 if ESCAPE
8287						                                             ;pressed
8288						                .if version!=400
8289	.e90e	ae 41 02	ldx $0241	                ldx inputSource
8290						                .endif
8291	.e911	20 57 ec	jsr $ec57	                jsr readFromEconetOrSoftKeyOrInputBufferA ;handle Econet/soft key stuff???
8292	.e914	90 0d		bcc $e923	                bcc osrdchDone
8293	.e916	24 e6		bit $e6		                bit readCharacterTimedFlag
8294	.e918	10 ed		bpl $e907	                bpl osrdchLoop     ;taken if no timeout - keep looping
8295	.e91a	ad b2 02	lda $02b2	                lda inkeyTimeoutCounter+1
8296	.e91d	0d b1 02	ora $02b1	                ora inkeyTimeoutCounter+0
8297	.e920	d0 e5		bne $e907	                bne osrdchLoop     ;taken if timeout not timed out yet
8298	.e922	3a		dec a		                dec a              ;timed out: A=$ff, C=1
8299	.e923					osrdchDone:
8300	.e923	7a		ply		                ply
8301	.e924	fa		plx		                plx
8302	.e925	60		rts		                rts

8304						;-------------------------------------------------------------------------

8306	.e926					starLIBFS:
8307	.e926	ad 01 df	lda $df01	                lda hazel.activeFS
8308	.e929	8d 02 df	sta $df02	                sta hazel.libFS
8309	.e92c	60		rts		                rts

8311						;-------------------------------------------------------------------------

8313						                .if version<500
8318						                .endif

8320						;-------------------------------------------------------------------------
8321						;
8322						; OSCLI
8323						;
8324						; MasRef D.4-1
8325						;

8327	.e92d					oscliEntryPoint: .block
8328	.e92d	20 40 ee	jsr $ee40	                jsr selectHAZEL
8329	.e930	86 f2		stx $f2		                stx stringInputBufferAddress+0
8330	.e932	84 f3		sty $f3		                sty stringInputBufferAddress+1
8331	.e934	a0 00		ldy #$00	                ldy #$00
8332	.e936					-
8333	.e936	b1 f2		lda ($f2),y	                lda (stringInputBufferAddress),y
8334	.e938	99 00 dc	sta $dc00,y	                sta hazel.commandLine,y
8335	=$e93c					emptyCommandLine=*+1                         ;arbitrary place that's
8336						                                             ;just a 13 byte...
8337	.e93b	c9 0d		cmp #$0d	                cmp #$0D
8338	.e93d	f0 04		beq $e943	                beq +     ;branch taken if end of command line reached
8339	.e93f	c8		iny		                iny
8340	.e940	d0 f4		bne $e936	                bne -

8342						                ; OSCLI is a no-op if the command line is too long.
8343	.e942	60		rts		                rts

8345	.e943					+
8346	.e943	a0 dc		ldy #$dc	                ldy #>hazel.commandLine
8347	.e945	a2 00		ldx #$00	                ldx #<hazel.commandLine
8348	.e947	20 50 f4	jsr $f450	                jsr withTerminalROM
8349	.e94a	4c 51 85	jmp $8551	                jmp terminal.oscli
8350						                .endblock

8352	=$e93c					emptyCommandLine=oscliEntryPoint.emptyCommandLine

8354						                ; OSWRCH
8355						                ; ======
8356	.e94d					oswrchEntryPoint:
8357	.e94d	48		pha		                pha                          ;S=[ch]
8358	.e94e	da		phx		                phx                          ;S=[x; ch]
8359	.e94f	5a		phy		                phy                          ;S=[y; x; ch]
8360	.e950	48		pha		                pha                          ;S=[ch; y; x; ch]
8361	.e951	2c 60 02	bit $0260	                bit econetOutputInterpretationStatus
8362	.e954	10 08		bpl $e95e	                bpl LE833
8363	.e956	a8		tay		                tay
8364	.e957	a9 04		lda #$04	                lda #netWriteCharacterAttempted
8365	.e959	20 5e ec	jsr $ec5e	                jsr callNETV
8366	.e95c	b0 72		bcs $e9d0	                bcs LE8A5
8367	.e95e					LE833:
8368	.e95e	a9 02		lda #$02	                lda #$02
8369	.e960	2c 7c 02	bit $027c	                bit characterDestinationStatus
8370	.e963	d0 28		bne $e98d	                bne LE862
8371	.e965	68		pla		                pla                          ;restore char to print
8372	.e966	48		pha		                pha                          ;save it again
8373	.e967	aa		tax		                tax                          ;X=char to print
8374	.e968	ad 34 fe	lda $fe34	                lda ACCCON                   ;
8375	.e96b	48		pha		                pha                          ;S=[old ACCCON; ch; y; x; ch]
8376						                .if version==350
8378						                .else
8379	.e96c	a9 08		lda #$08	                lda #ACCCON.Y
8380	.e96e	1c 34 fe	trb $fe34	                trb ACCCON                   ;MOS ROM at $c000
8381						                .endif
8382	.e971	a5 f4		lda $f4		                lda $F4
8383	.e973	48		pha		                pha          ;S=[old ROMSEL; old ACCCON; ch; y; x; ch]
8384	.e974	a9 8f		lda #$8f	                lda #$80|terminalROM
8385	.e976	85 f4		sta $f4		                sta $F4
8386	.e978	8d 30 fe	sta $fe30	                sta ROMSEL                   ;page in ANDY+Terminal
8387	.e97b	8a		txa		                txa                          ;A=char to print
8388	.e97c	20 27 c0	jsr $c027	                jsr outputToVDU
8389	.e97f	68		pla		                pla
8390	.e980	85 f4		sta $f4		                sta $F4
8391	.e982	8d 30 fe	sta $fe30	                sta ROMSEL
8392	.e985	68		pla		                pla
8393	.e986	29 08		and #$08	                and #ACCCON.Y
8394	.e988	0c 34 fe	tsb $fe34	                tsb ACCCON
8395	.e98b	b0 07		bcs $e994	                bcs LE869
8396	.e98d					LE862:
8397	.e98d	a9 08		lda #$08	                lda #$08
8398	.e98f	2c 7c 02	bit $027c	                bit characterDestinationStatus
8399	.e992	f0 05		beq $e999	                beq LE86E
8400	.e994					LE869:
8401	.e994	68		pla		                pla
8402	.e995	48		pha		                pha
8403	.e996	20 d5 e9	jsr $e9d5	                jsr LE8AA
8404	.e999					LE86E:
8405						                .if version!=400
8406	.e999	ad 7c 02	lda $027c	                lda characterDestinationStatus
8407	.e99c	6a		ror a		                ror a
8408	.e99d	90 1b		bcc $e9ba	                bcc LE88F
8409	.e99f	a4 ea		ldy $ea		                ldy $EA
8410	.e9a1	88		dey		                dey
8411	.e9a2	10 16		bpl $e9ba	                bpl LE88F
8412	.e9a4	68		pla		                pla
8413	.e9a5	48		pha		                pha
8414	.e9a6	08		php		                php
8415	.e9a7	78		sei		                sei
8416	.e9a8	a2 02		ldx #$02	                ldx #$02
8417	.e9aa	48		pha		                pha
8418	.e9ab	20 1a eb	jsr $eb1a	                jsr osbyte98
8419	.e9ae	90 03		bcc $e9b3	                bcc LE888
8420	.e9b0	20 33 ea	jsr $ea33	                jsr clearRS423BusyAndSetRS423Active
8421	.e9b3					LE888:
8422	.e9b3	68		pla		                pla
8423	.e9b4	a2 02		ldx #$02	                ldx #$02
8424	.e9b6	20 ce ea	jsr $eace	                jsr LE9A3
8425	.e9b9	28		plp		                plp
8426	.e9ba					LE88F:
8427						                .endif

8429	.e9ba	a9 10		lda #$10	                lda #$10
8430	.e9bc	2c 7c 02	bit $027c	                bit characterDestinationStatus
8431	.e9bf	d0 0f		bne $e9d0	                bne LE8A5
8432	.e9c1	ac 57 02	ldy $0257	                ldy spoolFileHandle
8433	.e9c4	f0 0a		beq $e9d0	                beq LE8A5
8434	.e9c6	68		pla		                pla
8435	.e9c7	48		pha		                pha
8436	.e9c8	38		sec		                sec
8437	.e9c9	66 eb		ror $eb		                ror $EB
8438	.e9cb	20 d4 ff	jsr $ffd4	                jsr OSBPUT
8439	.e9ce	46 eb		lsr $eb		                lsr $EB
8440	.e9d0					LE8A5:
8441	.e9d0	68		pla		                pla
8442	.e9d1	7a		ply		                ply
8443	.e9d2	fa		plx		                plx
8444	.e9d3	68		pla		                pla
8445	.e9d4	60		rts		                rts

8447	.e9d5					LE8AA:
8448	.e9d5	2c 7c 02	bit $027c	                bit characterDestinationStatus
8449	.e9d8	70 25		bvs $e9ff	                bvs LE8D4
8450	.e9da	cd 86 02	cmp $0286	                cmp printerIgnoreChar
8451	.e9dd	d0 05		bne $e9e4	                bne LE8B9
8452	.e9df	2c 46 02	bit $0246	                bit noignoreState
8453	.e9e2	10 1b		bpl $e9ff	                bpl LE8D4
8454	.e9e4					LE8B9:
8455	.e9e4	08		php		                php
8456	.e9e5	78		sei		                sei
8457	.e9e6	aa		tax		                tax
8458	.e9e7	a9 04		lda #$04	                lda #$04
8459	.e9e9	2c 7c 02	bit $027c	                bit characterDestinationStatus
8460	.e9ec	d0 10		bne $e9fe	                bne LE8D3
8461	.e9ee	8a		txa		                txa
8462	.e9ef	a2 03		ldx #$03	                ldx #$03
8463	.e9f1	20 ce ea	jsr $eace	                jsr LE9A3
8464	.e9f4	b0 08		bcs $e9fe	                bcs LE8D3
8465	.e9f6	2c d1 02	bit $02d1	                bit bufferEmptyFlags+bufferPrinter
8466	.e9f9	10 03		bpl $e9fe	                bpl LE8D3
8467	.e9fb	20 00 ea	jsr $ea00	                jsr LE8D5
8468	.e9fe					LE8D3:
8469	.e9fe	28		plp		                plp
8470	.e9ff					LE8D4:
8471	.e9ff	60		rts		                rts

8473	.ea00					LE8D5:                                       ;E7CA in MOS 4.00
8474	.ea00	ad 85 02	lda $0285	                lda printerDriverType
8475						                .if version!=400
8476	.ea03	f0 7f		beq $ea84	                beq LE959
8477	.ea05	3a		dec a		                dec a
8478	.ea06	d0 20		bne $ea28	                bne LE8FD
8479	.ea08	20 1f eb	jsr $eb1f	                jsr osbyte91
8480	.ea0b	6e d1 02	ror $02d1	                ror bufferEmptyFlags+bufferPrinter
8481	.ea0e	30 43		bmi $ea53	                bmi rtsE928
8482	.ea10	a0 82		ldy #$82	                ldy #$82
8483	.ea12	8c 6e fe	sty $fe6e	                sty userVIA.ier
8484	.ea15	8d 61 fe	sta $fe61	                sta userVIA.ora
8485	.ea18	ad 6c fe	lda $fe6c	                lda userVIA.pcr
8486	.ea1b	29 f1		and #$f1	                and #$F1
8487	.ea1d	09 0c		ora #$0c	                ora #$0C
8488	.ea1f	8d 6c fe	sta $fe6c	                sta userVIA.pcr
8489	.ea22	09 0e		ora #$0e	                ora #$0E
8490	.ea24	8d 6c fe	sta $fe6c	                sta userVIA.pcr
8491	.ea27	60		rts		                rts

8493	.ea28					LE8FD:
8494	.ea28	3a		dec a		                dec a
8495	.ea29	d0 29		bne $ea54	                bne activatePrinterDriver
8496	.ea2b	a4 ea		ldy $ea		                ldy $EA
8497	.ea2d	88		dey		                dey
8498	.ea2e	10 54		bpl $ea84	                bpl LE959
8499	.ea30	4e d1 02	lsr $02d1	                lsr bufferEmptyFlags+bufferPrinter
8500	.ea33					clearRS423BusyAndSetRS423Active:
8501	.ea33	4e 4f 02	lsr $024f	                lsr rs423Busy
8502	.ea36					setRS423Active:
8503	.ea36	20 b7 ed	jsr $edb7	                jsr getRS423InputBufferFreeBytes
8504	.ea39	90 18		bcc $ea53	                bcc rtsE928
8505	.ea3b	a2 20		ldx #$20	                ldx #ACIA.control.rtsLowTXInterruptEnabled
8506	.ea3d					resetACIA:
8507	.ea3d	a0 9f		ldy #$9f	                ldy #ACIA.control.rtsRTSInterruptEnabled|ACIA.control.word8DataOddParity1Stop|ACIA.control.reset

8509						;-------------------------------------------------------------------------
8510						;
8511						; OSBYTE 156 (&9C) Read/write serial ACIA control [MasRef D.2-47]
8512						;
8513	.ea3f					osbyte9C:
8514	.ea3f	08		php		                php
8515	.ea40	78		sei		                sei
8516	.ea41	98		tya		                tya
8517	.ea42	86 fa		stx $fa		                stx SEIWKA
8518	.ea44	2d 50 02	and $0250	                and aciaControlRegister
8519	.ea47	45 fa		eor $fa		                eor SEIWKA
8520	.ea49	ae 50 02	ldx $0250	                ldx aciaControlRegister
8521	.ea4c					writeACIAControlRegister:
8522	.ea4c	8d 50 02	sta $0250	                sta aciaControlRegister
8523	.ea4f	8d 08 fe	sta $fe08	                sta ACIA.control
8524	.ea52	28		plp		                plp
8525	.ea53					rtsE928:
8526	.ea53	60		rts		                rts

8537						                .endif

8539						;-------------------------------------------------------------------------

8541	.ea54					activatePrinterDriver:
8542	.ea54	18		clc		                clc
8543	.ea55	a9 01		lda #$01	                lda #printerDriverActivate
8544	.ea57	20 65 ea	jsr $ea65	                jsr callPrinterDriverWithPrinterBuffer

8546						                ; printer driver will set C=0 if active, C=1 if
8547						                ; inactive.

8549						;-------------------------------------------------------------------------
8550						;
8551						; OSBYTE 123 (&7B) Inform MOS of printer driver going dormant [MasRef
8552						; D.2-36]
8553						;
8554	.ea5a					osbyte7B:
8555	.ea5a	6e d1 02	ror $02d1	                ror bufferEmptyFlags+bufferPrinter   ;C=1 on entry, so set bit 7
8556	.ea5d					rtsE932:
8557	.ea5d	60		rts		                rts

8559						;-------------------------------------------------------------------------

8561	.ea5e					pollPrinterDriver:
8562	.ea5e	2c d1 02	bit $02d1	                bit bufferEmptyFlags+bufferPrinter
8563	.ea61	30 fa		bmi $ea5d	                bmi rtsE932           ;taken if printer driver dormant
8564	.ea63	a9 00		lda #$00	                lda #printerDriverPoll
8565	.ea65					callPrinterDriverWithPrinterBuffer:
8566	.ea65	a2 03		ldx #$03	                ldx #bufferPrinter
8567	.ea67					callPrinterDriver:
8568	.ea67	ac 85 02	ldy $0285	                ldy printerDriverType
8569	.ea6a	20 5e ec	jsr $ec5e	                jsr callNETV
8570	.ea6d	6c 22 02	jmp ($0222)	                jmp (UPTV)

8572						;-------------------------------------------------------------------------
8573						;
8574						; OSBYTE 15 (&0F) Flush buffer
8575						;
8576	.ea70					osbyte0F:
8577	.ea70	d0 0f		bne $ea81	                bne LE956
8578	.ea72					LE947:
8579	.ea72	a2 08		ldx #$08	                ldx #$08
8580	.ea74					LE949:
8581	.ea74	58		cli		                cli
8582	.ea75	78		sei		                sei
8583	.ea76	20 7c ea	jsr $ea7c	                jsr osbyte15
8584	.ea79	ca		dex		                dex
8585	.ea7a	10 f8		bpl $ea74	                bpl LE949

8587						;-------------------------------------------------------------------------
8588						;
8589						; OSBYTE 21 (&15) Flush selected buffer
8590						;
8591	.ea7c					osbyte15:                                    ;e951
8592	.ea7c	e0 09		cpx #$09	                cpx #bufferMax+1
8593	.ea7e	90 04		bcc $ea84	                bcc LE959
8594	.ea80	60		rts		                rts

8596	.ea81					LE956:
8597	.ea81	ae 41 02	ldx $0241	                ldx inputSource
8598	.ea84					LE959:
8599	.ea84	18		clc		                clc
8600	.ea85					LE95A:
8601	.ea85	48		pha		                pha
8602	.ea86	08		php		                php
8603	.ea87	78		sei		                sei
8604	.ea88	b0 08		bcs $ea92	                bcs LE967
8605	.ea8a	8a		txa		                txa
8606	.ea8b	29 04		and #$04	                and #$04                     ;buffer 4-7?
8607	.ea8d	f0 03		beq $ea92	                beq LE967                    ;taken if not sound buffer
8608	.ea8f	20 e8 f4	jsr $f4e8	                jsr clearSoundChannelBuffer
8609	.ea92					LE967:
8610	.ea92	38		sec		                sec
8611	.ea93	7e ce 02	ror $02ce,x	                ror bufferEmptyFlags,x
8612	.ea96	e0 02		cpx #$02	                cpx #bufferFirstOutput
8613	.ea98	b0 06		bcs $eaa0	                bcs LE975                    ;taken if output buffer
8614	.ea9a	9c 68 02	stz $0268	                stz softKeyStringLength
8615	.ea9d	9c 6a 02	stz $026a	                stz vduQueueNegativeLength
8616	.eaa0					LE975:
8617	.eaa0	20 b1 ed	jsr $edb1	                jsr purgeBufferViaCNPV
8618	.eaa3	28		plp		                plp
8619	.eaa4	68		pla		                pla
8620	.eaa5	60		rts		                rts

8622						;-------------------------------------------------------------------------
8623						;
8624						; Count/purge entry point [AUG p264]
8625						;
8626	.eaa6					cnpEntryPoint:
8627	.eaa6	50 07		bvc $eaaf	                bvc countBuffer
8628	.eaa8					purgeBuffer:
8629	.eaa8	bd d7 02	lda $02d7,x	                lda bufferStartIndices,x
8630	.eaab	9d e0 02	sta $02e0,x	                sta bufferEndIndices,x
8631	.eaae	60		rts		                rts

8633	.eaaf					countBuffer:
8634	.eaaf	08		php		                php
8635	.eab0	78		sei		                sei
8636	.eab1	08		php		                php
8637	.eab2	38		sec		                sec
8638	.eab3	bd e0 02	lda $02e0,x	                lda bufferEndIndices,x
8639	.eab6	fd d7 02	sbc $02d7,x	                sbc bufferStartIndices,x
8640	.eab9	b0 04		bcs $eabf	                bcs LE994
8641	.eabb	38		sec		                sec
8642	.eabc	fd 06 eb	sbc $eb06,x	                sbc bufferIndex0Offsets,x
8643	.eabf					LE994:
8644	.eabf	28		plp		                plp
8645	.eac0	90 06		bcc $eac8	                bcc LE99D
8646	.eac2	18		clc		                clc
8647	.eac3	7d 06 eb	adc $eb06,x	                adc bufferIndex0Offsets,x
8648	.eac6	49 ff		eor #$ff	                eor #$FF
8649	.eac8					LE99D:
8650	.eac8	a0 00		ldy #$00	                ldy #$00
8651	.eaca	aa		tax		                tax
8652	.eacb	28		plp		                plp
8653	.eacc					rtsE9A1:
8654	.eacc	60		rts		                rts

8656						;-------------------------------------------------------------------------

8658	.eacd					LE9A2:
8659	.eacd	58		cli		                cli
8660	.eace					LE9A3:
8661	.eace	78		sei		                sei
8662	.eacf					LE9A4:
8663	.eacf	20 6b eb	jsr $eb6b	                jsr callINSV
8664	.ead2	90 f8		bcc $eacc	                bcc rtsE9A1
8665	.ead4	20 ef f2	jsr $f2ef	                jsr LF241
8666	.ead7	48		pha		                pha
8667	.ead8	20 31 f5	jsr $f531	                jsr updateKeyboardLEDs
8668	.eadb	0a		asl a		                asl a
8669	.eadc	68		pla		                pla
8670	.eadd	90 ee		bcc $eacd	                bcc LE9A2
8671	.eadf	60		rts		                rts

8673						;-------------------------------------------------------------------------
8674						;
8675						; OSBYTE $77
8676						;
8677						; D.2-33
8678						;
8679						                .if version!=350
8680	.eae0					osbyte77:                       ;e9b5
8681	.eae0	20 50 f4	jsr $f450	                jsr withTerminalROM
8682	.eae3	4c ff 95	jmp $95ff	                jmp terminal.L9423
8683						                .endif

8685						;-------------------------------------------------------------------------
8686						;
8687						; Get *IGNORE CMOS byte offset and mask for a given ROM.
8688						;
8689						; entry:
8690						;
8691						; Y = ROM number
8692						;
8693						; exit:
8694						;
8695						; A = mask
8696						;
8697						; X = RTC address of byte
8698						;
8699	.eae6					getROMInsertedFlagRTCAddressAndMask:
8700	.eae6	a9 00		lda #$00	                lda #$00
8701	.eae8	38		sec		                sec
8702	.eae9	a2 06		ldx #$06	                ldx #CMOSBytes.insertedROMs+0+cmosBytesOffset
8703	.eaeb					-
8704	.eaeb	2a		rol a		                rol a
8705	.eaec	d0 02		bne $eaf0	                bne +
8706	.eaee	e8		inx		                inx
8707	.eaef	2a		rol a		                rol a
8708	.eaf0					+
8709	.eaf0	88		dey		                dey
8710	.eaf1	10 f8		bpl $eaeb	                bpl -
8711	.eaf3	60		rts		                rts

8713						;-------------------------------------------------------------------------

8715	=[]					_:=[]
8716	=[($03e0,32)]				_..=[(bufferKeyboardAddress,bufferKeyboardSize)]
8717	=[($03e0,32),($0a00,256)]		_..=[(bufferRS423InputAddress,bufferRS423InputSize)]
8718	=[($03e0,32),($0a00,256),($0900,192)]	_..=[(bufferRS423OutputAddress,bufferRS423OutputSize)]
8719	=[($03e0,32),($0a00,256),($0900,192),($0880,64)]
						_..=[(bufferPrinterAddress,bufferPrinterSize)]
8720	=[($03e0,32),($0a00,256),($0900,192),($0880,64),($0840,16)]
						_..=[(bufferSoundChannel0Address,bufferSoundChannel0Size)]
8721	=[($03e0,32),($0a00,256),($0900,192),($0880,64),($0840,16),($0850,16)]
						_..=[(bufferSoundChannel1Address,bufferSoundChannel1Size)]
8722	=[($03e0,32),($0a00,256),($0900,192),($0880,64),($0840,16),($0850,16),($0860,16)]
						_..=[(bufferSoundChannel2Address,bufferSoundChannel2Size)]
8723	=[($03e0,32),($0a00,256),($0900,192),($0880,64),($0840,16),($0850,16),($0860,16),($0870,16)]
						_..=[(bufferSoundChannel3Address,bufferSoundChannel3Size)]
8724	=[($03e0,32),($0a00,256),($0900,192),($0880,64),($0840,16),($0850,16),($0860,16),($0870,16),($09c0,64)]
						_..=[(buffer8Address,buffer8Size)]
8725	=[($03e0,32),($0a00,256),($0900,192),($0880,64),($0840,16),($0850,16),($0860,16),($0870,16),($09c0,64)]
						buffers=_

8727						BufferTableIndex0Offset: .function buffer
8728						                .endfunction 256-buffer[1]

8730						BufferTableBase: .function buffer
8731						                .endfunction buffer[0]-BufferTableIndex0Offset(buffer)

8733						;-------------------------------------------------------------------------
8734						;
8735						; Buffer base addresses - each buffer's address, offset by the offset
8736						; for index 0 (see bufferIndex0Offsets).
8737						;
8738	.eaf4					bufferBaseAddressMSBs:
8739						                .for i=0,i<len(buffers),i+=1
8740	>eaf4	03				                .byte >BufferTableBase(buffers[i])
8740	>eaf5	0a				                .byte >BufferTableBase(buffers[i])
8740	>eaf6	08				                .byte >BufferTableBase(buffers[i])
8740	>eaf7	07				                .byte >BufferTableBase(buffers[i])
8740	>eaf8	07				                .byte >BufferTableBase(buffers[i])
8740	>eaf9	07				                .byte >BufferTableBase(buffers[i])
8740	>eafa	07				                .byte >BufferTableBase(buffers[i])
8740	>eafb	07				                .byte >BufferTableBase(buffers[i])
8740	>eafc	09				                .byte >BufferTableBase(buffers[i])
8741						                .endfor

8743	.eafd					bufferBaseAddressLSBs:
8744						                .for i=0,i<len(buffers),i+=1
8745	>eafd	00				                .byte <BufferTableBase(buffers[i])
8745	>eafe	00				                .byte <BufferTableBase(buffers[i])
8745	>eaff	c0				                .byte <BufferTableBase(buffers[i])
8745	>eb00	c0				                .byte <BufferTableBase(buffers[i])
8745	>eb01	50				                .byte <BufferTableBase(buffers[i])
8745	>eb02	60				                .byte <BufferTableBase(buffers[i])
8745	>eb03	70				                .byte <BufferTableBase(buffers[i])
8745	>eb04	80				                .byte <BufferTableBase(buffers[i])
8745	>eb05	00				                .byte <BufferTableBase(buffers[i])
8746						                .endfor

8748						;-------------------------------------------------------------------------

8750						; Offset of buffer index 0 for each buffer. Index 0 is (-buffer size)
8751						; - buffer indexes count up, and wrap once they reach 0.

8753	.eb06					bufferIndex0Offsets:
8754						                .for i=0,i<len(buffers),i+=1
8755	>eb06	e0				                .byte BufferTableIndex0Offset(buffers[i])
8755	>eb07	00				                .byte BufferTableIndex0Offset(buffers[i])
8755	>eb08	40				                .byte BufferTableIndex0Offset(buffers[i])
8755	>eb09	c0				                .byte BufferTableIndex0Offset(buffers[i])
8755	>eb0a	f0				                .byte BufferTableIndex0Offset(buffers[i])
8755	>eb0b	f0				                .byte BufferTableIndex0Offset(buffers[i])
8755	>eb0c	f0				                .byte BufferTableIndex0Offset(buffers[i])
8755	>eb0d	f0				                .byte BufferTableIndex0Offset(buffers[i])
8755	>eb0e	c0				                .byte BufferTableIndex0Offset(buffers[i])
8756						                .endfor

8758						;-------------------------------------------------------------------------
8759						;
8760						; Get base address for a buffer.
8761						;
8762						; entry:
8763						;
8764						; X = buffer number
8765						;
8766						; exit:
8767						;
8768						; (SEIWKA) = buffer base address
8769						;
8770	.eb0f					getBufferBaseAddress:
8771	.eb0f	bd fd ea	lda $eafd,x	                lda bufferBaseAddressLSBs,x
8772	.eb12	85 fa		sta $fa		                sta SEIWKA
8773	.eb14	bd f4 ea	lda $eaf4,x	                lda bufferBaseAddressMSBs,x
8774	.eb17	85 fb		sta $fb		                sta SEIWKB
8775	.eb19	60		rts		                rts

8777						;-------------------------------------------------------------------------
8778						;
8779						; OSBYTE 152 (&98) Examine buffer status [MasRef D.2-45]
8780						;
8781	.eb1a					osbyte98:
8782	.eb1a	2c 70 e3	bit $e370	                bit valueFF                  ;V=1
8783	.eb1d	80 01		bra $eb20	                bra callREMV

8785						;-------------------------------------------------------------------------
8786						;
8787						; OSBYTE 145 (&91) Get character from buffer [MasRef D.2-45]
8788						;
8789						; X = buffer number
8790	.eb1f					osbyte91:
8791	.eb1f	b8		clv		                clv                          ;remove
8792	.eb20					callREMV:
8793	.eb20	6c 2c 02	jmp ($022c)	                jmp (REMV)

8795						;-------------------------------------------------------------------------
8796						;
8797						; Buffer remove entry point. [AUG p263]
8798						;
8799						; Even in remove mode, A is the character removed on exit. Some of the
8800						; other MOS routines rely on this.
8801						;
8802	.eb23					remEntryPoint:
8803	.eb23	08		php		                php
8804	.eb24	78		sei		                sei
8805	.eb25	bd d7 02	lda $02d7,x	                lda bufferStartIndices,x
8806	.eb28	dd e0 02	cmp $02e0,x	                cmp bufferEndIndices,x
8807	.eb2b	f0 6c		beq $eb99	                beq plp_sec_rts  ;taken if buffer empty
8808	.eb2d	a8		tay		                tay                          ;Y=start index
8809	.eb2e	20 0f eb	jsr $eb0f	                jsr getBufferBaseAddress
8810	.eb31	b1 fa		lda ($fa),y	                lda (SEIWKA),y               ;get byte from buffer
8811	.eb33	70 1a		bvs $eb4f	                bvs tay_plp_clc_rts                  ;taken if only looking
8812	.eb35	48		pha		                pha                          ;save buffered byte
8813	.eb36	c8		iny		                iny                          ;next char in buffer
8814	.eb37	98		tya		                tya                          ;set Z if wrap
8815	.eb38	d0 03		bne $eb3d	                bne +                        ;branch taken if no wrap
8816	.eb3a	bd 06 eb	lda $eb06,x	                lda bufferIndex0Offsets,x    ;reset index on wrap
8817	.eb3d					+
8818	.eb3d	9d d7 02	sta $02d7,x	                sta bufferStartIndices,x

8820						                ; Issue output buffer empty event when appropriate.
8821	.eb40	e0 02		cpx #$02	                cpx #bufferFirstOutput
8822	.eb42	90 0a		bcc $eb4e	                bcc pla_tay_plp_clc_rts ;taken if keyboard or RS423
8823						                                        ;input - i.e., buffer is input
8824	.eb44	dd e0 02	cmp $02e0,x	                cmp bufferEndIndices,x       ;buffer now empty?
8825	.eb47	d0 05		bne $eb4e	                bne pla_tay_plp_clc_rts           ;taken if not empty
8826	.eb49	a0 00		ldy #$00	                ldy #eventOutputBufferEmpty
8827	.eb4b	20 53 eb	jsr $eb53	                jsr eventEntryPoint
8828	.eb4e					pla_tay_plp_clc_rts:
8829	.eb4e	68		pla		                pla                          ;restore buffered byte
8830	.eb4f					tay_plp_clc_rts:
8831	.eb4f	a8		tay		                tay                          ;Y=buffered byte
8832	.eb50					plp_clc_rts:
8833	.eb50	28		plp		                plp
8834	.eb51	18		clc		                clc
8835	.eb52	60		rts		                rts

8837						;-------------------------------------------------------------------------
8838						;
8839						; [MasRef D.9-1]
8840						;
8841	.eb53					eventEntryPoint:
8842	.eb53	08		php		                php
8843	.eb54	78		sei		                sei
8844	.eb55	48		pha		                pha
8845	.eb56	b9 bf 02	lda $02bf,y	                lda eventEnabledFlags,y      ;is the event enabled?
8846	.eb59	f0 3d		beq $eb98	                beq pla_plp_sec_rts                    ;
8847	.eb5b	98		tya		                tya
8848	.eb5c	7a		ply		                ply
8849	.eb5d	5a		phy		                phy
8850	.eb5e	20 38 f7	jsr $f738	                jsr LF8BF
8851	.eb61	80 eb		bra $eb4e	                bra pla_tay_plp_clc_rts

8853						;-------------------------------------------------------------------------
8854						;
8855						; Insert character into buffer and issue an event for it.
8856						;
8857						; entry:
8858						;
8859						; Y = buffer number
8860						;
8861	.eb63					insertCharacterIntoBuffer:
8862	.eb63	98		tya		                tya
8863	.eb64	a0 02		ldy #$02	                ldy #eventCharacterEnteringBuffer
8864	.eb66	20 53 eb	jsr $eb53	                jsr eventEntryPoint
8865	.eb69	a8		tay		                tay

8867						;-------------------------------------------------------------------------
8868						;
8869						; OSBYTE 138 (&8A) Insert character code into buffer [MasRef D.2-43]
8870						;
8871	.eb6a					osbyte8A:
8872	.eb6a	98		tya		                tya
8873	.eb6b					callINSV:
8874	.eb6b	6c 2a 02	jmp ($022a)	                jmp (INSV)

8876						;-------------------------------------------------------------------------
8877						;
8878						; Default INSV entry point [AUG p263]
8879						;
8880	.eb6e					insEntryPoint:
8881	.eb6e	08		php		                php
8882	.eb6f	78		sei		                sei
8883	.eb70	48		pha		                pha                          ;save value to insert
8884	.eb71	bd e0 02	lda $02e0,x	                lda bufferEndIndices,x       ;get buffer index
8885	.eb74	1a		inc a		                inc a                        ;bump index
8886	.eb75	d0 03		bne $eb7a	                bne +          ;taken if index hasn't wrapped around
8887	.eb77	bd 06 eb	lda $eb06,x	                lda bufferIndex0Offsets,x        ;reset index due to wrap
8888	.eb7a					+
8889	.eb7a	dd d7 02	cmp $02d7,x	                cmp bufferStartIndices,x     ;are we at the start index?
8890	.eb7d	f0 0e		beq $eb8d	                beq bufferFull       ;taken if yes - i.e., buffer full
8891	.eb7f	bc e0 02	ldy $02e0,x	                ldy bufferEndIndices,x       ;note old buffer end
8892	.eb82	9d e0 02	sta $02e0,x	                sta bufferEndIndices,x       ;update buffer end
8893	.eb85	20 0f eb	jsr $eb0f	                jsr getBufferBaseAddress
8894	.eb88	68		pla		                pla                          ;restore value to insert
8895	.eb89	91 fa		sta ($fa),y	                sta (SEIWKA),y               ;store byte in buffer
8896	.eb8b	80 c3		bra $eb50	                bra plp_clc_rts              ;done

8898	.eb8d					bufferFull
8899						                ; Issue input buffer full event when appropriate.
8900	.eb8d	68		pla		                pla
8901	.eb8e	e0 02		cpx #$02	                cpx #bufferFirstOutput
8902	.eb90	b0 07		bcs $eb99	                bcs plp_sec_rts  ;taken if output buffer
8903	.eb92	a0 01		ldy #$01	                ldy #eventInputBufferFull
8904	.eb94	20 53 eb	jsr $eb53	                jsr eventEntryPoint
8905	.eb97	48		pha		                pha
8906	.eb98					pla_plp_sec_rts:
8907	.eb98	68		pla		                pla
8908	.eb99					plp_sec_rts:
8909	.eb99	28		plp		                plp
8910	.eb9a	38		sec		                sec
8911	.eb9b	60		rts		                rts

8913						;-------------------------------------------------------------------------
8914						;
8915						; Check if character is a letter - A-Z or a-z.
8916						;
8917						; Entry:
8918						;
8919						; A = character to test
8920						;
8921						; Exit:
8922						;
8923						; C=0 if character is letter, C=1 otherwise
8924						;
8925						; Preserves: A/X/Y
8926	.eb9c					isLetter: .proc                 ;EA71
8927	.eb9c	48		pha		                pha
8928	.eb9d	29 df		and #$df	                and #$DF        ;convert to upper case
8929	.eb9f	c9 5b		cmp #$5b	                cmp #'Z'+1
8930	.eba1	b0 04		bcs $eba7	                bcs +           ;branch taken with C=1 if past Z
8931	.eba3	49 ff		eor #$ff	                eor #$FF
8932	.eba5	c9 bf		cmp #$bf	                cmp #-'A'       ;C=1 if past A
8933	.eba7					+
8934	.eba7	68		pla		                pla
8935	.eba8	60		rts		                rts
8936						                .pend

8938						;-------------------------------------------------------------------------
8939						;
8940						; OSBYTE 153 (&99) Insert character code into buffer, checking for
8941						; ESCAPE [MasRef D.2-46]
8942						;
8943	.eba9					insertCharacterIntoKeyboardBuffer:
8944						                .if version==350
8947						                .endif
8948	.eba9	a2 00		ldx #$00	                ldx #$00
8949	.ebab					osbyte99:
8950						                .if version!=400
8951	.ebab	8a		txa		                txa                          ;X=1 if RS423, 0 if keyboard
8952	.ebac	2d 45 02	and $0245	                and rs423InputInterpretationStatus ;A=0 if RS423 simulates keyboard, 1=default
8953	.ebaf	d0 b9		bne $eb6a	                bne osbyte8A ;taken if default - don't treat RS423 as keyboard
8954						                .endif
8955	.ebb1	98		tya		                tya          ;A=char
8956	.ebb2	4d 6c 02	eor $026c	                eor escapeCharacter
8957	.ebb5	0d 75 02	ora $0275	                ora escapeKeyStatus
8958	.ebb8	d0 a9		bne $eb63	                bne insertCharacterIntoBuffer
8959	.ebba	ad 58 02	lda $0258	                lda breakAndESCAPEEffect
8960	.ebbd	6a		ror a		                ror a                        ;C=0 if normal ESCAPE action
8961	.ebbe	98		tya		                tya                          ;A=char
8962	.ebbf	b0 0a		bcs $ebcb	                bcs osbyte99Done             ;taken if ESCAPE inhibited
8963	.ebc1	a0 06		ldy #$06	                ldy #eventESCAPEPressed
8964	.ebc3	20 53 eb	jsr $eb53	                jsr eventEntryPoint
8965	.ebc6	90 03		bcc $ebcb	                bcc osbyte99Done             ;taken if event handled
8966	.ebc8	20 f5 ec	jsr $ecf5	                jsr osbyte7D
8967	.ebcb					osbyte99Done:
8968	.ebcb	18		clc		                clc
8969	.ebcc	60		rts		                rts

8971						;-------------------------------------------------------------------------

8973						; A = 0 (edit keys)/1 (ascii keys)/2 (F keys)
8974	.ebcd					handleCursorKeysAndCopy:
8975						                .if version<500
8979						                .else
8980	.ebcd	c9 02		cmp #$02	                cmp #2
8981	.ebcf	68		pla		                pla
8982	.ebd0	90 2a		bcc $ebfc	                bcc clc_rts_EABD
8983						                .endif

8985	.ebd2					handleFunctionKey:
8986	.ebd2	98		tya		                tya
8987						                .if version<500&&version!=350
8989						                .endif
8990						                .if version==350
8993						                .else
8994	.ebd3	48		pha		                pha
8995	.ebd4	98		tya		                tya
8996	.ebd5	4a		lsr a		                lsr a
8997	.ebd6	4a		lsr a		                lsr a
8998	.ebd7	4a		lsr a		                lsr a
8999	.ebd8	4a		lsr a		                lsr a
9000						                .endif
9001	.ebd9	49 04		eor #$04	                eor #$04
9002	.ebdb	a8		tay		                tay
9003	.ebdc	b9 65 02	lda $0265,y	                lda input192To207Interpretation-8,y
9004	.ebdf	4a		lsr a		                lsr a
9005						                .if version<500&&version!=350
9010						                .else
9011	.ebe0	d0 03		bne $ebe5	                bne +
9012	.ebe2	4c 99 ec	jmp $ec99	                jmp LEC99
9013	.ebe5					+
9014	.ebe5	2a		rol a		                rol a
9015	.ebe6	c9 02		cmp #$02	                cmp #2
9016	.ebe8	d0 0b		bne $ebf5	                bne LEBF5
9017	.ebea					LEBEA:
9018	.ebea	68		pla		                pla
9019	.ebeb	85 f8		sta $f8		                sta softKeyExpansionPtr
9020	.ebed	a9 ff		lda #$ff	                lda #$ff
9021	.ebef	8d 68 02	sta $0268	                sta softKeyStringLength
9022	.ebf2	1a		inc a		                inc a
9023	.ebf3	80 07		bra $ebfc	                bra clc_rts_EABD

9025	.ebf5					LEBF5:
9026	.ebf5	68		pla		                pla
9027	.ebf6	29 0f		and #$0f	                and #$0f
9028	.ebf8	18		clc		                clc
9029	.ebf9	79 65 02	adc $0265,y	                adc input192To207Interpretation-8,y
9030						                .endif

9032	.ebfc					clc_rts_EABD:
9033	.ebfc	18		clc		                clc
9034	.ebfd	60		rts		                rts

9036						;-------------------------------------------------------------------------

9038	.ebfe					copyCharNotRecognised:
9039	.ebfe	20 5f f0	jsr $f05f	                jsr vdu7EntryPoint           ;beep
9040	.ec01	fa		plx		                plx
9041	.ec02					readFromInputBufferX:
9042	.ec02	20 1f eb	jsr $eb1f	                jsr osbyte91          ;extract character from buffer X
9043						                .if version<500&&version!=350
9045						                .elsif version>=500||version==350
9046	.ec05	b0 06		bcs $ec0d	                bcs LEC0D
9047	.ec07	a8		tay		                tay
9048	.ec08	d0 18		bne $ec22	                bne LEAC8
9049						                .if version>=511||version==350
9053						                .endif
9054						                .if version==350&&!finmos329
9056						                .else
9057	.ec0a	20 1f eb	jsr $eb1f	                jsr osbyte91
9058						                .endif
9059	.ec0d					LEC0D:
9060	.ec0d	b0 7d		bcs $ec8c	                bcs rtsEB28
9061	.ec0f	a8		tay		                tay
9062	.ec10	d0 ea		bne $ebfc	                bne clc_rts_EABD
9063	.ec12	48		pha		                pha
9064	.ec13	a0 08		ldy #$08	                ldy #8

9066	.ec15					LEC15:
9067	.ec15	b9 6c 02	lda $026c,y	                lda shiftCtrlSoftKeyInterpretation-8,y
9068	.ec18	c9 02		cmp #$02	                cmp #2
9069	.ec1a	f0 ce		beq $ebea	                beq LEBEA
9070	.ec1c	88		dey		                dey
9071	.ec1d	d0 f6		bne $ec15	                bne LEC15
9072	.ec1f	68		pla		                pla
9073	.ec20	80 da		bra $ebfc	                bra clc_rts_EABD
9074						                .endif

9076						                .if version>=511||version==350
9079						                .endif

9081						                .if version!=400
9082	.ec22					LEAC8:
9083	.ec22	48		pha		                pha                   ;save character extracted
9084	.ec23	e0 01		cpx #$01	                cpx #bufferRS423Input ;was it RS423 input buffer?
9085	.ec25	d0 06		bne $ec2d	                bne LEAD3             ;taken if not RS423 input buffer
9086	.ec27	20 36 ea	jsr $ea36	                jsr setRS423Active
9087	.ec2a	38		sec		                sec
9088	.ec2b	a2 01		ldx #$01	                ldx #bufferRS423Input

9090	.ec2d					LEAD3:
9091	.ec2d	68		pla		                pla                          ;restore char extracted
9092	.ec2e	90 05		bcc $ec35	                bcc LEADB                    ;taken if keyboard buffer
9093	.ec30	ac 45 02	ldy $0245	                ldy rs423InputInterpretationStatus ;D.2-54
9094	.ec33	d0 56		bne $ec8b	                bne clc_rts_EB27             ;taken if default mode
9095						                .endif

9097	.ec35					LEADB:
9098	.ec35	a8		tay		                tay                          ;Y = char
9099	.ec36	10 53		bpl $ec8b	                bpl clc_rts_EB27             ;if normal char, all good
9100	.ec38	29 0f		and #$0f	                and #$0F
9101	.ec3a	c9 0b		cmp #$0b	                cmp #$0B
9102	.ec3c	90 94		bcc $ebd2	                bcc handleFunctionKey        ;taken if F key
9103	.ec3e	69 7b		adc #$7b	                adc #$7B    ;C=1, so +$7c - convert $0b-0$f to $87-$8B
9104	.ec40	48		pha		                pha         ;save translated value
9105	.ec41	ad 7d 02	lda $027d	                lda editKeysMode
9106	.ec44	d0 87		bne $ebcd	                bne handleCursorKeysAndCopy  ;taken if not editKeys
9107	.ec46	ad 7c 02	lda $027c	                lda characterDestinationStatus
9108	.ec49	6a		ror a		                ror a                        ;C=rs423_enable
9109	.ec4a	6a		ror a		                ror a                        ;C=vdu_disable
9110	.ec4b	68		pla		                pla                          ;restore translated value
9111	.ec4c	b0 b4		bcs $ec02	                bcs readFromInputBufferX     ;taken if VDU output disabled
9112	.ec4e	c9 87		cmp #$87	                cmp #$87                     ;COPY?
9113	.ec50	f0 3b		beq $ec8d	                beq readCopyChar
9114	.ec52	da		phx		                phx                          ;save buffer number
9115	.ec53	20 c9 ec	jsr $ecc9	                jsr handleCursorKeyThunk     ;handle cursor key
9116	.ec56	fa		plx		                plx
9117	.ec57					readFromEconetOrSoftKeyOrInputBufferA:
9118						                .if version==400
9120						                .endif
9121	.ec57	2c 5f 02	bit $025f	                bit econetInputInterpretationStatus
9122	.ec5a	10 05		bpl $ec61	                bpl readFromSoftKeyOrInputBufferA
9123	.ec5c	a9 06		lda #$06	                lda #netReadCharacterAttempted
9124	.ec5e					callNETV:
9125	.ec5e	6c 24 02	jmp ($0224)	                jmp (NETV)

9127	.ec61					readFromSoftKeyOrInputBufferA:
9128	.ec61	ad 68 02	lda $0268	                lda softKeyStringLength
9129	.ec64	f0 9c		beq $ec02	                beq readFromInputBufferX
9130						                .if version>=500||version==350
9131	.ec66	1a		inc a		                inc a
9132	.ec67	d0 07		bne $ec70	                bne LEC70
9133	.ec69	9c 68 02	stz $0268	                stz softKeyStringLength
9134	.ec6c	a5 f8		lda $f8		                lda softKeyExpansionPtr
9135	.ec6e	80 1b		bra $ec8b	                bra clc_rts_EB27
9136	.ec70					LEC70:
9137						                .endif
9138						                .if version!=400
9139	.ec70	8a		txa		                txa
9140	.ec71	2d 45 02	and $0245	                and rs423InputInterpretationStatus
9141	.ec74	d0 8c		bne $ec02	                bne readFromInputBufferX
9142						                .endif
9143	.ec76	a5 f4		lda $f4		                lda $F4
9144	.ec78	48		pha		                pha
9145	.ec79	20 b1 e5	jsr $e5b1	                jsr selectTerminalROMAndANDY2
9146	.ec7c	b2 f8		lda ($f8)	                lda (softKeyExpansionPtr)
9147	.ec7e	fa		plx		                plx
9148	.ec7f	20 9a e5	jsr $e59a	                jsr selectROMX
9149	.ec82	ce 68 02	dec $0268	                dec softKeyStringLength
9150	.ec85	e6 f8		inc $f8		                inc softKeyExpansionPtr+0
9151	.ec87	d0 02		bne $ec8b	                bne clc_rts_EB27
9152	.ec89	e6 f9		inc $f9		                inc softKeyExpansionPtr+1
9153	.ec8b					clc_rts_EB27:
9154	.ec8b	18		clc		                clc
9155	.ec8c					rtsEB28:
9156	.ec8c	60		rts		                rts

9158	.ec8d					readCopyChar:
9159	.ec8d	da		phx		                phx
9160	.ec8e	20 cf ec	jsr $eccf	                jsr handleCopyKeyThunk
9161						                .if version<500&&version!=350
9163						                .else
9164	.ec91	d0 03		bne $ec96	                bne +
9165	.ec93	4c fe eb	jmp $ebfe	                jmp copyCharNotRecognised
9166	.ec96					+
9167						                .endif
9168	.ec96	fa		plx		                plx
9169	.ec97	18		clc		                clc
9170	.ec98					rtsEB31:
9171	.ec98	60		rts		                rts

9173						                .if version>=500||version==350
9174	.ec99					LEC99:
9175	.ec99	68		pla		                pla
9176	.ec9a	29 0f		and #$0f	                and #$0f
9177	.ec9c	a8		tay		                tay
9178	.ec9d	b0 03		bcs $eca2	                bcs LECA2
9179	.ec9f	4c 02 ec	jmp $ec02	                jmp readFromInputBufferX

9181	.eca2					LECA2:
9182	.eca2	8d c9 02	sta $02c9	                sta currentSoftKey

9192						                .endif

9194	.eca5	a5 f4		lda $f4		                lda $F4
9195	.eca7	48		pha		                pha                           ;save old ROMSEL
9196	.eca8	20 b1 e5	jsr $e5b1	                jsr selectTerminalROMAndANDY2
9197	.ecab	20 c1 ec	jsr $ecc1	                jsr getSoftKeyStringLength
9198	.ecae	8d 68 02	sta $0268	                sta softKeyStringLength
9199	.ecb1	b9 00 80	lda $8000,y	                lda andy.softKeys.stringLSBs,y
9200	.ecb4	85 f8		sta $f8		                sta softKeyExpansionPtr+0
9201	.ecb6	b9 11 80	lda $8011,y	                lda andy.softKeys.stringMSBs,y
9202	.ecb9	85 f9		sta $f9		                sta softKeyExpansionPtr+1
9203	.ecbb	68		pla		                pla
9204	.ecbc	20 ab e5	jsr $e5ab	                jsr selectROMA               ;restore old ROMSEL
9205	.ecbf	80 96		bra $ec57	                bra readFromEconetOrSoftKeyOrInputBufferA

9207						;-------------------------------------------------------------------------

9209	.ecc1					getSoftKeyStringLength:
9210	.ecc1	b9 01 80	lda $8001,y	                lda andy.softKeys.stringLSBs+1,y
9211	.ecc4	38		sec		                sec
9212	.ecc5	f9 00 80	sbc $8000,y	                sbc andy.softKeys.stringLSBs+0,y
9213	.ecc8	60		rts		                rts

9215						;-------------------------------------------------------------------------
9216						;
9217						; Page HAZEL out, page MOS in, call handleCursorKey.
9218						;
9219	.ecc9					handleCursorKeyThunk:
9220	.ecc9	20 77 f4	jsr $f477	                jsr withMOSROM
9221	.eccc	4c 78 df	jmp $df78	                jmp handleCursorKey

9223						;-------------------------------------------------------------------------
9224						;
9225						; Page HAZEL out, page MOS in, call handleCopyKey.
9226						;
9227	.eccf					handleCopyKeyThunk:
9228	.eccf	20 77 f4	jsr $f477	                jsr withMOSROM
9229	.ecd2	4c 5e df	jmp $df5e	                jmp handleCopyKey

9231						;-------------------------------------------------------------------------

9233						                .if version==350&&!finmos329
9241						                .endif

9243						;-------------------------------------------------------------------------

9245						                .if version<500&&version!=350
9247						                .endif

9249						;-------------------------------------------------------------------------

9251	.ecd5					osbyte88: ;LEC37:
9252	.ecd5	a9 00		lda #$00	                lda #$00

9254	.ecd7					callUSERV:
9255	.ecd7	6c 00 02	jmp ($0200)	                jmp (USERV)

9257	.ecda					osbyte7E:                       ;ec3c
9258	.ecda	a2 00		ldx #$00	                ldx #$00
9259	.ecdc	24 ff		bit $ff		                bit $FF
9260	.ecde	10 14		bpl $ecf4	                bpl osbyte7C
9261	.ece0	ad 76 02	lda $0276	                lda escapeEffects
9262	.ece3	d0 0d		bne $ecf2	                bne LEC54
9263	.ece5	58		cli		                cli
9264	.ece6	9c 69 02	stz $0269	                stz pagedModeCounter
9265	.ece9	20 50 f4	jsr $f450	                jsr withTerminalROM
9266	.ecec	20 8d a9	jsr $a98d	                jsr terminal.starEXEC
9267	.ecef	20 72 ea	jsr $ea72	                jsr LE947
9268	.ecf2					LEC54:
9269	.ecf2	a2 ff		ldx #$ff	                ldx #$FF
9270	.ecf4					osbyte7C: ;EC56
9271	.ecf4	18		clc		                clc
9272	.ecf5					osbyte7D: ;EC57
9273						                .if version<500
9283						                .elsif version>=500
9284	.ecf5	08		php		                php
9285	.ecf6	78		sei		                sei
9286	.ecf7	08		php		                php
9287	.ecf8	06 ff		asl $ff		                asl escapeFlag
9288	.ecfa	28		plp		                plp
9289	.ecfb	66 ff		ror $ff		                ror escapeFlag
9290	.ecfd	28		plp		                plp
9291	.ecfe	80 6e		bra $ed6e	                bra LECD9
9292						                .endif

9294						;-------------------------------------------------------------------------

9296						                .if version<400
9304						                .endif

9306						;-------------------------------------------------------------------------
9307						;
9308						; ;OSBYTE 8 (&08) Write RS423 transmit rate
9309						;
9310						; This call sets the RS423 baud rate for transmitting data. The actual format of
9311						; the data is set using OSBYTE 156/&9C (see below).
9312						;
9313						; Entry parameters :
9314						; X=0 selects 9600 baud
9315						; X=1 selects 75 baud
9316						; X=2 selects 150 baud
9317						; X=3 selects 300 baud
9318						; X=4 selects 1200 baud
9319						; X=5 selects 2400 baud
9320						; X=6 selects 4800 baud
9321						; X=7 selects 9600 baud
9322						; X=8 selects 19200 baud
9323						; Y=0
9324						;
9325						; On exit : X=Y=<old serial ACIA control register contents>

9327						                .if version!=400
9328	.ed00					osbyte08:
9329	.ed00	a9 38		lda #$38	                lda #$38
9330						                ; fall through to OSBYTE &07
9331						                .endif

9333						;-------------------------------------------------------------------------
9334						;
9335						; OSBYTE 7 (&07) Write RS423 receive rate
9336						;
9337						; This call sets the RS423 baud rate for receiving data. The actual
9338						; format of the data is set using OSBYTE 156/&9C (see below).
9339						;
9340						; Entry parameters :
9341						; X=0 selects 9600 baud
9342						; X=1 selects 75 baud
9343						; X=2 selects 150 baud
9344						; X=3 selects 300 baud
9345						; X=4 selects 1200 baud
9346						; X=5 selects 2400 baud
9347						; X=6 selects 4800 baud
9348						; X=7 selects 9600 baud
9349						; X=8 selects 19200 baud
9350						; Y=0
9351						;
9352						; On exit : X=Y=<old serial ACIA control register contents>

9354						                .if version!=400
9355	.ed02					osbyte07:                                    ;ec6d
9356	.ed02	49 3f		eor #$3f	                eor #$3F                     ;if OSBYTE 8,
9357						                                             ;A=%00000111, mask for
9358						                                             ;transmit rate; if OSBYTE
9359						                                             ;8, A=%000111000, mask
9360						                                             ;for receive rate.
9361	.ed04	85 fa		sta $fa		                sta $FA                      ;save mask
9362	.ed06	ac 82 02	ldy $0282	                ldy serialULARegister                    ;
9363	.ed09	e0 09		cpx #$09	                cpx #$09                     ;check for invalid baud rate
9364	.ed0b	b0 17		bcs $ed24	                bcs LEC8F                    ;branch taken if invalid
9365	.ed0d	3d 95 f1	and $f195,x	                and serialBaudRatesTable,x   ;get setting in A
9366	.ed10	85 fb		sta $fb		                sta $FB                      ;store setting
9367	.ed12	98		tya		                tya                          ;
9368	.ed13	05 fa		ora $fa		                ora $FA
9369	.ed15	45 fa		eor $fa		                eor $FA
9370	.ed17	05 fb		ora $fb		                ora $FB
9371	.ed19	09 40		ora #$40	                ora #$40
9372	.ed1b	4d 5d 02	eor $025d	                eor rs423Destination ;mask in tape/serial flag set by OSBYTE 205ac
9373	.ed1e					LEC89:
9374	.ed1e	8d 82 02	sta $0282	                sta serialULARegister
9375	.ed21	8d 10 fe	sta $fe10	                sta SERPROC+0
9376	.ed24					LEC8F:
9377	.ed24	98		tya		                tya
9378	.ed25					LEC90:
9379	.ed25	aa		tax		                tax
9380	.ed26	60		rts		                rts
9381						                .endif

9383						                .if version==400
9388						                .endif

9390						;-------------------------------------------------------------------------

9392						; Y=0 on entry.

9394	.ed27					osbyte09:                       ;ec92
9395	.ed27	c8		iny		                iny
9396	.ed28	18		clc		                clc
9397	.ed29					osbyte0A:                                    ;ec94
9398	.ed29	b9 52 02	lda $0252,y	                lda firstFlashColourDuration,y
9399	.ed2c	48		pha		                pha
9400	.ed2d	8a		txa		                txa
9401	.ed2e	99 52 02	sta $0252,y	                sta firstFlashColourDuration,y
9402	.ed31	7a		ply		                ply
9403	.ed32	ad 51 02	lda $0251	                lda flashCounter
9404	.ed35	d0 ed		bne $ed24	                bne LEC8F
9405	.ed37	8e 51 02	stx $0251	                stx flashCounter
9406	.ed3a	ad 48 02	lda $0248	                lda vcontrolRegister
9407	.ed3d	08		php		                php
9408	.ed3e	6a		ror a		                ror a
9409	.ed3f	28		plp		                plp
9410	.ed40	2a		rol a		                rol a
9411	.ed41	8d 48 02	sta $0248	                sta vcontrolRegister
9412	.ed44	8d 20 fe	sta $fe20	                sta VCONTROL
9413	.ed47	80 db		bra $ed24	                bra LEC8F

9415						;-------------------------------------------------------------------------
9416						;
9417						; OSBYTE 2 (&02) Specify input stream
9418						;
9419						; Input may be taken from either the keyboard (by default) or the
9420						; RS423 port. This call specifies the selection for all subsequent
9421						; input.
9422						;
9423						; Entry parameters :
9424						; X=0 selects keyboard input and disables RS423
9425						; X=1 selects and enables RS423 input
9426						; X=2 selects keyboard input and enables RS423
9427						; Y=0
9428						;
9429						; On exit : X=0 indicates previous input was from the keyboard
9430						;           X=1 indicates previous input was from RS423
9431						;           Y is undefined
9432						;
9433						; D.2-18
9434						                .if version!=400
9435	.ed49					osbyte02:                       ;ecb4
9436	.ed49	8a		txa		                txa
9437	.ed4a	29 01		and #$01	                and #$01
9438	.ed4c	48		pha		                pha
9439	.ed4d	ad 50 02	lda $0250	                lda aciaControlRegister
9440	.ed50	2a		rol a		                rol a
9441	.ed51	e0 01		cpx #$01	                cpx #$01
9442	.ed53	6a		ror a		                ror a
9443	.ed54	cd 50 02	cmp $0250	                cmp aciaControlRegister
9444	.ed57	08		php		                php
9445	.ed58	8d 50 02	sta $0250	                sta aciaControlRegister
9446	.ed5b	8d 08 fe	sta $fe08	                sta ACIA+0
9447	.ed5e	20 36 ea	jsr $ea36	                jsr setRS423Active
9448	.ed61	28		plp		                plp
9449	.ed62	f0 03		beq $ed67	                beq LECD2
9450	.ed64	2c 09 fe	bit $fe09	                bit ACIA+1
9451	.ed67					LECD2:
9452	.ed67	ae 41 02	ldx $0241	                ldx inputSource
9453	.ed6a	68		pla		                pla
9454	.ed6b	8d 41 02	sta $0241	                sta inputSource
9455	.ed6e					LECD9:
9456	.ed6e	60		rts		                rts
9457						                .endif

9459						;-------------------------------------------------------------------------
9460						;
9461						; OSBYTE 13 (&0D) Disable event
9462						;
9463						; All events are assigned a unique number and this call provides a
9464						; means of disabling specific events.
9465						;
9466						; Entry parameters:
9467						; X = event number
9468						;
9469						; On exit: X = Y = <old enable state> (0=disabled)
9470	.ed6f					osbyte0D:
9471	.ed6f	98		tya		                tya             ;A=0

9473						;-------------------------------------------------------------------------
9474						;
9475						; OSBYTE 14 (&0E) Enable event
9476						;
9477						; This call provides a means of enabling specific events.
9478						;
9479						;
9480	.ed70					osbyte0E:
9481	.ed70	e0 0a		cpx #$0a	                cpx #eventMax+1
9482						                .if version!=400
9483	.ed72	b0 b1		bcs $ed25	                bcs LEC90
9486						                .endif
9487	.ed74	bc bf 02	ldy $02bf,x	                ldy eventEnabledFlags,x
9488	.ed77	9d bf 02	sta $02bf,x	                sta eventEnabledFlags,x
9489						                .if version!=400
9490	.ed7a	80 a8		bra $ed24	                bra LEC8F
9499						                .endif

9501						;-------------------------------------------------------------------------
9502						;
9503						; OSBYTE 16 (&10) Write number of ADC channels
9504						;
9505						; By default, each of the four ADC channels is sampled and converted
9506						; in turn so that each reading is updated every 40 milliseconds. This
9507						; call enables the number of channels to be changed so that if, for
9508						; example, only two channels are required, each will be updated every
9509						; 20 milliseconds.
9510						;
9511						                .if version!=400
9512	.ed7c					osbyte10:
9513						                .if version<500
9517						                .endif
9518	.ed7c	ad 4d 02	lda $024d	                lda maximumADCChannel
9519	.ed7f	8e 4d 02	stx $024d	                stx maximumADCChannel
9520	.ed82	aa		tax		                tax
9521	.ed83	60		rts		                rts
9522						                .endif

9524						;-------------------------------------------------------------------------
9525						;
9526						; OSBYTE 129 (&81) Read key with time limit
9527						;
9528						; This call may be used to read a key from the keyboard subject to a
9529						; specified time limit or to perform a keyboard scan for a specified
9530						; key depression.

9532	.ed84					osbyte81:
9533	.ed84	98		tya		                tya
9534	.ed85	30 0a		bmi $ed91	                bmi LED01          ;taken if scanning for specific key
9535	.ed87	20 e1 e8	jsr $e8e1	                jsr osbyte81Timed
9536	.ed8a	b0 03		bcs $ed8f	                bcs LECFF                 ;taken if timed out or error
9537	.ed8c	aa		tax		                tax                       ;X = ASCII char
9538	.ed8d					LECFD:
9539	.ed8d	a9 00		lda #$00	                lda #$00
9540	.ed8f					LECFF:
9541	.ed8f	a8		tay		                tay
9542	.ed90	60		rts		                rts

9544	.ed91					LED01:
9545	.ed91	8a		txa		                txa
9546	.ed92	f0 10		beq $eda4	                beq LED14
9547	.ed94	49 7f		eor #$7f	                eor #$7F
9548	.ed96	aa		tax		                tax
9549	.ed97	20 7b f7	jsr $f77b	                jsr callKEYV
9550	.ed9a	2a		rol a		                rol a
9551						                ; fall through

9553						;-------------------------------------------------------------------------

9555	.ed9b					osbyte82:
9556	.ed9b	a2 ff		ldx #$ff	                ldx #$FF
9557	.ed9d	a0 ff		ldy #$ff	                ldy #$FF
9558	.ed9f	b0 02		bcs $eda3	                bcs LEB13                    ;if OSBYTE $82, done
9559	.eda1	e8		inx		                inx
9560	.eda2	c8		iny		                iny
9561	.eda3					LEB13:
9562	.eda3	60		rts		                rts

9564	.eda4					LED14:
9565						                .if version==320
9569						                .elsif version==500||version==510
9570	.eda4	a2 f5		ldx #$f5	                ldx #$f5
9575						                .endif
9576	.eda6	80 e5		bra $ed8d	                bra LECFD

9578	.eda8					LED18:
9579						                .if version==400
9581						                .endif
9582	.eda8	8a		txa		                txa
9583	.eda9	49 ff		eor #$ff	                eor #$FF
9584	.edab	aa		tax		                tax
9585	.edac	e0 02		cpx #$02	                cpx #$02
9586						                ; fall through

9588						;-------------------------------------------------------------------------

9590	.edae					countBufferViaCNPV:
9591	.edae	b8		clv		                clv
9592	.edaf	80 03		bra $edb4	                bra callCNPV

9594	.edb1					purgeBufferViaCNPV:
9595	.edb1	2c 70 e3	bit $e370	                bit valueFF                  ;V=1
9596	.edb4					callCNPV:
9597	.edb4	6c 2e 02	jmp ($022e)	                jmp (CNPV)

9599						;-------------------------------------------------------------------------

9601						                .if version!=400
9602	.edb7					getRS423InputBufferFreeBytes:
9603	.edb7	38		sec		                sec
9604	.edb8	a2 01		ldx #$01	                ldx #bufferRS423Input
9605	.edba	20 ae ed	jsr $edae	                jsr countBufferViaCNPV
9606	.edbd	c0 01		cpy #$01	                cpy #$01                     ;check MSB
9607	.edbf	b0 03		bcs $edc4	                bcs +                        ;if >= 256 bytes, all good
9608	.edc1	ec 5b 02	cpx $025b	                cpx rs423InputBufferMinimumSpace ;compare to min space
9609	.edc4					+
9610	.edc4	60		rts		                rts
9611						                .endif

9613						;-------------------------------------------------------------------------

9615						                .if version!=400
9616	.edc5					osbyte80:
9617	.edc5	30 e1		bmi $eda8	                bmi LED18
9618	.edc7	f0 0e		beq $edd7	                beq LED45
9619						                .if version<500
9625						                .elsif version>=500
9626	.edc9	e8		inx		                inx
9627	.edca	8a		txa		                txa
9628	.edcb	29 01		and #$01	                and #1
9629	.edcd	0a		asl a		                asl a
9630	.edce	aa		tax		                tax
9631	.edcf	bc b8 02	ldy $02b8,x	                ldy adcResultLSBs+3-1,x
9632	.edd2	bd b7 02	lda $02b7,x	                lda adcResultLSBs+2-1,x
9633	.edd5	aa		tax		                tax
9634						                .endif
9635	.edd6	60		rts		                rts
9636						                .endif

9638						;-------------------------------------------------------------------------

9640						                .if version!=400
9641	.edd7					LED45:
9642						                .if version<500
9654						                .elsif version>=500
9655	.edd7	ac 4c 02	ldy $024c	                ldy currentADCChannel
9656	.edda	ae b6 02	ldx $02b6	                ldx adcResultLSBs
9657						                .endif
9658	.eddd	60		rts		                rts
9659						                .endif

9661						;-------------------------------------------------------------------------
9662						;
9663						; OSBYTE $70
9664						;
9665						; D.2-31
9666						;
9667	.edde					osbyte70:                       ;ed58
9668	.edde	20 f6 ed	jsr $edf6	                jsr osbyte7071
9669	.ede1	0a		asl a		                asl a
9670	.ede2	f0 04		beq $ede8	                beq clearACCCCONE
9671	.ede4					LED5E:
9672	.ede4	0c 34 fe	tsb $fe34	                tsb ACCCON
9673	.ede7	60		rts		                rts

9675	.ede8					clearACCCCONE:
9676	.ede8	a9 02		lda #$02	                lda #ACCCON.E
9677	.edea					LED64:
9678	.edea	1c 34 fe	trb $fe34	                trb ACCCON
9679	.eded	60		rts		                rts

9681						;-------------------------------------------------------------------------

9683	.edee					osbyte71:                       ;ed68
9684	.edee	20 f6 ed	jsr $edf6	                jsr osbyte7071
9685	.edf1	d0 f1		bne $ede4	                bne LED5E
9686	.edf3	1a		inc a		                inc a
9687	.edf4	80 f4		bra $edea	                bra LED64

9689						;-------------------------------------------------------------------------
9690						;
9691						; Handle OSBYTE $70 or OSBYTE $71
9692						;
9693						; Entry: A=$70 or $71
9694						;
9695	.edf6					osbyte7071:
9696	.edf6	a8		tay		                tay
9697	.edf7	8a		txa		                txa
9698						                .cerror vduDriverMemory+1!=displayMemory
9699	.edf8	99 1a 02	sta $021a,y	                sta vduDriverMemory-$70,y
9700	.edfb	d0 09		bne $ee06	                bne LED80
9701	.edfd	a5 d0		lda $d0		                lda STATE
9702	.edff	29 10		and #$10	                and #STATE.isShadowMode
9703	.ee01	f0 06		beq $ee09	                beq LED83
9704	.ee03					LED7D:
9705	.ee03	a9 01		lda #$01	                lda #$01
9706	.ee05	60		rts		                rts

9708	.ee06					LED80:
9709	.ee06	3a		dec a		                dec a
9710	.ee07	d0 fa		bne $ee03	                bne LED7D
9711	.ee09					LED83:
9712	.ee09	60		rts		                rts

9714						;-------------------------------------------------------------------------

9716						; OSBYTE &6E (110), &6F (111)
9717						; ===========================
9718						; Pass to sideways ROMs
9719	.ee0a					osbyteUnused:                   ;ed84
9720	.ee0a	a2 07		ldx #$07	                ldx #romServiceCallUnrecognisedOSBYTE
9721	.ee0c	20 f8 ee	jsr $eef8	                jsr makeROMServiceCall
9722	.ee0f	a6 f0		ldx $f0		                ldx originalX
9723						                .if version!=400
9724	.ee11	49 00		eor #$00	                eor #$00
9725						                .endif
9726	.ee13	60		rts		                rts

9728						;-------------------------------------------------------------------------

9730						                .if version!=350
9731	.ee14					osbyteA1:
9732	.ee14	20 50 f4	jsr $f450	                jsr withTerminalROM
9733	.ee17	4c aa 9d	jmp $9daa	                jmp terminal.readCMOSByte
9734						                .endif

9736						;-------------------------------------------------------------------------

9738						                .if version!=350
9739	.ee1a					osbyteA2:
9740	.ee1a	20 50 f4	jsr $f450	                jsr withTerminalROM
9741	.ee1d	4c f8 9d	jmp $9df8	                jmp terminal.writeCMOSByte
9742						                .endif

9744						;-------------------------------------------------------------------------
9745						;
9746						; OSBYTE 140 (&8C) Select Cassette Filing System [MasRef D.2-43]
9747						; OSBYTE 141 (&8D) Select ROM Filing System [MasRef D.2-43]
9748						;
9749	.ee20					osbyte8C8D:
9750	.ee20	20 46 ee	jsr $ee46	                jsr selectROMOrTAPEByOSBYTE
9751	.ee23	ad 34 fe	lda $fe34	                lda ACCCON                    ; Save ACCON register
9752	.ee26	48		pha		                pha
9753	.ee27	20 40 ee	jsr $ee40	                jsr selectHAZEL         ; Page Hazel workspace in
9754	.ee2a	ae 01 df	ldx $df01	                ldx hazel.activeFS
9755	.ee2d	8e 00 df	stx $df00	                stx hazel.currentFS
9756	.ee30	a9 0f		lda #$0f	                lda #terminalROM
9757	.ee32	8d 03 df	sta $df03	                sta hazel.currentFSROM
9758	.ee35	68		pla		                pla                          ; Restore ACCON
9759	.ee36					selectMOSOrHAZEL:                                       ;edb0
9760	.ee36	29 08		and #$08	                and #ACCCON.Y   ;get just the HAZEL/MOS bit
9761	.ee38	d0 08		bne $ee42	                bne tsbACCCON   ;branch taken if HAZEL at $c000
9762	.ee3a					selectMOS:
9763	.ee3a	a9 08		lda #$08	                lda #ACCCON.Y
9764	.ee3c	1c 34 fe	trb $fe34	                trb ACCCON      ;page in MOS at $c000
9765	.ee3f	60		rts		                rts

9767	.ee40					selectHAZEL:
9768	.ee40	a9 08		lda #$08	                lda #ACCCON.Y
9769	.ee42					tsbACCCON:
9770	.ee42	0c 34 fe	tsb $fe34	                tsb ACCCON      ;page in HAZEL at $c000
9771	.ee45	60		rts		                rts

9773						;-------------------------------------------------------------------------

9775						                .if version==400
9779						                .endif

9781						;-------------------------------------------------------------------------
9782						;
9783						; Select ROM or TAPE.
9784						;
9785						; Two entry points: selectROMOrTAPEByOSBYTE picks FS by OSBYTE number
9786						; ($8c=TAPE, $8d=ROM), and selectROMOrTAPE picks FS by number (0=TAPE,
9787						; 1=ROM).
9788						;
9789						; entry:
9790						;
9791						; A = FS to select
9792						;
9793	.ee46					selectROMOrTAPEByOSBYTE:
9794						                .if version==400
9805						                .else

9807	.ee46	49 8c		eor #$8c	                eor #$8C                     ;A=0 if tape, A=1 if ROM
9808	.ee48					selectROMOrTAPE:
9809	.ee48	0a		asl a		                asl a           ; Set CFS/RFS switch to 0=CFS or 2=RFS
9810	.ee49	8d 47 02	sta $0247	                sta cfsRFSFSSwitch
9811	.ee4c	d0 04		bne $ee52	                bne LEDCC                    ;taken if ROM
9812	.ee4e	a9 04		lda #$04	                lda #$04                     ; CFS, clear b2 of status
9813	.ee50	14 e2		trb $e2		                trb $E2
9814	.ee52					LEDCC:
9815	.ee52	e0 03		cpx #$03	                cpx #$03                     ; EQ=TAPE 300, NE=TAPE 1200
9816	.ee54	80 06		bra $ee5c	                bra LEDD6

9818	.ee56					LEDD0:
9819						                .if version==350
9821						                .endif
9822	.ee56	20 ea ee	jsr $eeea	                jsr LEE64
9823	.ee59	20 9c f2	jsr $f29c	                jsr LF1EE
9824	.ee5c					LEDD6:
9825	.ee5c	08		php		                php                          ; Save baud flag in Carry
9826	.ee5d	a9 06		lda #$06	                lda #$06                     ; Vectors about to change
9827	.ee5f	20 93 f2	jsr $f293	                jsr callFSCV
9828	.ee62	ad 47 02	lda $0247	                lda cfsRFSFSSwitch           ; Jump if RFS selected
9829	.ee65	d0 0d		bne $ee74	                bne LEDEE
9830	.ee67	a2 06		ldx #$06	                ldx #$06                     ; Prepare baud=6 for TAPE300
9831	.ee69	28		plp		                plp                          ; Skip past if TAPE300
9832	.ee6a	f0 05		beq $ee71	                beq LEDEB
9833	.ee6c	a9 04		lda #$04	                lda #$04                     ; TAPE1200, set bit 2 of status
9834	.ee6e	04 e2		tsb $e2		                tsb $E2
9835	.ee70	ca		dex		                dex                          ; Change to baud=5 for TAPE1200
9836	.ee71					LEDEB:
9837	.ee71	86 c6		stx $c6		                stx $C6                      ; Store baud rate setting
9838	.ee73	08		php		                php
9839	.ee74					LEDEE:
9840	.ee74	64 ce		stz $ce		                stz $CE                      ; Clear byte (unused on BBC)
9841	.ee76	28		plp		                plp
9842						                .endif

9844	.ee77	a2 0e		ldx #$0e	                ldx #defaultVectorTable.fsVectors.end-defaultVectorTable.fsVectors ; Prepare to set 7 vectors
9845	.ee79					LEDF3:
9846	.ee79	bd 0a e3	lda $e30a,x	                lda defaultVectorTable.fsVectors-1,x ; Set filing
9847						                                                     ; system vectors
9848						                                                     ; to point to
9849						                                                     ; extended
9850						                                                     ; vectors
9851	.ee7c	9d 11 02	sta $0211,x	                sta FILEV-1,x
9852	.ee7f	ca		dex		                dex
9853	.ee80	d0 f7		bne $ee79	                bne LEDF3
9854	.ee82	20 9c f2	jsr $f29c	                jsr LF1EE                    ; Set extended vectors
9855	.ee85	64 c2		stz $c2		                stz $C2                      ; Set Progress=idle
9856	.ee87	a2 0f		ldx #$0f	                ldx #romServiceCallVectorsClaimed ; Send service call &0F - vectors changed

9858						;-------------------------------------------------------------------------
9859						;
9860						; OSBYTE 143 (&8F) Issue paged ROM service request [MasRef D.2-44]
9861						;
9862	.ee89					osbyte8F: .proc                    ;ee03
9863	.ee89	5a		phy		                phy
9864	.ee8a	da		phx		                phx                          ; Send service call
9865	.ee8b	20 f8 ee	jsr $eef8	                jsr makeROMServiceCall
9866	.ee8e	fa		plx		                plx
9867	.ee8f	e0 0f		cpx #$0f	                cpx #romServiceCallVectorsClaimed ; If VectorsClaimed,
9868						                                                  ; hook FileSwitch
9869						                                                  ; back in
9870	.ee91	f0 36		beq $eec9	                beq handleVectorsClaimed
9871	.ee93	1a		inc a		                inc a       ; If claimed, check for
9872						                            ; InitialiseFilingSystem or
9873						                            ; UnrecognisedCommand
9874	.ee94	3a		dec a		                dec a       ;Z=1 if claimed
9875	.ee95	f0 03		beq $ee9a	                beq wasClaimed  ;branch taken if claimed
9876	.ee97					done:
9877	.ee97	fa		plx		                plx             ; Return with result in X, EQ=Claimed
9878	.ee98	aa		tax		                tax
9879	.ee99	60		rts		                rts

9881	.ee9a					wasClaimed:
9882	.ee9a	e0 12		cpx #$12	                cpx #romServiceCallInitialiseFilingSystem
9883	.ee9c	f0 04		beq $eea2	                beq +
9884	.ee9e	e0 04		cpx #$04	                cpx #romServiceCallUnrecognisedCommand
9885	.eea0	d0 f5		bne $ee97	                bne done
9886	.eea2					+

9888						; handle InitialiseFilingSystem ($12) or UnrecognisedCommand ($04)

9890	.eea2	7a		ply		                ply                     ;Y=service call arg
9891	.eea3	48		pha		                pha                     ;save A (though actually it's
9892						                                        ;always $00...)
9893	.eea4	ad 34 fe	lda $fe34	                lda ACCCON
9894	.eea7	48		pha		                pha                     ;save ACCCON
9895	.eea8	20 40 ee	jsr $ee40	                jsr selectHAZEL
9896	.eeab	38		sec		                sec
9897	.eeac	6e 00 df	ror $df00	                ror hazel.currentFS ;set currentFS bit 7
9898	.eeaf					LEE29:
9899	.eeaf	5a		phy		                phy             ;save ROM service call argument
9900	.eeb0	a9 00		lda #$00	                lda #$00
9901	.eeb2	a8		tay		                tay
9902	.eeb3	20 68 f9	jsr $f968	                jsr callARGSV   ;A=0, Y=0 - get active FS number
9903	.eeb6	8d 01 df	sta $df01	                sta hazel.activeFS ;save active FS number
9904	.eeb9	2c 00 df	bit $df00	                bit hazel.currentFS
9905	.eebc	10 03		bpl $eec1	                bpl LEE3B
9906	.eebe	20 bd f2	jsr $f2bd	                jsr osbyte6D
9907	.eec1					LEE3B:
9908	.eec1	7a		ply		                ply
9909	.eec2	68		pla		                pla
9910	.eec3	20 36 ee	jsr $ee36	                jsr selectMOSOrHAZEL
9911	.eec6	68		pla		                pla
9912	.eec7	aa		tax		                tax
9913	.eec8	60		rts		                rts

9915	.eec9					handleVectorsClaimed:
9916	.eec9	7a		ply		                ply
9917	.eeca	48		pha		                pha
9918	.eecb	ad 34 fe	lda $fe34	                lda ACCCON
9919	.eece	48		pha		                pha
9920	.eecf	20 40 ee	jsr $ee40	                jsr selectHAZEL
9921	.eed2	ad 1e 02	lda $021e	                lda FSCV+0
9922	.eed5	8d da df	sta $dfda	                sta hazel.activeFSCV+0
9923	.eed8	ad 1f 02	lda $021f	                lda FSCV+1
9924	.eedb	8d db df	sta $dfdb	                sta hazel.activeFSCV+1
9925	.eede	a9 b9		lda #$b9	                lda #<fileswitchFSCEntryPoint
9926	.eee0	8d 1e 02	sta $021e	                sta FSCV+0
9927	.eee3	a9 fa		lda #$fa	                lda #>fileswitchFSCEntryPoint
9928	.eee5	8d 1f 02	sta $021f	                sta FSCV+1
9929	.eee8	80 c5		bra $eeaf	                bra LEE29
9930						                .pend

9932						;-------------------------------------------------------------------------

9934	.eeea					LEE64:
9935	.eeea	a9 a1		lda #$a1	                lda #$A1
9936	.eeec	85 e3		sta $e3		                sta $E3
9937	.eeee	a9 19		lda #$19	                lda #$19
9938	.eef0	8d d1 03	sta $03d1	                sta $03D1
9939	.eef3	a9 04		lda #$04	                lda #$04
9940	.eef5	04 e2		tsb $e2		                tsb $E2
9941	.eef7	60		rts		                rts

9943						;-------------------------------------------------------------------------
9944						;
9945						; Pass service call around sideways ROMs
9946						;
9947						; Entry:
9948						; X=service call number
9949						; Y=any parameters
9950						;
9951						; Exit:
9952						; X=0 or preserved
9953						; Y=any returned parameters
9954						; EQ=call claimed if called directly
9955						;
9956	.eef8					makeROMServiceCall: .proc                    ;ee72
9957	.eef8	a5 f4		lda $f4		                lda $F4         ; Save current ROM
9958	.eefa	48		pha		                pha
9959	.eefb	ad 34 fe	lda $fe34	                lda ACCCON      ; Save current paging state
9960	.eefe	48		pha		                pha
9961	.eeff	20 40 ee	jsr $ee40	                jsr selectHAZEL ; Page in Hazel
9962	.ef02	8a		txa		                txa             ; Pass service call number to A
9963	.ef03	a2 0f		ldx #$0f	                ldx #$0F     ; Start at ROM 15, and always call ROM 15
9964	.ef05	80 05		bra $ef0c	                bra callServiceEntry
9965	.ef07					callServiceEntriesLoop:
9966	.ef07	3c a1 02	bit $02a1,x	                bit romInformationTable,x ;check if ROM X has a service entry
9967	.ef0a	10 0b		bpl $ef17	                bpl nextROM       ;branch taken if no service entry
9968	.ef0c					callServiceEntry:
9969	.ef0c	20 9a e5	jsr $e59a	                jsr selectROMX  ; Page in ROM X
9970	.ef0f	20 03 80	jsr $8003	                jsr $8003       ; Call ROM service entry point
9971	.ef12	aa		tax		                tax             ; X = service call result
9972	.ef13	f0 05		beq $ef1a	                beq done       ;branch taken if service call claimed
9973	.ef15	a6 f4		ldx $f4		                ldx $F4         ; Get ROM number
9974	.ef17					nextROM:
9975	.ef17	ca		dex		                dex       ; Step down to next ROM, loop until all done
9976	.ef18	10 ed		bpl $ef07	                bpl callServiceEntriesLoop

9978	.ef1a					done:
9979	.ef1a	68		pla		                pla                          ; Restore paging state
9980	.ef1b	20 36 ee	jsr $ee36	                jsr selectMOSOrHAZEL
9981	.ef1e	68		pla		                pla                          ; Restore current ROM
9982	.ef1f	20 ab e5	jsr $e5ab	                jsr selectROMA
9983	.ef22	8a		txa		                txa                          ; Pass claim/noclaim to A
9984	.ef23	60		rts		                rts
9985						                .pend

9987						;-------------------------------------------------------------------------

9989						; OSBYTE &6B (107) - Select memory for direct access
9990						; ==============================================
9991	.ef24					osbyte6B:                       ;ee9e
9992	.ef24	a0 20		ldy #$20	                ldy #$20                     ; Y=&20 to change 1MHz bit
9993	.ef26	80 02		bra $ef2a	                bra LEEA4

9995						;-------------------------------------------------------------------------

9997						; OSBYTE &6C (108) - Select memory for direct access
9998						; ==============================================
9999	.ef28					osbyte6C:
10000	.ef28	a0 04		ldy #$04	                ldy #ACCCON.X                ; Y=&04 to change RAM bit
10001	.ef2a					LEEA4:
10002	.ef2a	98		tya		                tya                          ; Clear RAM or 1MHz bit
10003	.ef2b	1c 34 fe	trb $fe34	                trb ACCCON
10004	.ef2e	8a		txa		                txa                          ; If X=0, exit with normal RAM/1MHz selected
10005	.ef2f	f0 05		beq $ef36	                beq LEEB0
10006						                .if version==350
10008						                .else
10009	.ef31	a9 04		lda #$04	                lda #ACCCON.X                ; BUG! This should be TYA
10010						                .endif
10011	.ef33	0c 34 fe	tsb $fe34	                tsb ACCCON                   ; Page in shadow RAM
10012	.ef36					LEEB0:
10013	.ef36	60		rts		                rts                          ; X preserved, Y=&04 or &20

10015						;-------------------------------------------------------------------------

10017						osword06Macro: .macro
10024						                .endmacro

10026						LEF1BMacro: .macro
10038						                .endmacro

10040						;-------------------------------------------------------------------------

10042						                .if version>=350
10043	.ef37					osword06:
10018	.ef37	20 0b f0	jsr $f00b	                jsr getAddressFromOSWORDParameterBlock
10019	.ef3a	b1 f0		lda ($f0),y	                lda (originalX),y
10020	.ef3c	92 fa		sta ($fa)	                sta (SEIWKA)
10021	.ef3e					ret:
10022	.ef3e	a9 00		lda #$00	                lda #$00
10023	.ef40	60		rts		                rts
10044	.ef41					LEF1B:
10027	.ef41	a5 eb		lda $eb		                lda $EB
10028	.ef43	30 f9		bmi $ef3e	                bmi osword06.ret
10029	.ef45	ad 57 02	lda $0257	                lda spoolFileHandle
10030	.ef48	d0 f4		bne $ef3e	                bne osword06.ret
10031	.ef4a	a9 08		lda #$08	                lda #$08
10032	.ef4c	25 e2		and $e2		                and $E2
10033	.ef4e	d0 04		bne $ef54	                bne LEF2E
10034	.ef50	a9 88		lda #$88	                lda #$88
10035	.ef52	25 bb		and $bb		                and $BB
10036	.ef54					LEF2E:
10037	.ef54	60		rts		                rts
10045						                .endif

10047						;-------------------------------------------------------------------------

10049						                .if version>=500
10050	.ef55					oswordEntryPoint:
10051	.ef55	48		pha		                pha
10052	.ef56	08		php		                php
10053	.ef57	78		sei		                sei
10054	.ef58	85 ef		sta $ef		                sta originalA
10055	.ef5a	86 f0		stx $f0		                stx originalX
10056	.ef5c	84 f1		sty $f1		                sty originalY
10057	.ef5e	a2 08		ldx #$08	                ldx #romServiceCallUnrecognisedOSWORD
10058	.ef60	c9 e0		cmp #$e0	                cmp #$e0
10059	.ef62	b0 3f		bcs $efa3	                bcs osbyteOrUSERV
10060	.ef64	c9 10		cmp #$10	                cmp #$10
10061	.ef66	90 0e		bcc $ef76	                bcc LEF76
10062	.ef68	c9 44		cmp #$44	                cmp #$44
10063	.ef6a	b0 05		bcs $ef71	                bcs LEF71
10064	.ef6c	c9 42		cmp #$42	                cmp #$42
10065	.ef6e	b0 04		bcs $ef74	                bcs LEF74
10066	.ef70	38		sec		                sec

10068	.ef71					LEF71:
10069	.ef71	4c fa ef	jmp $effa	                jmp handleUnrecognisedOSBYTEOrOSWORD

10071	.ef74					LEF74:
10072						                .if version<500
10074						                .elsif version>=500
10075	.ef74	e9 33		sbc #$33	                sbc #$33
10076						                .endif

10078	.ef76					LEF76:
10079	.ef76	69 59		adc #$59	                adc #$59                     ; :(
10080	.ef78	0a		asl a		                asl a
10081	.ef79	80 32		bra $efad	                bra callOSBYTEOrOSWORDFromTable
10082						                .endif

10084						;-------------------------------------------------------------------------

10086						                .if version>=350
10087	.ef7b					osword0E:
10088	.ef7b	c9 03		cmp #$03	                cmp #3
10089	.ef7d	b0 77		bcs $eff6	                bcs handleUnrecognisedOSWORD
10090	.ef7f	20 50 f4	jsr $f450	                jsr withTerminalROM
10091	.ef82	4c 78 98	jmp $9878	                jmp terminal.osword0E
10092						                .endif

10094						;-------------------------------------------------------------------------

10096						                .if version>=500||version==350
10097	.ef85					LEF85:
10098	.ef85	28		plp		                plp
10099	.ef86	68		pla		                pla
10100	.ef87	2c 70 e3	bit $e370	                bit valueFF
10101	.ef8a	60		rts		                rts
10102						                .endif

10104						;-------------------------------------------------------------------------


10107						; OSBYTE
10108						; ======
10109	.ef8b					osbyteEntryPoint:
10110	.ef8b	48		pha		                pha
10111	.ef8c	08		php		                php
10112	.ef8d	78		sei		                sei
10113	.ef8e	85 ef		sta $ef		                sta originalA
10114	.ef90	86 f0		stx $f0		                stx originalX
10115	.ef92	84 f1		sty $f1		                sty originalY
10116	.ef94	a2 07		ldx #$07	                ldx #romServiceCallUnrecognisedOSBYTE
10117	.ef96	c9 6b		cmp #$6b	                cmp #$6B
10118	.ef98	90 4c		bcc $efe6	                bcc osbyte00To6A
10119	.ef9a	c9 a6		cmp #$a6	                cmp #$A6
10120	.ef9c	90 09		bcc $efa7	                bcc osbyte6BToA5
10121	.ef9e	c9 a6		cmp #$a6	                cmp #$A6
10122	.efa0	90 58		bcc $effa	                bcc handleUnrecognisedOSBYTEOrOSWORD       ;??? - wait... didn't we just do this?

10124	.efa2					osbyteA6ToFF:
10125	.efa2	18		clc		                clc
10126	.efa3					osbyteOrUSERV:      ;call OSBYTE A6+ routine if C=0; call USERV if C=1
10127	.efa3	a9 a6		lda #$a6	                lda #$A6
10128	.efa5	69 00		adc #$00	                adc #$00
10129						                .if version<350
10132						                .elsif version>=350
10133	.efa7					osbyte6BToA5:
10134	.efa7	e9 24		sbc #$24	                sbc #$24
10135	.efa9					LEFA9:
10136	.efa9	e9 2a		sbc #$2a	                sbc #$2A
10137						                .endif
10138	.efab					osbyteUseTable:
10139	.efab	0a		asl a		                asl a           ;table is of words
10140	.efac	38		sec		                sec
10141	.efad					callOSBYTEOrOSWORDFromTable:
10142	.efad	84 f1		sty $f1		                sty originalY
10143	.efaf	a8		tay		                tay             ;get table offset in Y
10144	.efb0	2c 5e 02	bit $025e	                bit econetInterceptionStatus
10145	.efb3	10 07		bpl $efbc	                bpl LEEE0             ;taken if no Econet interception
10146	.efb5	8a		txa		                txa
10147						                .cerror (netOSBYTEAttempted!=romServiceCallUnrecognisedOSBYTE),"net/rom reason codes mismatch"
10148						                .cerror (netOSWORDAttempted!=romServiceCallUnrecognisedOSWORD),"net/rom reason codes mismatch"
10149	.efb6	b8		clv		                clv
10150	.efb7	20 5e ec	jsr $ec5e	                jsr callNETV
10151	.efba	70 24		bvs $efe0	                bvs LEEFA
10152	.efbc					LEEE0:
10153						                .if version>=500
10154	.efbc	a5 f4		lda $f4		                lda $f4
10155	.efbe	48		pha		                pha
10156	.efbf	20 a9 e5	jsr $e5a9	                jsr selectTerminalROM
10160						                .endif
10161						                .if version==350
10166						                .else
10167	.efc2	b9 a9 8f	lda $8fa9,y	                lda osbyteAndOSWORDRoutineTable+1,y
10168	.efc5	85 fb		sta $fb		                sta SEIWKB
10169	.efc7	b9 a8 8f	lda $8fa8,y	                lda osbyteAndOSWORDRoutineTable,y
10170	.efca	85 fa		sta $fa		                sta SEIWKA
10171						                .endif
10172						                .if version>=500
10173	.efcc	fa		plx		                plx
10174	.efcd	20 9a e5	jsr $e59a	                jsr selectROMX
10179						                .endif
10180	.efd0	a5 ef		lda $ef		                lda originalA
10181	.efd2	a4 f1		ldy $f1		                ldy originalY
10182	.efd4	b0 04		bcs $efda	                bcs +
10183	.efd6	a0 00		ldy #$00	                ldy #$00            ;??? - is this actually desirable?
10184	.efd8	b2 f0		lda ($f0)	                lda ($F0)           ;fetch 0th byte of parameter block
10185	.efda					+
10186	.efda	38		sec		                sec
10187						                .if version==350
10189						                .else
10190	.efdb	a6 f0		ldx $f0		                ldx originalX

10192						; on entry to the OSBYTE handlers, C=1, N/Z set as per X.

10194	.efdd	20 58 f7	jsr $f758	                jsr callSEIWKA
10195						                .endif
10196	.efe0					LEEFA:
10197	.efe0	6a		ror a		                ror a
10198	.efe1	28		plp		                plp
10199	.efe2	2a		rol a		                rol a
10200	.efe3	68		pla		                pla
10201	.efe4	b8		clv		                clv
10202	.efe5	60		rts		                rts

10204	.efe6					osbyte00To6A:
10205	.efe6	a0 00		ldy #$00	                ldy #$00        ;Y=0 on entry for this lot
10206	.efe8	c9 1a		cmp #$1a	                cmp #$1A        ;OSBYTE <=$19 is table-driven
10207	.efea	90 bf		bcc $efab	                bcc osbyteUseTable ;taken if OSBYTE $00-$19
10208						                .if version>=350
10209	.efec	c9 44		cmp #$44	                cmp #$44
10210	.efee	f0 b9		beq $efa9	                beq LEFA9
10211	.eff0	c9 45		cmp #$45	                cmp #$45
10212	.eff2	f0 b5		beq $efa9	                beq LEFA9
10213						                .endif
10214	.eff4	80 04		bra $effa	                bra handleUnrecognisedOSBYTEOrOSWORD

10216	.eff6					handleUnrecognisedOSWORD:
10217	.eff6	a2 08		ldx #$08	                ldx #romServiceCallUnrecognisedOSWORD
10218	.eff8	68		pla		                pla
10219	.eff9	68		pla		                pla
10220	.effa					handleUnrecognisedOSBYTEOrOSWORD:
10221	.effa	20 f8 ee	jsr $eef8	                jsr makeROMServiceCall
10222						                .if version<500&&version!=350
10224						                .else
10225	.effd	d0 86		bne $ef85	                bne LEF85
10226						                .endif
10227	.efff	a6 f0		ldx $f0		                ldx originalX
10228	.f001	80 dd		bra $efe0	                bra LEEFA
10229						                .if version<500&&version!=350
10235						                .endif

10237						;-------------------------------------------------------------------------

10239						                .if version<350
10241						                .endif

10243						;-------------------------------------------------------------------------
10244						;
10245						; OSWORD 14 (&0E) Read CMOS clock [MasRef D.3-22]
10246						;
10247						                .if version<350
10253						                .endif

10255						;-------------------------------------------------------------------------
10256						;
10257						; Entry point for OSWORD.
10258						;
10259						; D.3-3
10260						;
10261						                .if version<500
10303						                .endif

10305						;-------------------------------------------------------------------------
10306						;
10307						; OSWORD 5 (&05) Read byte from I/O processor memory [MasRef D.3-9]
10308						;
10309	.f003					osword05:
10310	.f003	20 0b f0	jsr $f00b	                jsr getAddressFromOSWORDParameterBlock
10311	.f006	b2 fa		lda ($fa)	                lda (SEIWKA)                 ;read byte from the address
10312	.f008	91 f0		sta ($f0),y	                sta (originalX),y                  ;update parameter block
10313	.f00a	60		rts		                rts

10315						;-------------------------------------------------------------------------
10316						;
10317						; OSWORD 6 (&06) Write byte to I/O processor memory [MasRef D.3-9]
10318						;

10320						                .if version<350
10322						                .endif

10324						;-------------------------------------------------------------------------
10325						;
10326						; Get address from OSWORD parameter block.
10327						;
10328						; entry:
10329						;
10330						; A = 0th byte of parameter block
10331						;
10332						; Y = 0
10333						;
10334						; (originalX) = parameter block
10335						;
10336						; exit:
10337						;
10338						; (SEIWKA) = address, first two bytes from parameter block
10339						;
10340						; Y = 4 (this is just convenient for both callers)
10341						;
10342	.f00b					getAddressFromOSWORDParameterBlock:
10343	.f00b	85 fa		sta $fa		                sta SEIWKA
10344	.f00d	c8		iny		                iny
10345	.f00e	b1 f0		lda ($f0),y	                lda (originalX),y
10346	.f010	85 fb		sta $fb		                sta SEIWKA+1
10347	.f012	a0 04		ldy #$04	                ldy #$04
10348	.f014					ldxim03_rts:
10349						                .if version<400
10353						                .else
10354	.f014	a2 05		ldx #$05	                ldx #$05
10355						                .endif
10356	.f016	60		rts		                rts

10358						;-------------------------------------------------------------------------
10359						;
10360						; OSBYTE 0 (&00) Display MOS version
10361						;
10362						; OSBYTE 0 has the effect of performing a BRK instruction and
10363						; displaying the MOS version number.
10364						;
10365						; Entry parameters :
10366						;
10367						; X=0 executes a BRK and displays the OS version
10368						;
10369						; X=1 executes an RTS and returns the Operating system version
10370						;
10371						; On exit : X=<OS version>
10372						;
10373						; D.2-18
10374						;
10375	.f017					osbyte00:                       ;ef6f
10376	.f017	d0 fb		bne $f014	                bne ldxim03_rts ;branch taken if X<>0 - return with
10377						                                 ;X=3

10379						; do a BRK and print MOS version number.

10381	.f019	00		brk #		                brk
10382	>f01a	f7				                .byte $f7
10383						                .if version==320
10387						                .elsif version==500
10388	>f01b	4d 4f 53 20 35 2e 30 30		                .text "MOS 5.00"
10409						                .endif
10410	>f023	00				                .byte 0

10412						;-------------------------------------------------------------------------
10413						;
10414						; OSWORD 7 (&07) Generate a sound [MasRef D.3-10]
10415						;
10416	.f024					osword07:
10417	.f024	c8		iny		                iny
10418	.f025	b1 f0		lda ($f0),y	                lda ($F0),y
10419	.f027	c9 20		cmp #$20	                cmp #$20
10420	.f029	b0 cb		bcs $eff6	                bcs handleUnrecognisedOSWORD
10421	.f02b	88		dey		                dey
10422	.f02c	20 9f f0	jsr $f09f	                jsr LEFF6
10423	.f02f	09 04		ora #$04	                ora #$04
10424	.f031	aa		tax		                tax
10425	.f032	90 05		bcc $f039	                bcc LEF90
10426	.f034	20 85 ea	jsr $ea85	                jsr LE95A
10427	.f037	a0 01		ldy #$01	                ldy #$01
10428	.f039					LEF90:
10429	.f039	20 9f f0	jsr $f09f	                jsr LEFF6
10430	.f03c	85 fa		sta $fa		                sta $FA
10431	.f03e	08		php		                php
10432	.f03f	a0 06		ldy #$06	                ldy #$06
10433	.f041	b1 f0		lda ($f0),y	                lda ($F0),y
10434	.f043	48		pha		                pha
10435	.f044	a0 04		ldy #$04	                ldy #$04
10436	.f046	b1 f0		lda ($f0),y	                lda ($F0),y
10437	.f048	48		pha		                pha
10438	.f049	a0 02		ldy #$02	                ldy #$02
10439	.f04b	b1 f0		lda ($f0),y	                lda ($F0),y
10440	.f04d	2a		rol a		                rol a
10441	.f04e	3a		dec a		                dec a
10442	.f04f	3a		dec a		                dec a
10443	.f050	0a		asl a		                asl a
10444	.f051	0a		asl a		                asl a
10445	.f052	05 fa		ora $fa		                ora $FA
10446	.f054	20 ce ea	jsr $eace	                jsr LE9A3
10447	.f057	90 1e		bcc $f077	                bcc LEFCE
10448	.f059	68		pla		                pla
10449	.f05a	68		pla		                pla
10450	.f05b	28		plp		                plp

10452						                ; WTF... fall through to OSBYTE $75!

10454						;-------------------------------------------------------------------------
10455						;
10456						; OSBYTE 117 (&75) Read VDU status [MasRef D.2-32]
10457						;
10458	.f05c					osbyte75:
10459	.f05c	a6 d0		ldx $d0		                ldx STATE
10460	.f05e	60		rts		                rts

10462						;-------------------------------------------------------------------------
10463						;
10464						; VDU 7 (&07) Produce BELL sound [MasRef E.3-4]
10465						;
10466	.f05f					vdu7EntryPoint:
10467	.f05f	08		php		                php
10468	.f060	78		sei		                sei
10469	.f061	ad 63 02	lda $0263	                lda bellChannel
10470	.f064	29 07		and #$07	                and #$07
10471	.f066	09 04		ora #$04	                ora #$04
10472	.f068	aa		tax		                tax
10473	.f069	ad 64 02	lda $0264	                lda bellSound
10474	.f06c	20 6b eb	jsr $eb6b	                jsr callINSV
10475	.f06f	ad 66 02	lda $0266	                lda bellDuration
10476	.f072	48		pha		                pha
10477	.f073	ad 65 02	lda $0265	                lda bellFrequency
10478	.f076	48		pha		                pha
10479	.f077					LEFCE:
10480	.f077	38		sec		                sec
10481	.f078	7e 00 08	ror $0800,x	                ror $0800,x
10482	.f07b	68		pla		                pla
10483	.f07c	20 6b eb	jsr $eb6b	                jsr callINSV
10484	.f07f	68		pla		                pla
10485	.f080	20 6b eb	jsr $eb6b	                jsr callINSV
10486	.f083	28		plp		                plp
10487	.f084	60		rts		                rts

10489						;-------------------------------------------------------------------------
10490						;
10491						; OSWORD 8 (&08) Define a sound envelope [MasRef D.3-14]
10492						;
10493	.f085					osword08:
10494	.f085	3a		dec a		                dec a                   ;get index of 1-based envelope
10495	.f086	0a		asl a		                asl a
10496	.f087	0a		asl a		                asl a
10497	.f088	0a		asl a		                asl a
10498	.f089	0a		asl a		                asl a                        ;index*16
10499	.f08a	09 0f		ora #$0f	                ora #$0F                     ;index*16+15
10500	.f08c	aa		tax		                tax                          ;
10501	.f08d	a9 00		lda #$00	                lda #$00                     ;
10502	.f08f	a0 10		ldy #$10	                ldy #16             ;16 bytes of envelope data get set
10503	.f091					-
10504	.f091	c0 0e		cpy #$0e	                cpy #$0E                     ;
10505	.f093	b0 02		bcs $f097	                bcs + ;taken if last 2 bytes of data - they get initialized to $00
10506	.f095	b1 f0		lda ($f0),y	                lda (originalX),y        ;fetch byte from OSWORD block
10507	.f097					+
10508	.f097	9d c0 08	sta $08c0,x	                sta envelope1Data,x          ;set envelope data bytes
10509	.f09a	ca		dex		                dex
10510	.f09b	88		dey		                dey
10511	.f09c	d0 f3		bne $f091	                bne -
10512	.f09e	60		rts		                rts

10514						;-------------------------------------------------------------------------

10516	.f09f					LEFF6:
10517	.f09f	b1 f0		lda ($f0),y	                lda ($F0),y
10518	.f0a1	c9 10		cmp #$10	                cmp #$10
10519	.f0a3	29 03		and #$03	                and #$03
10520	.f0a5	c8		iny		                iny
10521	.f0a6	60		rts		                rts

10523						;-------------------------------------------------------------------------
10524						;
10525						; OSWORD 3 (&03) Read interval timer [MasRef D.3-8]
10526						;
10527	.f0a7					osword03:
10528	.f0a7	a2 0f		ldx #$0f	                ldx #$0F
10529	.f0a9	80 03		bra $f0ae	                bra LF005

10531						;-------------------------------------------------------------------------
10532						;
10533						; OSWORD 1 (&01) Read system clock [MasRef D.3-7]
10534						;
10535	.f0ab					osword01:
10536	.f0ab	ae 83 02	ldx $0283	                ldx timerSwitchState
10537	.f0ae					LF005:
10538	.f0ae	a0 04		ldy #$04	                ldy #$04
10539	.f0b0					-
10540	.f0b0	bd 8d 02	lda $028d,x	                lda timer0-initialTimerSwitchState,x
10541	.f0b3	91 f0		sta ($f0),y	                sta (originalX),y
10542	.f0b5	e8		inx		                inx
10543	.f0b6	88		dey		                dey
10544	.f0b7	10 f7		bpl $f0b0	                bpl -
10545	.f0b9					rtsF010:
10546	.f0b9	60		rts		                rts

10548						;-------------------------------------------------------------------------
10549						;
10550						; OSWORD 4 (&04) Write interval timer [MasRef D.3-9]
10551						;
10552	.f0ba					osword04:
10553	.f0ba	a9 0f		lda #$0f	                lda #intervalTimer-(timer0-initialTimerSwitchState)
10554	.f0bc	80 06		bra $f0c4	                bra copyTIMEValue

10556						;-------------------------------------------------------------------------
10557						;
10558						; OSWORD 2 (&02) Write system clock [MasRef D.3-8]
10559						;
10560	.f0be					osword02:
10561	.f0be	ad 83 02	lda $0283	                lda timerSwitchState
10562	.f0c1	49 0f		eor #$0f	                eor #$0F       ;select the timer that isn't being used
10563	.f0c3	18		clc		                clc
10564	.f0c4					copyTIMEValue:
10565	.f0c4	48		pha		                pha
10566	.f0c5	aa		tax		                tax
10567	.f0c6	a0 04		ldy #$04	                ldy #$04
10568	.f0c8					-
10569	.f0c8	b1 f0		lda ($f0),y	                lda (originalX),y
10570	.f0ca	9d 8d 02	sta $028d,x	                sta timer0-initialTimerSwitchState,x
10571	.f0cd	e8		inx		                inx
10572	.f0ce	88		dey		                dey
10573	.f0cf	10 f7		bpl $f0c8	                bpl -
10574	.f0d1	68		pla		                pla
10575	.f0d2	b0 e5		bcs $f0b9	                bcs rtsF010
10576	.f0d4	8d 83 02	sta $0283	                sta timerSwitchState
10577	.f0d7	60		rts		                rts

10579						;-------------------------------------------------------------------------
10580						;
10581						; OSWORD 0 (&00) Read line from input stream to memory [MasRef D.3-6]
10582						;
10583	.f0d8					osword00:
10584	.f0d8	a0 04		ldy #$04	                ldy #$04
10585	.f0da					LF031:
10586	.f0da	b1 f0		lda ($f0),y	                lda (originalX),y
10587						                .cerror osword0MaxLineLength+1!=osword0MinASCIICharacter
10588						                .cerror osword0MinASCIICharacter+1!=osword0MaxASCIICharacter
10589	.f0dc	99 b1 02	sta $02b1,y	                sta osword0MaxLineLength-2,y
10590	.f0df	88		dey		                dey
10591	.f0e0	c0 02		cpy #$02	                cpy #$02
10592	.f0e2	b0 f6		bcs $f0da	                bcs LF031
10593	.f0e4	b1 f0		lda ($f0),y	                lda ($F0),y
10594	.f0e6	85 e9		sta $e9		                sta $E9
10595	.f0e8	88		dey		                dey
10596	.f0e9	9c 69 02	stz $0269	                stz pagedModeCounter
10597	.f0ec	b2 f0		lda ($f0)	                lda ($F0)
10598	.f0ee	85 e8		sta $e8		                sta $E8
10599	.f0f0	58		cli		                cli
10600	.f0f1	80 07		bra $f0fa	                bra LF051

10602	.f0f3					LF04A:
10603	.f0f3	a9 07		lda #$07	                lda #$07
10604	.f0f5					LF04C:
10605	.f0f5	88		dey		                dey
10606	.f0f6					LF04D:
10607	.f0f6	c8		iny		                iny
10608	.f0f7					LF04E:
10609	.f0f7	20 ee ff	jsr $ffee	                jsr OSWRCH
10610	.f0fa					LF051:
10611	.f0fa	20 e0 ff	jsr $ffe0	                jsr OSRDCH
10612	.f0fd	b0 49		bcs $f148	                bcs LF09F
10613	.f0ff	aa		tax		                tax
10614	.f100	ad 7c 02	lda $027c	                lda characterDestinationStatus
10615	.f103	6a		ror a		                ror a
10616	.f104	6a		ror a		                ror a
10617	.f105	8a		txa		                txa
10618	.f106	b0 05		bcs $f10d	                bcs LF064
10619	.f108	ae 6a 02	ldx $026a	                ldx vduQueueNegativeLength
10620	.f10b	d0 ea		bne $f0f7	                bne LF04E
10621	.f10d					LF064:
10622	.f10d	c9 7f		cmp #$7f	                cmp #$7F
10623	.f10f	d0 07		bne $f118	                bne LF06F
10624	.f111	c0 00		cpy #$00	                cpy #$00
10625	.f113	f0 e5		beq $f0fa	                beq LF051
10626	.f115	88		dey		                dey
10627	.f116	80 df		bra $f0f7	                bra LF04E

10629	.f118					LF06F:
10630	.f118	c9 15		cmp #$15	                cmp #$15
10631	.f11a	d0 0d		bne $f129	                bne LF080
10632	.f11c	98		tya		                tya
10633	.f11d	f0 db		beq $f0fa	                beq LF051
10634	.f11f	a9 7f		lda #$7f	                lda #$7F
10635	.f121					LF078:
10636	.f121	20 ee ff	jsr $ffee	                jsr OSWRCH
10637	.f124	88		dey		                dey
10638	.f125	d0 fa		bne $f121	                bne LF078
10639	.f127	80 d1		bra $f0fa	                bra LF051

10641	.f129					LF080:
10642	.f129	91 e8		sta ($e8),y	                sta ($E8),y
10643	.f12b	c9 0d		cmp #$0d	                cmp #$0D
10644	.f12d	f0 13		beq $f142	                beq LF099
10645	.f12f	cc b3 02	cpy $02b3	                cpy osword0MaxLineLength
10646	.f132	b0 bf		bcs $f0f3	                bcs LF04A
10647	.f134	cd b4 02	cmp $02b4	                cmp osword0MinASCIICharacter
10648	.f137	90 bc		bcc $f0f5	                bcc LF04C
10649	.f139	cd b5 02	cmp $02b5	                cmp osword0MaxASCIICharacter
10650	.f13c	f0 b8		beq $f0f6	                beq LF04D
10651	.f13e	90 b6		bcc $f0f6	                bcc LF04D
10652	.f140	80 b3		bra $f0f5	                bra LF04C

10654	.f142					LF099:
10655	.f142	20 e7 ff	jsr $ffe7	                jsr OSNEWL
10656	.f145	20 5e ec	jsr $ec5e	                jsr callNETV
10657	.f148					LF09F:
10658	.f148	a5 ff		lda $ff		                lda $FF
10659	.f14a	2a		rol a		                rol a
10660	.f14b	60		rts		                rts

10662						;-------------------------------------------------------------------------
10663						;
10664						; OSBYTE 3 (&03) Specify output stream [MasRef D.2-19]
10665						;
10666	.f14c					osbyte03:
10667	.f14c	da		phx		                phx
10668	.f14d	ae 7c 02	ldx $027c	                ldx characterDestinationStatus
10669	.f150	a9 0a		lda #$0a	                lda #printerDriverFX3
10670	.f152	20 67 ea	jsr $ea67	                jsr callPrinterDriver
10671	.f155	fa		plx		                plx
10672	.f156	a9 03		lda #$03	                lda #$03
10673	.f158	a0 00		ldy #$00	                ldy #$00
10674	.f15a	80 23		bra $f17f	                bra osbyte04

10676						;-------------------------------------------------------------------------
10677						;
10678						; OSBYTE 6 (&06) Write printer ignore character [MasRef D.2-21]
10679						;
10680	.f15c					osbyte06:                       ;f0b3
10681	.f15c	4e 46 02	lsr $0246	                lsr noignoreState
10682	.f15f	80 16		bra $f177	                bra osbyte01

10684						;-------------------------------------------------------------------------
10685						;
10686						; OSBYTE 114 (&72) Write usage of shadow memory [MasRef D.2-32]
10687						;
10688	.f161					osbyte72:                       ;f0b8
10689	.f161	a9 1f		lda #$1f	                lda #$1F
10690	.f163	80 10		bra $f175	                bra LF0CC

10692						;-------------------------------------------------------------------------
10693						;
10694						; OSBYTE 5 (&05) Write printer driver type [MasRef D.2-20]
10695						;
10696	.f165					osbyte05:
10697	.f165					waitForPrinterDriverDormant:
10698	.f165	58		cli		                cli
10699	.f166	78		sei		                sei
10700	.f167	24 ff		bit $ff		                bit $FF                      ;test for ESCAPE
10701	.f169	30 29		bmi $f194	                bmi rtsF0EB                  ;taken if ESCAPE pressed
10702	.f16b	2c d1 02	bit $02d1	                bit bufferEmptyFlags+bufferPrinter
10703	.f16e	10 f5		bpl $f165	                bpl waitForPrinterDriverDormant ;taken if printer driver active
10704	.f170	20 67 ea	jsr $ea67	                jsr callPrinterDriver    ;call with A=printerDriverFX5
10705	.f173	a0 00		ldy #$00	                ldy #$00
10706	.f175					LF0CC:
10707	.f175	64 f1		stz $f1		                stz $F1

10709						                ; fall through to standard MOS variable handling,
10710						                ; affecting printerDriverType

10712						;-------------------------------------------------------------------------
10713						;
10714						; OSBYTE 1 (&01) Write user flag [MasRef D.2-18]
10715						;
10716	.f177					osbyte01:
10717	.f177	49 f0		eor #$f0	                eor #firstMOSVariableOSBYTE+(userFlag-mosVariables)-1 ;-1 because OSBYTE 1
10718	.f179	80 07		bra $f182	                bra osbyteA6X  ;jump to standard MOS variable handling

10720						;-------------------------------------------------------------------------
10721						;
10722						; OSBYTE 12 (&0C) Write keyboard auto-repeat rate [MasRef D.2-23]
10723						;
10724	.f17b					osbyte0C:
10725	.f17b	f0 33		beq $f1b0	                beq resetKeyRepeat    ;taken if X=0

10727						;-------------------------------------------------------------------------
10728						;
10729						; OSBYTE 11 (&0B) Write keyboard auto-repeat delay [MasRef D.2-22]
10730						;
10731	.f17d					osbyte0B:
10732						                ; TODO - turn this constant into an expression
10733	.f17d	69 cf		adc #$cf	                adc #$CF

10735						                ;if osbyte0C, A=$db
10736						                ;if osbyteOD, A=$dc

10738						;-------------------------------------------------------------------------
10739						;
10740						; OSBYTE 4 (&04) Enable/disable cursor editing [MasRef D.2-19]
10741						;
10742	.f17f					osbyte04:
10743	.f17f	18		clc		                clc
10744	.f180	69 e9		adc #$e9	                adc #firstMOSVariableOSBYTE+(editKeysMode-mosVariables)-4 ;-4 because OSBYTE 4

10746						                ;if originally OSBYTE 4 (&04) Enable/disable cursor
10747						                ;editing [MasRef D.2-19], it's now OSBYTE 237 (&ED)
10748						                ;Read/write cursor editing status [MasRef D.2-77].
10749						                ;
10750						                ;if originally OSBYTE 12 (&0C) Write keyboard
10751						                ;auto-repeat rate [MasRef D.2-23], it's now OSBYTE 197
10752						                ;(&C5) Read/write keyboard auto-repeat rate [MasRef
10753						                ;D.2-60].
10754						                ;
10755						                ;if originally OSBYTE 11 (&0B) Write keyboard
10756						                ;auto-repeat delay [MasRef D.2-22], it's now OSBYTE
10757						                ;196 (&C4) Read/write keyboard auto-repeat delay
10758						                ;[MasRef D.2-60].

10760	.f182					osbyteA6X:
10761	.f182	86 f0		stx $f0		                stx originalX

10763						;-------------------------------------------------------------------------
10764						;
10765						; OSBYTE 166 (&A6) Read start address of MOS variables [MasRef D.2-50]
10766						;
10767	.f184					osbyteA6:
10768	.f184	a8		tay		                tay             ;
10769	.f185	b9 90 01	lda $0190,y	                lda mosVariables-firstMOSVariableOSBYTE,y;
10770	.f188	aa		tax		                tax             ;save old value
10771	.f189	25 f1		and $f1		                and originalY   ;AND old value with Y
10772	.f18b	45 f0		eor $f0		                eor originalX   ;EOR old value with X
10773	.f18d	99 90 01	sta $0190,y	                sta mosVariables-firstMOSVariableOSBYTE,y     ;set new variable value
10774	.f190	b9 91 01	lda $0191,y	                lda mosVariables-firstMOSVariableOSBYTE+1,y
10775	.f193	a8		tay		                tay             ;Y=contents of next location
10776	.f194					rtsF0EB:
10777	.f194	60		rts		                rts

10779						;-------------------------------------------------------------------------
10780						;
10781						; This table is used to set the serial baud rate.
10782						;
10783						;   - bit 7 is not used (always clear)
10784						;   - bit 6 is not used (always set)
10785						;   - bits 3,4,5 indicate the serial receive baud rate
10786						;   - bits 0,1,2 indicate the serial transmit baud rate
10787						;
10788						;       111 =    75 baud
10789						;       011 =   150 baud
10790						;       101 =   300 baud
10791						;       001 =  1200 baud
10792						;       110 =  2400 baud
10793						;       010 =  4800 baud
10794						;       100 =  9600 baud
10795						;       000 = 19200 baud
10796						;
10797						                .if version!=400
10798	.f195					serialBaudRatesTable:
10799	>f195	64				                .byte %01100100;$64
10800	>f196	7f				                .byte %01111111;$7f
10801	>f197	5b				                .byte %01011011;$5b
10802	>f198	6d				                .byte %01101101;$6d
10803	>f199	49				                .byte %01001001;$49
10804	>f19a	76				                .byte %01110110;$76
10805	>f19b	52				                .byte %01010010;$52
10806	>f19c	64				                .byte %01100100;$64
10807	>f19d	40				                .byte %01000000;$40
10808						                .endif

10810						;-------------------------------------------------------------------------
10811						;
10812						; OSBYTE 19 (&13) Wait for vertical sync [MasRef D.2-26]
10813						;
10814	.f19e					osbyte13:
10815	.f19e	ad 40 02	lda $0240	                lda cfsTimeoutCounter
10816	.f1a1					-
10817	.f1a1	58		cli		                cli
10818	.f1a2	78		sei		                sei
10819	.f1a3	cd 40 02	cmp $0240	                cmp cfsTimeoutCounter
10820	.f1a6	f0 f9		beq $f1a1	                beq -

10822						                ; fall through to OSBYTE $a0 (!!)

10824						;-------------------------------------------------------------------------
10825						;
10826						; OSBYTE 160 (&A0) Read VDU variable value [MasRef D.2-49]
10827						;
10828	.f1a8					osbyteA0:
10829	.f1a8	bc 01 03	ldy $0301,x	                ldy vduv+1,x
10830	.f1ab	bd 00 03	lda $0300,x	                lda vduv+0,x
10831	.f1ae	aa		tax		                tax
10832	.f1af	60		rts		                rts

10834						;-------------------------------------------------------------------------
10835						;
10836						; Reset key auto repeat settings to the defaults set in CMOS.
10837						;
10838						                .if version==350
10841						                .endif
10842	.f1b0					resetKeyRepeat:
10843	.f1b0	20 50 f4	jsr $f450	                jsr withTerminalROM
10844						                .if version<500&&version!=350
10848						                .else
10849	.f1b3	a2 0c		ldx #$0c	                ldx #CMOSBytes.keyboardAutoRepeatDelay+cmosBytesOffset
10850	.f1b5	20 ca 9d	jsr $9dca	                jsr terminal.readRTCByte
10851	.f1b8	8d 54 02	sta $0254	                sta keyboardAutoRepeatDelay
10852	.f1bb	a2 0d		ldx #$0d	                ldx #CMOSBytes.keyboardAutoRepeatRate+cmosBytesOffset
10853	.f1bd	20 ca 9d	jsr $9dca	                jsr terminal.readRTCByte
10854	.f1c0	a8		tay		                tay
10855						                .endif
10856	.f1c1	ae 55 02	ldx $0255	                ldx keyboardAutoRepeatRate
10857	.f1c4	8c 55 02	sty $0255	                sty keyboardAutoRepeatRate
10858	.f1c7	60		rts		                rts

10860						;-------------------------------------------------------------------------
10861						;
10862						; OSBYTE 18 (&12) Reset soft keys [MasRef D.2-26]
10863						;
10864						; MasRef says X undefined on exit; in fact, X=0, and terminal.scanROMs
10865						; relies on this.
10866						;
10867	.f1c8					osbyte12:
10868	.f1c8	38		sec		                sec
10869	.f1c9	6e 84 02	ror $0284	                ror softKeyConsistencyFlag   ;mark soft keys inconsistent
10870	.f1cc	a5 f4		lda $f4		                lda $F4
10871	.f1ce	48		pha		                pha                          ;push selected paged ROM
10872	.f1cf	20 98 e5	jsr $e598	                jsr selectTerminalROMAndANDY

10874						                ; point each soft key at the 0th byte of the strings -
10875						                ; they all then have length 0.
10876	.f1d2	a2 10		ldx #$10	                ldx #softKeyCount
10877	.f1d4					-
10878	.f1d4	a9 22		lda #$22	                lda #<andy.softKeys.strings
10879	.f1d6	9d 00 80	sta $8000,x	                sta andy.softKeys.stringLSBs,x
10880	.f1d9	a9 80		lda #$80	                lda #>andy.softKeys.strings
10881	.f1db	9d 11 80	sta $8011,x	                sta andy.softKeys.stringMSBs,x
10882	.f1de	ca		dex		                dex
10883	.f1df	10 f3		bpl $f1d4	                bpl -

10885	.f1e1	68		pla		                pla                 ;pop previously selected paged ROM
10886	.f1e2	20 ab e5	jsr $e5ab	                jsr selectROMA

10888	.f1e5	9c 68 02	stz $0268	                stz softKeyStringLength
10889	.f1e8	9c 84 02	stz $0284	                stz softKeyConsistencyFlag   ;mark soft keys consistent
10890	.f1eb	e8		inx		                inx
10891	.f1ec	60		rts		                rts

10893						;-------------------------------------------------------------------------
10894						;
10895						; OSWORD 11 (&0B) Read the palette [MasRef D.3-20]
10896						;
10897	.f1ed					osword0B:
10898	.f1ed	2d 60 03	and $0360	                and vduv.numberOfLogicalColoursMinusOne
10899	.f1f0	aa		tax		                tax
10900	.f1f1	bd 6f 03	lda $036f,x	                lda vduv.currentPalette,x
10901	.f1f4					LF146:
10902	.f1f4	c8		iny		                iny
10903	.f1f5					LF147:
10904	.f1f5	91 f0		sta ($f0),y	                sta (originalX),y
10905	.f1f7	a9 00		lda #$00	                lda #$00                     ;fill last 3 bytes with 0
10906	.f1f9	c0 04		cpy #$04	                cpy #$04
10907	.f1fb	d0 f7		bne $f1f4	                bne LF146
10908	.f1fd	60		rts		                rts

10910						;-------------------------------------------------------------------------
10911						;
10912						; OSWORD 9 (&09) Read pixel logical colour [MasRef D.3-19]
10913						;
10914	.f1fe					osword09:                                    ;f150
10915	.f1fe	20 77 f4	jsr $f477	                jsr withMOSROM               ; sF150= 20 AB F3     +s
10916	.f201	a0 03		ldy #$03	                ldy #$03
10917	.f203					-
10918	.f203	b1 f0		lda ($f0),y	                lda (originalX),y
10919	.f205	99 28 03	sta $0328,y	                sta vduv.workspace._28,y
10920	.f208	b9 10 03	lda $0310,y	                lda $0310,y
10921	.f20b	48		pha		                pha
10922	.f20c	88		dey		                dey
10923	.f20d	10 f4		bpl $f203	                bpl -
10924	.f20f	a9 28		lda #$28	                lda #VDUVariables.workspace._28
10925	.f211	20 b7 dd	jsr $ddb7	                jsr readPixelColour
10926	.f214	aa		tax		                tax
10927	.f215	a0 00		ldy #$00	                ldy #$00
10928	.f217					LF169:
10929	.f217	68		pla		                pla
10930	.f218	99 10 03	sta $0310,y	                sta $0310,y
10931	.f21b	c8		iny		                iny
10932	.f21c	c0 04		cpy #$04	                cpy #$04
10933	.f21e	d0 f7		bne $f217	                bne LF169
10934	.f220	8a		txa		                txa
10935	.f221	80 d2		bra $f1f5	                bra LF147

10937	.f223					osword0A:                                    ;f175
10938	.f223	20 3c e2	jsr $e23c	                jsr getSoftCharacterDefinitionAddress
10939	.f226	a0 00		ldy #$00	                ldy #$00
10940	.f228	a5 f4		lda $f4		                lda $F4
10941	.f22a	48		pha		                pha
10942	.f22b	20 98 e5	jsr $e598	                jsr selectTerminalROMAndANDY
10943	.f22e					LF180:
10944	.f22e	b1 de		lda ($de),y	                lda ($DE),y
10945	.f230	c8		iny		                iny
10946	.f231	91 f0		sta ($f0),y	                sta ($F0),y
10947	.f233	c0 08		cpy #$08	                cpy #$08
10948	.f235	d0 f7		bne $f22e	                bne LF180
10949	.f237	fa		plx		                plx
10950	.f238	4c 9a e5	jmp $e59a	                jmp selectROMX

10952	.f23b					osword0C:                                    ;f18d
10953	.f23b	20 77 f4	jsr $f477	                jsr withMOSROM
10954	.f23e	08		php		                php
10955	.f23f	2d 60 03	and $0360	                and $0360
10956	.f242	aa		tax		                tax
10957	.f243	c8		iny		                iny
10958	.f244	b1 f0		lda ($f0),y	                lda ($F0),y
10959	.f246	4c 39 c6	jmp $c639	                jmp LC639

10961	.f249					osword0D:                                    ;f19b
10962	.f249	20 77 f4	jsr $f477	                jsr withMOSROM
10963	.f24c	a9 03		lda #$03	                lda #$03
10964	.f24e	20 53 f2	jsr $f253	                jsr LF1A5
10965	.f251	a9 07		lda #$07	                lda #$07
10966	.f253					LF1A5:
10967	.f253	48		pha		                pha
10968	.f254	20 c6 e2	jsr $e2c6	                jsr LE2B6
10969	.f257	20 df c4	jsr $c4df	                jsr LC4DF
10970	.f25a	a2 03		ldx #$03	                ldx #$03
10971	.f25c	68		pla		                pla
10972	.f25d	a8		tay		                tay
10973	.f25e					LF1B0:
10974	.f25e	bd 10 03	lda $0310,x	                lda $0310,x
10975	.f261	91 f0		sta ($f0),y	                sta ($F0),y
10976	.f263	88		dey		                dey
10977	.f264	ca		dex		                dex
10978	.f265	10 f7		bpl $f25e	                bpl LF1B0
10979	.f267	60		rts		                rts

10981						; Read address of bottom of screen/top of user memory
10982						; ===================================================
10983	.f268					osbyte84:                     ;f1ba
10984	.f268	a5 d0		lda $d0		                lda STATE     ; Get VDU status
10985	.f26a	89 10		bit #$10	                bit #STATE.isShadowMode ; If shadow screen, jump to return &8000
10986	.f26c	d0 18		bne $f286	                bne LF1D8
10987	.f26e					LF1C0:
10988	.f26e	ad 55 03	lda $0355	                lda $0355                    ; Get current screen MODE

10990						; Return start of screen for non-shadow MODE in X
10991						; -----------------------------------------------
10992	.f271					LF1C3:
10993	.f271	29 07		and #$07	                and #$07
10994	.f273	a8		tay		                tay
10995	.f274	be 78 e1	ldx $e178,y	                ldx screenMODEGroupForMODE,y ; Get screen map for supplied MODE
10996	.f277	bd 8e e1	lda $e18e,x	                lda startScreenAddressHighByteForScreenMODEGroup,x ; Get address top byte for this screen map
10997	.f27a					LF1CC:
10998	.f27a	a2 00		ldx #$00	                ldx #$00                     ; Address=&xx00
10999	.f27c	a8		tay		                tay
11000	.f27d	60		rts		                rts

11002						;-------------------------------------------------------------------------
11003						;
11004						; OSBYTE 133 (&85) Read top of user RAM for given mode [MasRef D.2-41]
11005						;
11006	.f27e					osbyte85:
11007	.f27e	8a		txa		                txa                          ; If MODE &80+n, return &8000
11008	.f27f	30 05		bmi $f286	                bmi LF1D8
11009	.f281	ae 7f 02	ldx $027f	                ldx shadowRAMState ; If *SHADOW<>0, jump to return non-shadow address
11010	.f284	d0 eb		bne $f271	                bne LF1C3
11011	.f286					LF1D8:
11012	.f286	a9 80		lda #$80	                lda #$80                     ; Return &8000
11013	.f288	80 f0		bra $f27a	                bra LF1CC

11015						;-------------------------------------------------------------------------
11016						;
11017						; OSBYTE 135 (&87) Read screen mode and character at text cursor
11018						; position [MasRef D.2-42]
11019						;
11020	.f28a					osbyte87: ;F1DC:
11021	.f28a	20 77 f4	jsr $f477	                jsr withMOSROM
11022	.f28d	4c f8 dd	jmp $ddf8	                jmp readCharacterAtTextCursor

11024						;-------------------------------------------------------------------------
11025						;
11026						; OSBYTE 139 (&8B) Write Filing System options [MasRef D.2-43]
11027						;
11028	.f290					osbyte8B:
11029	.f290	0a		asl a		                asl a

11031						;-------------------------------------------------------------------------
11032						;
11033						; OSBYTE 127 (&7F) Check for end of file on an opened file [MasRef D.2-37]
11034						;
11035	.f291					osbyte7F:
11036	.f291	29 01		and #$01	                and #$01

11038						;-------------------------------------------------------------------------
11039						;
11040						; Call OSFSC. There's no entry point for this.
11041						;
11042	.f293					callFSCV:
11043	.f293	6c 1e 02	jmp ($021e)	                jmp (FSCV)

11045						;-------------------------------------------------------------------------
11046						;
11047						; OSWORD 15 (&0F) Write CMOS clock [MasRef D.3-24]
11048						;
11049						                .if version!=350
11050	.f296					osword0F:
11051	.f296	20 50 f4	jsr $f450	                jsr withTerminalROM       ; Page in ROM 15
11052	.f299	4c 73 98	jmp $9873	                jmp terminal.osword0F
11053						                .endif

11055						;-------------------------------------------------------------------------

11057						; Set TAPE/ROM extended vectors
11058						; =============================
11059	.f29c					LF1EE:
11060	.f29c	a2 15		ldx #$15	                ldx #$15
11061	.f29e					LF1F0:
11062	.f29e	bd a7 f2	lda $f2a7,x	                lda LF1FA-1,x
11063	.f2a1	9d b9 0d	sta $0db9,x	                sta ExtendedVectorAddress(FILEV)-1,x
11064	.f2a4	ca		dex		                dex
11065	.f2a5	d0 f7		bne $f29e	                bne LF1F0
11066	.f2a7					LF1F9:
11067	.f2a7	60		rts		                rts

11069						; TAPE/ROM extended vector values
11070						; -------------------------------
11071	.f2a8					LF1FA:
11072	>f2a8	fb a4				                .word terminal.osfileTapeOrROM ; FILEV
11073	>f2aa	0f				                .byte terminalROM
11074	>f2ab	9d a3				                .word terminal.osargsTapeOrROM ; ARGSV
11075	>f2ad	0f				                .byte terminalROM
11076	>f2ae	3d a7				                .word terminal.bputTapeOrROM ; BPUTV
11077	>f2b0	0f				                .byte terminalROM
11078						                .if version==400
11080						                .else
11081	>f2b1	9e a7				                .word terminal.bgetTapeOrROM ; BGETV
11082						                .endif
11083	>f2b3	0f				                .byte terminalROM
11084	>f2b4	c0 a7				                .word terminal.osgbpbTapeOrROM ; GBPBV
11085	>f2b6	0f				                .byte terminalROM
11086	>f2b7	4c a6				                .word terminal.osfindTapeOrROM ; FINDV
11087	>f2b9	0f				                .byte terminalROM
11088	>f2ba	00 a4				                .word terminal.fscTapeOrROM  ; FSCV
11089	>f2bc	0f				                .byte terminalROM

11091						;-------------------------------------------------------------------------
11092						;
11093						; OSBYTE 109 (&6D) Make temporary Filing System permanent
11094						;
11095						; MasRef D.2-30
11096						;
11097	.f2bd					osbyte6D:;f20f
11098	.f2bd	ae 01 df	ldx $df01	                ldx hazel.activeFS; Copy active FS to current FS
11099	.f2c0	8e 00 df	stx $df00	                stx hazel.currentFS
11100	.f2c3	ad bc 0d	lda $0dbc	                lda ExtendedVectorAddress(FILEV)+2 ; Copy XFILEV ROM to current FS ROM number
11101	.f2c6	8d 03 df	sta $df03	                sta hazel.currentFSROM
11102	.f2c9					rtsF180:
11103	.f2c9	60		rts		                rts

11105						;-------------------------------------------------------------------------
11106						;
11107						; OSBYTE 20 (&14) Restore default font definitions
11108						;
11109						; MasRef D.2-24
11110						;
11111						                .if version!=350
11112	.f2ca					osbyte14:                       ;f21c
11113	.f2ca	20 50 f4	jsr $f450	                jsr withTerminalROM
11114	.f2cd	4c 7c 94	jmp $947c	                jmp terminal.restoreFont32To126
11115						                .endif

11117						;-------------------------------------------------------------------------
11118						;
11119						; OSBYTE 25 (&19) Restore a group of font definitions
11120						;
11121						; MasRef D.2-28
11122						;
11123	.f2d0					osbyte19:                       ;f222
11124						                .if version>=511||version==350
11133						                .endif
11134	.f2d0	20 50 f4	jsr $f450	                jsr withTerminalROM
11135	.f2d3	4c 80 94	jmp $9480	                jmp terminal.osbyte19

11137						;-------------------------------------------------------------------------

11139						; OSBYTE &16 - Increment ROM polling semaphore
11140						; ========================================
11141	.f2d6					osbyte16:                       ;f228
11142	.f2d6	ee 43 02	inc $0243	                inc romPollingSemaphore
11143	.f2d9					LF2EB:
11144	.f2d9	60		rts		                rts

11146						;-------------------------------------------------------------------------

11148						; OSBYTE &17 - Decrement ROM polling semaphore
11149	.f2da					osbyte17:                       ;f22c
11150						; ========================================
11151	.f2da	ce 43 02	dec $0243	                dec romPollingSemaphore
11152	.f2dd	60		rts		                rts

11154						;-------------------------------------------------------------------------

11156						                .if version==350
11164						                .endif

11166						;-------------------------------------------------------------------------

11168						; OSBYTE &76 - Set LEDs to keyboard state
11169						; =======================================
11170	.f2de					osbyte76:
11171	.f2de	08		php		                php                          ; Disable IRQs
11172	.f2df	78		sei		                sei
11173	.f2e0	a9 40		lda #$40	                lda #$40                     ; Turn on LEDs
11174	.f2e2	20 ef f2	jsr $f2ef	                jsr LF241
11175	.f2e5	30 05		bmi $f2ec	                bmi LF23E                    ; Exit if Escape pending
11176	.f2e7	18		clc		                clc                          ; Call KEYV to read SHIFT and CTRL
11177	.f2e8	b8		clv		                clv
11178	.f2e9	20 7b f7	jsr $f77b	                jsr callKEYV
11179						; Returns A.b7=CTRL, A.b6=SHIFT, MI=CTRL, VS=SHIFT
11180	.f2ec					LF23E:
11181	.f2ec	28		plp		                plp                          ; Restore IRQs
11182	.f2ed	2a		rol a		                rol a                        ; Set Carry from A bit 7 and return
11183	.f2ee	60		rts		                rts
11184						; Returns A.b7=SHIFT, CS=CTRL

11186						; Set keyboard LEDs
11187						; -----------------
11188	.f2ef					LF241:
11189	.f2ef	90 09		bcc $f2fa	                bcc LF24C                    ; Skip if not called from OSBYTE
11190	.f2f1	a0 07		ldy #$07	                ldy #$07                     ; Turn ShiftLock LED on
11191	.f2f3	8c 40 fe	sty $fe40	                sty systemVIA.orb
11192	.f2f6	88		dey		                dey                          ; Turn CapsLock LED on
11193	.f2f7	8c 40 fe	sty $fe40	                sty systemVIA.orb
11194	.f2fa					LF24C:
11195	.f2fa	24 ff		bit $ff		                bit $FF                      ; Test Escape and return
11196	.f2fc	60		rts		                rts

11198						;-------------------------------------------------------------------------

11200	.f2fd					osbyte9A:
11201	.f2fd	8a		txa		                txa
11202	.f2fe					setVCONTROL:
11203	.f2fe	08		php		                php
11204	.f2ff	78		sei		                sei
11205	.f300	8d 48 02	sta $0248	                sta vcontrolRegister
11206	.f303	8d 20 fe	sta $fe20	                sta VCONTROL
11207	.f306	ad 53 02	lda $0253	                lda secondFlashColourDuration
11208	.f309	8d 51 02	sta $0251	                sta flashCounter
11209	.f30c	28		plp		                plp
11210	.f30d	60		rts		                rts

11212						;-------------------------------------------------------------------------
11213						;
11214						; OSBYTE 155 (&9B) Write to video ULA palette register and copy
11215						;
11216	.f30e					osbyte9B:
11217	.f30e	8a		txa		                txa
11218	.f30f					writeVPALETTE:
11219	.f30f	49 07		eor #$07	                eor #$07
11220	.f311	08		php		                php
11221	.f312	78		sei		                sei
11222	.f313	8d 49 02	sta $0249	                sta vpaletteRegister
11223	.f316	8d 21 fe	sta $fe21	                sta VPALETTE
11224	.f319	28		plp		                plp
11225	.f31a	60		rts		                rts

11227						;-------------------------------------------------------------------------

11229	.f31b					gsinitForFilenameParsing:
11230	.f31b	18		clc		                clc


11233						;-------------------------------------------------------------------------
11234						;
11235						; GSINIT
11236						;
11237						; MasRef D.10-1
11238						;
11239	.f31c					gsinitEntryPoint:
11240	.f31c	66 e4		ror $e4		                ror stringInputOptions    ;put C into bit 7
11241	.f31e	20 ad f3	jsr $f3ad	                jsr skipSpacesAndCheckForCRInStringInput
11242	.f321	c8		iny		                iny
11243	.f322	c9 22		cmp #$22	                cmp #'"'
11244	.f324	f0 02		beq $f328	                beq +                       ; C=1 if double quotes
11245	.f326	88		dey		                dey
11246	.f327	18		clc		                clc                         ; clear double quotes flag
11247	.f328					+
11248	.f328	66 e4		ror $e4		                ror stringInputOptions ; set doubleQuotes; move bit 7 into spaceNotATerminator
11249	.f32a	c9 0d		cmp #$0d	                cmp #$0D                     ; set Z if initial CR
11250	.f32c	60		rts		                rts

11252						;-------------------------------------------------------------------------
11253						;
11254						; GSREAD
11255						;
11256						; MasRef D.10-2
11257						; MasRef C.5-8 has the | syntax
11258						;
11259	.f32d					gsreadEntryPoint:
11260	.f32d	a9 01		lda #$01	                lda #stringInputOptions.goodString
11261	.f32f	04 e4		tsb $e4		                tsb stringInputOptions
11262	.f331	20 4a f3	jsr $f34a	                jsr LF29C
11263	.f334	08		php		                php                          ; save flags
11264	.f335	46 e4		lsr $e4		                lsr stringInputOptions       ; move goodString into C
11265	.f337	90 04		bcc $f33d	                bcc badStringError           ; branch taken if bad string
11266	.f339	26 e4		rol $e4		                rol stringInputOptions       ; reinstate goodString
11267	.f33b	28		plp		                plp                          ; restore flags
11268	.f33c	60		rts		                rts                          ;

11270	.f33d					badStringError:
11271	.f33d	00		brk #		                brk                          ;
11272	>f33e	fd 42 61 64 20 73 74 72		                .text $fd,"Bad string",0
	>f346	69 6e 67 00
11273	.f34a					LF29C:
11274	.f34a	18		clc		                clc                          ; last char not !
11275	.f34b					LF29D:
11276						                ; C=1 at this point if |! was the last sequence seen.
11277	.f34b	64 e5		stz $e5		                stz stringInputPlingFlag
11278	.f34d	66 e5		ror $e5		                ror stringInputPlingFlag     ; set ! flag as required
11279	.f34f	b1 f2		lda ($f2),y	                lda (stringInputBufferAddress),y
11280	.f351	c9 0d		cmp #$0d	                cmp #13                      ;EOL?
11281	.f353	d0 09		bne $f35e	                bne notRETURN                ;taken if not EOL
11282	.f355	24 e4		bit $e4		                bit stringInputOptions
11283	.f357	10 20		bpl $f379	                bpl finishedString           ;taken if !doubleQuotes
11284	.f359					badString:
11285	.f359	a9 01		lda #$01	                lda #stringInputOptions.goodString
11286	.f35b	14 e4		trb $e4		                trb stringInputOptions
11287	.f35d	60		rts		                rts

11289	.f35e					notRETURN:
11290	.f35e	c9 20		cmp #$20	                cmp #' '
11291	.f360	90 f7		bcc $f359	                bcc badString ;taken if unprintable control char
11292	.f362	d0 06		bne $f36a	                bne notSPACE
11293	.f364	24 e4		bit $e4		                bit stringInputOptions ;N=doubleQuotes, V=spaceNotATerminator
11294	.f366	30 3e		bmi $f3a6	                bmi finishUpReadClearV ;taken if quoted
11295	.f368	50 0f		bvc $f379	                bvc finishedString ;taken if space is a terminator
11296	.f36a					notSPACE:
11297	.f36a	c9 22		cmp #$22	                cmp #'"'
11298	.f36c	d0 10		bne $f37e	                bne notDOUBLEQUOTE         ;taken if not quotes
11299	.f36e	24 e4		bit $e4		                bit stringInputOptions ;N=doubleQuotes, V=spaceNotATerminator
11300	.f370	10 34		bpl $f3a6	                bpl finishUpReadClearV ;taken if not double quotes
11301	.f372	c8		iny		                iny
11302	.f373	b1 f2		lda ($f2),y	                lda (stringInputBufferAddress),y
11303	.f375	c9 22		cmp #$22	                cmp #'"'
11304	.f377	f0 2d		beq $f3a6	                beq finishUpReadClearV       ;taken if quotes
11305	.f379					finishedString:
11306	.f379	20 ad f3	jsr $f3ad	                jsr skipSpacesAndCheckForCRInStringInput
11307	.f37c	38		sec		                sec
11308	.f37d	60		rts		                rts

11310	.f37e					notDOUBLEQUOTE:
11311	.f37e	c9 7c		cmp #$7c	                cmp #'|'
11312	.f380	d0 24		bne $f3a6	                bne finishUpReadClearV       ;taken if not |
11313	.f382	c8		iny		                iny                          ;skip |
11314	.f383	b1 f2		lda ($f2),y	                lda (stringInputBufferAddress),y
11315	.f385	c9 7c		cmp #$7c	                cmp #'|'
11316	.f387	f0 1d		beq $f3a6	                beq finishUpReadClearV ;branch taken if "||" - literal |
11317	.f389	c9 22		cmp #$22	                cmp #'"'
11318	.f38b	f0 19		beq $f3a6	                beq finishUpReadClearV ;branch taken if "|\"" - literal "
11319	.f38d	c9 21		cmp #$21	                cmp #'!'
11320	.f38f	d0 03		bne $f394	                bne LF2E6                    ;taken if not "|!"

11322						                ; Handle |! - ASCII 128-255
11323	.f391	c8		iny		                iny                          ;skip !
11324	.f392	80 b7		bra $f34b	                bra LF29D

11326	.f394					LF2E6:
11327	.f394	c9 20		cmp #$20	                cmp #' '
11328	.f396	90 c1		bcc $f359	                bcc badString ;taken if | followed by a non-printable char
11329	.f398	c9 3f		cmp #$3f	                cmp #'?'
11330	.f39a	f0 08		beq $f3a4	                beq ascii127                 ;taken if "|?" - CHR$127
11331	.f39c	20 eb f3	jsr $f3eb	                jsr implementCTRLCodes
11332	.f39f	2c 70 e3	bit $e370	                bit valueFF
11333	.f3a2	80 03		bra $f3a7	                bra LF2F9

11335	.f3a4					ascii127:
11336	.f3a4	a9 7f		lda #$7f	                lda #$7F
11337	.f3a6					finishUpReadClearV:
11338	.f3a6	b8		clv		                clv
11339	.f3a7					LF2F9:
11340	.f3a7	c8		iny		                iny
11341	.f3a8	05 e5		ora $e5		                ora stringInputPlingFlag ;if it was a |! char, set bit 7
11342	.f3aa	18		clc		                clc
11343	.f3ab	60		rts		                rts

11345						;-------------------------------------------------------------------------

11347	.f3ac					incAndSkipSpaces:
11348	.f3ac	c8		iny		                iny
11349	.f3ad					skipSpacesAndCheckForCRInStringInput:
11350	.f3ad	b1 f2		lda ($f2),y	                lda (stringInputBufferAddress),y
11351	.f3af	c9 20		cmp #$20	                cmp #' '
11352	.f3b1	f0 f9		beq $f3ac	                beq incAndSkipSpaces
11353	.f3b3					checkForCR:
11354	.f3b3	c9 0d		cmp #$0d	                cmp #13
11355	.f3b5	60		rts		                rts

11357						;-------------------------------------------------------------------------

11359	.f3b6					LF308:
11360	.f3b6	90 f5		bcc $f3ad	                bcc skipSpacesAndCheckForCRInStringInput
11361	.f3b8					LF30A:
11362	.f3b8	20 ad f3	jsr $f3ad	                jsr skipSpacesAndCheckForCRInStringInput
11363	.f3bb	c9 2c		cmp #$2c	                cmp #','
11364	.f3bd	d0 f4		bne $f3b3	                bne checkForCR
11365	.f3bf	c8		iny		                iny
11366	.f3c0	60		rts		                rts

11368						;-------------------------------------------------------------------------

11370						                .if version==510&&olivetti
11459						                .endif

11461						;-------------------------------------------------------------------------
11462						;
11463						; Modify character in A as if the SHIFT key is being pressed.
11464						;

11466	.f3c1					implementShift:
11467						                .if version<500&&version!=350
11493						                .else

11495	.f3c1	a2 02		ldx #$02	                ldx #2
11496	.f3c3	50 00		bvc $f3c5	                bvc LF3C5
11497	.f3c5					LF3C5:
11498	.f3c5	dd e6 f3	cmp $f3e6,x	                cmp LF3E7-1,x
11499	.f3c8	f0 18		beq $f3e2	                beq LF3E2
11500	.f3ca	ca		dex		                dex
11501	.f3cb	d0 f8		bne $f3c5	                bne LF3C5
11502	.f3cd	50 12		bvc $f3e1	                bvc LF3E1
11503	.f3cf	c9 21		cmp #$21	                cmp #'!'
11504	.f3d1	90 0e		bcc $f3e1	                bcc LF3E1
11505	.f3d3	c9 40		cmp #$40	                cmp #'@'
11506						                .if version==350
11508						                .endif
11509	.f3d5	90 08		bcc $f3df	                bcc LF3DF
11510	.f3d7	c9 7f		cmp #$7f	                cmp #$7f
11511	.f3d9	f0 06		beq $f3e1	                beq LF3E1
11512	.f3db	b0 02		bcs $f3df	                bcs LF3DF

11514	.f3dd					LF3DD:
11515	.f3dd	49 30		eor #$30	                eor #$30
11516	.f3df					LF3DF:
11517	.f3df	49 10		eor #$10	                eor #$10
11518	.f3e1					LF3E1:
11519	.f3e1	60		rts		                rts

11521	.f3e2					LF3E2:
11522	.f3e2	b8		clv		                clv
11523	.f3e3	bd e8 f3	lda $f3e8,x	                lda LF3E9-1,x
11524	.f3e6	60		rts		                rts

11526	.f3e7					LF3E7:
11527	>f3e7	5f				                .byte '_'
11528	>f3e8	30				                .byte '0'
11529	.f3e9					LF3E9:
11530	>f3e9	60				                .byte '`'
11531						                .if version==350
11533						                .else
11534	>f3ea	40				                .byte '@'
11535						                .endif

11537						                .endif

11539						;-------------------------------------------------------------------------
11540						;
11541						; See MasRef C.5-8
11542						;
11543						;
11544	.f3eb					implementCTRLCodes:
11545						                .if version<500&&version!=350
11560						                .else

11562	.f3eb	da		phx		                phx
11563	.f3ec	a2 02		ldx #$02	                ldx #2
11564	.f3ee					LF3EE:
11565	.f3ee	dd 09 f4	cmp $f409,x	                cmp LF40A-1,x
11566	.f3f1	f0 11		beq $f404	                beq LF404
11567	.f3f3	ca		dex		                dex
11568	.f3f4	d0 f8		bne $f3ee	                bne LF3EE
11569	.f3f6	fa		plx		                plx
11570	.f3f7	c9 3f		cmp #$3f	                cmp #'?'
11571	.f3f9	90 08		bcc $f403	                bcc LF403
11572	.f3fb	c9 7f		cmp #$7f	                cmp #$7f
11573	.f3fd	f0 04		beq $f403	                beq LF403
11574	.f3ff	b0 dc		bcs $f3dd	                bcs LF3DD
11575	.f401	29 1f		and #$1f	                and #$1f
11576	.f403					LF403:
11577	.f403	60		rts		                rts

11579	.f404					LF404:
11580	.f404	b8		clv		                clv
11581	.f405	bd 0b f4	lda $f40b,x	                lda LF40C-1,x
11582	.f408	fa		plx		                plx
11583	.f409	60		rts		                rts

11585	.f40a					LF40A:
11586	>f40a	30 40				                .text '0','@'
11587	.f40c					LF40C:
11588	>f40c	00 00				                .text 0,0

11590						                .endif

11592						;-------------------------------------------------------------------------

11594	.f40e					osbyte247EntryPoint:
11595						                .if version==350
11598						                .endif
11599	.f40e	ad 87 02	lda $0287	                lda breakVectorByte0
11600	.f411	49 4c		eor #$4c	                eor #$4C                     ; JMP abs
11601	.f413	d0 1a		bne $f42f	                bne rtsF363
11602						                .if version==350
11607						                .else
11608	.f415	a5 f4		lda $f4		                lda $f4
11609	.f417	48		pha		                pha
11610	.f418	20 87 02	jsr $0287	                jsr breakVectorByte0
11611	.f41b	68		pla		                pla
11612	.f41c	85 f4		sta $f4		                sta $f4
11613	.f41e	60		rts		                rts
11614						                .endif

11616						;-------------------------------------------------------------------------
11617						;
11618						; OSBYTE 144 (&90)
11619						; Set vertical screen shift and interlace
11620						;
11621						; MasRef D.2-44
11622						;
11623	.f41f					osbyte90:
11624	.f41f	ad 90 02	lda $0290	                lda tvOffset
11625	.f422	8e 90 02	stx $0290	                stx tvOffset
11626	.f425	aa		tax		                tax
11627	.f426	98		tya		                tya
11628	.f427	29 01		and #$01	                and #$01
11629	.f429	ac 91 02	ldy $0291	                ldy tvInterlace
11630	.f42c	8d 91 02	sta $0291	                sta tvInterlace
11631	.f42f					rtsF363:
11632	.f42f	60		rts		                rts

11634						;-------------------------------------------------------------------------
11635						;
11636						; OSBYTE 149 (&95) <80><93> write to JIM
11637						;
11638						; MasRef D.2-45
11639						;
11640	.f430					osbyte95:
11641	.f430	98		tya		                tya
11642	.f431	9d 00 fd	sta $fd00,x	                sta $FD00,x
11643	.f434	60		rts		                rts

11645						;-------------------------------------------------------------------------
11646						;
11647						; OSBYTE 151 (&97) <80><93> write to SHEILA
11648						;
11649						; MasRef D.2-45
11650						;
11651	.f435					osbyte97:
11652	.f435	98		tya		                tya
11653	.f436	9d 00 fe	sta $fe00,x	                sta $FE00,x
11654	.f439	60		rts		                rts

11656						;-------------------------------------------------------------------------
11657						;
11658						; OSBYTE 147 (&93) <80><93> write to FRED
11659						;
11660						; MasRef D.2-45
11661						;
11662	.f43a					osbyte93:
11663	.f43a	98		tya		                tya
11664	.f43b	9d 00 fc	sta $fc00,x	                sta $FC00,x
11665	.f43e	60		rts		                rts

11667						;-------------------------------------------------------------------------
11668						;
11669						; *SHUT [MasRef G.5-10]
11670						;
11671	.f43f					starSHUT:
11672	.f43f	a2 26		ldx #$26	                ldx #romServiceCallCloseAllOpenFiles
11673	.f441	4c f8 ee	jmp $eef8	                jmp makeROMServiceCall

11675						;-------------------------------------------------------------------------
11676						;
11677						; Return thunk used by withTerminalROM.
11678						;
11679						; On entry here, the old value of $f4 is at the top of the stack.
11680						;
11681	.f444					withTerminalROMReturnThunk:
11682	.f444	08		php		                php                          ; S=[p; old ROMSEL]
11683	.f445	48		pha		                pha                          ; S=[a; p; old ROMSEL]
11684	.f446	da		phx		                phx                          ; S=[x; a; p; old ROMSEL]
11685	.f447	ba		tsx		                tsx
11686	.f448	bd 04 01	lda $0104,x	                lda $0104,x                  ; get old ROMSEL
11687	.f44b	20 ab e5	jsr $e5ab	                jsr selectROMA               ; re-select old ROM
11688	.f44e	80 5d		bra $f4ad	                bra returnThunkSuffix

11690						;-------------------------------------------------------------------------
11691						;
11692						; Select the Terminal ROM. Rearrange the stack so that the original
11693						; ROM is re-selected when withTerminalROM's caller itself returns.
11694						;
11695	.f450					withTerminalROM:
11696						                .if version==350
11704						                .else
11705	.f450	48		pha		                pha                          ; S=[A]
11706	.f451	48		pha		                pha                          ; S=[A; A]
11707	.f452	48		pha		                pha                          ; S=[A; A; A]
11708	.f453	08		php		                php                          ; S=[P; A; A; A]
11709	.f454	48		pha		                pha                          ; S=[A; P; A; A; A]
11710	.f455	da		phx		                phx                          ; S=[X; A; P; A; A; A]
11711	.f456	ba		tsx		                tsx                          ; S=[X; A; P; A; A; A; RL; RH]
11712	.f457	bd 07 01	lda $0107,x	                lda $0107,x                  ; get RL
11713	.f45a	9d 04 01	sta $0104,x	                sta $0104,x                  ; overwrite placeholder A
11714	.f45d	bd 08 01	lda $0108,x	                lda $0108,x                  ; get RH
11715	.f460	9d 05 01	sta $0105,x	                sta $0105,x                  ; overwrite placeholder A
11716	.f463	a5 f4		lda $f4		                lda $F4                      ; get ROMSEL
11717	.f465	9d 08 01	sta $0108,x	                sta $0108,x                  ; overwrite RH

11719						                ; put return thunk in the right spot
11720	.f468	a9 f4		lda #$f4	                lda #>withTerminalROMReturnThunk-1
11721	.f46a	9d 07 01	sta $0107,x	                sta $0107,x
11722	.f46d	a9 43		lda #$43	                lda #<withTerminalROMReturnThunk-1
11723	.f46f	9d 06 01	sta $0106,x	                sta $0106,x
11724						                .endif
11725	.f472	20 a9 e5	jsr $e5a9	                jsr selectTerminalROM
11726	.f475	80 28		bra $f49f	                bra plx_pla_plp_rts

11728						;-------------------------------------------------------------------------
11729						;
11730						; Select the MOS ROM (i.e., no HAZEL). Rearrange the stack so that the
11731						; original HAZEL state is restored when withMOSROM's caller itself
11732						; returns.
11733						;
11734	.f477					withMOSROM:
11735						                .if version==350
11744						                .else
11745	.f477	48		pha		                pha                          ; S=[A]
11746	.f478	48		pha		                pha                          ; S=[A; A]
11747	.f479	48		pha		                pha                          ; S=[A; A; A]
11748	.f47a	08		php		                php                          ; S=[P; A; A; A]
11749	.f47b	48		pha		                pha                          ; S=[A; P; A; A; A]
11750	.f47c	da		phx		                phx                          ; S=[X; A; P; A; A; A]
11751	.f47d	ba		tsx		                tsx                          ; S=[X; A; P; A; A; A; RL; RH]
11752	.f47e	bd 08 01	lda $0108,x	                lda $0108,x                  ; get RH
11753	.f481	9d 05 01	sta $0105,x	                sta $0105,x                  ; overwrite placeholder A
11754	.f484	bd 07 01	lda $0107,x	                lda $0107,x                  ; get RL
11755	.f487	9d 04 01	sta $0104,x	                sta $0104,x                  ; overwrite placeholder A

11757						                ; put return thunk in the right spot
11758	.f48a	a9 f4		lda #$f4	                lda #>withMOSROMReturnThunk-1
11759	.f48c	9d 07 01	sta $0107,x	                sta $0107,x
11760	.f48f	a9 a2		lda #$a2	                lda #<withMOSROMReturnThunk-1
11761	.f491	9d 06 01	sta $0106,x	                sta $0106,x

11763	.f494	ad 34 fe	lda $fe34	                lda ACCCON                   ; get ACCCON
11764	.f497	9d 08 01	sta $0108,x	                sta $0108,x                  ; overwrite RH
11765	.f49a	a9 08		lda #$08	                lda #ACCCON.Y
11766	.f49c	1c 34 fe	trb $fe34	                trb ACCCON
11767						                ; HAZEL off
11768						                .endif
11769	.f49f					plx_pla_plp_rts:
11770						                ; S=[X; A; P; RL; RH; thunkRL; thunkRH; old ACCCON/ROMSEL]
11771	.f49f	fa		plx		                plx
11772	.f4a0	68		pla		                pla
11773	.f4a1	28		plp		                plp
11774	.f4a2	60		rts		                rts

11776	.f4a3					withMOSROMReturnThunk:
11777	.f4a3	08		php		                php                          ; S=[P]
11778	.f4a4	48		pha		                pha                          ; S=[A; P]
11779	.f4a5	da		phx		                phx                          ; S=[X; A; P]
11780	.f4a6	ba		tsx		                tsx                          ; S=[X; A; P; old ACCCON]
11781	.f4a7	bd 04 01	lda $0104,x	                lda $0104,x                  ; get old ACCCON
11782	.f4aa	20 36 ee	jsr $ee36	                jsr selectMOSOrHAZEL         ; re-select old HAZEL state
11783	.f4ad					returnThunkSuffix:
11784						                ; double up P, as that's the easiest way of ending up
11785						                ; discarding the TOS without affecting the flags.
11786	.f4ad	bd 03 01	lda $0103,x	                lda $0103,x
11787	.f4b0	9d 04 01	sta $0104,x	                sta $0104,x
11788	.f4b3	fa		plx		                plx
11789	.f4b4	68		pla		                pla
11790	.f4b5	28		plp		                plp
11791	.f4b6	28		plp		                plp
11792	.f4b7	60		rts		                rts

11794						;-------------------------------------------------------------------------

11796						                .if version==350
11819						                .endif

11821						;-------------------------------------------------------------------------

11823						                .if version==350
11840						                .endif

11842						;-------------------------------------------------------------------------

11844	.f4b8					vduChrEntryPoint:
11845	.f4b8	20 77 f4	jsr $f477	                jsr withMOSROM
11846	.f4bb	a6 f4		ldx $f4		                ldx $F4
11847	.f4bd	da		phx		                phx
11848	.f4be	20 98 e5	jsr $e598	                jsr selectTerminalROMAndANDY
11849	.f4c1	20 27 c0	jsr $c027	                jsr outputToVDU
11850	.f4c4	fa		plx		                plx
11851	.f4c5	4c 9a e5	jmp $e59a	                jmp selectROMX

11853						;-------------------------------------------------------------------------
11854						;
11855						; OSRDSC [MasRef D.6-1]
11856						;
11857	.f4c8					osrdscEntryPoint:
11858	.f4c8	20 77 f4	jsr $f477	                jsr withMOSROM
11859	.f4cb	4c 18 c0	jmp $c018	                jmp LC018

11861						;-------------------------------------------------------------------------
11862						;
11863						; OSWRSC [MasRef D.8-1]
11864						;
11865	.f4ce					oswrscEntryPoint:
11866	.f4ce	20 77 f4	jsr $f477	                jsr withMOSROM
11867	.f4d1	4c 5f db	jmp $db5f	                jmp oswrscCode

11869						;-------------------------------------------------------------------------

11871	.f4d4					starRunBOOT:
11872	>f4d4	2f 21 42 4f 4f 54 0d		                .text "/!BOOT",13

11874						;-------------------------------------------------------------------------

11876						                .if version<500&&version!=350
11878						                .endif

11880						;-------------------------------------------------------------------------

11882						                .if version>=500

11884	.f4db					LF416:
11885	.f4db	a5 f4		lda $f4		                lda $f4
11886	.f4dd	48		pha		                pha
11887	.f4de	20 a9 e5	jsr $e5a9	                jsr selectTerminalROM
11888	.f4e1	20 56 9f	jsr $9f56	                jsr terminal.LF416
11889	.f4e4	fa		plx		                plx
11890	.f4e5	4c 9a e5	jmp $e59a	                jmp selectROMX

11892	.f4e8					clearSoundChannelBuffer:
11893	.f4e8	da		phx		                phx
11894	.f4e9	a5 f4		lda $f4		                lda $f4
11895	.f4eb	48		pha		                pha
11896	.f4ec	20 a9 e5	jsr $e5a9	                jsr selectTerminalROM
11897	.f4ef	20 9d a0	jsr $a09d	                jsr terminal.clearSoundChannelBuffer
11898	.f4f2	fa		plx		                plx
11899	.f4f3	20 9a e5	jsr $e59a	                jsr selectROMX
11900	.f4f6	fa		plx		                plx
11901	.f4f7	60		rts		                rts

11903						                .endif

11905						;-------------------------------------------------------------------------

11907						                .if version==350
11913						                .endif

11915						;-------------------------------------------------------------------------

11917						                .if version==350
11925						                .endif

11927						;-------------------------------------------------------------------------

11929						                .if version==350
11934						                .endif

11936						;-------------------------------------------------------------------------

11938	.f4f8					LF6FC:
11939	.f4f8	a9 ff		lda #$ff	                lda #$FF
11940	.f4fa	85 f5		sta $f5		                sta $F5
11941	.f4fc	60		rts		                rts

11943	.f4fd					LF701:
11944	.f4fd	e6 f5		inc $f5		                inc $F5
11945	.f4ff	a4 f5		ldy $f5		                ldy $F5
11946	.f501	a2 0d		ldx #$0d	                ldx #romServiceCallROMFilingSystemInitialize
11947	.f503					LF707:
11948	.f503	08		php		                php
11949	.f504	20 f8 ee	jsr $eef8	                jsr makeROMServiceCall
11950	.f507	28		plp		                plp
11951	.f508	c9 01		cmp #$01	                cmp #$01
11952	.f50a	98		tya		                tya
11953	.f50b	60		rts		                rts

11955	.f50c					LF710:
11956	.f50c	a2 0e		ldx #$0e	                ldx #$0E
11957	.f50e	a0 ff		ldy #$ff	                ldy #$FF
11958	.f510	4c 03 f5	jmp $f503	                jmp LF707

11960	.f513					LF717:
11961	.f513	ad cb 03	lda $03cb	                lda $03CB
11962	.f516	85 f6		sta $f6		                sta $F6
11963	.f518	ad cc 03	lda $03cc	                lda $03CC
11964	.f51b	85 f7		sta $f7		                sta $F7
11965	.f51d	a5 f5		lda $f5		                lda $F5
11966	.f51f	60		rts		                rts

11968	.f520					tidyUpAfterKeyboardProcessing:
11969	.f520	a2 ff		ldx #$ff	                ldx #$FF
11970	.f522	a5 ec		lda $ec		                lda lastKeyPressedInternal
11971	.f524	05 ed		ora $ed		                ora firstKeyPressedInternal
11972	.f526	d0 06		bne $f52e	                bne +                    ;taken if any keys pressed
11973	.f528	a9 81		lda #$81	                lda #$81
11974	.f52a	8d 4e fe	sta $fe4e	                sta systemVIA.ier            ;re-enable keyboard IRQ
11975	.f52d	e8		inx		                inx                          ;X=0
11976	.f52e					+
11977	.f52e	8e 42 02	stx $0242	                stx keyboardSemaphore
11978	.f531					updateKeyboardLEDs:
11979	.f531	08		php		                php
11980	.f532	ad 5a 02	lda $025a	                lda keyboardStatusByte
11981	.f535	4a		lsr a		                lsr a

11983						                ; bit 3 = caps lock off
11984						                ; bit 4 = shift lock off
11985	.f536	29 18		and #$18	                and #(keyboardStatusByte.capsLockDisengaged|keyboardStatusByte.shiftLockDisengaged)>>1
11986	.f538	09 06		ora #$06	                ora #$06                     ;latch B6 - caps lock
11987	.f53a	8d 40 fe	sta $fe40	                sta systemVIA.orb            ;update caps lock LED
11988	.f53d	4a		lsr a		                lsr a                        ;bit 3 = shift lock off
11989	.f53e	09 07		ora #$07	                ora #$07                     ;latch B7 - shift lock
11990	.f540	8d 40 fe	sta $fe40	                sta systemVIA.orb            ;update shift lock LED
11991	.f543	20 95 f7	jsr $f795	                jsr enableKeyboardScanning
11992	.f546	68		pla		                pla
11993	.f547	60		rts		                rts

11995						; KEYV handler
11996						; ============
11997	.f548					keyEntryPoint:
11998	.f548	50 0a		bvc $f554	                bvc keyVClear
11999	.f54a	a9 01		lda #$01	                lda #$01
12000	.f54c	8d 4e fe	sta $fe4e	                sta systemVIA.ier
12001	.f54f	b0 08		bcs $f559	                bcs keyboardTimerInterrupt
12002	.f551	4c de f6	jmp $f6de	                jmp keyPressedInterrupt

12004	.f554					keyVClear:
12005	.f554	90 06		bcc $f55c	                bcc keyTestSHIFTAndCTRLOrTimerInterrupt
12006	.f556	4c 8f f7	jmp $f78f	                jmp scanKeyboard

12008	.f559					keyboardTimerInterrupt:
12009	.f559	ee 42 02	inc $0242	                inc keyboardSemaphore

12011						;-------------------------------------------------------------------------
12012						;
12013						; Test Shift & Ctrl keys, or deal with timer interrupt.
12014						;
12015						; Entry: C=0 if KEYV V=0 C=0 - test SHIFT+CTRL keys
12016						;        C=1 if KEYV V=1 C=1 - keyboard timer interrupt
12017						;
12018	.f55c					keyTestSHIFTAndCTRLOrTimerInterrupt:
12019	.f55c	ad 5a 02	lda $025a	                lda keyboardStatusByte
12020	.f55f	29 b7		and #$b7	                and #~(keyboardStatusByte.shiftPressed|keyboardStatusByte.ctrlPressed)
12021	.f561	a2 00		ldx #$00	                ldx #key_shift
12022	.f563	20 f9 f6	jsr $f6f9	                jsr interrogateKeyboard      ;X=$80 if SHIFT pressed
12023	.f566	90 02		bcc $f56a	                bcc +                        ;taken if testing
12024						                                             ;SHIFT+CTRL only
12025	.f568	86 fa		stx $fa		                stx SEIWKA                   ;b7 set if SHIFT pressed
12026	.f56a					+
12027	.f56a	b8		clv		                clv                        ;V=0
12028	.f56b	10 05		bpl $f572	                bpl testCTRL               ;taken if SHIFT not pressed
12029	.f56d	2c 70 e3	bit $e370	                bit valueFF                ;V=1 N=1
12030	.f570	09 08		ora #$08	                ora #keyboardStatusByte.shiftPressed
12031	.f572					testCTRL:
12032	.f572	e8		inx		                inx                          ;X=1 - key_ctrl
12033	.f573	20 f9 f6	jsr $f6f9	                jsr interrogateKeyboard
12034	.f576	90 b9		bcc $f531	                bcc updateKeyboardLEDs ;taken if testing SHIFT+CTRL only
12035	.f578	10 02		bpl $f57c	                bpl updateKeyboardStatusByte ;taken if CTRL not pressed
12036	.f57a	09 40		ora #$40	                ora #keyboardStatusByte.ctrlPressed
12037	.f57c					updateKeyboardStatusByte:
12038	.f57c	8d 5a 02	sta $025a	                sta keyboardStatusByte
12039	.f57f	a6 ec		ldx $ec		                ldx lastKeyPressedInternal
12040	.f581	f0 4d		beq $f5d0	                beq braRolloverChecks        ;taken if no key pressed
12041	.f583	20 f9 f6	jsr $f6f9	                jsr interrogateKeyboard      ;still pressed?
12042	.f586	30 0d		bmi $f595	                bmi checkForKeyAutoRepeat    ;taken if still pressed
12043	.f588	e4 ec		cpx $ec		                cpx lastKeyPressedInternal   ;X=0 at this point
12044	.f58a					storeLastKeyPressed:
12045	.f58a	86 ec		stx $ec		                stx lastKeyPressedInternal   ;update last key pressed
12046	.f58c	d0 42		bne $f5d0	                bne braRolloverChecks  ;taken if still nothing pressed
12047	.f58e	64 ec		stz $ec		                stz lastKeyPressedInternal   ;reset last key pressed
12048	.f590					resetAutoRepeatAndContinue:
12049	.f590	20 ee f6	jsr $f6ee	                jsr resetAutoRepeatCounters
12050	.f593	80 3b		bra $f5d0	                bra braRolloverChecks

12052	.f595					checkForKeyAutoRepeat:
12053	.f595	e4 ec		cpx $ec		                cpx lastKeyPressedInternal
12054	.f597	d0 f1		bne $f58a	                bne storeLastKeyPressed      ;taken if new key pressed
12055	.f599	a5 e7		lda $e7		                lda autoRepeatCountdownTimer
12056	.f59b	f0 33		beq $f5d0	                beq braRolloverChecks      ;taken if countdown timer 0
12057	.f59d	c6 e7		dec $e7		                dec autoRepeatCountdownTimer ;timer--
12058	.f59f	d0 2f		bne $f5d0	                bne braRolloverChecks        ;taken if timer newly 0
12059	.f5a1	ad ca 02	lda $02ca	                lda keyboardFirstAutoRepeatCount
12060	.f5a4	85 e7		sta $e7		                sta autoRepeatCountdownTimer
12061	.f5a6	ad 55 02	lda $0255	                lda keyboardAutoRepeatRate
12062	.f5a9	8d ca 02	sta $02ca	                sta keyboardFirstAutoRepeatCount
12063	.f5ac	ad 5a 02	lda $025a	                lda keyboardStatusByte
12064	.f5af	a6 ec		ldx $ec		                ldx lastKeyPressedInternal
12065	.f5b1	e0 d0		cpx #$d0	                cpx #$80|key_shift_lock
12066	.f5b3	f0 12		beq $f5c7	                beq shiftLockPressed
12067	.f5b5	e0 c0		cpx #$c0	                cpx #$80|key_caps_lock
12068						                .if version>=511||version==350
12070						                .else
12071	.f5b7	d0 1a		bne $f5d3	                bne getASCIICode
12072						                .endif
12073	.f5b9					capsLockPressed:
12074	.f5b9	09 a0		ora #$a0	                ora #keyboardStatusByte.shiftEnabled|keyboardStatusByte.shiftLockDisengaged
12075	.f5bb	24 fa		bit $fa		                bit SEIWKA                   ;test SHIFT status
12076	.f5bd	10 04		bpl $f5c3	                bpl +                        ;taken if SHIFT not pressed
12077						                ; Do the SHIFT+CAPS LOCK thing
12078	.f5bf	09 10		ora #$10	                ora #keyboardStatusByte.capsLockDisengaged
12079	.f5c1	49 80		eor #$80	                eor #keyboardStatusByte.shiftEnabled
12080	.f5c3					+
12081	.f5c3	49 90		eor #$90	                eor #keyboardStatusByte.shiftEnabled|keyboardStatusByte.capsLockDisengaged
12082	.f5c5	80 04		bra $f5cb	                bra resetKeyboardStatusAndTimer

12084	.f5c7					shiftLockPressed:
12085	.f5c7	09 90		ora #$90	                ora #keyboardStatusByte.shiftEnabled|keyboardStatusByte.capsLockDisengaged
12086	.f5c9	49 a0		eor #$a0	                eor #keyboardStatusByte.shiftEnabled|keyboardStatusByte.shiftLockDisengaged
12087	.f5cb					resetKeyboardStatusAndTimer:
12088	.f5cb	8d 5a 02	sta $025a	                sta keyboardStatusByte
12089	.f5ce	64 e7		stz $e7		                stz autoRepeatCountdownTimer
12090	.f5d0					braRolloverChecks:
12091						                .if version<500&&version!=350
12093						                .else
12094	.f5d0	4c be f6	jmp $f6be	                jmp keyboardRolloverChecks
12095						                .endif

12097						;-------------------------------------------------------------------------

12099						                .if version>=511||version==350
12127						                .endif
12128						;-------------------------------------------------------------------------
12129						;
12130						; Convert internal key number (with bit 7 set) to ASCII code, taking
12131						; into account state of CTRL, SHIFT, CAPS LOCK and SHIFT LOCK.
12132						;
12133	.f5d3					getASCIICode:
12134						                ; -$80 to adjust for bit 7 set; -16 because
12135						                ; interesting keys start at 16
12136	.f5d3	bd 7b f6	lda $f67b,x	                lda keyTranslationTable-$80-16,x
12137						                .if version>=500
12138	.f5d6	ae 7d 02	ldx $027d	                ldx editKeysMode
12139	.f5d9	e0 03		cpx #$03	                cpx #3
12140	.f5db	d0 08		bne $f5e5	                bne LF5E5
12141	.f5dd	c9 8b		cmp #$8b	                cmp #$8b
12142	.f5df	90 04		bcc $f5e5	                bcc LF5E5
12143	.f5e1	c9 90		cmp #$90	                cmp #$90
12144	.f5e3	90 eb		bcc $f5d0	                bcc braRolloverChecks
12145	.f5e5					LF5E5:
12146	.f5e5	48		pha		                pha
12147	.f5e6	c9 1b		cmp #$1b	                cmp #27
12148	.f5e8	d0 05		bne $f5ef	                bne LF5EF
12149	.f5ea	a9 07		lda #$07	                lda #7
12150	.f5ec	1c 5a 02	trb $025a	                trb keyboardStatusByte
12151	.f5ef					LF5EF:
12152	.f5ef	68		pla		                pla
12153						                .endif
12154	.f5f0	f0 08		beq $f5fa	                beq handleTAB                ;taken if TAB
12155	.f5f2	c9 9d		cmp #$9d	                cmp #$9D                     ;was it key_numpad_return?
12156						                .if version<500&&version!=350
12158						                .else
12159	.f5f4	d0 07		bne $f5fd	                bne LF5FD
12160						                .endif

12162						                ;Transform $9d into $8d, aka 13|$80. ($8d is already
12163						                ; used in the table for right arrow.)
12164	.f5f6	49 10		eor #$10	                eor #$10
12165	.f5f8	80 31		bra $f62b	                bra getNumpadASCIICode

12167	.f5fa					handleTAB:
12168	.f5fa	ad 6b 02	lda $026b	                lda tabKeyCode
12169						                .if version>=500
12170	.f5fd					LF5FD:
12171	.f5fd	c9 01		cmp #$01	                cmp #1
12172	.f5ff	d0 1e		bne $f61f	                bne LF61F
12173	.f601	ad 5a 02	lda $025a	                lda keyboardStatusByte
12174	.f604	29 f8		and #$f8	                and #$f8
12175	.f606	8d 5a 02	sta $025a	                sta keyboardStatusByte
12176	.f609	a2 01		ldx #$01	                ldx #1
12177	.f60b	89 08		bit #$08	                bit #keyboardStatusByte.shiftPressed
12178	.f60d	f0 01		beq $f610	                beq LF610
12179	.f60f	e8		inx		                inx
12180	.f610					LF610:
12181	.f610	89 40		bit #$40	                bit #keyboardStatusByte.ctrlPressed
12182	.f612	f0 02		beq $f616	                beq LF616
12183	.f614	e8		inx		                inx
12184	.f615	e8		inx		                inx
12185	.f616					LF616:
12186	.f616	8a		txa		                txa
12187	.f617	0d 5a 02	ora $025a	                ora keyboardStatusByte
12188	.f61a	8d 5a 02	sta $025a	                sta keyboardStatusByte
12189	.f61d	80 b1		bra $f5d0	                bra braRolloverChecks

12191	.f61f					LF61F:
12192	.f61f	2c 70 e3	bit $e370	                bit valueFF
12193	.f622	c9 90		cmp #$90	                cmp #$90
12194	.f624	90 01		bcc $f627	                bcc handleKey
12195	.f626	b8		clv		                clv
12202						                .endif
12203	.f627					handleKey:
12204	.f627	c9 a0		cmp #$a0	                cmp #$A0                     ;numpad key?
12205	.f629	90 0e		bcc $f639	                bcc processModifiers         ;taken if not
12206	.f62b					getNumpadASCIICode:
12207						                .if version>=500||version==350
12208	.f62b	08		php		                php
12209						                .endif
12210						                ; C=1 at this point
12211	.f62c	e9 31		sbc #$31	                sbc #'0'+1      ;+1 to compensate for C=1 in the next
12212						                                ;addition
12213	.f62e	6d 7e 02	adc $027e	                adc numericKeypadInterpretation ;form actual ASCII value
12214						                .if version>=500||version==350
12215	.f631	28		plp		                plp
12216						                .endif
12217	.f632	49 80		eor #$80	                eor #$80                     ;clear bit 7
12218	.f634	ae 8e 02	ldx $028e	                ldx numericKeypadShiftEffect ;does SHIFT affect the
12219						                                             ;keypad?
12220	.f637	d0 46		bne $f67f	                bne LF839                    ;taken if no
12221	.f639					processModifiers:
12222	.f639	ae 5a 02	ldx $025a	                ldx keyboardStatusByte
12223	.f63c	86 fa		stx $fa		                stx SEIWKA
12224	.f63e	26 fa		rol $fa		                rol SEIWKA                  ;b7 = ctrlPressed
12225	.f640	10 0a		bpl $f64c	                bpl testShiftLock           ;taken if ctrl not pressed
12226	.f642	a6 ed		ldx $ed		                ldx firstKeyPressedInternal
12227	.f644					localResetAutoRepeatAndContinue:
12228						                .if version<500&&version!=350
12231						                .else
12232	.f644	f0 03		beq $f649	                beq +
12233	.f646	4c 90 f5	jmp $f590	                jmp resetAutoRepeatAndContinue
12234	.f649					+
12235	.f649	20 eb f3	jsr $f3eb	                jsr implementCTRLCodes
12236						                .endif
12237	.f64c					testShiftLock:
12238	.f64c	26 fa		rol $fa		                rol SEIWKA                   ;b7 = shiftLockDisengaged
12239	.f64e	30 07		bmi $f657	                bmi testCapsLock             ;taken if shift lock off
12240	.f650	20 c1 f3	jsr $f3c1	                jsr implementShift           ;shift lock on - apply shift
12241	.f653	26 fa		rol $fa		                rol SEIWKA                   ;b7 = capsLockDisengaged
12242	.f655	80 0c		bra $f663	                bra testShiftEnabled

12244	.f657					testCapsLock:
12245	.f657	26 fa		rol $fa		                rol SEIWKA                   ;b7 = capsLockDisengaged
12246	.f659	30 0d		bmi $f668	                bmi testShift                ;taken if caps lock off
12247	.f65b	20 9c eb	jsr $eb9c	                jsr isLetter
12248	.f65e	b0 08		bcs $f668	                bcs testShift                ;taken if not a letter
12249	.f660	20 c1 f3	jsr $f3c1	                jsr implementShift ;letter + caps lock - make upper case
12250	.f663					testShiftEnabled:
12251	.f663	ae 5a 02	ldx $025a	                ldx keyboardStatusByte       ;b7 = shiftEnabled
12252	.f666	10 0b		bpl $f673	                bpl testEscape               ;taken if not shiftEnabled
12253	.f668					testShift:
12254	.f668	26 fa		rol $fa		                rol SEIWKA                   ;b7 = shiftPressed
12255	.f66a	10 07		bpl $f673	                bpl testEscape               ;taken if not shiftPressed
12256	.f66c	a6 ed		ldx $ed		                ldx firstKeyPressedInternal
12257	.f66e	d0 d4		bne $f644	                bne localResetAutoRepeatAndContinue
12258	.f670	20 c1 f3	jsr $f3c1	                jsr implementShift
12259	.f673					testEscape:
12260	.f673	cd 6c 02	cmp $026c	                cmp escapeCharacter
12261	.f676	d0 07		bne $f67f	                bne LF839
12262	.f678	ae 75 02	ldx $0275	                ldx escapeKeyStatus
12263	.f67b	d0 02		bne $f67f	                bne LF839
12264	.f67d	64 e7		stz $e7		                stz autoRepeatCountdownTimer

12266	.f67f					LF839:

12268						                .if version==350
12296						                .elsif version>=500

12298	.f67f	48		pha		                pha
12299	.f680	ad 5a 02	lda $025a	                lda keyboardStatusByte
12300	.f683	29 07		and #$07	                and #7
12301	.f685	aa		tax		                tax
12302						                .if version<511
12303	.f686	a9 07		lda #$07	                lda #7
12304						                .endif
12305	.f688	1c 5a 02	trb $025a	                trb keyboardStatusByte
12306	.f68b	68		pla		                pla
12307	.f68c	48		pha		                pha
12308	.f68d	ca		dex		                dex
12309						                .if version<511
12310	.f68e	d0 03		bne $f693	                bne LF693
12311	.f690	68		pla		                pla
12312						                .if olivetti
12314						                .else
12315	.f691	80 15		bra $f6a8	                bra LF6A8
12316						                .endif
12317						                .endif

12319	.f693					LF693:
12320	.f693	ca		dex		                dex
12321						                .if version<511
12322	.f694	d0 03		bne $f699	                bne LF699
12323	.f696	68		pla		                pla
12324						                .if olivetti
12326						                .else
12327	.f697	80 0f		bra $f6a8	                bra LF6A8
12328						                .endif
12329						                .endif

12331	.f699					LF699:
12332	.f699	ca		dex		                dex
12333						                .if version<511
12334	.f69a	d0 03		bne $f69f	                bne LF69F
12335	.f69c	68		pla		                pla
12336						                .if olivetti
12338						                .else
12339	.f69d	80 09		bra $f6a8	                bra LF6A8
12340						                .endif
12341						                .endif

12343	.f69f					LF69F:
12344	.f69f	ca		dex		                dex
12345						                .if olivetti
12347						                .else
12348	.f6a0	d0 05		bne $f6a7	                bne LF6A7
12349						                .endif
12350	.f6a2	68		pla		                pla
12351	.f6a3	09 80		ora #$80	                ora #$80
12352	.f6a5	80 06		bra $f6ad	                bra LF6AD

12354						                .if olivetti
12362						                .endif

12364	.f6a7					LF6A7:
12365						                .if !olivetti
12366	.f6a7	68		pla		                pla
12367	.f6a8					LF6A8:
12368						                .endif
12369	.f6a8	a8		tay		                tay
12370	.f6a9	50 02		bvc $f6ad	                bvc LF6AD
12371	.f6ab	d0 06		bne $f6b3	                bne LF6B3
12372	.f6ad					LF6AD:
12373	.f6ad	20 2b f8	jsr $f82b	                jsr LF82B
12374	.f6b0	90 09		bcc $f6bb	                bcc LF6BB
12375	.f6b2	a8		tay		                tay

12377	.f6b3					LF6B3:
12378	.f6b3	ad 59 02	lda $0259	                lda keyboardStatus
12379	.f6b6	d0 03		bne $f6bb	                bne LF6BB
12380	.f6b8	20 a9 eb	jsr $eba9	                jsr insertCharacterIntoKeyboardBuffer
12381	.f6bb					LF6BB:
12382	.f6bb	20 1f f8	jsr $f81f	                jsr enableKeyboardScanningFlippingInterrupts

12384						                .endif

12386	.f6be					keyboardRolloverChecks:
12387	.f6be	a6 ed		ldx $ed		                ldx firstKeyPressedInternal
12388	.f6c0	f0 09		beq $f6cb	                beq LF852                    ;taken if 1 key down
12389	.f6c2	20 f9 f6	jsr $f6f9	                jsr interrogateKeyboard      ;test first key pressed
12390	.f6c5	86 ed		stx $ed		                stx firstKeyPressedInternal  ;save it
12391	.f6c7	30 18		bmi $f6e1	                bmi LF868                    ;taken if still pressed
12392	.f6c9	64 ed		stz $ed		                stz firstKeyPressedInternal  ;reset first key
12393	.f6cb					LF852:
12394	.f6cb	a0 ec		ldy #$ec	                ldy #lastKeyPressedInternal
12395	.f6cd	20 e5 f7	jsr $f7e5	                jsr scanKeyboardWithExclusion
12396	.f6d0	30 09		bmi $f6db	                bmi LF862
12397	.f6d2	a5 ec		lda $ec		                lda lastKeyPressedInternal
12398	.f6d4	85 ed		sta $ed		                sta firstKeyPressedInternal
12399	.f6d6					updateLastKeyPressedInternal:
12400	.f6d6	86 ec		stx $ec		                stx lastKeyPressedInternal
12401	.f6d8	20 ee f6	jsr $f6ee	                jsr resetAutoRepeatCounters
12402	.f6db					LF862:
12403	.f6db	4c 20 f5	jmp $f520	                jmp tidyUpAfterKeyboardProcessing

12405	.f6de					keyPressedInterrupt:
12406	.f6de	20 f9 f6	jsr $f6f9	                jsr interrogateKeyboard
12407	.f6e1					LF868:
12408	.f6e1	a5 ec		lda $ec		                lda lastKeyPressedInternal
12409	.f6e3	d0 f6		bne $f6db	                bne LF862
12410	.f6e5	a0 ed		ldy #$ed	                ldy #firstKeyPressedInternal
12411	.f6e7	20 e5 f7	jsr $f7e5	                jsr scanKeyboardWithExclusion
12412	.f6ea	30 ef		bmi $f6db	                bmi LF862
12413	.f6ec	80 e8		bra $f6d6	                bra updateLastKeyPressedInternal

12415	.f6ee					resetAutoRepeatCounters:
12416	.f6ee	a2 01		ldx #$01	                ldx #$01
12417	.f6f0	86 e7		stx $e7		                stx autoRepeatCountdownTimer
12418	.f6f2	ae 54 02	ldx $0254	                ldx keyboardAutoRepeatDelay
12419	.f6f5	8e ca 02	stx $02ca	                stx keyboardFirstAutoRepeatCount
12420	.f6f8	60		rts		                rts

12422						;-------------------------------------------------------------------------
12423						;
12424						; Read a single key's state from the keyboard
12425						;
12426						; Entry:
12427						;
12428						; X = key to test
12429						;
12430						; Exit:
12431						;
12432						; X=$80, N=1 if key pressed; X=$00, N=0 if key not pressed
12433						;
12434						; Preserves: A/C
12435						;
12436						                .if version==350
12439						                .endif
12440	.f6f9					interrogateKeyboard:
12441	.f6f9	a0 03		ldy #$03	                ldy #$03                     ;write to keyboard
12442	.f6fb	8c 40 fe	sty $fe40	                sty systemVIA.orb
12443	.f6fe	a0 7f		ldy #$7f	                ldy #$7F
12444	.f700	8c 43 fe	sty $fe43	                sty systemVIA.ddra           ;bit 7=input, bits 6-0=output
12445	.f703	8e 4f fe	stx $fe4f	                stx systemVIA.oraNoHandshake ;store key value
12446	.f706	ea		nop		                nop
12447	.f707	ae 4f fe	ldx $fe4f	                ldx systemVIA.iraNoHandshake ;read key state
12448	.f70a	60		rts		                rts

12450						; Default keyboard table
12451						; ======================

12453	.f70b					keyTranslationTable:
12454	>f70b	71				                .text "q"                    ;10 q
12455	>f70c	33				                .byte "3"                    ;11 3
12456	>f70d	34				                .byte "4"                    ;12 4
12457	>f70e	35				                .byte "5"                    ;13 5
12458	>f70f	84				                .byte $84                    ;14 f4
12459	>f710	38				                .text "8"                    ;15 8
12460	>f711	87				                .byte $87                    ;16 f7
12461	>f712	2d				                .text "-"                    ;17 minus
12462	>f713	5e				                .text "^"                    ;18 caret
12463	>f714	8c				                .byte $8C                    ;19 left
12464	>f715	b6				                .byte "6"|$80                ;1a numpad_6
12465	>f716	b7				                .byte "7"|$80                ;1b numpad_7
12466	.f717					osbyte92:
12467	.f717	bc 00 fc	ldy $fc00,x	                ldy $FC00,x                  ;1c 1d 1e
12468	.f71a	60		rts		                rts                          ;1f

12470						                .cerror *-keyTranslationTable!=16,'oops'
12471	>f71b	80				                .byte $80                    ;20 f0
12472	>f71c	77				                .text "w"                    ;21 w
12473	>f71d	65				                .text "e"                    ;22 e
12474	>f71e	74				                .text "t"                    ;23 t
12475	>f71f	37				                .text "7"                    ;24 7
12476	>f720	69				                .text "i"                    ;25 i
12477	>f721	39				                .text "9"                    ;26 9
12478	>f722	30				                .text "0"                    ;27 0
12479	>f723	5f				                .text "_"                    ;28 underline
12480	>f724	8e				                .byte $8E                    ;29 down
12481	>f725	b8				                .byte "8"|$80                ;2a numpad_8
12482	>f726	b9				                .byte "9"|$80                ;2b numpad_9
12483	.f727					osbyte94:
12484	.f727	bc 00 fd	ldy $fd00,x	                ldy $FD00,x                  ;2c 2d 2e
12485	.f72a	60		rts		                rts                          ;2f

12487						                .cerror *-keyTranslationTable!=32,'oops'
12488	>f72b	31				                .text "1"                    ;30 1
12489	>f72c	32				                .text "2"                    ;31 2
12490	>f72d	64				                .text "d"                    ;32 d
12491	>f72e	72				                .text "r"                    ;33 r
12492	>f72f	36				                .text "6"                    ;34 6
12493	>f730	75				                .text "u"                    ;35 u
12494	>f731	6f				                .text "o"                    ;36 o
12495	>f732	70				                .text "p"                    ;37 p
12496	>f733	5b				                .text "["                    ;38 left_square_bracket
12497	>f734	8f				                .byte $8F                    ;39 up
12498	>f735	ab				                .byte "+"|$80                ;3a numpad_plus
12499	>f736	ad				                .byte "-"|$80                ;3b numpad_minus
12500	>f737	9d				                .byte $9D                    ;3c numpad_return
12501	.f738					LF8BF:
12502	.f738	6c 20 02	jmp ($0220)	                jmp (EVENTV)                 ;3d 3e 3f
12503						                .cerror *-keyTranslationTable!=48,'oops'
12504	>f73b	01				                .byte 1                      ;40 caps_lock
12505	>f73c	61				                .text "a"                    ;41 a
12506	>f73d	78				                .text "x"                    ;42 x
12507	>f73e	66				                .text "f"                    ;43 f
12508	>f73f	79				                .text "y"                    ;44 y
12509	>f740	6a				                .text "j"                    ;45 j
12510	>f741	6b				                .text "k"                    ;46 k
12511						                .if version<500
12513						                .elsif version>=500
12514	>f742	01				                .byte 1                      ;47 special
12515						                .endif
12516	>f743	3a				                .text ":"                    ;48 colon
12517	>f744	0d				                .byte $0D                    ;49 return
12518	>f745	af				                .byte "/"|$80                ;4a numpad_divide
12519	>f746	ff				                .byte 127|$80                ;4b numpad_delete
12520	>f747	ae				                .byte "."|$80                ;4c numpad_stop
12521	.f748					call1MHzBusHook:
12522	.f748	6c fe fd	jmp ($fdfe)	                jmp ($FDFE)                  ;4d 4e 4f

12524						                .cerror *-keyTranslationTable!=64,'oops'
12525	>f74b	02				                .byte 2                      ;50 shift_lock
12526	>f74c	73				                .text "s"                    ;51 s
12527	>f74d	63				                .text "c"                    ;52 c
12528	>f74e	67				                .text "g"                    ;53 g
12529	>f74f	68				                .text "h"                    ;54 h
12530	>f750	6e				                .text "n"                    ;55 n
12531	>f751	6c				                .text "l"                    ;56 l
12532	>f752	3b				                .text ";"                    ;57 semicolon
12533	>f753	5d				                .text "]"                    ;58 right_square_bracket
12534	>f754	7f				                .byte $7F                    ;59 delete
12535	>f755	a3				                .byte "#"|$80                ;5a numpad_hash
12536	>f756	aa				                .byte "*"|$80                ;5b numpad_multiply
12537	>f757	ac				                .byte ","|$80                ;5c numpad_comma
12538	.f758					callSEIWKA:
12539	.f758	6c fa 00	jmp ($00fa)	                jmp (SEIWKA)                 ;5d 5e 5f
12540						                .cerror *-keyTranslationTable!=80,'oops'
12541	>f75b	00				                .byte 0                      ;60 tab
12542	>f75c	7a				                .text "z"                    ;61 z
12543	>f75d	20				                .text " "                    ;62 space
12544	>f75e	76				                .text "v"                    ;63 v
12545	>f75f	62				                .text "b"                    ;64 b
12546	>f760	6d				                .text "m"                    ;65 m
12547	>f761	2c				                .text ","                    ;66 comma
12548	>f762	2e				                .text "."                    ;67 stop
12549	>f763	2f				                .text "/"                    ;68 divide
12550	>f764	8b				                .byte $8B                    ;69 copy
12551	>f765	b0				                .byte "0"|$80                ;6a numpad_0
12552	>f766	b1				                .byte "1"|$80                ;6b numpad_1
12553	>f767	b3				                .byte "3"|$80                ;6c numpad_3
12554	>f768	00				                .byte 0                      ;6d
12555	>f769	00				                .byte 0                      ;6e
12556	>f76a	00				                .byte 0                      ;6f
12557						                .cerror *-keyTranslationTable!=96,'oops'
12558	>f76b	1b				                .byte 27                     ;70 escape
12559	>f76c	81				                .byte $81                    ;71 f1
12560	>f76d	82				                .byte $82                    ;72 f2
12561	>f76e	83				                .byte $83                    ;73 f3
12562	>f76f	85				                .byte $85                    ;74 f5
12563	>f770	86				                .byte $86                    ;75 f6
12564	>f771	88				                .byte $88                    ;76 f8
12565	>f772	89				                .byte $89                    ;77 f9
12566	>f773	5c				                .byte $5C                    ;78 backslash
12567	>f774	8d				                .byte $8D                    ;79 right
12568	>f775	b4				                .byte "4"|$80                ;7a numpad_4
12569	>f776	b5				                .byte "5"|$80                ;7b numpad_5
12570	>f777	b2				                .byte "2"|$80                ;7c numpad_2
12571	.f778					LF8FF:
12572	.f778	2c 70 e3	bit $e370	                bit valueFF                  ; Set V
12573	.f77b					callKEYV:
12574	.f77b	6c 28 02	jmp ($0228)	                jmp (KEYV)                   ; Jump to KEYV

12576						;-------------------------------------------------------------------------
12577						;
12578						; OSBYTE 131 (&83) - Read Operating System High Water Mark (OSHWM)
12579						;
12580						; MasRef D.2-40
12581						;
12582	.f77e					osbyte83:
12583	.f77e	ac 44 02	ldy $0244	                ldy oshwm
12584	.f781	a2 00		ldx #$00	                ldx #$00
12585	.f783	60		rts		                rts

12587						;-------------------------------------------------------------------------
12588						;
12589						; OSBYTE 120 ($78) - Write keys pressed information
12590						;
12591						; MasRef D.2-33
12592						;
12593	.f784					osbyte78:                          ;f90b
12594	.f784	84 ec		sty $ec		                sty lastKeyPressedInternal
12595	.f786	86 ed		stx $ed		                stx firstKeyPressedInternal
12596	.f788	60		rts		                rts

12598						;-------------------------------------------------------------------------
12599						;
12600						; OSBYTE 122 (&7A) Keyboard scan from 16 decimal
12601						;
12602						; MasRef D.2-36
12603						;
12604						                .if version==350
12607						                .endif
12608	.f789					osbyte7A:
12609	.f789	a2 10		ldx #$10	                ldx #$10
12610	.f78b	b8		clv		                clv
12611	.f78c	38		sec		                sec
12612	.f78d	80 ec		bra $f77b	                bra callKEYV

12614						;-------------------------------------------------------------------------

12616	.f78f					scanKeyboard:
12617	.f78f	8a		txa		                txa
12618	.f790	10 0a		bpl $f79c	                bpl LF923
12619	.f792	20 f9 f6	jsr $f6f9	                jsr interrogateKeyboard
12620	.f795					enableKeyboardScanning:
12621	.f795	a9 0b		lda #$0b	                lda #8|3                     ;set latch B3 - auto scan mode
12622	.f797	8d 40 fe	sta $fe40	                sta systemVIA.orb            ;set auto scan mode
12623	.f79a	8a		txa		                txa
12624	.f79b	60		rts		                rts

12626	.f79c					LF923:
12627	.f79c	8e cb 02	stx $02cb	                stx previousKeyPressedWhenReadingLastKey
12628	.f79f	a9 ff		lda #$ff	                lda #$FF
12629	.f7a1	8d cc 02	sta $02cc	                sta previousKeyPressedWhenReadingFirstKey
12630	.f7a4	a2 0c		ldx #$0c	                ldx #$0C
12631	.f7a6	a9 7f		lda #$7f	                lda #$7F
12632	.f7a8	8d 43 fe	sta $fe43	                sta systemVIA.ddra
12633	.f7ab	a9 03		lda #$03	                lda #0|3            ;reset latch B3 - manual scan mode
12634	.f7ad	8d 40 fe	sta $fe40	                sta systemVIA.orb
12635	.f7b0					loopKeyboardColumns:
12636	.f7b0	a9 0f		lda #$0f	                lda #$0F
12637	.f7b2	8d 4f fe	sta $fe4f	                sta systemVIA.oraNoHandshake ;select a non-existent column
12638	.f7b5	a9 01		lda #$01	                lda #$01
12639	.f7b7	8d 4d fe	sta $fe4d	                sta systemVIA.ifr            ;cancel keyboard interrupts
12640	.f7ba	8e 4f fe	stx $fe4f	                stx systemVIA.oraNoHandshake ;select column
12641	.f7bd	2c 4d fe	bit $fe4d	                bit systemVIA.ifr            ;any key in this column
12642						                                             ;pressed?
12643	.f7c0	f0 1b		beq $f7dd	                beq tryNextKeyboardColumn    ;taken if no key
12644	.f7c2	8a		txa		                txa                          ;A = first key in column
12645	.f7c3					loopKeyboardRows:
12646	.f7c3	18		clc		                clc
12647	.f7c4	69 10		adc #$10	                adc #$10                     ;next row
12648	.f7c6	30 15		bmi $f7dd	                bmi tryNextKeyboardColumn    ;taken if done
12649	.f7c8	8d 4f fe	sta $fe4f	                sta systemVIA.oraNoHandshake ;store key
12650	.f7cb	2c 4f fe	bit $fe4f	                bit systemVIA.iraNoHandshake ;pressed?
12651	.f7ce	10 f3		bpl $f7c3	                bpl loopKeyboardRows         ;taken if not
12652	.f7d0	cd cb 02	cmp $02cb	                cmp previousKeyPressedWhenReadingLastKey
12653	.f7d3	90 ee		bcc $f7c3	                bcc loopKeyboardRows
12654	.f7d5	cd cc 02	cmp $02cc	                cmp previousKeyPressedWhenReadingFirstKey
12655	.f7d8	b0 e9		bcs $f7c3	                bcs loopKeyboardRows
12656	.f7da	8d cc 02	sta $02cc	                sta previousKeyPressedWhenReadingFirstKey
12657	.f7dd					tryNextKeyboardColumn:
12658	.f7dd	ca		dex		                dex
12659	.f7de	10 d0		bpl $f7b0	                bpl loopKeyboardColumns
12660	.f7e0	ae cc 02	ldx $02cc	                ldx previousKeyPressedWhenReadingFirstKey
12661	.f7e3	80 b0		bra $f795	                bra enableKeyboardScanning

12663	.f7e5					scanKeyboardWithExclusion:
12664	.f7e5	a2 0c		ldx #$0c	                ldx #$0c
12665	.f7e7					LF96E:
12666	.f7e7	20 1f f8	jsr $f81f	                jsr enableKeyboardScanningFlippingInterrupts
12667	.f7ea	a9 7f		lda #$7f	                lda #$7F
12668	.f7ec	8d 43 fe	sta $fe43	                sta systemVIA.ddra
12669	.f7ef	a9 03		lda #$03	                lda #0|3
12670	.f7f1	8d 40 fe	sta $fe40	                sta systemVIA.orb
12671	.f7f4	a9 0f		lda #$0f	                lda #$0F
12672	.f7f6	8d 4f fe	sta $fe4f	                sta systemVIA.oraNoHandshake ;select non-existent column
12673	.f7f9	a9 01		lda #$01	                lda #$01
12674	.f7fb	8d 4d fe	sta $fe4d	                sta systemVIA.ifr            ;cancel keyboard interrupts
12675	.f7fe	8e 4f fe	stx $fe4f	                stx systemVIA.oraNoHandshake
12676	.f801	2c 4d fe	bit $fe4d	                bit systemVIA.ifr
12677	.f804	f0 20		beq $f826	                beq LF9AD
12678	.f806	8a		txa		                txa
12679	.f807					LF98E:
12680	.f807	18		clc		                clc
12681	.f808	69 10		adc #$10	                adc #$10
12682	.f80a	30 1a		bmi $f826	                bmi LF9AD                    ;taken if done
12683	.f80c	8d 4f fe	sta $fe4f	                sta systemVIA.oraNoHandshake ;test key
12684	.f80f	2c 4f fe	bit $fe4f	                bit systemVIA.iraNoHandshake ;pressed?
12685	.f812	10 f3		bpl $f807	                bpl LF98E                    ;taken if not
12686	.f814	48		pha		                pha                          ;save key number
12687	.f815					LF99C:
12688	.f815	59 00 00	eor $0000,y	                eor $0000,y                  ;compare to value
12689	.f818	0a		asl a		                asl a                        ;discard irrelevant bit 7
12690	.f819	c9 01		cmp #$01	                cmp #$01                     ;C set if different
12691	.f81b	68		pla		                pla                          ;restore key number
12692	.f81c	90 e9		bcc $f807	                bcc LF98E                    ;same key found - keep going
12693	.f81e	aa		tax		                tax
12694	.f81f					enableKeyboardScanningFlippingInterrupts:
12695	.f81f	20 95 f7	jsr $f795	                jsr enableKeyboardScanning
12696	.f822	58		cli		                cli
12697	.f823	78		sei		                sei
12698	.f824	8a		txa		                txa
12699	.f825	60		rts		                rts

12701	.f826					LF9AD:
12702	.f826	ca		dex		                dex
12703	.f827	10 be		bpl $f7e7	                bpl LF96E
12704	.f829	80 f4		bra $f81f	                bra enableKeyboardScanningFlippingInterrupts

12706						;-------------------------------------------------------------------------

12708						                .if version==400
12710						                .endif

12712						;-------------------------------------------------------------------------

12714						                .if version>=500
12715						                ; dup of what's called LF6D3 in MOS 3.50
12716	.f82b					LF82B:
12717	.f82b	48		pha		                pha
12718	.f82c	a2 00		ldx #$00	                ldx #0
12719	.f82e	b8		clv		                clv
12720	.f82f	38		sec		                sec
12721	.f830	20 ae ed	jsr $edae	                jsr countBufferViaCNPV
12722	.f833	98		tya		                tya
12723	.f834	d0 04		bne $f83a	                bne LF83A
12724	.f836	e0 02		cpx #$02	                cpx #2
12725	.f838	90 0a		bcc $f844	                bcc LF844
12726	.f83a					LF83A:
12727	.f83a	ac 59 02	ldy $0259	                ldy keyboardStatus
12728	.f83d	18		clc		                clc
12729	.f83e	d0 04		bne $f844	                bne LF844
12730	.f840	20 a9 eb	jsr $eba9	                jsr insertCharacterIntoKeyboardBuffer
12731	.f843	38		sec		                sec
12732	.f844					LF844:
12733	.f844	68		pla		                pla
12734	.f845	60		rts		                rts
12735						                .endif

12737						;-------------------------------------------------------------------------

12739						                .if version>=500
12740	.f846					LF846: .block
12741	.f846	20 ab e5	jsr $e5ab	                jsr selectROMA
12742	.f849					LF849:
12743	.f849	b1 b0		lda ($b0),y	                lda ($b0),y
12744	.f84b	91 b2		sta ($b2),y	                sta ($b2),y
12745	.f84d	c8		iny		                iny
12746	.f84e	d0 0d		bne $f85d	                bne LF85D
12747	.f850	e6 b1		inc $b1		                inc $b1
12748	.f852	e6 b3		inc $b3		                inc $b3
12749	.f854	20 a9 e5	jsr $e5a9	                jsr selectTerminalROM
12750	.f857	20 0f 8d	jsr $8d0f	                jsr terminal.L8D0F
12751	.f85a	20 ab e5	jsr $e5ab	                jsr selectROMA
12752	.f85d					LF85D:
12753	.f85d	cc ef 02	cpy $02ef	                cpy $2ef
12754	.f860	d0 e7		bne $f849	                bne LF849
12755	.f862	b5 01		lda $01,x	                lda 1,x
12756	.f864	cd f0 02	cmp $02f0	                cmp $2f0
12757	.f867	d0 e0		bne $f849	                bne LF849
12758	.f869	4c a9 e5	jmp $e5a9	                jmp selectTerminalROM
12759						                .endblock
12760						                .endif

12762						;-------------------------------------------------------------------------

12764						                .if version>=400
12765						                .include "sram_access_helpers_2.s65"

:17	;******  Processing file: src/sram_access_helpers_2.s65

1	.f86c					dummy_rom_header: .block
2	.f86c	60		rts		                rts
3	>f86d	00 00				                .byte 0,0
4	.f86f	60		rts		                rts
5	>f870	00 00				                .byte 0,0
6	>f872	02				                .byte 2
7	>f873	0c				                .byte copyright-dummy_rom_header
8	>f874	ff				                .byte $ff
9	>f875	52				                .text "R"
10	.f876					ram_or_rom_char:
11	>f876	41				                .text "A"
12	>f877	4d				                .text "M"
13	.f878					copyright:
14	>f878	00				                .byte 0
15	>f879	28 43 29			                .text "(C)"
16						                .endblock

18	.f87c					LF87C:
19	.f87c	20 9a e5	jsr $e59a	                jsr selectROMX
20	.f87f	a0 0f		ldy #$0f	                ldy #size(dummy_rom_header)-1
21	.f881					LF881:
22	.f881	b9 6c f8	lda $f86c,y	                lda dummy_rom_header,y
23	.f884	99 00 80	sta $8000,y	                sta $8000,y
24	.f887	88		dey		                dey
25	.f888	10 f7		bpl $f881	                bpl LF881
26	.f88a	2c ee 02	bit $02ee	                bit $2ee
27	.f88d	70 05		bvs $f894	                bvs LF894
28	.f88f	a9 4f		lda #$4f	                lda #'O'
29	.f891	8d 0a 80	sta $800a	                sta $8000+(dummy_rom_header.ram_or_rom_char-dummy_rom_header)
30	.f894					LF894:
31	.f894	8e 01 80	stx $8001	                stx $8001
32	.f897	4c a9 e5	jmp $e5a9	                jmp selectTerminalROM

34						;-------------------------------------------------------------------------

36	.f89a					LF89A:
37	.f89a	20 9a e5	jsr $e59a	                jsr selectROMX
38	.f89d	ad 08 80	lda $8008	                lda $8008
39	.f8a0	a8		tay		                tay
40	.f8a1	49 ff		eor #$ff	                eor #$ff
41	.f8a3	78		sei		                sei
42	.f8a4	8d 08 80	sta $8008	                sta $8008
43	.f8a7	cd 08 80	cmp $8008	                cmp $8008
44	.f8aa	8c 08 80	sty $8008	                sty $8008
45	.f8ad	58		cli		                cli
46	.f8ae	f0 01		beq $f8b1	                beq LF8B1
47	.f8b0	18		clc		                clc
48	.f8b1					LF8B1:
49	.f8b1	4c a9 e5	jmp $e5a9	                jmp selectTerminalROM

51						;-------------------------------------------------------------------------


:15	;******  Return to file: src/mos.s65

12766						                .endif

12768						;-------------------------------------------------------------------------

12770						                .if version>=400
12771	.f8b4					LF8B4:
12772	.f8b4	20 9a e5	jsr $e59a	                jsr selectROMX
12773						                .if version==400
12778						                .else
12779	.f8b7	a0 80		ldy #$80	                ldy #$80
12780	.f8b9	84 01		sty $01		                sty 1
12781	.f8bb	64 00		stz $00		                stz 0
12782						                .endif
12783	.f8bd	a8		tay		                tay
12784	.f8be					LF8BE:
12785	.f8be	91 00		sta ($00),y	                sta (0),y
12786	.f8c0	c8		iny		                iny
12787	.f8c1	d0 fb		bne $f8be	                bne LF8BE
12788	.f8c3	e6 01		inc $01		                inc 1
12789	.f8c5	24 01		bit $01		                bit 1
12790	.f8c7	50 f5		bvc $f8be	                bvc LF8BE
12791	.f8c9	ca		dex		                dex
12792	.f8ca	e0 04		cpx #$04	                cpx #4
12793	.f8cc	b0 e6		bcs $f8b4	                bcs LF8B4
12794	.f8ce	4c a9 e5	jmp $e5a9	                jmp selectTerminalROM
12795						                .endif

12797						;-------------------------------------------------------------------------

12799						LF8D1Macro: .macro
12811						                .endmacro

12813						                .if version>=500
12814	.f8d1					LF8D1:
12800	.f8d1	ad ee 02	lda $02ee	                lda $02ee
12801	.f8d4	c9 a0		cmp #$a0	                cmp #$a0
12802	.f8d6	d0 d9		bne $f8b1	                bne LF8B1
12803	.f8d8	ac f1 02	ldy $02f1	                ldy $2f1
12804	.f8db	98		tya		                tya
12805	.f8dc	aa		tax		                tax
12806	.f8dd	20 ab e3	jsr $e3ab	                jsr LE389
12807	.f8e0	90 cf		bcc $f8b1	                bcc LF8B1
12808	.f8e2	ad 06 80	lda $8006	                lda $8006
12809	.f8e5	9d a1 02	sta $02a1,x	                sta romInformationTable,x
12810	.f8e8	80 c7		bra $f8b1	                bra LF8B1
12815						                .endif

12817						;-------------------------------------------------------------------------

12819						                .if version>=400
12820	.f8ea					LF8EA:
12821	.f8ea	20 50 f4	jsr $f450	                jsr withTerminalROM
12822	.f8ed	4c dc 8e	jmp $8edc	                jmp terminal.L8EDC
12823						                .endif

12825						;-------------------------------------------------------------------------

12827						                .if version>=400
12828	.f8f0					LF8F0:
12829	.f8f0	20 50 f4	jsr $f450	                jsr withTerminalROM
12830	.f8f3	4c 8c 8f	jmp $8f8c	                jmp terminal.L8F8C
12831						                .endif

12833						;-------------------------------------------------------------------------

12835						                .if version>=400
12836	.f8f6					osword10:
12837	.f8f6	20 50 f4	jsr $f450	                jsr withTerminalROM
12838	.f8f9	4c f2 8b	jmp $8bf2	                jmp terminal.L8BF2
12839						                .endif

12841						;-------------------------------------------------------------------------

12843						                .if version>=400
12844	.f8fc					osword11:
12845	.f8fc	20 50 f4	jsr $f450	                jsr withTerminalROM
12846	.f8ff	4c 2e 8e	jmp $8e2e	                jmp terminal.L8E2E
12847						                .endif

12849						;-------------------------------------------------------------------------

12851						                .if version==350
12872						                .endif

12874						;-------------------------------------------------------------------------
12875						;
12876						; OSBPUT [AUG p339]
12877						;
12878	.f902					osbputEntryPoint:
12879	.f902	20 e7 f9	jsr $f9e7	                jsr selectFSForHandle
12880	.f905	6c 18 02	jmp ($0218)	                jmp (BPUTV)

12882						;-------------------------------------------------------------------------
12883						;
12884						; OSBGET [AUG p338]
12885						;
12886	.f908					osbgetEntryPoint:
12887	.f908	20 e7 f9	jsr $f9e7	                jsr selectFSForHandle
12888	.f90b	6c 16 02	jmp ($0216)	                jmp (BGETV)

12890						;-------------------------------------------------------------------------
12891						;
12892						; OSGBPB [AUG p339]
12893						;
12894	.f90e					osgbpbEntryPoint: .proc
12895	.f90e	c9 05		cmp #$05	                cmp #gbpbGetMediaMetadata
12896	.f910	b0 15		bcs $f927	                bcs nonFileOperation
12897	.f912	c9 00		cmp #$00	                cmp #$00
12898	.f914	f0 11		beq $f927	                beq nonFileOperation

12900						                ; Handle OSGBPB call that's an operation on a file
12901						                ; handle. Select the appropriate FS, given the file
12902						                ; handle, and pass the request along.
12903	.f916	5a		phy		                phy                          ;save OSGBPB Y
12904	.f917	48		pha		                pha                          ;save OSGBPB A
12905	.f918	86 b0		stx $b0		                stx osgbpbWorkspace.ptr+0
12906	.f91a	84 b1		sty $b1		                sty osgbpbWorkspace.ptr+1
12907	.f91c	b2 b0		lda ($b0)	                lda (osgbpbWorkspace.ptr)    ;get file handle
12908	.f91e	a8		tay		                tay
12909	.f91f	68		pla		                pla                          ;restore OSGBPB A
12910	.f920	20 e7 f9	jsr $f9e7	                jsr selectFSForHandle
12911	.f923					passToCurrentFS:
12912	.f923	7a		ply		                ply                          ;restore OSGBPB Y
12913	.f924	6c 1a 02	jmp ($021a)	                jmp (GBPBV)

12915						;-------------------------------------------------------------------------
12916						;
12917						; Handle OSGBPB call that isn't an operation on a file handle. Select
12918						; current FS and pass the request along.
12919						;
12920	.f927					nonFileOperation:
12921	.f927	5a		phy		                phy
12922	.f928	da		phx		                phx
12923	.f929	48		pha		                pha
12924	.f92a	20 40 ee	jsr $ee40	                jsr selectHAZEL
12925	.f92d	ad 00 df	lda $df00	                lda hazel.currentFS
12926	.f930	20 9d fa	jsr $fa9d	                jsr selectFS
12927	.f933	68		pla		                pla
12928	.f934	fa		plx		                plx
12929	.f935	80 ec		bra $f923	                bra passToCurrentFS
12930						                .endproc

12932						;-------------------------------------------------------------------------
12933						;
12934						; OSARGS [AUG p337[
12935						;
12936						;
12937	.f937					osargsEntryPoint: .proc
12938	.f937	c0 00		cpy #$00	                cpy #$00
12939	.f939	d0 2a		bne $f965	                bne fileOperation            ;taken if file operation
12940	.f93b	c9 04		cmp #$04	                cmp #$04
12941	.f93d	b0 26		bcs $f965	                bcs fileOperation ;taken if Y=0, A>=4 - honorary file operation
12942	.f93f	48		pha		                pha
12943	.f940	20 40 ee	jsr $ee40	                jsr selectHAZEL
12944	.f943	68		pla		                pla
12945	.f944	d0 04		bne $f94a	                bne notGetFS
12946	.f946					getFS:
12947						                ; OSARGS Y=0 A=0 - read current FS number
12948	.f946	ad 00 df	lda $df00	                lda hazel.currentFS
12949	.f949	60		rts		                rts

12951	.f94a					notGetFS:
12952	.f94a	3a		dec a		                dec a
12953	.f94b	d0 10		bne $f95d	                bne notGetCommandLine
12954	.f94d					getCommandLine:
12955						                ; OSARGS Y=0 A=1 - read command line tail address
12956	.f94d	3a		dec a		                dec a                        ;A=$ff
12957	.f94e	95 02		sta $02,x	                sta 2,x                    ;store full 32-bit address
12958	.f950	95 03		sta $03,x	                sta 3,x                    ;store full 32-bit address
12959	.f952	ad 04 df	lda $df04	                lda hazel.commandLinePointer+0
12960	.f955	95 00		sta $00,x	                sta 0,x                    ;
12961	.f957	ad 05 df	lda $df05	                lda hazel.commandLinePointer+1
12962	.f95a	95 01		sta $01,x	                sta 1,x
12963	.f95c	60		rts		                rts

12965	.f95d					notGetCommandLine:
12966	.f95d	c9 01		cmp #$01	                cmp #argsCheckANFS-1    ;-1 due to the dec a above
12967	.f95f	f0 03		beq $f964	                beq rtsFA14            ; OSARGS Y=0 A=2 - Read OldNFS flag
12968	.f961					getLibFS:
12969	.f961	ad 02 df	lda $df02	                lda hazel.libFS      ;OSARGS Y=0 A=3 - Read libfs filing system number
12970	.f964					rtsFA14:
12971	.f964	60		rts		                rts

12973	.f965					fileOperation:
12974						                ; Operating on a file. Select appropriate FS first.
12975	.f965	20 e7 f9	jsr $f9e7	                jsr selectFSForHandle
12976						                .endproc


12979						;-------------------------------------------------------------------------
12980						;
12981						; Call current FS's OSARGS routine, bypassing the FileSwitch stuff.
12982						;
12983	.f968					callARGSV:                      ;fa18
12984	.f968	6c 14 02	jmp ($0214)	                jmp (ARGSV)

12986						;-------------------------------------------------------------------------
12987						;
12988						; OSFIND [AUG p342]
12989						;
12990	.f96b					osfindEntryPoint: .proc
12991	.f96b	09 00		ora #$00	                ora #$00        ;A=$00 if a file is to be closed
12992	.f96d	f0 05		beq $f974	                beq close       ;branch taken if closing a file
12993	.f96f	20 be f9	jsr $f9be	                jsr parseFileNameAndSelectFS       ;handle something other than a file close
12994	.f972	80 03		bra $f977	                bra callFINDV

12996	.f974					close:
12997	.f974	20 e7 f9	jsr $f9e7	                jsr selectFSForHandle
12998	.f977					callFINDV:
12999	.f977	6c 1c 02	jmp ($021c)	                jmp (FINDV)
13000						                .pend

13002						;-------------------------------------------------------------------------
13003						;
13004						; OSFILE [AUG p335]
13005						;
13006	.f97a					osfileEntryPoint:               ;fa2a
13007	.f97a	da		phx		                phx
13008	.f97b	5a		phy		                phy
13009	.f97c	48		pha		                pha
13010	.f97d	86 f2		stx $f2		                stx stringInputBufferAddress+0
13011	.f97f	84 f3		sty $f3		                sty stringInputBufferAddress+1
13012	.f981	a0 11		ldy #$11	                ldy #size(OSFILEParameterBlock)-1
13013	.f983					-
13014	.f983	b1 f2		lda ($f2),y	                lda (stringInputBufferAddress),y
13015	.f985	99 ed 02	sta $02ed,y	                sta osfileParameterBlock,y
13016	.f988	88		dey		                dey
13017	.f989	10 f8		bpl $f983	                bpl -
13018	.f98b	ae ed 02	ldx $02ed	                ldx osfileParameterBlock+OSFILEParameterBlock.fileName+0
13019	.f98e	ac ee 02	ldy $02ee	                ldy osfileParameterBlock+OSFILEParameterBlock.fileName+1
13020	.f991	20 be f9	jsr $f9be	                jsr parseFileNameAndSelectFS
13021	.f994	8e ed 02	stx $02ed	                stx osfileParameterBlock+OSFILEParameterBlock.fileName+0
13022	.f997	8c ee 02	sty $02ee	                sty osfileParameterBlock+OSFILEParameterBlock.fileName+1
13023	.f99a	68		pla		                pla
13024	.f99b	a2 ed		ldx #$ed	                ldx #<osfileParameterBlock
13025	.f99d	a0 02		ldy #$02	                ldy #>osfileParameterBlock
13026	.f99f	20 bb f9	jsr $f9bb	                jsr callFILEV
13027	.f9a2	7a		ply		                ply
13028	.f9a3	84 f3		sty $f3		                sty stringInputBufferAddress+1
13029	.f9a5	fa		plx		                plx
13030	.f9a6	86 f2		stx $f2		                stx stringInputBufferAddress+0
13031	.f9a8	48		pha		                pha
13032	.f9a9	a0 11		ldy #$11	                ldy #size(OSFILEParameterBlock)-1
13033	.f9ab					-
13034	.f9ab	b9 ed 02	lda $02ed,y	                lda osfileParameterBlock,y
13035	.f9ae	91 f2		sta ($f2),y	                sta (stringInputBufferAddress),y
13036	.f9b0	88		dey		                dey
13037	.f9b1	c0 02		cpy #$02	                cpy #$02                     ;don't overwrite file name
13038	.f9b3	b0 f6		bcs $f9ab	                bcs -
13039	.f9b5	68		pla		                pla
13040	.f9b6	a6 f2		ldx $f2		                ldx stringInputBufferAddress+0
13041	.f9b8	a4 f3		ldy $f3		                ldy stringInputBufferAddress+1
13042	.f9ba	60		rts		                rts

13044	.f9bb					callFILEV:
13045	.f9bb	6c 12 02	jmp ($0212)	                jmp (FILEV)

13047						;-------------------------------------------------------------------------
13048						;
13049						; Parse file name. Handle (and skip) any -FS- tempfs syntax, selecting
13050						; the FS specified if required.
13051						;
13052						; entry:
13053						;
13054						; Y (MSB)/X (LSB) = address of file name string
13055						;
13056						; exit:
13057						;
13058						; Y (MSB)/X (LSB) = address of file name part
13059						;
13060						; - New FS may have been selected
13061						;
13062	.f9be					parseFileNameAndSelectFS:
13063	.f9be	48		pha		                pha
13064	.f9bf	a5 f2		lda $f2		                lda stringInputBufferAddress+0
13065	.f9c1	48		pha		                pha
13066	.f9c2	a5 f3		lda $f3		                lda stringInputBufferAddress+1
13067	.f9c4	48		pha		                pha
13068	.f9c5	20 40 ee	jsr $ee40	                jsr selectHAZEL
13069	.f9c8	86 f2		stx $f2		                stx stringInputBufferAddress+0
13070	.f9ca	84 f3		sty $f3		                sty stringInputBufferAddress+1
13071	.f9cc	a0 00		ldy #$00	                ldy #$00
13072	.f9ce	20 f6 f9	jsr $f9f6	                jsr parseFileNameFS      ;find -FS- prefix, if any
13073	.f9d1	5a		phy		                phy                      ;save offset
13074	.f9d2	20 9d fa	jsr $fa9d	                jsr selectFS                 ;select desired FS
13075	.f9d5	68		pla		                pla
13076	.f9d6	18		clc		                clc
13077	.f9d7	65 f2		adc $f2		                adc stringInputBufferAddress+0
13078	.f9d9	aa		tax		                tax                          ;save string address LSB
13079	.f9da	a4 f3		ldy $f3		                ldy stringInputBufferAddress+1
13080	.f9dc	90 01		bcc $f9df	                bcc +
13081	.f9de	c8		iny		                iny
13082	.f9df					+
13083	.f9df	68		pla		                pla
13084	.f9e0	85 f3		sta $f3		                sta stringInputBufferAddress+1
13085	.f9e2	68		pla		                pla
13086	.f9e3	85 f2		sta $f2		                sta stringInputBufferAddress+0
13087	.f9e5	68		pla		                pla
13088	.f9e6	60		rts		                rts

13090						;-------------------------------------------------------------------------
13091						;
13092						; Select appropriate FS for the given file handle.
13093						;
13094						; entry:
13095						;
13096						; Y = file handle
13097						;
13098						; exit:
13099						;
13100						; - appropriate FS selected
13101						;
13102						; preserves: Y/X/A

13104	.f9e7					selectFSForHandle:
13105	.f9e7	da		phx		                phx
13106	.f9e8	48		pha		                pha
13107	.f9e9	20 40 ee	jsr $ee40	                jsr selectHAZEL
13108	.f9ec	20 73 fa	jsr $fa73	                jsr findFSForHandle
13109	.f9ef	8a		txa		                txa
13110	.f9f0	20 9d fa	jsr $fa9d	                jsr selectFS
13111	.f9f3	68		pla		                pla
13112	.f9f4	fa		plx		                plx
13113	.f9f5	60		rts		                rts

13115						;-------------------------------------------------------------------------
13116						;
13117						; Parse the FS part of a file name, if any, and return the filing
13118						; system to use.
13119						;
13120						; Entry:
13121						;
13122						; (stringInputBufferAddress),y = the string
13123						;
13124						; Exit:
13125						;
13126						; A = FS number to use
13127						;
13128						; (stringInputBufferAddress),y = next char after any tempfs prefix has
13129						; been consumed
13130	.f9f6					parseFileNameFS: .proc

13132	.f9f6	4e c6 df	lsr $dfc6	                lsr hazel.tempFSFlag
13133	.f9f9	20 ad f3	jsr $f3ad	                jsr skipSpacesAndCheckForCRInStringInput
13134	.f9fc	b1 f2		lda ($f2),y	                lda (stringInputBufferAddress),y
13135	.f9fe	c9 2d		cmp #$2d	                cmp #'-'
13136	.fa00	f0 0c		beq $fa0e	                beq parseFSNamePrefix ; branch taken if tempfs syntax
13137	.fa02	2c c6 df	bit $dfc6	                bit hazel.tempFSFlag
13138	.fa05	ad 00 df	lda $df00	                lda hazel.currentFS
13139	.fa08	50 03		bvc $fa0d	                bvc +
13140	.fa0a	ad 01 df	lda $df01	                lda hazel.activeFS
13141	.fa0d					+
13142	.fa0d	60		rts		                rts

13144	.fa0e					parseFSNamePrefix:
13145	.fa0e	c8		iny		                iny
13146	.fa0f	a2 00		ldx #$00	                ldx #$00
13147	.fa11					LFAC1:
13148	.fa11	bd 06 df	lda $df06,x	                lda hazel.fsInfoBlocks,x ;get FS name char
13149	.fa14	f0 44		beq $fa5a	                beq badFilingSystemName
13150	.fa16	8a		txa		                txa                      ;A=offset in info blocks
13151	.fa17	18		clc		                clc
13152	.fa18	69 08		adc #$08	                adc #size(fsInfoBlock.name)
13153	.fa1a	85 b0		sta $b0		                sta parseFileNameFSWorkspace.fsInfoOffset
13154	.fa1c	5a		phy		                phy
13155	.fa1d					compareFSNameLoop:
13156	.fa1d	b1 f2		lda ($f2),y	                lda (stringInputBufferAddress),y

13158						; validate FS name char. Must be letter or digit.

13160	.fa1f	20 9c eb	jsr $eb9c	                jsr isLetter
13161	.fa22	90 08		bcc $fa2c	                bcc validFSNameChar           ;branch taken if letter
13162	.fa24	c9 30		cmp #$30	                cmp #'0'
13163	.fa26	90 1b		bcc $fa43	                bcc notValidFSNameChar       ;branch taken if not digit
13164	.fa28	c9 3a		cmp #$3a	                cmp #'9'+1
13165	.fa2a	b0 17		bcs $fa43	                bcs notValidFSNameChar       ;branch taken if not digit
13166	.fa2c					validFSNameChar:
13167	.fa2c	e4 b0		cpx $b0		                cpx parseFileNameFSWorkspace.fsInfoOffset
13168	.fa2e	b0 0b		bcs $fa3b	                bcs nextFSInfoBlock ;branch taken if end of FS
13169						                                         ;info block name was reached
13170	.fa30	5d 06 df	eor $df06,x	                eor hazel.fsInfoBlocks,x
13171	.fa33	29 df		and #$df	                and #$DF                 ;Z=1 if char matches FS name
13172	.fa35	d0 04		bne $fa3b	                bne nextFSInfoBlock      ;branch taken if not a match
13173	.fa37	e8		inx		                inx                      ;next fs info block byte
13174	.fa38	c8		iny		                iny                      ;next input string byte
13175	.fa39	80 e2		bra $fa1d	                bra compareFSNameLoop

13177	.fa3b					nextFSInfoBlock:
13178	.fa3b	7a		ply		                ply
13179	.fa3c	a6 b0		ldx $b0		                ldx parseFileNameFSWorkspace.fsInfoOffset ;offset of end of name
13180	.fa3e	e8		inx		                inx
13181	.fa3f	e8		inx		                inx
13182	.fa40	e8		inx		                inx             ;advance to next entry
13183	.fa41	80 ce		bra $fa11	                bra LFAC1

13185	.fa43					notValidFSNameChar:

13187						; Matching FS name must be terminated with -. Otherwise, it's bad
13188						; syntax, or perhaps an overly long name.

13190	.fa43	c9 2d		cmp #$2d	                cmp #'-'
13191	.fa45	d0 13		bne $fa5a	                bne badFilingSystemName
13192	.fa47	c8		iny		                iny                       ;consume input '-'
13193	.fa48	e4 b0		cpx $b0		                cpx parseFileNameFSWorkspace.fsInfoOffset
13194	.fa4a	f0 07		beq $fa53	                beq foundFSInfoBlock     ;branch taken if a match due
13195						                                         ;to being right at end of the
13196						                                         ;FS info block name
13197	.fa4c	bd 06 df	lda $df06,x	                lda hazel.fsInfoBlocks,x ;
13198	.fa4f	c9 20		cmp #$20	                cmp #' '
13199	.fa51	d0 e8		bne $fa3b	                bne nextFSInfoBlock      ;branch taken if not a match
13200						                                         ;as tthe supplied name was a
13201						                                         ;prefix of this FS's name
13202	.fa53					foundFSInfoBlock:
13203	.fa53	68		pla		                pla
13204	.fa54	a6 b0		ldx $b0		                ldx parseFileNameFSWorkspace.fsInfoOffset
13205	.fa56	bd 08 df	lda $df08,x	                lda hazel.fsInfoBlocks+(fsInfoBlock.fsNumber-(fsInfoBlock.name+size(fsInfoBlock.name))),x
13206	.fa59	60		rts		                rts

13208	.fa5a					badFilingSystemName:
13209	.fa5a	00		brk #		                brk
13210	>fa5b	f8 42 61 64 20 66 69 6c		                .text $f8,'Bad filing system name',0
	>fa63	69 6e 67 20 73 79 73 74 65 6d 20 6e 61 6d 65 00
13211						                .pend

13213						;-------------------------------------------------------------------------
13214						;
13215						; Find FS for the given handle
13216						;
13217						; entry:
13218						;
13219						; Y = file handle
13220						;
13221						; exit:
13222						;
13223						; X = FS number - will just use current FS if none suitable found
13224						;
13225	.fa73					findFSForHandle: .proc
13226	.fa73	48		pha		                pha                          ;
13227	.fa74	5a		phy		                phy                          ;
13228	.fa75	98		tya		                tya                          ;A = handle to search for
13229	.fa76	a0 00		ldy #$00	                ldy #$00                     ;
13230	.fa78					loop:
13231	.fa78	be 06 df	ldx $df06,y	                ldx hazel.fsInfoBlocks.name+0,y
13232	.fa7b	f0 15		beq $fa92	                beq notFound                  ;taken if terminating entry
13233	.fa7d	d9 0e df	cmp $df0e,y	                cmp hazel.fsInfoBlocks.minHandle,y
13234	.fa80	90 07		bcc $fa89	                bcc next                     ;taken if not this FS
13235	.fa82	d9 0f df	cmp $df0f,y	                cmp hazel.fsInfoBlocks.maxHandle,y
13236	.fa85	90 10		bcc $fa97	                bcc found                    ;taken if this FS
13237	.fa87	f0 0e		beq $fa97	                beq found                    ;taken if this FS

13239	.fa89					next:
13240	.fa89	48		pha		                pha
13241	.fa8a	98		tya		                tya
13242	.fa8b	18		clc		                clc
13243	.fa8c	69 0b		adc #$0b	                adc #size(fsInfoBlock)
13244	.fa8e	a8		tay		                tay
13245	.fa8f	68		pla		                pla
13246	.fa90	80 e6		bra $fa78	                bra loop

13248	.fa92					notFound:
13249	.fa92	ae 00 df	ldx $df00	                ldx hazel.currentFS
13250	.fa95	80 03		bra $fa9a	                bra done

13252	.fa97					found:
13253	.fa97	be 10 df	ldx $df10,y	                ldx hazel.fsInfoBlocks.fsNumber,y
13254	.fa9a					done:
13255	.fa9a	7a		ply		                ply
13256	.fa9b	68		pla		                pla
13257	.fa9c	60		rts		                rts
13258						                .endproc

13260						;-------------------------------------------------------------------------
13261						;
13262						; Select filing system in A.
13263						;
13264						; Entry:
13265						;
13266						; A = FS number
13267						;
13268	.fa9d					selectFS:                               ;fb4d
13269	.fa9d	cd 01 df	cmp $df01	                cmp hazel.activeFS      ; Check active fs
13270	.faa0	f0 16		beq $fab8	                beq rtsFB68               ; Already active fs, return
13271	.faa2	5a		phy		                phy
13272	.faa3	da		phx		                phx
13273	.faa4	a8		tay		                tay
13274	.faa5	3a		dec a		                dec a
13275	.faa6	d0 07		bne $faaf	                bne LFB5F       ;taken if not FS 1 (tape)

13277						; ??? - only if trying to select tape FS

13279	.faa8	a9 04		lda #$04	                lda #$04
13280	.faaa	24 e2		bit $e2		                bit $E2
13281	.faac	d0 01		bne $faaf	                bne LFB5F
13282	.faae	c8		iny		                iny
13283	.faaf					LFB5F:
13284	.faaf	5a		phy		                phy
13285	.fab0	a2 12		ldx #$12	                ldx #romServiceCallInitialiseFilingSystem
13286	.fab2	20 f8 ee	jsr $eef8	                jsr makeROMServiceCall
13287	.fab5	68		pla		                pla
13288	.fab6	fa		plx		                plx
13289	.fab7	7a		ply		                ply
13290	.fab8					rtsFB68:
13291	.fab8	60		rts		                rts

13293						;-------------------------------------------------------------------------
13294						;
13295						; FileSwitch FSC
13296						; ==============
13297						;
13298	.fab9					fileswitchFSCEntryPoint:
13299	.fab9	48		pha		                pha                          ;save request type
13300	.faba	20 40 ee	jsr $ee40	                jsr selectHAZEL
13301	.fabd	4e c6 df	lsr $dfc6	                lsr hazel.tempFSFlag
13302	.fac0	68		pla		                pla                          ;restore request type
13303	.fac1	48		pha		                pha                          ;save request type
13304	.fac2	da		phx		                phx                          ;save request X
13305	.fac3	0a		asl a		                asl a
13306	.fac4	aa		tax		                tax
13307	.fac5	c9 17		cmp #$17	                cmp #11*2+1
13308	.fac7	b0 03		bcs $facc	                bcs fileswitchPassFSCToCurrentFS ;taken if out of range
13309	.fac9	7c d1 fa	jmp ($fad1,x)	                jmp (fileswitchFSCRoutinesTable,x)

13311						;-------------------------------------------------------------------------
13312						;
13313						; Pass to filing system's FSC
13314						;
13315						; There's 2 entry points - fileswitchPassFSCToCurrentFS, for
13316						; when X and A are both on the stack, and
13317						; fileswitchPassFSCToCurrentFS_X, for when only A is on the
13318						; stack.
13319						;
13320	.facc					fileswitchPassFSCToCurrentFS:
13321	.facc					fileswitchFSCNewFS:
13322	.facc					fileswitchFSCFileHandleRange:
13323	.facc					fileswitchFSCStarCommand:
13324	.facc	fa		plx		                plx                          ;restore request X
13325	.facd					fileswitchPassFSCToCurrentFS_X:
13326	.facd	68		pla		                pla                          ;restore request type
13327	.face	6c da df	jmp ($dfda)	                jmp (hazel.activeFSCV) ;call active FS's real FSCV entry point

13329						;-------------------------------------------------------------------------
13330						;
13331						; FileSwitch FSC table
13332						;
13333	.fad1					fileswitchFSCRoutinesTable:
13334	>fad1	f6 fa				                .word fileswitchFSCOPT
13335	>fad3	ef fa				                .word fileswitchFSCCheckEOF
13336	>fad5	03 fb				                .word fileswitchFSCStarSlash
13337	>fad7	e9 fa				                .word fileswitchFSCUnknownCommand
13338	>fad9	03 fb				                .word fileswitchFSCStarRUN
13339	>fadb	08 fb				                .word fileswitchFSCStarCAT
13340	>fadd	cc fa				                .word fileswitchFSCNewFS
13341	>fadf	cc fa				                .word fileswitchFSCFileHandleRange
13342	>fae1	cc fa				                .word fileswitchFSCStarCommand
13343	>fae3	08 fb				                .word fileswitchFSCStarEX
13344	>fae5	08 fb				                .word fileswitchFSCStarINFO
13345	>fae7	38 fb				                .word fileswitchFSCRUNLibrary

13347						;-------------------------------------------------------------------------
13348						;
13349						; FSC 3 - *command [AUG p344]
13350						;
13351	.fae9					fileswitchFSCUnknownCommand:
13352	.fae9	fa		plx		                plx
13353	.faea	20 11 fb	jsr $fb11	                jsr getCommandLinePointer
13354	.faed	80 de		bra $facd	                bra fileswitchPassFSCToCurrentFS_X

13356						;-------------------------------------------------------------------------
13357						;
13358						; FSC 1 - check EOF [AUG p343]
13359						;
13360	.faef					fileswitchFSCCheckEOF:
13361	.faef	7a		ply		                ply                         ;Y = file handle
13362	.faf0	5a		phy		                phy                         ;restore stack arrangement
13363	.faf1	20 e7 f9	jsr $f9e7	                jsr selectFSForHandle
13364	.faf4	80 d6		bra $facc	                bra fileswitchPassFSCToCurrentFS

13366						;-------------------------------------------------------------------------
13367						;
13368						; FSC 0 - *OPT [AUG p343]
13369						;
13370	.faf6					fileswitchFSCOPT:
13371	.faf6	2c c6 df	bit $dfc6	                bit hazel.tempFSFlag   ; Check temporary fs flag
13372	.faf9	70 d1		bvs $facc	                bvs fileswitchPassFSCToCurrentFS
13373	.fafb	ad 00 df	lda $df00	                lda hazel.currentFS ; Get current filing system number

13375						;-------------------------------------------------------------------------
13376						;
13377						; Pass FSCV request through to a particular FS.
13378						;
13379						; entry:
13380						;
13381						; A = FS to select
13382						;
13383						; Y = FSCV Y
13384						;
13385						; S = [FSCV X; FSCV A]
13386						;
13387	.fafe					fileswitchPassFSCToSpecificFS:
13388	.fafe	20 9d fa	jsr $fa9d	                jsr selectFS        ; Select filing system
13389	.fb01	80 c9		bra $facc	                bra fileswitchPassFSCToCurrentFS

13391						;-------------------------------------------------------------------------
13392						;
13393						; FSC 2 - */filename [AUG p343]
13394						; FSC 4 - *RUN filename [AUG p344]
13395						;
13396	.fb03					fileswitchFSCStarSlash:
13397	.fb03					fileswitchFSCStarRUN:
13398	.fb03	fa		plx		                plx
13399	.fb04	20 11 fb	jsr $fb11	                jsr getCommandLinePointer ; Skip '*'s and spaces, set command line address
13400	.fb07	da		phx		                phx             ; Continue on to pass to filing system


13403						;-------------------------------------------------------------------------
13404						;
13405						; FSC 5 - *CAT [AUG p344]
13406						; FSC 9 - *EX [NAUG p257]
13407						; FSC, 10 - *INFO [NAUG p257]
13408						;
13409	.fb08					fileswitchFSCStarCAT:
13410	.fb08					fileswitchFSCStarEX:
13411	.fb08					fileswitchFSCStarINFO:
13412	.fb08	fa		plx		                plx
13413	.fb09	0e c6 df	asl $dfc6	                asl hazel.tempFSFlag
13414	.fb0c	20 be f9	jsr $f9be	                jsr parseFileNameAndSelectFS
13415	.fb0f	80 bc		bra $facd	                bra fileswitchPassFSCToCurrentFS_X

13417						;-------------------------------------------------------------------------
13418						;
13419						; Get command line pointer.
13420						;
13421						; Entry:
13422						;
13423						; X/Y - pointer to CR-terminated command line string
13424						;
13425						; Exit:
13426						;
13427						; X/Y, (hazel.commandLinePointer) - pointer to first non-space char in
13428						; command line string
13429	.fb11					getCommandLinePointer: .proc ;fbc1
13430	.fb11	86 f2		stx $f2		                stx stringInputBufferAddress+0
13431	.fb13	84 f3		sty $f3		                sty stringInputBufferAddress+1

13433						; skip spaces. Stop if terminating CR encountered.

13435	.fb15	a0 ff		ldy #$ff	                ldy #$FF
13436	.fb17					-
13437	.fb17	c8		iny		                iny
13438	.fb18	b1 f2		lda ($f2),y	                lda (stringInputBufferAddress),y
13439	.fb1a	c9 0d		cmp #$0d	                cmp #$0D
13440	.fb1c	f0 04		beq $fb22	                beq +
13441	.fb1e	c9 20		cmp #$20	                cmp #' '
13442	.fb20	d0 f5		bne $fb17	                bne -

13444	.fb22					+

13446						; Hmm. Didn't we just do this bit already?

13448	.fb22	20 ad f3	jsr $f3ad	                jsr skipSpacesAndCheckForCRInStringInput

13450						; Store address of first non-space char in the HAZEL command line
13451						; pointer.

13453	.fb25	98		tya		                tya
13454	.fb26	18		clc		                clc
13455	.fb27	65 f2		adc $f2		                adc stringInputBufferAddress+0
13456	.fb29	8d 04 df	sta $df04	                sta hazel.commandLinePointer+0
13457	.fb2c	a5 f3		lda $f3		                lda stringInputBufferAddress+1
13458	.fb2e	69 00		adc #$00	                adc #$00
13459	.fb30	8d 05 df	sta $df05	                sta hazel.commandLinePointer+1
13460	.fb33	a4 f3		ldy $f3		                ldy stringInputBufferAddress+1
13461	.fb35	a6 f2		ldx $f2		                ldx stringInputBufferAddress+0
13462	.fb37	60		rts		                rts
13463						                .pend

13465						;-------------------------------------------------------------------------
13466						;
13467						; FSC 11 - RUN from libfs [NAUG p257]
13468						;
13469	.fb38					fileswitchFSCRUNLibrary:
13470	.fb38	ad 02 df	lda $df02	                lda hazel.libFS      ; Is a libfs set?
13471	.fb3b	10 c1		bpl $fafe	                bpl fileswitchPassFSCToSpecificFS
13472	.fb3d					badCommandError:
13473	.fb3d	00		brk #		                brk
13474	>fb3e	fe				                .byte 254
13475	>fb3f	42 61 64 20 63 6f 6d 6d		                .text "Bad command"
	>fb47	61 6e 64
13476	.fb4a	00		brk #		                brk

13478						;-------------------------------------------------------------------------

13480						                .if version==350
13708						                .endif

13710						;-------------------------------------------------------------------------

13712						                .if version==350&&multios
13715						                .endif

13717						;-------------------------------------------------------------------------

13719	>fb4b	ff ff ff ff ff ff ff ff		                .fill $fc00-*,$ff
	>fb53	ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff
	>fb63	ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff
	>fb73	ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff
	>fb83	ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff
	>fb93	ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff
	>fba3	ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff
	>fbb3	ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff
	>fbc3	ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff
	>fbd3	ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff
	>fbe3	ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff
	>fbf3	ff ff ff ff ff ff ff ff ff ff ff ff ff

13721						                .if version==350
13750						                .else

13752						;-------------------------------------------------------------------------
13753						;
13754						; Credits - normally hidden by the I/O region.
13755						;

13757						                .if version<500
13760						                .elsif version>=500
13761						                .if olivetti
13763						                .else
13764	>fc00	28 43 29 20 31 39 38 36		                .text "(C) 1986 Acorn Computers Ltd."
	>fc08	20 41 63 6f 72 6e 20 43 6f 6d 70 75 74 65 72 73
	>fc18	20 4c 74 64 2e
13765						                .endif
13766	>fc1d	54 68 61 6e 6b 73 20 61		                .text "Thanks are due to the following contributors to this Computer (among many others):- "
	>fc25	72 65 20 64 75 65 20 74 6f 20 74 68 65 20 66 6f
	>fc35	6c 6c 6f 77 69 6e 67 20 63 6f 6e 74 72 69 62 75
	>fc45	74 6f 72 73 20 74 6f 20 74 68 69 73 20 43 6f 6d
	>fc55	70 75 74 65 72 20 28 61 6d 6f 6e 67 20 6d 61 6e
	>fc65	79 20 6f 74 68 65 72 73 29 3a 2d 20
13767						                .endif
13768	>fc71	44 61 76 69 64 20 41 6c		                .text "David Allen,"
	>fc79	6c 65 6e 2c
13769						                .if version<500
13771						                .endif
13772	>fc7d	44 61 76 69 64 20 42 65		                .text "David Bell,"
	>fc85	6c 6c 2c
13773	>fc88	50 61 75 6c 20 42 6f 6e		                .text "Paul Bond,"
	>fc90	64 2c
13774						                .if version<500
13776						                .endif
13777	>fc92	4a 75 6c 69 61 6e 20 42		                .text "Julian Brown,"
	>fc9a	72 6f 77 6e 2c
13778	>fc9f	54 75 64 6f 72 20 42 72		                .text "Tudor Brown,"
	>fca7	6f 77 6e 2c
13779						                .if version>=500
13780	>fcab	54 69 6d 20 43 61 73 70		                .text "Tim Caspell,"
	>fcb3	65 6c 6c 2c
13781						                .endif
13782	>fcb7	42 72 69 61 6e 20 43 6f		                .text "Brian Cockburn,"
	>fcbf	63 6b 62 75 72 6e 2c
13783						                .if version>=500
13784	>fcc6	42 61 72 62 61 72 61 20		                .text "Barbara Cole,"
	>fcce	43 6f 6c 65 2c
13785						                .endif
13786						                .if version<500
13788						                .endif
13789	>fcd3	4d 61 72 6b 20 43 6f 6c		                .text "Mark Colton,"
	>fcdb	74 6f 6e 2c
13790	>fcdf	43 68 72 69 73 20 43 75		                .text "Chris Curry,"
	>fce7	72 72 79 2c
13791						                .if version>=500
13792	>fceb	4a 69 6d 20 44 61 79 2c		                .text "Jim Day,"
13793	>fcf3	54 69 6d 20 44 6f 62 73		                .text "Tim Dobson,"
	>fcfb	6f 6e 2c
13794						                .endif
13795	>fcfe	4a 6f 65 20 44 75 6e 6e		                .text "Joe Dunn,"
	>fd06	2c
13796						                .if version==400
13798						                .endif
13799						                .if version<500
13801						                .endif
13802						                .if version>=500
13803	>fd07	50 61 75 6c 20 46 65 6c		                .text "Paul Fellows,"
	>fd0f	6c 6f 77 73 2c
13804	>fd14	41 6c 61 6e 20 46 6f 75		                .text "Alan Fournier,"
	>fd1c	72 6e 69 65 72 2c
13805						                .endif
13806	>fd22	53 74 65 76 65 20 46 75		                .text "Steve Furber,"
	>fd2a	72 62 65 72 2c
13807	>fd2f	4d 61 72 74 79 6e 20 47		                .text "Martyn Gilbert,"
	>fd37	69 6c 62 65 72 74 2c
13808	>fd3e	4a 6f 68 6e 20 48 61 72		                .text "John Harrison,"
	>fd46	72 69 73 6f 6e 2c
13809	>fd4c	48 65 72 6d 61 6e 6e 20		                .text "Hermann Hauser,"
	>fd54	48 61 75 73 65 72 2c
13810						                .if version!=400
13811	>fd5b	4d 69 6b 65 20 48 69 6c		                .text "Mike Hill,"
	>fd63	6c 2c
13812						                .endif
13813						                .if version>=500
13814	>fd65	50 61 75 6c 20 48 6f 6c		                .text "Paul Holding,"
	>fd6d	64 69 6e 67 2c
13815						                .endif
13816	>fd72	4a 6f 68 6e 20 48 6f 72		                .text "John Horton,"
	>fd7a	74 6f 6e 2c
13817						                .if version==400
13819						                .endif
13820						                .if version>=500
13821	>fd7e	44 61 76 65 20 49 72 65		                .text "Dave Ireland,"
	>fd86	6c 61 6e 64 2c
13822						                .endif
13823						                .if version<500
13825						                .endif
13826	>fd8b	52 69 63 68 61 72 64 20		                .text "Richard King,"
	>fd93	4b 69 6e 67 2c
13827	>fd98	44 61 76 69 64 20 4b 69		                .text "David Kitson,"
	>fda0	74 73 6f 6e 2c
13828						                .if version>=500
13829	>fda5	41 6e 64 79 20 4b 6e 69		                .text "Andy Knight,"
	>fdad	67 68 74 2c
13830						                .endif
13831	>fdb1	4a 75 6c 69 61 6e 20 4c		                .text "Julian Lomberg,"
	>fdb9	6f 6d 62 65 72 67 2c
13832	>fdc0	52 6f 62 20 4d 61 63 6d		                .text "Rob Macmillan,"
	>fdc8	69 6c 6c 61 6e 2c
13833						                .if version>=500
13834	>fdce	54 6f 6d 20 4d 63 4e 61		                .text "Tom McNamara,"
	>fdd6	6d 61 72 61 2c
13835						                .endif
13836	>fddb	52 69 63 68 61 72 64 20		                .text "Richard Manby,"
	>fde3	4d 61 6e 62 79 2c
13837						                .if version<500
13846						                .endif
13847						                .if version>=500
13848	>fde9	44 61 76 69 64 20 4d 6f		                .text "David Morgan,"
	>fdf1	72 67 61 6e 2c
13849	>fdf6	52 69 63 68 61 72 64 20		                .text "Richard Murphy,"
	>fdfe	4d 75 72 70 68 79 2c
13850						                .endif
13851	>fe05	47 6c 65 6e 20 4e 69 63		                .text "Glen Nicholls,"
	>fe0d	68 6f 6c 6c 73 2c
13852	>fe13	52 6f 62 65 72 74 20 4e		                .text "Robert Nokes,"
	>fe1b	6f 6b 65 73 2c
13853						                .if version>=500
13854	>fe20	4a 65 61 6e 20 4e 75 6e		                .text "Jean Nunn,"
	>fe28	6e 2c
13855						                .endif
13856	>fe2a	52 69 63 68 61 72 64 20		                .text "Richard Page,"
	>fe32	50 61 67 65 2c
13857						                .if version<400
13859						                .endif
13860						                .if version<=400
13862						                .endif
13863	>fe37	4a 6f 68 6e 20 52 61 64		                .text "John Radcliffe,"
	>fe3f	63 6c 69 66 66 65 2c
13864	>fe46	52 69 63 6b 20 52 61 6e		                .text "Rick Rand,"
	>fe4e	64 2c
13865						                .if version>=400
13866	>fe50	4e 69 63 6b 20 52 65 65		                .text "Nick Reeves,"
	>fe58	76 65 73 2c
13867						                .endif
13868	>fe5c	42 72 69 61 6e 20 52 6f		                .text "Brian Robertson,"
	>fe64	62 65 72 74 73 6f 6e 2c
13869						                .if version>=500
13870	>fe6c	50 61 75 6c 20 52 6f 73		                .text "Paul Rose,"
	>fe74	65 2c
13871						                .endif
13872	>fe76	52 69 63 68 61 72 64 20		                .text "Richard Russell,"
	>fe7e	52 75 73 73 65 6c 6c 2c
13873						                .if version<500
13876						                .endif
13877						                .if version>=500
13878	>fe86	52 6f 62 65 72 74 20 53		                .text "Robert Sack,"
	>fe8e	61 63 6b 2c
13879	>fe92	52 6f 67 65 72 20 53 61		                .text "Roger Sale,"
	>fe9a	6c 65 2c
13880						                .endif
13881	>fe9d	44 61 76 69 64 20 53 65		                .text "David Seal,"
	>fea5	61 6c 2c
13882						                .if version>=500
13883	>fea8	50 68 69 6c 20 53 6d 69		                .text "Phil Smith,"
	>feb0	74 68 2c
13884	>feb3	54 6f 6e 79 20 53 75 6d		                .text "Tony Sumner,"
	>febb	6e 65 72 2c
13885						                .endif
13886						                .if version!=400
13887	>febf	50 61 75 6c 20 53 77 69		                .text "Paul Swindell,"
	>fec7	6e 64 65 6c 6c 2c
13888						                .endif
13889	>fecd	4a 6f 6e 20 54 68 61 63		                .text "Jon Thackray,"
	>fed5	6b 72 61 79 2c
13890						                .if version>=500
13891	>feda	54 6f 6e 79 20 54 68 6f		                .text "Tony Thompson,"
	>fee2	6d 70 73 6f 6e 2c
13892						                .endif
13893	>fee8	48 75 67 6f 20 54 79 73		                .text "Hugo Tyson,"
	>fef0	6f 6e 2c
13894						                .if version<500
13901						                .endif
13902						                .if version<500
13906						                .endif
13907						                .if version>=500
13908	>fef3	52 6f 67 65 72 20 57 69		                .text "Roger Wilson."
	>fefb	6c 73 6f 6e 2e
13909						                .endif
13910						                .if version!=400
13911						                .if olivetti
13913						                .else
13915						                .endif
13918						                .endif

13920						;-------------------------------------------------------------------------

13922						                .endif

13924						;-------------------------------------------------------------------------

13926	.ff00					E_USERV: ; ff00
13927	.ff00	20 51 ff	jsr $ff51	                jsr extendedVectorEntryPoint
13928	.ff03					E_BRKV: ; ff03
13929	.ff03	20 51 ff	jsr $ff51	                jsr extendedVectorEntryPoint
13930	.ff06					E_IRQ1V: ; ff06
13931	.ff06	20 51 ff	jsr $ff51	                jsr extendedVectorEntryPoint
13932	.ff09					E_IRQ2V: ; ff09
13933	.ff09	20 51 ff	jsr $ff51	                jsr extendedVectorEntryPoint
13934	.ff0c					E_CLIV: ; ff0c
13935	.ff0c	20 51 ff	jsr $ff51	                jsr extendedVectorEntryPoint
13936	.ff0f					E_BYTEV: ; ff0f
13937	.ff0f	20 51 ff	jsr $ff51	                jsr extendedVectorEntryPoint
13938	.ff12					E_WORDV: ; ff12
13939	.ff12	20 51 ff	jsr $ff51	                jsr extendedVectorEntryPoint
13940	.ff15					E_WRCHV: ; ff15
13941	.ff15	20 51 ff	jsr $ff51	                jsr extendedVectorEntryPoint
13942	.ff18					E_RDCHV: ; ff18
13943	.ff18	20 51 ff	jsr $ff51	                jsr extendedVectorEntryPoint
13944	.ff1b					E_FILEV: ; ff1b
13945	.ff1b	20 51 ff	jsr $ff51	                jsr extendedVectorEntryPoint
13946	.ff1e					E_ARGSV: ; ff1e
13947	.ff1e	20 51 ff	jsr $ff51	                jsr extendedVectorEntryPoint
13948	.ff21					E_BGETV: ; ff21
13949	.ff21	20 51 ff	jsr $ff51	                jsr extendedVectorEntryPoint
13950	.ff24					E_BPUTV: ; ff24
13951	.ff24	20 51 ff	jsr $ff51	                jsr extendedVectorEntryPoint
13952	.ff27					E_GBPBV: ; ff27
13953	.ff27	20 51 ff	jsr $ff51	                jsr extendedVectorEntryPoint
13954	.ff2a					E_FINDV: ; ff2a
13955	.ff2a	20 51 ff	jsr $ff51	                jsr extendedVectorEntryPoint
13956	.ff2d					E_FSCV: ; ff2d
13957	.ff2d	20 51 ff	jsr $ff51	                jsr extendedVectorEntryPoint
13958	.ff30					E_EVENTV: ; ff30
13959	.ff30	20 51 ff	jsr $ff51	                jsr extendedVectorEntryPoint
13960	.ff33					E_UPTV: ; ff33
13961	.ff33	20 51 ff	jsr $ff51	                jsr extendedVectorEntryPoint
13962	.ff36					E_NETV: ; ff36
13963	.ff36	20 51 ff	jsr $ff51	                jsr extendedVectorEntryPoint
13964	.ff39					E_VDUV: ; ff39
13965	.ff39	20 51 ff	jsr $ff51	                jsr extendedVectorEntryPoint
13966	.ff3c					E_KEYV: ; ff3c
13967	.ff3c	20 51 ff	jsr $ff51	                jsr extendedVectorEntryPoint
13968	.ff3f					E_INSV: ; ff3f
13969	.ff3f	20 51 ff	jsr $ff51	                jsr extendedVectorEntryPoint
13970	.ff42					E_REMV: ; ff42
13971	.ff42	20 51 ff	jsr $ff51	                jsr extendedVectorEntryPoint
13972	.ff45					E_CNPV: ; ff45
13973	.ff45	20 51 ff	jsr $ff51	                jsr extendedVectorEntryPoint
13974	.ff48					E_IND1V: ; ff48
13975	.ff48	20 51 ff	jsr $ff51	                jsr extendedVectorEntryPoint
13976	.ff4b					E_IND2V: ; ff4b
13977	.ff4b	20 51 ff	jsr $ff51	                jsr extendedVectorEntryPoint
13978	.ff4e					E_IND3V: ; ff4e
13979	.ff4e	20 51 ff	jsr $ff51	                jsr extendedVectorEntryPoint

13981						;-------------------------------------------------------------------------

13983	.ff51					extendedVectorEntryPoint:
13984						                ; .if CFA3000
13985						                ; ;...
13986						                ; .else
13987						                ; $10b,x = rL
13988	.ff51	48		pha		                pha                 ; $10a,x  (old ROMSEL)
13989	.ff52	48		pha		                pha                 ; $109,x  (old ACCCON)
13990	.ff53	48		pha		                pha                 ; $108,x  (thunk rH)
13991	.ff54	48		pha		                pha                 ; $107,x  (thunk rL)
13992	.ff55	48		pha		                pha                 ; $106,x  (jump dest MSB)
13993	.ff56	48		pha		                pha                 ; $105,x  (jump dest LSB)
13994	.ff57	08		php		                php                 ; $104,x  (P for RTI)
13995	.ff58	48		pha		                pha                 ; $103,x  (old A)
13996	.ff59	da		phx		                phx                 ; $102,x  (old X)
13997	.ff5a	5a		phy		                phy                 ; $101,x  (old Y)
13998	.ff5b	ba		tsx		                tsx
13999	.ff5c	a9 ff		lda #$ff	                lda #>extendedVectorReturnThunk-1
14000	.ff5e	9d 08 01	sta $0108,x	                sta $0108,x
14001	.ff61	a9 8c		lda #$8c	                lda #<extendedVectorReturnThunk-1
14002	.ff63	9d 07 01	sta $0107,x	                sta $0107,x

14004						                ; this routine is only ever called from $ff00, $ff03,
14005						                ; $ff06, etc. - so rL holds vectorIndex*3+2, suitable
14006						                ; for indexing into the extended vector space.
14007	.ff66	bc 0b 01	ldy $010b,x	                ldy $010B,x                  ;Y=vectorIndex*3+2
14008	.ff69	b9 9d 0d	lda $0d9d,y	                lda extendedVectorSpace-2,y  ;get vector LSB
14009	.ff6c	9d 05 01	sta $0105,x	                sta $0105,x                  ;
14010	.ff6f	b9 9e 0d	lda $0d9e,y	                lda extendedVectorSpace-1,y  ;get vector MSB
14011	.ff72	9d 06 01	sta $0106,x	                sta $0106,x
14012	.ff75	a5 f4		lda $f4		                lda $F4
14013	.ff77	9d 0a 01	sta $010a,x	                sta $010A,x
14014	.ff7a	ad 34 fe	lda $fe34	                lda ACCCON
14015	.ff7d	9d 09 01	sta $0109,x	                sta $0109,x

14017						                ; New stack layout:
14018						                ;
14019						                ; $10a,x - old ROMSEL
14020						                ; $109,x - old ACCCON
14021						                ; $108,x - thunk rH
14022						                ; $107,x - thunk rL
14023						                ; $106,x - jump dest MSB
14024						                ; $105,x - jump dest LSB
14025						                ; $104,x - P (for RTI)
14026						                ; $103,x - old A
14027						                ; $102,x - old X
14028						                ; $101,x - old Y

14030	.ff80	20 40 ee	jsr $ee40	                jsr mos.selectHAZEL
14031	.ff83	b9 9f 0d	lda $0d9f,y	                lda extendedVectorSpace,y    ;get vector ROM number
14032	.ff86	20 ab e5	jsr $e5ab	                jsr mos.selectROMA
14033	.ff89	7a		ply		                ply
14034	.ff8a	fa		plx		                plx
14035	.ff8b	68		pla		                pla
14036	.ff8c	40		rti		                rti
14037						;                .endif

14039						;-------------------------------------------------------------------------

14041	.ff8d					extendedVectorReturnThunk:
14042	.ff8d	08		php		                php
14043	.ff8e	48		pha		                pha
14044	.ff8f	da		phx		                phx
14045	.ff90	ba		tsx		                tsx
14046	.ff91	bd 02 01	lda $0102,x	                lda $0102,x
14047	.ff94	9d 06 01	sta $0106,x	                sta $0106,x
14048	.ff97	bd 03 01	lda $0103,x	                lda $0103,x
14049	.ff9a	9d 07 01	sta $0107,x	                sta $0107,x
14050	.ff9d	fa		plx		                plx
14051	.ff9e	68		pla		                pla
14052	.ff9f	68		pla		                pla
14053	.ffa0	68		pla		                pla
14054	.ffa1	20 36 ee	jsr $ee36	                jsr mos.selectMOSOrHAZEL
14055	.ffa4	68		pla		                pla
14056	.ffa5	20 ab e5	jsr $e5ab	                jsr mos.selectROMA
14057	.ffa8	68		pla		                pla
14058	.ffa9	28		plp		                plp
14059	.ffaa					rtsFFAA:
14060	.ffaa	60		rts		                rts

14062						;-------------------------------------------------------------------------
14063						;
14064						; OSBYTE 150 (&96) Read from SHEILA (&FE00 <80><93> &FEFF) [MasRef D.2-45]
14065						;
14066	.ffab					osbyte96:
14067	.ffab	bc 00 fe	ldy $fe00,x	                ldy $fe00,x
14068	.ffae	60		rts		                rts

14070						;-------------------------------------------------------------------------
14071						;
14072						; OSBYTE 157 (&9D) Write byte across Tube [MasRef D.2-48]
14073						;
14074	.ffaf					osbyte9D:
14075	.ffaf	8a		txa		                txa
14076	.ffb0	80 22		bra $ffd4	                bra OSBPUT

14078	.ffb2	00		brk #		                brk

14080						;-------------------------------------------------------------------------

14082						; MOS block ends here, so that the standard entry points have
14083						; unadorned names.
14084						;
14085						; A couple of the E_ entry points need namespacing in the Terminal
14086						; ROM.
14087						                .endblock


14090						;-------------------------------------------------------------------------
14091	.ffb3					OSWRSC:
14092	.ffb3	4c ce f4	jmp $f4ce	                jmp mos.oswrscEntryPoint ; FFB3
14093	>ffb6	36				                .byte mos.defaultVectorTable.end-mos.defaultVectorTable ;
14094	>ffb7	f9 e2				                .word mos.defaultVectorTable ;
14095	.ffb9					OSRDSC:
14096	.ffb9	4c c8 f4	jmp $f4c8	                jmp mos.osrdscEntryPoint ; FFB9
14097	.ffbc					VDUCHR:
14098	.ffbc	4c b8 f4	jmp $f4b8	                jmp mos.vduChrEntryPoint ; FFBC
14099	.ffbf					OSEVEN:
14100	.ffbf	4c 53 eb	jmp $eb53	                jmp mos.eventEntryPoint ; FFBF
14101	.ffc2					GSINIT:
14102	.ffc2	4c 1c f3	jmp $f31c	                jmp mos.gsinitEntryPoint ; FFC2
14103	.ffc5					GSREAD:
14104	.ffc5	4c 2d f3	jmp $f32d	                jmp mos.gsreadEntryPoint ; FFC5
14105	.ffc8					NVRDCH:
14106	.ffc8	4c ec e8	jmp $e8ec	                jmp mos.osrdchEntryPoint                    ; FFC8
14107	.ffcb					NVWRCH:
14108	.ffcb	4c 4d e9	jmp $e94d	                jmp mos.oswrchEntryPoint                    ; FFCB
14109	.ffce					OSFIND:
14110	.ffce	4c 6b f9	jmp $f96b	                jmp mos.osfindEntryPoint                    ; FFCE
14111	.ffd1					OSGBPB:
14112	.ffd1	4c 0e f9	jmp $f90e	                jmp mos.osgbpbEntryPoint                    ; FFD1
14113	.ffd4					OSBPUT:
14114	.ffd4	4c 02 f9	jmp $f902	                jmp mos.osbputEntryPoint                    ; FFD4
14115	.ffd7					OSBGET:
14116	.ffd7	4c 08 f9	jmp $f908	                jmp mos.osbgetEntryPoint                    ; FFD7
14117	.ffda					OSARGS:
14118	.ffda	4c 37 f9	jmp $f937	                jmp mos.osargsEntryPoint ; FFDA
14119	.ffdd					OSFILE:
14120	.ffdd	4c 7a f9	jmp $f97a	                jmp mos.osfileEntryPoint ; FFDD
14121	.ffe0					OSRDCH:
14122	.ffe0	6c 10 02	jmp ($0210)	                jmp (RDCHV)                  ; FFE0
14123	.ffe3					OSASCI:
14124	.ffe3	c9 0d		cmp #$0d	                cmp #$0D                     ; FFE3
14125	.ffe5	d0 07		bne $ffee	                bne OSWRCH                   ; FFE5
14126	.ffe7					OSNEWL:
14127	.ffe7	a9 0a		lda #$0a	                lda #$0A                     ; FFE7
14128	.ffe9	20 ee ff	jsr $ffee	                jsr OSWRCH                   ; FFE9
14129	.ffec	a9 0d		lda #$0d	                lda #$0D                     ; FFEC
14130	.ffee					OSWRCH:
14131	.ffee	6c 0e 02	jmp ($020e)	                jmp (WRCHV)                  ; FFEE
14132	.fff1					OSWORD:
14133	.fff1	6c 0c 02	jmp ($020c)	                jmp (WORDV)                  ; FFF1
14134	.fff4					OSBYTE:
14135	.fff4	6c 0a 02	jmp ($020a)	                jmp (BYTEV)                  ; FFF4
14136	.fff7					OSCLI:
14137	.fff7	6c 08 02	jmp ($0208)	                jmp (CLIV)                  ; FFF7

14139	.fffa					LFFFA:                                       ; FFFA NMIV
14140	>fffa	00 0d				                .word nmiEntryPoint
14141	.fffc					LFFFC:                                       ; FFFB RESETV
14142	>fffc	86 e3				                .word mos.resetEntryPoint
14143	.fffe					LFFFE:                                       ; FFFE IRQV
14144	>fffe	b7 e5				                .word mos.irqEntryPoint


:1	;******  Return to file: mos500.s65

32						                .endsection

;******  End of listing
